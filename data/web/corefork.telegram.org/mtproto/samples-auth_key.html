<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 99 0A 00 9D 36 A8 65
0010 | 14 00 00 00 F1 8E 7E BE 9A AF A7 4E 29 5C CF C9
0020 | 7B C5 93 19 50 7B 21 BC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E4990A009D36A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 88 9E 03 9E 36 A8 65
0010 | 68 00 00 00 63 24 16 05 9A AF A7 4E 29 5C CF C9
0020 | 7B C5 93 19 50 7B 21 BC 05 4D 38 FE DC 2F 29 EC
0030 | 2C B5 82 83 2E F5 17 72 08 16 D2 E3 CF 36 19 C1
0040 | 0B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01889E039E36A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>68000000</code> (104 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0816D2E3CF3619C10B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1644627293049045259</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1644627293049045259</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1644627293049045259 = 1057485463 * 1555224493</code></p>
<pre><code>p = 1057485463
q = 1555224493</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 D2 E3 CF 36 19 C1 0B 00 00 00
0010 | 04 3F 07 F2 97 00 00 00 04 5C B2 D7 AD 00 00 00
0020 | 9A AF A7 4E 29 5C CF C9 7B C5 93 19 50 7B 21 BC
0030 | 05 4D 38 FE DC 2F 29 EC 2C B5 82 83 2E F5 17 72
0040 | E7 53 D9 DE 36 B0 2B 0E F4 88 51 DB 37 AF 3E B8
0050 | DF 36 F4 38 E4 50 B9 F2 DF 37 32 5D 03 62 28 E2
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0816D2E3CF3619C10B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1644627293049045259</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043F07F297000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1057485463</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045CB2D7AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1555224493</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>E753D9DE36B02B0EF48851DB37AF3EB8</code> <code>DF36F438E450B9F2DF37325D036228E2</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90816D2E3CF3619C10B000000043F07F297000000045CB2D7AD0000009AAFA74E295CCFC97BC59319507B21BC054D38FEDC2F29EC2CB582832EF51772E753D9DE36B02B0EF48851DB37AF3EB8DF36F438E450B9F2DF37325D036228E202000000
random_padding_bytes = 689372C5F440976397FB5093F99EA81B7ECD1FE29E04222A9A3FAB455FB5FF03D914E9DC780F98D9513FDB8D5B9D8A996ADBADC1896CE1D52BDE8550299E2C720627E8F2BF56D6D1CCDCBE62EDCD26D604BC142759E8B2B292E2894A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 57C834C4C90A149B9998EBDA6E2D7AEE192DD0EE1DFD41CDE82998F7632085F70C96AC549B51E234905770402EA632A964213206BD56AA0B3FD8F3AB9F959524B86084A67CFCDAF229329968248D5721175DF5D3112E98D6F837B7172AC316DACB8F962EA965AF2F17984A1997A63F5FE2B13B49189C16AA8BDB9481968E9D33674ED7644E8A78652174F437655DB3170F09A1735ECE4834FCB78D772E5A40A4A850F6BE5D3EA009993FF467608E2A8B0216CAC0197C425C208A9F4BFA1D5112F954DE1AE93DC44F18B0046721DDB938C5EAD8FE39325670BC607A7AB1E5FA2681C7D1053E8E605044A75DA1A7ADF5C230AF5032AAA2519E6AEB4C95B0C0AE0B</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 30 AD 05 00 9E 36 A8 65
0010 | 40 01 00 00 BE E4 12 D7 9A AF A7 4E 29 5C CF C9
0020 | 7B C5 93 19 50 7B 21 BC 05 4D 38 FE DC 2F 29 EC
0030 | 2C B5 82 83 2E F5 17 72 04 3F 07 F2 97 00 00 00
0040 | 04 5C B2 D7 AD 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 57 C8 34 C4 C9 0A 14 9B 99 98 EB DA
0060 | 6E 2D 7A EE 19 2D D0 EE 1D FD 41 CD E8 29 98 F7
0070 | 63 20 85 F7 0C 96 AC 54 9B 51 E2 34 90 57 70 40
0080 | 2E A6 32 A9 64 21 32 06 BD 56 AA 0B 3F D8 F3 AB
0090 | 9F 95 95 24 B8 60 84 A6 7C FC DA F2 29 32 99 68
00A0 | 24 8D 57 21 17 5D F5 D3 11 2E 98 D6 F8 37 B7 17
00B0 | 2A C3 16 DA CB 8F 96 2E A9 65 AF 2F 17 98 4A 19
00C0 | 97 A6 3F 5F E2 B1 3B 49 18 9C 16 AA 8B DB 94 81
00D0 | 96 8E 9D 33 67 4E D7 64 4E 8A 78 65 21 74 F4 37
00E0 | 65 5D B3 17 0F 09 A1 73 5E CE 48 34 FC B7 8D 77
00F0 | 2E 5A 40 A4 A8 50 F6 BE 5D 3E A0 09 99 3F F4 67
0100 | 60 8E 2A 8B 02 16 CA C0 19 7C 42 5C 20 8A 9F 4B
0110 | FA 1D 51 12 F9 54 DE 1A E9 3D C4 4F 18 B0 04 67
0120 | 21 DD B9 38 C5 EA D8 FE 39 32 56 70 BC 60 7A 7A
0130 | B1 E5 FA 26 81 C7 D1 05 3E 8E 60 50 44 A7 5D A1
0140 | A7 AD F5 C2 30 AF 50 32 AA A2 51 9E 6A EB 4C 95
0150 | B0 C0 AE 0B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>30AD05009E36A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043F07F297000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1057485463</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045CB2D7AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1555224493</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010057C834C4C90A149B9998EBDA</code> <code>6E2D7AEE192DD0EE1DFD41CDE82998F7</code> <code>632085F70C96AC549B51E23490577040</code> <code>2EA632A964213206BD56AA0B3FD8F3AB</code> <code>9F959524B86084A67CFCDAF229329968</code> <code>248D5721175DF5D3112E98D6F837B717</code> <code>2AC316DACB8F962EA965AF2F17984A19</code> <code>97A63F5FE2B13B49189C16AA8BDB9481</code> <code>968E9D33674ED7644E8A78652174F437</code> <code>655DB3170F09A1735ECE4834FCB78D77</code> <code>2E5A40A4A850F6BE5D3EA009993FF467</code> <code>608E2A8B0216CAC0197C425C208A9F4B</code> <code>FA1D5112F954DE1AE93DC44F18B00467</code> <code>21DDB938C5EAD8FE39325670BC607A7A</code> <code>B1E5FA2681C7D1053E8E605044A75DA1</code> <code>A7ADF5C230AF5032AAA2519E6AEB4C95</code><br> <code>B0C0AE0B</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 1F B0 9E 36 A8 65
0010 | B8 02 00 00 5C 07 E8 D0 9A AF A7 4E 29 5C CF C9
0020 | 7B C5 93 19 50 7B 21 BC 05 4D 38 FE DC 2F 29 EC
0030 | 2C B5 82 83 2E F5 17 72 FE 50 02 00 CF 6B 6F 69
0040 | 5F CF 77 5D 01 50 D0 FB 02 9F 7A BB 2C F7 E3 8B
0050 | 33 C9 D8 58 E0 8A BC 66 1C FE F3 A5 8B D9 A4 0E
0060 | A5 52 19 48 DD D0 B7 40 5D BA D7 5F 96 93 56 D1
0070 | 72 72 7A 9F 06 D0 C9 84 05 C5 4F E6 C6 47 AB C2
0080 | 59 EA C5 CF 50 03 62 32 18 17 A7 DF 4E 61 6E DD
0090 | 81 6A FC DF 63 CC AB 2C 8A 27 B3 3A CE A3 FE 2A
00A0 | C4 2C C3 E8 9D 18 62 0D E4 0E 2F F0 BF 74 BB 28
00B0 | 8E 8A 48 05 B6 43 00 99 BF 08 E8 16 0E CF 56 8E
00C0 | F4 63 20 BB 80 B4 1F DE 5B A8 26 A1 10 C1 BC CF
00D0 | F1 23 52 09 A1 7E 66 48 E2 EB C9 45 00 8A 9D B0
00E0 | FC 14 A3 34 7D AA FB C9 D5 BC BC C6 60 43 B9 0F
00F0 | BF 7C 82 24 73 41 5A BA 26 9D 99 49 54 AD B3 3F
0100 | C3 8D 4D AF 26 E5 64 2B CD 30 3D 67 25 01 58 01
0110 | FE 9D 7B B6 15 28 F5 B4 66 85 FD 12 EF 99 36 15
0120 | 09 EB 6C 23 00 DC 26 AB 9D F3 D7 12 26 4A 7F FE
0130 | 1D C9 75 73 DE B1 55 0C 53 55 C0 08 13 A2 A6 9C
0140 | EE F5 DA B6 5A A4 08 4A 51 AB 1A AA 58 BF BB A5
0150 | C7 F7 8C 62 4F 81 7B 21 29 79 FF 45 38 AC 0D A5
0160 | CA AD 2B 78 6A 0A 63 DD 9B BF 48 96 15 31 64 D1
0170 | 7F CC 0C 13 61 30 28 4D 3C 36 3B 07 6C 2C F7 8B
0180 | 34 0F F4 16 13 20 5B A5 1A 68 31 B1 FB 02 16 84
0190 | 06 90 32 53 9E 3B 96 63 FE 53 38 CF 95 7B 0A 81
01A0 | 47 39 DB 1C 89 45 18 90 B3 79 C3 43 F5 CF 96 23
01B0 | 03 97 3B 71 0A AB D3 9F 17 BE EA 24 48 13 EF A9
01C0 | E0 C7 F0 AE 70 5B 9A FA E8 49 FC E8 B7 C6 97 04
01D0 | D5 2C E6 39 AC 34 3A 52 69 C4 B2 CB 10 B5 01 47
01E0 | 5A 22 A8 6A D3 7B 87 2B 6E D7 FB 98 1E 09 0B 32
01F0 | 87 DB CF 5D 8C 4C 2B 3A 7A A8 E7 D2 C6 8C 1D FD
0200 | F5 23 7B 22 67 5E C9 99 03 A3 55 C4 90 E1 E9 4F
0210 | 13 7E 90 47 79 C7 0C 60 22 56 77 E7 35 54 D2 69
0220 | FB 22 ED A4 DE 09 1A 57 8F F0 49 49 6A D6 B1 6B
0230 | 59 68 A5 92 85 B8 0F 4A 63 E3 EC DB 32 8B 0E C0
0240 | 63 C0 77 89 60 F1 B4 A3 D4 B6 8A F6 77 FF 5D 70
0250 | B7 EB C6 8D C1 37 1B 9A D8 84 0E 2D 1B C9 B0 87
0260 | 84 45 62 3F 18 C6 7C C5 52 29 17 96 F6 F0 A6 9A
0270 | 68 61 C3 80 E9 D8 D1 A6 74 E5 F7 65 1E A4 16 3A
0280 | 41 F5 20 A8 4A ED 73 50 45 AF 8A 57</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01581FB09E36A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B8020000</code> (696 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200CF6B6F695FCF775D0150D0FB</code> <code>029F7ABB2CF7E38B33C9D858E08ABC66</code> <code>1CFEF3A58BD9A40EA5521948DDD0B740</code> <code>5DBAD75F969356D172727A9F06D0C984</code> <code>05C54FE6C647ABC259EAC5CF50036232</code> <code>1817A7DF4E616EDD816AFCDF63CCAB2C</code> <code>8A27B33ACEA3FE2AC42CC3E89D18620D</code> <code>E40E2FF0BF74BB288E8A4805B6430099</code> <code>BF08E8160ECF568EF46320BB80B41FDE</code> <code>5BA826A110C1BCCFF1235209A17E6648</code> <code>E2EBC945008A9DB0FC14A3347DAAFBC9</code> <code>D5BCBCC66043B90FBF7C822473415ABA</code> <code>269D994954ADB33FC38D4DAF26E5642B</code> <code>CD303D6725015801FE9D7BB61528F5B4</code> <code>6685FD12EF99361509EB6C2300DC26AB</code> <code>9DF3D712264A7FFE1DC97573DEB1550C</code> <code>5355C00813A2A69CEEF5DAB65AA4084A</code> <code>51AB1AAA58BFBBA5C7F78C624F817B21</code> <code>2979FF4538AC0DA5CAAD2B786A0A63DD</code> <code>9BBF4896153164D17FCC0C136130284D</code> <code>3C363B076C2CF78B340FF41613205BA5</code> <code>1A6831B1FB021684069032539E3B9663</code> <code>FE5338CF957B0A814739DB1C89451890</code> <code>B379C343F5CF962303973B710AABD39F</code> <code>17BEEA244813EFA9E0C7F0AE705B9AFA</code> <code>E849FCE8B7C69704D52CE639AC343A52</code> <code>69C4B2CB10B501475A22A86AD37B872B</code> <code>6ED7FB981E090B3287DBCF5D8C4C2B3A</code> <code>7AA8E7D2C68C1DFDF5237B22675EC999</code> <code>03A355C490E1E94F137E904779C70C60</code> <code>225677E73554D269FB22EDA4DE091A57</code> <code>8FF049496AD6B16B5968A59285B80F4A</code> <code>63E3ECDB328B0EC063C0778960F1B4A3</code> <code>D4B68AF677FF5D70B7EBC68DC1371B9A</code> <code>D8840E2D1BC9B0878445623F18C67CC5</code> <code>52291796F6F0A69A6861C380E9D8D1A6</code> <code>74E5F7651EA4163A41F520A84AED7350</code><br> <code>45AF8A57</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = CF6B6F695FCF775D0150D0FB029F7ABB2CF7E38B33C9D858E08ABC661CFEF3A58BD9A40EA5521948DDD0B7405DBAD75F969356D172727A9F06D0C98405C54FE6C647ABC259EAC5CF500362321817A7DF4E616EDD816AFCDF63CCAB2C8A27B33ACEA3FE2AC42CC3E89D18620DE40E2FF0BF74BB288E8A4805B6430099BF08E8160ECF568EF46320BB80B41FDE5BA826A110C1BCCFF1235209A17E6648E2EBC945008A9DB0FC14A3347DAAFBC9D5BCBCC66043B90FBF7C822473415ABA269D994954ADB33FC38D4DAF26E5642BCD303D6725015801FE9D7BB61528F5B46685FD12EF99361509EB6C2300DC26AB9DF3D712264A7FFE1DC97573DEB1550C5355C00813A2A69CEEF5DAB65AA4084A51AB1AAA58BFBBA5C7F78C624F817B212979FF4538AC0DA5CAAD2B786A0A63DD9BBF4896153164D17FCC0C136130284D3C363B076C2CF78B340FF41613205BA51A6831B1FB021684069032539E3B9663FE5338CF957B0A814739DB1C89451890B379C343F5CF962303973B710AABD39F17BEEA244813EFA9E0C7F0AE705B9AFAE849FCE8B7C69704D52CE639AC343A5269C4B2CB10B501475A22A86AD37B872B6ED7FB981E090B3287DBCF5D8C4C2B3A7AA8E7D2C68C1DFDF5237B22675EC99903A355C490E1E94F137E904779C70C60225677E73554D269FB22EDA4DE091A578FF049496AD6B16B5968A59285B80F4A63E3ECDB328B0EC063C0778960F1B4A3D4B68AF677FF5D70B7EBC68DC1371B9AD8840E2D1BC9B0878445623F18C67CC552291796F6F0A69A6861C380E9D8D1A674E5F7651EA4163A41F520A84AED735045AF8A57
tmp_aes_key = 5A92A9C13DAE7AD44F48EE21479299AFD3680211ABDA9D54F009B6846D8EFEA1
tmp_aes_iv = E99F3BAD6AB94F5C30B04635A75C66CFD2AB5A68B8D4C50DCE7F384DE753D9DE</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 8A2B4F65A663F8005035B220241C64DFA3A4A078BA0D89B59AAFA74E295CCFC97BC59319507B21BC054D38FEDC2F29EC2CB582832EF5177203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002C0AF2EA836117BEA3BCF6F213BF04679BB389698290EEED2EE4C4583719EC6E55784CE2FCA01A3FA576AAB1606C89DA6701330C7A2A0E7304CE95DAD3A6CE631657EDD4F5A0FDABC1B5167F6AE66C380175100F7B20D1B16A2A329F71615A7E27BAB707C3EDF8657B8D52A82D7CF15F5743A97F78939504E07A2A621C395C2332AF46B3943D8599A9120685675747A9EB987F5A9BCF0E89034717BF77C5A881D3551997F02AAB08EDAB3173274A4BAF20F7EA0E6BA26F95A6DB2EEAF55E9355E0B4AED0F89CE52B00650615CFFEDDEFF0E9964561D2703A635D2CD6D27ACE60B098A51636D79BC3F58C0C265B30B2E2272F1D2337B39DF7F879159C2DE9DC579E36A8657E139AC1E4C03A76
answer = BA0D89B59AAFA74E295CCFC97BC59319507B21BC054D38FEDC2F29EC2CB582832EF5177203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002C0AF2EA836117BEA3BCF6F213BF04679BB389698290EEED2EE4C4583719EC6E55784CE2FCA01A3FA576AAB1606C89DA6701330C7A2A0E7304CE95DAD3A6CE631657EDD4F5A0FDABC1B5167F6AE66C380175100F7B20D1B16A2A329F71615A7E27BAB707C3EDF8657B8D52A82D7CF15F5743A97F78939504E07A2A621C395C2332AF46B3943D8599A9120685675747A9EB987F5A9BCF0E89034717BF77C5A881D3551997F02AAB08EDAB3173274A4BAF20F7EA0E6BA26F95A6DB2EEAF55E9355E0B4AED0F89CE52B00650615CFFEDDEFF0E9964561D2703A635D2CD6D27ACE60B098A51636D79BC3F58C0C265B30B2E2272F1D2337B39DF7F879159C2DE9DC579E36A8657E139AC1E4C03A76</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 9A AF A7 4E 29 5C CF C9 7B C5 93 19
0010 | 50 7B 21 BC 05 4D 38 FE DC 2F 29 EC 2C B5 82 83
0020 | 2E F5 17 72 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 2C 0A F2 EA 83 61 17 BE A3 BC F6 F2 13 BF 04 67
0140 | 9B B3 89 69 82 90 EE ED 2E E4 C4 58 37 19 EC 6E
0150 | 55 78 4C E2 FC A0 1A 3F A5 76 AA B1 60 6C 89 DA
0160 | 67 01 33 0C 7A 2A 0E 73 04 CE 95 DA D3 A6 CE 63
0170 | 16 57 ED D4 F5 A0 FD AB C1 B5 16 7F 6A E6 6C 38
0180 | 01 75 10 0F 7B 20 D1 B1 6A 2A 32 9F 71 61 5A 7E
0190 | 27 BA B7 07 C3 ED F8 65 7B 8D 52 A8 2D 7C F1 5F
01A0 | 57 43 A9 7F 78 93 95 04 E0 7A 2A 62 1C 39 5C 23
01B0 | 32 AF 46 B3 94 3D 85 99 A9 12 06 85 67 57 47 A9
01C0 | EB 98 7F 5A 9B CF 0E 89 03 47 17 BF 77 C5 A8 81
01D0 | D3 55 19 97 F0 2A AB 08 ED AB 31 73 27 4A 4B AF
01E0 | 20 F7 EA 0E 6B A2 6F 95 A6 DB 2E EA F5 5E 93 55
01F0 | E0 B4 AE D0 F8 9C E5 2B 00 65 06 15 CF FE DD EF
0200 | F0 E9 96 45 61 D2 70 3A 63 5D 2C D6 D2 7A CE 60
0210 | B0 98 A5 16 36 D7 9B C3 F5 8C 0C 26 5B 30 B2 E2
0220 | 27 2F 1D 23 37 B3 9D F7 F8 79 15 9C 2D E9 DC 57
0230 | 9E 36 A8 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001002C0AF2EA836117BEA3BCF6F2</code> <code>13BF04679BB389698290EEED2EE4C458</code> <code>3719EC6E55784CE2FCA01A3FA576AAB1</code> <code>606C89DA6701330C7A2A0E7304CE95DA</code> <code>D3A6CE631657EDD4F5A0FDABC1B5167F</code> <code>6AE66C380175100F7B20D1B16A2A329F</code> <code>71615A7E27BAB707C3EDF8657B8D52A8</code> <code>2D7CF15F5743A97F78939504E07A2A62</code> <code>1C395C2332AF46B3943D8599A9120685</code> <code>675747A9EB987F5A9BCF0E89034717BF</code> <code>77C5A881D3551997F02AAB08EDAB3173</code> <code>274A4BAF20F7EA0E6BA26F95A6DB2EEA</code> <code>F55E9355E0B4AED0F89CE52B00650615</code> <code>CFFEDDEFF0E9964561D2703A635D2CD6</code> <code>D27ACE60B098A51636D79BC3F58C0C26</code> <code>5B30B2E2272F1D2337B39DF7F879159C</code><br> <code>2DE9DC57</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>9E36A865</code> (1705522846 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 09DA60C95DE494D1DC93E312B4360DCE03264CA0D780F5054953AA123BE384D0F2D9622E94EAEAEF7899772FA52F9002EFFC5B359AEE4BA4AEC1B13ED3B4C4209BABC349C7596FF732E22919D232600EAC2934B8602FE2633D661C378BEE8D503C68C2E1E9C7A1B15A96AD1530C5936CF7150AB604C860060BFEE1728F45877BB7BAF1D24263C9E8C248E0171E0634DA84C3667A276BC024C421191F79290178F47999DF1CA46C0C523B9D3B6B020551D4AC79699A1C7DA431349CFBA2FDD191BE84881E12C848265CAACF1815B977C4325AA9EFB513F50039059F7E61EFD2B66FD6EEFA1520B1AB48BC2E2512F8DC3D1AEAE2011656FC9C42B69A5B26E4A39D</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 2C8CCBFB2588782B28078C6F4629EEA9C5BB65CE59C26D18D7DBE1224C3F9336073C2EE089387F7C66306EA495BC08E1ADF042C7E3D91EFC9BC075AAAB844F4C7AFEF8D05796FC5104C0A57E55F69F75CD584A4D1AA46D139F9455035900E7ECB56D71074AE08E1901C5F9D90391DFD93DAC28B3CC5674701A0B1E8B39DACD67D3F524710456CD7E147221AC5E2256E12A68C77FCB1F6F7191F9FA0D99EB15A02E00E65A7FA59A4BBA7C7860A300AD43036150C3B4BE9023089F87493DB98D0088E0ACB4C145C72720F7DFDDDCD3F1469BD8EC2D2ED80B849ACC0B6B013F37437D49DCEAACD7360638C02B387932F7FF4BA8409128D78C3FFE7213AD30E83527</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 9A AF A7 4E 29 5C CF C9 7B C5 93 19
0010 | 50 7B 21 BC 05 4D 38 FE DC 2F 29 EC 2C B5 82 83
0020 | 2E F5 17 72 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 2C 8C CB FB 25 88 78 2B 28 07 8C 6F 46 29 EE A9
0040 | C5 BB 65 CE 59 C2 6D 18 D7 DB E1 22 4C 3F 93 36
0050 | 07 3C 2E E0 89 38 7F 7C 66 30 6E A4 95 BC 08 E1
0060 | AD F0 42 C7 E3 D9 1E FC 9B C0 75 AA AB 84 4F 4C
0070 | 7A FE F8 D0 57 96 FC 51 04 C0 A5 7E 55 F6 9F 75
0080 | CD 58 4A 4D 1A A4 6D 13 9F 94 55 03 59 00 E7 EC
0090 | B5 6D 71 07 4A E0 8E 19 01 C5 F9 D9 03 91 DF D9
00A0 | 3D AC 28 B3 CC 56 74 70 1A 0B 1E 8B 39 DA CD 67
00B0 | D3 F5 24 71 04 56 CD 7E 14 72 21 AC 5E 22 56 E1
00C0 | 2A 68 C7 7F CB 1F 6F 71 91 F9 FA 0D 99 EB 15 A0
00D0 | 2E 00 E6 5A 7F A5 9A 4B BA 7C 78 60 A3 00 AD 43
00E0 | 03 61 50 C3 B4 BE 90 23 08 9F 87 49 3D B9 8D 00
00F0 | 88 E0 AC B4 C1 45 C7 27 20 F7 DF DD DC D3 F1 46
0100 | 9B D8 EC 2D 2E D8 0B 84 9A CC 0B 6B 01 3F 37 43
0110 | 7D 49 DC EA AC D7 36 06 38 C0 2B 38 79 32 F7 FF
0120 | 4B A8 40 91 28 D7 8C 3F FE 72 13 AD 30 E8 35 27</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001002C8CCBFB2588782B28078C6F</code> <code>4629EEA9C5BB65CE59C26D18D7DBE122</code> <code>4C3F9336073C2EE089387F7C66306EA4</code> <code>95BC08E1ADF042C7E3D91EFC9BC075AA</code> <code>AB844F4C7AFEF8D05796FC5104C0A57E</code> <code>55F69F75CD584A4D1AA46D139F945503</code> <code>5900E7ECB56D71074AE08E1901C5F9D9</code> <code>0391DFD93DAC28B3CC5674701A0B1E8B</code> <code>39DACD67D3F524710456CD7E147221AC</code> <code>5E2256E12A68C77FCB1F6F7191F9FA0D</code> <code>99EB15A02E00E65A7FA59A4BBA7C7860</code> <code>A300AD43036150C3B4BE9023089F8749</code> <code>3DB98D0088E0ACB4C145C72720F7DFDD</code> <code>DCD3F1469BD8EC2D2ED80B849ACC0B6B</code> <code>013F37437D49DCEAACD7360638C02B38</code> <code>7932F7FF4BA8409128D78C3FFE7213AD</code><br> <code>30E83527</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643669AAFA74E295CCFC97BC59319507B21BC054D38FEDC2F29EC2CB582832EF517720000000000000000FE0001002C8CCBFB2588782B28078C6F4629EEA9C5BB65CE59C26D18D7DBE1224C3F9336073C2EE089387F7C66306EA495BC08E1ADF042C7E3D91EFC9BC075AAAB844F4C7AFEF8D05796FC5104C0A57E55F69F75CD584A4D1AA46D139F9455035900E7ECB56D71074AE08E1901C5F9D90391DFD93DAC28B3CC5674701A0B1E8B39DACD67D3F524710456CD7E147221AC5E2256E12A68C77FCB1F6F7191F9FA0D99EB15A02E00E65A7FA59A4BBA7C7860A300AD43036150C3B4BE9023089F87493DB98D0088E0ACB4C145C72720F7DFDDDCD3F1469BD8EC2D2ED80B849ACC0B6B013F37437D49DCEAACD7360638C02B387932F7FF4BA8409128D78C3FFE7213AD30E83527
padding = 170DEC31F5A11DE115D057FC
tmp_aes_key = 5A92A9C13DAE7AD44F48EE21479299AFD3680211ABDA9D54F009B6846D8EFEA1
tmp_aes_iv = E99F3BAD6AB94F5C30B04635A75C66CFD2AB5A68B8D4C50DCE7F384DE753D9DE</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 19D136DB0431F30C8204159B7547FC223ADA5F91CF9395C2466CC1C0430705F68DAEE69BF38C6D915B04B212503860CC0F2E770F58DBA12E0BC2BFE175B7F05C224E2CA03E9EF0216AD4DD2710C6D43337CE055D6FFD5657905D8ED35073D4D33BFE476903D8576FB34C388C3390432D8BF2C4F86726890B338E42C3EE5F4AA77E0618CA4AEFE578F9AFAA7899FF55F7EE0EC759CA506CD17E029D50FA631EB51C79A1C2B4E7FDDF47F08CF9466E3550857386E9A763DFB5214D47FF8C05E7DAA8BA6E628486F3160050DAEE78F600A4C567EFFAB504B950A62CAFBC2934887CA81433001D0934BD0DD875C0D9274C38C652FF2EC90C8BB22A9CACF77C1081EB4B28882705E8EEDB1BE3B5214EF0ABFCFEC8F7CCCCE4315C625A063FC6988F03192436010EA3F73070E728D357C5FBA4827E1463DC8308A14ABACEEE6B48D315F203D0CBC74E8560C7036068357B292C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 34 AD 05 00 9E 36 A8 65
0010 | 78 01 00 00 1F 5F 04 F5 9A AF A7 4E 29 5C CF C9
0020 | 7B C5 93 19 50 7B 21 BC 05 4D 38 FE DC 2F 29 EC
0030 | 2C B5 82 83 2E F5 17 72 FE 50 01 00 19 D1 36 DB
0040 | 04 31 F3 0C 82 04 15 9B 75 47 FC 22 3A DA 5F 91
0050 | CF 93 95 C2 46 6C C1 C0 43 07 05 F6 8D AE E6 9B
0060 | F3 8C 6D 91 5B 04 B2 12 50 38 60 CC 0F 2E 77 0F
0070 | 58 DB A1 2E 0B C2 BF E1 75 B7 F0 5C 22 4E 2C A0
0080 | 3E 9E F0 21 6A D4 DD 27 10 C6 D4 33 37 CE 05 5D
0090 | 6F FD 56 57 90 5D 8E D3 50 73 D4 D3 3B FE 47 69
00A0 | 03 D8 57 6F B3 4C 38 8C 33 90 43 2D 8B F2 C4 F8
00B0 | 67 26 89 0B 33 8E 42 C3 EE 5F 4A A7 7E 06 18 CA
00C0 | 4A EF E5 78 F9 AF AA 78 99 FF 55 F7 EE 0E C7 59
00D0 | CA 50 6C D1 7E 02 9D 50 FA 63 1E B5 1C 79 A1 C2
00E0 | B4 E7 FD DF 47 F0 8C F9 46 6E 35 50 85 73 86 E9
00F0 | A7 63 DF B5 21 4D 47 FF 8C 05 E7 DA A8 BA 6E 62
0100 | 84 86 F3 16 00 50 DA EE 78 F6 00 A4 C5 67 EF FA
0110 | B5 04 B9 50 A6 2C AF BC 29 34 88 7C A8 14 33 00
0120 | 1D 09 34 BD 0D D8 75 C0 D9 27 4C 38 C6 52 FF 2E
0130 | C9 0C 8B B2 2A 9C AC F7 7C 10 81 EB 4B 28 88 27
0140 | 05 E8 EE DB 1B E3 B5 21 4E F0 AB FC FE C8 F7 CC
0150 | CC E4 31 5C 62 5A 06 3F C6 98 8F 03 19 24 36 01
0160 | 0E A3 F7 30 70 E7 28 D3 57 C5 FB A4 82 7E 14 63
0170 | DC 83 08 A1 4A BA CE EE 6B 48 D3 15 F2 03 D0 CB
0180 | C7 4E 85 60 C7 03 60 68 35 7B 29 2C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>34AD05009E36A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010019D136DB0431F30C8204159B</code> <code>7547FC223ADA5F91CF9395C2466CC1C0</code> <code>430705F68DAEE69BF38C6D915B04B212</code> <code>503860CC0F2E770F58DBA12E0BC2BFE1</code> <code>75B7F05C224E2CA03E9EF0216AD4DD27</code> <code>10C6D43337CE055D6FFD5657905D8ED3</code> <code>5073D4D33BFE476903D8576FB34C388C</code> <code>3390432D8BF2C4F86726890B338E42C3</code> <code>EE5F4AA77E0618CA4AEFE578F9AFAA78</code> <code>99FF55F7EE0EC759CA506CD17E029D50</code> <code>FA631EB51C79A1C2B4E7FDDF47F08CF9</code> <code>466E3550857386E9A763DFB5214D47FF</code> <code>8C05E7DAA8BA6E628486F3160050DAEE</code> <code>78F600A4C567EFFAB504B950A62CAFBC</code> <code>2934887CA81433001D0934BD0DD875C0</code> <code>D9274C38C652FF2EC90C8BB22A9CACF7</code> <code>7C1081EB4B28882705E8EEDB1BE3B521</code> <code>4EF0ABFCFEC8F7CCCCE4315C625A063F</code> <code>C6988F03192436010EA3F73070E728D3</code> <code>57C5FBA4827E1463DC8308A14ABACEEE</code> <code>6B48D315F203D0CBC74E8560C7036068</code><br> <code>357B292C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 8C359D419DCD976B43054226DF43AE8E4CE7FCEB812AF52B54255FEA88984E436AA02BAB9B20D8D6DCA5DFE28B594C3BE7F622B0C1DDB9263B8CFD31DBE713F897C162ABAAFCE7E9ED16A344A26E55DC4211EEB291107601898FD18AAC9F016FFA70A099CE280EC4C3255DD7956BBB6E6164473727887CF92578FEE11F7CF2D112CEC1754BA1AA0D4B9BD8C5A33C6273F819D8617CD0E07638B61866A4298F373ED0F46BC272C7E6A07A32CD2B34A8761778849840ACCBE06A7B169C294945F258C8F9B3A25EE209D8B610F4821A49C4ABA136B512631935DEE5B35A280353DDFCF8FB34BB54FA76E3F019C9DF7650632252F81C81B2BB8A7D5F50ACFDDA3B62</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 20 5E E4 9F 36 A8 65
0010 | 5C 00 00 00 34 F7 CB 3B 9A AF A7 4E 29 5C CF C9
0020 | 7B C5 93 19 50 7B 21 BC 05 4D 38 FE DC 2F 29 EC
0030 | 2C B5 82 83 2E F5 17 72 4F C0 EE 0B 29 27 F6 92
0040 | BE D8 95 F7 9C D6 6A 3A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01205EE49F36A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>5C000000</code> (92 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9AAFA74E295CCFC97BC59319507B21BC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>054D38FEDC2F29EC2CB582832EF51772</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4FC0EE0B2927F692BED895F79CD66A3A</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

