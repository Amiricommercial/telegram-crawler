<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B8 66 08 00 6B AC 7C 65
0010 | 14 00 00 00 F1 8E 7E BE 40 D6 59 B1 27 2C F7 5A
0020 | EE A1 83 3A 66 BE D1 DA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B86608006BAC7C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 0C 7F 03 6D AC 7C 65
0010 | 78 00 00 00 63 24 16 05 40 D6 59 B1 27 2C F7 5A
0020 | EE A1 83 3A 66 BE D1 DA EB A4 DF 47 84 75 8E BA
0030 | 7D B4 DA 94 FF AB 83 FD 08 16 4E C3 0C A4 B3 9E
0040 | 13 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>010C7F036DAC7C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78000000</code> (120 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08164EC30CA4B39E13000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1607436576088104467</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1607436576088104467</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1607436576088104467 = 1206120829 * 1332732623</code></p>
<pre><code>p = 1206120829
q = 1332732623</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 4E C3 0C A4 B3 9E 13 00 00 00
0010 | 04 47 E3 F1 7D 00 00 00 04 4F 6F E2 CF 00 00 00
0020 | 40 D6 59 B1 27 2C F7 5A EE A1 83 3A 66 BE D1 DA
0030 | EB A4 DF 47 84 75 8E BA 7D B4 DA 94 FF AB 83 FD
0040 | AD EB 4D 91 E6 F8 10 59 07 33 3D A4 D6 32 39 FD
0050 | 6E 51 BD 27 66 2A B5 FB 26 9A 15 57 ED 3F 34 34
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08164EC30CA4B39E13000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1607436576088104467</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0447E3F17D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1206120829</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044F6FE2CF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1332732623</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>ADEB4D91E6F8105907333DA4D63239FD</code> <code>6E51BD27662AB5FB269A1557ED3F3434</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908164EC30CA4B39E130000000447E3F17D000000044F6FE2CF00000040D659B1272CF75AEEA1833A66BED1DAEBA4DF4784758EBA7DB4DA94FFAB83FDADEB4D91E6F8105907333DA4D63239FD6E51BD27662AB5FB269A1557ED3F343402000000
random_padding_bytes = 5DE6C16341AE74DECDCFD12BD4C0F5AF682D9FE21E75E1B98AFBA471ADE48CAA72A180EFEDA49B18393E545BB01909B3A8A30D4607EA9BB0EA4E24D950F905460BFFD80E2C24592514421A062D69A04F8CC37BADDC4970DC113A2FAB</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = C0CB80E9A662A637CD5BEEE6DD739B1327050614AC82763F8728DB2080FE229CF551CDBC5529DB1AA10B489ED09C4569810AE5CB8D5644F6A66929224B206A984CD48132B8C8B3EDABCC2E13C80DEFC44C2718E3C933CAA3E4AD92A461426FDA5A420B3A6C96EA0A8E879FD46C4A9E473DE0E99F6B5A3090E8B98E7FD34BAFF26FC8A093F77FC1715536B4D044043DD78B28C40749FF137C3F8A2D16649795B799785A48E9316441E6EDCA30BEED7729A2793D842295CF9923B333EA3DD7DAF424AA7493F19BFF0D936E9D136357CA292ED0DE718DBF11E62EF5323AAB3487E887A1B952ED3D4865F90386AF9C05882C77AAF573A11C489DEF3D305863EF39FB</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 4C 21 00 00 6C AC 7C 65
0010 | 40 01 00 00 BE E4 12 D7 40 D6 59 B1 27 2C F7 5A
0020 | EE A1 83 3A 66 BE D1 DA EB A4 DF 47 84 75 8E BA
0030 | 7D B4 DA 94 FF AB 83 FD 04 47 E3 F1 7D 00 00 00
0040 | 04 4F 6F E2 CF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 C0 CB 80 E9 A6 62 A6 37 CD 5B EE E6
0060 | DD 73 9B 13 27 05 06 14 AC 82 76 3F 87 28 DB 20
0070 | 80 FE 22 9C F5 51 CD BC 55 29 DB 1A A1 0B 48 9E
0080 | D0 9C 45 69 81 0A E5 CB 8D 56 44 F6 A6 69 29 22
0090 | 4B 20 6A 98 4C D4 81 32 B8 C8 B3 ED AB CC 2E 13
00A0 | C8 0D EF C4 4C 27 18 E3 C9 33 CA A3 E4 AD 92 A4
00B0 | 61 42 6F DA 5A 42 0B 3A 6C 96 EA 0A 8E 87 9F D4
00C0 | 6C 4A 9E 47 3D E0 E9 9F 6B 5A 30 90 E8 B9 8E 7F
00D0 | D3 4B AF F2 6F C8 A0 93 F7 7F C1 71 55 36 B4 D0
00E0 | 44 04 3D D7 8B 28 C4 07 49 FF 13 7C 3F 8A 2D 16
00F0 | 64 97 95 B7 99 78 5A 48 E9 31 64 41 E6 ED CA 30
0100 | BE ED 77 29 A2 79 3D 84 22 95 CF 99 23 B3 33 EA
0110 | 3D D7 DA F4 24 AA 74 93 F1 9B FF 0D 93 6E 9D 13
0120 | 63 57 CA 29 2E D0 DE 71 8D BF 11 E6 2E F5 32 3A
0130 | AB 34 87 E8 87 A1 B9 52 ED 3D 48 65 F9 03 86 AF
0140 | 9C 05 88 2C 77 AA F5 73 A1 1C 48 9D EF 3D 30 58
0150 | 63 EF 39 FB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>4C2100006CAC7C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0447E3F17D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1206120829</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044F6FE2CF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1332732623</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100C0CB80E9A662A637CD5BEEE6</code> <code>DD739B1327050614AC82763F8728DB20</code> <code>80FE229CF551CDBC5529DB1AA10B489E</code> <code>D09C4569810AE5CB8D5644F6A6692922</code> <code>4B206A984CD48132B8C8B3EDABCC2E13</code> <code>C80DEFC44C2718E3C933CAA3E4AD92A4</code> <code>61426FDA5A420B3A6C96EA0A8E879FD4</code> <code>6C4A9E473DE0E99F6B5A3090E8B98E7F</code> <code>D34BAFF26FC8A093F77FC1715536B4D0</code> <code>44043DD78B28C40749FF137C3F8A2D16</code> <code>649795B799785A48E9316441E6EDCA30</code> <code>BEED7729A2793D842295CF9923B333EA</code> <code>3DD7DAF424AA7493F19BFF0D936E9D13</code> <code>6357CA292ED0DE718DBF11E62EF5323A</code> <code>AB3487E887A1B952ED3D4865F90386AF</code> <code>9C05882C77AAF573A11C489DEF3D3058</code><br> <code>63EF39FB</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 CC 71 B0 6D AC 7C 65
0010 | A8 02 00 00 5C 07 E8 D0 40 D6 59 B1 27 2C F7 5A
0020 | EE A1 83 3A 66 BE D1 DA EB A4 DF 47 84 75 8E BA
0030 | 7D B4 DA 94 FF AB 83 FD FE 50 02 00 AC 5B 51 4F
0040 | C5 8A 8D B4 C5 AF BC C9 E0 F0 41 D7 93 21 F0 24
0050 | 58 EB 97 26 D3 36 7C 68 72 68 8A C4 10 72 7D C4
0060 | C6 BF 7D 2E 25 29 9E FE 20 62 8F B4 64 68 DF 37
0070 | DC 4C DD 60 30 30 87 77 B0 65 60 32 F7 44 31 4D
0080 | 49 42 80 1B DD 3B 52 61 0C 32 3A 5A AF 54 0E 4F
0090 | C5 80 1E F4 B2 F6 1C DE 9C 0E B8 0A 17 98 A2 44
00A0 | 99 CA 73 39 04 E9 9B B7 BF 0C 39 81 C9 96 F4 99
00B0 | 66 89 09 18 1A 4C 56 31 01 E5 5C EF C3 66 B4 1B
00C0 | B0 E9 B0 AC 40 7B 76 24 3F D1 80 BF 25 F8 95 0B
00D0 | 7C 04 90 E6 02 10 26 32 33 C5 5D 6A A8 88 D8 5F
00E0 | 72 02 38 D0 14 98 BA 05 ED 4C 1C 9B D2 3E 6B FF
00F0 | C3 71 2A ED 44 A9 81 1C 4E 15 0E AD 9B FC 24 4F
0100 | 1D 8B 0E 29 F1 0F D6 B1 7C 11 6D B5 5D 23 E6 72
0110 | 7D 8D 26 F4 C7 B3 59 37 44 E6 98 76 24 75 57 E1
0120 | FA 4F B4 8E 7F 1D 6C 30 83 3A B2 29 D2 57 8D E5
0130 | 25 9A BA DC 09 40 DE CD CB 76 3C 52 37 2F 33 78
0140 | EC 65 64 EF CC BA 2A 0F 78 5B 57 12 CE B6 52 92
0150 | 03 97 45 A3 3A DB 5D CA ED 6E D7 46 63 F7 36 1A
0160 | 95 B7 BF 43 61 55 97 15 0F FC 8C 21 80 FE F1 8F
0170 | 2D 83 B9 4C 0A 11 1F 45 D2 B7 32 83 CE 7B FD 52
0180 | CF 65 E5 45 4D 67 24 5D B2 92 23 1B FF 5E 68 63
0190 | 77 E7 DC 19 56 3C 19 F3 01 67 8F 66 DE A5 16 12
01A0 | F1 78 56 AB FC 78 7A F0 FD 6A 39 CE D7 43 E0 05
01B0 | 33 AA 84 44 D9 C3 CF AD 4A FC CE 95 1A B1 4D A3
01C0 | 01 92 AE AA 21 31 68 CB F1 42 D7 1B 0E 55 51 1E
01D0 | 97 C4 67 FF 58 7F C3 D6 C3 BC FD 06 E2 33 F9 55
01E0 | 08 D8 97 74 91 16 55 BC 2C 51 98 DB 6B 1B AE EF
01F0 | FE 5E 54 41 AA A6 52 BF 0E E4 84 F0 1A 5B 95 75
0200 | 2B 30 02 4B 9B 58 65 19 41 39 1C 7E 13 D0 96 1E
0210 | 0E F8 83 50 5A 0A B3 F0 52 A9 8C A6 C4 F2 A4 2B
0220 | F5 E5 35 D6 83 7E B9 BE 92 CA 2F 03 A5 BB 4A 0A
0230 | B0 DE EB 22 69 F4 40 19 81 BE 5B B6 A1 6F 1A 86
0240 | 08 A4 5D 37 11 C6 F8 6B B3 9A 2F EA 26 89 0A 98
0250 | 45 83 F0 67 33 6D F8 05 A6 29 FB E9 FA 67 20 EA
0260 | 8E B2 C4 DC 0C 05 59 D7 8D 2E E4 E8 C4 E7 8B 83
0270 | 16 71 E4 6B 8F 72 48 02 74 69 3F 51 23 D2 F8 3A
0280 | E8 C9 0A 70 F9 A8 47 C8 78 08 81 05</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01CC71B06DAC7C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8020000</code> (680 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200AC5B514FC58A8DB4C5AFBCC9</code> <code>E0F041D79321F02458EB9726D3367C68</code> <code>72688AC410727DC4C6BF7D2E25299EFE</code> <code>20628FB46468DF37DC4CDD6030308777</code> <code>B0656032F744314D4942801BDD3B5261</code> <code>0C323A5AAF540E4FC5801EF4B2F61CDE</code> <code>9C0EB80A1798A24499CA733904E99BB7</code> <code>BF0C3981C996F499668909181A4C5631</code> <code>01E55CEFC366B41BB0E9B0AC407B7624</code> <code>3FD180BF25F8950B7C0490E602102632</code> <code>33C55D6AA888D85F720238D01498BA05</code> <code>ED4C1C9BD23E6BFFC3712AED44A9811C</code> <code>4E150EAD9BFC244F1D8B0E29F10FD6B1</code> <code>7C116DB55D23E6727D8D26F4C7B35937</code> <code>44E69876247557E1FA4FB48E7F1D6C30</code> <code>833AB229D2578DE5259ABADC0940DECD</code> <code>CB763C52372F3378EC6564EFCCBA2A0F</code> <code>785B5712CEB65292039745A33ADB5DCA</code> <code>ED6ED74663F7361A95B7BF4361559715</code> <code>0FFC8C2180FEF18F2D83B94C0A111F45</code> <code>D2B73283CE7BFD52CF65E5454D67245D</code> <code>B292231BFF5E686377E7DC19563C19F3</code> <code>01678F66DEA51612F17856ABFC787AF0</code> <code>FD6A39CED743E00533AA8444D9C3CFAD</code> <code>4AFCCE951AB14DA30192AEAA213168CB</code> <code>F142D71B0E55511E97C467FF587FC3D6</code> <code>C3BCFD06E233F95508D89774911655BC</code> <code>2C5198DB6B1BAEEFFE5E5441AAA652BF</code> <code>0EE484F01A5B95752B30024B9B586519</code> <code>41391C7E13D0961E0EF883505A0AB3F0</code> <code>52A98CA6C4F2A42BF5E535D6837EB9BE</code> <code>92CA2F03A5BB4A0AB0DEEB2269F44019</code> <code>81BE5BB6A16F1A8608A45D3711C6F86B</code> <code>B39A2FEA26890A984583F067336DF805</code> <code>A629FBE9FA6720EA8EB2C4DC0C0559D7</code> <code>8D2EE4E8C4E78B831671E46B8F724802</code> <code>74693F5123D2F83AE8C90A70F9A847C8</code><br> <code>78088105</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = AC5B514FC58A8DB4C5AFBCC9E0F041D79321F02458EB9726D3367C6872688AC410727DC4C6BF7D2E25299EFE20628FB46468DF37DC4CDD6030308777B0656032F744314D4942801BDD3B52610C323A5AAF540E4FC5801EF4B2F61CDE9C0EB80A1798A24499CA733904E99BB7BF0C3981C996F499668909181A4C563101E55CEFC366B41BB0E9B0AC407B76243FD180BF25F8950B7C0490E60210263233C55D6AA888D85F720238D01498BA05ED4C1C9BD23E6BFFC3712AED44A9811C4E150EAD9BFC244F1D8B0E29F10FD6B17C116DB55D23E6727D8D26F4C7B3593744E69876247557E1FA4FB48E7F1D6C30833AB229D2578DE5259ABADC0940DECDCB763C52372F3378EC6564EFCCBA2A0F785B5712CEB65292039745A33ADB5DCAED6ED74663F7361A95B7BF43615597150FFC8C2180FEF18F2D83B94C0A111F45D2B73283CE7BFD52CF65E5454D67245DB292231BFF5E686377E7DC19563C19F301678F66DEA51612F17856ABFC787AF0FD6A39CED743E00533AA8444D9C3CFAD4AFCCE951AB14DA30192AEAA213168CBF142D71B0E55511E97C467FF587FC3D6C3BCFD06E233F95508D89774911655BC2C5198DB6B1BAEEFFE5E5441AAA652BF0EE484F01A5B95752B30024B9B58651941391C7E13D0961E0EF883505A0AB3F052A98CA6C4F2A42BF5E535D6837EB9BE92CA2F03A5BB4A0AB0DEEB2269F4401981BE5BB6A16F1A8608A45D3711C6F86BB39A2FEA26890A984583F067336DF805A629FBE9FA6720EA8EB2C4DC0C0559D78D2EE4E8C4E78B831671E46B8F72480274693F5123D2F83AE8C90A70F9A847C878088105
tmp_aes_key = 9F80404847B20E9F8D5357E4FE4CCDF4D9D670F8D21B57ED4AA667DC16391151
tmp_aes_iv = 4826EC48442743B263E4F6F7A8C874D2B11E4D67634DA5F05B5963FEADEB4D91</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 20FE7C212E6557A75EF65010B94C3E5CFBF115CCBA0D89B540D659B1272CF75AEEA1833A66BED1DAEBA4DF4784758EBA7DB4DA94FFAB83FD03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010062AA2F3D99A2D62E6036E2D5E67CB62D56254D74281F80EFD33BD9B29104649A14BFE483A7BA2958AF765B0F9284994C0B39AFE1D5B33637F627629E2DCE51D1797A17E4D7A8B9C2E113FCD808EA745D1D6033399CDCC74D150CF57F4CFC846041249425B8F12FCF1FF6B6FD8A438221D96D33EA97EAE8D9011DF9B3BBA34CF2A095CF28C564D46C25F1C5A1AC46032F20A5B0C1366E93F92DD5B2A33D69F7106D7B0E7E933167A25F86706A3B483041886912D705A08F6F026B7A8B51980E204D02707AD1A4CB181061FC4B9E70CB33E28FFE5BDD4DDC2A3B7886AE702CDC54DFA8918B34E1E3813F48C30DEAF8B79AB78111EF66FB3139E196BDB43CA8D6F76DAC7C653E866F144BF2F8B8
answer = BA0D89B540D659B1272CF75AEEA1833A66BED1DAEBA4DF4784758EBA7DB4DA94FFAB83FD03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010062AA2F3D99A2D62E6036E2D5E67CB62D56254D74281F80EFD33BD9B29104649A14BFE483A7BA2958AF765B0F9284994C0B39AFE1D5B33637F627629E2DCE51D1797A17E4D7A8B9C2E113FCD808EA745D1D6033399CDCC74D150CF57F4CFC846041249425B8F12FCF1FF6B6FD8A438221D96D33EA97EAE8D9011DF9B3BBA34CF2A095CF28C564D46C25F1C5A1AC46032F20A5B0C1366E93F92DD5B2A33D69F7106D7B0E7E933167A25F86706A3B483041886912D705A08F6F026B7A8B51980E204D02707AD1A4CB181061FC4B9E70CB33E28FFE5BDD4DDC2A3B7886AE702CDC54DFA8918B34E1E3813F48C30DEAF8B79AB78111EF66FB3139E196BDB43CA8D6F76DAC7C653E866F144BF2F8B8</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 40 D6 59 B1 27 2C F7 5A EE A1 83 3A
0010 | 66 BE D1 DA EB A4 DF 47 84 75 8E BA 7D B4 DA 94
0020 | FF AB 83 FD 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 62 AA 2F 3D 99 A2 D6 2E 60 36 E2 D5 E6 7C B6 2D
0140 | 56 25 4D 74 28 1F 80 EF D3 3B D9 B2 91 04 64 9A
0150 | 14 BF E4 83 A7 BA 29 58 AF 76 5B 0F 92 84 99 4C
0160 | 0B 39 AF E1 D5 B3 36 37 F6 27 62 9E 2D CE 51 D1
0170 | 79 7A 17 E4 D7 A8 B9 C2 E1 13 FC D8 08 EA 74 5D
0180 | 1D 60 33 39 9C DC C7 4D 15 0C F5 7F 4C FC 84 60
0190 | 41 24 94 25 B8 F1 2F CF 1F F6 B6 FD 8A 43 82 21
01A0 | D9 6D 33 EA 97 EA E8 D9 01 1D F9 B3 BB A3 4C F2
01B0 | A0 95 CF 28 C5 64 D4 6C 25 F1 C5 A1 AC 46 03 2F
01C0 | 20 A5 B0 C1 36 6E 93 F9 2D D5 B2 A3 3D 69 F7 10
01D0 | 6D 7B 0E 7E 93 31 67 A2 5F 86 70 6A 3B 48 30 41
01E0 | 88 69 12 D7 05 A0 8F 6F 02 6B 7A 8B 51 98 0E 20
01F0 | 4D 02 70 7A D1 A4 CB 18 10 61 FC 4B 9E 70 CB 33
0200 | E2 8F FE 5B DD 4D DC 2A 3B 78 86 AE 70 2C DC 54
0210 | DF A8 91 8B 34 E1 E3 81 3F 48 C3 0D EA F8 B7 9A
0220 | B7 81 11 EF 66 FB 31 39 E1 96 BD B4 3C A8 D6 F7
0230 | 6D AC 7C 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010062AA2F3D99A2D62E6036E2D5</code> <code>E67CB62D56254D74281F80EFD33BD9B2</code> <code>9104649A14BFE483A7BA2958AF765B0F</code> <code>9284994C0B39AFE1D5B33637F627629E</code> <code>2DCE51D1797A17E4D7A8B9C2E113FCD8</code> <code>08EA745D1D6033399CDCC74D150CF57F</code> <code>4CFC846041249425B8F12FCF1FF6B6FD</code> <code>8A438221D96D33EA97EAE8D9011DF9B3</code> <code>BBA34CF2A095CF28C564D46C25F1C5A1</code> <code>AC46032F20A5B0C1366E93F92DD5B2A3</code> <code>3D69F7106D7B0E7E933167A25F86706A</code> <code>3B483041886912D705A08F6F026B7A8B</code> <code>51980E204D02707AD1A4CB181061FC4B</code> <code>9E70CB33E28FFE5BDD4DDC2A3B7886AE</code> <code>702CDC54DFA8918B34E1E3813F48C30D</code> <code>EAF8B79AB78111EF66FB3139E196BDB4</code><br> <code>3CA8D6F7</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>6DAC7C65</code> (1702669421 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 010D0C826F5EB17198EF2B07B58506138CBD144D275A81E8D54BDDBE3156BA40BA7D8EC57D2995A34312FFD1C6F3D6FF879101A1B84A9D0E4844192CBC2A6A927763F4C40AE603FB573AD3BB64C3E094DA135F1F6DDC662DBB49E75622E06C848F872648C4260142624EF8F5FB362FC996C2461D4C341383237B6C6FBFABCE529B3EFBC7511FAE912B9D3D0112A293CAA1DE6C7E1C28DDF019578C21A5731ACB8FE4753F3F6421045471E00E33BB82D848214E34C0C0528AF144DBDB62F45DC74D3774595C00058747F1C4D78B2C28938BA47B5EF62AFDD3719CB10A08F5633C0D88F9AEAE9C3B4E74883A11D6F25F052CD1F7269784654FFB3B95DBB8B7E49F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 1C4CD5DFF6CCC5B2FB8E7535A8374D7C1028788BA8E0E14E20EA1EC24967675B4DC9B63FCD82EA35E6195B2B33CFC213DB4AE06412884CA1AE1619252109C121024FCD42A9BE2B23B3AA45AD1F1CCC7516AC449025954F1140B2D6123AADB21DA3C07773AE304036B6497D78693E599277F4D6FBBC5092E5F53C4185351EA8F26E9D9F08F125177A17F1E75F1AE88C0F64BE7325A69736E1F32F1523861C0A0C30969CAEB3BB0B9FFA2A854D38EC839623C2DD5256CF1DA13BEE06D4AAB305BBD7253F0F00ABE209EED2F9DEBA24F084E5BBD3CDBE07A95B87EE88B800C5150E5D0293046DD068E5896F6ACE8DB7919C741ECBA15C508FA902192C7D9A53B401</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 40 D6 59 B1 27 2C F7 5A EE A1 83 3A
0010 | 66 BE D1 DA EB A4 DF 47 84 75 8E BA 7D B4 DA 94
0020 | FF AB 83 FD 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 1C 4C D5 DF F6 CC C5 B2 FB 8E 75 35 A8 37 4D 7C
0040 | 10 28 78 8B A8 E0 E1 4E 20 EA 1E C2 49 67 67 5B
0050 | 4D C9 B6 3F CD 82 EA 35 E6 19 5B 2B 33 CF C2 13
0060 | DB 4A E0 64 12 88 4C A1 AE 16 19 25 21 09 C1 21
0070 | 02 4F CD 42 A9 BE 2B 23 B3 AA 45 AD 1F 1C CC 75
0080 | 16 AC 44 90 25 95 4F 11 40 B2 D6 12 3A AD B2 1D
0090 | A3 C0 77 73 AE 30 40 36 B6 49 7D 78 69 3E 59 92
00A0 | 77 F4 D6 FB BC 50 92 E5 F5 3C 41 85 35 1E A8 F2
00B0 | 6E 9D 9F 08 F1 25 17 7A 17 F1 E7 5F 1A E8 8C 0F
00C0 | 64 BE 73 25 A6 97 36 E1 F3 2F 15 23 86 1C 0A 0C
00D0 | 30 96 9C AE B3 BB 0B 9F FA 2A 85 4D 38 EC 83 96
00E0 | 23 C2 DD 52 56 CF 1D A1 3B EE 06 D4 AA B3 05 BB
00F0 | D7 25 3F 0F 00 AB E2 09 EE D2 F9 DE BA 24 F0 84
0100 | E5 BB D3 CD BE 07 A9 5B 87 EE 88 B8 00 C5 15 0E
0110 | 5D 02 93 04 6D D0 68 E5 89 6F 6A CE 8D B7 91 9C
0120 | 74 1E CB A1 5C 50 8F A9 02 19 2C 7D 9A 53 B4 01</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001001C4CD5DFF6CCC5B2FB8E7535</code> <code>A8374D7C1028788BA8E0E14E20EA1EC2</code> <code>4967675B4DC9B63FCD82EA35E6195B2B</code> <code>33CFC213DB4AE06412884CA1AE161925</code> <code>2109C121024FCD42A9BE2B23B3AA45AD</code> <code>1F1CCC7516AC449025954F1140B2D612</code> <code>3AADB21DA3C07773AE304036B6497D78</code> <code>693E599277F4D6FBBC5092E5F53C4185</code> <code>351EA8F26E9D9F08F125177A17F1E75F</code> <code>1AE88C0F64BE7325A69736E1F32F1523</code> <code>861C0A0C30969CAEB3BB0B9FFA2A854D</code> <code>38EC839623C2DD5256CF1DA13BEE06D4</code> <code>AAB305BBD7253F0F00ABE209EED2F9DE</code> <code>BA24F084E5BBD3CDBE07A95B87EE88B8</code> <code>00C5150E5D0293046DD068E5896F6ACE</code> <code>8DB7919C741ECBA15C508FA902192C7D</code><br> <code>9A53B401</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436640D659B1272CF75AEEA1833A66BED1DAEBA4DF4784758EBA7DB4DA94FFAB83FD0000000000000000FE0001001C4CD5DFF6CCC5B2FB8E7535A8374D7C1028788BA8E0E14E20EA1EC24967675B4DC9B63FCD82EA35E6195B2B33CFC213DB4AE06412884CA1AE1619252109C121024FCD42A9BE2B23B3AA45AD1F1CCC7516AC449025954F1140B2D6123AADB21DA3C07773AE304036B6497D78693E599277F4D6FBBC5092E5F53C4185351EA8F26E9D9F08F125177A17F1E75F1AE88C0F64BE7325A69736E1F32F1523861C0A0C30969CAEB3BB0B9FFA2A854D38EC839623C2DD5256CF1DA13BEE06D4AAB305BBD7253F0F00ABE209EED2F9DEBA24F084E5BBD3CDBE07A95B87EE88B800C5150E5D0293046DD068E5896F6ACE8DB7919C741ECBA15C508FA902192C7D9A53B401
padding = E13CA42691F8DB3231782F87
tmp_aes_key = 9F80404847B20E9F8D5357E4FE4CCDF4D9D670F8D21B57ED4AA667DC16391151
tmp_aes_iv = 4826EC48442743B263E4F6F7A8C874D2B11E4D67634DA5F05B5963FEADEB4D91</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 9650445AD6C9B22DA795AEA28948BD7D2FEDC2AB174CA134361803ABFF40DC52E8322703D55A0A01556511D329AAB8DA1017EFAF1746CB6BA8E48FADBBA12EA797D9BF4532C368908D05E7F57B0108BFACE7922CB7C05897EB3B2D0E45F89E9C7425B0E9B35A52FE7D0D89CC412C8DA2D4C84512C306909D61FE6179D38C3CE5F163068F08FDE60201FEFF083E6B075EE8F8CB63CB9E48D1AD814BB14D211C3A993E8959684B19C6AB2CF4494E68FB7217BC9F62DC6C432995D34CC63BC04EB8C17E4FB9BCC34F401FD737384AB0AEA73CE407667D266BB8683A70BBD3EDBD3BBC4CC7049BDD731A422D98E5010F9D389E365D38287EB406154DA781621C7D61FCFFA007371D1FB866EC3E6933B4C8284EE8C0F29CF27778B0AB574F42921F8622E22E730F0900A05BCC29C0D05B6C7AE901323FF88E7BCCE4AA1805C1F2559FF52B46D3D814C52E2E9E5BCE339F91BA</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 9C 8D 0E 00 6D AC 7C 65
0010 | 78 01 00 00 1F 5F 04 F5 40 D6 59 B1 27 2C F7 5A
0020 | EE A1 83 3A 66 BE D1 DA EB A4 DF 47 84 75 8E BA
0030 | 7D B4 DA 94 FF AB 83 FD FE 50 01 00 96 50 44 5A
0040 | D6 C9 B2 2D A7 95 AE A2 89 48 BD 7D 2F ED C2 AB
0050 | 17 4C A1 34 36 18 03 AB FF 40 DC 52 E8 32 27 03
0060 | D5 5A 0A 01 55 65 11 D3 29 AA B8 DA 10 17 EF AF
0070 | 17 46 CB 6B A8 E4 8F AD BB A1 2E A7 97 D9 BF 45
0080 | 32 C3 68 90 8D 05 E7 F5 7B 01 08 BF AC E7 92 2C
0090 | B7 C0 58 97 EB 3B 2D 0E 45 F8 9E 9C 74 25 B0 E9
00A0 | B3 5A 52 FE 7D 0D 89 CC 41 2C 8D A2 D4 C8 45 12
00B0 | C3 06 90 9D 61 FE 61 79 D3 8C 3C E5 F1 63 06 8F
00C0 | 08 FD E6 02 01 FE FF 08 3E 6B 07 5E E8 F8 CB 63
00D0 | CB 9E 48 D1 AD 81 4B B1 4D 21 1C 3A 99 3E 89 59
00E0 | 68 4B 19 C6 AB 2C F4 49 4E 68 FB 72 17 BC 9F 62
00F0 | DC 6C 43 29 95 D3 4C C6 3B C0 4E B8 C1 7E 4F B9
0100 | BC C3 4F 40 1F D7 37 38 4A B0 AE A7 3C E4 07 66
0110 | 7D 26 6B B8 68 3A 70 BB D3 ED BD 3B BC 4C C7 04
0120 | 9B DD 73 1A 42 2D 98 E5 01 0F 9D 38 9E 36 5D 38
0130 | 28 7E B4 06 15 4D A7 81 62 1C 7D 61 FC FF A0 07
0140 | 37 1D 1F B8 66 EC 3E 69 33 B4 C8 28 4E E8 C0 F2
0150 | 9C F2 77 78 B0 AB 57 4F 42 92 1F 86 22 E2 2E 73
0160 | 0F 09 00 A0 5B CC 29 C0 D0 5B 6C 7A E9 01 32 3F
0170 | F8 8E 7B CC E4 AA 18 05 C1 F2 55 9F F5 2B 46 D3
0180 | D8 14 C5 2E 2E 9E 5B CE 33 9F 91 BA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>9C8D0E006DAC7C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001009650445AD6C9B22DA795AEA2</code> <code>8948BD7D2FEDC2AB174CA134361803AB</code> <code>FF40DC52E8322703D55A0A01556511D3</code> <code>29AAB8DA1017EFAF1746CB6BA8E48FAD</code> <code>BBA12EA797D9BF4532C368908D05E7F5</code> <code>7B0108BFACE7922CB7C05897EB3B2D0E</code> <code>45F89E9C7425B0E9B35A52FE7D0D89CC</code> <code>412C8DA2D4C84512C306909D61FE6179</code> <code>D38C3CE5F163068F08FDE60201FEFF08</code> <code>3E6B075EE8F8CB63CB9E48D1AD814BB1</code> <code>4D211C3A993E8959684B19C6AB2CF449</code> <code>4E68FB7217BC9F62DC6C432995D34CC6</code> <code>3BC04EB8C17E4FB9BCC34F401FD73738</code> <code>4AB0AEA73CE407667D266BB8683A70BB</code> <code>D3EDBD3BBC4CC7049BDD731A422D98E5</code> <code>010F9D389E365D38287EB406154DA781</code> <code>621C7D61FCFFA007371D1FB866EC3E69</code> <code>33B4C8284EE8C0F29CF27778B0AB574F</code> <code>42921F8622E22E730F0900A05BCC29C0</code> <code>D05B6C7AE901323FF88E7BCCE4AA1805</code> <code>C1F2559FF52B46D3D814C52E2E9E5BCE</code><br> <code>339F91BA</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 704962C6CEE4F017E536B0FCD4E4C0A67BF4281A5192E1729EDA71F69744F28735DD10CCAF8CBF9A8B41B7C6552CE597D2E798CDEEA549151B6732A9993EE6E4594B27F7344F10A655888EF4EB7695A150E5BCAF826EBAE56724252B42425F72B5AF57F88141617247513A7DCED1B4A77CDA6EA70D4E7838391B43814C4A57FE87EB9FC3C11246DC6480A35E51045598AE8C5C3BDBBEF945E2F3E5B23B7D613CF818B6340280B91FDDB182D3DE96BAD1DD1A88A03B801158FCD816488DC9A0C186BBBB6FFDCE4D959556FE82115BB1DCDBD8880666FEE86B4F3FF51254873DA79E3F90CA692EB2784A48413FB663A472542B8A9B7DC3E449CF94B3E1C8163BC9</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 8C D5 FB 6D AC 7C 65
0010 | 58 00 00 00 34 F7 CB 3B 40 D6 59 B1 27 2C F7 5A
0020 | EE A1 83 3A 66 BE D1 DA EB A4 DF 47 84 75 8E BA
0030 | 7D B4 DA 94 FF AB 83 FD 0A D7 C8 3B BA 5E 75 ED
0040 | C6 53 7C D2 2A 01 D0 AE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018CD5FB6DAC7C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>40D659B1272CF75AEEA1833A66BED1DA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA4DF4784758EBA7DB4DA94FFAB83FD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>0AD7C83BBA5E75EDC6537CD22A01D0AE</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

