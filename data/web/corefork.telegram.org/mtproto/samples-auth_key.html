<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B8 92 06 00 E0 C8 AB 65
0010 | 14 00 00 00 F1 8E 7E BE FB 6C 67 30 A2 09 CF B4
0020 | D9 9B 31 0D 48 CA 7F EC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B8920600E0C8AB65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E4 56 EC E0 C8 AB 65
0010 | B0 00 00 00 63 24 16 05 FB 6C 67 30 A2 09 CF B4
0020 | D9 9B 31 0D 48 CA 7F EC 48 08 2D 3E 05 DF D9 54
0030 | B9 8C E6 56 43 8A 88 00 08 23 36 C6 E0 E2 33 26
0040 | F3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E456ECE0C8AB65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0000000</code> (176 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082336C6E0E23326F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2537434109239830259</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2537434109239830259</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2537434109239830259 = 1348056659 * 1882290401</code></p>
<pre><code>p = 1348056659
q = 1882290401</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 23 36 C6 E0 E2 33 26 F3 00 00 00
0010 | 04 50 59 B6 53 00 00 00 04 70 31 78 E1 00 00 00
0020 | FB 6C 67 30 A2 09 CF B4 D9 9B 31 0D 48 CA 7F EC
0030 | 48 08 2D 3E 05 DF D9 54 B9 8C E6 56 43 8A 88 00
0040 | 2A 9D 4F F9 67 66 46 22 11 35 F9 26 8D A4 CA FA
0050 | A1 81 C5 87 8C 47 34 60 9D 85 8E CF FB 29 B9 6A
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082336C6E0E23326F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2537434109239830259</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045059B653000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1348056659</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04703178E1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1882290401</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>2A9D4FF9676646221135F9268DA4CAFA</code> <code>A181C5878C4734609D858ECFFB29B96A</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082336C6E0E23326F3000000045059B65300000004703178E1000000FB6C6730A209CFB4D99B310D48CA7FEC48082D3E05DFD954B98CE656438A88002A9D4FF9676646221135F9268DA4CAFAA181C5878C4734609D858ECFFB29B96A02000000
random_padding_bytes = CD346AD4AD38B8C438E8A868A0F1D5F306FB360A76DF2579C80256F6E4758D0A2DC3C846AA6F3B47533291C046553EB42DE83E50D1AB68368CB8C45C7FD2C307FAADBC4A7A29898625E558FB4EA52D139D11FECEF23C8EE826FD8451</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 252C4634765441727FA848CB542B01A8E894E1F6E00D57825C41AB0671803F15DB27934EEC7BAAF81BD231EA5F46824E963CB43DAEE3751FAB065A89B46FC39639A2CF5083B91457D1266F0E7B8205FC0498B2CE92B119A335362C1D993EC848D1ECDCB3E9B1DABB6306134E32128BF60B6DE34D5B48E1FFCEE1F3E10E6646FE40F05ADF3E7C357ABB1C958B110F3346DB06BD05682BA6AD73121496EC64C2B98DEF4A7195E009BB8D8DCBC14853A4EF512E14CBC9CF6173156884F30993622F3FF7D909B44CA7B54937FDD5E2DCB7945E8D6FCB87A082D7E212D122A7FC14FAA16F42FE25C2B52F0E9D0E9D73285A55001110C40E1844E2800881850653D87E</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E8 5F 07 00 E0 C8 AB 65
0010 | 40 01 00 00 BE E4 12 D7 FB 6C 67 30 A2 09 CF B4
0020 | D9 9B 31 0D 48 CA 7F EC 48 08 2D 3E 05 DF D9 54
0030 | B9 8C E6 56 43 8A 88 00 04 50 59 B6 53 00 00 00
0040 | 04 70 31 78 E1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 25 2C 46 34 76 54 41 72 7F A8 48 CB
0060 | 54 2B 01 A8 E8 94 E1 F6 E0 0D 57 82 5C 41 AB 06
0070 | 71 80 3F 15 DB 27 93 4E EC 7B AA F8 1B D2 31 EA
0080 | 5F 46 82 4E 96 3C B4 3D AE E3 75 1F AB 06 5A 89
0090 | B4 6F C3 96 39 A2 CF 50 83 B9 14 57 D1 26 6F 0E
00A0 | 7B 82 05 FC 04 98 B2 CE 92 B1 19 A3 35 36 2C 1D
00B0 | 99 3E C8 48 D1 EC DC B3 E9 B1 DA BB 63 06 13 4E
00C0 | 32 12 8B F6 0B 6D E3 4D 5B 48 E1 FF CE E1 F3 E1
00D0 | 0E 66 46 FE 40 F0 5A DF 3E 7C 35 7A BB 1C 95 8B
00E0 | 11 0F 33 46 DB 06 BD 05 68 2B A6 AD 73 12 14 96
00F0 | EC 64 C2 B9 8D EF 4A 71 95 E0 09 BB 8D 8D CB C1
0100 | 48 53 A4 EF 51 2E 14 CB C9 CF 61 73 15 68 84 F3
0110 | 09 93 62 2F 3F F7 D9 09 B4 4C A7 B5 49 37 FD D5
0120 | E2 DC B7 94 5E 8D 6F CB 87 A0 82 D7 E2 12 D1 22
0130 | A7 FC 14 FA A1 6F 42 FE 25 C2 B5 2F 0E 9D 0E 9D
0140 | 73 28 5A 55 00 11 10 C4 0E 18 44 E2 80 08 81 85
0150 | 06 53 D8 7E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E85F0700E0C8AB65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045059B653000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1348056659</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04703178E1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1882290401</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100252C4634765441727FA848CB</code> <code>542B01A8E894E1F6E00D57825C41AB06</code> <code>71803F15DB27934EEC7BAAF81BD231EA</code> <code>5F46824E963CB43DAEE3751FAB065A89</code> <code>B46FC39639A2CF5083B91457D1266F0E</code> <code>7B8205FC0498B2CE92B119A335362C1D</code> <code>993EC848D1ECDCB3E9B1DABB6306134E</code> <code>32128BF60B6DE34D5B48E1FFCEE1F3E1</code> <code>0E6646FE40F05ADF3E7C357ABB1C958B</code> <code>110F3346DB06BD05682BA6AD73121496</code> <code>EC64C2B98DEF4A7195E009BB8D8DCBC1</code> <code>4853A4EF512E14CBC9CF6173156884F3</code> <code>0993622F3FF7D909B44CA7B54937FDD5</code> <code>E2DCB7945E8D6FCB87A082D7E212D122</code> <code>A7FC14FAA16F42FE25C2B52F0E9D0E9D</code> <code>73285A55001110C40E1844E280088185</code><br> <code>0653D87E</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 08 1A 7F E1 C8 AB 65
0010 | 78 02 00 00 5C 07 E8 D0 FB 6C 67 30 A2 09 CF B4
0020 | D9 9B 31 0D 48 CA 7F EC 48 08 2D 3E 05 DF D9 54
0030 | B9 8C E6 56 43 8A 88 00 FE 50 02 00 14 35 00 42
0040 | D3 61 5E 00 17 76 EB 73 01 70 96 30 2C 4E 83 7C
0050 | 75 05 77 67 15 2D 99 A3 A0 74 A9 7D DC AE AF E1
0060 | A4 33 D6 C4 CC 28 96 39 70 B6 AA 2F A0 A5 7D F9
0070 | 6D 13 09 96 F1 F8 A5 89 03 6E 72 68 BF 01 D8 03
0080 | 8F 2C E2 AF 16 3A D7 C9 6F A5 B8 9A 10 67 E4 7B
0090 | D0 ED 3B EC F6 89 37 1C 63 2D E7 4C E6 B4 5D 53
00A0 | 00 FA 72 59 DC BF 22 A0 3B 52 FE 42 A7 77 DA A8
00B0 | DF B2 7E B7 E8 E3 CB 12 55 E7 BF A1 19 B8 FD E3
00C0 | 6A D0 A0 61 B3 1B 12 CA B7 6E A4 27 2E F3 B5 B6
00D0 | 68 07 C3 E1 37 68 D0 50 BD 8F 1E 0B F0 23 5D CC
00E0 | 9D 05 3E BD 31 E7 FA 58 E1 52 2D 94 49 6D E2 17
00F0 | B9 71 61 81 24 34 DE 4D 20 20 8D 05 DE E4 AF A5
0100 | A7 36 11 D4 5C 08 02 D7 00 52 34 96 A4 84 F7 8C
0110 | 01 C8 DE F1 A7 13 C8 62 22 11 A4 EB A7 FB 9D 03
0120 | 86 82 AD 80 67 8A D0 C8 31 C3 29 2E 00 8E 5D F9
0130 | 5C 30 DF 9B 68 0F 85 99 1A 92 B3 C4 0F 52 B1 9E
0140 | A4 08 E4 5D 2F DE 9D B6 A3 0A 67 EE A4 B5 76 E8
0150 | 69 98 4C 8C 82 EB 84 A1 94 25 4D 66 FD 2F 25 C1
0160 | 9A 27 88 A4 C8 07 A8 A9 C6 85 9B CD 3F E0 19 1D
0170 | 44 24 35 F2 D2 64 F6 7E A4 4A CE 2C D9 73 8E B1
0180 | C4 7E AE FE 0C 49 7B 98 2D 1E 3F 4E DE C3 10 F9
0190 | D4 E6 A8 FD 90 D9 5D B3 D6 FA 9F CA DF B3 AB 88
01A0 | C4 47 24 92 A9 2D 84 65 A3 D1 A5 3A 67 21 6F E0
01B0 | CE F6 23 54 50 E5 D9 6F 7B 8D 62 CB 62 FE 6B 31
01C0 | A3 19 52 08 0B 38 C4 C6 80 71 D2 4E 26 D4 11 42
01D0 | 20 3E F0 10 97 A0 3A BC B9 70 79 D4 88 41 29 E5
01E0 | C9 65 FD 9C F9 BB 54 CB E2 BF E7 4F 5B 5A D5 CD
01F0 | E5 2C ED 8C 64 8E EB 87 B3 7C 20 2A 8D 7F 4C 90
0200 | 08 F5 6F 58 9E D1 CA 14 FC AA 45 AF A2 78 C6 F6
0210 | E0 5A 09 D8 C5 FD 17 D9 C7 1B B5 0E F2 8A 28 37
0220 | C4 32 C0 D4 B4 65 32 57 63 FA EC 7B 08 82 5D 8A
0230 | 38 11 01 71 F4 E9 0C E4 98 6C AE FC 9A 8E 6D 06
0240 | 01 50 22 0F AD BF 5F 98 23 4F 39 4C C2 54 C4 A8
0250 | BB 77 23 80 57 F2 AB D3 6D 9C 0A 9C E8 44 0D 9E
0260 | 34 FE 83 E2 86 96 F0 EB 13 DB 81 BB B4 57 10 0C
0270 | A8 39 60 DC A8 3D 3E FB 03 74 47 C2 6A 80 24 EB
0280 | 26 21 68 05 27 35 EA 06 7A CC B6 0B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01081A7FE1C8AB65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020014350042D3615E001776EB73</code> <code>017096302C4E837C75057767152D99A3</code> <code>A074A97DDCAEAFE1A433D6C4CC289639</code> <code>70B6AA2FA0A57DF96D130996F1F8A589</code> <code>036E7268BF01D8038F2CE2AF163AD7C9</code> <code>6FA5B89A1067E47BD0ED3BECF689371C</code> <code>632DE74CE6B45D5300FA7259DCBF22A0</code> <code>3B52FE42A777DAA8DFB27EB7E8E3CB12</code> <code>55E7BFA119B8FDE36AD0A061B31B12CA</code> <code>B76EA4272EF3B5B66807C3E13768D050</code> <code>BD8F1E0BF0235DCC9D053EBD31E7FA58</code> <code>E1522D94496DE217B97161812434DE4D</code> <code>20208D05DEE4AFA5A73611D45C0802D7</code> <code>00523496A484F78C01C8DEF1A713C862</code> <code>2211A4EBA7FB9D038682AD80678AD0C8</code> <code>31C3292E008E5DF95C30DF9B680F8599</code> <code>1A92B3C40F52B19EA408E45D2FDE9DB6</code> <code>A30A67EEA4B576E869984C8C82EB84A1</code> <code>94254D66FD2F25C19A2788A4C807A8A9</code> <code>C6859BCD3FE0191D442435F2D264F67E</code> <code>A44ACE2CD9738EB1C47EAEFE0C497B98</code> <code>2D1E3F4EDEC310F9D4E6A8FD90D95DB3</code> <code>D6FA9FCADFB3AB88C4472492A92D8465</code> <code>A3D1A53A67216FE0CEF6235450E5D96F</code> <code>7B8D62CB62FE6B31A31952080B38C4C6</code> <code>8071D24E26D41142203EF01097A03ABC</code> <code>B97079D4884129E5C965FD9CF9BB54CB</code> <code>E2BFE74F5B5AD5CDE52CED8C648EEB87</code> <code>B37C202A8D7F4C9008F56F589ED1CA14</code> <code>FCAA45AFA278C6F6E05A09D8C5FD17D9</code> <code>C71BB50EF28A2837C432C0D4B4653257</code> <code>63FAEC7B08825D8A38110171F4E90CE4</code> <code>986CAEFC9A8E6D060150220FADBF5F98</code> <code>234F394CC254C4A8BB77238057F2ABD3</code> <code>6D9C0A9CE8440D9E34FE83E28696F0EB</code> <code>13DB81BBB457100CA83960DCA83D3EFB</code> <code>037447C26A8024EB262168052735EA06</code><br> <code>7ACCB60B</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 14350042D3615E001776EB73017096302C4E837C75057767152D99A3A074A97DDCAEAFE1A433D6C4CC28963970B6AA2FA0A57DF96D130996F1F8A589036E7268BF01D8038F2CE2AF163AD7C96FA5B89A1067E47BD0ED3BECF689371C632DE74CE6B45D5300FA7259DCBF22A03B52FE42A777DAA8DFB27EB7E8E3CB1255E7BFA119B8FDE36AD0A061B31B12CAB76EA4272EF3B5B66807C3E13768D050BD8F1E0BF0235DCC9D053EBD31E7FA58E1522D94496DE217B97161812434DE4D20208D05DEE4AFA5A73611D45C0802D700523496A484F78C01C8DEF1A713C8622211A4EBA7FB9D038682AD80678AD0C831C3292E008E5DF95C30DF9B680F85991A92B3C40F52B19EA408E45D2FDE9DB6A30A67EEA4B576E869984C8C82EB84A194254D66FD2F25C19A2788A4C807A8A9C6859BCD3FE0191D442435F2D264F67EA44ACE2CD9738EB1C47EAEFE0C497B982D1E3F4EDEC310F9D4E6A8FD90D95DB3D6FA9FCADFB3AB88C4472492A92D8465A3D1A53A67216FE0CEF6235450E5D96F7B8D62CB62FE6B31A31952080B38C4C68071D24E26D41142203EF01097A03ABCB97079D4884129E5C965FD9CF9BB54CBE2BFE74F5B5AD5CDE52CED8C648EEB87B37C202A8D7F4C9008F56F589ED1CA14FCAA45AFA278C6F6E05A09D8C5FD17D9C71BB50EF28A2837C432C0D4B465325763FAEC7B08825D8A38110171F4E90CE4986CAEFC9A8E6D060150220FADBF5F98234F394CC254C4A8BB77238057F2ABD36D9C0A9CE8440D9E34FE83E28696F0EB13DB81BBB457100CA83960DCA83D3EFB037447C26A8024EB262168052735EA067ACCB60B
tmp_aes_key = 939A48A4F8097727F06DDF7AAC298444991F6804620AC0E12890D2F8750F0BF1
tmp_aes_iv = 2CCC8FF240E00E900DDD34DC87C89B2F9383AEEEF45322E44F4119962A9D4FF9</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = AF6DBFB2611362E8C2947C7F6A311346D4786AE8BA0D89B5FB6C6730A209CFB4D99B310D48CA7FEC48082D3E05DFD954B98CE656438A880003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010049743B49768F04B6845C3DB77A4E8319CA4DDDBA4A97EA63AFB0DD54AFF8D5552B5BC9534F28EEBD7FC2566E7C05ACE4F1ED5276E5E46EC842B3B6ABA708D50A31D423C3A1E48D1D290D13A7069D73414966418A0B5FFA05F7D2D3478EA313C292664A21C30E417DCE4B1B0E0D325BFB6FF685D1DFC36DBA550A41BC8FAAF81B376BEB41651B7EBAE3E49D004553D3D5252E4539A87FA449F33D211F2FEF3390CDC86FF3C8F0FD89BB963854324EC93D8997E867D8AFF4C445380A9DD5544C07F7850E552B350245D03FB4AAA015DFE1C2261695BD2A999226D102094BEF244C38200A05D1BDF586D40E00381C4069DBFCFB80F1BD10C2F710FDD53D614E79B4E1C8AB65081762C7B45FA64D
answer = BA0D89B5FB6C6730A209CFB4D99B310D48CA7FEC48082D3E05DFD954B98CE656438A880003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010049743B49768F04B6845C3DB77A4E8319CA4DDDBA4A97EA63AFB0DD54AFF8D5552B5BC9534F28EEBD7FC2566E7C05ACE4F1ED5276E5E46EC842B3B6ABA708D50A31D423C3A1E48D1D290D13A7069D73414966418A0B5FFA05F7D2D3478EA313C292664A21C30E417DCE4B1B0E0D325BFB6FF685D1DFC36DBA550A41BC8FAAF81B376BEB41651B7EBAE3E49D004553D3D5252E4539A87FA449F33D211F2FEF3390CDC86FF3C8F0FD89BB963854324EC93D8997E867D8AFF4C445380A9DD5544C07F7850E552B350245D03FB4AAA015DFE1C2261695BD2A999226D102094BEF244C38200A05D1BDF586D40E00381C4069DBFCFB80F1BD10C2F710FDD53D614E79B4E1C8AB65081762C7B45FA64D</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 FB 6C 67 30 A2 09 CF B4 D9 9B 31 0D
0010 | 48 CA 7F EC 48 08 2D 3E 05 DF D9 54 B9 8C E6 56
0020 | 43 8A 88 00 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 49 74 3B 49 76 8F 04 B6 84 5C 3D B7 7A 4E 83 19
0140 | CA 4D DD BA 4A 97 EA 63 AF B0 DD 54 AF F8 D5 55
0150 | 2B 5B C9 53 4F 28 EE BD 7F C2 56 6E 7C 05 AC E4
0160 | F1 ED 52 76 E5 E4 6E C8 42 B3 B6 AB A7 08 D5 0A
0170 | 31 D4 23 C3 A1 E4 8D 1D 29 0D 13 A7 06 9D 73 41
0180 | 49 66 41 8A 0B 5F FA 05 F7 D2 D3 47 8E A3 13 C2
0190 | 92 66 4A 21 C3 0E 41 7D CE 4B 1B 0E 0D 32 5B FB
01A0 | 6F F6 85 D1 DF C3 6D BA 55 0A 41 BC 8F AA F8 1B
01B0 | 37 6B EB 41 65 1B 7E BA E3 E4 9D 00 45 53 D3 D5
01C0 | 25 2E 45 39 A8 7F A4 49 F3 3D 21 1F 2F EF 33 90
01D0 | CD C8 6F F3 C8 F0 FD 89 BB 96 38 54 32 4E C9 3D
01E0 | 89 97 E8 67 D8 AF F4 C4 45 38 0A 9D D5 54 4C 07
01F0 | F7 85 0E 55 2B 35 02 45 D0 3F B4 AA A0 15 DF E1
0200 | C2 26 16 95 BD 2A 99 92 26 D1 02 09 4B EF 24 4C
0210 | 38 20 0A 05 D1 BD F5 86 D4 0E 00 38 1C 40 69 DB
0220 | FC FB 80 F1 BD 10 C2 F7 10 FD D5 3D 61 4E 79 B4
0230 | E1 C8 AB 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010049743B49768F04B6845C3DB7</code> <code>7A4E8319CA4DDDBA4A97EA63AFB0DD54</code> <code>AFF8D5552B5BC9534F28EEBD7FC2566E</code> <code>7C05ACE4F1ED5276E5E46EC842B3B6AB</code> <code>A708D50A31D423C3A1E48D1D290D13A7</code> <code>069D73414966418A0B5FFA05F7D2D347</code> <code>8EA313C292664A21C30E417DCE4B1B0E</code> <code>0D325BFB6FF685D1DFC36DBA550A41BC</code> <code>8FAAF81B376BEB41651B7EBAE3E49D00</code> <code>4553D3D5252E4539A87FA449F33D211F</code> <code>2FEF3390CDC86FF3C8F0FD89BB963854</code> <code>324EC93D8997E867D8AFF4C445380A9D</code> <code>D5544C07F7850E552B350245D03FB4AA</code> <code>A015DFE1C2261695BD2A999226D10209</code> <code>4BEF244C38200A05D1BDF586D40E0038</code> <code>1C4069DBFCFB80F1BD10C2F710FDD53D</code><br> <code>614E79B4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E1C8AB65</code> (1705756897 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = AAD47B1DA97968D0050F9F7757700FABA551B3BFCD4628A1BDBA2EE5CE811C84C46667CB570FDA558FC050D33D150B88E44C1E3416CF3D44E95FAB68B2C61DADBD74862A3E1304CAE0F02F7995D8C4BBEA9F4527681F172FD724A04B97FF7EA84B47C2A0121B09F16391EB3906D8988E3F1BEA7534DD29540688303AA81D5F722C7CF9021703943F3E47CAEACABED8795935AAD8999701F0662C9CC3F046BBD030AC6FE5972B6A4BFC40E707A526D0A426462C5CE3E1D3295AC6924DE4E72CA00997FFCB89AB931D0C7EE9BCC52F1EA67F322F01E3DBA4E66F7DDE3844FF15CCB310300BAA837F1632E0F81B0ADFB57F08755215782D467C4CD4BEE97228D9DF</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4895872FF27C396A60C98CDBCB5469C0948242EEBE99A0ED4573CC10C668AE4A1B660538498D554434308DF026482083ECA6D67201663EB55F2C076C43CCE5079AF08E574D566F294DEA2421D1BF1513624572E0EFDBF8A10B981C6515FB9D6D4EEF01AB489380DEBAAC59E4BD35BA74AA59E752A5FC4670C9715A9EA6846D0E3D7B0208F7BE18DC5CA600873F455BB080F23F45AFA715750A0F76730A0DD2A6DDC94A15FF51E0A3E7F28C32D784931F2ECDBAE8CD27EA54AC2C99AF8ADACDC377F219139893B27AB6C25653E17F34950C60B419F20D8C768FD9A1777198BF3E1B9C7806CB207FE33C090BB286FE67BD80A57496B0BA02959A6E57AE329C9A39</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 FB 6C 67 30 A2 09 CF B4 D9 9B 31 0D
0010 | 48 CA 7F EC 48 08 2D 3E 05 DF D9 54 B9 8C E6 56
0020 | 43 8A 88 00 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 48 95 87 2F F2 7C 39 6A 60 C9 8C DB CB 54 69 C0
0040 | 94 82 42 EE BE 99 A0 ED 45 73 CC 10 C6 68 AE 4A
0050 | 1B 66 05 38 49 8D 55 44 34 30 8D F0 26 48 20 83
0060 | EC A6 D6 72 01 66 3E B5 5F 2C 07 6C 43 CC E5 07
0070 | 9A F0 8E 57 4D 56 6F 29 4D EA 24 21 D1 BF 15 13
0080 | 62 45 72 E0 EF DB F8 A1 0B 98 1C 65 15 FB 9D 6D
0090 | 4E EF 01 AB 48 93 80 DE BA AC 59 E4 BD 35 BA 74
00A0 | AA 59 E7 52 A5 FC 46 70 C9 71 5A 9E A6 84 6D 0E
00B0 | 3D 7B 02 08 F7 BE 18 DC 5C A6 00 87 3F 45 5B B0
00C0 | 80 F2 3F 45 AF A7 15 75 0A 0F 76 73 0A 0D D2 A6
00D0 | DD C9 4A 15 FF 51 E0 A3 E7 F2 8C 32 D7 84 93 1F
00E0 | 2E CD BA E8 CD 27 EA 54 AC 2C 99 AF 8A DA CD C3
00F0 | 77 F2 19 13 98 93 B2 7A B6 C2 56 53 E1 7F 34 95
0100 | 0C 60 B4 19 F2 0D 8C 76 8F D9 A1 77 71 98 BF 3E
0110 | 1B 9C 78 06 CB 20 7F E3 3C 09 0B B2 86 FE 67 BD
0120 | 80 A5 74 96 B0 BA 02 95 9A 6E 57 AE 32 9C 9A 39</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004895872FF27C396A60C98CDB</code> <code>CB5469C0948242EEBE99A0ED4573CC10</code> <code>C668AE4A1B660538498D554434308DF0</code> <code>26482083ECA6D67201663EB55F2C076C</code> <code>43CCE5079AF08E574D566F294DEA2421</code> <code>D1BF1513624572E0EFDBF8A10B981C65</code> <code>15FB9D6D4EEF01AB489380DEBAAC59E4</code> <code>BD35BA74AA59E752A5FC4670C9715A9E</code> <code>A6846D0E3D7B0208F7BE18DC5CA60087</code> <code>3F455BB080F23F45AFA715750A0F7673</code> <code>0A0DD2A6DDC94A15FF51E0A3E7F28C32</code> <code>D784931F2ECDBAE8CD27EA54AC2C99AF</code> <code>8ADACDC377F219139893B27AB6C25653</code> <code>E17F34950C60B419F20D8C768FD9A177</code> <code>7198BF3E1B9C7806CB207FE33C090BB2</code> <code>86FE67BD80A57496B0BA02959A6E57AE</code><br> <code>329C9A39</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366FB6C6730A209CFB4D99B310D48CA7FEC48082D3E05DFD954B98CE656438A88000000000000000000FE0001004895872FF27C396A60C98CDBCB5469C0948242EEBE99A0ED4573CC10C668AE4A1B660538498D554434308DF026482083ECA6D67201663EB55F2C076C43CCE5079AF08E574D566F294DEA2421D1BF1513624572E0EFDBF8A10B981C6515FB9D6D4EEF01AB489380DEBAAC59E4BD35BA74AA59E752A5FC4670C9715A9EA6846D0E3D7B0208F7BE18DC5CA600873F455BB080F23F45AFA715750A0F76730A0DD2A6DDC94A15FF51E0A3E7F28C32D784931F2ECDBAE8CD27EA54AC2C99AF8ADACDC377F219139893B27AB6C25653E17F34950C60B419F20D8C768FD9A1777198BF3E1B9C7806CB207FE33C090BB286FE67BD80A57496B0BA02959A6E57AE329C9A39
padding = 135F6FBA425997B3BB0A66C0
tmp_aes_key = 939A48A4F8097727F06DDF7AAC298444991F6804620AC0E12890D2F8750F0BF1
tmp_aes_iv = 2CCC8FF240E00E900DDD34DC87C89B2F9383AEEEF45322E44F4119962A9D4FF9</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 93AB2AF96F1A51915CD4B1F89EED07819E10DDDE3F936D67F2D0E559120DDD56F674775964F5F13243BCF3923BC790E25711DA6EAD8A1BEFC56161532A5EE70D64C00E37D7E5785772A3B7E1AC93EE2D556D48179627B63A2E0C3EF3FEF70DF5FE4351883628E67C6147F276B532A1F3A198FAD209A7472E244EFCB6FBC0CB42C836FA5C12C4499355A3099202AC4FCBAE417B99BF00C6FF3A51FEE64C571A37555F2AAEE90A09C16D77A9E68D728D596CEB84F52C8861AE54EB623B1E91103E0E92495F2C0422E21039E3AFCCB7FDD6425620E51A67206EC9249679019E90579E1DEEDC791AA6FB6FD07D8E6043C34A0DDF7C31192355A97B4119103F2C8B7FDB8BE7AE1277C183DA28C48DCE3E55E6772A7B20585D3D6BDDC81B03A8D5E070CBB568C958A56626CD21A03947CCDDCF1FBCD522C6A60DBB9DD3AE138F2DC112DED74DEE63BE214435753B58100E534E</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 FE 05 00 E1 C8 AB 65
0010 | 78 01 00 00 1F 5F 04 F5 FB 6C 67 30 A2 09 CF B4
0020 | D9 9B 31 0D 48 CA 7F EC 48 08 2D 3E 05 DF D9 54
0030 | B9 8C E6 56 43 8A 88 00 FE 50 01 00 93 AB 2A F9
0040 | 6F 1A 51 91 5C D4 B1 F8 9E ED 07 81 9E 10 DD DE
0050 | 3F 93 6D 67 F2 D0 E5 59 12 0D DD 56 F6 74 77 59
0060 | 64 F5 F1 32 43 BC F3 92 3B C7 90 E2 57 11 DA 6E
0070 | AD 8A 1B EF C5 61 61 53 2A 5E E7 0D 64 C0 0E 37
0080 | D7 E5 78 57 72 A3 B7 E1 AC 93 EE 2D 55 6D 48 17
0090 | 96 27 B6 3A 2E 0C 3E F3 FE F7 0D F5 FE 43 51 88
00A0 | 36 28 E6 7C 61 47 F2 76 B5 32 A1 F3 A1 98 FA D2
00B0 | 09 A7 47 2E 24 4E FC B6 FB C0 CB 42 C8 36 FA 5C
00C0 | 12 C4 49 93 55 A3 09 92 02 AC 4F CB AE 41 7B 99
00D0 | BF 00 C6 FF 3A 51 FE E6 4C 57 1A 37 55 5F 2A AE
00E0 | E9 0A 09 C1 6D 77 A9 E6 8D 72 8D 59 6C EB 84 F5
00F0 | 2C 88 61 AE 54 EB 62 3B 1E 91 10 3E 0E 92 49 5F
0100 | 2C 04 22 E2 10 39 E3 AF CC B7 FD D6 42 56 20 E5
0110 | 1A 67 20 6E C9 24 96 79 01 9E 90 57 9E 1D EE DC
0120 | 79 1A A6 FB 6F D0 7D 8E 60 43 C3 4A 0D DF 7C 31
0130 | 19 23 55 A9 7B 41 19 10 3F 2C 8B 7F DB 8B E7 AE
0140 | 12 77 C1 83 DA 28 C4 8D CE 3E 55 E6 77 2A 7B 20
0150 | 58 5D 3D 6B DD C8 1B 03 A8 D5 E0 70 CB B5 68 C9
0160 | 58 A5 66 26 CD 21 A0 39 47 CC DD CF 1F BC D5 22
0170 | C6 A6 0D BB 9D D3 AE 13 8F 2D C1 12 DE D7 4D EE
0180 | 63 BE 21 44 35 75 3B 58 10 0E 53 4E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B0FE0500E1C8AB65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010093AB2AF96F1A51915CD4B1F8</code> <code>9EED07819E10DDDE3F936D67F2D0E559</code> <code>120DDD56F674775964F5F13243BCF392</code> <code>3BC790E25711DA6EAD8A1BEFC5616153</code> <code>2A5EE70D64C00E37D7E5785772A3B7E1</code> <code>AC93EE2D556D48179627B63A2E0C3EF3</code> <code>FEF70DF5FE4351883628E67C6147F276</code> <code>B532A1F3A198FAD209A7472E244EFCB6</code> <code>FBC0CB42C836FA5C12C4499355A30992</code> <code>02AC4FCBAE417B99BF00C6FF3A51FEE6</code> <code>4C571A37555F2AAEE90A09C16D77A9E6</code> <code>8D728D596CEB84F52C8861AE54EB623B</code> <code>1E91103E0E92495F2C0422E21039E3AF</code> <code>CCB7FDD6425620E51A67206EC9249679</code> <code>019E90579E1DEEDC791AA6FB6FD07D8E</code> <code>6043C34A0DDF7C31192355A97B411910</code> <code>3F2C8B7FDB8BE7AE1277C183DA28C48D</code> <code>CE3E55E6772A7B20585D3D6BDDC81B03</code> <code>A8D5E070CBB568C958A56626CD21A039</code> <code>47CCDDCF1FBCD522C6A60DBB9DD3AE13</code> <code>8F2DC112DED74DEE63BE214435753B58</code><br> <code>100E534E</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 72CC5EB1A5E336C6ECA831CF9B76A2FA522B83C9AD9BA596CAF69848F17A50A70222D281CACBAB6B489E41A9837B54D081892A4A0018E865D6AEC0255B4C75B2119966D6D390099DE3098FFA7B65A0745A069E1DC5128DEFBD592AF2D36576229C9921809F38BBAC62DF4A43FD0F1C5944CB63ECC87D704DEC1F5E04204D7D02A7C3A2087836FB830B19F5A4CFFCAA5405F702C3D0189136085180DD87253FBA4292E83BA79A70EFA97A05963384A69F7A578D60B04102B38DD80F9AE56D7239072341AAEA0B54858E3C630A8B6FDA4F427B2CDEADD5F275F77AAE62E5029285470B77A882D08C58F3D54FE3C97996F391BC1EDAB6EED8424360A3592DDFA78C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 29 17 E2 C8 AB 65
0010 | B0 00 00 00 34 F7 CB 3B FB 6C 67 30 A2 09 CF B4
0020 | D9 9B 31 0D 48 CA 7F EC 48 08 2D 3E 05 DF D9 54
0030 | B9 8C E6 56 43 8A 88 00 9B 1A 8F 9A 8D 23 BD C1
0040 | FE 2E 7C 9F 01 DA 7C 8B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01942917E2C8AB65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0000000</code> (176 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FB6C6730A209CFB4D99B310D48CA7FEC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48082D3E05DFD954B98CE656438A8800</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>9B1A8F9A8D23BDC1FE2E7C9F01DA7C8B</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

