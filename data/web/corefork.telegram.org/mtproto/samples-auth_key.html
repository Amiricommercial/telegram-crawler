<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E0 01 0D 00 CB 4D A8 65
0010 | 14 00 00 00 F1 8E 7E BE 6B B1 FE 9B 0F 76 0B 1C
0020 | FC 66 5F 43 C8 6D 50 50</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E0010D00CB4DA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 3C 09 F5 CB 4D A8 65
0010 | C0 00 00 00 63 24 16 05 6B B1 FE 9B 0F 76 0B 1C
0020 | FC 66 5F 43 C8 6D 50 50 3F 68 23 00 18 95 A0 A7
0030 | 2C DA EC C5 35 F8 68 87 08 1C FA D1 19 D4 3A D5
0040 | 33 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013C09F5CB4DA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C0000000</code> (192 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081CFAD119D43AD533000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2088211286104659251</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2088211286104659251</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2088211286104659251 = 1324480639 * 1576626509</code></p>
<pre><code>p = 1324480639
q = 1576626509</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1C FA D1 19 D4 3A D5 33 00 00 00
0010 | 04 4E F1 F8 7F 00 00 00 04 5D F9 69 4D 00 00 00
0020 | 6B B1 FE 9B 0F 76 0B 1C FC 66 5F 43 C8 6D 50 50
0030 | 3F 68 23 00 18 95 A0 A7 2C DA EC C5 35 F8 68 87
0040 | 95 4A C7 CE D4 C7 DD 7D C6 E7 01 C3 F7 CE E2 37
0050 | FA 4C 39 B9 AB C6 38 FD AD D9 0F B4 2F A0 AA 94
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081CFAD119D43AD533000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2088211286104659251</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044EF1F87F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1324480639</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045DF9694D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1576626509</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>954AC7CED4C7DD7DC6E701C3F7CEE237</code> <code>FA4C39B9ABC638FDADD90FB42FA0AA94</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081CFAD119D43AD533000000044EF1F87F000000045DF9694D0000006BB1FE9B0F760B1CFC665F43C86D50503F6823001895A0A72CDAECC535F86887954AC7CED4C7DD7DC6E701C3F7CEE237FA4C39B9ABC638FDADD90FB42FA0AA9402000000
random_padding_bytes = 46518266C5C87137578CFB7BDB4EB3AD215548EA1FD7BAE96A593CFD906DDD87FA4297D28513B315CDCD7C701BE7BA6E9F0D10D2FA32EA3F4527D82362BF2E91E1931ADE1698846BE08DD3FE46FE71A6DF21CB8C04CC020E85985C4D</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B792E993F291A3F7A7AAD90C991B5C5B6A73C7221F1B2B7DFAD94D59FB3C437AED49F04EB5F24B970A8E20DE5F501324292D031291D1ACDCE857657F26C66E3D325BF3AEEE1B86393E0E1150D394732B8282E53D4F48C6EA26F6DF2A32185B82E67C7D43F66069ECBAACF4A5F40492473B466B864A47C20BA7B6B571A6B0F900CBC148CB18A15E21B1CBCD5560E0DA2334BFB137841A5C6513CE2FE91A061F7061790FE4BF156797D59D4687392903E626E9C80B462E2DA67812D91BBF64B1D901A7D0ADB5388A91562475A2C9812A7AB249E72036E809ABF72F341485E72F4A03ABB28E930769D2D549192A89EB81D4D89DECA527D27E91B3AF7947AF205238</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 4B 0A 00 CC 4D A8 65
0010 | 40 01 00 00 BE E4 12 D7 6B B1 FE 9B 0F 76 0B 1C
0020 | FC 66 5F 43 C8 6D 50 50 3F 68 23 00 18 95 A0 A7
0030 | 2C DA EC C5 35 F8 68 87 04 4E F1 F8 7F 00 00 00
0040 | 04 5D F9 69 4D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B7 92 E9 93 F2 91 A3 F7 A7 AA D9 0C
0060 | 99 1B 5C 5B 6A 73 C7 22 1F 1B 2B 7D FA D9 4D 59
0070 | FB 3C 43 7A ED 49 F0 4E B5 F2 4B 97 0A 8E 20 DE
0080 | 5F 50 13 24 29 2D 03 12 91 D1 AC DC E8 57 65 7F
0090 | 26 C6 6E 3D 32 5B F3 AE EE 1B 86 39 3E 0E 11 50
00A0 | D3 94 73 2B 82 82 E5 3D 4F 48 C6 EA 26 F6 DF 2A
00B0 | 32 18 5B 82 E6 7C 7D 43 F6 60 69 EC BA AC F4 A5
00C0 | F4 04 92 47 3B 46 6B 86 4A 47 C2 0B A7 B6 B5 71
00D0 | A6 B0 F9 00 CB C1 48 CB 18 A1 5E 21 B1 CB CD 55
00E0 | 60 E0 DA 23 34 BF B1 37 84 1A 5C 65 13 CE 2F E9
00F0 | 1A 06 1F 70 61 79 0F E4 BF 15 67 97 D5 9D 46 87
0100 | 39 29 03 E6 26 E9 C8 0B 46 2E 2D A6 78 12 D9 1B
0110 | BF 64 B1 D9 01 A7 D0 AD B5 38 8A 91 56 24 75 A2
0120 | C9 81 2A 7A B2 49 E7 20 36 E8 09 AB F7 2F 34 14
0130 | 85 E7 2F 4A 03 AB B2 8E 93 07 69 D2 D5 49 19 2A
0140 | 89 EB 81 D4 D8 9D EC A5 27 D2 7E 91 B3 AF 79 47
0150 | AF 20 52 38</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>784B0A00CC4DA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044EF1F87F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1324480639</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045DF9694D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1576626509</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B792E993F291A3F7A7AAD90C</code> <code>991B5C5B6A73C7221F1B2B7DFAD94D59</code> <code>FB3C437AED49F04EB5F24B970A8E20DE</code> <code>5F501324292D031291D1ACDCE857657F</code> <code>26C66E3D325BF3AEEE1B86393E0E1150</code> <code>D394732B8282E53D4F48C6EA26F6DF2A</code> <code>32185B82E67C7D43F66069ECBAACF4A5</code> <code>F40492473B466B864A47C20BA7B6B571</code> <code>A6B0F900CBC148CB18A15E21B1CBCD55</code> <code>60E0DA2334BFB137841A5C6513CE2FE9</code> <code>1A061F7061790FE4BF156797D59D4687</code> <code>392903E626E9C80B462E2DA67812D91B</code> <code>BF64B1D901A7D0ADB5388A91562475A2</code> <code>C9812A7AB249E72036E809ABF72F3414</code> <code>85E72F4A03ABB28E930769D2D549192A</code> <code>89EB81D4D89DECA527D27E91B3AF7947</code><br> <code>AF205238</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C8 AC C1 CC 4D A8 65
0010 | BC 02 00 00 5C 07 E8 D0 6B B1 FE 9B 0F 76 0B 1C
0020 | FC 66 5F 43 C8 6D 50 50 3F 68 23 00 18 95 A0 A7
0030 | 2C DA EC C5 35 F8 68 87 FE 50 02 00 11 AB 4C 2E
0040 | 34 25 38 8E 57 E0 93 E7 D1 F1 E7 A0 60 06 7E 51
0050 | 91 80 1B 4D F4 2E 87 9F 93 AC D6 14 91 03 42 5F
0060 | 0C 04 CD 8D 36 C5 94 58 FB 7C 19 F3 D8 48 41 4C
0070 | 14 A7 DD 63 FD 7F F8 33 7F 19 3E 39 67 36 C2 5F
0080 | 9A FB A8 9C BC F5 4F 40 B1 74 83 0C 95 E9 F8 BF
0090 | FB 61 62 2F E6 CD 23 FA 3E 0B 33 89 4A E7 54 A4
00A0 | 58 2C EA EA 0A 13 71 03 B7 D4 15 88 71 9B AB 76
00B0 | 63 1C 6A 01 F9 4F 6E 76 B8 48 69 60 C9 E6 CC D7
00C0 | 5F AF 91 9F B2 60 17 0D DB 78 10 C8 10 D2 C5 6E
00D0 | D9 00 9D D9 4F 7A A6 60 61 8F D0 26 98 FB 2E C7
00E0 | 0A 3B 5C 44 6A EC D7 B6 63 94 BC 81 4B 89 35 CF
00F0 | B1 C5 56 1A D3 B2 0F 55 7B B9 EA 26 CA 48 B1 51
0100 | F5 53 66 D9 1A BA D8 64 0C 92 15 B9 81 2E F3 43
0110 | F4 B1 21 B7 F0 87 7C 36 23 E5 49 B9 F6 4C A6 C9
0120 | 05 70 A8 E7 C9 3F FA 42 CC AE A6 0A 4B 4E A9 31
0130 | 41 EA D6 3F 49 E8 37 EB D1 82 DE 49 0B A2 E1 9B
0140 | 84 1A 84 48 B9 6B 9B D9 AA 8A EB 52 A0 19 FB 57
0150 | 96 E6 DC 73 72 82 6F 7A FB FD 02 CF 30 9B 45 4B
0160 | 93 95 82 07 F0 09 AC 62 17 01 C2 4A 30 09 16 E2
0170 | 28 59 B4 89 0B EB 85 95 16 20 2F 87 86 4B 22 82
0180 | B9 0F D3 B8 A2 8F F0 33 B8 07 ED 0B C1 31 F6 F3
0190 | 68 8E BB 5E AF B5 24 25 87 04 DE B9 90 CC 09 CF
01A0 | DE A1 6A 7A 77 F9 EC 9B 90 C8 0A D2 A1 F3 33 55
01B0 | 31 95 AD E9 BE FC 50 AE 2C 46 19 CA 37 DF B8 C4
01C0 | 73 85 3E 22 AB 72 15 C0 EC 7A 87 22 8B 58 03 EF
01D0 | 9E 40 8F C8 52 92 EC 97 05 0A A5 69 21 E7 6C 55
01E0 | 7C 6A 72 37 C8 15 93 C3 77 86 76 38 45 BA D4 24
01F0 | D3 6E 1C 4B 61 9A 97 94 AD BE 6C 00 8C 33 3D 5E
0200 | 7B E9 C0 05 28 DE 79 00 78 19 8D 5F 89 31 69 7F
0210 | 40 09 08 16 A1 A1 4B CA C4 28 A5 41 91 B6 FB 0C
0220 | 58 99 19 BB 83 03 F6 B1 9A CA EC 61 A6 92 D6 49
0230 | 24 5F 6F CF F3 7E 02 FA 0F EA 2E 9F FB 19 44 16
0240 | 67 DC 26 1C D9 41 FE BC B3 7E FB 85 3B 19 56 ED
0250 | F4 EB EE EE 11 21 DF 7D 2E C4 37 7C 39 C9 08 01
0260 | 1D 59 69 9C DA 9A D9 E0 5A 93 66 45 30 41 90 43
0270 | 4B DB DF 7A 4D 12 EE E1 BB 9B 4C CD D3 26 D1 D7
0280 | CA DD D6 C5 3D F5 5C 96 FD F3 96 D6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C8ACC1CC4DA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC020000</code> (700 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020011AB4C2E3425388E57E093E7</code> <code>D1F1E7A060067E5191801B4DF42E879F</code> <code>93ACD6149103425F0C04CD8D36C59458</code> <code>FB7C19F3D848414C14A7DD63FD7FF833</code> <code>7F193E396736C25F9AFBA89CBCF54F40</code> <code>B174830C95E9F8BFFB61622FE6CD23FA</code> <code>3E0B33894AE754A4582CEAEA0A137103</code> <code>B7D41588719BAB76631C6A01F94F6E76</code> <code>B8486960C9E6CCD75FAF919FB260170D</code> <code>DB7810C810D2C56ED9009DD94F7AA660</code> <code>618FD02698FB2EC70A3B5C446AECD7B6</code> <code>6394BC814B8935CFB1C5561AD3B20F55</code> <code>7BB9EA26CA48B151F55366D91ABAD864</code> <code>0C9215B9812EF343F4B121B7F0877C36</code> <code>23E549B9F64CA6C90570A8E7C93FFA42</code> <code>CCAEA60A4B4EA93141EAD63F49E837EB</code> <code>D182DE490BA2E19B841A8448B96B9BD9</code> <code>AA8AEB52A019FB5796E6DC7372826F7A</code> <code>FBFD02CF309B454B93958207F009AC62</code> <code>1701C24A300916E22859B4890BEB8595</code> <code>16202F87864B2282B90FD3B8A28FF033</code> <code>B807ED0BC131F6F3688EBB5EAFB52425</code> <code>8704DEB990CC09CFDEA16A7A77F9EC9B</code> <code>90C80AD2A1F333553195ADE9BEFC50AE</code> <code>2C4619CA37DFB8C473853E22AB7215C0</code> <code>EC7A87228B5803EF9E408FC85292EC97</code> <code>050AA56921E76C557C6A7237C81593C3</code> <code>7786763845BAD424D36E1C4B619A9794</code> <code>ADBE6C008C333D5E7BE9C00528DE7900</code> <code>78198D5F8931697F40090816A1A14BCA</code> <code>C428A54191B6FB0C589919BB8303F6B1</code> <code>9ACAEC61A692D649245F6FCFF37E02FA</code> <code>0FEA2E9FFB19441667DC261CD941FEBC</code> <code>B37EFB853B1956EDF4EBEEEE1121DF7D</code> <code>2EC4377C39C908011D59699CDA9AD9E0</code> <code>5A936645304190434BDBDF7A4D12EEE1</code> <code>BB9B4CCDD326D1D7CADDD6C53DF55C96</code><br> <code>FDF396D6</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 11AB4C2E3425388E57E093E7D1F1E7A060067E5191801B4DF42E879F93ACD6149103425F0C04CD8D36C59458FB7C19F3D848414C14A7DD63FD7FF8337F193E396736C25F9AFBA89CBCF54F40B174830C95E9F8BFFB61622FE6CD23FA3E0B33894AE754A4582CEAEA0A137103B7D41588719BAB76631C6A01F94F6E76B8486960C9E6CCD75FAF919FB260170DDB7810C810D2C56ED9009DD94F7AA660618FD02698FB2EC70A3B5C446AECD7B66394BC814B8935CFB1C5561AD3B20F557BB9EA26CA48B151F55366D91ABAD8640C9215B9812EF343F4B121B7F0877C3623E549B9F64CA6C90570A8E7C93FFA42CCAEA60A4B4EA93141EAD63F49E837EBD182DE490BA2E19B841A8448B96B9BD9AA8AEB52A019FB5796E6DC7372826F7AFBFD02CF309B454B93958207F009AC621701C24A300916E22859B4890BEB859516202F87864B2282B90FD3B8A28FF033B807ED0BC131F6F3688EBB5EAFB524258704DEB990CC09CFDEA16A7A77F9EC9B90C80AD2A1F333553195ADE9BEFC50AE2C4619CA37DFB8C473853E22AB7215C0EC7A87228B5803EF9E408FC85292EC97050AA56921E76C557C6A7237C81593C37786763845BAD424D36E1C4B619A9794ADBE6C008C333D5E7BE9C00528DE790078198D5F8931697F40090816A1A14BCAC428A54191B6FB0C589919BB8303F6B19ACAEC61A692D649245F6FCFF37E02FA0FEA2E9FFB19441667DC261CD941FEBCB37EFB853B1956EDF4EBEEEE1121DF7D2EC4377C39C908011D59699CDA9AD9E05A936645304190434BDBDF7A4D12EEE1BB9B4CCDD326D1D7CADDD6C53DF55C96FDF396D6
tmp_aes_key = BE4001B21615E36F7A01A312A0DF34EAFD3A96A944D0658BE47A22BAD5CF132F
tmp_aes_iv = 1927FBBDBA9D74C05078630ED2DE8E0887B3E9BE569682F826B695A5954AC7CE</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = F22FC59E4A387E4BC1587F968C8765463D5228F5BA0D89B56BB1FE9B0F760B1CFC665F43C86D50503F6823001895A0A72CDAECC535F8688703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010099D405C9EFA7D5B8633D132C83521D268FF94ECCB136D91527D6C382D7AF179ABB025D6BB0DE01CFC248CDD0302833EA708F3D2A7FF0EDD48611845DE627F95219ED77E10D9DCA75890786BC02C1E46146043185A791284971C5A000D7A66EA1DEBFC8A2920EB592B088EC6AD5A343328B78C3E55542D5C63E3E298149FCEF47566C5D004844A00A4F33B012DEC5800F26C8695F9AC354B42B6F32150C8AF838D03E6F48F0509B2DD207BB2BAC22CD0F6173AA28B1A7F477AF0EE58B65F338C026E15AF0BCA45713ECCB67BEA55A049E33702FC64EA4DDB99386F17D61EC2739FB7656983C9E591330A3E87BF6406EA9064C5591B06C0A58DB3F8668AAE97B0FCC4DA865B594123086983505
answer = BA0D89B56BB1FE9B0F760B1CFC665F43C86D50503F6823001895A0A72CDAECC535F8688703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010099D405C9EFA7D5B8633D132C83521D268FF94ECCB136D91527D6C382D7AF179ABB025D6BB0DE01CFC248CDD0302833EA708F3D2A7FF0EDD48611845DE627F95219ED77E10D9DCA75890786BC02C1E46146043185A791284971C5A000D7A66EA1DEBFC8A2920EB592B088EC6AD5A343328B78C3E55542D5C63E3E298149FCEF47566C5D004844A00A4F33B012DEC5800F26C8695F9AC354B42B6F32150C8AF838D03E6F48F0509B2DD207BB2BAC22CD0F6173AA28B1A7F477AF0EE58B65F338C026E15AF0BCA45713ECCB67BEA55A049E33702FC64EA4DDB99386F17D61EC2739FB7656983C9E591330A3E87BF6406EA9064C5591B06C0A58DB3F8668AAE97B0FCC4DA865B594123086983505</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 6B B1 FE 9B 0F 76 0B 1C FC 66 5F 43
0010 | C8 6D 50 50 3F 68 23 00 18 95 A0 A7 2C DA EC C5
0020 | 35 F8 68 87 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 99 D4 05 C9 EF A7 D5 B8 63 3D 13 2C 83 52 1D 26
0140 | 8F F9 4E CC B1 36 D9 15 27 D6 C3 82 D7 AF 17 9A
0150 | BB 02 5D 6B B0 DE 01 CF C2 48 CD D0 30 28 33 EA
0160 | 70 8F 3D 2A 7F F0 ED D4 86 11 84 5D E6 27 F9 52
0170 | 19 ED 77 E1 0D 9D CA 75 89 07 86 BC 02 C1 E4 61
0180 | 46 04 31 85 A7 91 28 49 71 C5 A0 00 D7 A6 6E A1
0190 | DE BF C8 A2 92 0E B5 92 B0 88 EC 6A D5 A3 43 32
01A0 | 8B 78 C3 E5 55 42 D5 C6 3E 3E 29 81 49 FC EF 47
01B0 | 56 6C 5D 00 48 44 A0 0A 4F 33 B0 12 DE C5 80 0F
01C0 | 26 C8 69 5F 9A C3 54 B4 2B 6F 32 15 0C 8A F8 38
01D0 | D0 3E 6F 48 F0 50 9B 2D D2 07 BB 2B AC 22 CD 0F
01E0 | 61 73 AA 28 B1 A7 F4 77 AF 0E E5 8B 65 F3 38 C0
01F0 | 26 E1 5A F0 BC A4 57 13 EC CB 67 BE A5 5A 04 9E
0200 | 33 70 2F C6 4E A4 DD B9 93 86 F1 7D 61 EC 27 39
0210 | FB 76 56 98 3C 9E 59 13 30 A3 E8 7B F6 40 6E A9
0220 | 06 4C 55 91 B0 6C 0A 58 DB 3F 86 68 AA E9 7B 0F
0230 | CC 4D A8 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010099D405C9EFA7D5B8633D132C</code> <code>83521D268FF94ECCB136D91527D6C382</code> <code>D7AF179ABB025D6BB0DE01CFC248CDD0</code> <code>302833EA708F3D2A7FF0EDD48611845D</code> <code>E627F95219ED77E10D9DCA75890786BC</code> <code>02C1E46146043185A791284971C5A000</code> <code>D7A66EA1DEBFC8A2920EB592B088EC6A</code> <code>D5A343328B78C3E55542D5C63E3E2981</code> <code>49FCEF47566C5D004844A00A4F33B012</code> <code>DEC5800F26C8695F9AC354B42B6F3215</code> <code>0C8AF838D03E6F48F0509B2DD207BB2B</code> <code>AC22CD0F6173AA28B1A7F477AF0EE58B</code> <code>65F338C026E15AF0BCA45713ECCB67BE</code> <code>A55A049E33702FC64EA4DDB99386F17D</code> <code>61EC2739FB7656983C9E591330A3E87B</code> <code>F6406EA9064C5591B06C0A58DB3F8668</code><br> <code>AAE97B0F</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>CC4DA865</code> (1705528780 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A657F94962633DCF14DCFAAE27DC1DEF797B48A8756BC90CB72744E40DAB334DB4DDFC8A1761EA6E9E64142C165A817C5D0B5CD85624AE8E88CCC615C89F5F8FC187EA7D880F1E28AD1F0F3A12002D92A1C33460AB98BD3B7148F3BE5822A33B10CD08F1780A6F9C8F59EEF8963367D37F55BDBAA15EBDCCA6D70388D44FDD75DE87872A7E406DACCB584E7562C472FCD539C223E10233C2F206FAD7AEF47E2B0EEDC3C27F79FD1376AEF1082F1B56248D38E327B7DFF652E47393EC5A78CF2DCAD997DCCBE54BDA66FC83C0B89CA0B9CCB8C5DF88883F6337BC14DBD39BF1BC8B57DF38FA4F1E556BBDECE67607015E2B7082486C258B1527318F128CD4304D</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 9D9B23CCB0D2C4575C335B223C946C00E2A0E793FB5521BA72BA41CAB71E6B6200BCF1DDF75D60B0EBC342C12F6A7E541900F4BD789FAC7CFECBDDFB42381D00D9641053C63C520D30D39A280A201A9E83761886662215089B95DFF2F75B9FD49365CE455E16D429EAF5EF9BDA49A164B95E36D9FCD659DD9BCA22889349CB8BEB2A4EFAFE1A9DB0CCBEA54FC55FC442B7826A18C950AFEB0B8C6B8145AB8E3519FAB030BB734AB46C7D7C3646788D03B6BAC4E69BC216BB19A4946A04C20924CF881548178D77D631382C7ECFD8B61A64566D58DFCEDD81EAC1A4ECE1727B557CDF6CAE0A0BD1C0D833D7E46C65434A958139C628622670180769E17B26977D</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 6B B1 FE 9B 0F 76 0B 1C FC 66 5F 43
0010 | C8 6D 50 50 3F 68 23 00 18 95 A0 A7 2C DA EC C5
0020 | 35 F8 68 87 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 9D 9B 23 CC B0 D2 C4 57 5C 33 5B 22 3C 94 6C 00
0040 | E2 A0 E7 93 FB 55 21 BA 72 BA 41 CA B7 1E 6B 62
0050 | 00 BC F1 DD F7 5D 60 B0 EB C3 42 C1 2F 6A 7E 54
0060 | 19 00 F4 BD 78 9F AC 7C FE CB DD FB 42 38 1D 00
0070 | D9 64 10 53 C6 3C 52 0D 30 D3 9A 28 0A 20 1A 9E
0080 | 83 76 18 86 66 22 15 08 9B 95 DF F2 F7 5B 9F D4
0090 | 93 65 CE 45 5E 16 D4 29 EA F5 EF 9B DA 49 A1 64
00A0 | B9 5E 36 D9 FC D6 59 DD 9B CA 22 88 93 49 CB 8B
00B0 | EB 2A 4E FA FE 1A 9D B0 CC BE A5 4F C5 5F C4 42
00C0 | B7 82 6A 18 C9 50 AF EB 0B 8C 6B 81 45 AB 8E 35
00D0 | 19 FA B0 30 BB 73 4A B4 6C 7D 7C 36 46 78 8D 03
00E0 | B6 BA C4 E6 9B C2 16 BB 19 A4 94 6A 04 C2 09 24
00F0 | CF 88 15 48 17 8D 77 D6 31 38 2C 7E CF D8 B6 1A
0100 | 64 56 6D 58 DF CE DD 81 EA C1 A4 EC E1 72 7B 55
0110 | 7C DF 6C AE 0A 0B D1 C0 D8 33 D7 E4 6C 65 43 4A
0120 | 95 81 39 C6 28 62 26 70 18 07 69 E1 7B 26 97 7D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001009D9B23CCB0D2C4575C335B22</code> <code>3C946C00E2A0E793FB5521BA72BA41CA</code> <code>B71E6B6200BCF1DDF75D60B0EBC342C1</code> <code>2F6A7E541900F4BD789FAC7CFECBDDFB</code> <code>42381D00D9641053C63C520D30D39A28</code> <code>0A201A9E83761886662215089B95DFF2</code> <code>F75B9FD49365CE455E16D429EAF5EF9B</code> <code>DA49A164B95E36D9FCD659DD9BCA2288</code> <code>9349CB8BEB2A4EFAFE1A9DB0CCBEA54F</code> <code>C55FC442B7826A18C950AFEB0B8C6B81</code> <code>45AB8E3519FAB030BB734AB46C7D7C36</code> <code>46788D03B6BAC4E69BC216BB19A4946A</code> <code>04C20924CF881548178D77D631382C7E</code> <code>CFD8B61A64566D58DFCEDD81EAC1A4EC</code> <code>E1727B557CDF6CAE0A0BD1C0D833D7E4</code> <code>6C65434A958139C628622670180769E1</code><br> <code>7B26977D</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643666BB1FE9B0F760B1CFC665F43C86D50503F6823001895A0A72CDAECC535F868870000000000000000FE0001009D9B23CCB0D2C4575C335B223C946C00E2A0E793FB5521BA72BA41CAB71E6B6200BCF1DDF75D60B0EBC342C12F6A7E541900F4BD789FAC7CFECBDDFB42381D00D9641053C63C520D30D39A280A201A9E83761886662215089B95DFF2F75B9FD49365CE455E16D429EAF5EF9BDA49A164B95E36D9FCD659DD9BCA22889349CB8BEB2A4EFAFE1A9DB0CCBEA54FC55FC442B7826A18C950AFEB0B8C6B8145AB8E3519FAB030BB734AB46C7D7C3646788D03B6BAC4E69BC216BB19A4946A04C20924CF881548178D77D631382C7ECFD8B61A64566D58DFCEDD81EAC1A4ECE1727B557CDF6CAE0A0BD1C0D833D7E46C65434A958139C628622670180769E17B26977D
padding = FF4625906B7223077FCD71BA
tmp_aes_key = BE4001B21615E36F7A01A312A0DF34EAFD3A96A944D0658BE47A22BAD5CF132F
tmp_aes_iv = 1927FBBDBA9D74C05078630ED2DE8E0887B3E9BE569682F826B695A5954AC7CE</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 9C7CDC04947F47C96B88754AB5C79B9046A32E54964AC2DA437951000345304DC7120174249A3AAF722059421DF39759E78B8FDE3933FED62BC7B6140A4855DA6BBCC77303F6199058381391042C3FF32C70365418BCA6F6FF2F797D53444E0CA24E90CD6B2CDE9E1336D9BF86D960D1CBE4EF5AA8AA322F9D5B6E22B13EB01D10485360BFA841B882F75D73BB4A06BF9C391DD0F93C01F5A0EA8FB715B8B8C641D7A02A509FFD023DB4D81419DCA78890E133E135D39091B74373ECC0C28631F383A17A3C795108423AD35F2DF70FA25CCFE5B653F6038599F006C11CDCE1C93A1FA22FA74B5DF056B36930C7FCA94DB08672D5610B0781D7F32F80DD77D08203E0A28E288745F4029BDC84E4A62743465F8612A29963B696666785C342D6C7F9FBECB8FA41F87A59754D2BAFDD77C61296A53E0FBC8B929F899F043B1C987AE5B0BD216F8625C32FF3F4ACF9B66E90</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C 59 0C 00 CC 4D A8 65
0010 | 78 01 00 00 1F 5F 04 F5 6B B1 FE 9B 0F 76 0B 1C
0020 | FC 66 5F 43 C8 6D 50 50 3F 68 23 00 18 95 A0 A7
0030 | 2C DA EC C5 35 F8 68 87 FE 50 01 00 9C 7C DC 04
0040 | 94 7F 47 C9 6B 88 75 4A B5 C7 9B 90 46 A3 2E 54
0050 | 96 4A C2 DA 43 79 51 00 03 45 30 4D C7 12 01 74
0060 | 24 9A 3A AF 72 20 59 42 1D F3 97 59 E7 8B 8F DE
0070 | 39 33 FE D6 2B C7 B6 14 0A 48 55 DA 6B BC C7 73
0080 | 03 F6 19 90 58 38 13 91 04 2C 3F F3 2C 70 36 54
0090 | 18 BC A6 F6 FF 2F 79 7D 53 44 4E 0C A2 4E 90 CD
00A0 | 6B 2C DE 9E 13 36 D9 BF 86 D9 60 D1 CB E4 EF 5A
00B0 | A8 AA 32 2F 9D 5B 6E 22 B1 3E B0 1D 10 48 53 60
00C0 | BF A8 41 B8 82 F7 5D 73 BB 4A 06 BF 9C 39 1D D0
00D0 | F9 3C 01 F5 A0 EA 8F B7 15 B8 B8 C6 41 D7 A0 2A
00E0 | 50 9F FD 02 3D B4 D8 14 19 DC A7 88 90 E1 33 E1
00F0 | 35 D3 90 91 B7 43 73 EC C0 C2 86 31 F3 83 A1 7A
0100 | 3C 79 51 08 42 3A D3 5F 2D F7 0F A2 5C CF E5 B6
0110 | 53 F6 03 85 99 F0 06 C1 1C DC E1 C9 3A 1F A2 2F
0120 | A7 4B 5D F0 56 B3 69 30 C7 FC A9 4D B0 86 72 D5
0130 | 61 0B 07 81 D7 F3 2F 80 DD 77 D0 82 03 E0 A2 8E
0140 | 28 87 45 F4 02 9B DC 84 E4 A6 27 43 46 5F 86 12
0150 | A2 99 63 B6 96 66 67 85 C3 42 D6 C7 F9 FB EC B8
0160 | FA 41 F8 7A 59 75 4D 2B AF DD 77 C6 12 96 A5 3E
0170 | 0F BC 8B 92 9F 89 9F 04 3B 1C 98 7A E5 B0 BD 21
0180 | 6F 86 25 C3 2F F3 F4 AC F9 B6 6E 90</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6C590C00CC4DA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001009C7CDC04947F47C96B88754A</code> <code>B5C79B9046A32E54964AC2DA43795100</code> <code>0345304DC7120174249A3AAF72205942</code> <code>1DF39759E78B8FDE3933FED62BC7B614</code> <code>0A4855DA6BBCC77303F6199058381391</code> <code>042C3FF32C70365418BCA6F6FF2F797D</code> <code>53444E0CA24E90CD6B2CDE9E1336D9BF</code> <code>86D960D1CBE4EF5AA8AA322F9D5B6E22</code> <code>B13EB01D10485360BFA841B882F75D73</code> <code>BB4A06BF9C391DD0F93C01F5A0EA8FB7</code> <code>15B8B8C641D7A02A509FFD023DB4D814</code> <code>19DCA78890E133E135D39091B74373EC</code> <code>C0C28631F383A17A3C795108423AD35F</code> <code>2DF70FA25CCFE5B653F6038599F006C1</code> <code>1CDCE1C93A1FA22FA74B5DF056B36930</code> <code>C7FCA94DB08672D5610B0781D7F32F80</code> <code>DD77D08203E0A28E288745F4029BDC84</code> <code>E4A62743465F8612A29963B696666785</code> <code>C342D6C7F9FBECB8FA41F87A59754D2B</code> <code>AFDD77C61296A53E0FBC8B929F899F04</code> <code>3B1C987AE5B0BD216F8625C32FF3F4AC</code><br> <code>F9B66E90</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 032BB5C7B7D1D14A9E88583B2DF883ECD4D5F982C70235F079695DC77C7AFF22254842AB4E38326112C7D9147D25BA89D2F7DD31B7634C038074DF06570027D73074B3478F11C967DB4EBEDAA6516E6C836CF29EF0FF3DA7D5A92DC618AB97E95A741313A14883BE52ACD121F1807C833A7A27B2FEF78F366A4004AFB7FBFEB65939AF25A5378D745D9B28AFF7EF9087BF16B72B9EB7BA6AFCD5E06FE5D0DDFD2F057DF1F0FAC43D16EDA279D556129D24081F4C7B4D5A398E442743768121767ABEFDCC9CDC882DD12AE029C416B88A7208938FA04A8BF40BF3E450F73754C8AABBBD875B9B3EAFE3AD44490136CD4D8AFE6843EF7D63F4CB9F6DF5CBFA8E80</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 44 62 49 CD 4D A8 65
0010 | 50 00 00 00 34 F7 CB 3B 6B B1 FE 9B 0F 76 0B 1C
0020 | FC 66 5F 43 C8 6D 50 50 3F 68 23 00 18 95 A0 A7
0030 | 2C DA EC C5 35 F8 68 87 4A 95 31 14 20 65 4E B8
0040 | 7D E6 58 B6 78 29 CE 90</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01446249CD4DA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6BB1FE9B0F760B1CFC665F43C86D5050</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3F6823001895A0A72CDAECC535F86887</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4A95311420654EB87DE658B67829CE90</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

