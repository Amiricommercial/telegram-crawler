<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D0 05 0D 00 5B 8F 52 65
0010 | 14 00 00 00 F1 8E 7E BE 65 6E 13 93 58 19 E7 6E
0020 | EC 8A 35 66 9A 28 E6 54</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D0050D005B8F5265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 7C A8 5B 8F 52 65
0010 | 64 00 00 00 63 24 16 05 65 6E 13 93 58 19 E7 6E
0020 | EC 8A 35 66 9A 28 E6 54 56 D3 89 64 15 00 3D F7
0030 | AC 4F 3A 54 16 E5 C3 67 08 16 88 14 FD D6 F0 77
0040 | 71 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01607CA85B8F5265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>64000000</code> (100 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08168814FDD6F07771000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1623570746132428657</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1623570746132428657</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1623570746132428657 = 1269825343 * 1278577999</code></p>
<pre><code>p = 1269825343
q = 1278577999</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 88 14 FD D6 F0 77 71 00 00 00
0010 | 04 4B AF FF 3F 00 00 00 04 4C 35 8D 4F 00 00 00
0020 | 65 6E 13 93 58 19 E7 6E EC 8A 35 66 9A 28 E6 54
0030 | 56 D3 89 64 15 00 3D F7 AC 4F 3A 54 16 E5 C3 67
0040 | 66 7F E7 5D 9B 22 6F 1D 4B A4 B5 A6 52 81 DB 97
0050 | E3 D4 52 8C C0 0F 8B 8F 60 47 C1 F7 C7 88 F3 E4
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08168814FDD6F07771000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1623570746132428657</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044BAFFF3F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1269825343</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044C358D4F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1278577999</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>667FE75D9B226F1D4BA4B5A65281DB97</code> <code>E3D4528CC00F8B8F6047C1F7C788F3E4</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908168814FDD6F07771000000044BAFFF3F000000044C358D4F000000656E13935819E76EEC8A35669A28E65456D3896415003DF7AC4F3A5416E5C367667FE75D9B226F1D4BA4B5A65281DB97E3D4528CC00F8B8F6047C1F7C788F3E402000000
random_padding_bytes = D63275026745B2326813D072BB92325F3FA5212E7EBE16D1DCE659DD4A2666BF62FDE6A368FE109BD7AFBE8123B703CA45A7FD3F8B7775E231E1B30CD9DC4D78DE76FCB33AC90072E23B0654E9C10B345D7485CC208CD0B5F38E7F50</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A9B83CD944FAC581E90026025C1C3CF9A798202704D3B854AD6D6EB454FC4D76D254F2EFDF451F486F0E74E7A88CCE167B121116E945BE809246D829DAD260581674848E66A3B2879019AE6E8D6441955332B5105C142A5EE56223701142FC756E3C256B81800EE474B4F8DFE9A7FF281685674B21BB8AEBA322B9041AC5602787DDA8A26EDA02700A6C4E1EA1BC94EC4A42726096C2CA036EE24A84FD5A5CCF8026D0C1DAE7E6A504FC5DC54498AFFE2955A4E7CE195B2ED81E938A2F313C7CE27A775DF59BF5EDA337B773CD049D5910C02DF2CE386CB26CAFB79E466503CEBF77C4F854D9B592E4369B1A9ACBB03F9F3589929C514A45CCFB456A3995C6AC</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 68 02 0F 00 5B 8F 52 65
0010 | 40 01 00 00 BE E4 12 D7 65 6E 13 93 58 19 E7 6E
0020 | EC 8A 35 66 9A 28 E6 54 56 D3 89 64 15 00 3D F7
0030 | AC 4F 3A 54 16 E5 C3 67 04 4B AF FF 3F 00 00 00
0040 | 04 4C 35 8D 4F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A9 B8 3C D9 44 FA C5 81 E9 00 26 02
0060 | 5C 1C 3C F9 A7 98 20 27 04 D3 B8 54 AD 6D 6E B4
0070 | 54 FC 4D 76 D2 54 F2 EF DF 45 1F 48 6F 0E 74 E7
0080 | A8 8C CE 16 7B 12 11 16 E9 45 BE 80 92 46 D8 29
0090 | DA D2 60 58 16 74 84 8E 66 A3 B2 87 90 19 AE 6E
00A0 | 8D 64 41 95 53 32 B5 10 5C 14 2A 5E E5 62 23 70
00B0 | 11 42 FC 75 6E 3C 25 6B 81 80 0E E4 74 B4 F8 DF
00C0 | E9 A7 FF 28 16 85 67 4B 21 BB 8A EB A3 22 B9 04
00D0 | 1A C5 60 27 87 DD A8 A2 6E DA 02 70 0A 6C 4E 1E
00E0 | A1 BC 94 EC 4A 42 72 60 96 C2 CA 03 6E E2 4A 84
00F0 | FD 5A 5C CF 80 26 D0 C1 DA E7 E6 A5 04 FC 5D C5
0100 | 44 98 AF FE 29 55 A4 E7 CE 19 5B 2E D8 1E 93 8A
0110 | 2F 31 3C 7C E2 7A 77 5D F5 9B F5 ED A3 37 B7 73
0120 | CD 04 9D 59 10 C0 2D F2 CE 38 6C B2 6C AF B7 9E
0130 | 46 65 03 CE BF 77 C4 F8 54 D9 B5 92 E4 36 9B 1A
0140 | 9A CB B0 3F 9F 35 89 92 9C 51 4A 45 CC FB 45 6A
0150 | 39 95 C6 AC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>68020F005B8F5265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044BAFFF3F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1269825343</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044C358D4F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1278577999</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A9B83CD944FAC581E9002602</code> <code>5C1C3CF9A798202704D3B854AD6D6EB4</code> <code>54FC4D76D254F2EFDF451F486F0E74E7</code> <code>A88CCE167B121116E945BE809246D829</code> <code>DAD260581674848E66A3B2879019AE6E</code> <code>8D6441955332B5105C142A5EE5622370</code> <code>1142FC756E3C256B81800EE474B4F8DF</code> <code>E9A7FF281685674B21BB8AEBA322B904</code> <code>1AC5602787DDA8A26EDA02700A6C4E1E</code> <code>A1BC94EC4A42726096C2CA036EE24A84</code> <code>FD5A5CCF8026D0C1DAE7E6A504FC5DC5</code> <code>4498AFFE2955A4E7CE195B2ED81E938A</code> <code>2F313C7CE27A775DF59BF5EDA337B773</code> <code>CD049D5910C02DF2CE386CB26CAFB79E</code> <code>466503CEBF77C4F854D9B592E4369B1A</code> <code>9ACBB03F9F3589929C514A45CCFB456A</code><br> <code>3995C6AC</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 8C 46 60 5C 8F 52 65
0010 | 7C 02 00 00 5C 07 E8 D0 65 6E 13 93 58 19 E7 6E
0020 | EC 8A 35 66 9A 28 E6 54 56 D3 89 64 15 00 3D F7
0030 | AC 4F 3A 54 16 E5 C3 67 FE 50 02 00 12 C6 41 64
0040 | 40 86 EF 6D B1 38 A9 A3 E5 36 43 53 5C E5 92 8C
0050 | C1 69 93 9E 62 A3 0C 96 69 74 AE DD A0 77 3D D1
0060 | E8 1D 60 50 7B C8 25 EA E5 2D 94 EF 0B CC F0 2F
0070 | 30 C4 4D 62 88 A5 BC 10 0C 0B A1 BF 23 94 25 F8
0080 | 0F 18 F3 9D A7 B3 44 30 DA 30 95 E8 E5 4A 8E 60
0090 | E0 3D 95 DF 42 C6 53 A7 B7 39 C1 D1 21 8B 10 49
00A0 | 0D 61 09 C2 9E EF 76 5F B8 83 FD C4 B5 1E 4C 03
00B0 | BD 09 AC 7F 5F F1 B6 A7 10 18 73 43 35 89 B8 60
00C0 | 2C 67 16 02 87 3E 9F 97 AD A0 EC 34 80 76 65 F8
00D0 | C7 5E 38 2F 29 B5 A4 D0 20 37 5E 87 3B 79 E7 F5
00E0 | 05 1B 0F 2B C6 5D C4 16 21 63 3B 8D 85 76 FD 7B
00F0 | 73 67 9A 70 D6 4A 39 E9 E1 01 CA 36 36 91 6C B1
0100 | 61 E5 30 8C AE A3 1E 38 C5 71 3A 44 3D 8A 2E 53
0110 | C5 86 06 E9 29 69 E3 B3 30 A6 0B 22 86 6E E6 77
0120 | E3 5D D4 73 A1 6F 3A CF 5D 60 B9 32 98 67 53 E3
0130 | 92 5F E0 58 0F 61 17 B5 02 B6 43 E6 EA F7 E9 30
0140 | C7 F9 B8 0B C3 9D BC 5A 52 FE 7D D3 28 25 3A 7E
0150 | E6 AC 27 E1 CE F5 FB 21 59 6C 76 9A 51 E3 16 96
0160 | 2D D3 02 4A AD 2D 71 AE 11 1F 88 E8 D0 27 75 88
0170 | 02 13 B2 1A D5 88 65 46 23 EA 12 B1 03 62 6A F7
0180 | C9 D6 7A 5A F5 0C F2 3E 2C 69 5C BB 98 DB CE 9B
0190 | 35 BC DD D6 31 4F A6 96 C8 33 D6 5C 10 1D C4 22
01A0 | 0E F0 B7 A8 F7 67 79 8E 62 AF CF 65 94 93 21 52
01B0 | F4 62 5B 2E 51 AA A1 7C AD 70 EE 12 D3 CC 91 B6
01C0 | BA F6 F4 45 BF E4 1F 87 04 87 C4 F8 6F 6E E1 7D
01D0 | 30 DE DE FD BD 14 B3 C7 23 C1 11 EE 06 2A 60 8D
01E0 | BB 9A 80 3F D4 19 3C F6 B9 E7 E7 74 61 4F 58 A4
01F0 | 31 F9 08 46 9B A8 EB BD A3 DA F0 6B ED A4 7D 16
0200 | CD F4 11 23 29 54 BE 13 CD 24 08 44 7B 93 D5 2B
0210 | DA 65 6D 75 3A C9 7E 7A 7A 05 5C 91 18 6F AF AF
0220 | 57 4C 7A 11 D8 3E EF 1E ED 4D 98 61 36 A4 D5 5D
0230 | C0 85 49 CB 0C 57 91 AF 1D 28 87 F6 EB 70 33 DE
0240 | 87 17 07 98 8B CC 75 D4 D0 D6 AA 87 1F 2F 3C 67
0250 | 08 07 27 83 70 28 FD 94 17 50 ED DF A0 58 2F 10
0260 | BC F7 6A 97 4A 2F 45 55 51 D8 B3 FF 9A B2 AA 66
0270 | 61 20 6E D0 71 1B 1B 3A 7C E1 73 B3 F6 86 CB 02
0280 | B6 FA A4 FE EB 2E 50 D0 72 3D 11 F1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018C46605C8F5265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>7C020000</code> (636 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020012C641644086EF6DB138A9A3</code> <code>E53643535CE5928CC169939E62A30C96</code> <code>6974AEDDA0773DD1E81D60507BC825EA</code> <code>E52D94EF0BCCF02F30C44D6288A5BC10</code> <code>0C0BA1BF239425F80F18F39DA7B34430</code> <code>DA3095E8E54A8E60E03D95DF42C653A7</code> <code>B739C1D1218B10490D6109C29EEF765F</code> <code>B883FDC4B51E4C03BD09AC7F5FF1B6A7</code> <code>101873433589B8602C671602873E9F97</code> <code>ADA0EC34807665F8C75E382F29B5A4D0</code> <code>20375E873B79E7F5051B0F2BC65DC416</code> <code>21633B8D8576FD7B73679A70D64A39E9</code> <code>E101CA3636916CB161E5308CAEA31E38</code> <code>C5713A443D8A2E53C58606E92969E3B3</code> <code>30A60B22866EE677E35DD473A16F3ACF</code> <code>5D60B932986753E3925FE0580F6117B5</code> <code>02B643E6EAF7E930C7F9B80BC39DBC5A</code> <code>52FE7DD328253A7EE6AC27E1CEF5FB21</code> <code>596C769A51E316962DD3024AAD2D71AE</code> <code>111F88E8D02775880213B21AD5886546</code> <code>23EA12B103626AF7C9D67A5AF50CF23E</code> <code>2C695CBB98DBCE9B35BCDDD6314FA696</code> <code>C833D65C101DC4220EF0B7A8F767798E</code> <code>62AFCF6594932152F4625B2E51AAA17C</code> <code>AD70EE12D3CC91B6BAF6F445BFE41F87</code> <code>0487C4F86F6EE17D30DEDEFDBD14B3C7</code> <code>23C111EE062A608DBB9A803FD4193CF6</code> <code>B9E7E774614F58A431F908469BA8EBBD</code> <code>A3DAF06BEDA47D16CDF411232954BE13</code> <code>CD2408447B93D52BDA656D753AC97E7A</code> <code>7A055C91186FAFAF574C7A11D83EEF1E</code> <code>ED4D986136A4D55DC08549CB0C5791AF</code> <code>1D2887F6EB7033DE871707988BCC75D4</code> <code>D0D6AA871F2F3C67080727837028FD94</code> <code>1750EDDFA0582F10BCF76A974A2F4555</code> <code>51D8B3FF9AB2AA6661206ED0711B1B3A</code> <code>7CE173B3F686CB02B6FAA4FEEB2E50D0</code><br> <code>723D11F1</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 12C641644086EF6DB138A9A3E53643535CE5928CC169939E62A30C966974AEDDA0773DD1E81D60507BC825EAE52D94EF0BCCF02F30C44D6288A5BC100C0BA1BF239425F80F18F39DA7B34430DA3095E8E54A8E60E03D95DF42C653A7B739C1D1218B10490D6109C29EEF765FB883FDC4B51E4C03BD09AC7F5FF1B6A7101873433589B8602C671602873E9F97ADA0EC34807665F8C75E382F29B5A4D020375E873B79E7F5051B0F2BC65DC41621633B8D8576FD7B73679A70D64A39E9E101CA3636916CB161E5308CAEA31E38C5713A443D8A2E53C58606E92969E3B330A60B22866EE677E35DD473A16F3ACF5D60B932986753E3925FE0580F6117B502B643E6EAF7E930C7F9B80BC39DBC5A52FE7DD328253A7EE6AC27E1CEF5FB21596C769A51E316962DD3024AAD2D71AE111F88E8D02775880213B21AD588654623EA12B103626AF7C9D67A5AF50CF23E2C695CBB98DBCE9B35BCDDD6314FA696C833D65C101DC4220EF0B7A8F767798E62AFCF6594932152F4625B2E51AAA17CAD70EE12D3CC91B6BAF6F445BFE41F870487C4F86F6EE17D30DEDEFDBD14B3C723C111EE062A608DBB9A803FD4193CF6B9E7E774614F58A431F908469BA8EBBDA3DAF06BEDA47D16CDF411232954BE13CD2408447B93D52BDA656D753AC97E7A7A055C91186FAFAF574C7A11D83EEF1EED4D986136A4D55DC08549CB0C5791AF1D2887F6EB7033DE871707988BCC75D4D0D6AA871F2F3C67080727837028FD941750EDDFA0582F10BCF76A974A2F455551D8B3FF9AB2AA6661206ED0711B1B3A7CE173B3F686CB02B6FAA4FEEB2E50D0723D11F1
tmp_aes_key = 022F9B4E9EADB601A8BC7F9636B1721B7C9E3BBB72927FDC43B052899A31552D
tmp_aes_iv = 05777D67BA5E51E589DA36B406F2D216280E1341DDF4CA79320CBA1B667FE75D</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 627A90E4BC623A2607BFE4764C720B91A41E4944BA0D89B5656E13935819E76EEC8A35669A28E65456D3896415003DF7AC4F3A5416E5C36703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010046851FF32F9D73F99456F20FF27E9C37C331734FB197FE0C1EF4F3FB6B4F965D2A972F17A5A84A7DFFC5DFAC4EA8189341CD812417F42DDBB3CAC6FCF2FAC093438A6421BA4535AD3F926D8C3B84413D6B4C9A00A9CBF549A7AE67F6EE34F036125696A650B5D51345875966327FB16A985EF05BF4F0DB84C3D604A9FD447C1120DB1DCB967C689FD6D25E9053FD8B496D6D41C194B0133B3A3D47BD4DCC3FEB9C887E82F3AAAC7C584D3F84474F8CA6D18872599800FE575B56E7A12404C39DFFBFD81276630B08768DAA55D2C94B6DE54D391FB43556303963A107F60E89747B8C605258810FBA58E2E57229EBC93016A5550F071EA305BD29858B41F380A05C8F5265D73EEB989A98383C
answer = BA0D89B5656E13935819E76EEC8A35669A28E65456D3896415003DF7AC4F3A5416E5C36703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010046851FF32F9D73F99456F20FF27E9C37C331734FB197FE0C1EF4F3FB6B4F965D2A972F17A5A84A7DFFC5DFAC4EA8189341CD812417F42DDBB3CAC6FCF2FAC093438A6421BA4535AD3F926D8C3B84413D6B4C9A00A9CBF549A7AE67F6EE34F036125696A650B5D51345875966327FB16A985EF05BF4F0DB84C3D604A9FD447C1120DB1DCB967C689FD6D25E9053FD8B496D6D41C194B0133B3A3D47BD4DCC3FEB9C887E82F3AAAC7C584D3F84474F8CA6D18872599800FE575B56E7A12404C39DFFBFD81276630B08768DAA55D2C94B6DE54D391FB43556303963A107F60E89747B8C605258810FBA58E2E57229EBC93016A5550F071EA305BD29858B41F380A05C8F5265D73EEB989A98383C</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 65 6E 13 93 58 19 E7 6E EC 8A 35 66
0010 | 9A 28 E6 54 56 D3 89 64 15 00 3D F7 AC 4F 3A 54
0020 | 16 E5 C3 67 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 46 85 1F F3 2F 9D 73 F9 94 56 F2 0F F2 7E 9C 37
0140 | C3 31 73 4F B1 97 FE 0C 1E F4 F3 FB 6B 4F 96 5D
0150 | 2A 97 2F 17 A5 A8 4A 7D FF C5 DF AC 4E A8 18 93
0160 | 41 CD 81 24 17 F4 2D DB B3 CA C6 FC F2 FA C0 93
0170 | 43 8A 64 21 BA 45 35 AD 3F 92 6D 8C 3B 84 41 3D
0180 | 6B 4C 9A 00 A9 CB F5 49 A7 AE 67 F6 EE 34 F0 36
0190 | 12 56 96 A6 50 B5 D5 13 45 87 59 66 32 7F B1 6A
01A0 | 98 5E F0 5B F4 F0 DB 84 C3 D6 04 A9 FD 44 7C 11
01B0 | 20 DB 1D CB 96 7C 68 9F D6 D2 5E 90 53 FD 8B 49
01C0 | 6D 6D 41 C1 94 B0 13 3B 3A 3D 47 BD 4D CC 3F EB
01D0 | 9C 88 7E 82 F3 AA AC 7C 58 4D 3F 84 47 4F 8C A6
01E0 | D1 88 72 59 98 00 FE 57 5B 56 E7 A1 24 04 C3 9D
01F0 | FF BF D8 12 76 63 0B 08 76 8D AA 55 D2 C9 4B 6D
0200 | E5 4D 39 1F B4 35 56 30 39 63 A1 07 F6 0E 89 74
0210 | 7B 8C 60 52 58 81 0F BA 58 E2 E5 72 29 EB C9 30
0220 | 16 A5 55 0F 07 1E A3 05 BD 29 85 8B 41 F3 80 A0
0230 | 5C 8F 52 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010046851FF32F9D73F99456F20F</code> <code>F27E9C37C331734FB197FE0C1EF4F3FB</code> <code>6B4F965D2A972F17A5A84A7DFFC5DFAC</code> <code>4EA8189341CD812417F42DDBB3CAC6FC</code> <code>F2FAC093438A6421BA4535AD3F926D8C</code> <code>3B84413D6B4C9A00A9CBF549A7AE67F6</code> <code>EE34F036125696A650B5D51345875966</code> <code>327FB16A985EF05BF4F0DB84C3D604A9</code> <code>FD447C1120DB1DCB967C689FD6D25E90</code> <code>53FD8B496D6D41C194B0133B3A3D47BD</code> <code>4DCC3FEB9C887E82F3AAAC7C584D3F84</code> <code>474F8CA6D18872599800FE575B56E7A1</code> <code>2404C39DFFBFD81276630B08768DAA55</code> <code>D2C94B6DE54D391FB43556303963A107</code> <code>F60E89747B8C605258810FBA58E2E572</code> <code>29EBC93016A5550F071EA305BD29858B</code><br> <code>41F380A0</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>5C8F5265</code> (1699909468 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A9C62D5F5DF7D5064C52FA9E15A724EF2111A658FE6C4A45DB02313C58899C1806E1655A819D0C7B6454213481C93C734637E240990272B41E0B25896954F60DE3734C08792E0AFBE0B92C49E4A77CC0B819EE5721108753247769FE7E2DE396B76A43A1D9A1B2014F045D042914780820CB3A44E6FD685C8B177C776CE1B8203FDF4CE2D0D9BB559EF4E52EA7D08BA71FC3EB44BA964931ADD84BF952AADE5A76E28CC40005A322C92C19722035108EEEDC7963E471F807161383B9210ECC78EE3C3654C94AC23B2905FB5E33260B2A660C898DC9EB0F1C7B91D05E71AC61B8E334D530F70ED468FAF312A3A0FD1720499F3EA2703CB240438FA32BFE9AB9DF</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B91B0D25B5EA73D684D49657008F57D98228B1F4DDBA5D58B61A9AF10676742354B201B209626A19CF2A118E997EF1AF5E60B000FEE007C4F0C621C02375233F9F5E527FF95B448B2456AF0665D7DE0D4219AE06ED3CD24EFB1C77D178534D2BFC24F1AAC069CF1E9B94615CC5A4076ADE695C87EC9B8532A68A0E79FBDF5440231B9DD434DC5E512EC72F2765078A9AB48C118437AF0716C18B02331D131025609BC9F317DB5871CAC35C18DC4B782347B217AD5C9A42E6CFB50C4F6C1643F90FE27589D229343D942F72A7FFE56213037A55C6AD780ED47942006E699AA1D28FA5003D7349B3F77A2DE1289EE7711CB9C609C77DAEEBC261DE438B0914B367</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 65 6E 13 93 58 19 E7 6E EC 8A 35 66
0010 | 9A 28 E6 54 56 D3 89 64 15 00 3D F7 AC 4F 3A 54
0020 | 16 E5 C3 67 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B9 1B 0D 25 B5 EA 73 D6 84 D4 96 57 00 8F 57 D9
0040 | 82 28 B1 F4 DD BA 5D 58 B6 1A 9A F1 06 76 74 23
0050 | 54 B2 01 B2 09 62 6A 19 CF 2A 11 8E 99 7E F1 AF
0060 | 5E 60 B0 00 FE E0 07 C4 F0 C6 21 C0 23 75 23 3F
0070 | 9F 5E 52 7F F9 5B 44 8B 24 56 AF 06 65 D7 DE 0D
0080 | 42 19 AE 06 ED 3C D2 4E FB 1C 77 D1 78 53 4D 2B
0090 | FC 24 F1 AA C0 69 CF 1E 9B 94 61 5C C5 A4 07 6A
00A0 | DE 69 5C 87 EC 9B 85 32 A6 8A 0E 79 FB DF 54 40
00B0 | 23 1B 9D D4 34 DC 5E 51 2E C7 2F 27 65 07 8A 9A
00C0 | B4 8C 11 84 37 AF 07 16 C1 8B 02 33 1D 13 10 25
00D0 | 60 9B C9 F3 17 DB 58 71 CA C3 5C 18 DC 4B 78 23
00E0 | 47 B2 17 AD 5C 9A 42 E6 CF B5 0C 4F 6C 16 43 F9
00F0 | 0F E2 75 89 D2 29 34 3D 94 2F 72 A7 FF E5 62 13
0100 | 03 7A 55 C6 AD 78 0E D4 79 42 00 6E 69 9A A1 D2
0110 | 8F A5 00 3D 73 49 B3 F7 7A 2D E1 28 9E E7 71 1C
0120 | B9 C6 09 C7 7D AE EB C2 61 DE 43 8B 09 14 B3 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B91B0D25B5EA73D684D49657</code> <code>008F57D98228B1F4DDBA5D58B61A9AF1</code> <code>0676742354B201B209626A19CF2A118E</code> <code>997EF1AF5E60B000FEE007C4F0C621C0</code> <code>2375233F9F5E527FF95B448B2456AF06</code> <code>65D7DE0D4219AE06ED3CD24EFB1C77D1</code> <code>78534D2BFC24F1AAC069CF1E9B94615C</code> <code>C5A4076ADE695C87EC9B8532A68A0E79</code> <code>FBDF5440231B9DD434DC5E512EC72F27</code> <code>65078A9AB48C118437AF0716C18B0233</code> <code>1D131025609BC9F317DB5871CAC35C18</code> <code>DC4B782347B217AD5C9A42E6CFB50C4F</code> <code>6C1643F90FE27589D229343D942F72A7</code> <code>FFE56213037A55C6AD780ED47942006E</code> <code>699AA1D28FA5003D7349B3F77A2DE128</code> <code>9EE7711CB9C609C77DAEEBC261DE438B</code><br> <code>0914B367</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366656E13935819E76EEC8A35669A28E65456D3896415003DF7AC4F3A5416E5C3670000000000000000FE000100B91B0D25B5EA73D684D49657008F57D98228B1F4DDBA5D58B61A9AF10676742354B201B209626A19CF2A118E997EF1AF5E60B000FEE007C4F0C621C02375233F9F5E527FF95B448B2456AF0665D7DE0D4219AE06ED3CD24EFB1C77D178534D2BFC24F1AAC069CF1E9B94615CC5A4076ADE695C87EC9B8532A68A0E79FBDF5440231B9DD434DC5E512EC72F2765078A9AB48C118437AF0716C18B02331D131025609BC9F317DB5871CAC35C18DC4B782347B217AD5C9A42E6CFB50C4F6C1643F90FE27589D229343D942F72A7FFE56213037A55C6AD780ED47942006E699AA1D28FA5003D7349B3F77A2DE1289EE7711CB9C609C77DAEEBC261DE438B0914B367
padding = 9A4EA5C48D611C758093013A
tmp_aes_key = 022F9B4E9EADB601A8BC7F9636B1721B7C9E3BBB72927FDC43B052899A31552D
tmp_aes_iv = 05777D67BA5E51E589DA36B406F2D216280E1341DDF4CA79320CBA1B667FE75D</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = BC6ACD1D5ADB27D38AD88BE5E673F7EB44A2D42C2E52ED51699E6942B46D4964A42A1DAC0FE2BF5B2784D19A11BC87EF2B5C8C2237E1021447CFA992A672542FB497687C8F7F7E185858B9AA2A77982134AE8ECDA99ECF1203AD98843EE872CA251CC615271F657A7ED332C14D50094E5CCADF2644DFDCF8C6248529BBC76D8CD73AA9AE0C54DCB0DC0F132B64188189F81A2F74B429EE61EFFCF12F7C4DD27A594F4C3B93DE9AF23E6E997F01AF85102CEF173DC7A8957ED2B93442F3EE7F2FCB424B8B8AA9BA30C4A5CA3B0964500318605853CE74B5F6D33820B677BA34D91EFB2A0E28B2F4FCB7B5ACADD4F8C354BAA68DA6242BFC1AD5DBB883FE5E8738DEE2B47D58A8ED91BE2801202481839A7702003555632657AEFEA53AE9B2C30107196214626CA3C19861131B8C1D0C776DA4BBCA727B0A341C2903096E05CE6DE0DA2E1CA62D0EAAB92F5B504A8C1F20</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 72 02 00 5C 8F 52 65
0010 | 78 01 00 00 1F 5F 04 F5 65 6E 13 93 58 19 E7 6E
0020 | EC 8A 35 66 9A 28 E6 54 56 D3 89 64 15 00 3D F7
0030 | AC 4F 3A 54 16 E5 C3 67 FE 50 01 00 BC 6A CD 1D
0040 | 5A DB 27 D3 8A D8 8B E5 E6 73 F7 EB 44 A2 D4 2C
0050 | 2E 52 ED 51 69 9E 69 42 B4 6D 49 64 A4 2A 1D AC
0060 | 0F E2 BF 5B 27 84 D1 9A 11 BC 87 EF 2B 5C 8C 22
0070 | 37 E1 02 14 47 CF A9 92 A6 72 54 2F B4 97 68 7C
0080 | 8F 7F 7E 18 58 58 B9 AA 2A 77 98 21 34 AE 8E CD
0090 | A9 9E CF 12 03 AD 98 84 3E E8 72 CA 25 1C C6 15
00A0 | 27 1F 65 7A 7E D3 32 C1 4D 50 09 4E 5C CA DF 26
00B0 | 44 DF DC F8 C6 24 85 29 BB C7 6D 8C D7 3A A9 AE
00C0 | 0C 54 DC B0 DC 0F 13 2B 64 18 81 89 F8 1A 2F 74
00D0 | B4 29 EE 61 EF FC F1 2F 7C 4D D2 7A 59 4F 4C 3B
00E0 | 93 DE 9A F2 3E 6E 99 7F 01 AF 85 10 2C EF 17 3D
00F0 | C7 A8 95 7E D2 B9 34 42 F3 EE 7F 2F CB 42 4B 8B
0100 | 8A A9 BA 30 C4 A5 CA 3B 09 64 50 03 18 60 58 53
0110 | CE 74 B5 F6 D3 38 20 B6 77 BA 34 D9 1E FB 2A 0E
0120 | 28 B2 F4 FC B7 B5 AC AD D4 F8 C3 54 BA A6 8D A6
0130 | 24 2B FC 1A D5 DB B8 83 FE 5E 87 38 DE E2 B4 7D
0140 | 58 A8 ED 91 BE 28 01 20 24 81 83 9A 77 02 00 35
0150 | 55 63 26 57 AE FE A5 3A E9 B2 C3 01 07 19 62 14
0160 | 62 6C A3 C1 98 61 13 1B 8C 1D 0C 77 6D A4 BB CA
0170 | 72 7B 0A 34 1C 29 03 09 6E 05 CE 6D E0 DA 2E 1C
0180 | A6 2D 0E AA B9 2F 5B 50 4A 8C 1F 20</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F07202005C8F5265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100BC6ACD1D5ADB27D38AD88BE5</code> <code>E673F7EB44A2D42C2E52ED51699E6942</code> <code>B46D4964A42A1DAC0FE2BF5B2784D19A</code> <code>11BC87EF2B5C8C2237E1021447CFA992</code> <code>A672542FB497687C8F7F7E185858B9AA</code> <code>2A77982134AE8ECDA99ECF1203AD9884</code> <code>3EE872CA251CC615271F657A7ED332C1</code> <code>4D50094E5CCADF2644DFDCF8C6248529</code> <code>BBC76D8CD73AA9AE0C54DCB0DC0F132B</code> <code>64188189F81A2F74B429EE61EFFCF12F</code> <code>7C4DD27A594F4C3B93DE9AF23E6E997F</code> <code>01AF85102CEF173DC7A8957ED2B93442</code> <code>F3EE7F2FCB424B8B8AA9BA30C4A5CA3B</code> <code>0964500318605853CE74B5F6D33820B6</code> <code>77BA34D91EFB2A0E28B2F4FCB7B5ACAD</code> <code>D4F8C354BAA68DA6242BFC1AD5DBB883</code> <code>FE5E8738DEE2B47D58A8ED91BE280120</code> <code>2481839A7702003555632657AEFEA53A</code> <code>E9B2C30107196214626CA3C19861131B</code> <code>8C1D0C776DA4BBCA727B0A341C290309</code> <code>6E05CE6DE0DA2E1CA62D0EAAB92F5B50</code><br> <code>4A8C1F20</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = A19E77A54D431E58632A6C3CDC1BF97A8425DD8DD2FFB47A88F5E6D6824F896A327728403DF5D41EA36BA5A74D0BEEC6FEF187D8587643D3C596786D4C9B36B904DE484F6F798E99518D3430A9A790C74474429DB518349B289998FE91BDFAB9DF3A8AE27C2D119B48F90AE85D7854CA9DBBFFE82A3C60E6D4FB570755F95504C03777DCDBC3F344E2E5A06C6EDD18598CB1AA14B42202ABB1469425B489CA86CF71B82E6E99EA31224645016E290B734F90CAFA72CEB8FF5E187D0BA3658B72799B48EC9469D9B1EA0260EC1EE22409F8A5D14B7A9920FC33F035578CB75EB107DFA816F9EC2F77D4F6EE76DB884CB8A0EA61D20828E3962918340BFAF5F318</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E4 B7 B7 5C 8F 52 65
0010 | 40 00 00 00 34 F7 CB 3B 65 6E 13 93 58 19 E7 6E
0020 | EC 8A 35 66 9A 28 E6 54 56 D3 89 64 15 00 3D F7
0030 | AC 4F 3A 54 16 E5 C3 67 9B 95 A7 41 1F 0B 6B 3E
0040 | 0D 4C 61 C4 67 B7 8B 84</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E4B7B75C8F5265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40000000</code> (64 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>656E13935819E76EEC8A35669A28E654</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>56D3896415003DF7AC4F3A5416E5C367</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>9B95A7411F0B6B3E0D4C61C467B78B84</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

