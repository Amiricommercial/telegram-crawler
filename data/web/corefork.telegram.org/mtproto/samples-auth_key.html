<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C4 03 0F 00 3A BB 74 65
0010 | 14 00 00 00 F1 8E 7E BE 12 D2 52 A6 52 49 2F 98
0020 | B3 E7 AC 76 FE FA 89 A4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C4030F003ABB7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 F3 23 3A BB 74 65
0010 | 58 00 00 00 63 24 16 05 12 D2 52 A6 52 49 2F 98
0020 | B3 E7 AC 76 FE FA 89 A4 6C E7 5A 07 8D 3B DA EC
0030 | 6C D2 D6 3A D8 67 9D DA 08 23 8D 10 D1 5D AC AD
0040 | 17 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0138F3233ABB7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08238D10D15DACAD17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2561722254449487127</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2561722254449487127</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2561722254449487127 = 1530421979 * 1673866613</code></p>
<pre><code>p = 1530421979
q = 1673866613</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 23 8D 10 D1 5D AC AD 17 00 00 00
0010 | 04 5B 38 62 DB 00 00 00 04 63 C5 2D 75 00 00 00
0020 | 12 D2 52 A6 52 49 2F 98 B3 E7 AC 76 FE FA 89 A4
0030 | 6C E7 5A 07 8D 3B DA EC 6C D2 D6 3A D8 67 9D DA
0040 | 56 01 8F A1 6B 1D 5A C2 AC 60 C6 0E A7 BB AD A5
0050 | EE 4A 6B BB 2B 6B 0C 29 F9 63 7F 1E EB DC 02 C9
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08238D10D15DACAD17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2561722254449487127</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045B3862DB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1530421979</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0463C52D75000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1673866613</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>56018FA16B1D5AC2AC60C60EA7BBADA5</code> <code>EE4A6BBB2B6B0C29F9637F1EEBDC02C9</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908238D10D15DACAD17000000045B3862DB0000000463C52D7500000012D252A652492F98B3E7AC76FEFA89A46CE75A078D3BDAEC6CD2D63AD8679DDA56018FA16B1D5AC2AC60C60EA7BBADA5EE4A6BBB2B6B0C29F9637F1EEBDC02C902000000
random_padding_bytes = 979109065C19335B68C0906AA669492BBDFD4930CC44A561EBA8470770E00BC833E64F4F78733CAB274365CE300CCB3103E3AC9B43E9FC026A98F7728E00628A953690E761A9EE10B9A984B34B0DBCF2BC8DAB15E91A6EEC9BFD8D25</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D9CBB19DB9128A9A39832DD1E904E38D4C2B2BF8C713736FDEFA3C340FA2186DC41B66E51C0B99FA9B1DFFA40293E7FCFFD10AF21ADBB21BAEF77C9DD103C39B26F7BB15C57D5384CE3686397318C3D6711259300DB30095160DC84A3B06AD8F491EB226861A9D01F8C4C8C846C0E4789CB023CD2AE265C175B5A0F9BE446CBD66FB11A9AF59DE03065EFE98D3F99D6DCC6DB0E2D37271D12B78F98F7D38DFF35CC7B4DEABFED8272E0D4C72736118263DE2EEE60641C36969B23D3678E9009DE7CF410AE85706937C520319474C39648FB8F7BD37EE85F71CFFB880EA17880EF99DE262E9D5F405FD1998F689B44BFBF4F8DEBA3B0B0190A7C642883D623EE9</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 03 0F 00 3A BB 74 65
0010 | 40 01 00 00 BE E4 12 D7 12 D2 52 A6 52 49 2F 98
0020 | B3 E7 AC 76 FE FA 89 A4 6C E7 5A 07 8D 3B DA EC
0030 | 6C D2 D6 3A D8 67 9D DA 04 5B 38 62 DB 00 00 00
0040 | 04 63 C5 2D 75 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D9 CB B1 9D B9 12 8A 9A 39 83 2D D1
0060 | E9 04 E3 8D 4C 2B 2B F8 C7 13 73 6F DE FA 3C 34
0070 | 0F A2 18 6D C4 1B 66 E5 1C 0B 99 FA 9B 1D FF A4
0080 | 02 93 E7 FC FF D1 0A F2 1A DB B2 1B AE F7 7C 9D
0090 | D1 03 C3 9B 26 F7 BB 15 C5 7D 53 84 CE 36 86 39
00A0 | 73 18 C3 D6 71 12 59 30 0D B3 00 95 16 0D C8 4A
00B0 | 3B 06 AD 8F 49 1E B2 26 86 1A 9D 01 F8 C4 C8 C8
00C0 | 46 C0 E4 78 9C B0 23 CD 2A E2 65 C1 75 B5 A0 F9
00D0 | BE 44 6C BD 66 FB 11 A9 AF 59 DE 03 06 5E FE 98
00E0 | D3 F9 9D 6D CC 6D B0 E2 D3 72 71 D1 2B 78 F9 8F
00F0 | 7D 38 DF F3 5C C7 B4 DE AB FE D8 27 2E 0D 4C 72
0100 | 73 61 18 26 3D E2 EE E6 06 41 C3 69 69 B2 3D 36
0110 | 78 E9 00 9D E7 CF 41 0A E8 57 06 93 7C 52 03 19
0120 | 47 4C 39 64 8F B8 F7 BD 37 EE 85 F7 1C FF B8 80
0130 | EA 17 88 0E F9 9D E2 62 E9 D5 F4 05 FD 19 98 F6
0140 | 89 B4 4B FB F4 F8 DE BA 3B 0B 01 90 A7 C6 42 88
0150 | 3D 62 3E E9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C8030F003ABB7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045B3862DB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1530421979</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0463C52D75000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1673866613</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D9CBB19DB9128A9A39832DD1</code> <code>E904E38D4C2B2BF8C713736FDEFA3C34</code> <code>0FA2186DC41B66E51C0B99FA9B1DFFA4</code> <code>0293E7FCFFD10AF21ADBB21BAEF77C9D</code> <code>D103C39B26F7BB15C57D5384CE368639</code> <code>7318C3D6711259300DB30095160DC84A</code> <code>3B06AD8F491EB226861A9D01F8C4C8C8</code> <code>46C0E4789CB023CD2AE265C175B5A0F9</code> <code>BE446CBD66FB11A9AF59DE03065EFE98</code> <code>D3F99D6DCC6DB0E2D37271D12B78F98F</code> <code>7D38DFF35CC7B4DEABFED8272E0D4C72</code> <code>736118263DE2EEE60641C36969B23D36</code> <code>78E9009DE7CF410AE85706937C520319</code> <code>474C39648FB8F7BD37EE85F71CFFB880</code> <code>EA17880EF99DE262E9D5F405FD1998F6</code> <code>89B44BFBF4F8DEBA3B0B0190A7C64288</code><br> <code>3D623EE9</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 FC D3 E6 3A BB 74 65
0010 | D4 02 00 00 5C 07 E8 D0 12 D2 52 A6 52 49 2F 98
0020 | B3 E7 AC 76 FE FA 89 A4 6C E7 5A 07 8D 3B DA EC
0030 | 6C D2 D6 3A D8 67 9D DA FE 50 02 00 0E 75 02 FC
0040 | 77 76 13 32 EB BF AC 5A 3D 6F 6B 79 99 5A AA 71
0050 | DD 7D DF 6E F7 4B 23 FE 72 2A D9 96 82 8F 85 28
0060 | 4A A7 6B BF 6D 58 60 51 BC 2E 7E 58 6A DE 76 A9
0070 | 80 E2 66 08 AF 09 E3 6C 83 95 BE 7F E1 E1 15 D2
0080 | 15 DD 16 52 2C 7D E8 84 E7 9D 47 01 BC 42 52 FB
0090 | 1E CC 75 53 23 9D 40 B8 3E 37 65 76 E3 DB 9B 26
00A0 | D2 D0 26 A4 91 33 F2 83 01 EC 76 0A ED 51 DF 08
00B0 | 2D BB 4F 3D 57 F5 30 E5 09 9B E9 51 7F E1 7E F1
00C0 | B7 E8 37 B6 F9 6D E4 E0 7A 24 C2 E5 97 6D 91 83
00D0 | CB 9C 0A 0D 56 26 B2 73 A0 C9 F3 CA CB D2 2F 3E
00E0 | 37 E9 74 84 4D 35 A6 D0 A3 99 AE 18 75 66 1D 08
00F0 | 4D E9 02 00 9B 36 58 1E 9A 26 9A 80 55 0E A8 2A
0100 | D1 DA CD C1 7C 9D 45 DD 64 A4 32 05 4C 67 7B D7
0110 | D8 A2 2B F5 5B 5E 42 26 40 E8 4A 41 DE 8F 32 89
0120 | 6F CB 28 EC 95 8B 6A 72 68 68 FA 50 95 1D 8A 79
0130 | AE C5 AE B8 79 8C 5C D2 F2 FD 23 14 BD 42 B6 FE
0140 | C5 89 C0 40 87 F9 0C 97 94 1F EA 8A F6 6A 7C D2
0150 | 10 B9 A5 46 2C 1C 73 40 39 9D 5B 14 6D BB 57 FC
0160 | 24 4D D0 EF 86 71 68 11 72 2D F1 3B 1B E3 1B 1E
0170 | 73 DD 0F 7A 94 74 34 DF 9D 1F 62 C3 D1 32 1E 48
0180 | 65 29 1B A4 CF 9B 74 27 95 E6 E1 BA 2E 30 AA 46
0190 | 40 9F 20 E9 FE 72 7A 92 1D 0C C9 C5 8B A5 46 81
01A0 | 90 39 0D 43 8F CF 20 98 BD 8F 2D 11 55 0C 20 7D
01B0 | C0 85 63 C9 04 08 0E 8C B7 4F E9 93 61 9B 0A 7C
01C0 | 30 FD 58 C2 C5 88 01 90 FE 91 FA 35 2D 1D EF 76
01D0 | CB 3C 9E FD BD 7C 57 EF C7 B1 E7 06 27 D6 20 CC
01E0 | 85 DF F6 01 A0 10 6E 9D 9E EA A6 3F B4 6D BA 8E
01F0 | 06 5F 4E D0 3A F7 92 E9 68 F0 BF E6 BF 84 6F DD
0200 | 84 09 6A D4 E0 4F 3A 0E 29 94 B1 4C B8 53 9F 88
0210 | 1D 17 32 20 10 0E A3 90 F9 D0 4F 47 B5 B5 97 82
0220 | FA CB E1 B8 54 DA 20 53 E3 13 FA 7A B1 C8 18 04
0230 | 6F E5 5A 31 33 72 86 F2 F1 01 7A 9C 9B 80 8B 78
0240 | C7 21 AA B4 B3 DA AA B6 0C E7 70 D1 91 E9 8F 6E
0250 | 3B FB 69 0A 37 D0 65 11 C2 A4 06 0E 4A E2 25 68
0260 | 97 A0 29 E5 FB 57 99 20 84 BA 0C E2 15 96 CA 78
0270 | E9 8F E4 F3 C4 8A 4D 8C F4 F3 D7 67 DA 6B A0 DC
0280 | 0B F8 30 35 A8 21 D0 3E 0B 9E 26 91</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01FCD3E63ABB7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>D4020000</code> (724 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002000E7502FC77761332EBBFAC5A</code> <code>3D6F6B79995AAA71DD7DDF6EF74B23FE</code> <code>722AD996828F85284AA76BBF6D586051</code> <code>BC2E7E586ADE76A980E26608AF09E36C</code> <code>8395BE7FE1E115D215DD16522C7DE884</code> <code>E79D4701BC4252FB1ECC7553239D40B8</code> <code>3E376576E3DB9B26D2D026A49133F283</code> <code>01EC760AED51DF082DBB4F3D57F530E5</code> <code>099BE9517FE17EF1B7E837B6F96DE4E0</code> <code>7A24C2E5976D9183CB9C0A0D5626B273</code> <code>A0C9F3CACBD22F3E37E974844D35A6D0</code> <code>A399AE1875661D084DE902009B36581E</code> <code>9A269A80550EA82AD1DACDC17C9D45DD</code> <code>64A432054C677BD7D8A22BF55B5E4226</code> <code>40E84A41DE8F32896FCB28EC958B6A72</code> <code>6868FA50951D8A79AEC5AEB8798C5CD2</code> <code>F2FD2314BD42B6FEC589C04087F90C97</code> <code>941FEA8AF66A7CD210B9A5462C1C7340</code> <code>399D5B146DBB57FC244DD0EF86716811</code> <code>722DF13B1BE31B1E73DD0F7A947434DF</code> <code>9D1F62C3D1321E4865291BA4CF9B7427</code> <code>95E6E1BA2E30AA46409F20E9FE727A92</code> <code>1D0CC9C58BA5468190390D438FCF2098</code> <code>BD8F2D11550C207DC08563C904080E8C</code> <code>B74FE993619B0A7C30FD58C2C5880190</code> <code>FE91FA352D1DEF76CB3C9EFDBD7C57EF</code> <code>C7B1E70627D620CC85DFF601A0106E9D</code> <code>9EEAA63FB46DBA8E065F4ED03AF792E9</code> <code>68F0BFE6BF846FDD84096AD4E04F3A0E</code> <code>2994B14CB8539F881D173220100EA390</code> <code>F9D04F47B5B59782FACBE1B854DA2053</code> <code>E313FA7AB1C818046FE55A31337286F2</code> <code>F1017A9C9B808B78C721AAB4B3DAAAB6</code> <code>0CE770D191E98F6E3BFB690A37D06511</code> <code>C2A4060E4AE2256897A029E5FB579920</code> <code>84BA0CE21596CA78E98FE4F3C48A4D8C</code> <code>F4F3D767DA6BA0DC0BF83035A821D03E</code><br> <code>0B9E2691</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 0E7502FC77761332EBBFAC5A3D6F6B79995AAA71DD7DDF6EF74B23FE722AD996828F85284AA76BBF6D586051BC2E7E586ADE76A980E26608AF09E36C8395BE7FE1E115D215DD16522C7DE884E79D4701BC4252FB1ECC7553239D40B83E376576E3DB9B26D2D026A49133F28301EC760AED51DF082DBB4F3D57F530E5099BE9517FE17EF1B7E837B6F96DE4E07A24C2E5976D9183CB9C0A0D5626B273A0C9F3CACBD22F3E37E974844D35A6D0A399AE1875661D084DE902009B36581E9A269A80550EA82AD1DACDC17C9D45DD64A432054C677BD7D8A22BF55B5E422640E84A41DE8F32896FCB28EC958B6A726868FA50951D8A79AEC5AEB8798C5CD2F2FD2314BD42B6FEC589C04087F90C97941FEA8AF66A7CD210B9A5462C1C7340399D5B146DBB57FC244DD0EF86716811722DF13B1BE31B1E73DD0F7A947434DF9D1F62C3D1321E4865291BA4CF9B742795E6E1BA2E30AA46409F20E9FE727A921D0CC9C58BA5468190390D438FCF2098BD8F2D11550C207DC08563C904080E8CB74FE993619B0A7C30FD58C2C5880190FE91FA352D1DEF76CB3C9EFDBD7C57EFC7B1E70627D620CC85DFF601A0106E9D9EEAA63FB46DBA8E065F4ED03AF792E968F0BFE6BF846FDD84096AD4E04F3A0E2994B14CB8539F881D173220100EA390F9D04F47B5B59782FACBE1B854DA2053E313FA7AB1C818046FE55A31337286F2F1017A9C9B808B78C721AAB4B3DAAAB60CE770D191E98F6E3BFB690A37D06511C2A4060E4AE2256897A029E5FB57992084BA0CE21596CA78E98FE4F3C48A4D8CF4F3D767DA6BA0DC0BF83035A821D03E0B9E2691
tmp_aes_key = F97885237250E1E2923A564401F69AA32F283C7A9C3448965DAB36A9481EE649
tmp_aes_iv = 954D4B646A8170F6C46CD9F709B2E4203595359E5AA26C84DA8918FB56018FA1</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = A5EBFA70800CECFE974D1B3F5368C9C143740722BA0D89B512D252A652492F98B3E7AC76FEFA89A46CE75A078D3BDAEC6CD2D63AD8679DDA03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100347BE521229C862F6DE3FB2DA9ECE4F5D77B8BBD389E8AF45F2377C6E1D3F6ACE73A2EDD1F24F638DD52BB46ED8C470EE3338EECF830DD88E1F64D33F2B64009B9D3F2DBB3092F0B47B4812B14B3790DB994DD7E672D2878BAE02AAB806831384252993D4E9461AD4D81AFF85267ADBE55CD68FF074E59C0F47E801C091F0C407C35176F17C3A3C5606C47EA9EAE2065F1FAA6BE24CD6F0855EFE9FD6F2DEE69F826ACACE3E21A62F6D9812433247959E9E65265FC9BB398CA860C7244832D08EF37ABC298BE190C8051808235859652EE1E29512F17FD6881074049ECC5FD9B05F24F9808244B5440D6394E7FE4ADA0CA9659A0A94020B0BBA2E1F582BCD3333ABB7465A33090C42DAFA01F
answer = BA0D89B512D252A652492F98B3E7AC76FEFA89A46CE75A078D3BDAEC6CD2D63AD8679DDA03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100347BE521229C862F6DE3FB2DA9ECE4F5D77B8BBD389E8AF45F2377C6E1D3F6ACE73A2EDD1F24F638DD52BB46ED8C470EE3338EECF830DD88E1F64D33F2B64009B9D3F2DBB3092F0B47B4812B14B3790DB994DD7E672D2878BAE02AAB806831384252993D4E9461AD4D81AFF85267ADBE55CD68FF074E59C0F47E801C091F0C407C35176F17C3A3C5606C47EA9EAE2065F1FAA6BE24CD6F0855EFE9FD6F2DEE69F826ACACE3E21A62F6D9812433247959E9E65265FC9BB398CA860C7244832D08EF37ABC298BE190C8051808235859652EE1E29512F17FD6881074049ECC5FD9B05F24F9808244B5440D6394E7FE4ADA0CA9659A0A94020B0BBA2E1F582BCD3333ABB7465A33090C42DAFA01F</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 12 D2 52 A6 52 49 2F 98 B3 E7 AC 76
0010 | FE FA 89 A4 6C E7 5A 07 8D 3B DA EC 6C D2 D6 3A
0020 | D8 67 9D DA 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 34 7B E5 21 22 9C 86 2F 6D E3 FB 2D A9 EC E4 F5
0140 | D7 7B 8B BD 38 9E 8A F4 5F 23 77 C6 E1 D3 F6 AC
0150 | E7 3A 2E DD 1F 24 F6 38 DD 52 BB 46 ED 8C 47 0E
0160 | E3 33 8E EC F8 30 DD 88 E1 F6 4D 33 F2 B6 40 09
0170 | B9 D3 F2 DB B3 09 2F 0B 47 B4 81 2B 14 B3 79 0D
0180 | B9 94 DD 7E 67 2D 28 78 BA E0 2A AB 80 68 31 38
0190 | 42 52 99 3D 4E 94 61 AD 4D 81 AF F8 52 67 AD BE
01A0 | 55 CD 68 FF 07 4E 59 C0 F4 7E 80 1C 09 1F 0C 40
01B0 | 7C 35 17 6F 17 C3 A3 C5 60 6C 47 EA 9E AE 20 65
01C0 | F1 FA A6 BE 24 CD 6F 08 55 EF E9 FD 6F 2D EE 69
01D0 | F8 26 AC AC E3 E2 1A 62 F6 D9 81 24 33 24 79 59
01E0 | E9 E6 52 65 FC 9B B3 98 CA 86 0C 72 44 83 2D 08
01F0 | EF 37 AB C2 98 BE 19 0C 80 51 80 82 35 85 96 52
0200 | EE 1E 29 51 2F 17 FD 68 81 07 40 49 EC C5 FD 9B
0210 | 05 F2 4F 98 08 24 4B 54 40 D6 39 4E 7F E4 AD A0
0220 | CA 96 59 A0 A9 40 20 B0 BB A2 E1 F5 82 BC D3 33
0230 | 3A BB 74 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100347BE521229C862F6DE3FB2D</code> <code>A9ECE4F5D77B8BBD389E8AF45F2377C6</code> <code>E1D3F6ACE73A2EDD1F24F638DD52BB46</code> <code>ED8C470EE3338EECF830DD88E1F64D33</code> <code>F2B64009B9D3F2DBB3092F0B47B4812B</code> <code>14B3790DB994DD7E672D2878BAE02AAB</code> <code>806831384252993D4E9461AD4D81AFF8</code> <code>5267ADBE55CD68FF074E59C0F47E801C</code> <code>091F0C407C35176F17C3A3C5606C47EA</code> <code>9EAE2065F1FAA6BE24CD6F0855EFE9FD</code> <code>6F2DEE69F826ACACE3E21A62F6D98124</code> <code>33247959E9E65265FC9BB398CA860C72</code> <code>44832D08EF37ABC298BE190C80518082</code> <code>35859652EE1E29512F17FD6881074049</code> <code>ECC5FD9B05F24F9808244B5440D6394E</code> <code>7FE4ADA0CA9659A0A94020B0BBA2E1F5</code><br> <code>82BCD333</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>3ABB7465</code> (1702148922 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 47F55ABF75125D664CB42AC0484DD33B40314EACCD487BFAE50271930D1F83A9455DF1FC0F4013530DB5BC205371E79238EBFCB46755CC43AA762595FA8C4A1108A9B5EB992B13DA7D816BAB9F8098721A76EA38238EB52809BE487EFBA926E5C821461AC4DB4325880DE8A234EB6BD97743E6D099F941197D85EE92336B90AB6DE61732F1F59E42DC125F4A1C97938DC648564ABF0A36B3F487A165BF5B088158B61CD8EDDEE600943637E6C0F5D037F49D2D68440CF3E1276FDBF03D7C1939E737BAAB001C4F56CA6108DFFEC95EB1B842B065D461D13F617AD2A6D0FEB45EF37B947E7504133A423890E52A090F50138D381B797A149FAE7BAF771CB45DC1</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 6D2DEC4316EE4A6C99B4637DEA60FBEC3FF3681142DDDF0766A9903FDF521BC1A5A1E96CB38596FC893FE5417A722F4F119542D3AB21DCB06783FE3E4C1E60C2FE225E8B631083A82E3C66AC3959564DFA4BC422DD870106A698726EBD30E152619EE13691355BA52408158C70F890B4CEEA6831CC7D9C357049A38B104BB1EAC19F21EB4F66F5FC63695C85F0DB7F3CB1E8FB0064EBB1EA8092832F1DA77476897FD269F3E9A8B41212ED78CA6EB0456E2DF7014F6D5C7671877E8997EABDECD0DC3F94E986B0EF32A1EA5F5F5563460E8E0D18571FEA329B3B36312B22D24590FFE27BF00F950853F0A837F1276ECC7A0524DEFC1B603BD3C274AA7691D0AD</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 12 D2 52 A6 52 49 2F 98 B3 E7 AC 76
0010 | FE FA 89 A4 6C E7 5A 07 8D 3B DA EC 6C D2 D6 3A
0020 | D8 67 9D DA 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 6D 2D EC 43 16 EE 4A 6C 99 B4 63 7D EA 60 FB EC
0040 | 3F F3 68 11 42 DD DF 07 66 A9 90 3F DF 52 1B C1
0050 | A5 A1 E9 6C B3 85 96 FC 89 3F E5 41 7A 72 2F 4F
0060 | 11 95 42 D3 AB 21 DC B0 67 83 FE 3E 4C 1E 60 C2
0070 | FE 22 5E 8B 63 10 83 A8 2E 3C 66 AC 39 59 56 4D
0080 | FA 4B C4 22 DD 87 01 06 A6 98 72 6E BD 30 E1 52
0090 | 61 9E E1 36 91 35 5B A5 24 08 15 8C 70 F8 90 B4
00A0 | CE EA 68 31 CC 7D 9C 35 70 49 A3 8B 10 4B B1 EA
00B0 | C1 9F 21 EB 4F 66 F5 FC 63 69 5C 85 F0 DB 7F 3C
00C0 | B1 E8 FB 00 64 EB B1 EA 80 92 83 2F 1D A7 74 76
00D0 | 89 7F D2 69 F3 E9 A8 B4 12 12 ED 78 CA 6E B0 45
00E0 | 6E 2D F7 01 4F 6D 5C 76 71 87 7E 89 97 EA BD EC
00F0 | D0 DC 3F 94 E9 86 B0 EF 32 A1 EA 5F 5F 55 63 46
0100 | 0E 8E 0D 18 57 1F EA 32 9B 3B 36 31 2B 22 D2 45
0110 | 90 FF E2 7B F0 0F 95 08 53 F0 A8 37 F1 27 6E CC
0120 | 7A 05 24 DE FC 1B 60 3B D3 C2 74 AA 76 91 D0 AD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001006D2DEC4316EE4A6C99B4637D</code> <code>EA60FBEC3FF3681142DDDF0766A9903F</code> <code>DF521BC1A5A1E96CB38596FC893FE541</code> <code>7A722F4F119542D3AB21DCB06783FE3E</code> <code>4C1E60C2FE225E8B631083A82E3C66AC</code> <code>3959564DFA4BC422DD870106A698726E</code> <code>BD30E152619EE13691355BA52408158C</code> <code>70F890B4CEEA6831CC7D9C357049A38B</code> <code>104BB1EAC19F21EB4F66F5FC63695C85</code> <code>F0DB7F3CB1E8FB0064EBB1EA8092832F</code> <code>1DA77476897FD269F3E9A8B41212ED78</code> <code>CA6EB0456E2DF7014F6D5C7671877E89</code> <code>97EABDECD0DC3F94E986B0EF32A1EA5F</code> <code>5F5563460E8E0D18571FEA329B3B3631</code> <code>2B22D24590FFE27BF00F950853F0A837</code> <code>F1276ECC7A0524DEFC1B603BD3C274AA</code><br> <code>7691D0AD</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436612D252A652492F98B3E7AC76FEFA89A46CE75A078D3BDAEC6CD2D63AD8679DDA0000000000000000FE0001006D2DEC4316EE4A6C99B4637DEA60FBEC3FF3681142DDDF0766A9903FDF521BC1A5A1E96CB38596FC893FE5417A722F4F119542D3AB21DCB06783FE3E4C1E60C2FE225E8B631083A82E3C66AC3959564DFA4BC422DD870106A698726EBD30E152619EE13691355BA52408158C70F890B4CEEA6831CC7D9C357049A38B104BB1EAC19F21EB4F66F5FC63695C85F0DB7F3CB1E8FB0064EBB1EA8092832F1DA77476897FD269F3E9A8B41212ED78CA6EB0456E2DF7014F6D5C7671877E8997EABDECD0DC3F94E986B0EF32A1EA5F5F5563460E8E0D18571FEA329B3B36312B22D24590FFE27BF00F950853F0A837F1276ECC7A0524DEFC1B603BD3C274AA7691D0AD
padding = 7207D745977DE93E3241406F
tmp_aes_key = F97885237250E1E2923A564401F69AA32F283C7A9C3448965DAB36A9481EE649
tmp_aes_iv = 954D4B646A8170F6C46CD9F709B2E4203595359E5AA26C84DA8918FB56018FA1</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = A503E6CD8B949E333CA530863336E66D42F26723883828EC831280772BCDF29C9770EFC917E6971C83830FA60F32C76696877EBE68620AD75CD5338777835E4CED6E3529CE4391C3FBD97E5E81B47FF060EED9CDFB91BE9DB9E82DE5E32187299DACB5FB667F409E4C2FC9118509CA68CB484B0F9597DE3707B31744DE2FAD949957B3FAA8A9D34CCD4399103704739E2B8620C4FE32737063D46D40833E79BF62A8062EEB5D518C38C02AA4CE85D9EF00B7B975144BEE80C1223A272E6B0EF4373AD6C6F86C30AC0FAA106DFEDDB8D15CA1752B960D39AAD9DB8BC19F1D89AF4DB0FDCE2E2CD407841446ECEF382984E3445096864F39DD9D3CCF1026D45888FE3E5E5864352087BCDC335587ED91E44263EB784C2B31B841A55803AC6A5572517BE118906FDFCFFA815C4B2F911351758117C07DEE4744109866657D281DDD1F6CDA0EDF72CDB43A0333320B12227C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC 03 0F 00 3A BB 74 65
0010 | 78 01 00 00 1F 5F 04 F5 12 D2 52 A6 52 49 2F 98
0020 | B3 E7 AC 76 FE FA 89 A4 6C E7 5A 07 8D 3B DA EC
0030 | 6C D2 D6 3A D8 67 9D DA FE 50 01 00 A5 03 E6 CD
0040 | 8B 94 9E 33 3C A5 30 86 33 36 E6 6D 42 F2 67 23
0050 | 88 38 28 EC 83 12 80 77 2B CD F2 9C 97 70 EF C9
0060 | 17 E6 97 1C 83 83 0F A6 0F 32 C7 66 96 87 7E BE
0070 | 68 62 0A D7 5C D5 33 87 77 83 5E 4C ED 6E 35 29
0080 | CE 43 91 C3 FB D9 7E 5E 81 B4 7F F0 60 EE D9 CD
0090 | FB 91 BE 9D B9 E8 2D E5 E3 21 87 29 9D AC B5 FB
00A0 | 66 7F 40 9E 4C 2F C9 11 85 09 CA 68 CB 48 4B 0F
00B0 | 95 97 DE 37 07 B3 17 44 DE 2F AD 94 99 57 B3 FA
00C0 | A8 A9 D3 4C CD 43 99 10 37 04 73 9E 2B 86 20 C4
00D0 | FE 32 73 70 63 D4 6D 40 83 3E 79 BF 62 A8 06 2E
00E0 | EB 5D 51 8C 38 C0 2A A4 CE 85 D9 EF 00 B7 B9 75
00F0 | 14 4B EE 80 C1 22 3A 27 2E 6B 0E F4 37 3A D6 C6
0100 | F8 6C 30 AC 0F AA 10 6D FE DD B8 D1 5C A1 75 2B
0110 | 96 0D 39 AA D9 DB 8B C1 9F 1D 89 AF 4D B0 FD CE
0120 | 2E 2C D4 07 84 14 46 EC EF 38 29 84 E3 44 50 96
0130 | 86 4F 39 DD 9D 3C CF 10 26 D4 58 88 FE 3E 5E 58
0140 | 64 35 20 87 BC DC 33 55 87 ED 91 E4 42 63 EB 78
0150 | 4C 2B 31 B8 41 A5 58 03 AC 6A 55 72 51 7B E1 18
0160 | 90 6F DF CF FA 81 5C 4B 2F 91 13 51 75 81 17 C0
0170 | 7D EE 47 44 10 98 66 65 7D 28 1D DD 1F 6C DA 0E
0180 | DF 72 CD B4 3A 03 33 32 0B 12 22 7C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CC030F003ABB7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100A503E6CD8B949E333CA53086</code> <code>3336E66D42F26723883828EC83128077</code> <code>2BCDF29C9770EFC917E6971C83830FA6</code> <code>0F32C76696877EBE68620AD75CD53387</code> <code>77835E4CED6E3529CE4391C3FBD97E5E</code> <code>81B47FF060EED9CDFB91BE9DB9E82DE5</code> <code>E32187299DACB5FB667F409E4C2FC911</code> <code>8509CA68CB484B0F9597DE3707B31744</code> <code>DE2FAD949957B3FAA8A9D34CCD439910</code> <code>3704739E2B8620C4FE32737063D46D40</code> <code>833E79BF62A8062EEB5D518C38C02AA4</code> <code>CE85D9EF00B7B975144BEE80C1223A27</code> <code>2E6B0EF4373AD6C6F86C30AC0FAA106D</code> <code>FEDDB8D15CA1752B960D39AAD9DB8BC1</code> <code>9F1D89AF4DB0FDCE2E2CD407841446EC</code> <code>EF382984E3445096864F39DD9D3CCF10</code> <code>26D45888FE3E5E5864352087BCDC3355</code> <code>87ED91E44263EB784C2B31B841A55803</code> <code>AC6A5572517BE118906FDFCFFA815C4B</code> <code>2F911351758117C07DEE474410986665</code> <code>7D281DDD1F6CDA0EDF72CDB43A033332</code><br> <code>0B12227C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 244410BC9D177FCDB8EFFB35E66FFD061C5A1FC1B1B42490DDF5F621C348D9275513C5AD9E4869AA35BE3547282FAA822C1A55D63AF593EA23E09AED79F190DECDD0940CB86C0BA8A983CDC2D97F538D4109DD18955E99B881A95670710532F898C3406113CA35F658099DEA83EC0052272F7C1D0BEED401E3D6A6341499009B961DD2EA74F1875579A90E0F152A87A6853FE320EB27E76DAF367795086597F7160F7C392DEBE55E7AA8B3FB181999659E3B925283211FEEF0DE6FAC7866D43E22F2D5068E5D081C42D291316F750AB1304D13CCFBBB5094529B9E056A49F6C42B5689BBF5475B24C9EF200AF82E4ADF62FC3FA996DB99A4B80549B0C853FCCC</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 E0 33 3B BB 74 65
0010 | 9C 00 00 00 34 F7 CB 3B 12 D2 52 A6 52 49 2F 98
0020 | B3 E7 AC 76 FE FA 89 A4 6C E7 5A 07 8D 3B DA EC
0030 | 6C D2 D6 3A D8 67 9D DA 8B FA C8 03 5D A7 77 2B
0040 | 7F 58 18 E2 3A 86 65 79</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0160E0333BBB7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>9C000000</code> (156 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>12D252A652492F98B3E7AC76FEFA89A4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6CE75A078D3BDAEC6CD2D63AD8679DDA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>8BFAC8035DA7772B7F5818E23A866579</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

