<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 50 11 04 00 E3 8D 3A 65
0010 | 14 00 00 00 F1 8E 7E BE 2D 04 92 CF AF BB 64 8E
0020 | 66 10 FC CC 4E AB 76 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>50110400E38D3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 2C 61 58 DF 8D 3A 65
0010 | 84 00 00 00 63 24 16 05 2D 04 92 CF AF BB 64 8E
0020 | 66 10 FC CC 4E AB 76 00 86 62 FB 56 73 6E 14 8F
0030 | C2 F3 AA 5E 25 50 43 10 08 21 F8 7A 8A 85 A8 1F
0040 | 01 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>012C6158DF8D3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>84000000</code> (132 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0821F87A8A85A81F01000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2447841132842327809</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2447841132842327809</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2447841132842327809 = 1307819633 * 1871696273</code></p>
<pre><code>p = 1307819633
q = 1871696273</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 21 F8 7A 8A 85 A8 1F 01 00 00 00
0010 | 04 4D F3 BE 71 00 00 00 04 6F 8F D1 91 00 00 00
0020 | 2D 04 92 CF AF BB 64 8E 66 10 FC CC 4E AB 76 00
0030 | 86 62 FB 56 73 6E 14 8F C2 F3 AA 5E 25 50 43 10
0040 | 23 FA 9D B2 BC 29 E7 F3 A0 0D 2A 21 2C AF 26 A6
0050 | 23 69 E0 8A 2E F3 22 5C 90 CF 92 C2 64 04 7E ED
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0821F87A8A85A81F01000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2447841132842327809</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044DF3BE71000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1307819633</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046F8FD191000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1871696273</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>23FA9DB2BC29E7F3A00D2A212CAF26A6</code> <code>2369E08A2EF3225C90CF92C264047EED</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90821F87A8A85A81F01000000044DF3BE71000000046F8FD1910000002D0492CFAFBB648E6610FCCC4EAB76008662FB56736E148FC2F3AA5E2550431023FA9DB2BC29E7F3A00D2A212CAF26A62369E08A2EF3225C90CF92C264047EED02000000
random_padding_bytes = 116EF64A9EF4CAC893017400DAA3DEAA1909CAE11333DECBF8CB9F414BD4EFFAB3B536DD1DE9FEAB0201382386EE06500EC087FBCEC47E7740BBBAE7C99FB63863B0E8ABAE095AB080C3F9A830406DAFBA8095BE8C6499584581060D</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 52D7E2455C52741B1111852120057C4316010FB24CF858466BF33319B8796C6A2D384AC37AE26BF7A60C80CD63F61207ABA81E60C588558F71967D838C98EA9BBA61A66F92CD851BBF317307CD1595724369334865A6893668D09A1D982536270C7A866CB85D739061FD40D89E93BB901430C0ADDC91744979EFD3415ACEDAA276559EA44DBCF85BCFA94FF2F989172736AAFCDB6897A5C17BF7A55EC8CA42F52D127C67C08E3AA53824B72F859A6FCC1FC8C45B601B7E3B3CF7DC36D140ADDDBFF5540459E7F93D03313A08EFE90004861A11048AB3C3791BCAADD4591E2BC2434DB3DD82EB6DED725BB7A755591B316441FFAC3B9F167DD963ADDD016926FF</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 08 05 00 E3 8D 3A 65
0010 | 40 01 00 00 BE E4 12 D7 2D 04 92 CF AF BB 64 8E
0020 | 66 10 FC CC 4E AB 76 00 86 62 FB 56 73 6E 14 8F
0030 | C2 F3 AA 5E 25 50 43 10 04 4D F3 BE 71 00 00 00
0040 | 04 6F 8F D1 91 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 52 D7 E2 45 5C 52 74 1B 11 11 85 21
0060 | 20 05 7C 43 16 01 0F B2 4C F8 58 46 6B F3 33 19
0070 | B8 79 6C 6A 2D 38 4A C3 7A E2 6B F7 A6 0C 80 CD
0080 | 63 F6 12 07 AB A8 1E 60 C5 88 55 8F 71 96 7D 83
0090 | 8C 98 EA 9B BA 61 A6 6F 92 CD 85 1B BF 31 73 07
00A0 | CD 15 95 72 43 69 33 48 65 A6 89 36 68 D0 9A 1D
00B0 | 98 25 36 27 0C 7A 86 6C B8 5D 73 90 61 FD 40 D8
00C0 | 9E 93 BB 90 14 30 C0 AD DC 91 74 49 79 EF D3 41
00D0 | 5A CE DA A2 76 55 9E A4 4D BC F8 5B CF A9 4F F2
00E0 | F9 89 17 27 36 AA FC DB 68 97 A5 C1 7B F7 A5 5E
00F0 | C8 CA 42 F5 2D 12 7C 67 C0 8E 3A A5 38 24 B7 2F
0100 | 85 9A 6F CC 1F C8 C4 5B 60 1B 7E 3B 3C F7 DC 36
0110 | D1 40 AD DD BF F5 54 04 59 E7 F9 3D 03 31 3A 08
0120 | EF E9 00 04 86 1A 11 04 8A B3 C3 79 1B CA AD D4
0130 | 59 1E 2B C2 43 4D B3 DD 82 EB 6D ED 72 5B B7 A7
0140 | 55 59 1B 31 64 41 FF AC 3B 9F 16 7D D9 63 AD DD
0150 | 01 69 26 FF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C8080500E38D3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044DF3BE71000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1307819633</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046F8FD191000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1871696273</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010052D7E2455C52741B11118521</code> <code>20057C4316010FB24CF858466BF33319</code> <code>B8796C6A2D384AC37AE26BF7A60C80CD</code> <code>63F61207ABA81E60C588558F71967D83</code> <code>8C98EA9BBA61A66F92CD851BBF317307</code> <code>CD1595724369334865A6893668D09A1D</code> <code>982536270C7A866CB85D739061FD40D8</code> <code>9E93BB901430C0ADDC91744979EFD341</code> <code>5ACEDAA276559EA44DBCF85BCFA94FF2</code> <code>F989172736AAFCDB6897A5C17BF7A55E</code> <code>C8CA42F52D127C67C08E3AA53824B72F</code> <code>859A6FCC1FC8C45B601B7E3B3CF7DC36</code> <code>D140ADDDBFF5540459E7F93D03313A08</code> <code>EFE90004861A11048AB3C3791BCAADD4</code> <code>591E2BC2434DB3DD82EB6DED725BB7A7</code> <code>55591B316441FFAC3B9F167DD963ADDD</code><br> <code>016926FF</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 4C D3 13 E0 8D 3A 65
0010 | E8 02 00 00 5C 07 E8 D0 2D 04 92 CF AF BB 64 8E
0020 | 66 10 FC CC 4E AB 76 00 86 62 FB 56 73 6E 14 8F
0030 | C2 F3 AA 5E 25 50 43 10 FE 50 02 00 CE 42 8F 68
0040 | 24 06 CE 02 FF 23 11 D3 B1 B4 76 13 64 3F 0B EF
0050 | 7C B8 F1 09 67 51 CC 87 09 C3 92 0A 83 59 3C 21
0060 | AD 38 18 B8 54 27 00 B5 2C CD 68 94 37 F6 63 A5
0070 | F6 96 AE 93 DC F4 D3 AB 28 87 5A 50 35 D5 EB 7D
0080 | 70 EF 5C DF 2D 1C 40 4A 08 42 B7 13 DB 40 59 14
0090 | 58 13 1A F1 9B 71 3B AC 5A 40 3B B9 92 60 E7 80
00A0 | 57 F2 63 39 6A 6B E9 EF 44 77 59 A2 E4 58 40 8F
00B0 | BF 6D A3 81 1D 72 D3 8A 15 89 85 EF 49 E3 26 45
00C0 | AD E0 2A 32 FE BB B4 BD 3A 4C BD 5F 40 FF 4F 2C
00D0 | 08 81 99 0A 3B E0 DB DA D6 46 8B D7 6C 73 F3 C2
00E0 | 11 C2 14 BF 46 5D A7 39 E8 59 DE 79 42 62 24 4D
00F0 | 36 45 F6 E1 72 86 68 1F 67 E6 CF 8C 94 AD C8 A7
0100 | AC 24 04 C6 9A 50 25 0C 84 5D 58 0A B7 0C 11 CC
0110 | 1B 76 74 19 11 D6 9A C8 B5 BE B2 16 8E 87 8A 1D
0120 | D8 98 4D CF 1B 4B BF 96 8A 06 63 1A 0F 92 A1 05
0130 | B6 10 4A 5C B4 7F 3E 1E 6E 47 26 2E AA 69 D0 59
0140 | BF CB 94 31 2F CE 87 11 2D 4C 71 B5 58 CA 22 B9
0150 | FD 6C A2 FD E3 04 E5 52 FD 9A BA 58 A2 05 28 D9
0160 | 0B 5B 47 32 51 A9 24 37 DC 37 BA 9F 3B E8 27 2F
0170 | 04 77 E3 99 43 89 E9 9B 94 CB 95 EB 3D 36 45 B0
0180 | E5 CE 52 98 2F 5E E2 10 A9 55 5A C5 8C B5 2A 6E
0190 | AB CA 69 93 B9 6E FE 93 BD CD 58 4B 77 56 F4 F5
01A0 | BA F9 97 FD DB 40 86 9C 18 27 CD 8E 9D EE 19 19
01B0 | CB 01 D5 30 65 D5 49 FC A1 BF 46 78 D3 FB 90 C3
01C0 | BE CA 0E 00 A8 A0 6B 19 4F 0C EF F5 35 2B 21 F6
01D0 | 99 EB 43 10 F2 EE 53 1B EA 04 57 8D 68 D1 28 83
01E0 | 47 FB 79 DC E4 48 A7 5C 7F D7 0A 02 DD 12 D6 65
01F0 | 1C 61 84 96 7C 63 4B 57 00 5E 65 A0 FD B4 E3 61
0200 | C1 CF 79 AA 65 CD 15 F8 AD DA D6 48 89 66 78 7E
0210 | 57 A1 D8 B2 46 7C 86 4E 25 48 F0 09 97 8D 0A 56
0220 | 45 97 75 B7 70 C7 E9 35 C0 71 72 F1 9B 6E 06 1A
0230 | 1B 15 23 E4 FB 22 A8 24 EE 1F 81 16 73 39 59 32
0240 | 3D FA 87 DD 3E 6D 8B 5D 36 C5 56 30 B2 EB 18 2A
0250 | BB DB 5E A2 13 CB 75 B6 89 08 2A 32 68 AB 83 F7
0260 | 7E E4 F8 B7 8B 2A 64 DA 58 74 F8 5D BC CC 24 54
0270 | FF 99 E9 02 F4 93 52 1D 74 4F 73 B1 CA A2 39 2D
0280 | 77 45 6C 47 5B C1 BF 1D AA 34 80 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014CD313E08D3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>E8020000</code> (744 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200CE428F682406CE02FF2311D3</code> <code>B1B47613643F0BEF7CB8F1096751CC87</code> <code>09C3920A83593C21AD3818B8542700B5</code> <code>2CCD689437F663A5F696AE93DCF4D3AB</code> <code>28875A5035D5EB7D70EF5CDF2D1C404A</code> <code>0842B713DB40591458131AF19B713BAC</code> <code>5A403BB99260E78057F263396A6BE9EF</code> <code>447759A2E458408FBF6DA3811D72D38A</code> <code>158985EF49E32645ADE02A32FEBBB4BD</code> <code>3A4CBD5F40FF4F2C0881990A3BE0DBDA</code> <code>D6468BD76C73F3C211C214BF465DA739</code> <code>E859DE794262244D3645F6E17286681F</code> <code>67E6CF8C94ADC8A7AC2404C69A50250C</code> <code>845D580AB70C11CC1B76741911D69AC8</code> <code>B5BEB2168E878A1DD8984DCF1B4BBF96</code> <code>8A06631A0F92A105B6104A5CB47F3E1E</code> <code>6E47262EAA69D059BFCB94312FCE8711</code> <code>2D4C71B558CA22B9FD6CA2FDE304E552</code> <code>FD9ABA58A20528D90B5B473251A92437</code> <code>DC37BA9F3BE8272F0477E3994389E99B</code> <code>94CB95EB3D3645B0E5CE52982F5EE210</code> <code>A9555AC58CB52A6EABCA6993B96EFE93</code> <code>BDCD584B7756F4F5BAF997FDDB40869C</code> <code>1827CD8E9DEE1919CB01D53065D549FC</code> <code>A1BF4678D3FB90C3BECA0E00A8A06B19</code> <code>4F0CEFF5352B21F699EB4310F2EE531B</code> <code>EA04578D68D1288347FB79DCE448A75C</code> <code>7FD70A02DD12D6651C6184967C634B57</code> <code>005E65A0FDB4E361C1CF79AA65CD15F8</code> <code>ADDAD6488966787E57A1D8B2467C864E</code> <code>2548F009978D0A56459775B770C7E935</code> <code>C07172F19B6E061A1B1523E4FB22A824</code> <code>EE1F8116733959323DFA87DD3E6D8B5D</code> <code>36C55630B2EB182ABBDB5EA213CB75B6</code> <code>89082A3268AB83F77EE4F8B78B2A64DA</code> <code>5874F85DBCCC2454FF99E902F493521D</code> <code>744F73B1CAA2392D77456C475BC1BF1D</code><br> <code>AA3480C3</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = CE428F682406CE02FF2311D3B1B47613643F0BEF7CB8F1096751CC8709C3920A83593C21AD3818B8542700B52CCD689437F663A5F696AE93DCF4D3AB28875A5035D5EB7D70EF5CDF2D1C404A0842B713DB40591458131AF19B713BAC5A403BB99260E78057F263396A6BE9EF447759A2E458408FBF6DA3811D72D38A158985EF49E32645ADE02A32FEBBB4BD3A4CBD5F40FF4F2C0881990A3BE0DBDAD6468BD76C73F3C211C214BF465DA739E859DE794262244D3645F6E17286681F67E6CF8C94ADC8A7AC2404C69A50250C845D580AB70C11CC1B76741911D69AC8B5BEB2168E878A1DD8984DCF1B4BBF968A06631A0F92A105B6104A5CB47F3E1E6E47262EAA69D059BFCB94312FCE87112D4C71B558CA22B9FD6CA2FDE304E552FD9ABA58A20528D90B5B473251A92437DC37BA9F3BE8272F0477E3994389E99B94CB95EB3D3645B0E5CE52982F5EE210A9555AC58CB52A6EABCA6993B96EFE93BDCD584B7756F4F5BAF997FDDB40869C1827CD8E9DEE1919CB01D53065D549FCA1BF4678D3FB90C3BECA0E00A8A06B194F0CEFF5352B21F699EB4310F2EE531BEA04578D68D1288347FB79DCE448A75C7FD70A02DD12D6651C6184967C634B57005E65A0FDB4E361C1CF79AA65CD15F8ADDAD6488966787E57A1D8B2467C864E2548F009978D0A56459775B770C7E935C07172F19B6E061A1B1523E4FB22A824EE1F8116733959323DFA87DD3E6D8B5D36C55630B2EB182ABBDB5EA213CB75B689082A3268AB83F77EE4F8B78B2A64DA5874F85DBCCC2454FF99E902F493521D744F73B1CAA2392D77456C475BC1BF1DAA3480C3
tmp_aes_key = 9B0A9698737CF5429E50AB38AF936978254CC052B84309195BFE79E228C04E9B
tmp_aes_iv = 738A8E2BFDEB20A8B1A8D81EF9749E2EA95011E444BA50B5514680E623FA9DB2</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 7617D03F66CCD2859AE556BF8836383FF867C984BA0D89B52D0492CFAFBB648E6610FCCC4EAB76008662FB56736E148FC2F3AA5E2550431003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010067C82B4587789DE213E09E28AD9EE9556821D3049AF7354CAD1E58BDCF6A26DDD4ED0CE939AA7060CF80641D240065549EA6A0B06418E0715C929CD7782C9156DF8B6320ABF9FB9CFE9656E3BDDC0A33EA6A49CE450EEA66E448871505039843535000F3D6AA0B6241B3EF7573546C3A87BB02116A50928AEE7D7C5ECD46FAAC2C5F0CE5762CE84DE1097554651ABAD5898F3464AEADBD722C0E0C99D77BAC7DB4455CC8562EDCA9D5D3FF43CFC39856ADA178B8DAAD15E4C069AAAAAD3618264A6B8C7428C96174A4C1E748B8F95A9AC0D7D598A6CA82293A064CC15DEBD2298365A25946EAD5B6BC20B3A7BDF966FEA1CE06400DDD47E5BEE785536E0E7BB4E08D3A65357854D420ACAAA5
answer = BA0D89B52D0492CFAFBB648E6610FCCC4EAB76008662FB56736E148FC2F3AA5E2550431003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010067C82B4587789DE213E09E28AD9EE9556821D3049AF7354CAD1E58BDCF6A26DDD4ED0CE939AA7060CF80641D240065549EA6A0B06418E0715C929CD7782C9156DF8B6320ABF9FB9CFE9656E3BDDC0A33EA6A49CE450EEA66E448871505039843535000F3D6AA0B6241B3EF7573546C3A87BB02116A50928AEE7D7C5ECD46FAAC2C5F0CE5762CE84DE1097554651ABAD5898F3464AEADBD722C0E0C99D77BAC7DB4455CC8562EDCA9D5D3FF43CFC39856ADA178B8DAAD15E4C069AAAAAD3618264A6B8C7428C96174A4C1E748B8F95A9AC0D7D598A6CA82293A064CC15DEBD2298365A25946EAD5B6BC20B3A7BDF966FEA1CE06400DDD47E5BEE785536E0E7BB4E08D3A65357854D420ACAAA5</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 2D 04 92 CF AF BB 64 8E 66 10 FC CC
0010 | 4E AB 76 00 86 62 FB 56 73 6E 14 8F C2 F3 AA 5E
0020 | 25 50 43 10 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 67 C8 2B 45 87 78 9D E2 13 E0 9E 28 AD 9E E9 55
0140 | 68 21 D3 04 9A F7 35 4C AD 1E 58 BD CF 6A 26 DD
0150 | D4 ED 0C E9 39 AA 70 60 CF 80 64 1D 24 00 65 54
0160 | 9E A6 A0 B0 64 18 E0 71 5C 92 9C D7 78 2C 91 56
0170 | DF 8B 63 20 AB F9 FB 9C FE 96 56 E3 BD DC 0A 33
0180 | EA 6A 49 CE 45 0E EA 66 E4 48 87 15 05 03 98 43
0190 | 53 50 00 F3 D6 AA 0B 62 41 B3 EF 75 73 54 6C 3A
01A0 | 87 BB 02 11 6A 50 92 8A EE 7D 7C 5E CD 46 FA AC
01B0 | 2C 5F 0C E5 76 2C E8 4D E1 09 75 54 65 1A BA D5
01C0 | 89 8F 34 64 AE AD BD 72 2C 0E 0C 99 D7 7B AC 7D
01D0 | B4 45 5C C8 56 2E DC A9 D5 D3 FF 43 CF C3 98 56
01E0 | AD A1 78 B8 DA AD 15 E4 C0 69 AA AA AD 36 18 26
01F0 | 4A 6B 8C 74 28 C9 61 74 A4 C1 E7 48 B8 F9 5A 9A
0200 | C0 D7 D5 98 A6 CA 82 29 3A 06 4C C1 5D EB D2 29
0210 | 83 65 A2 59 46 EA D5 B6 BC 20 B3 A7 BD F9 66 FE
0220 | A1 CE 06 40 0D DD 47 E5 BE E7 85 53 6E 0E 7B B4
0230 | E0 8D 3A 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010067C82B4587789DE213E09E28</code> <code>AD9EE9556821D3049AF7354CAD1E58BD</code> <code>CF6A26DDD4ED0CE939AA7060CF80641D</code> <code>240065549EA6A0B06418E0715C929CD7</code> <code>782C9156DF8B6320ABF9FB9CFE9656E3</code> <code>BDDC0A33EA6A49CE450EEA66E4488715</code> <code>05039843535000F3D6AA0B6241B3EF75</code> <code>73546C3A87BB02116A50928AEE7D7C5E</code> <code>CD46FAAC2C5F0CE5762CE84DE1097554</code> <code>651ABAD5898F3464AEADBD722C0E0C99</code> <code>D77BAC7DB4455CC8562EDCA9D5D3FF43</code> <code>CFC39856ADA178B8DAAD15E4C069AAAA</code> <code>AD3618264A6B8C7428C96174A4C1E748</code> <code>B8F95A9AC0D7D598A6CA82293A064CC1</code> <code>5DEBD2298365A25946EAD5B6BC20B3A7</code> <code>BDF966FEA1CE06400DDD47E5BEE78553</code><br> <code>6E0E7BB4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E08D3A65</code> (1698336224 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 83D935CAE2A3A54F793F542982BA9C01B3091AA9C2A39A26760CEED0BB1189AEAC2797226D32AD6FD0ACBB163F4999E5F94283EA7F4C3CBEB5BC808AFBE758CF10AE8EB73B063FF304D4A44CC72978F1813E0CB5F4DFFC6CA880880457F338F036624235F7A6D4833B1AB8E157C5E9A22AFD0D5B8DC676BB027827AED85DD3BEB6066DD938B9831AA5BC40538F870A413FDF11126D48B1B2EAF65A9B82E6D518D614A3A80ADBABD99E6EE19AB0D607CCBB1237941CCC91FAA70C240B7353EFE32F9183182E59BAF95CECDA0AFCF49228BB72ABE415F69603929EF6CB00BC1A07288962EEEDD587308353A5D2DD3A3DCB2BB5FEF1F8F70658A1FC6A7BB062D045</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 3758BB479739F3C8C9C7D199984B39A93D52E97758C9F4FB6BC946F11EFB45C7695044179C82B5F9C17DC1E103B2596593BB1A247ACF47CC7F9EC79E326B8E49CD67A4FE606C72D51CC8F0BAE8882B0A8A6D97D18520239104FA5BD6222EDD5A6C7F0DE8002C7610C0F0E83DD83A136CE6A9DD64707C0B50227DEE9C47CFED9EE75D604A82DB58003307FE03EF4C06173ACD29F5D4905AC12EB129C4CF0E1B45E18CB2FC55629BF5535738ECF67BFF5590854DC11B53C5511657A2122D60904A074C25FBF687FEC35A859E44A87A95A80DD243E737B2B555B40432537ED7281F6ABDE1B969497ADB2CCBA56590B9B93D8DD78508E08C144012D45AB86D1DEFA1</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 2D 04 92 CF AF BB 64 8E 66 10 FC CC
0010 | 4E AB 76 00 86 62 FB 56 73 6E 14 8F C2 F3 AA 5E
0020 | 25 50 43 10 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 37 58 BB 47 97 39 F3 C8 C9 C7 D1 99 98 4B 39 A9
0040 | 3D 52 E9 77 58 C9 F4 FB 6B C9 46 F1 1E FB 45 C7
0050 | 69 50 44 17 9C 82 B5 F9 C1 7D C1 E1 03 B2 59 65
0060 | 93 BB 1A 24 7A CF 47 CC 7F 9E C7 9E 32 6B 8E 49
0070 | CD 67 A4 FE 60 6C 72 D5 1C C8 F0 BA E8 88 2B 0A
0080 | 8A 6D 97 D1 85 20 23 91 04 FA 5B D6 22 2E DD 5A
0090 | 6C 7F 0D E8 00 2C 76 10 C0 F0 E8 3D D8 3A 13 6C
00A0 | E6 A9 DD 64 70 7C 0B 50 22 7D EE 9C 47 CF ED 9E
00B0 | E7 5D 60 4A 82 DB 58 00 33 07 FE 03 EF 4C 06 17
00C0 | 3A CD 29 F5 D4 90 5A C1 2E B1 29 C4 CF 0E 1B 45
00D0 | E1 8C B2 FC 55 62 9B F5 53 57 38 EC F6 7B FF 55
00E0 | 90 85 4D C1 1B 53 C5 51 16 57 A2 12 2D 60 90 4A
00F0 | 07 4C 25 FB F6 87 FE C3 5A 85 9E 44 A8 7A 95 A8
0100 | 0D D2 43 E7 37 B2 B5 55 B4 04 32 53 7E D7 28 1F
0110 | 6A BD E1 B9 69 49 7A DB 2C CB A5 65 90 B9 B9 3D
0120 | 8D D7 85 08 E0 8C 14 40 12 D4 5A B8 6D 1D EF A1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001003758BB479739F3C8C9C7D199</code> <code>984B39A93D52E97758C9F4FB6BC946F1</code> <code>1EFB45C7695044179C82B5F9C17DC1E1</code> <code>03B2596593BB1A247ACF47CC7F9EC79E</code> <code>326B8E49CD67A4FE606C72D51CC8F0BA</code> <code>E8882B0A8A6D97D18520239104FA5BD6</code> <code>222EDD5A6C7F0DE8002C7610C0F0E83D</code> <code>D83A136CE6A9DD64707C0B50227DEE9C</code> <code>47CFED9EE75D604A82DB58003307FE03</code> <code>EF4C06173ACD29F5D4905AC12EB129C4</code> <code>CF0E1B45E18CB2FC55629BF5535738EC</code> <code>F67BFF5590854DC11B53C5511657A212</code> <code>2D60904A074C25FBF687FEC35A859E44</code> <code>A87A95A80DD243E737B2B555B4043253</code> <code>7ED7281F6ABDE1B969497ADB2CCBA565</code> <code>90B9B93D8DD78508E08C144012D45AB8</code><br> <code>6D1DEFA1</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643662D0492CFAFBB648E6610FCCC4EAB76008662FB56736E148FC2F3AA5E255043100000000000000000FE0001003758BB479739F3C8C9C7D199984B39A93D52E97758C9F4FB6BC946F11EFB45C7695044179C82B5F9C17DC1E103B2596593BB1A247ACF47CC7F9EC79E326B8E49CD67A4FE606C72D51CC8F0BAE8882B0A8A6D97D18520239104FA5BD6222EDD5A6C7F0DE8002C7610C0F0E83DD83A136CE6A9DD64707C0B50227DEE9C47CFED9EE75D604A82DB58003307FE03EF4C06173ACD29F5D4905AC12EB129C4CF0E1B45E18CB2FC55629BF5535738ECF67BFF5590854DC11B53C5511657A2122D60904A074C25FBF687FEC35A859E44A87A95A80DD243E737B2B555B40432537ED7281F6ABDE1B969497ADB2CCBA56590B9B93D8DD78508E08C144012D45AB86D1DEFA1
padding = A82EEC561D7DF357D108A428
tmp_aes_key = 9B0A9698737CF5429E50AB38AF936978254CC052B84309195BFE79E228C04E9B
tmp_aes_iv = 738A8E2BFDEB20A8B1A8D81EF9749E2EA95011E444BA50B5514680E623FA9DB2</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 5379E076E9DC485EFBFB658DE640B165665A705709E4A0EBB890761544330F1C7700626DA244244D8A1E75741D9716055A016F5C83DACF597AD36C156BCE0CB7DB6F28EA787213A2B91BAFCFD12371520602D786F8CBEAC34E40A7BB413C6F6CBCD1EAC59104534FD888C640D6B553B7C63FE88551512066D53B417BE7BE6A85B147958089B9EABE6EC03391F7C2AC85DCE79BFB27A7F382582FF8C5A8C27BD1B14A857754A09854236F153CBF9B8B2B1B88AC43062C5B2047EE1815D4D606CB5721D75A94E19131BD81AB8F2FB57FC3AA2014C250D0CE5E64ACA2397DFA7512FB69A5CDC5C0BB8BDE5A4F0588D31D299CB8F9DAAA423A149FE310466BAD6387ED9AE78B0841F17C704CE40D002F121AA012DEF67746A5177FC0B2BD68A6FE453B1B0E137EADB104D2F3E234869BAD4E912A22DF3D2A5D4253B67B5CB98B306DF5A86EC064622B25753AFBE7C3DC998F</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC 08 05 00 E3 8D 3A 65
0010 | 78 01 00 00 1F 5F 04 F5 2D 04 92 CF AF BB 64 8E
0020 | 66 10 FC CC 4E AB 76 00 86 62 FB 56 73 6E 14 8F
0030 | C2 F3 AA 5E 25 50 43 10 FE 50 01 00 53 79 E0 76
0040 | E9 DC 48 5E FB FB 65 8D E6 40 B1 65 66 5A 70 57
0050 | 09 E4 A0 EB B8 90 76 15 44 33 0F 1C 77 00 62 6D
0060 | A2 44 24 4D 8A 1E 75 74 1D 97 16 05 5A 01 6F 5C
0070 | 83 DA CF 59 7A D3 6C 15 6B CE 0C B7 DB 6F 28 EA
0080 | 78 72 13 A2 B9 1B AF CF D1 23 71 52 06 02 D7 86
0090 | F8 CB EA C3 4E 40 A7 BB 41 3C 6F 6C BC D1 EA C5
00A0 | 91 04 53 4F D8 88 C6 40 D6 B5 53 B7 C6 3F E8 85
00B0 | 51 51 20 66 D5 3B 41 7B E7 BE 6A 85 B1 47 95 80
00C0 | 89 B9 EA BE 6E C0 33 91 F7 C2 AC 85 DC E7 9B FB
00D0 | 27 A7 F3 82 58 2F F8 C5 A8 C2 7B D1 B1 4A 85 77
00E0 | 54 A0 98 54 23 6F 15 3C BF 9B 8B 2B 1B 88 AC 43
00F0 | 06 2C 5B 20 47 EE 18 15 D4 D6 06 CB 57 21 D7 5A
0100 | 94 E1 91 31 BD 81 AB 8F 2F B5 7F C3 AA 20 14 C2
0110 | 50 D0 CE 5E 64 AC A2 39 7D FA 75 12 FB 69 A5 CD
0120 | C5 C0 BB 8B DE 5A 4F 05 88 D3 1D 29 9C B8 F9 DA
0130 | AA 42 3A 14 9F E3 10 46 6B AD 63 87 ED 9A E7 8B
0140 | 08 41 F1 7C 70 4C E4 0D 00 2F 12 1A A0 12 DE F6
0150 | 77 46 A5 17 7F C0 B2 BD 68 A6 FE 45 3B 1B 0E 13
0160 | 7E AD B1 04 D2 F3 E2 34 86 9B AD 4E 91 2A 22 DF
0170 | 3D 2A 5D 42 53 B6 7B 5C B9 8B 30 6D F5 A8 6E C0
0180 | 64 62 2B 25 75 3A FB E7 C3 DC 99 8F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CC080500E38D3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001005379E076E9DC485EFBFB658D</code> <code>E640B165665A705709E4A0EBB8907615</code> <code>44330F1C7700626DA244244D8A1E7574</code> <code>1D9716055A016F5C83DACF597AD36C15</code> <code>6BCE0CB7DB6F28EA787213A2B91BAFCF</code> <code>D12371520602D786F8CBEAC34E40A7BB</code> <code>413C6F6CBCD1EAC59104534FD888C640</code> <code>D6B553B7C63FE88551512066D53B417B</code> <code>E7BE6A85B147958089B9EABE6EC03391</code> <code>F7C2AC85DCE79BFB27A7F382582FF8C5</code> <code>A8C27BD1B14A857754A09854236F153C</code> <code>BF9B8B2B1B88AC43062C5B2047EE1815</code> <code>D4D606CB5721D75A94E19131BD81AB8F</code> <code>2FB57FC3AA2014C250D0CE5E64ACA239</code> <code>7DFA7512FB69A5CDC5C0BB8BDE5A4F05</code> <code>88D31D299CB8F9DAAA423A149FE31046</code> <code>6BAD6387ED9AE78B0841F17C704CE40D</code> <code>002F121AA012DEF67746A5177FC0B2BD</code> <code>68A6FE453B1B0E137EADB104D2F3E234</code> <code>869BAD4E912A22DF3D2A5D4253B67B5C</code> <code>B98B306DF5A86EC064622B25753AFBE7</code><br> <code>C3DC998F</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 37E92E336A7B2CC876FC8272B890B934522A4FC720B62054E4684DB6E616CD3E7AACB1FA24B8AAA30EE44A58CF62700DB252DDF16245D5E1BC8289CA6BEC2C74C82F1F663C2A7E20A75543FCCCE47F4E66D9C122DB7ECAFBBC3309964B840B81DF6518E1E95448A1D4B0A430A282D244161C8A6FCAC08A0B309C88BC7F77419D65CA07ABFE848A77515E3603612F726A23304BF2AD80E23FAA0E42D7CCC6D3D515266ACF2C75A434FADBF14DEDD1A1CCF4E6A16A8671E983E7DD81E9203446CDA40A37AFF560BA69FF7DC169E9705164DB7276D6BD964F3E75929505230F42F151DD5100EC5841A65B01899B0A9D89C7458287F8AFDC7632A66C5D6DD14B7FF3</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 04 98 68 E0 8D 3A 65
0010 | B0 00 00 00 34 F7 CB 3B 2D 04 92 CF AF BB 64 8E
0020 | 66 10 FC CC 4E AB 76 00 86 62 FB 56 73 6E 14 8F
0030 | C2 F3 AA 5E 25 50 43 10 8C 79 A6 2A 7F 47 5E 10
0040 | CC 36 FB 7E A5 25 28 E3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01049868E08D3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0000000</code> (176 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>2D0492CFAFBB648E6610FCCC4EAB7600</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8662FB56736E148FC2F3AA5E25504310</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>8C79A62A7F475E10CC36FB7EA52528E3</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

