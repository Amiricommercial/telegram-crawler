<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 94 F5 00 00 AF B3 78 65
0010 | 14 00 00 00 F1 8E 7E BE 6F E8 1D BD DA C6 62 6F
0020 | C1 8E 41 56 90 E0 76 80</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>94F50000AFB37865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 C9 42 AF B3 78 65
0010 | 74 00 00 00 63 24 16 05 6F E8 1D BD DA C6 62 6F
0020 | C1 8E 41 56 90 E0 76 80 1E C0 DE B4 07 3E F9 1C
0030 | BA A6 BE D7 12 3C 95 B0 08 19 80 F4 E6 79 52 AB
0040 | 69 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0194C942AFB37865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>74000000</code> (116 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081980F4E67952AB69000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1837737918682278761</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1837737918682278761</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1837737918682278761 = 1032884053 * 1779229637</code></p>
<pre><code>p = 1032884053
q = 1779229637</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 80 F4 E6 79 52 AB 69 00 00 00
0010 | 04 3D 90 8F 55 00 00 00 04 6A 0C E3 C5 00 00 00
0020 | 6F E8 1D BD DA C6 62 6F C1 8E 41 56 90 E0 76 80
0030 | 1E C0 DE B4 07 3E F9 1C BA A6 BE D7 12 3C 95 B0
0040 | 2D E6 3E 15 D1 29 45 59 42 4C ED 43 14 2B 66 52
0050 | 8A 0B 31 E7 AC 60 1B 3E 87 91 A3 DE 7B 5F 05 3C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081980F4E67952AB69000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1837737918682278761</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043D908F55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1032884053</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046A0CE3C5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1779229637</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>2DE63E15D1294559424CED43142B6652</code> <code>8A0B31E7AC601B3E8791A3DE7B5F053C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081980F4E67952AB69000000043D908F55000000046A0CE3C50000006FE81DBDDAC6626FC18E415690E076801EC0DEB4073EF91CBAA6BED7123C95B02DE63E15D1294559424CED43142B66528A0B31E7AC601B3E8791A3DE7B5F053C02000000
random_padding_bytes = B657CB82804DE75AEBD3D3BCFF6B12CBDA7216E22A5FA24054A83A5177AEF303B01AFF5E44E0F266EA451BF7595653269547A0372282D3EF875E45AED3BE1C766C678796388FC4E2D5654972A2265EAC8391A698F7025352C5BC6483</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 048799C4AC7595856CB043A3092E3C12C18C247102D9C4DAF1521D5FB4FC4D20ABA04F6F18F5E1A792725CB48D2043AFAE55B14948FA4BE7DBFFFCBBDC43125A9870EA64682665D24405C5EFECA3B123F4992D81FE86D1289E83FE73FADD0D6811C7FD6D5BB4F9D190DD4512401B1CB73F119466CBFF0B0D981DAA103535244C3EB9A28962337E589E2F283E6C0D493727E38EEF747D22378A56EA8DD60FFF878BBA199907F8C9DD142BD0D8F505F35EED5EDB261EC311CA14BE8F5038AECEB7038E63FE083547BC24528A31661AC0BE81364541562B8D5BB73382CB192783BF8B8DC3AE1152CA22E0CE846D76AD3CA45934EF735738A8DE40865891E739E34B</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 4C 07 09 00 AF B3 78 65
0010 | 40 01 00 00 BE E4 12 D7 6F E8 1D BD DA C6 62 6F
0020 | C1 8E 41 56 90 E0 76 80 1E C0 DE B4 07 3E F9 1C
0030 | BA A6 BE D7 12 3C 95 B0 04 3D 90 8F 55 00 00 00
0040 | 04 6A 0C E3 C5 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 04 87 99 C4 AC 75 95 85 6C B0 43 A3
0060 | 09 2E 3C 12 C1 8C 24 71 02 D9 C4 DA F1 52 1D 5F
0070 | B4 FC 4D 20 AB A0 4F 6F 18 F5 E1 A7 92 72 5C B4
0080 | 8D 20 43 AF AE 55 B1 49 48 FA 4B E7 DB FF FC BB
0090 | DC 43 12 5A 98 70 EA 64 68 26 65 D2 44 05 C5 EF
00A0 | EC A3 B1 23 F4 99 2D 81 FE 86 D1 28 9E 83 FE 73
00B0 | FA DD 0D 68 11 C7 FD 6D 5B B4 F9 D1 90 DD 45 12
00C0 | 40 1B 1C B7 3F 11 94 66 CB FF 0B 0D 98 1D AA 10
00D0 | 35 35 24 4C 3E B9 A2 89 62 33 7E 58 9E 2F 28 3E
00E0 | 6C 0D 49 37 27 E3 8E EF 74 7D 22 37 8A 56 EA 8D
00F0 | D6 0F FF 87 8B BA 19 99 07 F8 C9 DD 14 2B D0 D8
0100 | F5 05 F3 5E ED 5E DB 26 1E C3 11 CA 14 BE 8F 50
0110 | 38 AE CE B7 03 8E 63 FE 08 35 47 BC 24 52 8A 31
0120 | 66 1A C0 BE 81 36 45 41 56 2B 8D 5B B7 33 82 CB
0130 | 19 27 83 BF 8B 8D C3 AE 11 52 CA 22 E0 CE 84 6D
0140 | 76 AD 3C A4 59 34 EF 73 57 38 A8 DE 40 86 58 91
0150 | E7 39 E3 4B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>4C070900AFB37865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043D908F55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1032884053</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046A0CE3C5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1779229637</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100048799C4AC7595856CB043A3</code> <code>092E3C12C18C247102D9C4DAF1521D5F</code> <code>B4FC4D20ABA04F6F18F5E1A792725CB4</code> <code>8D2043AFAE55B14948FA4BE7DBFFFCBB</code> <code>DC43125A9870EA64682665D24405C5EF</code> <code>ECA3B123F4992D81FE86D1289E83FE73</code> <code>FADD0D6811C7FD6D5BB4F9D190DD4512</code> <code>401B1CB73F119466CBFF0B0D981DAA10</code> <code>3535244C3EB9A28962337E589E2F283E</code> <code>6C0D493727E38EEF747D22378A56EA8D</code> <code>D60FFF878BBA199907F8C9DD142BD0D8</code> <code>F505F35EED5EDB261EC311CA14BE8F50</code> <code>38AECEB7038E63FE083547BC24528A31</code> <code>661AC0BE81364541562B8D5BB73382CB</code> <code>192783BF8B8DC3AE1152CA22E0CE846D</code> <code>76AD3CA45934EF735738A8DE40865891</code><br> <code>E739E34B</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 78 8A F2 AF B3 78 65
0010 | D8 02 00 00 5C 07 E8 D0 6F E8 1D BD DA C6 62 6F
0020 | C1 8E 41 56 90 E0 76 80 1E C0 DE B4 07 3E F9 1C
0030 | BA A6 BE D7 12 3C 95 B0 FE 50 02 00 AA CF 4C 3F
0040 | BA 8B 3B 0E C4 EC 9A FE 87 F2 D0 A1 83 1E 1B 41
0050 | 29 C8 F3 8B 2A DF 9C 50 65 6E 93 01 54 86 F3 34
0060 | 35 5A 9F 26 F6 B3 DB 8C 3E F2 75 45 F6 3C 28 63
0070 | D3 12 6D 1E 2F 1C 85 7E C9 5C B7 CC 50 08 74 86
0080 | EB 6D D1 84 0C 10 E7 F3 B7 28 D2 E6 2D FB F0 98
0090 | E2 1B E6 F4 43 80 DD 22 04 3F 7C C3 24 2B AC 89
00A0 | 11 F3 EC 48 DC CC 34 FD 21 45 B3 C9 9B 12 50 67
00B0 | CF DB 36 EA 4B F8 C1 AD 3D 50 C8 35 5A B7 9F D7
00C0 | 38 E9 0B 98 F7 A0 22 2C 4D 38 C7 5E 77 46 0B DD
00D0 | 99 7F E7 D4 7A 5B 33 01 A3 23 98 49 A9 53 51 14
00E0 | 70 DF D2 70 E8 1B 7A D4 03 47 7D 2D 5C 4F ED 8C
00F0 | 66 B0 0A 69 A7 F3 BD 64 5F 61 40 FF 89 7D 40 03
0100 | 7E 0C 9D 14 D5 93 91 05 33 E5 24 5D 4F 36 EB D8
0110 | E4 04 23 87 43 A9 A0 15 E9 F6 AA 39 AD 6E 4B A7
0120 | F6 54 1F CA 4D 17 77 BB F5 94 3C 75 93 03 3C BB
0130 | 68 5E 5F 1C DF 23 53 25 C7 E3 64 D9 51 1C C8 54
0140 | 58 39 F3 7E F0 D6 F3 33 A1 9D DC 28 71 60 B7 6D
0150 | 1B 30 7A 3B 85 C3 4B 4D 1F 0E 2D 57 46 80 8F C8
0160 | D2 6B A3 90 5B A5 43 56 26 E1 38 FB 06 7C D5 50
0170 | 7D 6F D4 39 5E D0 41 9C 8B 5B 34 CD 53 85 DA 6C
0180 | C6 0A 35 09 3D 47 F3 59 16 03 33 A5 25 91 1E 52
0190 | F3 3F DA 10 08 5A B2 81 1C 67 47 C5 AD 5A 47 59
01A0 | 32 D8 A1 E6 0B 10 46 7D 35 59 00 B5 31 5D 68 00
01B0 | 3E 0A FE FE 0F E7 BC B3 22 D7 CF 70 F8 3A 60 2F
01C0 | 48 12 1F 91 69 B9 CF EE 93 A7 67 C6 7B B2 7F 8F
01D0 | AE 17 D9 1C 81 3E E1 46 1A D1 04 F3 48 4F DA D8
01E0 | 13 DF D5 E4 1B 98 8B 64 0F 3F 33 C1 89 AA B1 C3
01F0 | C1 61 71 9B 9B 33 72 23 D8 86 46 BF 1C 4E 2E A4
0200 | B5 EF ED DA 96 63 24 DB E1 C4 D6 11 DF 29 38 80
0210 | 76 CC 3B C3 C6 2F E6 DE A7 EF 00 83 81 BF 8B B1
0220 | E4 AB 43 BB 73 9B FC 69 D6 A0 77 A2 56 27 96 8C
0230 | CC 6E 7F 38 09 57 94 CF 88 36 3A 65 C5 9E 94 AB
0240 | D8 AE 77 7C 1F 36 F3 9B 25 21 01 EE 37 03 62 EF
0250 | CB A2 F6 DB FF F7 C6 5E D7 5B 0E A1 A2 DB 3B 64
0260 | 06 9F 77 60 E8 45 44 1F 54 11 9C 1B 27 22 9F 63
0270 | B5 CB F8 6B B5 92 61 06 70 56 84 3A CF EE 21 A1
0280 | 24 74 E5 3C 6E 0E 08 2A 59 BB AA F2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01788AF2AFB37865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>D8020000</code> (728 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200AACF4C3FBA8B3B0EC4EC9AFE</code> <code>87F2D0A1831E1B4129C8F38B2ADF9C50</code> <code>656E93015486F334355A9F26F6B3DB8C</code> <code>3EF27545F63C2863D3126D1E2F1C857E</code> <code>C95CB7CC50087486EB6DD1840C10E7F3</code> <code>B728D2E62DFBF098E21BE6F44380DD22</code> <code>043F7CC3242BAC8911F3EC48DCCC34FD</code> <code>2145B3C99B125067CFDB36EA4BF8C1AD</code> <code>3D50C8355AB79FD738E90B98F7A0222C</code> <code>4D38C75E77460BDD997FE7D47A5B3301</code> <code>A3239849A953511470DFD270E81B7AD4</code> <code>03477D2D5C4FED8C66B00A69A7F3BD64</code> <code>5F6140FF897D40037E0C9D14D5939105</code> <code>33E5245D4F36EBD8E404238743A9A015</code> <code>E9F6AA39AD6E4BA7F6541FCA4D1777BB</code> <code>F5943C7593033CBB685E5F1CDF235325</code> <code>C7E364D9511CC8545839F37EF0D6F333</code> <code>A19DDC287160B76D1B307A3B85C34B4D</code> <code>1F0E2D5746808FC8D26BA3905BA54356</code> <code>26E138FB067CD5507D6FD4395ED0419C</code> <code>8B5B34CD5385DA6CC60A35093D47F359</code> <code>160333A525911E52F33FDA10085AB281</code> <code>1C6747C5AD5A475932D8A1E60B10467D</code> <code>355900B5315D68003E0AFEFE0FE7BCB3</code> <code>22D7CF70F83A602F48121F9169B9CFEE</code> <code>93A767C67BB27F8FAE17D91C813EE146</code> <code>1AD104F3484FDAD813DFD5E41B988B64</code> <code>0F3F33C189AAB1C3C161719B9B337223</code> <code>D88646BF1C4E2EA4B5EFEDDA966324DB</code> <code>E1C4D611DF29388076CC3BC3C62FE6DE</code> <code>A7EF008381BF8BB1E4AB43BB739BFC69</code> <code>D6A077A25627968CCC6E7F38095794CF</code> <code>88363A65C59E94ABD8AE777C1F36F39B</code> <code>252101EE370362EFCBA2F6DBFFF7C65E</code> <code>D75B0EA1A2DB3B64069F7760E845441F</code> <code>54119C1B27229F63B5CBF86BB5926106</code> <code>7056843ACFEE21A12474E53C6E0E082A</code><br> <code>59BBAAF2</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = AACF4C3FBA8B3B0EC4EC9AFE87F2D0A1831E1B4129C8F38B2ADF9C50656E93015486F334355A9F26F6B3DB8C3EF27545F63C2863D3126D1E2F1C857EC95CB7CC50087486EB6DD1840C10E7F3B728D2E62DFBF098E21BE6F44380DD22043F7CC3242BAC8911F3EC48DCCC34FD2145B3C99B125067CFDB36EA4BF8C1AD3D50C8355AB79FD738E90B98F7A0222C4D38C75E77460BDD997FE7D47A5B3301A3239849A953511470DFD270E81B7AD403477D2D5C4FED8C66B00A69A7F3BD645F6140FF897D40037E0C9D14D593910533E5245D4F36EBD8E404238743A9A015E9F6AA39AD6E4BA7F6541FCA4D1777BBF5943C7593033CBB685E5F1CDF235325C7E364D9511CC8545839F37EF0D6F333A19DDC287160B76D1B307A3B85C34B4D1F0E2D5746808FC8D26BA3905BA5435626E138FB067CD5507D6FD4395ED0419C8B5B34CD5385DA6CC60A35093D47F359160333A525911E52F33FDA10085AB2811C6747C5AD5A475932D8A1E60B10467D355900B5315D68003E0AFEFE0FE7BCB322D7CF70F83A602F48121F9169B9CFEE93A767C67BB27F8FAE17D91C813EE1461AD104F3484FDAD813DFD5E41B988B640F3F33C189AAB1C3C161719B9B337223D88646BF1C4E2EA4B5EFEDDA966324DBE1C4D611DF29388076CC3BC3C62FE6DEA7EF008381BF8BB1E4AB43BB739BFC69D6A077A25627968CCC6E7F38095794CF88363A65C59E94ABD8AE777C1F36F39B252101EE370362EFCBA2F6DBFFF7C65ED75B0EA1A2DB3B64069F7760E845441F54119C1B27229F63B5CBF86BB59261067056843ACFEE21A12474E53C6E0E082A59BBAAF2
tmp_aes_key = A7BAE872D171E4221E338E2CEEE4ED7FE283DBAFB5C2AC2F5D45C4346ED11604
tmp_aes_iv = 293025CCC9576AB027A6F0F77FDAF40709A19A8BF28215831FFF83E42DE63E15</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1ECCD752980F14790949011EE637A8DC4053C72DBA0D89B56FE81DBDDAC6626FC18E415690E076801EC0DEB4073EF91CBAA6BED7123C95B003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010020A42F3268BA3136F8E19D2524AEF90905BC7097582855408170E4113F9F82EA5DD1704A11279C9505186EC2D0B6B9630183F318C978266F2E79D36C759E76958228193152B745F183E30DEAE3D8A6E39C2B0AD688D86C16F9F7D27862075ADD16BFB3000E3CA49DD95CCD72A8ECE2AB7B3138A530FBF35CCF318EAF0D7EBA8D2622E2484DB4E9D08D885C3832E5C49484531DEDB141AD107460C3FE8B345837002D59BA76242039E41987C4FCA446EA606B451731581FE10098285B298DD250CF0604F1982EEED75CD514FB3F36DE159FE2EB5E4006EAC0493E96BA8AE816476F771EF4AAC55D3D02E1F97DFD4016873C0C407692558EE0A56DEF2A186BF35FAFB37865D4CA936D6593D061
answer = BA0D89B56FE81DBDDAC6626FC18E415690E076801EC0DEB4073EF91CBAA6BED7123C95B003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010020A42F3268BA3136F8E19D2524AEF90905BC7097582855408170E4113F9F82EA5DD1704A11279C9505186EC2D0B6B9630183F318C978266F2E79D36C759E76958228193152B745F183E30DEAE3D8A6E39C2B0AD688D86C16F9F7D27862075ADD16BFB3000E3CA49DD95CCD72A8ECE2AB7B3138A530FBF35CCF318EAF0D7EBA8D2622E2484DB4E9D08D885C3832E5C49484531DEDB141AD107460C3FE8B345837002D59BA76242039E41987C4FCA446EA606B451731581FE10098285B298DD250CF0604F1982EEED75CD514FB3F36DE159FE2EB5E4006EAC0493E96BA8AE816476F771EF4AAC55D3D02E1F97DFD4016873C0C407692558EE0A56DEF2A186BF35FAFB37865D4CA936D6593D061</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 6F E8 1D BD DA C6 62 6F C1 8E 41 56
0010 | 90 E0 76 80 1E C0 DE B4 07 3E F9 1C BA A6 BE D7
0020 | 12 3C 95 B0 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 20 A4 2F 32 68 BA 31 36 F8 E1 9D 25 24 AE F9 09
0140 | 05 BC 70 97 58 28 55 40 81 70 E4 11 3F 9F 82 EA
0150 | 5D D1 70 4A 11 27 9C 95 05 18 6E C2 D0 B6 B9 63
0160 | 01 83 F3 18 C9 78 26 6F 2E 79 D3 6C 75 9E 76 95
0170 | 82 28 19 31 52 B7 45 F1 83 E3 0D EA E3 D8 A6 E3
0180 | 9C 2B 0A D6 88 D8 6C 16 F9 F7 D2 78 62 07 5A DD
0190 | 16 BF B3 00 0E 3C A4 9D D9 5C CD 72 A8 EC E2 AB
01A0 | 7B 31 38 A5 30 FB F3 5C CF 31 8E AF 0D 7E BA 8D
01B0 | 26 22 E2 48 4D B4 E9 D0 8D 88 5C 38 32 E5 C4 94
01C0 | 84 53 1D ED B1 41 AD 10 74 60 C3 FE 8B 34 58 37
01D0 | 00 2D 59 BA 76 24 20 39 E4 19 87 C4 FC A4 46 EA
01E0 | 60 6B 45 17 31 58 1F E1 00 98 28 5B 29 8D D2 50
01F0 | CF 06 04 F1 98 2E EE D7 5C D5 14 FB 3F 36 DE 15
0200 | 9F E2 EB 5E 40 06 EA C0 49 3E 96 BA 8A E8 16 47
0210 | 6F 77 1E F4 AA C5 5D 3D 02 E1 F9 7D FD 40 16 87
0220 | 3C 0C 40 76 92 55 8E E0 A5 6D EF 2A 18 6B F3 5F
0230 | AF B3 78 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010020A42F3268BA3136F8E19D25</code> <code>24AEF90905BC7097582855408170E411</code> <code>3F9F82EA5DD1704A11279C9505186EC2</code> <code>D0B6B9630183F318C978266F2E79D36C</code> <code>759E76958228193152B745F183E30DEA</code> <code>E3D8A6E39C2B0AD688D86C16F9F7D278</code> <code>62075ADD16BFB3000E3CA49DD95CCD72</code> <code>A8ECE2AB7B3138A530FBF35CCF318EAF</code> <code>0D7EBA8D2622E2484DB4E9D08D885C38</code> <code>32E5C49484531DEDB141AD107460C3FE</code> <code>8B345837002D59BA76242039E41987C4</code> <code>FCA446EA606B451731581FE10098285B</code> <code>298DD250CF0604F1982EEED75CD514FB</code> <code>3F36DE159FE2EB5E4006EAC0493E96BA</code> <code>8AE816476F771EF4AAC55D3D02E1F97D</code> <code>FD4016873C0C407692558EE0A56DEF2A</code><br> <code>186BF35F</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>AFB37865</code> (1702409135 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 5D5615680F343505009F03052CA06904AADB5BBC42B9405698DC399CA0A0654F4FF8906FE7C2B176203EA19F31342BC2DD5D697471ABD126179B2AB10BD8B7B8B81E3B2A8694450D6DBF7F7E98D112CE3226B4AC54D6062CCA3F960CC673375BD46DFE8315043421A8DEAFFEFA5A221FD5501B5EE747C0468AC2F7FCE57F550451B150D1ADFB96D7D537DAEA087965208BD178B38E4B7FD2CEF52F593997657E436C502E09FDB16A5B325036FD3600B297271E7C15516C1BBFA5CB7A7B16DCA2B2447079A1F39BC95DF87676FA1307835A91350C6BCBA83D3DA2BC5C4FFEA66875B6DAB9719EF7E2ABE6761CE4EB8ED256B7833703FA3061E2F107E21974F8D0</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 71171AF934ABD6DC248E06DAE32C618D9023A927832FB6AB50CFE8E9B6DA46796096E47573C79A159D1EA1A48CC595D2EE1234CB5409D2632CE23A2FACAE2816A1C3D4C939734D24749A45877081A18B6851585F9CB9DC26C2FEE4FC1E8D324B0700893A81CB0DDB8A1C26E6127DDEF3E4054E898D0FC9493A283FAFCE31AE19C1D673CF650BB9C17D7287DA011A96D633FF3D1162E3F354E8A191EB153F13E7DEE2B60E96ED27B96253BBC658A40BA6A763EE57B95C027FC2EAE7A4A93EB28C82030060FB0554CF6F502AB4799EDE7790E8B17AC244D89762AD7871EBA54D6884CC66251620FD49A8FC284840073FFF66C37D7F958822D433870E1B78C60B00</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 6F E8 1D BD DA C6 62 6F C1 8E 41 56
0010 | 90 E0 76 80 1E C0 DE B4 07 3E F9 1C BA A6 BE D7
0020 | 12 3C 95 B0 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 71 17 1A F9 34 AB D6 DC 24 8E 06 DA E3 2C 61 8D
0040 | 90 23 A9 27 83 2F B6 AB 50 CF E8 E9 B6 DA 46 79
0050 | 60 96 E4 75 73 C7 9A 15 9D 1E A1 A4 8C C5 95 D2
0060 | EE 12 34 CB 54 09 D2 63 2C E2 3A 2F AC AE 28 16
0070 | A1 C3 D4 C9 39 73 4D 24 74 9A 45 87 70 81 A1 8B
0080 | 68 51 58 5F 9C B9 DC 26 C2 FE E4 FC 1E 8D 32 4B
0090 | 07 00 89 3A 81 CB 0D DB 8A 1C 26 E6 12 7D DE F3
00A0 | E4 05 4E 89 8D 0F C9 49 3A 28 3F AF CE 31 AE 19
00B0 | C1 D6 73 CF 65 0B B9 C1 7D 72 87 DA 01 1A 96 D6
00C0 | 33 FF 3D 11 62 E3 F3 54 E8 A1 91 EB 15 3F 13 E7
00D0 | DE E2 B6 0E 96 ED 27 B9 62 53 BB C6 58 A4 0B A6
00E0 | A7 63 EE 57 B9 5C 02 7F C2 EA E7 A4 A9 3E B2 8C
00F0 | 82 03 00 60 FB 05 54 CF 6F 50 2A B4 79 9E DE 77
0100 | 90 E8 B1 7A C2 44 D8 97 62 AD 78 71 EB A5 4D 68
0110 | 84 CC 66 25 16 20 FD 49 A8 FC 28 48 40 07 3F FF
0120 | 66 C3 7D 7F 95 88 22 D4 33 87 0E 1B 78 C6 0B 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010071171AF934ABD6DC248E06DA</code> <code>E32C618D9023A927832FB6AB50CFE8E9</code> <code>B6DA46796096E47573C79A159D1EA1A4</code> <code>8CC595D2EE1234CB5409D2632CE23A2F</code> <code>ACAE2816A1C3D4C939734D24749A4587</code> <code>7081A18B6851585F9CB9DC26C2FEE4FC</code> <code>1E8D324B0700893A81CB0DDB8A1C26E6</code> <code>127DDEF3E4054E898D0FC9493A283FAF</code> <code>CE31AE19C1D673CF650BB9C17D7287DA</code> <code>011A96D633FF3D1162E3F354E8A191EB</code> <code>153F13E7DEE2B60E96ED27B96253BBC6</code> <code>58A40BA6A763EE57B95C027FC2EAE7A4</code> <code>A93EB28C82030060FB0554CF6F502AB4</code> <code>799EDE7790E8B17AC244D89762AD7871</code> <code>EBA54D6884CC66251620FD49A8FC2848</code> <code>40073FFF66C37D7F958822D433870E1B</code><br> <code>78C60B00</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643666FE81DBDDAC6626FC18E415690E076801EC0DEB4073EF91CBAA6BED7123C95B00000000000000000FE00010071171AF934ABD6DC248E06DAE32C618D9023A927832FB6AB50CFE8E9B6DA46796096E47573C79A159D1EA1A48CC595D2EE1234CB5409D2632CE23A2FACAE2816A1C3D4C939734D24749A45877081A18B6851585F9CB9DC26C2FEE4FC1E8D324B0700893A81CB0DDB8A1C26E6127DDEF3E4054E898D0FC9493A283FAFCE31AE19C1D673CF650BB9C17D7287DA011A96D633FF3D1162E3F354E8A191EB153F13E7DEE2B60E96ED27B96253BBC658A40BA6A763EE57B95C027FC2EAE7A4A93EB28C82030060FB0554CF6F502AB4799EDE7790E8B17AC244D89762AD7871EBA54D6884CC66251620FD49A8FC284840073FFF66C37D7F958822D433870E1B78C60B00
padding = 7215E47027D2CF4AC80B77F5
tmp_aes_key = A7BAE872D171E4221E338E2CEEE4ED7FE283DBAFB5C2AC2F5D45C4346ED11604
tmp_aes_iv = 293025CCC9576AB027A6F0F77FDAF40709A19A8BF28215831FFF83E42DE63E15</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = E340C849B4F3612951CC4B38FC0ACDD0BA2A19211C3D7805DD79B0615026C8C06CD38DDA3038C06A7765052BE7A7A9C16ED1AE60CAB33FDAB632854A5B0109328A8EC5BE2D1B2A6C4827C41836D88B7E6CF483F7F9452AD87E77661F160A57998C4EB6C1CAC8E53C799513A546A11B1423B2EE03FB900A2BDF115257C82E4170B25EC634DB6BB1DDB6A18A5394E2D5A652F0C22F9E945D2055DEF174552D3ACF5714F7FBFEA76E9C241437387844D208E8CB1AC337419C07FFED4BA36592AB806C4F82E742448D73451F7114F2E5BE4CB9EECE49FBA0DF13871A7DBBC007A38C76C4B0BCE4C87D48FA23E93D3796A1F3FE67D3C1709B1DA63A78536F3040322F0CEE4E3C788177F51FE6C0FB32A2C37E0DA1589E32DB964EA56ECD28505C082560CE85C2317E1512BF05C688348759A2E03102F777453FB06F34150F4C8A68567A6F5595726AF07088AD79C9EAFD4245</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 34 6A 0B 00 AF B3 78 65
0010 | 78 01 00 00 1F 5F 04 F5 6F E8 1D BD DA C6 62 6F
0020 | C1 8E 41 56 90 E0 76 80 1E C0 DE B4 07 3E F9 1C
0030 | BA A6 BE D7 12 3C 95 B0 FE 50 01 00 E3 40 C8 49
0040 | B4 F3 61 29 51 CC 4B 38 FC 0A CD D0 BA 2A 19 21
0050 | 1C 3D 78 05 DD 79 B0 61 50 26 C8 C0 6C D3 8D DA
0060 | 30 38 C0 6A 77 65 05 2B E7 A7 A9 C1 6E D1 AE 60
0070 | CA B3 3F DA B6 32 85 4A 5B 01 09 32 8A 8E C5 BE
0080 | 2D 1B 2A 6C 48 27 C4 18 36 D8 8B 7E 6C F4 83 F7
0090 | F9 45 2A D8 7E 77 66 1F 16 0A 57 99 8C 4E B6 C1
00A0 | CA C8 E5 3C 79 95 13 A5 46 A1 1B 14 23 B2 EE 03
00B0 | FB 90 0A 2B DF 11 52 57 C8 2E 41 70 B2 5E C6 34
00C0 | DB 6B B1 DD B6 A1 8A 53 94 E2 D5 A6 52 F0 C2 2F
00D0 | 9E 94 5D 20 55 DE F1 74 55 2D 3A CF 57 14 F7 FB
00E0 | FE A7 6E 9C 24 14 37 38 78 44 D2 08 E8 CB 1A C3
00F0 | 37 41 9C 07 FF ED 4B A3 65 92 AB 80 6C 4F 82 E7
0100 | 42 44 8D 73 45 1F 71 14 F2 E5 BE 4C B9 EE CE 49
0110 | FB A0 DF 13 87 1A 7D BB C0 07 A3 8C 76 C4 B0 BC
0120 | E4 C8 7D 48 FA 23 E9 3D 37 96 A1 F3 FE 67 D3 C1
0130 | 70 9B 1D A6 3A 78 53 6F 30 40 32 2F 0C EE 4E 3C
0140 | 78 81 77 F5 1F E6 C0 FB 32 A2 C3 7E 0D A1 58 9E
0150 | 32 DB 96 4E A5 6E CD 28 50 5C 08 25 60 CE 85 C2
0160 | 31 7E 15 12 BF 05 C6 88 34 87 59 A2 E0 31 02 F7
0170 | 77 45 3F B0 6F 34 15 0F 4C 8A 68 56 7A 6F 55 95
0180 | 72 6A F0 70 88 AD 79 C9 EA FD 42 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>346A0B00AFB37865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100E340C849B4F3612951CC4B38</code> <code>FC0ACDD0BA2A19211C3D7805DD79B061</code> <code>5026C8C06CD38DDA3038C06A7765052B</code> <code>E7A7A9C16ED1AE60CAB33FDAB632854A</code> <code>5B0109328A8EC5BE2D1B2A6C4827C418</code> <code>36D88B7E6CF483F7F9452AD87E77661F</code> <code>160A57998C4EB6C1CAC8E53C799513A5</code> <code>46A11B1423B2EE03FB900A2BDF115257</code> <code>C82E4170B25EC634DB6BB1DDB6A18A53</code> <code>94E2D5A652F0C22F9E945D2055DEF174</code> <code>552D3ACF5714F7FBFEA76E9C24143738</code> <code>7844D208E8CB1AC337419C07FFED4BA3</code> <code>6592AB806C4F82E742448D73451F7114</code> <code>F2E5BE4CB9EECE49FBA0DF13871A7DBB</code> <code>C007A38C76C4B0BCE4C87D48FA23E93D</code> <code>3796A1F3FE67D3C1709B1DA63A78536F</code> <code>3040322F0CEE4E3C788177F51FE6C0FB</code> <code>32A2C37E0DA1589E32DB964EA56ECD28</code> <code>505C082560CE85C2317E1512BF05C688</code> <code>348759A2E03102F777453FB06F34150F</code> <code>4C8A68567A6F5595726AF07088AD79C9</code><br> <code>EAFD4245</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 61FB2EA919481794D5E3A843C79BD667CDB0500AA178D78E226B9E1137752A8BB4809D3A6E52B68DCCEACC440247EF05CCF805AFD072B0CD9B55EE95EB8745F6DAF9D9BA5EE60F28212A2C147DF139C9FD69E7BE5BAA331A04EEF1593A1587CBD8B49AC4526C693912021F3573C74FB9CF525A385FC978618C3293BF4DF0E79C2AB9FE39575A715574A359682FC16CCC840C5E43FAD839EDF471A78C1384B072DC2EADEF255120C632E8BC3543D6641AB2FDCD0ECE4389866F820FF3B0A965D774C7CAE579E3605DE9C7D6482D318ADA69CF611772F97A31E402EA59A971E823BC0E0BC82D2C8D69487AC006B219156D8238C9D6FA3DBAD4BF03A705426AF45B</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C 43 44 B0 B3 78 65
0010 | 94 00 00 00 34 F7 CB 3B 6F E8 1D BD DA C6 62 6F
0020 | C1 8E 41 56 90 E0 76 80 1E C0 DE B4 07 3E F9 1C
0030 | BA A6 BE D7 12 3C 95 B0 CA F7 62 81 A6 F2 B3 33
0040 | 97 90 2E AD 01 2E FE 78</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019C4344B0B37865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>94000000</code> (148 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6FE81DBDDAC6626FC18E415690E07680</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1EC0DEB4073EF91CBAA6BED7123C95B0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>CAF76281A6F2B33397902EAD012EFE78</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

