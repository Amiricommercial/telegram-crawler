<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 64 7F 0C 00 B8 90 52 65
0010 | 14 00 00 00 F1 8E 7E BE 26 BD 66 FA AC 98 75 CF
0020 | CE 27 A5 E6 95 9E E5 87</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>647F0C00B8905265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 28 E8 29 B8 90 52 65
0010 | 54 00 00 00 63 24 16 05 26 BD 66 FA AC 98 75 CF
0020 | CE 27 A5 E6 95 9E E5 87 B2 1E 98 5D 3E C9 B7 EC
0030 | D5 D4 83 29 13 BE 69 12 08 17 BE 00 0F E7 15 EC
0040 | C9 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0128E829B8905265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0817BE000FE715ECC9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1710804976748850377</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1710804976748850377</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1710804976748850377 = 1147566131 * 1490811667</code></p>
<pre><code>p = 1147566131
q = 1490811667</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 17 BE 00 0F E7 15 EC C9 00 00 00
0010 | 04 44 66 78 33 00 00 00 04 58 DB FB 13 00 00 00
0020 | 26 BD 66 FA AC 98 75 CF CE 27 A5 E6 95 9E E5 87
0030 | B2 1E 98 5D 3E C9 B7 EC D5 D4 83 29 13 BE 69 12
0040 | D5 E3 E5 8D 12 5A 7D 82 04 FA C5 DF CE 2F 6D 1B
0050 | BB 81 12 0C 8F 48 C9 16 B5 FB 55 EF 10 DA 1E 13
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0817BE000FE715ECC9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1710804976748850377</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0444667833000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1147566131</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0458DBFB13000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1490811667</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>D5E3E58D125A7D8204FAC5DFCE2F6D1B</code> <code>BB81120C8F48C916B5FB55EF10DA1E13</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90817BE000FE715ECC900000004446678330000000458DBFB1300000026BD66FAAC9875CFCE27A5E6959EE587B21E985D3EC9B7ECD5D4832913BE6912D5E3E58D125A7D8204FAC5DFCE2F6D1BBB81120C8F48C916B5FB55EF10DA1E1302000000
random_padding_bytes = 4294371FBDE2286C0BE7C7D2E19DC02EBBB2B7084337D957AE220B9BF9549FA36E5330C5E087DA1865E2334BE0DB8BDCCA8272B1A668A492665C71AE04CBBA6DC95614E8A01B173FF9CB943051B717F02B5786794D45AE92D7B90589</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B2386EF5D858F165C6531D7F4C66DE3724DBB740BCCA82E3FEF64582E4DDD7D637C42793B010600F8D8B880412BA8F09129B3AD20F76659A8932B418C90FC409290A0973821E7004822BD20D8B1DF50C755D6095847F8F79266D96C1D6C6A0D52C871A5F1D5F310A97F71FD211CC6293EA28AE9239BCA18FB51ECF3C950F3467415B35E97CC3CA849275955B63077911E564673955A0E58E0698323F9B9496612911E0D607C3C1AFB174A0B7B6619B969505CEFD45F42705B2439397B572CCEB16B47CD817D67B6C137B079CDFC09AF4FCC53E30DC4B7375FF6E9BA2738DE09B20500D0695084F89EDCC8D689C160ACAAF89AF406DA09AD8BF1765B5CE2B603F</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 68 7F 0C 00 B8 90 52 65
0010 | 40 01 00 00 BE E4 12 D7 26 BD 66 FA AC 98 75 CF
0020 | CE 27 A5 E6 95 9E E5 87 B2 1E 98 5D 3E C9 B7 EC
0030 | D5 D4 83 29 13 BE 69 12 04 44 66 78 33 00 00 00
0040 | 04 58 DB FB 13 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B2 38 6E F5 D8 58 F1 65 C6 53 1D 7F
0060 | 4C 66 DE 37 24 DB B7 40 BC CA 82 E3 FE F6 45 82
0070 | E4 DD D7 D6 37 C4 27 93 B0 10 60 0F 8D 8B 88 04
0080 | 12 BA 8F 09 12 9B 3A D2 0F 76 65 9A 89 32 B4 18
0090 | C9 0F C4 09 29 0A 09 73 82 1E 70 04 82 2B D2 0D
00A0 | 8B 1D F5 0C 75 5D 60 95 84 7F 8F 79 26 6D 96 C1
00B0 | D6 C6 A0 D5 2C 87 1A 5F 1D 5F 31 0A 97 F7 1F D2
00C0 | 11 CC 62 93 EA 28 AE 92 39 BC A1 8F B5 1E CF 3C
00D0 | 95 0F 34 67 41 5B 35 E9 7C C3 CA 84 92 75 95 5B
00E0 | 63 07 79 11 E5 64 67 39 55 A0 E5 8E 06 98 32 3F
00F0 | 9B 94 96 61 29 11 E0 D6 07 C3 C1 AF B1 74 A0 B7
0100 | B6 61 9B 96 95 05 CE FD 45 F4 27 05 B2 43 93 97
0110 | B5 72 CC EB 16 B4 7C D8 17 D6 7B 6C 13 7B 07 9C
0120 | DF C0 9A F4 FC C5 3E 30 DC 4B 73 75 FF 6E 9B A2
0130 | 73 8D E0 9B 20 50 0D 06 95 08 4F 89 ED CC 8D 68
0140 | 9C 16 0A CA AF 89 AF 40 6D A0 9A D8 BF 17 65 B5
0150 | CE 2B 60 3F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>687F0C00B8905265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0444667833000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1147566131</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0458DBFB13000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1490811667</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B2386EF5D858F165C6531D7F</code> <code>4C66DE3724DBB740BCCA82E3FEF64582</code> <code>E4DDD7D637C42793B010600F8D8B8804</code> <code>12BA8F09129B3AD20F76659A8932B418</code> <code>C90FC409290A0973821E7004822BD20D</code> <code>8B1DF50C755D6095847F8F79266D96C1</code> <code>D6C6A0D52C871A5F1D5F310A97F71FD2</code> <code>11CC6293EA28AE9239BCA18FB51ECF3C</code> <code>950F3467415B35E97CC3CA849275955B</code> <code>63077911E564673955A0E58E0698323F</code> <code>9B9496612911E0D607C3C1AFB174A0B7</code> <code>B6619B969505CEFD45F42705B2439397</code> <code>B572CCEB16B47CD817D67B6C137B079C</code> <code>DFC09AF4FCC53E30DC4B7375FF6E9BA2</code> <code>738DE09B20500D0695084F89EDCC8D68</code> <code>9C160ACAAF89AF406DA09AD8BF1765B5</code><br> <code>CE2B603F</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 5C 2C EB B8 90 52 65
0010 | A4 02 00 00 5C 07 E8 D0 26 BD 66 FA AC 98 75 CF
0020 | CE 27 A5 E6 95 9E E5 87 B2 1E 98 5D 3E C9 B7 EC
0030 | D5 D4 83 29 13 BE 69 12 FE 50 02 00 C4 9A 1A 4B
0040 | 9A 7C 7D DA A3 B4 8D B8 B7 9E 2E C0 DE E0 5E 11
0050 | 89 9C 5B BF 70 F4 DC 7B 51 35 29 7B 4E C8 A9 34
0060 | 34 2A 02 D5 00 70 1F 98 32 0C D5 02 3E F2 5A F5
0070 | BB B1 01 32 EE 84 30 37 2B 15 63 AC 68 E1 C5 C8
0080 | 5B C7 25 EB 40 F6 5B 01 0B C4 AE AC C9 FB 14 D2
0090 | 41 EB B4 59 B5 32 64 FC ED B0 7C EF D3 5A 94 2C
00A0 | B1 A8 DB 78 75 EE F3 22 7E 71 14 26 B8 42 5F B9
00B0 | 52 0B E8 ED 2C 22 C6 81 80 1E 12 A5 88 6A 09 99
00C0 | 0A E7 DF 80 07 5A C4 A5 3A 43 42 22 B8 12 0F E0
00D0 | E1 CB 3A DC 32 3B 9F 50 14 4D B3 17 89 B2 DC D9
00E0 | 84 A9 55 5C EA 15 7F 0D 84 A2 B8 E1 65 F1 2C 08
00F0 | E4 8E 8F 50 68 7A 10 5E BB 14 B3 DC E2 33 9E B7
0100 | 70 6E BF 44 A0 42 7D 7A 31 70 E3 D9 63 BE 7B 95
0110 | 3F F5 8A AF A5 E1 0C 7A FC CE 58 9B 3F 38 33 7F
0120 | 1F E0 B2 56 B6 D0 54 61 22 52 00 34 7D EE E3 83
0130 | 86 40 AC BE 66 A6 80 40 71 2C FD F0 43 41 73 41
0140 | AF FA 31 05 9A 46 C1 13 99 1A 3E 24 66 28 02 3D
0150 | 3A C4 0E DD 49 C6 EA 7A A3 CF 84 B4 F3 C1 CC 70
0160 | 7C 5C B3 78 3D 99 78 09 7E D5 4F 8A B3 D6 C2 1D
0170 | 14 97 72 D1 9F BF 37 2D 31 65 7E 70 99 48 F2 8B
0180 | D0 5C A8 10 BA FF 64 EB D7 95 DD 86 E0 15 A8 6F
0190 | A4 D8 AE 7F 41 D7 06 CF 66 0B 2F 91 D3 9A 1E 73
01A0 | F8 A7 5D F3 C8 9D 18 B4 9A D7 1E F5 12 68 BA E0
01B0 | 09 FD D5 D7 F1 A5 DC BC 4D 16 55 9B 32 63 C6 38
01C0 | E4 CE 45 89 7C E3 93 F2 52 CB F2 34 D0 94 C2 97
01D0 | 53 05 26 14 F8 FB 6F A1 36 B4 BB 62 8B 14 A7 2D
01E0 | F1 E3 05 D2 F7 FC AF 35 3E 22 8B 79 C6 08 E8 64
01F0 | 31 8A EB 61 2D 0B 5A DE AD CD 30 C4 15 E1 55 76
0200 | F3 3A 30 A7 19 A9 8D B0 B1 38 A1 0B AD 88 F8 D2
0210 | 03 75 DF 18 D6 78 5F 0A E0 D3 BD 3E 71 55 5F 73
0220 | AC D7 7E 0F E0 07 1E D0 44 55 4E 5C 71 EE 9A 24
0230 | 01 CA 14 39 F3 E6 D2 BC F2 0D 86 C3 23 40 40 CF
0240 | 19 88 67 06 13 D6 66 D6 37 C4 63 4E 8B DF 49 BA
0250 | 0C CE 90 AC 91 53 55 1E 62 35 03 86 49 30 0E D6
0260 | 70 26 2E 47 75 DB 4B D3 6F 10 8D 16 3C 23 04 88
0270 | 81 1E 4E 2F 36 F9 2E 92 90 49 30 4D EA C7 25 9E
0280 | D6 C7 86 84 99 E1 E2 BA F5 BF 6A 34</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015C2CEBB8905265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A4020000</code> (676 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200C49A1A4B9A7C7DDAA3B48DB8</code> <code>B79E2EC0DEE05E11899C5BBF70F4DC7B</code> <code>5135297B4EC8A934342A02D500701F98</code> <code>320CD5023EF25AF5BBB10132EE843037</code> <code>2B1563AC68E1C5C85BC725EB40F65B01</code> <code>0BC4AEACC9FB14D241EBB459B53264FC</code> <code>EDB07CEFD35A942CB1A8DB7875EEF322</code> <code>7E711426B8425FB9520BE8ED2C22C681</code> <code>801E12A5886A09990AE7DF80075AC4A5</code> <code>3A434222B8120FE0E1CB3ADC323B9F50</code> <code>144DB31789B2DCD984A9555CEA157F0D</code> <code>84A2B8E165F12C08E48E8F50687A105E</code> <code>BB14B3DCE2339EB7706EBF44A0427D7A</code> <code>3170E3D963BE7B953FF58AAFA5E10C7A</code> <code>FCCE589B3F38337F1FE0B256B6D05461</code> <code>225200347DEEE3838640ACBE66A68040</code> <code>712CFDF043417341AFFA31059A46C113</code> <code>991A3E246628023D3AC40EDD49C6EA7A</code> <code>A3CF84B4F3C1CC707C5CB3783D997809</code> <code>7ED54F8AB3D6C21D149772D19FBF372D</code> <code>31657E709948F28BD05CA810BAFF64EB</code> <code>D795DD86E015A86FA4D8AE7F41D706CF</code> <code>660B2F91D39A1E73F8A75DF3C89D18B4</code> <code>9AD71EF51268BAE009FDD5D7F1A5DCBC</code> <code>4D16559B3263C638E4CE45897CE393F2</code> <code>52CBF234D094C29753052614F8FB6FA1</code> <code>36B4BB628B14A72DF1E305D2F7FCAF35</code> <code>3E228B79C608E864318AEB612D0B5ADE</code> <code>ADCD30C415E15576F33A30A719A98DB0</code> <code>B138A10BAD88F8D20375DF18D6785F0A</code> <code>E0D3BD3E71555F73ACD77E0FE0071ED0</code> <code>44554E5C71EE9A2401CA1439F3E6D2BC</code> <code>F20D86C3234040CF1988670613D666D6</code> <code>37C4634E8BDF49BA0CCE90AC9153551E</code> <code>6235038649300ED670262E4775DB4BD3</code> <code>6F108D163C230488811E4E2F36F92E92</code> <code>9049304DEAC7259ED6C7868499E1E2BA</code><br> <code>F5BF6A34</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = C49A1A4B9A7C7DDAA3B48DB8B79E2EC0DEE05E11899C5BBF70F4DC7B5135297B4EC8A934342A02D500701F98320CD5023EF25AF5BBB10132EE8430372B1563AC68E1C5C85BC725EB40F65B010BC4AEACC9FB14D241EBB459B53264FCEDB07CEFD35A942CB1A8DB7875EEF3227E711426B8425FB9520BE8ED2C22C681801E12A5886A09990AE7DF80075AC4A53A434222B8120FE0E1CB3ADC323B9F50144DB31789B2DCD984A9555CEA157F0D84A2B8E165F12C08E48E8F50687A105EBB14B3DCE2339EB7706EBF44A0427D7A3170E3D963BE7B953FF58AAFA5E10C7AFCCE589B3F38337F1FE0B256B6D05461225200347DEEE3838640ACBE66A68040712CFDF043417341AFFA31059A46C113991A3E246628023D3AC40EDD49C6EA7AA3CF84B4F3C1CC707C5CB3783D9978097ED54F8AB3D6C21D149772D19FBF372D31657E709948F28BD05CA810BAFF64EBD795DD86E015A86FA4D8AE7F41D706CF660B2F91D39A1E73F8A75DF3C89D18B49AD71EF51268BAE009FDD5D7F1A5DCBC4D16559B3263C638E4CE45897CE393F252CBF234D094C29753052614F8FB6FA136B4BB628B14A72DF1E305D2F7FCAF353E228B79C608E864318AEB612D0B5ADEADCD30C415E15576F33A30A719A98DB0B138A10BAD88F8D20375DF18D6785F0AE0D3BD3E71555F73ACD77E0FE0071ED044554E5C71EE9A2401CA1439F3E6D2BCF20D86C3234040CF1988670613D666D637C4634E8BDF49BA0CCE90AC9153551E6235038649300ED670262E4775DB4BD36F108D163C230488811E4E2F36F92E929049304DEAC7259ED6C7868499E1E2BAF5BF6A34
tmp_aes_key = 50467B2FCB4A132671FAD6A516EE22B77DE5E0D984276C02F0C486AE4CEE52E2
tmp_aes_iv = CDB0881CC08413E78791861E094E1A279D07459F407D4683DC6558D4D5E3E58D</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 230CDAD37181F11AD3684C399ED527B269CB1221BA0D89B526BD66FAAC9875CFCE27A5E6959EE587B21E985D3EC9B7ECD5D4832913BE691203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002BF6F2C80188A19712DFEE1B962274142091C35FA6DD61F3BDF525ACDD5F18B0E1DBCFF01E2A06A6813FE60A0447123375B11275911F82448E0F1A878A3C893B3129A40E4A6AC8C4BA6342FD40F00BC36E0234C70D98C0AD46DE23A3882F2B5846DD20CB6A16C61FF3411DC356A46222DCBFE188720D9F1D3834E313DC2331B10CEF42AD4BFBED3FB7C97DFE1DE36B17E99452947B185575ADCADB76ED7AD49B671D46F475568E7D5B72FFC8222F6A8D8E02D3D77AF64F64EC2B1EF5FB64D02FA56E46AB823CBC295F321E79051F58F6F3E38B4A63559CFEDF91456B37591BD2453A67C82C8214BA160091B8AE07E0A7C7C90533A810E76E58438FB3CFECC4D4B8905265B7AC84D45DF41E91
answer = BA0D89B526BD66FAAC9875CFCE27A5E6959EE587B21E985D3EC9B7ECD5D4832913BE691203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002BF6F2C80188A19712DFEE1B962274142091C35FA6DD61F3BDF525ACDD5F18B0E1DBCFF01E2A06A6813FE60A0447123375B11275911F82448E0F1A878A3C893B3129A40E4A6AC8C4BA6342FD40F00BC36E0234C70D98C0AD46DE23A3882F2B5846DD20CB6A16C61FF3411DC356A46222DCBFE188720D9F1D3834E313DC2331B10CEF42AD4BFBED3FB7C97DFE1DE36B17E99452947B185575ADCADB76ED7AD49B671D46F475568E7D5B72FFC8222F6A8D8E02D3D77AF64F64EC2B1EF5FB64D02FA56E46AB823CBC295F321E79051F58F6F3E38B4A63559CFEDF91456B37591BD2453A67C82C8214BA160091B8AE07E0A7C7C90533A810E76E58438FB3CFECC4D4B8905265B7AC84D45DF41E91</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 26 BD 66 FA AC 98 75 CF CE 27 A5 E6
0010 | 95 9E E5 87 B2 1E 98 5D 3E C9 B7 EC D5 D4 83 29
0020 | 13 BE 69 12 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 2B F6 F2 C8 01 88 A1 97 12 DF EE 1B 96 22 74 14
0140 | 20 91 C3 5F A6 DD 61 F3 BD F5 25 AC DD 5F 18 B0
0150 | E1 DB CF F0 1E 2A 06 A6 81 3F E6 0A 04 47 12 33
0160 | 75 B1 12 75 91 1F 82 44 8E 0F 1A 87 8A 3C 89 3B
0170 | 31 29 A4 0E 4A 6A C8 C4 BA 63 42 FD 40 F0 0B C3
0180 | 6E 02 34 C7 0D 98 C0 AD 46 DE 23 A3 88 2F 2B 58
0190 | 46 DD 20 CB 6A 16 C6 1F F3 41 1D C3 56 A4 62 22
01A0 | DC BF E1 88 72 0D 9F 1D 38 34 E3 13 DC 23 31 B1
01B0 | 0C EF 42 AD 4B FB ED 3F B7 C9 7D FE 1D E3 6B 17
01C0 | E9 94 52 94 7B 18 55 75 AD CA DB 76 ED 7A D4 9B
01D0 | 67 1D 46 F4 75 56 8E 7D 5B 72 FF C8 22 2F 6A 8D
01E0 | 8E 02 D3 D7 7A F6 4F 64 EC 2B 1E F5 FB 64 D0 2F
01F0 | A5 6E 46 AB 82 3C BC 29 5F 32 1E 79 05 1F 58 F6
0200 | F3 E3 8B 4A 63 55 9C FE DF 91 45 6B 37 59 1B D2
0210 | 45 3A 67 C8 2C 82 14 BA 16 00 91 B8 AE 07 E0 A7
0220 | C7 C9 05 33 A8 10 E7 6E 58 43 8F B3 CF EC C4 D4
0230 | B8 90 52 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001002BF6F2C80188A19712DFEE1B</code> <code>962274142091C35FA6DD61F3BDF525AC</code> <code>DD5F18B0E1DBCFF01E2A06A6813FE60A</code> <code>0447123375B11275911F82448E0F1A87</code> <code>8A3C893B3129A40E4A6AC8C4BA6342FD</code> <code>40F00BC36E0234C70D98C0AD46DE23A3</code> <code>882F2B5846DD20CB6A16C61FF3411DC3</code> <code>56A46222DCBFE188720D9F1D3834E313</code> <code>DC2331B10CEF42AD4BFBED3FB7C97DFE</code> <code>1DE36B17E99452947B185575ADCADB76</code> <code>ED7AD49B671D46F475568E7D5B72FFC8</code> <code>222F6A8D8E02D3D77AF64F64EC2B1EF5</code> <code>FB64D02FA56E46AB823CBC295F321E79</code> <code>051F58F6F3E38B4A63559CFEDF91456B</code> <code>37591BD2453A67C82C8214BA160091B8</code> <code>AE07E0A7C7C90533A810E76E58438FB3</code><br> <code>CFECC4D4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B8905265</code> (1699909816 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 40B667AA49BC731928F4D56C0293F550A41772B17B014881E9DBD659B92B3883475A2D46BB1F990CDC24CB20A12B034E011CFC924E7B85763278B70D5CD5CDD8630C3707411ECD5C52628B7819C4608930CB1D7AF3F9AABEBCC2BB31378C2D61C820B3E8EEED18535D4C534B2A63605BBD471BC741D0811803C3077835A6F4A3DE33569B0935DC79E106DC49B26FB16BB23B1B78BE228FDB2517B9D4EBDF3551D0C55F771151D454EF2367C3BE4132F8B7613CC05F00C82483E21FB843FCC935366C9AEBB0B731A433994421580446765409F6358A06E6F826DFFCB04FA5AF579CF8AC3EAB7AA018412F1A7A5761C98C7D4B83845E28D59DD81634593BFC9D3F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 3F705A3D16081D2D5303D14160C241DB036755D0409830E7F78CF64E3B9C4D71F514AE2AFBD5C90FC47A9E3C85C430BC00D8777BB8FA35C84744E2B099D08F65757D743E7FB1A48D17AE7124B90AD7DCECF60A2D63B8A7D39CC22249D5D5036BE48B0A88054DA0DF4DE45F3B658570C5B087FEE1AFEE50C915748C0DABD8E23180082315F06A36328E07598184A94D956ABD0316D3D1234A0337315BA7F0AC51A3ED1E2B3B6FD2737FA8FD014B63CC1D132188C735D044FD5981147EDCE292AC11160A58AC38CF56590AB8EA4C02B3D747BD6E9CDEFAA01438D7B6D0746D56830EE2933F5C3D2354204B9ACE7BCCF9566F894B2BFD514BFA62136D361B86A468</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 26 BD 66 FA AC 98 75 CF CE 27 A5 E6
0010 | 95 9E E5 87 B2 1E 98 5D 3E C9 B7 EC D5 D4 83 29
0020 | 13 BE 69 12 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 3F 70 5A 3D 16 08 1D 2D 53 03 D1 41 60 C2 41 DB
0040 | 03 67 55 D0 40 98 30 E7 F7 8C F6 4E 3B 9C 4D 71
0050 | F5 14 AE 2A FB D5 C9 0F C4 7A 9E 3C 85 C4 30 BC
0060 | 00 D8 77 7B B8 FA 35 C8 47 44 E2 B0 99 D0 8F 65
0070 | 75 7D 74 3E 7F B1 A4 8D 17 AE 71 24 B9 0A D7 DC
0080 | EC F6 0A 2D 63 B8 A7 D3 9C C2 22 49 D5 D5 03 6B
0090 | E4 8B 0A 88 05 4D A0 DF 4D E4 5F 3B 65 85 70 C5
00A0 | B0 87 FE E1 AF EE 50 C9 15 74 8C 0D AB D8 E2 31
00B0 | 80 08 23 15 F0 6A 36 32 8E 07 59 81 84 A9 4D 95
00C0 | 6A BD 03 16 D3 D1 23 4A 03 37 31 5B A7 F0 AC 51
00D0 | A3 ED 1E 2B 3B 6F D2 73 7F A8 FD 01 4B 63 CC 1D
00E0 | 13 21 88 C7 35 D0 44 FD 59 81 14 7E DC E2 92 AC
00F0 | 11 16 0A 58 AC 38 CF 56 59 0A B8 EA 4C 02 B3 D7
0100 | 47 BD 6E 9C DE FA A0 14 38 D7 B6 D0 74 6D 56 83
0110 | 0E E2 93 3F 5C 3D 23 54 20 4B 9A CE 7B CC F9 56
0120 | 6F 89 4B 2B FD 51 4B FA 62 13 6D 36 1B 86 A4 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001003F705A3D16081D2D5303D141</code> <code>60C241DB036755D0409830E7F78CF64E</code> <code>3B9C4D71F514AE2AFBD5C90FC47A9E3C</code> <code>85C430BC00D8777BB8FA35C84744E2B0</code> <code>99D08F65757D743E7FB1A48D17AE7124</code> <code>B90AD7DCECF60A2D63B8A7D39CC22249</code> <code>D5D5036BE48B0A88054DA0DF4DE45F3B</code> <code>658570C5B087FEE1AFEE50C915748C0D</code> <code>ABD8E23180082315F06A36328E075981</code> <code>84A94D956ABD0316D3D1234A0337315B</code> <code>A7F0AC51A3ED1E2B3B6FD2737FA8FD01</code> <code>4B63CC1D132188C735D044FD5981147E</code> <code>DCE292AC11160A58AC38CF56590AB8EA</code> <code>4C02B3D747BD6E9CDEFAA01438D7B6D0</code> <code>746D56830EE2933F5C3D2354204B9ACE</code> <code>7BCCF9566F894B2BFD514BFA62136D36</code><br> <code>1B86A468</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436626BD66FAAC9875CFCE27A5E6959EE587B21E985D3EC9B7ECD5D4832913BE69120000000000000000FE0001003F705A3D16081D2D5303D14160C241DB036755D0409830E7F78CF64E3B9C4D71F514AE2AFBD5C90FC47A9E3C85C430BC00D8777BB8FA35C84744E2B099D08F65757D743E7FB1A48D17AE7124B90AD7DCECF60A2D63B8A7D39CC22249D5D5036BE48B0A88054DA0DF4DE45F3B658570C5B087FEE1AFEE50C915748C0DABD8E23180082315F06A36328E07598184A94D956ABD0316D3D1234A0337315BA7F0AC51A3ED1E2B3B6FD2737FA8FD014B63CC1D132188C735D044FD5981147EDCE292AC11160A58AC38CF56590AB8EA4C02B3D747BD6E9CDEFAA01438D7B6D0746D56830EE2933F5C3D2354204B9ACE7BCCF9566F894B2BFD514BFA62136D361B86A468
padding = F453381991D9D60D2636535B
tmp_aes_key = 50467B2FCB4A132671FAD6A516EE22B77DE5E0D984276C02F0C486AE4CEE52E2
tmp_aes_iv = CDB0881CC08413E78791861E094E1A279D07459F407D4683DC6558D4D5E3E58D</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 18D4986E3CD13B8C752189BF1973C9C65C282CADAFC2AE00B67828E7E68E0BC0145394B83E088A60DC091CE3215E9AE480F28E4ACDD7541D7754BE14E88F7FCF5EB0B0BC467ACBFC2652513637737F789393953C825DC57D7DD01F5366A7E94B374827A3E7742B385E5F6F3DB1AA9D92096A388DF45D1D1BAA96FD18F0D117BEF5EF80E0A9CA376700C841928808A26D7FF82D2DC5FAF3ABDA288ED2F91F54EFDECDDBCFCC326AF365CCFA20EAE06908F5FE99232657B5C11E6565E20E9A30DFA80F05AEA2E2EA072614D870A576A803376F06B09B855E9CC54492D46676B660FDDC05A32C2AA83B992BAE143C10447D246A12D786CD71CC5DB15166AEBAF302B271F3429C592CD9DE0109FAB82DBBA2DA3BB05CCD84BEE607A719158B2A8ECB17A943661EF2DCAEF0BABD58924A57DC4FFEAEEB71D59142567A78214301087ACC21800728D2CEF04380452C5539AED4</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 18 3A 0C 00 B9 90 52 65
0010 | 78 01 00 00 1F 5F 04 F5 26 BD 66 FA AC 98 75 CF
0020 | CE 27 A5 E6 95 9E E5 87 B2 1E 98 5D 3E C9 B7 EC
0030 | D5 D4 83 29 13 BE 69 12 FE 50 01 00 18 D4 98 6E
0040 | 3C D1 3B 8C 75 21 89 BF 19 73 C9 C6 5C 28 2C AD
0050 | AF C2 AE 00 B6 78 28 E7 E6 8E 0B C0 14 53 94 B8
0060 | 3E 08 8A 60 DC 09 1C E3 21 5E 9A E4 80 F2 8E 4A
0070 | CD D7 54 1D 77 54 BE 14 E8 8F 7F CF 5E B0 B0 BC
0080 | 46 7A CB FC 26 52 51 36 37 73 7F 78 93 93 95 3C
0090 | 82 5D C5 7D 7D D0 1F 53 66 A7 E9 4B 37 48 27 A3
00A0 | E7 74 2B 38 5E 5F 6F 3D B1 AA 9D 92 09 6A 38 8D
00B0 | F4 5D 1D 1B AA 96 FD 18 F0 D1 17 BE F5 EF 80 E0
00C0 | A9 CA 37 67 00 C8 41 92 88 08 A2 6D 7F F8 2D 2D
00D0 | C5 FA F3 AB DA 28 8E D2 F9 1F 54 EF DE CD DB CF
00E0 | CC 32 6A F3 65 CC FA 20 EA E0 69 08 F5 FE 99 23
00F0 | 26 57 B5 C1 1E 65 65 E2 0E 9A 30 DF A8 0F 05 AE
0100 | A2 E2 EA 07 26 14 D8 70 A5 76 A8 03 37 6F 06 B0
0110 | 9B 85 5E 9C C5 44 92 D4 66 76 B6 60 FD DC 05 A3
0120 | 2C 2A A8 3B 99 2B AE 14 3C 10 44 7D 24 6A 12 D7
0130 | 86 CD 71 CC 5D B1 51 66 AE BA F3 02 B2 71 F3 42
0140 | 9C 59 2C D9 DE 01 09 FA B8 2D BB A2 DA 3B B0 5C
0150 | CD 84 BE E6 07 A7 19 15 8B 2A 8E CB 17 A9 43 66
0160 | 1E F2 DC AE F0 BA BD 58 92 4A 57 DC 4F FE AE EB
0170 | 71 D5 91 42 56 7A 78 21 43 01 08 7A CC 21 80 07
0180 | 28 D2 CE F0 43 80 45 2C 55 39 AE D4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>183A0C00B9905265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010018D4986E3CD13B8C752189BF</code> <code>1973C9C65C282CADAFC2AE00B67828E7</code> <code>E68E0BC0145394B83E088A60DC091CE3</code> <code>215E9AE480F28E4ACDD7541D7754BE14</code> <code>E88F7FCF5EB0B0BC467ACBFC26525136</code> <code>37737F789393953C825DC57D7DD01F53</code> <code>66A7E94B374827A3E7742B385E5F6F3D</code> <code>B1AA9D92096A388DF45D1D1BAA96FD18</code> <code>F0D117BEF5EF80E0A9CA376700C84192</code> <code>8808A26D7FF82D2DC5FAF3ABDA288ED2</code> <code>F91F54EFDECDDBCFCC326AF365CCFA20</code> <code>EAE06908F5FE99232657B5C11E6565E2</code> <code>0E9A30DFA80F05AEA2E2EA072614D870</code> <code>A576A803376F06B09B855E9CC54492D4</code> <code>6676B660FDDC05A32C2AA83B992BAE14</code> <code>3C10447D246A12D786CD71CC5DB15166</code> <code>AEBAF302B271F3429C592CD9DE0109FA</code> <code>B82DBBA2DA3BB05CCD84BEE607A71915</code> <code>8B2A8ECB17A943661EF2DCAEF0BABD58</code> <code>924A57DC4FFEAEEB71D59142567A7821</code> <code>4301087ACC21800728D2CEF04380452C</code><br> <code>5539AED4</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 933DB694728888FBFFE10255BBDA639C075D20570E9C123BFECBD57D43B34E9B4A69E81E65D5C1C0D77DD1EF229B73BD28CB11B8B963CEB39072C960F7608BCDBDD66B3838B6E04BFE5EBC1AF31563B407053F63EC61B00DF7889E65ACF7610EE1CEA93C15EED67327D123536303E7551BCED1E0D1F670700C9734DB7FAB759317CF53FCBAF872D31C8ED4B86101DFD1B4AE6F6823BB31EE77AD4F2B7BE6C1B89361C8B59938D57C8DCB2E2F5C7E75187D73AE872C38383F7DD2C870F6B5303FE9E519F38A5FA42E94358349EC59A4D9F30A7206A698981505A90561B1C069A32FC646EA08175EB203BDC3DD2A88CB020E80090CF69FCA6FD57E5A30436BC764</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 48 59 45 B9 90 52 65
0010 | 54 00 00 00 34 F7 CB 3B 26 BD 66 FA AC 98 75 CF
0020 | CE 27 A5 E6 95 9E E5 87 B2 1E 98 5D 3E C9 B7 EC
0030 | D5 D4 83 29 13 BE 69 12 42 EB 2B 95 75 30 C2 95
0040 | BC 81 F3 59 99 60 46 85</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01485945B9905265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>26BD66FAAC9875CFCE27A5E6959EE587</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B21E985D3EC9B7ECD5D4832913BE6912</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>42EB2B957530C295BC81F35999604685</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

