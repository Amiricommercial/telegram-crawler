<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 98 08 06 00 98 A2 7C 65
0010 | 14 00 00 00 F1 8E 7E BE B3 E1 D2 FA 3E 92 73 28
0020 | 94 C0 7D AE C7 C7 8E 10</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>9808060098A27C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 27 E7 98 A2 7C 65
0010 | 70 00 00 00 63 24 16 05 B3 E1 D2 FA 3E 92 73 28
0020 | 94 C0 7D AE C7 C7 8E 10 C6 DB 85 F8 40 93 C7 5A
0030 | FE 46 DC 80 3D D1 2C C0 08 19 CD D4 06 35 4D 32
0040 | 8B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015827E798A27C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>70000000</code> (112 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0819CDD406354D328B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1859375344303026827</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1859375344303026827</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1859375344303026827 = 1111389791 * 1673018197</code></p>
<pre><code>p = 1111389791
q = 1673018197</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 CD D4 06 35 4D 32 8B 00 00 00
0010 | 04 42 3E 76 5F 00 00 00 04 63 B8 3B 55 00 00 00
0020 | B3 E1 D2 FA 3E 92 73 28 94 C0 7D AE C7 C7 8E 10
0030 | C6 DB 85 F8 40 93 C7 5A FE 46 DC 80 3D D1 2C C0
0040 | 79 CC 58 58 47 1C FD A6 B4 97 F9 E2 BF 04 0F 49
0050 | 3B 00 12 A9 F2 8F 14 78 FE 58 D6 2E 83 65 98 F8
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0819CDD406354D328B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1859375344303026827</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04423E765F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1111389791</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0463B83B55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1673018197</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>79CC5858471CFDA6B497F9E2BF040F49</code> <code>3B0012A9F28F1478FE58D62E836598F8</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90819CDD406354D328B00000004423E765F0000000463B83B55000000B3E1D2FA3E92732894C07DAEC7C78E10C6DB85F84093C75AFE46DC803DD12CC079CC5858471CFDA6B497F9E2BF040F493B0012A9F28F1478FE58D62E836598F802000000
random_padding_bytes = E7F74A6D71E32CEACFCC8D2EFF77E4E1166730349B66B0E1EF5CC7DDA92BE7CF04ED61C63727BA6C03AA642F432168F37A15CDCD18F6FB8D63DD590F91E372A5ABF39F7127E969F53067113DBE11EF6096BF8FEA696C1789052A57B4</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 91F39BFC3BAEEA8E3319DA8C9CBF6660DFEB69CFB8CF2F3A9B46E93540B622E1D9BB1837F228E1DD5971EFD7361154569FF96E87E3171AECA82F034625DB87D02A9910071C70BD12D09F2129ED7FF1B51F64ED41EAFBACEB73A2AE005E6708DAD8220CC1C0D603A79F6F9E3B1DA51A718C50CE7925E6FCFA9E5DEF35CF6AEE8F36A6EE7DC8E822B4F40D57D5BE138FB2FDEE9FCEF955CA2F8337BF861FE133A2677CC4384B29C13B3BBA3EBC810C592793727B4089A9F9503617401D27C174A0CFF51B56E461DB414F62C95A080D7C970A52BA7AAB88B2517AA08EC6E0CD3604A1D50CB09F37397DCB0ED324267CAC3AEBCB7D9FD5BF1A9B9675CA448930AB5C</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC DB 07 00 99 A2 7C 65
0010 | 40 01 00 00 BE E4 12 D7 B3 E1 D2 FA 3E 92 73 28
0020 | 94 C0 7D AE C7 C7 8E 10 C6 DB 85 F8 40 93 C7 5A
0030 | FE 46 DC 80 3D D1 2C C0 04 42 3E 76 5F 00 00 00
0040 | 04 63 B8 3B 55 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 91 F3 9B FC 3B AE EA 8E 33 19 DA 8C
0060 | 9C BF 66 60 DF EB 69 CF B8 CF 2F 3A 9B 46 E9 35
0070 | 40 B6 22 E1 D9 BB 18 37 F2 28 E1 DD 59 71 EF D7
0080 | 36 11 54 56 9F F9 6E 87 E3 17 1A EC A8 2F 03 46
0090 | 25 DB 87 D0 2A 99 10 07 1C 70 BD 12 D0 9F 21 29
00A0 | ED 7F F1 B5 1F 64 ED 41 EA FB AC EB 73 A2 AE 00
00B0 | 5E 67 08 DA D8 22 0C C1 C0 D6 03 A7 9F 6F 9E 3B
00C0 | 1D A5 1A 71 8C 50 CE 79 25 E6 FC FA 9E 5D EF 35
00D0 | CF 6A EE 8F 36 A6 EE 7D C8 E8 22 B4 F4 0D 57 D5
00E0 | BE 13 8F B2 FD EE 9F CE F9 55 CA 2F 83 37 BF 86
00F0 | 1F E1 33 A2 67 7C C4 38 4B 29 C1 3B 3B BA 3E BC
0100 | 81 0C 59 27 93 72 7B 40 89 A9 F9 50 36 17 40 1D
0110 | 27 C1 74 A0 CF F5 1B 56 E4 61 DB 41 4F 62 C9 5A
0120 | 08 0D 7C 97 0A 52 BA 7A AB 88 B2 51 7A A0 8E C6
0130 | E0 CD 36 04 A1 D5 0C B0 9F 37 39 7D CB 0E D3 24
0140 | 26 7C AC 3A EB CB 7D 9F D5 BF 1A 9B 96 75 CA 44
0150 | 89 30 AB 5C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>ECDB070099A27C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04423E765F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1111389791</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0463B83B55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1673018197</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010091F39BFC3BAEEA8E3319DA8C</code> <code>9CBF6660DFEB69CFB8CF2F3A9B46E935</code> <code>40B622E1D9BB1837F228E1DD5971EFD7</code> <code>361154569FF96E87E3171AECA82F0346</code> <code>25DB87D02A9910071C70BD12D09F2129</code> <code>ED7FF1B51F64ED41EAFBACEB73A2AE00</code> <code>5E6708DAD8220CC1C0D603A79F6F9E3B</code> <code>1DA51A718C50CE7925E6FCFA9E5DEF35</code> <code>CF6AEE8F36A6EE7DC8E822B4F40D57D5</code> <code>BE138FB2FDEE9FCEF955CA2F8337BF86</code> <code>1FE133A2677CC4384B29C13B3BBA3EBC</code> <code>810C592793727B4089A9F9503617401D</code> <code>27C174A0CFF51B56E461DB414F62C95A</code> <code>080D7C970A52BA7AAB88B2517AA08EC6</code> <code>E0CD3604A1D50CB09F37397DCB0ED324</code> <code>267CAC3AEBCB7D9FD5BF1A9B9675CA44</code><br> <code>8930AB5C</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 78 F1 98 99 A2 7C 65
0010 | 94 02 00 00 5C 07 E8 D0 B3 E1 D2 FA 3E 92 73 28
0020 | 94 C0 7D AE C7 C7 8E 10 C6 DB 85 F8 40 93 C7 5A
0030 | FE 46 DC 80 3D D1 2C C0 FE 50 02 00 FA 52 6D CF
0040 | 96 01 7C 62 13 A1 84 AA 95 17 BA B3 9A 4C B4 C6
0050 | D2 FF 14 C2 BB 59 53 6E D1 B6 5C 06 13 45 11 E0
0060 | BB 18 0B 50 48 62 24 0D 4A 7D B3 92 82 41 E2 6F
0070 | 07 2E 30 E0 CF 96 87 44 C0 65 0C 51 42 46 79 1E
0080 | AB 89 E7 8D 5A 92 79 3B 79 2A E9 ED 60 BD CB A0
0090 | 01 61 E9 63 2C 49 7E 31 D5 39 E3 84 14 17 F6 13
00A0 | 40 F7 B8 CA 98 13 34 93 20 C1 E7 91 F2 6F D5 E7
00B0 | C0 7B 53 89 DE CF DB 88 F8 7B FB F6 F9 FD 62 4E
00C0 | A6 5F 47 7B 2C C9 CD 43 EF E1 50 41 D3 65 C0 3C
00D0 | 01 73 5A 82 22 27 AA 02 C1 7C 04 19 7B A4 32 91
00E0 | 05 E9 76 7D 12 E9 C9 C4 8A 55 23 21 A8 C0 42 6D
00F0 | FB 08 CC 47 B7 D5 EE 04 7A AD CD 34 E4 3D 17 4C
0100 | 42 AD 33 28 87 C5 EA 93 77 55 2A 9E 2A 20 AD 06
0110 | 8B 61 EB F3 CC 57 A3 FB F7 E2 98 3C 22 23 66 8E
0120 | 63 77 20 8F C7 3B 7E DB 9A CE F2 62 76 15 FC 43
0130 | FE B5 6C 94 81 58 B2 40 24 64 A9 3F 32 41 B8 18
0140 | 8D 7B 7E 59 95 03 0B 7B 1C 4D F0 77 4A 0F 8A 0D
0150 | D8 E5 F4 4D 03 32 72 D8 F3 73 00 CB 11 3F 39 B8
0160 | 20 3A 55 12 CF 94 8A 25 45 DB AF 9F 26 A5 B0 A1
0170 | A8 CB BB C0 42 ED 52 14 DF 23 11 2B DC 11 9D B4
0180 | 87 53 74 A1 22 91 A0 BA A4 CF 0A 96 81 A7 AC 73
0190 | AD 5C 67 C1 C4 C7 6E DF 15 11 6D 13 50 61 EF F2
01A0 | C5 D9 26 2A 9E 9C DA 47 13 B0 58 1F D0 AB 3B E2
01B0 | 88 69 4C F5 16 43 C7 63 DD 23 33 4D DD D8 F0 F0
01C0 | FC 2C 22 C7 74 B2 9B 4F AE ED 11 94 37 E8 D6 31
01D0 | 68 9E 35 83 7D 3D C1 A9 34 54 E7 B0 9C 12 E4 95
01E0 | 7F 6A 3A 0D 85 A5 D0 6D 1A E3 F5 3D 90 F1 A4 B3
01F0 | EC DB EB 35 0D FC E4 8F 45 54 DC DC 9C 9E 53 63
0200 | 65 E7 EB A0 6B 77 9C 40 31 24 A0 1B B5 55 49 6A
0210 | CB 32 47 D8 DB 93 C7 46 10 DB 93 EF 6C A8 7B 84
0220 | 63 87 DC A8 4A 33 26 44 DD 0B 0F 05 45 F6 04 26
0230 | 47 DE E3 7E 5F DC 2C 33 82 E3 DC 52 1E 40 7D 43
0240 | DE 42 55 51 8D 65 54 05 9E C6 1D 6C 0C AB E7 D1
0250 | D2 22 46 B8 4B 84 6D 4A 4B 61 E7 16 73 3E CB E2
0260 | CB FF FD 77 CC DF 49 2F B4 7F 47 CE A7 D9 0C 3A
0270 | CF B1 99 76 E4 4B F2 2A 4D 6F A7 65 9D 91 E1 14
0280 | F5 3C 36 05 1F 5C B3 E5 18 6F 74 B5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0178F19899A27C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>94020000</code> (660 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200FA526DCF96017C6213A184AA</code> <code>9517BAB39A4CB4C6D2FF14C2BB59536E</code> <code>D1B65C06134511E0BB180B504862240D</code> <code>4A7DB3928241E26F072E30E0CF968744</code> <code>C0650C514246791EAB89E78D5A92793B</code> <code>792AE9ED60BDCBA00161E9632C497E31</code> <code>D539E3841417F61340F7B8CA98133493</code> <code>20C1E791F26FD5E7C07B5389DECFDB88</code> <code>F87BFBF6F9FD624EA65F477B2CC9CD43</code> <code>EFE15041D365C03C01735A822227AA02</code> <code>C17C04197BA4329105E9767D12E9C9C4</code> <code>8A552321A8C0426DFB08CC47B7D5EE04</code> <code>7AADCD34E43D174C42AD332887C5EA93</code> <code>77552A9E2A20AD068B61EBF3CC57A3FB</code> <code>F7E2983C2223668E6377208FC73B7EDB</code> <code>9ACEF2627615FC43FEB56C948158B240</code> <code>2464A93F3241B8188D7B7E5995030B7B</code> <code>1C4DF0774A0F8A0DD8E5F44D033272D8</code> <code>F37300CB113F39B8203A5512CF948A25</code> <code>45DBAF9F26A5B0A1A8CBBBC042ED5214</code> <code>DF23112BDC119DB4875374A12291A0BA</code> <code>A4CF0A9681A7AC73AD5C67C1C4C76EDF</code> <code>15116D135061EFF2C5D9262A9E9CDA47</code> <code>13B0581FD0AB3BE288694CF51643C763</code> <code>DD23334DDDD8F0F0FC2C22C774B29B4F</code> <code>AEED119437E8D631689E35837D3DC1A9</code> <code>3454E7B09C12E4957F6A3A0D85A5D06D</code> <code>1AE3F53D90F1A4B3ECDBEB350DFCE48F</code> <code>4554DCDC9C9E536365E7EBA06B779C40</code> <code>3124A01BB555496ACB3247D8DB93C746</code> <code>10DB93EF6CA87B846387DCA84A332644</code> <code>DD0B0F0545F6042647DEE37E5FDC2C33</code> <code>82E3DC521E407D43DE4255518D655405</code> <code>9EC61D6C0CABE7D1D22246B84B846D4A</code> <code>4B61E716733ECBE2CBFFFD77CCDF492F</code> <code>B47F47CEA7D90C3ACFB19976E44BF22A</code> <code>4D6FA7659D91E114F53C36051F5CB3E5</code><br> <code>186F74B5</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = FA526DCF96017C6213A184AA9517BAB39A4CB4C6D2FF14C2BB59536ED1B65C06134511E0BB180B504862240D4A7DB3928241E26F072E30E0CF968744C0650C514246791EAB89E78D5A92793B792AE9ED60BDCBA00161E9632C497E31D539E3841417F61340F7B8CA9813349320C1E791F26FD5E7C07B5389DECFDB88F87BFBF6F9FD624EA65F477B2CC9CD43EFE15041D365C03C01735A822227AA02C17C04197BA4329105E9767D12E9C9C48A552321A8C0426DFB08CC47B7D5EE047AADCD34E43D174C42AD332887C5EA9377552A9E2A20AD068B61EBF3CC57A3FBF7E2983C2223668E6377208FC73B7EDB9ACEF2627615FC43FEB56C948158B2402464A93F3241B8188D7B7E5995030B7B1C4DF0774A0F8A0DD8E5F44D033272D8F37300CB113F39B8203A5512CF948A2545DBAF9F26A5B0A1A8CBBBC042ED5214DF23112BDC119DB4875374A12291A0BAA4CF0A9681A7AC73AD5C67C1C4C76EDF15116D135061EFF2C5D9262A9E9CDA4713B0581FD0AB3BE288694CF51643C763DD23334DDDD8F0F0FC2C22C774B29B4FAEED119437E8D631689E35837D3DC1A93454E7B09C12E4957F6A3A0D85A5D06D1AE3F53D90F1A4B3ECDBEB350DFCE48F4554DCDC9C9E536365E7EBA06B779C403124A01BB555496ACB3247D8DB93C74610DB93EF6CA87B846387DCA84A332644DD0B0F0545F6042647DEE37E5FDC2C3382E3DC521E407D43DE4255518D6554059EC61D6C0CABE7D1D22246B84B846D4A4B61E716733ECBE2CBFFFD77CCDF492FB47F47CEA7D90C3ACFB19976E44BF22A4D6FA7659D91E114F53C36051F5CB3E5186F74B5
tmp_aes_key = 656C62150D07208FBFD43F699694392BEA12420FB0FCF97F38EB133362C8D42B
tmp_aes_iv = C4C17A57E0E1B321E7B09EED0E7F2DF2B7309129E23AFF664C4B867D79CC5858</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 30FED3225CBB23C8BF99F7D2F6D006F5A08607E9BA0D89B5B3E1D2FA3E92732894C07DAEC7C78E10C6DB85F84093C75AFE46DC803DD12CC003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100AF8F35A4FCDE6EF5B128119981505BD6A6E483D9FB0A9B58047554E3DB6FA879AC78376E267A114A555D08925411A86C808D6A6CD60B9C028F12A125E766F4F190CDD1DAA106E8510FCD14BD7645A92D10BB72982AD4B7969B89B43BDF26B9187456338D29990B02FFDA9EDA582A29455E1FC169159ADB87B802AE6551EAADDC7F852DC8D54FAE5E309FC939A17308D48614795EDEE4E42E3F72290AA3B28C981A8C17F7E01133A8E93FEF9CBC96BC798C1904349F30DD4C6D49C11FBB19FB52664B672D0271E6A3FB36446BC99AE0E7FF27ECEEC6E5E144CB5ED8AEE22369B2CCCA9A0E9D6D9ADC2CA0527899AA1DE3B505709C5D4653CFA7A88863873CF21B99A27C6582A3BBE184C40C68
answer = BA0D89B5B3E1D2FA3E92732894C07DAEC7C78E10C6DB85F84093C75AFE46DC803DD12CC003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100AF8F35A4FCDE6EF5B128119981505BD6A6E483D9FB0A9B58047554E3DB6FA879AC78376E267A114A555D08925411A86C808D6A6CD60B9C028F12A125E766F4F190CDD1DAA106E8510FCD14BD7645A92D10BB72982AD4B7969B89B43BDF26B9187456338D29990B02FFDA9EDA582A29455E1FC169159ADB87B802AE6551EAADDC7F852DC8D54FAE5E309FC939A17308D48614795EDEE4E42E3F72290AA3B28C981A8C17F7E01133A8E93FEF9CBC96BC798C1904349F30DD4C6D49C11FBB19FB52664B672D0271E6A3FB36446BC99AE0E7FF27ECEEC6E5E144CB5ED8AEE22369B2CCCA9A0E9D6D9ADC2CA0527899AA1DE3B505709C5D4653CFA7A88863873CF21B99A27C6582A3BBE184C40C68</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 B3 E1 D2 FA 3E 92 73 28 94 C0 7D AE
0010 | C7 C7 8E 10 C6 DB 85 F8 40 93 C7 5A FE 46 DC 80
0020 | 3D D1 2C C0 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | AF 8F 35 A4 FC DE 6E F5 B1 28 11 99 81 50 5B D6
0140 | A6 E4 83 D9 FB 0A 9B 58 04 75 54 E3 DB 6F A8 79
0150 | AC 78 37 6E 26 7A 11 4A 55 5D 08 92 54 11 A8 6C
0160 | 80 8D 6A 6C D6 0B 9C 02 8F 12 A1 25 E7 66 F4 F1
0170 | 90 CD D1 DA A1 06 E8 51 0F CD 14 BD 76 45 A9 2D
0180 | 10 BB 72 98 2A D4 B7 96 9B 89 B4 3B DF 26 B9 18
0190 | 74 56 33 8D 29 99 0B 02 FF DA 9E DA 58 2A 29 45
01A0 | 5E 1F C1 69 15 9A DB 87 B8 02 AE 65 51 EA AD DC
01B0 | 7F 85 2D C8 D5 4F AE 5E 30 9F C9 39 A1 73 08 D4
01C0 | 86 14 79 5E DE E4 E4 2E 3F 72 29 0A A3 B2 8C 98
01D0 | 1A 8C 17 F7 E0 11 33 A8 E9 3F EF 9C BC 96 BC 79
01E0 | 8C 19 04 34 9F 30 DD 4C 6D 49 C1 1F BB 19 FB 52
01F0 | 66 4B 67 2D 02 71 E6 A3 FB 36 44 6B C9 9A E0 E7
0200 | FF 27 EC EE C6 E5 E1 44 CB 5E D8 AE E2 23 69 B2
0210 | CC CA 9A 0E 9D 6D 9A DC 2C A0 52 78 99 AA 1D E3
0220 | B5 05 70 9C 5D 46 53 CF A7 A8 88 63 87 3C F2 1B
0230 | 99 A2 7C 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100AF8F35A4FCDE6EF5B1281199</code> <code>81505BD6A6E483D9FB0A9B58047554E3</code> <code>DB6FA879AC78376E267A114A555D0892</code> <code>5411A86C808D6A6CD60B9C028F12A125</code> <code>E766F4F190CDD1DAA106E8510FCD14BD</code> <code>7645A92D10BB72982AD4B7969B89B43B</code> <code>DF26B9187456338D29990B02FFDA9EDA</code> <code>582A29455E1FC169159ADB87B802AE65</code> <code>51EAADDC7F852DC8D54FAE5E309FC939</code> <code>A17308D48614795EDEE4E42E3F72290A</code> <code>A3B28C981A8C17F7E01133A8E93FEF9C</code> <code>BC96BC798C1904349F30DD4C6D49C11F</code> <code>BB19FB52664B672D0271E6A3FB36446B</code> <code>C99AE0E7FF27ECEEC6E5E144CB5ED8AE</code> <code>E22369B2CCCA9A0E9D6D9ADC2CA05278</code> <code>99AA1DE3B505709C5D4653CFA7A88863</code><br> <code>873CF21B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>99A27C65</code> (1702666905 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = BF735A674C1785CDA8F4A2E948A49F1CED4742664A186D1C924305359720B0F72352D1E00AE8ACB4FA1F24335D674EF301EC7E8A0D91048CFB35546767C494C97A27C0BFE25EB8BE16A376C7306C0AA3A4F218A28560E65D1A5FEA7CDE94EB4046F8D59817B5137B67BCB22A1464BDA650F23B356137E248FC1091C88ED887031609D36E55064F2AC833F0C79E07613F26C8C6D81060B8885A1FA970A286E03BA018A4677E62A8AE113D595BF63C985E8C2BC51FDA0B0ACD50C3BE5EBEB443F8118AC32C0CD409BE7945C391A3AC313B70697AE31BF3F7EF0EA686ADD92458B384A3596DF9D304EE05FA2E1F7E9365D05B7BD177021A3424447297CD6C3F1460</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = A77CC850CB4E75C9C9EC93FACE302E7F633CF8AAC0CBD87103ADD8B9C93968E3D229BB29F55D128B0F48F89A854D7EA6F6CBBCDADC7134A06856E35A8BF05805897B90C379CC2413687FA73D8E2207B4EEB61A18D9B07E1E240CB81D320316317CFEEBB6F6D3CAA402718316CDA433643E04A39351EEBBDDB9D370544ECDE7392B70418468FA082BF919B519B681F0AACD4587B987754992A5093BB4187FDE9FB00124A7FD0E7D2E41E5BA84030011E2EDD340000B47DA718FA5A211056F83FBEB5E15A2156DFD0B57FF5DCD55FE84B7F337EDF168B27A143692C5AF49D8894C95E1ECD80B8C2BFAE54E788E933A882570C00F6917F6ADC47D4229BF9D879882</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 B3 E1 D2 FA 3E 92 73 28 94 C0 7D AE
0010 | C7 C7 8E 10 C6 DB 85 F8 40 93 C7 5A FE 46 DC 80
0020 | 3D D1 2C C0 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | A7 7C C8 50 CB 4E 75 C9 C9 EC 93 FA CE 30 2E 7F
0040 | 63 3C F8 AA C0 CB D8 71 03 AD D8 B9 C9 39 68 E3
0050 | D2 29 BB 29 F5 5D 12 8B 0F 48 F8 9A 85 4D 7E A6
0060 | F6 CB BC DA DC 71 34 A0 68 56 E3 5A 8B F0 58 05
0070 | 89 7B 90 C3 79 CC 24 13 68 7F A7 3D 8E 22 07 B4
0080 | EE B6 1A 18 D9 B0 7E 1E 24 0C B8 1D 32 03 16 31
0090 | 7C FE EB B6 F6 D3 CA A4 02 71 83 16 CD A4 33 64
00A0 | 3E 04 A3 93 51 EE BB DD B9 D3 70 54 4E CD E7 39
00B0 | 2B 70 41 84 68 FA 08 2B F9 19 B5 19 B6 81 F0 AA
00C0 | CD 45 87 B9 87 75 49 92 A5 09 3B B4 18 7F DE 9F
00D0 | B0 01 24 A7 FD 0E 7D 2E 41 E5 BA 84 03 00 11 E2
00E0 | ED D3 40 00 0B 47 DA 71 8F A5 A2 11 05 6F 83 FB
00F0 | EB 5E 15 A2 15 6D FD 0B 57 FF 5D CD 55 FE 84 B7
0100 | F3 37 ED F1 68 B2 7A 14 36 92 C5 AF 49 D8 89 4C
0110 | 95 E1 EC D8 0B 8C 2B FA E5 4E 78 8E 93 3A 88 25
0120 | 70 C0 0F 69 17 F6 AD C4 7D 42 29 BF 9D 87 98 82</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100A77CC850CB4E75C9C9EC93FA</code> <code>CE302E7F633CF8AAC0CBD87103ADD8B9</code> <code>C93968E3D229BB29F55D128B0F48F89A</code> <code>854D7EA6F6CBBCDADC7134A06856E35A</code> <code>8BF05805897B90C379CC2413687FA73D</code> <code>8E2207B4EEB61A18D9B07E1E240CB81D</code> <code>320316317CFEEBB6F6D3CAA402718316</code> <code>CDA433643E04A39351EEBBDDB9D37054</code> <code>4ECDE7392B70418468FA082BF919B519</code> <code>B681F0AACD4587B987754992A5093BB4</code> <code>187FDE9FB00124A7FD0E7D2E41E5BA84</code> <code>030011E2EDD340000B47DA718FA5A211</code> <code>056F83FBEB5E15A2156DFD0B57FF5DCD</code> <code>55FE84B7F337EDF168B27A143692C5AF</code> <code>49D8894C95E1ECD80B8C2BFAE54E788E</code> <code>933A882570C00F6917F6ADC47D4229BF</code><br> <code>9D879882</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366B3E1D2FA3E92732894C07DAEC7C78E10C6DB85F84093C75AFE46DC803DD12CC00000000000000000FE000100A77CC850CB4E75C9C9EC93FACE302E7F633CF8AAC0CBD87103ADD8B9C93968E3D229BB29F55D128B0F48F89A854D7EA6F6CBBCDADC7134A06856E35A8BF05805897B90C379CC2413687FA73D8E2207B4EEB61A18D9B07E1E240CB81D320316317CFEEBB6F6D3CAA402718316CDA433643E04A39351EEBBDDB9D370544ECDE7392B70418468FA082BF919B519B681F0AACD4587B987754992A5093BB4187FDE9FB00124A7FD0E7D2E41E5BA84030011E2EDD340000B47DA718FA5A211056F83FBEB5E15A2156DFD0B57FF5DCD55FE84B7F337EDF168B27A143692C5AF49D8894C95E1ECD80B8C2BFAE54E788E933A882570C00F6917F6ADC47D4229BF9D879882
padding = 3A56FDEE8A10FEC869B26703
tmp_aes_key = 656C62150D07208FBFD43F699694392BEA12420FB0FCF97F38EB133362C8D42B
tmp_aes_iv = C4C17A57E0E1B321E7B09EED0E7F2DF2B7309129E23AFF664C4B867D79CC5858</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 715E52FCAB18C07336B830E67CE609178B1355B3401CD4D2333CBF7DC6C48492233C39246D1EECB57972E8198F26640E90E47E30D2CFF2F5E89C0D5D0DCA775CE61561930A79DD60C9F80E04D6F07DCBE424602EBE59851790087543D47E9E6B8378493E80428B5BD2ECA810C18FFFEE5FBCE42C0C51D234D8AE825AC47909499DA142A5938EC5EA1A3B3B1D4110AE7B009BA74D637B3A1B8B9E4B0F67B58691BB73519B87078D33FE6525033853BC78EB6AC332FFB52BC7FAED3CC75BF548BE1A8CF6286093DED305E58C14204AC2A6989149899EF575F35E4C8C962EABDDE1F9B9E957B6A9F92289958DD57206A3C9642E4DBD622475FC6EF14AE52E51F64C011EE0B247696841C9748462C4BDAB7958F217CE191D581E82B6A5967FFC1D8CE543427F9FA95304F2519C5535C6EFFBC3F75C4F540A0F1ACCA49C8E0964356F9A47A9DB674D632EBD59902133C5CB12</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 DB 07 00 99 A2 7C 65
0010 | 78 01 00 00 1F 5F 04 F5 B3 E1 D2 FA 3E 92 73 28
0020 | 94 C0 7D AE C7 C7 8E 10 C6 DB 85 F8 40 93 C7 5A
0030 | FE 46 DC 80 3D D1 2C C0 FE 50 01 00 71 5E 52 FC
0040 | AB 18 C0 73 36 B8 30 E6 7C E6 09 17 8B 13 55 B3
0050 | 40 1C D4 D2 33 3C BF 7D C6 C4 84 92 23 3C 39 24
0060 | 6D 1E EC B5 79 72 E8 19 8F 26 64 0E 90 E4 7E 30
0070 | D2 CF F2 F5 E8 9C 0D 5D 0D CA 77 5C E6 15 61 93
0080 | 0A 79 DD 60 C9 F8 0E 04 D6 F0 7D CB E4 24 60 2E
0090 | BE 59 85 17 90 08 75 43 D4 7E 9E 6B 83 78 49 3E
00A0 | 80 42 8B 5B D2 EC A8 10 C1 8F FF EE 5F BC E4 2C
00B0 | 0C 51 D2 34 D8 AE 82 5A C4 79 09 49 9D A1 42 A5
00C0 | 93 8E C5 EA 1A 3B 3B 1D 41 10 AE 7B 00 9B A7 4D
00D0 | 63 7B 3A 1B 8B 9E 4B 0F 67 B5 86 91 BB 73 51 9B
00E0 | 87 07 8D 33 FE 65 25 03 38 53 BC 78 EB 6A C3 32
00F0 | FF B5 2B C7 FA ED 3C C7 5B F5 48 BE 1A 8C F6 28
0100 | 60 93 DE D3 05 E5 8C 14 20 4A C2 A6 98 91 49 89
0110 | 9E F5 75 F3 5E 4C 8C 96 2E AB DD E1 F9 B9 E9 57
0120 | B6 A9 F9 22 89 95 8D D5 72 06 A3 C9 64 2E 4D BD
0130 | 62 24 75 FC 6E F1 4A E5 2E 51 F6 4C 01 1E E0 B2
0140 | 47 69 68 41 C9 74 84 62 C4 BD AB 79 58 F2 17 CE
0150 | 19 1D 58 1E 82 B6 A5 96 7F FC 1D 8C E5 43 42 7F
0160 | 9F A9 53 04 F2 51 9C 55 35 C6 EF FB C3 F7 5C 4F
0170 | 54 0A 0F 1A CC A4 9C 8E 09 64 35 6F 9A 47 A9 DB
0180 | 67 4D 63 2E BD 59 90 21 33 C5 CB 12</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0DB070099A27C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100715E52FCAB18C07336B830E6</code> <code>7CE609178B1355B3401CD4D2333CBF7D</code> <code>C6C48492233C39246D1EECB57972E819</code> <code>8F26640E90E47E30D2CFF2F5E89C0D5D</code> <code>0DCA775CE61561930A79DD60C9F80E04</code> <code>D6F07DCBE424602EBE59851790087543</code> <code>D47E9E6B8378493E80428B5BD2ECA810</code> <code>C18FFFEE5FBCE42C0C51D234D8AE825A</code> <code>C47909499DA142A5938EC5EA1A3B3B1D</code> <code>4110AE7B009BA74D637B3A1B8B9E4B0F</code> <code>67B58691BB73519B87078D33FE652503</code> <code>3853BC78EB6AC332FFB52BC7FAED3CC7</code> <code>5BF548BE1A8CF6286093DED305E58C14</code> <code>204AC2A6989149899EF575F35E4C8C96</code> <code>2EABDDE1F9B9E957B6A9F92289958DD5</code> <code>7206A3C9642E4DBD622475FC6EF14AE5</code> <code>2E51F64C011EE0B247696841C9748462</code> <code>C4BDAB7958F217CE191D581E82B6A596</code> <code>7FFC1D8CE543427F9FA95304F2519C55</code> <code>35C6EFFBC3F75C4F540A0F1ACCA49C8E</code> <code>0964356F9A47A9DB674D632EBD599021</code><br> <code>33C5CB12</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 82F078D27C28B9158A05764D13C3E3C63DAB7591A0D34EA72CDCD05BD61ACA24E1B9E9A8252A45AEF6A73A2E84B4B49D3FF70837C721C856B84B2D1101A9DA81CEE6691A08DF704D8ECC77CCF7561FA1DFBF19C8494BC2226493F39795552759088AB848CD7A280A576447456D7A3C8CB858514663C281F22FAEEED73C5BB45DB447455C47CE868FFCC5B9918F877616B340CB92576EC70D7AA0EC220CE68BD24BC06BBF9BB525917048950DE7601D45D38299AAF06DDE09420571739E36C87430271B78EBC89AC9325195B3E42CA243364B2644991EFE43EA9211D3E0C398980E4295D6F590726DF09C1EDD3D7E8CCCD7896EF55CAF8CD35EC0D49418971D71</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 10 32 E2 99 A2 7C 65
0010 | 5C 00 00 00 34 F7 CB 3B B3 E1 D2 FA 3E 92 73 28
0020 | 94 C0 7D AE C7 C7 8E 10 C6 DB 85 F8 40 93 C7 5A
0030 | FE 46 DC 80 3D D1 2C C0 4A F5 6C 57 08 4D 0D 18
0040 | 1A 22 40 E1 C2 0C E0 89</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>011032E299A27C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>5C000000</code> (92 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3E1D2FA3E92732894C07DAEC7C78E10</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C6DB85F84093C75AFE46DC803DD12CC0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4AF56C57084D0D181A2240E1C20CE089</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

