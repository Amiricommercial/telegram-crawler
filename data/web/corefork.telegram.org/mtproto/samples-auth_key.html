<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F8 0F 0C 00 C0 FB B3 65
0010 | 14 00 00 00 F1 8E 7E BE 0F B3 89 6D B8 D4 F6 4A
0020 | A3 BF 00 07 47 45 01 BB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F80F0C00C0FBB365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 08 25 87 C0 FB B3 65
0010 | CC 00 00 00 63 24 16 05 0F B3 89 6D B8 D4 F6 4A
0020 | A3 BF 00 07 47 45 01 BB B2 FB 10 D3 78 A3 4B 01
0030 | 87 44 4E 66 1C A0 BC 2D 08 12 FB 88 BE A7 BA B9
0040 | 27 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01082587C0FBB365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>CC000000</code> (204 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0812FB88BEA7BAB927000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1367837264276273447</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1367837264276273447</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1367837264276273447 = 1145893927 * 1193685761</code></p>
<pre><code>p = 1145893927
q = 1193685761</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 12 FB 88 BE A7 BA B9 27 00 00 00
0010 | 04 44 4C F4 27 00 00 00 04 47 26 33 01 00 00 00
0020 | 0F B3 89 6D B8 D4 F6 4A A3 BF 00 07 47 45 01 BB
0030 | B2 FB 10 D3 78 A3 4B 01 87 44 4E 66 1C A0 BC 2D
0040 | 94 25 B6 19 AD 20 13 51 DA 61 FF 35 D8 D7 1F 10
0050 | 17 2F C1 2A E3 5F 80 E1 2D C8 26 AD AC CE 38 DF
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0812FB88BEA7BAB927000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1367837264276273447</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04444CF427000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1145893927</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0447263301000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1193685761</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>9425B619AD201351DA61FF35D8D71F10</code> <code>172FC12AE35F80E12DC826ADACCE38DF</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90812FB88BEA7BAB92700000004444CF42700000004472633010000000FB3896DB8D4F64AA3BF0007474501BBB2FB10D378A34B0187444E661CA0BC2D9425B619AD201351DA61FF35D8D71F10172FC12AE35F80E12DC826ADACCE38DF02000000
random_padding_bytes = 493EED61CB26155C38368CCD6D4994E9EC8501BE820C9D4FC3F51ED630C390EF4A541E70EF70321606360D2602B0C2BB2ED6190BF1712EB8082B7791A42556955145014F947E4BAA5DDA157EAB8B60469D0834AA1EFBADA91D9DF7FD</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 341338BAFE30B6F50135AD07F4571652DDAD90697D5BE5B32AE38BCF0A5F54DBEDB039694EC300BC75EC388C4A202822E385826F3171B8EB607997C6FAA99DC3AAD24D23603F8170975382258F770452B27817879CCBC8AB3014E82E985A9C6032A4E529E3F1615A8698EA18B846CEE48D18C656AF3D64DE9E3A5DF5DB5E929AA1355942534EBC5DBC5CBC057C97CE48656585DF91B19A44FA77DC345CAE1BF8CDE43EB4A759A989E9EEA192986149E8FFB443E699045F7B08AA866BDC429F66FDA98276688FC0BF3BB3FCB3F9FE57911AE3A95FD71624ED6EC89A93EB73EF249517E4343D3644D044250EC135833BCF2F3FFB783B80A3105113E9B71E2E0E7F</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 FC 0F 0C 00 C0 FB B3 65
0010 | 40 01 00 00 BE E4 12 D7 0F B3 89 6D B8 D4 F6 4A
0020 | A3 BF 00 07 47 45 01 BB B2 FB 10 D3 78 A3 4B 01
0030 | 87 44 4E 66 1C A0 BC 2D 04 44 4C F4 27 00 00 00
0040 | 04 47 26 33 01 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 34 13 38 BA FE 30 B6 F5 01 35 AD 07
0060 | F4 57 16 52 DD AD 90 69 7D 5B E5 B3 2A E3 8B CF
0070 | 0A 5F 54 DB ED B0 39 69 4E C3 00 BC 75 EC 38 8C
0080 | 4A 20 28 22 E3 85 82 6F 31 71 B8 EB 60 79 97 C6
0090 | FA A9 9D C3 AA D2 4D 23 60 3F 81 70 97 53 82 25
00A0 | 8F 77 04 52 B2 78 17 87 9C CB C8 AB 30 14 E8 2E
00B0 | 98 5A 9C 60 32 A4 E5 29 E3 F1 61 5A 86 98 EA 18
00C0 | B8 46 CE E4 8D 18 C6 56 AF 3D 64 DE 9E 3A 5D F5
00D0 | DB 5E 92 9A A1 35 59 42 53 4E BC 5D BC 5C BC 05
00E0 | 7C 97 CE 48 65 65 85 DF 91 B1 9A 44 FA 77 DC 34
00F0 | 5C AE 1B F8 CD E4 3E B4 A7 59 A9 89 E9 EE A1 92
0100 | 98 61 49 E8 FF B4 43 E6 99 04 5F 7B 08 AA 86 6B
0110 | DC 42 9F 66 FD A9 82 76 68 8F C0 BF 3B B3 FC B3
0120 | F9 FE 57 91 1A E3 A9 5F D7 16 24 ED 6E C8 9A 93
0130 | EB 73 EF 24 95 17 E4 34 3D 36 44 D0 44 25 0E C1
0140 | 35 83 3B CF 2F 3F FB 78 3B 80 A3 10 51 13 E9 B7
0150 | 1E 2E 0E 7F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>FC0F0C00C0FBB365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04444CF427000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1145893927</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0447263301000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1193685761</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100341338BAFE30B6F50135AD07</code> <code>F4571652DDAD90697D5BE5B32AE38BCF</code> <code>0A5F54DBEDB039694EC300BC75EC388C</code> <code>4A202822E385826F3171B8EB607997C6</code> <code>FAA99DC3AAD24D23603F817097538225</code> <code>8F770452B27817879CCBC8AB3014E82E</code> <code>985A9C6032A4E529E3F1615A8698EA18</code> <code>B846CEE48D18C656AF3D64DE9E3A5DF5</code> <code>DB5E929AA1355942534EBC5DBC5CBC05</code> <code>7C97CE48656585DF91B19A44FA77DC34</code> <code>5CAE1BF8CDE43EB4A759A989E9EEA192</code> <code>986149E8FFB443E699045F7B08AA866B</code> <code>DC429F66FDA98276688FC0BF3BB3FCB3</code> <code>F9FE57911AE3A95FD71624ED6EC89A93</code> <code>EB73EF249517E4343D3644D044250EC1</code> <code>35833BCF2F3FFB783B80A3105113E9B7</code><br> <code>1E2E0E7F</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A4 A6 3C C1 FB B3 65
0010 | 8C 02 00 00 5C 07 E8 D0 0F B3 89 6D B8 D4 F6 4A
0020 | A3 BF 00 07 47 45 01 BB B2 FB 10 D3 78 A3 4B 01
0030 | 87 44 4E 66 1C A0 BC 2D FE 50 02 00 23 53 27 9B
0040 | B1 E1 E7 23 EF D9 ED 37 B9 6F D9 40 82 84 A9 C9
0050 | 99 CC 57 BE 3E 2A 7F 77 A9 3E 4E AA 3B 02 AD 83
0060 | A2 CB F1 F2 27 E8 85 6E E2 8C 51 40 D0 56 7A A0
0070 | 77 09 39 C7 D7 F8 93 E2 41 71 D6 CE 4B 53 CC BE
0080 | 1E 8F 84 F4 7D 75 13 43 5B 99 F6 50 E5 78 71 D8
0090 | 34 73 C1 68 E3 82 A8 BA EC 66 1E B2 15 52 12 15
00A0 | BA 52 98 04 49 47 DB FE 1A CF A2 CE 62 87 8E 91
00B0 | C8 19 62 D9 43 FE 34 A4 37 FB 76 DA 5C F2 1F 60
00C0 | C2 24 D8 14 8B A3 31 16 F2 72 A1 F8 B5 9B 23 20
00D0 | BF 8B B0 B6 5C 2A 78 CA 60 15 FE 70 5D CD 95 FB
00E0 | 7E 50 A2 C1 BB 59 E8 11 66 B8 F9 BE E1 E9 18 0D
00F0 | 49 E6 24 1B 02 E8 B5 6C AD E3 9D 79 8D 03 49 A3
0100 | 9F 63 7B 44 3D 68 BB AA 1B 65 FC 4C 12 92 C6 D6
0110 | D3 0B D9 73 C4 B6 18 FF 47 9C 5C 0C 46 A8 6F 97
0120 | 6A 78 62 21 5F 46 C1 7A 13 A3 73 40 D6 C1 FB 34
0130 | 9D E2 23 4B 74 C0 AF 08 61 04 84 F5 AA 89 4E 23
0140 | 12 FA 4B D0 32 CA F2 8D E8 D6 9B 47 C7 CF 4F F1
0150 | 2D D4 E0 AE 4D D0 B3 7E 93 64 2E 5A 4A 2F 1E 3F
0160 | FB CD 5D C5 46 E5 2A 1B 83 FA 0F A5 E8 DE DF 52
0170 | FB B8 A0 42 02 5C B4 E4 72 EA 89 DC 9A 9A CE 6E
0180 | FC 2D 9E BA 09 3E 28 6F AB 46 79 92 8C F7 86 E2
0190 | E8 4E 95 59 AA 33 51 7B 90 7A 05 52 6F 32 76 8F
01A0 | 7A 91 AC 9A 5A 08 82 48 40 53 02 0B 9C 08 D1 AA
01B0 | BD 9A 48 F6 3F 1F 66 13 60 1E 54 24 F2 8E D4 D1
01C0 | 9E 99 AE A1 65 5D 60 C0 7A 61 3D AC 32 C6 8F 48
01D0 | 3B 6A 3E B5 50 CC AC 6F 4F 56 50 9D C1 EC C9 F6
01E0 | C7 C1 A5 EF 72 59 EE 09 D0 34 35 84 51 E5 51 89
01F0 | E9 4D 88 88 3C 57 46 E2 44 DF C5 8C 22 30 CA 4E
0200 | 16 CA 7A 69 48 74 02 41 67 E3 7E 83 78 36 A0 18
0210 | 00 FF 00 15 FE CC 08 2F D1 06 5C 4F A2 A6 EA B5
0220 | 9B 8D 4E 21 0F EC 3B E7 88 4C A9 60 02 2C 81 B9
0230 | 5C EC 7A F2 34 C1 DE 6C B0 5F EA DD B5 1D 4F 06
0240 | 4C FF 61 70 25 81 13 32 A9 F8 21 D3 1C 40 40 17
0250 | 5A E4 F2 8C FD CC 81 77 00 B7 96 0E 61 30 25 65
0260 | 69 34 93 36 67 7C 68 D4 C2 59 75 5F 9E 22 C6 39
0270 | C3 C4 CA 3F 27 6F 91 AC 94 25 0F 98 84 EE 55 8D
0280 | BE D9 5C 70 B7 CF 41 35 5F C5 9C 6D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A4A63CC1FBB365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>8C020000</code> (652 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002002353279BB1E1E723EFD9ED37</code> <code>B96FD9408284A9C999CC57BE3E2A7F77</code> <code>A93E4EAA3B02AD83A2CBF1F227E8856E</code> <code>E28C5140D0567AA0770939C7D7F893E2</code> <code>4171D6CE4B53CCBE1E8F84F47D751343</code> <code>5B99F650E57871D83473C168E382A8BA</code> <code>EC661EB215521215BA5298044947DBFE</code> <code>1ACFA2CE62878E91C81962D943FE34A4</code> <code>37FB76DA5CF21F60C224D8148BA33116</code> <code>F272A1F8B59B2320BF8BB0B65C2A78CA</code> <code>6015FE705DCD95FB7E50A2C1BB59E811</code> <code>66B8F9BEE1E9180D49E6241B02E8B56C</code> <code>ADE39D798D0349A39F637B443D68BBAA</code> <code>1B65FC4C1292C6D6D30BD973C4B618FF</code> <code>479C5C0C46A86F976A7862215F46C17A</code> <code>13A37340D6C1FB349DE2234B74C0AF08</code> <code>610484F5AA894E2312FA4BD032CAF28D</code> <code>E8D69B47C7CF4FF12DD4E0AE4DD0B37E</code> <code>93642E5A4A2F1E3FFBCD5DC546E52A1B</code> <code>83FA0FA5E8DEDF52FBB8A042025CB4E4</code> <code>72EA89DC9A9ACE6EFC2D9EBA093E286F</code> <code>AB4679928CF786E2E84E9559AA33517B</code> <code>907A05526F32768F7A91AC9A5A088248</code> <code>4053020B9C08D1AABD9A48F63F1F6613</code> <code>601E5424F28ED4D19E99AEA1655D60C0</code> <code>7A613DAC32C68F483B6A3EB550CCAC6F</code> <code>4F56509DC1ECC9F6C7C1A5EF7259EE09</code> <code>D034358451E55189E94D88883C5746E2</code> <code>44DFC58C2230CA4E16CA7A6948740241</code> <code>67E37E837836A01800FF0015FECC082F</code> <code>D1065C4FA2A6EAB59B8D4E210FEC3BE7</code> <code>884CA960022C81B95CEC7AF234C1DE6C</code> <code>B05FEADDB51D4F064CFF617025811332</code> <code>A9F821D31C4040175AE4F28CFDCC8177</code> <code>00B7960E6130256569349336677C68D4</code> <code>C259755F9E22C639C3C4CA3F276F91AC</code> <code>94250F9884EE558DBED95C70B7CF4135</code><br> <code>5FC59C6D</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 2353279BB1E1E723EFD9ED37B96FD9408284A9C999CC57BE3E2A7F77A93E4EAA3B02AD83A2CBF1F227E8856EE28C5140D0567AA0770939C7D7F893E24171D6CE4B53CCBE1E8F84F47D7513435B99F650E57871D83473C168E382A8BAEC661EB215521215BA5298044947DBFE1ACFA2CE62878E91C81962D943FE34A437FB76DA5CF21F60C224D8148BA33116F272A1F8B59B2320BF8BB0B65C2A78CA6015FE705DCD95FB7E50A2C1BB59E81166B8F9BEE1E9180D49E6241B02E8B56CADE39D798D0349A39F637B443D68BBAA1B65FC4C1292C6D6D30BD973C4B618FF479C5C0C46A86F976A7862215F46C17A13A37340D6C1FB349DE2234B74C0AF08610484F5AA894E2312FA4BD032CAF28DE8D69B47C7CF4FF12DD4E0AE4DD0B37E93642E5A4A2F1E3FFBCD5DC546E52A1B83FA0FA5E8DEDF52FBB8A042025CB4E472EA89DC9A9ACE6EFC2D9EBA093E286FAB4679928CF786E2E84E9559AA33517B907A05526F32768F7A91AC9A5A0882484053020B9C08D1AABD9A48F63F1F6613601E5424F28ED4D19E99AEA1655D60C07A613DAC32C68F483B6A3EB550CCAC6F4F56509DC1ECC9F6C7C1A5EF7259EE09D034358451E55189E94D88883C5746E244DFC58C2230CA4E16CA7A694874024167E37E837836A01800FF0015FECC082FD1065C4FA2A6EAB59B8D4E210FEC3BE7884CA960022C81B95CEC7AF234C1DE6CB05FEADDB51D4F064CFF617025811332A9F821D31C4040175AE4F28CFDCC817700B7960E6130256569349336677C68D4C259755F9E22C639C3C4CA3F276F91AC94250F9884EE558DBED95C70B7CF41355FC59C6D
tmp_aes_key = 695E5D5073BA35408BB39AC367E613169C326D1FF07AF7431B871C839E5A54ED
tmp_aes_iv = EA681B84941A2E507EE05F6923DCA7B2E0AD5FD9A83859856EE0B6AD9425B619</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = BC46D671D2B508231144D92D9202D9A3C66D7490BA0D89B50FB3896DB8D4F64AA3BF0007474501BBB2FB10D378A34B0187444E661CA0BC2D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010097C24DCAE30AEA5E7CB1213EDCD92578132D9E658F8A661BE55E9157F4457B12AA67EB921C408D52B93CD77F045D974C191613A8920054C7F72B9B74D5EEE95EDF9425DA675CDD3011D6F3DCD22BA453FC90159385082702D24B0E1F91DB1E1E9136B06E6195C719021905E17A5C607B57EF6D0189B0E5434A7DCCF7A979D1F6CAB988156FAB405526E4E27DA9F95B95440C84049631B12A93A33B7A0AE963697A25E2DA442DAE9BD18A373ECC2EFC38B50521BCADCD2141AFF240613C8B8C9A03B437D1877AC681BCF9BF1BE5488AEDC2F695B0B5262E3240620D881175E78E906F00341B9100598EDDA65B3C0A983F168EB595B142196D47CFDB39A2E9D890C1FBB365EB2748982C31AB5A
answer = BA0D89B50FB3896DB8D4F64AA3BF0007474501BBB2FB10D378A34B0187444E661CA0BC2D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010097C24DCAE30AEA5E7CB1213EDCD92578132D9E658F8A661BE55E9157F4457B12AA67EB921C408D52B93CD77F045D974C191613A8920054C7F72B9B74D5EEE95EDF9425DA675CDD3011D6F3DCD22BA453FC90159385082702D24B0E1F91DB1E1E9136B06E6195C719021905E17A5C607B57EF6D0189B0E5434A7DCCF7A979D1F6CAB988156FAB405526E4E27DA9F95B95440C84049631B12A93A33B7A0AE963697A25E2DA442DAE9BD18A373ECC2EFC38B50521BCADCD2141AFF240613C8B8C9A03B437D1877AC681BCF9BF1BE5488AEDC2F695B0B5262E3240620D881175E78E906F00341B9100598EDDA65B3C0A983F168EB595B142196D47CFDB39A2E9D890C1FBB365EB2748982C31AB5A</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 0F B3 89 6D B8 D4 F6 4A A3 BF 00 07
0010 | 47 45 01 BB B2 FB 10 D3 78 A3 4B 01 87 44 4E 66
0020 | 1C A0 BC 2D 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 97 C2 4D CA E3 0A EA 5E 7C B1 21 3E DC D9 25 78
0140 | 13 2D 9E 65 8F 8A 66 1B E5 5E 91 57 F4 45 7B 12
0150 | AA 67 EB 92 1C 40 8D 52 B9 3C D7 7F 04 5D 97 4C
0160 | 19 16 13 A8 92 00 54 C7 F7 2B 9B 74 D5 EE E9 5E
0170 | DF 94 25 DA 67 5C DD 30 11 D6 F3 DC D2 2B A4 53
0180 | FC 90 15 93 85 08 27 02 D2 4B 0E 1F 91 DB 1E 1E
0190 | 91 36 B0 6E 61 95 C7 19 02 19 05 E1 7A 5C 60 7B
01A0 | 57 EF 6D 01 89 B0 E5 43 4A 7D CC F7 A9 79 D1 F6
01B0 | CA B9 88 15 6F AB 40 55 26 E4 E2 7D A9 F9 5B 95
01C0 | 44 0C 84 04 96 31 B1 2A 93 A3 3B 7A 0A E9 63 69
01D0 | 7A 25 E2 DA 44 2D AE 9B D1 8A 37 3E CC 2E FC 38
01E0 | B5 05 21 BC AD CD 21 41 AF F2 40 61 3C 8B 8C 9A
01F0 | 03 B4 37 D1 87 7A C6 81 BC F9 BF 1B E5 48 8A ED
0200 | C2 F6 95 B0 B5 26 2E 32 40 62 0D 88 11 75 E7 8E
0210 | 90 6F 00 34 1B 91 00 59 8E DD A6 5B 3C 0A 98 3F
0220 | 16 8E B5 95 B1 42 19 6D 47 CF DB 39 A2 E9 D8 90
0230 | C1 FB B3 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010097C24DCAE30AEA5E7CB1213E</code> <code>DCD92578132D9E658F8A661BE55E9157</code> <code>F4457B12AA67EB921C408D52B93CD77F</code> <code>045D974C191613A8920054C7F72B9B74</code> <code>D5EEE95EDF9425DA675CDD3011D6F3DC</code> <code>D22BA453FC90159385082702D24B0E1F</code> <code>91DB1E1E9136B06E6195C719021905E1</code> <code>7A5C607B57EF6D0189B0E5434A7DCCF7</code> <code>A979D1F6CAB988156FAB405526E4E27D</code> <code>A9F95B95440C84049631B12A93A33B7A</code> <code>0AE963697A25E2DA442DAE9BD18A373E</code> <code>CC2EFC38B50521BCADCD2141AFF24061</code> <code>3C8B8C9A03B437D1877AC681BCF9BF1B</code> <code>E5488AEDC2F695B0B5262E3240620D88</code> <code>1175E78E906F00341B9100598EDDA65B</code> <code>3C0A983F168EB595B142196D47CFDB39</code><br> <code>A2E9D890</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>C1FBB365</code> (1706294209 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = FBD2AF203260953DEFA154C1247CD766720E31A267F8D05DED49D9C8BDDC42952DA652189A214F37C83D0A6BE2604C3C32A9F020C16B0D72B102B313B2B17452AA0FCC42ECB01C6D7FE35DCF7A1E6AEFD547DD757EB3549C36B87A48E49E48E3F3F2B64E784B2A75A464EFAE5DD43EA0AB2CEDD321D18BB8EAE7A0A483CC125286F8D313EBFD9F5DEED2DD6C9B2FB6923258C741BCA3C3A03FD2590B025D20775D630A95D8F803D42131BC428095E7E021980D5DDC2AC608CD4D32DA2C8EC76C32EF84E007FE5FBC08166B9C2F81620149C66B17AA4E8FBA3A704C66270ACA2F469274AB4A1B27E0A93C7F224129FCFA6E80D2CE642F3608A38050846E95BEF2</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 6900C2840E67BFBB5D418B3823070B495E1375D7B4A32A36CA0DA2E68E1F60957A6BF2626DBD542532D746A738E175DC1B33B97736D3DDD600A6EE2B64D6EF89A355DD7EE35DC1FCC735DAD938736A2C6FE6D2A98606BF328A8D7D6CA8A06A57F149482F06ED77A71F8C8ECA8686012D766E694B2603D0308258A4F3E7F3EFED9DFB160E2CF9CE8AAA124784B23969B3F16CB3EE04DD27C49C54FC6F42F1A5BFC25F9F34FAFEF6F5EA32CB335DBE73A9B1DB2EA4E3B2E5C0991799F8E92C1C354B8C7CF411BB5690396BAA8722EBFC9D9C00E6FE9A3128E6BDA6D8C89EF6B2C3C70C32D879D6C932E95BA7C39CC2D55D055D300CF510BC6CB584C5CD248CED54</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 0F B3 89 6D B8 D4 F6 4A A3 BF 00 07
0010 | 47 45 01 BB B2 FB 10 D3 78 A3 4B 01 87 44 4E 66
0020 | 1C A0 BC 2D 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 69 00 C2 84 0E 67 BF BB 5D 41 8B 38 23 07 0B 49
0040 | 5E 13 75 D7 B4 A3 2A 36 CA 0D A2 E6 8E 1F 60 95
0050 | 7A 6B F2 62 6D BD 54 25 32 D7 46 A7 38 E1 75 DC
0060 | 1B 33 B9 77 36 D3 DD D6 00 A6 EE 2B 64 D6 EF 89
0070 | A3 55 DD 7E E3 5D C1 FC C7 35 DA D9 38 73 6A 2C
0080 | 6F E6 D2 A9 86 06 BF 32 8A 8D 7D 6C A8 A0 6A 57
0090 | F1 49 48 2F 06 ED 77 A7 1F 8C 8E CA 86 86 01 2D
00A0 | 76 6E 69 4B 26 03 D0 30 82 58 A4 F3 E7 F3 EF ED
00B0 | 9D FB 16 0E 2C F9 CE 8A AA 12 47 84 B2 39 69 B3
00C0 | F1 6C B3 EE 04 DD 27 C4 9C 54 FC 6F 42 F1 A5 BF
00D0 | C2 5F 9F 34 FA FE F6 F5 EA 32 CB 33 5D BE 73 A9
00E0 | B1 DB 2E A4 E3 B2 E5 C0 99 17 99 F8 E9 2C 1C 35
00F0 | 4B 8C 7C F4 11 BB 56 90 39 6B AA 87 22 EB FC 9D
0100 | 9C 00 E6 FE 9A 31 28 E6 BD A6 D8 C8 9E F6 B2 C3
0110 | C7 0C 32 D8 79 D6 C9 32 E9 5B A7 C3 9C C2 D5 5D
0120 | 05 5D 30 0C F5 10 BC 6C B5 84 C5 CD 24 8C ED 54</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001006900C2840E67BFBB5D418B38</code> <code>23070B495E1375D7B4A32A36CA0DA2E6</code> <code>8E1F60957A6BF2626DBD542532D746A7</code> <code>38E175DC1B33B97736D3DDD600A6EE2B</code> <code>64D6EF89A355DD7EE35DC1FCC735DAD9</code> <code>38736A2C6FE6D2A98606BF328A8D7D6C</code> <code>A8A06A57F149482F06ED77A71F8C8ECA</code> <code>8686012D766E694B2603D0308258A4F3</code> <code>E7F3EFED9DFB160E2CF9CE8AAA124784</code> <code>B23969B3F16CB3EE04DD27C49C54FC6F</code> <code>42F1A5BFC25F9F34FAFEF6F5EA32CB33</code> <code>5DBE73A9B1DB2EA4E3B2E5C0991799F8</code> <code>E92C1C354B8C7CF411BB5690396BAA87</code> <code>22EBFC9D9C00E6FE9A3128E6BDA6D8C8</code> <code>9EF6B2C3C70C32D879D6C932E95BA7C3</code> <code>9CC2D55D055D300CF510BC6CB584C5CD</code><br> <code>248CED54</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643660FB3896DB8D4F64AA3BF0007474501BBB2FB10D378A34B0187444E661CA0BC2D0000000000000000FE0001006900C2840E67BFBB5D418B3823070B495E1375D7B4A32A36CA0DA2E68E1F60957A6BF2626DBD542532D746A738E175DC1B33B97736D3DDD600A6EE2B64D6EF89A355DD7EE35DC1FCC735DAD938736A2C6FE6D2A98606BF328A8D7D6CA8A06A57F149482F06ED77A71F8C8ECA8686012D766E694B2603D0308258A4F3E7F3EFED9DFB160E2CF9CE8AAA124784B23969B3F16CB3EE04DD27C49C54FC6F42F1A5BFC25F9F34FAFEF6F5EA32CB335DBE73A9B1DB2EA4E3B2E5C0991799F8E92C1C354B8C7CF411BB5690396BAA8722EBFC9D9C00E6FE9A3128E6BDA6D8C89EF6B2C3C70C32D879D6C932E95BA7C39CC2D55D055D300CF510BC6CB584C5CD248CED54
padding = CBC58A6F6911365FC22A9177
tmp_aes_key = 695E5D5073BA35408BB39AC367E613169C326D1FF07AF7431B871C839E5A54ED
tmp_aes_iv = EA681B84941A2E507EE05F6923DCA7B2E0AD5FD9A83859856EE0B6AD9425B619</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = EFC413BB078845D2CBA59C121502CFFF26BA817B89D172115B803438C82E52861DFF773222C8C754B1F4CFBAF586D65A31BB45DE2B1FD2E36267FD208B5374681A561339A6906C13438B50177927B021B59765698273B16E14DBE3B5D492170B624DFD30AD7A2DC7EE44B6B069056CA69590D58FB63A149AF5FBB491C6945EFCE2E8100F3A1434AA2E3A0CC9B30A038EBDBA436B8C23FF9CAF0D8FD4ABEA97A68BE0775B07BB8C9F30097F26F65A57099615AB31E2DDC844C05F62609C378579A0CE2C564AC31F43664AC9A74549F8AEF9565E79E21A35847799F6B950DCCC6B11CF6B10A53A5DF4167EA4E00151207DA9C48A9D268D070D8F93C12CDA71130C8618744B556712E1977481B2D333F800A0B9EB781D297B888C3BE702EA5E196496F4B13CA2B365670E88A391567B559EDAEC68A1A049F6B3D0AD397C94F34A38C977B768E3EA9529BC5D363246B0B399</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 AC 62 00 00 C1 FB B3 65
0010 | 78 01 00 00 1F 5F 04 F5 0F B3 89 6D B8 D4 F6 4A
0020 | A3 BF 00 07 47 45 01 BB B2 FB 10 D3 78 A3 4B 01
0030 | 87 44 4E 66 1C A0 BC 2D FE 50 01 00 EF C4 13 BB
0040 | 07 88 45 D2 CB A5 9C 12 15 02 CF FF 26 BA 81 7B
0050 | 89 D1 72 11 5B 80 34 38 C8 2E 52 86 1D FF 77 32
0060 | 22 C8 C7 54 B1 F4 CF BA F5 86 D6 5A 31 BB 45 DE
0070 | 2B 1F D2 E3 62 67 FD 20 8B 53 74 68 1A 56 13 39
0080 | A6 90 6C 13 43 8B 50 17 79 27 B0 21 B5 97 65 69
0090 | 82 73 B1 6E 14 DB E3 B5 D4 92 17 0B 62 4D FD 30
00A0 | AD 7A 2D C7 EE 44 B6 B0 69 05 6C A6 95 90 D5 8F
00B0 | B6 3A 14 9A F5 FB B4 91 C6 94 5E FC E2 E8 10 0F
00C0 | 3A 14 34 AA 2E 3A 0C C9 B3 0A 03 8E BD BA 43 6B
00D0 | 8C 23 FF 9C AF 0D 8F D4 AB EA 97 A6 8B E0 77 5B
00E0 | 07 BB 8C 9F 30 09 7F 26 F6 5A 57 09 96 15 AB 31
00F0 | E2 DD C8 44 C0 5F 62 60 9C 37 85 79 A0 CE 2C 56
0100 | 4A C3 1F 43 66 4A C9 A7 45 49 F8 AE F9 56 5E 79
0110 | E2 1A 35 84 77 99 F6 B9 50 DC CC 6B 11 CF 6B 10
0120 | A5 3A 5D F4 16 7E A4 E0 01 51 20 7D A9 C4 8A 9D
0130 | 26 8D 07 0D 8F 93 C1 2C DA 71 13 0C 86 18 74 4B
0140 | 55 67 12 E1 97 74 81 B2 D3 33 F8 00 A0 B9 EB 78
0150 | 1D 29 7B 88 8C 3B E7 02 EA 5E 19 64 96 F4 B1 3C
0160 | A2 B3 65 67 0E 88 A3 91 56 7B 55 9E DA EC 68 A1
0170 | A0 49 F6 B3 D0 AD 39 7C 94 F3 4A 38 C9 77 B7 68
0180 | E3 EA 95 29 BC 5D 36 32 46 B0 B3 99</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>AC620000C1FBB365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100EFC413BB078845D2CBA59C12</code> <code>1502CFFF26BA817B89D172115B803438</code> <code>C82E52861DFF773222C8C754B1F4CFBA</code> <code>F586D65A31BB45DE2B1FD2E36267FD20</code> <code>8B5374681A561339A6906C13438B5017</code> <code>7927B021B59765698273B16E14DBE3B5</code> <code>D492170B624DFD30AD7A2DC7EE44B6B0</code> <code>69056CA69590D58FB63A149AF5FBB491</code> <code>C6945EFCE2E8100F3A1434AA2E3A0CC9</code> <code>B30A038EBDBA436B8C23FF9CAF0D8FD4</code> <code>ABEA97A68BE0775B07BB8C9F30097F26</code> <code>F65A57099615AB31E2DDC844C05F6260</code> <code>9C378579A0CE2C564AC31F43664AC9A7</code> <code>4549F8AEF9565E79E21A35847799F6B9</code> <code>50DCCC6B11CF6B10A53A5DF4167EA4E0</code> <code>0151207DA9C48A9D268D070D8F93C12C</code> <code>DA71130C8618744B556712E1977481B2</code> <code>D333F800A0B9EB781D297B888C3BE702</code> <code>EA5E196496F4B13CA2B365670E88A391</code> <code>567B559EDAEC68A1A049F6B3D0AD397C</code> <code>94F34A38C977B768E3EA9529BC5D3632</code><br> <code>46B0B399</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 76050AE4569B3765E53E541207CD161CF3D47AB4BACDE545E6F5356921DC4C90FD11CC1B134A81D316276149E4BB9E47E1AD229FF7E117109304E48DCE192FAED5A41AF091FEBD89CC1AD9F79FB223CB4F7AFC63C4F6E9635DBD44B83A968D7253A84590E04A062201C097F42F40492A62B6E38D9A23F4C81B04EE2113FCABE2BE396C2247CDC500050494188DC5BAFE5A92C07FD051CFC1EAF3C54FEBCCD47655ADEBBB183CFA67EE4B64BDBBE97C4CEC9DBD995861EACDA905ED51CB7E28D2F1872B1F0C4D24ED98638595DA06459EAAC14C47ED8FF72C4F834DC78CE92C1BD5E274FBB62F8B7474A9404FE1F7D09231DABC41009A3BB9C58FED3FE65A2A81</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 70 F0 45 C2 FB B3 65
0010 | 74 00 00 00 34 F7 CB 3B 0F B3 89 6D B8 D4 F6 4A
0020 | A3 BF 00 07 47 45 01 BB B2 FB 10 D3 78 A3 4B 01
0030 | 87 44 4E 66 1C A0 BC 2D 2A DF 61 64 25 7C 6B B8
0040 | 4B 11 E5 0C 8D 67 A2 DD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0170F045C2FBB365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>74000000</code> (116 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0FB3896DB8D4F64AA3BF0007474501BB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B2FB10D378A34B0187444E661CA0BC2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>2ADF6164257C6BB84B11E50C8D67A2DD</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

