<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 90 45 05 00 71 F5 22 65
0010 | 14 00 00 00 F1 8E 7E BE 58 C2 89 3D 19 63 D1 36
0020 | 4C 49 F9 69 1D 09 67 FA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>9045050071F52265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 7E 28 71 F5 22 65
0010 | 90 00 00 00 63 24 16 05 58 C2 89 3D 19 63 D1 36
0020 | 4C 49 F9 69 1D 09 67 FA 54 54 54 07 99 FB 06 6A
0030 | D9 0A E7 F9 A5 F7 E0 48 08 32 F8 EA 1A 81 A9 22
0040 | C9 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01307E2871F52265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90000000</code> (144 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0832F8EA1A81A922C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3672942895686034121</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3672942895686034121</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3672942895686034121 = 1863829003 * 1970643707</code></p>
<pre><code>p = 1863829003
q = 1970643707</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 32 F8 EA 1A 81 A9 22 C9 00 00 00
0010 | 04 6F 17 C6 0B 00 00 00 04 75 75 A2 FB 00 00 00
0020 | 58 C2 89 3D 19 63 D1 36 4C 49 F9 69 1D 09 67 FA
0030 | 54 54 54 07 99 FB 06 6A D9 0A E7 F9 A5 F7 E0 48
0040 | E7 A0 8A 34 DB A6 8A C4 08 C8 5D 58 75 F1 60 66
0050 | B0 12 D8 E7 77 A3 15 07 83 CF 00 F4 58 8B 2E 05
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0832F8EA1A81A922C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3672942895686034121</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>046F17C60B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1863829003</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047575A2FB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1970643707</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>E7A08A34DBA68AC408C85D5875F16066</code> <code>B012D8E777A3150783CF00F4588B2E05</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90832F8EA1A81A922C9000000046F17C60B000000047575A2FB00000058C2893D1963D1364C49F9691D0967FA5454540799FB066AD90AE7F9A5F7E048E7A08A34DBA68AC408C85D5875F16066B012D8E777A3150783CF00F4588B2E0502000000
random_padding_bytes = 2C5439FD410845A070327817A7AA56C71C9FD27F2663B1701FB8B31D26E0AEE1CBCFB9930CF6CB8213A89F0453E5F6CCDCA8B00E6DE243C5DD40C3615A184A52A3BB2EDD2DDD67F32EFF805EFDC085FECCB384A2A11EFF269AF2C18C</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 1D332697DD5742DA60F7620B959BCF6239EBF5DB882924327EF2B6D4BC7F72EE4FFC6FB012EF6FB9C3D0FB43DA1DD8AB7B7DAB4E9497B4F9D084D54EDC13174A1243122757731EFCB059F8FF69FD369F03D621E190CFB2589B726C636A1810B1D5032F9B7EEA5C686FB3D9C06EA241DECF5BAF480910B8E31B2F9CA2DD703BC7D551DF2E1DBB2B46026FD629E3A1CAA330A72D8B98C8C41FC77E56F29BB6CAB036BF8B235DA5DF8E16685AC822B365E3DE3F56450E7055F38D2F163BD2FD1453D3F698720126CB53CD7A5E036D5109D2CCF8DA7ECC28D8FC3884809ACF510F247429106F2CE6C896615E858C64D176C96FFF9920BAFAA61681F3052D06D5F6BA</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 14 61 0B 00 71 F5 22 65
0010 | 40 01 00 00 BE E4 12 D7 58 C2 89 3D 19 63 D1 36
0020 | 4C 49 F9 69 1D 09 67 FA 54 54 54 07 99 FB 06 6A
0030 | D9 0A E7 F9 A5 F7 E0 48 04 6F 17 C6 0B 00 00 00
0040 | 04 75 75 A2 FB 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 1D 33 26 97 DD 57 42 DA 60 F7 62 0B
0060 | 95 9B CF 62 39 EB F5 DB 88 29 24 32 7E F2 B6 D4
0070 | BC 7F 72 EE 4F FC 6F B0 12 EF 6F B9 C3 D0 FB 43
0080 | DA 1D D8 AB 7B 7D AB 4E 94 97 B4 F9 D0 84 D5 4E
0090 | DC 13 17 4A 12 43 12 27 57 73 1E FC B0 59 F8 FF
00A0 | 69 FD 36 9F 03 D6 21 E1 90 CF B2 58 9B 72 6C 63
00B0 | 6A 18 10 B1 D5 03 2F 9B 7E EA 5C 68 6F B3 D9 C0
00C0 | 6E A2 41 DE CF 5B AF 48 09 10 B8 E3 1B 2F 9C A2
00D0 | DD 70 3B C7 D5 51 DF 2E 1D BB 2B 46 02 6F D6 29
00E0 | E3 A1 CA A3 30 A7 2D 8B 98 C8 C4 1F C7 7E 56 F2
00F0 | 9B B6 CA B0 36 BF 8B 23 5D A5 DF 8E 16 68 5A C8
0100 | 22 B3 65 E3 DE 3F 56 45 0E 70 55 F3 8D 2F 16 3B
0110 | D2 FD 14 53 D3 F6 98 72 01 26 CB 53 CD 7A 5E 03
0120 | 6D 51 09 D2 CC F8 DA 7E CC 28 D8 FC 38 84 80 9A
0130 | CF 51 0F 24 74 29 10 6F 2C E6 C8 96 61 5E 85 8C
0140 | 64 D1 76 C9 6F FF 99 20 BA FA A6 16 81 F3 05 2D
0150 | 06 D5 F6 BA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>14610B0071F52265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>046F17C60B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1863829003</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047575A2FB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1970643707</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001001D332697DD5742DA60F7620B</code> <code>959BCF6239EBF5DB882924327EF2B6D4</code> <code>BC7F72EE4FFC6FB012EF6FB9C3D0FB43</code> <code>DA1DD8AB7B7DAB4E9497B4F9D084D54E</code> <code>DC13174A1243122757731EFCB059F8FF</code> <code>69FD369F03D621E190CFB2589B726C63</code> <code>6A1810B1D5032F9B7EEA5C686FB3D9C0</code> <code>6EA241DECF5BAF480910B8E31B2F9CA2</code> <code>DD703BC7D551DF2E1DBB2B46026FD629</code> <code>E3A1CAA330A72D8B98C8C41FC77E56F2</code> <code>9BB6CAB036BF8B235DA5DF8E16685AC8</code> <code>22B365E3DE3F56450E7055F38D2F163B</code> <code>D2FD1453D3F698720126CB53CD7A5E03</code> <code>6D5109D2CCF8DA7ECC28D8FC3884809A</code> <code>CF510F247429106F2CE6C896615E858C</code> <code>64D176C96FFF9920BAFAA61681F3052D</code><br> <code>06D5F6BA</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 20 E3 71 F5 22 65
0010 | E4 02 00 00 5C 07 E8 D0 58 C2 89 3D 19 63 D1 36
0020 | 4C 49 F9 69 1D 09 67 FA 54 54 54 07 99 FB 06 6A
0030 | D9 0A E7 F9 A5 F7 E0 48 FE 50 02 00 71 58 0A 8A
0040 | 83 C3 BC FE F0 D7 83 EC 01 0E C2 ED 5C 17 2A E2
0050 | D3 FB A6 A9 8B 25 57 4D CE 59 AF 7F 46 B6 39 6D
0060 | F1 69 C8 80 C1 E4 5F 5A 5F C6 97 9F 4F DA FE 2A
0070 | 1F 7A 72 11 FA 82 02 C0 59 98 84 A5 69 24 0B 7F
0080 | A6 E7 3E 40 4B 3C B0 E9 E1 6C 04 69 6A C4 CF 3F
0090 | C4 78 5D 68 2A 3C 3C 44 C4 EA D9 3F 3B 67 9C 6D
00A0 | 99 9E EB A2 01 12 3B F0 3C 84 E8 8C 4B C1 41 F6
00B0 | 77 25 DF CB B4 A9 54 30 3E 9B A3 92 3F 41 26 9B
00C0 | 76 2B DB C8 A8 36 42 DF 37 81 C7 E5 F4 C1 22 17
00D0 | B5 80 01 E6 86 F4 4F B6 8A 07 04 9B E0 5B B9 15
00E0 | B7 97 36 71 0C 8D 2F D7 59 DC F2 BA 73 A8 A7 DB
00F0 | 5B 42 45 E7 05 CF 8B C9 C5 76 7B 9C C5 94 38 F6
0100 | EF 09 C5 E9 92 99 5C 23 39 CE 5B 40 8D 35 28 EB
0110 | A9 E8 60 B2 AC D2 10 53 4A 39 03 3E B6 BA 6B DA
0120 | D6 C5 C6 E6 60 4A 10 6F 6D 53 0B DD E3 74 83 71
0130 | 45 D7 4B E0 47 95 35 2E 24 65 B2 3E A4 BD 24 F5
0140 | D2 F6 92 D1 71 4B 5A 40 CE 9E 1B 3A D2 3C C1 C3
0150 | 70 2B 5B FF B6 10 4B 24 91 87 55 0E C0 7D EE 92
0160 | 94 8D D0 FC 0C 76 02 6E 17 3A 72 D8 8D DD F2 AA
0170 | 67 4E 05 56 7A C7 E1 96 A6 F4 DE A3 74 EE 51 C8
0180 | 42 C4 FE 2A 79 C5 8B 82 F1 8D E7 8D 72 2D D2 25
0190 | 42 FC 95 F0 47 02 1C 81 24 FE 9B 50 EB F5 3C 12
01A0 | 9F 4B F4 7B B3 AB 7C 1F AC 68 B0 00 D9 2C B9 BD
01B0 | A5 37 E8 3E C8 4E 00 3B A2 B8 D3 68 3F 7B 7D 1C
01C0 | 2E 9A 26 AC 9B 5F 5B B1 59 DF A4 3D 6A 89 B5 6D
01D0 | 9C 34 79 E3 90 3D 8F C0 58 6D E9 AB C3 82 9A 53
01E0 | 76 68 DC 74 54 AD FC 7A FC BC 06 DF 0E 33 94 A9
01F0 | B8 EE 50 AA F5 33 E8 AC 15 73 66 63 C5 1F 3A 1F
0200 | AB D5 DC DD E5 46 47 AE 4D 34 C2 2D 64 A7 8E B5
0210 | BD DB 44 9C FE 8D 37 DB F0 EE 40 67 93 F2 F2 A3
0220 | 48 D3 A1 E8 84 03 A8 00 2B 31 FA 90 6C C6 11 19
0230 | 92 B9 D0 3F FE 75 6D 32 A2 80 D6 92 EE 61 6F 89
0240 | 75 EC 55 4E 79 0F E7 C1 5F 57 11 35 72 55 35 A1
0250 | AF FE F4 2E B5 06 68 C9 71 29 D9 ED 58 63 23 88
0260 | A9 2D 94 98 1B 0E 53 39 6E 7F 4F 79 0B D5 F7 B3
0270 | C7 FB F1 F5 A4 14 9B 97 01 79 A1 CD 04 4A 62 48
0280 | 58 DC FD B4 45 D5 E6 AD 0D 5C D8 59</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E020E371F52265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>E4020000</code> (740 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020071580A8A83C3BCFEF0D783EC</code> <code>010EC2ED5C172AE2D3FBA6A98B25574D</code> <code>CE59AF7F46B6396DF169C880C1E45F5A</code> <code>5FC6979F4FDAFE2A1F7A7211FA8202C0</code> <code>599884A569240B7FA6E73E404B3CB0E9</code> <code>E16C04696AC4CF3FC4785D682A3C3C44</code> <code>C4EAD93F3B679C6D999EEBA201123BF0</code> <code>3C84E88C4BC141F67725DFCBB4A95430</code> <code>3E9BA3923F41269B762BDBC8A83642DF</code> <code>3781C7E5F4C12217B58001E686F44FB6</code> <code>8A07049BE05BB915B79736710C8D2FD7</code> <code>59DCF2BA73A8A7DB5B4245E705CF8BC9</code> <code>C5767B9CC59438F6EF09C5E992995C23</code> <code>39CE5B408D3528EBA9E860B2ACD21053</code> <code>4A39033EB6BA6BDAD6C5C6E6604A106F</code> <code>6D530BDDE374837145D74BE04795352E</code> <code>2465B23EA4BD24F5D2F692D1714B5A40</code> <code>CE9E1B3AD23CC1C3702B5BFFB6104B24</code> <code>9187550EC07DEE92948DD0FC0C76026E</code> <code>173A72D88DDDF2AA674E05567AC7E196</code> <code>A6F4DEA374EE51C842C4FE2A79C58B82</code> <code>F18DE78D722DD22542FC95F047021C81</code> <code>24FE9B50EBF53C129F4BF47BB3AB7C1F</code> <code>AC68B000D92CB9BDA537E83EC84E003B</code> <code>A2B8D3683F7B7D1C2E9A26AC9B5F5BB1</code> <code>59DFA43D6A89B56D9C3479E3903D8FC0</code> <code>586DE9ABC3829A537668DC7454ADFC7A</code> <code>FCBC06DF0E3394A9B8EE50AAF533E8AC</code> <code>15736663C51F3A1FABD5DCDDE54647AE</code> <code>4D34C22D64A78EB5BDDB449CFE8D37DB</code> <code>F0EE406793F2F2A348D3A1E88403A800</code> <code>2B31FA906CC6111992B9D03FFE756D32</code> <code>A280D692EE616F8975EC554E790FE7C1</code> <code>5F571135725535A1AFFEF42EB50668C9</code> <code>7129D9ED58632388A92D94981B0E5339</code> <code>6E7F4F790BD5F7B3C7FBF1F5A4149B97</code> <code>0179A1CD044A624858DCFDB445D5E6AD</code><br> <code>0D5CD859</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 71580A8A83C3BCFEF0D783EC010EC2ED5C172AE2D3FBA6A98B25574DCE59AF7F46B6396DF169C880C1E45F5A5FC6979F4FDAFE2A1F7A7211FA8202C0599884A569240B7FA6E73E404B3CB0E9E16C04696AC4CF3FC4785D682A3C3C44C4EAD93F3B679C6D999EEBA201123BF03C84E88C4BC141F67725DFCBB4A954303E9BA3923F41269B762BDBC8A83642DF3781C7E5F4C12217B58001E686F44FB68A07049BE05BB915B79736710C8D2FD759DCF2BA73A8A7DB5B4245E705CF8BC9C5767B9CC59438F6EF09C5E992995C2339CE5B408D3528EBA9E860B2ACD210534A39033EB6BA6BDAD6C5C6E6604A106F6D530BDDE374837145D74BE04795352E2465B23EA4BD24F5D2F692D1714B5A40CE9E1B3AD23CC1C3702B5BFFB6104B249187550EC07DEE92948DD0FC0C76026E173A72D88DDDF2AA674E05567AC7E196A6F4DEA374EE51C842C4FE2A79C58B82F18DE78D722DD22542FC95F047021C8124FE9B50EBF53C129F4BF47BB3AB7C1FAC68B000D92CB9BDA537E83EC84E003BA2B8D3683F7B7D1C2E9A26AC9B5F5BB159DFA43D6A89B56D9C3479E3903D8FC0586DE9ABC3829A537668DC7454ADFC7AFCBC06DF0E3394A9B8EE50AAF533E8AC15736663C51F3A1FABD5DCDDE54647AE4D34C22D64A78EB5BDDB449CFE8D37DBF0EE406793F2F2A348D3A1E88403A8002B31FA906CC6111992B9D03FFE756D32A280D692EE616F8975EC554E790FE7C15F571135725535A1AFFEF42EB50668C97129D9ED58632388A92D94981B0E53396E7F4F790BD5F7B3C7FBF1F5A4149B970179A1CD044A624858DCFDB445D5E6AD0D5CD859
tmp_aes_key = 1EF31FDD893F3FC4802877BC105FC0B01A14753EEFF15E0BA1913BA164820A34
tmp_aes_iv = 5AF4537C03BE9A55811DD73015B491B2EDE87FD1499AD57E1C7F0C81E7A08A34</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = CD0A715DF80D8CB2F130ACA5407D2862E209972CBA0D89B558C2893D1963D1364C49F9691D0967FA5454540799FB066AD90AE7F9A5F7E04803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100985AF8E2C6F85D3F92DFA2AAF64E043E3670DC584FC7786A26C7B14DB98AF9595382F790BF9B8F3EFBD3A20D7600581C32A4E0EC581D098CB2C39B5321A4A59DE58597B517A1D4BC58EF0ABFF3D324C0D0C01AC667FC5DCB5FEC1E01E72A14682A494324FFD027C1D96298D1C3050F4A22179243CC5810F0EAC060DCDE13148CD159D1ABE9D013304535088786AA3D62B988FD94101F8EB07350A2427CBED7B4498DB95195D307623D9500B1A194BD9DC04E8603B17352EDA6469DD7EC0A694DCD291BD6DD31ADA6E29916ED96E0F3C777C51D22E5A35E72A96796B8E0196E54BF83F2F03A70324DCBD305A80E72846F7C52C2816EA76C5F663969D1EE76003471F52265348B7E126F692E2C
answer = BA0D89B558C2893D1963D1364C49F9691D0967FA5454540799FB066AD90AE7F9A5F7E04803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100985AF8E2C6F85D3F92DFA2AAF64E043E3670DC584FC7786A26C7B14DB98AF9595382F790BF9B8F3EFBD3A20D7600581C32A4E0EC581D098CB2C39B5321A4A59DE58597B517A1D4BC58EF0ABFF3D324C0D0C01AC667FC5DCB5FEC1E01E72A14682A494324FFD027C1D96298D1C3050F4A22179243CC5810F0EAC060DCDE13148CD159D1ABE9D013304535088786AA3D62B988FD94101F8EB07350A2427CBED7B4498DB95195D307623D9500B1A194BD9DC04E8603B17352EDA6469DD7EC0A694DCD291BD6DD31ADA6E29916ED96E0F3C777C51D22E5A35E72A96796B8E0196E54BF83F2F03A70324DCBD305A80E72846F7C52C2816EA76C5F663969D1EE76003471F52265348B7E126F692E2C</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 58 C2 89 3D 19 63 D1 36 4C 49 F9 69
0010 | 1D 09 67 FA 54 54 54 07 99 FB 06 6A D9 0A E7 F9
0020 | A5 F7 E0 48 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 98 5A F8 E2 C6 F8 5D 3F 92 DF A2 AA F6 4E 04 3E
0140 | 36 70 DC 58 4F C7 78 6A 26 C7 B1 4D B9 8A F9 59
0150 | 53 82 F7 90 BF 9B 8F 3E FB D3 A2 0D 76 00 58 1C
0160 | 32 A4 E0 EC 58 1D 09 8C B2 C3 9B 53 21 A4 A5 9D
0170 | E5 85 97 B5 17 A1 D4 BC 58 EF 0A BF F3 D3 24 C0
0180 | D0 C0 1A C6 67 FC 5D CB 5F EC 1E 01 E7 2A 14 68
0190 | 2A 49 43 24 FF D0 27 C1 D9 62 98 D1 C3 05 0F 4A
01A0 | 22 17 92 43 CC 58 10 F0 EA C0 60 DC DE 13 14 8C
01B0 | D1 59 D1 AB E9 D0 13 30 45 35 08 87 86 AA 3D 62
01C0 | B9 88 FD 94 10 1F 8E B0 73 50 A2 42 7C BE D7 B4
01D0 | 49 8D B9 51 95 D3 07 62 3D 95 00 B1 A1 94 BD 9D
01E0 | C0 4E 86 03 B1 73 52 ED A6 46 9D D7 EC 0A 69 4D
01F0 | CD 29 1B D6 DD 31 AD A6 E2 99 16 ED 96 E0 F3 C7
0200 | 77 C5 1D 22 E5 A3 5E 72 A9 67 96 B8 E0 19 6E 54
0210 | BF 83 F2 F0 3A 70 32 4D CB D3 05 A8 0E 72 84 6F
0220 | 7C 52 C2 81 6E A7 6C 5F 66 39 69 D1 EE 76 00 34
0230 | 71 F5 22 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100985AF8E2C6F85D3F92DFA2AA</code> <code>F64E043E3670DC584FC7786A26C7B14D</code> <code>B98AF9595382F790BF9B8F3EFBD3A20D</code> <code>7600581C32A4E0EC581D098CB2C39B53</code> <code>21A4A59DE58597B517A1D4BC58EF0ABF</code> <code>F3D324C0D0C01AC667FC5DCB5FEC1E01</code> <code>E72A14682A494324FFD027C1D96298D1</code> <code>C3050F4A22179243CC5810F0EAC060DC</code> <code>DE13148CD159D1ABE9D0133045350887</code> <code>86AA3D62B988FD94101F8EB07350A242</code> <code>7CBED7B4498DB95195D307623D9500B1</code> <code>A194BD9DC04E8603B17352EDA6469DD7</code> <code>EC0A694DCD291BD6DD31ADA6E29916ED</code> <code>96E0F3C777C51D22E5A35E72A96796B8</code> <code>E0196E54BF83F2F03A70324DCBD305A8</code> <code>0E72846F7C52C2816EA76C5F663969D1</code><br> <code>EE760034</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>71F52265</code> (1696789873 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 6D1E82DDAC9F80DECE92BC7A42D8E94014D5CF84A9428931A064BD731E92CF0DA08067E1B7BE172CCEF799064E69D7FFD89720494C74E09411284C3B6B8CE946F028869B859BB78B956B0C120442F70BDE77504866EEE955EC558F66B248C8E41C5EC19D0F7836051B7EF74D325281B2DA916B961668FF215DF3D6C4694D7AD793F2FED7AFEA47C85C71C2A6FED3EFBAC3B284C85FEDDA12B3DD0DAC7FDAEDF9D4FA09A3E421FC227F68DCE53D721EF3CF1BE23A6FAF0D46954E1C16B074D44712429911E24DB18D7E18A48689976A5622BB754C52A41D7C00DC374B7C417D64678C1F0F06773016856CDC4C91BC04A0E02E3054EC0B4A0D62198F16E03FBB00</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = C1FA6C6108A690D57884A07623800F29B976346C7FAF707299B186F72628781D1C4DD1EA9FD326C1896FBAC6506D534F89335B13FCEC4626184BC4F9CFD55895DA8D5C74A8D1E1F981FC9992217E93EEB55535DF90FC100F8D7FFA1278A286FB01EE5D107B69A39D1068A96B95322E4C9F9F1DC27AD90EFCF8DBABF9C8639644F9E392BD964FC32FE918F86D00585D3F13FAC7090294CB2222EE1766B9001FF22CC11D28FB0AE9CD589E0DC710F5DBB695C303876793838ACFB39E49DF1C9D6F99328918DA28559A02AB40791AAE5CE6AFBBD047AE4C8B57ADB1512738F35646D627840669C043D0DC0777D7B347B0FEA33A3D86198F81863A15E04632C9D737</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 58 C2 89 3D 19 63 D1 36 4C 49 F9 69
0010 | 1D 09 67 FA 54 54 54 07 99 FB 06 6A D9 0A E7 F9
0020 | A5 F7 E0 48 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | C1 FA 6C 61 08 A6 90 D5 78 84 A0 76 23 80 0F 29
0040 | B9 76 34 6C 7F AF 70 72 99 B1 86 F7 26 28 78 1D
0050 | 1C 4D D1 EA 9F D3 26 C1 89 6F BA C6 50 6D 53 4F
0060 | 89 33 5B 13 FC EC 46 26 18 4B C4 F9 CF D5 58 95
0070 | DA 8D 5C 74 A8 D1 E1 F9 81 FC 99 92 21 7E 93 EE
0080 | B5 55 35 DF 90 FC 10 0F 8D 7F FA 12 78 A2 86 FB
0090 | 01 EE 5D 10 7B 69 A3 9D 10 68 A9 6B 95 32 2E 4C
00A0 | 9F 9F 1D C2 7A D9 0E FC F8 DB AB F9 C8 63 96 44
00B0 | F9 E3 92 BD 96 4F C3 2F E9 18 F8 6D 00 58 5D 3F
00C0 | 13 FA C7 09 02 94 CB 22 22 EE 17 66 B9 00 1F F2
00D0 | 2C C1 1D 28 FB 0A E9 CD 58 9E 0D C7 10 F5 DB B6
00E0 | 95 C3 03 87 67 93 83 8A CF B3 9E 49 DF 1C 9D 6F
00F0 | 99 32 89 18 DA 28 55 9A 02 AB 40 79 1A AE 5C E6
0100 | AF BB D0 47 AE 4C 8B 57 AD B1 51 27 38 F3 56 46
0110 | D6 27 84 06 69 C0 43 D0 DC 07 77 D7 B3 47 B0 FE
0120 | A3 3A 3D 86 19 8F 81 86 3A 15 E0 46 32 C9 D7 37</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100C1FA6C6108A690D57884A076</code> <code>23800F29B976346C7FAF707299B186F7</code> <code>2628781D1C4DD1EA9FD326C1896FBAC6</code> <code>506D534F89335B13FCEC4626184BC4F9</code> <code>CFD55895DA8D5C74A8D1E1F981FC9992</code> <code>217E93EEB55535DF90FC100F8D7FFA12</code> <code>78A286FB01EE5D107B69A39D1068A96B</code> <code>95322E4C9F9F1DC27AD90EFCF8DBABF9</code> <code>C8639644F9E392BD964FC32FE918F86D</code> <code>00585D3F13FAC7090294CB2222EE1766</code> <code>B9001FF22CC11D28FB0AE9CD589E0DC7</code> <code>10F5DBB695C303876793838ACFB39E49</code> <code>DF1C9D6F99328918DA28559A02AB4079</code> <code>1AAE5CE6AFBBD047AE4C8B57ADB15127</code> <code>38F35646D627840669C043D0DC0777D7</code> <code>B347B0FEA33A3D86198F81863A15E046</code><br> <code>32C9D737</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436658C2893D1963D1364C49F9691D0967FA5454540799FB066AD90AE7F9A5F7E0480000000000000000FE000100C1FA6C6108A690D57884A07623800F29B976346C7FAF707299B186F72628781D1C4DD1EA9FD326C1896FBAC6506D534F89335B13FCEC4626184BC4F9CFD55895DA8D5C74A8D1E1F981FC9992217E93EEB55535DF90FC100F8D7FFA1278A286FB01EE5D107B69A39D1068A96B95322E4C9F9F1DC27AD90EFCF8DBABF9C8639644F9E392BD964FC32FE918F86D00585D3F13FAC7090294CB2222EE1766B9001FF22CC11D28FB0AE9CD589E0DC710F5DBB695C303876793838ACFB39E49DF1C9D6F99328918DA28559A02AB40791AAE5CE6AFBBD047AE4C8B57ADB1512738F35646D627840669C043D0DC0777D7B347B0FEA33A3D86198F81863A15E04632C9D737
padding = ECD9B8E57F405F4DA52369ED
tmp_aes_key = 1EF31FDD893F3FC4802877BC105FC0B01A14753EEFF15E0BA1913BA164820A34
tmp_aes_iv = 5AF4537C03BE9A55811DD73015B491B2EDE87FD1499AD57E1C7F0C81E7A08A34</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 45D326B8F0CCBA2FEE4F2B8F8F1098F45B851027507B03D61DD7A6341B66F97E8B4B504B8161652687947B7735C13192D5076BDBA37B76D33EA1E55581F22C348F4B4139B8D55729BE66CDDEAE811F677018109FB1AC1A4EA6164FBA0B1418E29A331BFEFB7CBE7A835D17082DAF985193ECC1EBBDCAD055C147290B3D28B89C095382F9A81A0E72AC7035D402A9F40A5D5880EB4916C8175FCC6B8E2C29416320DE75D84FED182F9EF42EF6EC5BED09999703F9854390892051FEF25B7D27F5844A18DFA7C09AEB75D88223DFFB418B1740A5E31058F77839E1E801D3DCA237F29381F47DFDB3318F7899DFE267C879496DED11C2F405D1CBE93280B44E768BF4A2F030B1900DB1409C06615A2B8F092E3FB1518D98355A4EE5DB0C1BC487ADA77A06D9C3171B9ECD7E59CD47ABF017832E26B91264B3BC4302FD5FFE98408966395BB437254DE26D7989A4AD957909</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 18 61 0B 00 71 F5 22 65
0010 | 78 01 00 00 1F 5F 04 F5 58 C2 89 3D 19 63 D1 36
0020 | 4C 49 F9 69 1D 09 67 FA 54 54 54 07 99 FB 06 6A
0030 | D9 0A E7 F9 A5 F7 E0 48 FE 50 01 00 45 D3 26 B8
0040 | F0 CC BA 2F EE 4F 2B 8F 8F 10 98 F4 5B 85 10 27
0050 | 50 7B 03 D6 1D D7 A6 34 1B 66 F9 7E 8B 4B 50 4B
0060 | 81 61 65 26 87 94 7B 77 35 C1 31 92 D5 07 6B DB
0070 | A3 7B 76 D3 3E A1 E5 55 81 F2 2C 34 8F 4B 41 39
0080 | B8 D5 57 29 BE 66 CD DE AE 81 1F 67 70 18 10 9F
0090 | B1 AC 1A 4E A6 16 4F BA 0B 14 18 E2 9A 33 1B FE
00A0 | FB 7C BE 7A 83 5D 17 08 2D AF 98 51 93 EC C1 EB
00B0 | BD CA D0 55 C1 47 29 0B 3D 28 B8 9C 09 53 82 F9
00C0 | A8 1A 0E 72 AC 70 35 D4 02 A9 F4 0A 5D 58 80 EB
00D0 | 49 16 C8 17 5F CC 6B 8E 2C 29 41 63 20 DE 75 D8
00E0 | 4F ED 18 2F 9E F4 2E F6 EC 5B ED 09 99 97 03 F9
00F0 | 85 43 90 89 20 51 FE F2 5B 7D 27 F5 84 4A 18 DF
0100 | A7 C0 9A EB 75 D8 82 23 DF FB 41 8B 17 40 A5 E3
0110 | 10 58 F7 78 39 E1 E8 01 D3 DC A2 37 F2 93 81 F4
0120 | 7D FD B3 31 8F 78 99 DF E2 67 C8 79 49 6D ED 11
0130 | C2 F4 05 D1 CB E9 32 80 B4 4E 76 8B F4 A2 F0 30
0140 | B1 90 0D B1 40 9C 06 61 5A 2B 8F 09 2E 3F B1 51
0150 | 8D 98 35 5A 4E E5 DB 0C 1B C4 87 AD A7 7A 06 D9
0160 | C3 17 1B 9E CD 7E 59 CD 47 AB F0 17 83 2E 26 B9
0170 | 12 64 B3 BC 43 02 FD 5F FE 98 40 89 66 39 5B B4
0180 | 37 25 4D E2 6D 79 89 A4 AD 95 79 09</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>18610B0071F52265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010045D326B8F0CCBA2FEE4F2B8F</code> <code>8F1098F45B851027507B03D61DD7A634</code> <code>1B66F97E8B4B504B8161652687947B77</code> <code>35C13192D5076BDBA37B76D33EA1E555</code> <code>81F22C348F4B4139B8D55729BE66CDDE</code> <code>AE811F677018109FB1AC1A4EA6164FBA</code> <code>0B1418E29A331BFEFB7CBE7A835D1708</code> <code>2DAF985193ECC1EBBDCAD055C147290B</code> <code>3D28B89C095382F9A81A0E72AC7035D4</code> <code>02A9F40A5D5880EB4916C8175FCC6B8E</code> <code>2C29416320DE75D84FED182F9EF42EF6</code> <code>EC5BED09999703F9854390892051FEF2</code> <code>5B7D27F5844A18DFA7C09AEB75D88223</code> <code>DFFB418B1740A5E31058F77839E1E801</code> <code>D3DCA237F29381F47DFDB3318F7899DF</code> <code>E267C879496DED11C2F405D1CBE93280</code> <code>B44E768BF4A2F030B1900DB1409C0661</code> <code>5A2B8F092E3FB1518D98355A4EE5DB0C</code> <code>1BC487ADA77A06D9C3171B9ECD7E59CD</code> <code>47ABF017832E26B91264B3BC4302FD5F</code> <code>FE98408966395BB437254DE26D7989A4</code><br> <code>AD957909</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 4956DE0A117E360E7E8C90B071E36CBB7E87D584BA43D5B11E3F8B256B71CD411531237092606FDB1E43DFC9AFE5AEA404BC70DBCFED48DEC78978D8A7ABB71C723E1C9C39B70B9AE10ED76F884A58B4486B6A7539AFCBA0A64FFDB8A5D8DD8879DCC83DF0A66EA0769E17DE2B0F883A8554183F145397DABD927628C0D51BDED2210281224BAFC8D73728DE4C8A228D22C6158F7CBDCF0E0017C21D593F038481E5B3EE7C35B7046D4267AB6827FD636B94090F434C3DB47D4341BC7D10DA2ADBA037CA539173EB1F441CCF2D73AD0E8AE83EF611ACE77B42D87F201C02F39E5EF06569D686E9322DEF58E51F9AE9FF1A8B6F4D9F53EED73F9D6DADB1760E4D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 28 AB 2E 72 F5 22 65
0010 | A4 00 00 00 34 F7 CB 3B 58 C2 89 3D 19 63 D1 36
0020 | 4C 49 F9 69 1D 09 67 FA 54 54 54 07 99 FB 06 6A
0030 | D9 0A E7 F9 A5 F7 E0 48 64 28 4A BB 5E 5C 33 0A
0040 | 2B 7E D3 31 26 77 06 B5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0128AB2E72F52265</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A4000000</code> (164 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>58C2893D1963D1364C49F9691D0967FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>5454540799FB066AD90AE7F9A5F7E048</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>64284ABB5E5C330A2B7ED331267706B5</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)">Twitter</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

