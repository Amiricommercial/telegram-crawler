<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 DC 01 00 E4 97 3A 65
0010 | 14 00 00 00 F1 8E 7E BE 3F E0 76 CF 55 FF 9F 84
0020 | 87 51 A6 62 1D FA F4 B6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B0DC0100E4973A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 18 07 61 E0 97 3A 65
0010 | 54 00 00 00 63 24 16 05 3F E0 76 CF 55 FF 9F 84
0020 | 87 51 A6 62 1D FA F4 B6 72 25 BE E1 1E B0 B4 BF
0030 | 6F D2 72 17 47 13 67 68 08 2D 76 90 4E E2 A0 A8
0040 | 2B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01180761E0973A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082D76904EE2A0A82B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3275964447442642987</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3275964447442642987</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3275964447442642987 = 1736345431 * 1886700877</code></p>
<pre><code>p = 1736345431
q = 1886700877</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2D 76 90 4E E2 A0 A8 2B 00 00 00
0010 | 04 67 7E 87 57 00 00 00 04 70 74 C5 4D 00 00 00
0020 | 3F E0 76 CF 55 FF 9F 84 87 51 A6 62 1D FA F4 B6
0030 | 72 25 BE E1 1E B0 B4 BF 6F D2 72 17 47 13 67 68
0040 | FB 51 96 8E FC 10 36 E0 DC DF 4F 69 7E 34 74 C2
0050 | D4 D5 65 5A 55 7F A3 AB AE 47 80 60 A6 37 12 8F
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082D76904EE2A0A82B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3275964447442642987</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04677E8757000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1736345431</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047074C54D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1886700877</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>FB51968EFC1036E0DCDF4F697E3474C2</code> <code>D4D5655A557FA3ABAE478060A637128F</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082D76904EE2A0A82B00000004677E8757000000047074C54D0000003FE076CF55FF9F848751A6621DFAF4B67225BEE11EB0B4BF6FD2721747136768FB51968EFC1036E0DCDF4F697E3474C2D4D5655A557FA3ABAE478060A637128F02000000
random_padding_bytes = B60FE699BB883EF0C6A7A85A8F1360974EF556C24DE11B9EF09B2AC07C1AC0E429EFA3BDDD9278DA1B28A7997723B06E989D4954512CC71D95114522DED3697BEA97B070BEF64A8D3ACAA383C076FB94C603861D45972A5B722A41A1</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 6924E88772F171A95F8A92F5F1594306FE429FA9BE439F4F0CB8004708053F30BC78A0DB5FFB9E37DA3CC60C6BE5D932D2B0953BBA633B2491F18D9560791C61D9F6927F0F4DDB14166889648A2706E6E3A79D7131B84DF9661B923347D6770B77C788FC28CB5C015D154BAD1B5D9872D4A09794660802A6C1743AE388F0C434E929684CBFF5A87CB93E568F806D38251733EDF30DD4160B89C6E6D5D4AB8DB5B6E178E6E175CDA2C594B632FBB97F2D91A32FEEA244C49A7D83D05EAB657017FFA33447F08326504D3406304B78552416377F9ED1F69C4A251416E530FBD5D702A6975C3AEB67EBA4521AFF1C8C246BB0B261932EDBA43F2BF8375244A26D06</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 60 31 0B 00 E4 97 3A 65
0010 | 40 01 00 00 BE E4 12 D7 3F E0 76 CF 55 FF 9F 84
0020 | 87 51 A6 62 1D FA F4 B6 72 25 BE E1 1E B0 B4 BF
0030 | 6F D2 72 17 47 13 67 68 04 67 7E 87 57 00 00 00
0040 | 04 70 74 C5 4D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 69 24 E8 87 72 F1 71 A9 5F 8A 92 F5
0060 | F1 59 43 06 FE 42 9F A9 BE 43 9F 4F 0C B8 00 47
0070 | 08 05 3F 30 BC 78 A0 DB 5F FB 9E 37 DA 3C C6 0C
0080 | 6B E5 D9 32 D2 B0 95 3B BA 63 3B 24 91 F1 8D 95
0090 | 60 79 1C 61 D9 F6 92 7F 0F 4D DB 14 16 68 89 64
00A0 | 8A 27 06 E6 E3 A7 9D 71 31 B8 4D F9 66 1B 92 33
00B0 | 47 D6 77 0B 77 C7 88 FC 28 CB 5C 01 5D 15 4B AD
00C0 | 1B 5D 98 72 D4 A0 97 94 66 08 02 A6 C1 74 3A E3
00D0 | 88 F0 C4 34 E9 29 68 4C BF F5 A8 7C B9 3E 56 8F
00E0 | 80 6D 38 25 17 33 ED F3 0D D4 16 0B 89 C6 E6 D5
00F0 | D4 AB 8D B5 B6 E1 78 E6 E1 75 CD A2 C5 94 B6 32
0100 | FB B9 7F 2D 91 A3 2F EE A2 44 C4 9A 7D 83 D0 5E
0110 | AB 65 70 17 FF A3 34 47 F0 83 26 50 4D 34 06 30
0120 | 4B 78 55 24 16 37 7F 9E D1 F6 9C 4A 25 14 16 E5
0130 | 30 FB D5 D7 02 A6 97 5C 3A EB 67 EB A4 52 1A FF
0140 | 1C 8C 24 6B B0 B2 61 93 2E DB A4 3F 2B F8 37 52
0150 | 44 A2 6D 06</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>60310B00E4973A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04677E8757000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1736345431</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047074C54D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1886700877</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001006924E88772F171A95F8A92F5</code> <code>F1594306FE429FA9BE439F4F0CB80047</code> <code>08053F30BC78A0DB5FFB9E37DA3CC60C</code> <code>6BE5D932D2B0953BBA633B2491F18D95</code> <code>60791C61D9F6927F0F4DDB1416688964</code> <code>8A2706E6E3A79D7131B84DF9661B9233</code> <code>47D6770B77C788FC28CB5C015D154BAD</code> <code>1B5D9872D4A09794660802A6C1743AE3</code> <code>88F0C434E929684CBFF5A87CB93E568F</code> <code>806D38251733EDF30DD4160B89C6E6D5</code> <code>D4AB8DB5B6E178E6E175CDA2C594B632</code> <code>FBB97F2D91A32FEEA244C49A7D83D05E</code> <code>AB657017FFA33447F08326504D340630</code> <code>4B78552416377F9ED1F69C4A251416E5</code> <code>30FBD5D702A6975C3AEB67EBA4521AFF</code> <code>1C8C246BB0B261932EDBA43F2BF83752</code><br> <code>44A26D06</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 1C E7 FE E0 97 3A 65
0010 | E8 02 00 00 5C 07 E8 D0 3F E0 76 CF 55 FF 9F 84
0020 | 87 51 A6 62 1D FA F4 B6 72 25 BE E1 1E B0 B4 BF
0030 | 6F D2 72 17 47 13 67 68 FE 50 02 00 0A 66 A3 22
0040 | EC E3 E3 1F F9 21 41 41 F0 BE C8 FE 93 F7 2F 3D
0050 | A1 D8 16 F7 12 41 32 1C A7 4B 60 68 7B CA F7 B5
0060 | 79 D9 C2 DA 54 70 B5 49 16 00 F5 01 06 86 71 97
0070 | 8C 8E 34 5B 2F 56 34 43 97 2F A1 9D 8B 1A EF 59
0080 | 6A 7C C2 B3 77 73 4E 92 A3 78 9F 41 32 6F 8F 8D
0090 | 22 F2 15 74 77 00 05 65 06 15 81 9A E3 19 3F 65
00A0 | 81 8B 06 D5 73 D4 88 94 8B 1B C3 2E F6 DF 70 58
00B0 | 8F 01 3F 11 4E 10 65 B2 33 6D 05 55 4C 76 5E 8A
00C0 | 9A A4 38 90 F8 F4 DE 1C AE D6 DD 44 EF C0 A5 6C
00D0 | 7B A0 54 B3 05 F9 A6 DE A4 27 68 E7 72 57 CC FD
00E0 | 62 3E 1D 66 48 B7 0B 30 2D 63 5C B9 EB D0 E1 21
00F0 | 28 99 88 63 D0 67 2E B2 FC B1 C1 36 D5 80 A9 2C
0100 | 8B FD 8D 37 FA 79 10 43 C6 19 BB A9 FF AD A7 13
0110 | 7B EC 21 75 75 8C 51 3A 33 39 01 A7 7B 69 50 32
0120 | FC 72 A7 F1 92 14 C2 3C 18 0D B6 51 C4 AD BB 19
0130 | C5 6E 32 13 C0 04 78 10 62 4A B0 8A 4B 13 26 E9
0140 | EC 5C 3C 7C 41 59 50 15 00 BC 49 D0 CF 81 15 E2
0150 | FE 54 FD 0F AD 25 A0 E0 B8 99 BC F8 EE 7A FB E0
0160 | 41 D2 8C 21 69 9D 62 71 31 99 B6 78 7B 74 DC 6B
0170 | 7C A8 5E FB 7C F2 92 4F 9F 4D 0B 4D 6A EE 49 8D
0180 | 68 EC 42 77 28 17 5F D1 17 A5 86 F9 4B A2 53 7F
0190 | A5 73 EF 4D E8 31 D7 77 BC 59 C9 20 F0 31 1C EF
01A0 | 30 13 70 DD C6 4C 72 10 65 A9 64 CA E9 99 9C D9
01B0 | CE CA C3 DC A1 AE 74 81 80 AE F6 F9 61 84 AC 92
01C0 | FE 07 3C 84 97 DB 88 D8 10 BC 5F FF 14 5B 8B 38
01D0 | CB 1B E0 60 FF 66 AD AB 00 2C D4 73 49 ED EA CA
01E0 | 3A 27 D2 62 EC E6 40 40 EB 8E 16 82 7B FB FF 76
01F0 | F3 13 4B 3A 87 E2 D5 03 14 D1 7D AB B5 89 BE 54
0200 | 2C 71 7F BA 17 34 CF 11 5A 32 09 98 65 7B D5 1E
0210 | 33 B9 A9 29 58 A9 F3 7C 79 36 62 13 DF B5 C9 23
0220 | 3D 8C 49 25 C7 66 EB 2F FB 70 95 39 2F B9 30 D6
0230 | F1 B9 97 38 7C 75 96 5A 24 F4 D6 C8 F9 0C 2D 85
0240 | 4F C5 26 2A 63 68 23 69 75 B9 F8 A8 88 06 5F 47
0250 | 7C ED B9 B3 37 C2 7B DE 8E 23 1E FB 09 C4 7B 2F
0260 | D5 27 4B 08 EF 43 8E BA 45 5A 63 81 6F 51 7B FA
0270 | 38 84 E8 A2 C1 3B 95 F1 3D B9 79 29 1F 1F DC 8F
0280 | 50 A5 15 0F 4E 97 AC 24 71 81 3C 7C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>011CE7FEE0973A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>E8020000</code> (744 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002000A66A322ECE3E31FF9214141</code> <code>F0BEC8FE93F72F3DA1D816F71241321C</code> <code>A74B60687BCAF7B579D9C2DA5470B549</code> <code>1600F501068671978C8E345B2F563443</code> <code>972FA19D8B1AEF596A7CC2B377734E92</code> <code>A3789F41326F8F8D22F2157477000565</code> <code>0615819AE3193F65818B06D573D48894</code> <code>8B1BC32EF6DF70588F013F114E1065B2</code> <code>336D05554C765E8A9AA43890F8F4DE1C</code> <code>AED6DD44EFC0A56C7BA054B305F9A6DE</code> <code>A42768E77257CCFD623E1D6648B70B30</code> <code>2D635CB9EBD0E12128998863D0672EB2</code> <code>FCB1C136D580A92C8BFD8D37FA791043</code> <code>C619BBA9FFADA7137BEC2175758C513A</code> <code>333901A77B695032FC72A7F19214C23C</code> <code>180DB651C4ADBB19C56E3213C0047810</code> <code>624AB08A4B1326E9EC5C3C7C41595015</code> <code>00BC49D0CF8115E2FE54FD0FAD25A0E0</code> <code>B899BCF8EE7AFBE041D28C21699D6271</code> <code>3199B6787B74DC6B7CA85EFB7CF2924F</code> <code>9F4D0B4D6AEE498D68EC427728175FD1</code> <code>17A586F94BA2537FA573EF4DE831D777</code> <code>BC59C920F0311CEF301370DDC64C7210</code> <code>65A964CAE9999CD9CECAC3DCA1AE7481</code> <code>80AEF6F96184AC92FE073C8497DB88D8</code> <code>10BC5FFF145B8B38CB1BE060FF66ADAB</code> <code>002CD47349EDEACA3A27D262ECE64040</code> <code>EB8E16827BFBFF76F3134B3A87E2D503</code> <code>14D17DABB589BE542C717FBA1734CF11</code> <code>5A320998657BD51E33B9A92958A9F37C</code> <code>79366213DFB5C9233D8C4925C766EB2F</code> <code>FB7095392FB930D6F1B997387C75965A</code> <code>24F4D6C8F90C2D854FC5262A63682369</code> <code>75B9F8A888065F477CEDB9B337C27BDE</code> <code>8E231EFB09C47B2FD5274B08EF438EBA</code> <code>455A63816F517BFA3884E8A2C13B95F1</code> <code>3DB979291F1FDC8F50A5150F4E97AC24</code><br> <code>71813C7C</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 0A66A322ECE3E31FF9214141F0BEC8FE93F72F3DA1D816F71241321CA74B60687BCAF7B579D9C2DA5470B5491600F501068671978C8E345B2F563443972FA19D8B1AEF596A7CC2B377734E92A3789F41326F8F8D22F21574770005650615819AE3193F65818B06D573D488948B1BC32EF6DF70588F013F114E1065B2336D05554C765E8A9AA43890F8F4DE1CAED6DD44EFC0A56C7BA054B305F9A6DEA42768E77257CCFD623E1D6648B70B302D635CB9EBD0E12128998863D0672EB2FCB1C136D580A92C8BFD8D37FA791043C619BBA9FFADA7137BEC2175758C513A333901A77B695032FC72A7F19214C23C180DB651C4ADBB19C56E3213C0047810624AB08A4B1326E9EC5C3C7C4159501500BC49D0CF8115E2FE54FD0FAD25A0E0B899BCF8EE7AFBE041D28C21699D62713199B6787B74DC6B7CA85EFB7CF2924F9F4D0B4D6AEE498D68EC427728175FD117A586F94BA2537FA573EF4DE831D777BC59C920F0311CEF301370DDC64C721065A964CAE9999CD9CECAC3DCA1AE748180AEF6F96184AC92FE073C8497DB88D810BC5FFF145B8B38CB1BE060FF66ADAB002CD47349EDEACA3A27D262ECE64040EB8E16827BFBFF76F3134B3A87E2D50314D17DABB589BE542C717FBA1734CF115A320998657BD51E33B9A92958A9F37C79366213DFB5C9233D8C4925C766EB2FFB7095392FB930D6F1B997387C75965A24F4D6C8F90C2D854FC5262A6368236975B9F8A888065F477CEDB9B337C27BDE8E231EFB09C47B2FD5274B08EF438EBA455A63816F517BFA3884E8A2C13B95F13DB979291F1FDC8F50A5150F4E97AC2471813C7C
tmp_aes_key = D7F10579D845F23B0890169D6EE870E5B8A2D06772E0F57197C4CB2235893E6C
tmp_aes_iv = BDC459CF6ACB4C9770EE42F9AF0822E1A2D7B537AB4F7B8D54163B62FB51968E</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = FAD90E806814194681B0D8680BE3CAECA8D42D2FBA0D89B53FE076CF55FF9F848751A6621DFAF4B67225BEE11EB0B4BF6FD272174713676803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004DFF29C1AE8B4835E8296AA78F4554EF153A5A3F9AF51BD75745AB36FFC015860891E9BA438036FD0B3EEAEE319E4D462AE7B168481CD087E4429EC680D3599891CC717FA0C833EEAD5BF8B35F85F61159BC818CE1342030B27CDC4F061B607EC97419AAE95DDF1DE355ED834AAD39627D6989A86166CEA2C5ED4AB3D9A177E6552D39C0EB8402F5F62A2AA14EB28BDD4DE11B5252A4FBE7A0B3BD2943C2DB2DCADDF73CCE36A24E4EF2ADEBFBFC4D641419C43625DF673AA8031F994793ED2EAC8C491F3F93D6AE5621DFACC1DB1F6704AF17C789226860CB5C5A6BBC23A2605EF240588F58FC08DCDB8A233C577F41C68A0AF443B9A940466207B6DC61BD25E0973A65B431437C47CF5365
answer = BA0D89B53FE076CF55FF9F848751A6621DFAF4B67225BEE11EB0B4BF6FD272174713676803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004DFF29C1AE8B4835E8296AA78F4554EF153A5A3F9AF51BD75745AB36FFC015860891E9BA438036FD0B3EEAEE319E4D462AE7B168481CD087E4429EC680D3599891CC717FA0C833EEAD5BF8B35F85F61159BC818CE1342030B27CDC4F061B607EC97419AAE95DDF1DE355ED834AAD39627D6989A86166CEA2C5ED4AB3D9A177E6552D39C0EB8402F5F62A2AA14EB28BDD4DE11B5252A4FBE7A0B3BD2943C2DB2DCADDF73CCE36A24E4EF2ADEBFBFC4D641419C43625DF673AA8031F994793ED2EAC8C491F3F93D6AE5621DFACC1DB1F6704AF17C789226860CB5C5A6BBC23A2605EF240588F58FC08DCDB8A233C577F41C68A0AF443B9A940466207B6DC61BD25E0973A65B431437C47CF5365</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 3F E0 76 CF 55 FF 9F 84 87 51 A6 62
0010 | 1D FA F4 B6 72 25 BE E1 1E B0 B4 BF 6F D2 72 17
0020 | 47 13 67 68 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 4D FF 29 C1 AE 8B 48 35 E8 29 6A A7 8F 45 54 EF
0140 | 15 3A 5A 3F 9A F5 1B D7 57 45 AB 36 FF C0 15 86
0150 | 08 91 E9 BA 43 80 36 FD 0B 3E EA EE 31 9E 4D 46
0160 | 2A E7 B1 68 48 1C D0 87 E4 42 9E C6 80 D3 59 98
0170 | 91 CC 71 7F A0 C8 33 EE AD 5B F8 B3 5F 85 F6 11
0180 | 59 BC 81 8C E1 34 20 30 B2 7C DC 4F 06 1B 60 7E
0190 | C9 74 19 AA E9 5D DF 1D E3 55 ED 83 4A AD 39 62
01A0 | 7D 69 89 A8 61 66 CE A2 C5 ED 4A B3 D9 A1 77 E6
01B0 | 55 2D 39 C0 EB 84 02 F5 F6 2A 2A A1 4E B2 8B DD
01C0 | 4D E1 1B 52 52 A4 FB E7 A0 B3 BD 29 43 C2 DB 2D
01D0 | CA DD F7 3C CE 36 A2 4E 4E F2 AD EB FB FC 4D 64
01E0 | 14 19 C4 36 25 DF 67 3A A8 03 1F 99 47 93 ED 2E
01F0 | AC 8C 49 1F 3F 93 D6 AE 56 21 DF AC C1 DB 1F 67
0200 | 04 AF 17 C7 89 22 68 60 CB 5C 5A 6B BC 23 A2 60
0210 | 5E F2 40 58 8F 58 FC 08 DC DB 8A 23 3C 57 7F 41
0220 | C6 8A 0A F4 43 B9 A9 40 46 62 07 B6 DC 61 BD 25
0230 | E0 97 3A 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001004DFF29C1AE8B4835E8296AA7</code> <code>8F4554EF153A5A3F9AF51BD75745AB36</code> <code>FFC015860891E9BA438036FD0B3EEAEE</code> <code>319E4D462AE7B168481CD087E4429EC6</code> <code>80D3599891CC717FA0C833EEAD5BF8B3</code> <code>5F85F61159BC818CE1342030B27CDC4F</code> <code>061B607EC97419AAE95DDF1DE355ED83</code> <code>4AAD39627D6989A86166CEA2C5ED4AB3</code> <code>D9A177E6552D39C0EB8402F5F62A2AA1</code> <code>4EB28BDD4DE11B5252A4FBE7A0B3BD29</code> <code>43C2DB2DCADDF73CCE36A24E4EF2ADEB</code> <code>FBFC4D641419C43625DF673AA8031F99</code> <code>4793ED2EAC8C491F3F93D6AE5621DFAC</code> <code>C1DB1F6704AF17C789226860CB5C5A6B</code> <code>BC23A2605EF240588F58FC08DCDB8A23</code> <code>3C577F41C68A0AF443B9A940466207B6</code><br> <code>DC61BD25</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E0973A65</code> (1698338784 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = EF0839CEF61C5CBC1254441347CA1DFC59F87BB1EFEF0EACD64EB31FCF33FABBD0A6596A2E26622672520B76B8843E80BC81C615421124CDD566274BF6B777D5199C753D80B1F35E290FC5E948E70025DD2E5E3F2DCDDCDCB00AE696AA174E9C474BD13A9C7A6AF1757E44346863A850912D0389916BCCB04047CA6AD7975B756C376E0B22CFF8E470A43F4DB72C45CE5A6ACD215E7F367941DA3335B73D783ED1D11565A47093F2B93C77EE635A04DC09F15C3E087D57C36F3A52763C560135BA36EAAC74C82DF3A47EA2042FE1DC457396B8A047FA4261CC4DFF969E5A27DEBE4328A201B31911980A67E1C33E2CC4DB82DA8011C36C6C8A18EABECEBF9AA9</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 60B2E6349B4EF613EDDF247CCA03D0E231FBBF9CFA0B952353C1C031AB0BB1B8AA913493D2B02EF543EDE4A68222163D9D990000A2A5168EB243071F06FAC6C24CE2B3216CBA78DAE1B202A7068E2BB90FF4274018A5E168B60AB368332123F0BB72AAD09C98B814F7DEF3E159F33345338569B64819BF5A1ABEE037E5C978B46E41688A28F30AAFC91022577B11C0EB167AC038DCA14A1C80A4DE8854D2B2664D01AA07E209C738F47DFDFA8B0956CEBCB0A53A02932E248857233E13078DB6153938C9488071E2AC2DEC328E14EC0A8A4EAC9C0C77691D04AD702510AF617CF350AF01799C3427610B4B8581196B9297CD30B5AD01F5A67EF66A0789521B73</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 3F E0 76 CF 55 FF 9F 84 87 51 A6 62
0010 | 1D FA F4 B6 72 25 BE E1 1E B0 B4 BF 6F D2 72 17
0020 | 47 13 67 68 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 60 B2 E6 34 9B 4E F6 13 ED DF 24 7C CA 03 D0 E2
0040 | 31 FB BF 9C FA 0B 95 23 53 C1 C0 31 AB 0B B1 B8
0050 | AA 91 34 93 D2 B0 2E F5 43 ED E4 A6 82 22 16 3D
0060 | 9D 99 00 00 A2 A5 16 8E B2 43 07 1F 06 FA C6 C2
0070 | 4C E2 B3 21 6C BA 78 DA E1 B2 02 A7 06 8E 2B B9
0080 | 0F F4 27 40 18 A5 E1 68 B6 0A B3 68 33 21 23 F0
0090 | BB 72 AA D0 9C 98 B8 14 F7 DE F3 E1 59 F3 33 45
00A0 | 33 85 69 B6 48 19 BF 5A 1A BE E0 37 E5 C9 78 B4
00B0 | 6E 41 68 8A 28 F3 0A AF C9 10 22 57 7B 11 C0 EB
00C0 | 16 7A C0 38 DC A1 4A 1C 80 A4 DE 88 54 D2 B2 66
00D0 | 4D 01 AA 07 E2 09 C7 38 F4 7D FD FA 8B 09 56 CE
00E0 | BC B0 A5 3A 02 93 2E 24 88 57 23 3E 13 07 8D B6
00F0 | 15 39 38 C9 48 80 71 E2 AC 2D EC 32 8E 14 EC 0A
0100 | 8A 4E AC 9C 0C 77 69 1D 04 AD 70 25 10 AF 61 7C
0110 | F3 50 AF 01 79 9C 34 27 61 0B 4B 85 81 19 6B 92
0120 | 97 CD 30 B5 AD 01 F5 A6 7E F6 6A 07 89 52 1B 73</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010060B2E6349B4EF613EDDF247C</code> <code>CA03D0E231FBBF9CFA0B952353C1C031</code> <code>AB0BB1B8AA913493D2B02EF543EDE4A6</code> <code>8222163D9D990000A2A5168EB243071F</code> <code>06FAC6C24CE2B3216CBA78DAE1B202A7</code> <code>068E2BB90FF4274018A5E168B60AB368</code> <code>332123F0BB72AAD09C98B814F7DEF3E1</code> <code>59F33345338569B64819BF5A1ABEE037</code> <code>E5C978B46E41688A28F30AAFC9102257</code> <code>7B11C0EB167AC038DCA14A1C80A4DE88</code> <code>54D2B2664D01AA07E209C738F47DFDFA</code> <code>8B0956CEBCB0A53A02932E248857233E</code> <code>13078DB6153938C9488071E2AC2DEC32</code> <code>8E14EC0A8A4EAC9C0C77691D04AD7025</code> <code>10AF617CF350AF01799C3427610B4B85</code> <code>81196B9297CD30B5AD01F5A67EF66A07</code><br> <code>89521B73</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643663FE076CF55FF9F848751A6621DFAF4B67225BEE11EB0B4BF6FD27217471367680000000000000000FE00010060B2E6349B4EF613EDDF247CCA03D0E231FBBF9CFA0B952353C1C031AB0BB1B8AA913493D2B02EF543EDE4A68222163D9D990000A2A5168EB243071F06FAC6C24CE2B3216CBA78DAE1B202A7068E2BB90FF4274018A5E168B60AB368332123F0BB72AAD09C98B814F7DEF3E159F33345338569B64819BF5A1ABEE037E5C978B46E41688A28F30AAFC91022577B11C0EB167AC038DCA14A1C80A4DE8854D2B2664D01AA07E209C738F47DFDFA8B0956CEBCB0A53A02932E248857233E13078DB6153938C9488071E2AC2DEC328E14EC0A8A4EAC9C0C77691D04AD702510AF617CF350AF01799C3427610B4B8581196B9297CD30B5AD01F5A67EF66A0789521B73
padding = CD99AFDA6E31D2E6F607A23B
tmp_aes_key = D7F10579D845F23B0890169D6EE870E5B8A2D06772E0F57197C4CB2235893E6C
tmp_aes_iv = BDC459CF6ACB4C9770EE42F9AF0822E1A2D7B537AB4F7B8D54163B62FB51968E</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = E5D36877E3E40F80E792AE657D28472BDE7B43FC569C3C40D41A77C2025FBF2E78E5EBBE4D171B07B5A30522AEF617E2848B0794D162A67EA9CF5BC48BDE68B14E0F1D7629E553629239C07FE2F1D4BD90A126041DF4C13C68B7BB50E924CCD8CE91868D912E772FC3237927873B09B87A087F47F0B1CF1B0FC5BAEAEF739D20A13C73E7FEDCD20CAF3B7A137FBB2E4504A5CBD116CF6C1D5A521AA6680791F02A8BDA3C7E638C91C5ACF2FF9EBB4BABD9C7DADFB9E6D855052F988AD49E9838537328F9BD75BF627A0B282EC12781869B9FF87469B830EF9A036AA02CCA00541620D367B61FFD084B49C9D33EA71C3878FC6CC351DB2F1DE09767F5F0041C79F07EB5EE4AB08EDEB49CE16D97E772C7AF3947C300445CE01010E80D9979E0F8F1A5493B95514E9135AE00437F9DF4873E64F91603F1C43915060F4CD881EF78742237CBD4C1D4A903145A2C7D620893</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 64 31 0B 00 E4 97 3A 65
0010 | 78 01 00 00 1F 5F 04 F5 3F E0 76 CF 55 FF 9F 84
0020 | 87 51 A6 62 1D FA F4 B6 72 25 BE E1 1E B0 B4 BF
0030 | 6F D2 72 17 47 13 67 68 FE 50 01 00 E5 D3 68 77
0040 | E3 E4 0F 80 E7 92 AE 65 7D 28 47 2B DE 7B 43 FC
0050 | 56 9C 3C 40 D4 1A 77 C2 02 5F BF 2E 78 E5 EB BE
0060 | 4D 17 1B 07 B5 A3 05 22 AE F6 17 E2 84 8B 07 94
0070 | D1 62 A6 7E A9 CF 5B C4 8B DE 68 B1 4E 0F 1D 76
0080 | 29 E5 53 62 92 39 C0 7F E2 F1 D4 BD 90 A1 26 04
0090 | 1D F4 C1 3C 68 B7 BB 50 E9 24 CC D8 CE 91 86 8D
00A0 | 91 2E 77 2F C3 23 79 27 87 3B 09 B8 7A 08 7F 47
00B0 | F0 B1 CF 1B 0F C5 BA EA EF 73 9D 20 A1 3C 73 E7
00C0 | FE DC D2 0C AF 3B 7A 13 7F BB 2E 45 04 A5 CB D1
00D0 | 16 CF 6C 1D 5A 52 1A A6 68 07 91 F0 2A 8B DA 3C
00E0 | 7E 63 8C 91 C5 AC F2 FF 9E BB 4B AB D9 C7 DA DF
00F0 | B9 E6 D8 55 05 2F 98 8A D4 9E 98 38 53 73 28 F9
0100 | BD 75 BF 62 7A 0B 28 2E C1 27 81 86 9B 9F F8 74
0110 | 69 B8 30 EF 9A 03 6A A0 2C CA 00 54 16 20 D3 67
0120 | B6 1F FD 08 4B 49 C9 D3 3E A7 1C 38 78 FC 6C C3
0130 | 51 DB 2F 1D E0 97 67 F5 F0 04 1C 79 F0 7E B5 EE
0140 | 4A B0 8E DE B4 9C E1 6D 97 E7 72 C7 AF 39 47 C3
0150 | 00 44 5C E0 10 10 E8 0D 99 79 E0 F8 F1 A5 49 3B
0160 | 95 51 4E 91 35 AE 00 43 7F 9D F4 87 3E 64 F9 16
0170 | 03 F1 C4 39 15 06 0F 4C D8 81 EF 78 74 22 37 CB
0180 | D4 C1 D4 A9 03 14 5A 2C 7D 62 08 93</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>64310B00E4973A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100E5D36877E3E40F80E792AE65</code> <code>7D28472BDE7B43FC569C3C40D41A77C2</code> <code>025FBF2E78E5EBBE4D171B07B5A30522</code> <code>AEF617E2848B0794D162A67EA9CF5BC4</code> <code>8BDE68B14E0F1D7629E553629239C07F</code> <code>E2F1D4BD90A126041DF4C13C68B7BB50</code> <code>E924CCD8CE91868D912E772FC3237927</code> <code>873B09B87A087F47F0B1CF1B0FC5BAEA</code> <code>EF739D20A13C73E7FEDCD20CAF3B7A13</code> <code>7FBB2E4504A5CBD116CF6C1D5A521AA6</code> <code>680791F02A8BDA3C7E638C91C5ACF2FF</code> <code>9EBB4BABD9C7DADFB9E6D855052F988A</code> <code>D49E9838537328F9BD75BF627A0B282E</code> <code>C12781869B9FF87469B830EF9A036AA0</code> <code>2CCA00541620D367B61FFD084B49C9D3</code> <code>3EA71C3878FC6CC351DB2F1DE09767F5</code> <code>F0041C79F07EB5EE4AB08EDEB49CE16D</code> <code>97E772C7AF3947C300445CE01010E80D</code> <code>9979E0F8F1A5493B95514E9135AE0043</code> <code>7F9DF4873E64F91603F1C43915060F4C</code> <code>D881EF78742237CBD4C1D4A903145A2C</code><br> <code>7D620893</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 698F637A5809CA6C1F8B7331C8CFF8180904A7BC15734CB112399050EB18C14F2521E9C87B9336FBCE45DFE74BC5813F49DB69D122253148ACA790213FDDA5BF7389AC05144B7E7A84615C3C56B657961A8C7460815836ED545D130C5A041FF5520E01D80B7DCDAF15F28530DC029DC448ABEC848D03B1860916E7D3E463C6713353047D5CAD7DC52FAE1D06509462F102DB8551A918C180F29D723928AFBDECD4E33F5C373F9B9B73731A138F02B10E17D8981E1955AA76666057215C56919ABF7EA6CDFBFB3CCEF0BE1ABAEC806E24ADC56B4E4D64B79A0DFB472D77E04428F48B8C46624DBA932EEF8081C066D1C033476BB5224351FA5945632A912A6444</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 74 20 B6 E1 97 3A 65
0010 | 38 00 00 00 34 F7 CB 3B 3F E0 76 CF 55 FF 9F 84
0020 | 87 51 A6 62 1D FA F4 B6 72 25 BE E1 1E B0 B4 BF
0030 | 6F D2 72 17 47 13 67 68 F6 2E 0E 16 84 ED C7 A4
0040 | A9 D5 A2 AF D5 22 C1 04</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017420B6E1973A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>38000000</code> (56 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3FE076CF55FF9F848751A6621DFAF4B6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7225BEE11EB0B4BF6FD2721747136768</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>F62E0E1684EDC7A4A9D5A2AFD522C104</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

