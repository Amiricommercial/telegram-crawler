<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 28 3E 0A 00 78 4F A0 65
0010 | 14 00 00 00 F1 8E 7E BE 0E 17 58 73 DD 4B 71 B4
0020 | 73 61 8C 49 86 79 1D C6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>283E0A00784FA065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 FA 5A 78 4F A0 65
0010 | 54 00 00 00 63 24 16 05 0E 17 58 73 DD 4B 71 B4
0020 | 73 61 8C 49 86 79 1D C6 54 19 2D 5D AA 38 2A A6
0030 | 90 7C 3C 13 BD 1F D3 CD 08 18 E1 59 B3 63 AB F3
0040 | BB 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B4FA5A784FA065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0818E159B363ABF3BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1792812753676399547</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1792812753676399547</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1792812753676399547 = 1270317553 * 1411310699</code></p>
<pre><code>p = 1270317553
q = 1411310699</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 18 E1 59 B3 63 AB F3 BB 00 00 00
0010 | 04 4B B7 81 F1 00 00 00 04 54 1E E4 6B 00 00 00
0020 | 0E 17 58 73 DD 4B 71 B4 73 61 8C 49 86 79 1D C6
0030 | 54 19 2D 5D AA 38 2A A6 90 7C 3C 13 BD 1F D3 CD
0040 | 20 D7 7E DE 15 A3 0D E5 65 B7 21 A2 56 80 BA 2C
0050 | 9F 0B 44 77 7F B9 11 BB 09 DF 31 20 8C 80 B0 00
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0818E159B363ABF3BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1792812753676399547</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044BB781F1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1270317553</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04541EE46B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1411310699</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>20D77EDE15A30DE565B721A25680BA2C</code> <code>9F0B44777FB911BB09DF31208C80B000</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90818E159B363ABF3BB000000044BB781F100000004541EE46B0000000E175873DD4B71B473618C4986791DC654192D5DAA382AA6907C3C13BD1FD3CD20D77EDE15A30DE565B721A25680BA2C9F0B44777FB911BB09DF31208C80B00002000000
random_padding_bytes = 77CF1919770EB0674BECCD5EBFA6A87454221791764C34AC169FDE7A2E8E6CE8F8777BE513B1FC1779E8ABD2804CFB17ED97A0DE2083EA5EC9C1AD0610268D211AEE3CDF9F208939345C0AC8B5124F28B5DCA61A275CCD68DEB1319E</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B9DC3292E654F9427B72339808FF067FC95D83DFB5DC01D699A8224A4B636AB1DB7BE8293BD7D558D48F85AF0C5E55BF561DCC36BD4C076930F8B59F2B39C354DCF5E3488AEFAD17A3A0FD7914963D68301A5766D6390F59C3099D6BCA1576BD5AC5B73952ADFAF2894C2E7779A0C6219FB0FA2925CCD4BE3C8E16671BC77919C7497CFA80D549C71D169EF1327F5F824D54D7954B85CAB20E9E20844AF8A3CE6B250B854EE37F20DF84ACDBACD1060CF7F3E3487811493815E5077904F7D0684FB1C7AD40DD0C5E41F81238AEF421A09003086C4143E3A0D2D4FCAF1784FBB76A405CD38C80BEE11E8158F190D888213A4B3CB4B70F19174928643EE9B281F5</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 C1 0B 00 78 4F A0 65
0010 | 40 01 00 00 BE E4 12 D7 0E 17 58 73 DD 4B 71 B4
0020 | 73 61 8C 49 86 79 1D C6 54 19 2D 5D AA 38 2A A6
0030 | 90 7C 3C 13 BD 1F D3 CD 04 4B B7 81 F1 00 00 00
0040 | 04 54 1E E4 6B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B9 DC 32 92 E6 54 F9 42 7B 72 33 98
0060 | 08 FF 06 7F C9 5D 83 DF B5 DC 01 D6 99 A8 22 4A
0070 | 4B 63 6A B1 DB 7B E8 29 3B D7 D5 58 D4 8F 85 AF
0080 | 0C 5E 55 BF 56 1D CC 36 BD 4C 07 69 30 F8 B5 9F
0090 | 2B 39 C3 54 DC F5 E3 48 8A EF AD 17 A3 A0 FD 79
00A0 | 14 96 3D 68 30 1A 57 66 D6 39 0F 59 C3 09 9D 6B
00B0 | CA 15 76 BD 5A C5 B7 39 52 AD FA F2 89 4C 2E 77
00C0 | 79 A0 C6 21 9F B0 FA 29 25 CC D4 BE 3C 8E 16 67
00D0 | 1B C7 79 19 C7 49 7C FA 80 D5 49 C7 1D 16 9E F1
00E0 | 32 7F 5F 82 4D 54 D7 95 4B 85 CA B2 0E 9E 20 84
00F0 | 4A F8 A3 CE 6B 25 0B 85 4E E3 7F 20 DF 84 AC DB
0100 | AC D1 06 0C F7 F3 E3 48 78 11 49 38 15 E5 07 79
0110 | 04 F7 D0 68 4F B1 C7 AD 40 DD 0C 5E 41 F8 12 38
0120 | AE F4 21 A0 90 03 08 6C 41 43 E3 A0 D2 D4 FC AF
0130 | 17 84 FB B7 6A 40 5C D3 8C 80 BE E1 1E 81 58 F1
0140 | 90 D8 88 21 3A 4B 3C B4 B7 0F 19 17 49 28 64 3E
0150 | E9 B2 81 F5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>44C10B00784FA065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044BB781F1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1270317553</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04541EE46B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1411310699</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B9DC3292E654F9427B723398</code> <code>08FF067FC95D83DFB5DC01D699A8224A</code> <code>4B636AB1DB7BE8293BD7D558D48F85AF</code> <code>0C5E55BF561DCC36BD4C076930F8B59F</code> <code>2B39C354DCF5E3488AEFAD17A3A0FD79</code> <code>14963D68301A5766D6390F59C3099D6B</code> <code>CA1576BD5AC5B73952ADFAF2894C2E77</code> <code>79A0C6219FB0FA2925CCD4BE3C8E1667</code> <code>1BC77919C7497CFA80D549C71D169EF1</code> <code>327F5F824D54D7954B85CAB20E9E2084</code> <code>4AF8A3CE6B250B854EE37F20DF84ACDB</code> <code>ACD1060CF7F3E3487811493815E50779</code> <code>04F7D0684FB1C7AD40DD0C5E41F81238</code> <code>AEF421A09003086C4143E3A0D2D4FCAF</code> <code>1784FBB76A405CD38C80BEE11E8158F1</code> <code>90D888213A4B3CB4B70F19174928643E</code><br> <code>E9B281F5</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 90 0F 79 4F A0 65
0010 | 88 02 00 00 5C 07 E8 D0 0E 17 58 73 DD 4B 71 B4
0020 | 73 61 8C 49 86 79 1D C6 54 19 2D 5D AA 38 2A A6
0030 | 90 7C 3C 13 BD 1F D3 CD FE 50 02 00 FF B9 4A 26
0040 | D9 0C A4 8E 60 41 CD 9A 7F 69 08 24 64 CD E8 D4
0050 | 4B 38 BD DE 77 B4 8C 03 F2 E3 D5 A0 1D 1C B5 5C
0060 | C3 3E 90 FC 1D 13 BD 47 6E 4B E5 9A 92 AB 46 49
0070 | E9 D6 E1 83 FE 25 EA 74 D4 FF 75 C4 F1 0E D7 DC
0080 | 18 64 33 38 BF 6C 98 26 65 71 BC 28 9D 85 9C 3F
0090 | 8C 4C 45 78 C0 D8 70 ED 94 10 90 EE 57 0A D2 7D
00A0 | B3 7F F1 5B F8 3D BC FC 0C 25 70 EE 38 DC 45 2B
00B0 | CE 7B 02 75 FC 0D 22 86 14 3D 8A 61 B2 BC 82 CA
00C0 | 61 DC E7 6A 0C 9E 8E 47 7D C1 C2 3B 17 99 00 19
00D0 | 5D 36 43 60 64 01 CF 7A 15 87 1E BB AC 6C 5E 0B
00E0 | D5 2B DB B0 4D 5C 72 00 0E 4D 7D 8C 18 E6 32 E2
00F0 | F0 B4 95 A4 BF 3C 30 B7 FB 7B B1 1F 10 27 3D 3A
0100 | 03 92 56 6D A2 00 D9 E2 26 3F AF 67 38 33 FE 28
0110 | DA AA 61 F0 A2 84 81 41 0F 87 D6 78 78 CD C0 00
0120 | 62 6E A5 40 E9 30 84 2E E7 76 F1 D3 0A 02 A1 0D
0130 | 93 D2 EB ED 3E 56 3D 3B 58 D9 7B 6E 36 A3 87 61
0140 | 4D 0F 5A 0C 81 D6 9D C9 B4 07 FF 64 9C E6 53 7F
0150 | DA BB 4E 3E 95 66 68 B9 1F 81 16 EA BE B7 87 7C
0160 | 8D D8 4A 84 A9 B5 6E 46 AF EE E5 BE 59 B4 5B E1
0170 | 05 71 D3 9D 57 49 5C 9A 45 DE 87 12 22 42 C8 41
0180 | 52 64 2B 43 69 C9 F3 68 C4 17 DC 90 53 D5 F6 18
0190 | 79 42 1F 63 4E FE 58 55 E6 AD 28 17 20 8A CC 0B
01A0 | 70 71 06 55 DC A5 8F E3 08 A9 C1 90 78 E5 9F 2C
01B0 | 78 6E 78 44 7C D5 4B B1 81 CF E8 3E F4 0F 4D F8
01C0 | D3 74 95 66 C2 74 94 F8 B0 18 F7 6C 94 F6 13 D8
01D0 | D5 E7 94 09 AF DE 1B AE 37 E4 1E 60 F1 D9 74 91
01E0 | 6C 61 44 38 B1 3D 30 3E 67 FB 08 7A 4E 53 D3 DA
01F0 | 80 4C AC 61 10 84 62 65 90 1E 29 91 C0 2D 34 4D
0200 | C1 5B 11 BC C8 38 7E 4F 4D B2 26 24 CE 66 81 23
0210 | B7 AF 33 6C 26 B4 0E 37 D2 6B 24 70 33 F6 E5 0C
0220 | 02 7B 19 5E B6 12 D7 24 D1 A3 90 6E FA 88 53 AF
0230 | BE 04 2B 5A 49 49 AE 1D FD B2 82 C9 9A 78 B2 CE
0240 | 4F 4D F1 82 12 DA F0 38 41 71 8A 12 07 CC E3 58
0250 | 05 02 98 DF 6A AA 00 BD E2 E0 ED 5E E8 07 74 75
0260 | 6B A3 45 1C 27 6F 6A 49 31 0C 85 2C 04 F5 0E 00
0270 | FE E2 AD B1 BA 91 C7 77 24 BA 04 52 2E 92 B4 06
0280 | C5 DD 5B B6 D4 60 C3 44 A0 25 8B FB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E8900F794FA065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>88020000</code> (648 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200FFB94A26D90CA48E6041CD9A</code> <code>7F69082464CDE8D44B38BDDE77B48C03</code> <code>F2E3D5A01D1CB55CC33E90FC1D13BD47</code> <code>6E4BE59A92AB4649E9D6E183FE25EA74</code> <code>D4FF75C4F10ED7DC18643338BF6C9826</code> <code>6571BC289D859C3F8C4C4578C0D870ED</code> <code>941090EE570AD27DB37FF15BF83DBCFC</code> <code>0C2570EE38DC452BCE7B0275FC0D2286</code> <code>143D8A61B2BC82CA61DCE76A0C9E8E47</code> <code>7DC1C23B179900195D3643606401CF7A</code> <code>15871EBBAC6C5E0BD52BDBB04D5C7200</code> <code>0E4D7D8C18E632E2F0B495A4BF3C30B7</code> <code>FB7BB11F10273D3A0392566DA200D9E2</code> <code>263FAF673833FE28DAAA61F0A2848141</code> <code>0F87D67878CDC000626EA540E930842E</code> <code>E776F1D30A02A10D93D2EBED3E563D3B</code> <code>58D97B6E36A387614D0F5A0C81D69DC9</code> <code>B407FF649CE6537FDABB4E3E956668B9</code> <code>1F8116EABEB7877C8DD84A84A9B56E46</code> <code>AFEEE5BE59B45BE10571D39D57495C9A</code> <code>45DE87122242C84152642B4369C9F368</code> <code>C417DC9053D5F61879421F634EFE5855</code> <code>E6AD2817208ACC0B70710655DCA58FE3</code> <code>08A9C19078E59F2C786E78447CD54BB1</code> <code>81CFE83EF40F4DF8D3749566C27494F8</code> <code>B018F76C94F613D8D5E79409AFDE1BAE</code> <code>37E41E60F1D974916C614438B13D303E</code> <code>67FB087A4E53D3DA804CAC6110846265</code> <code>901E2991C02D344DC15B11BCC8387E4F</code> <code>4DB22624CE668123B7AF336C26B40E37</code> <code>D26B247033F6E50C027B195EB612D724</code> <code>D1A3906EFA8853AFBE042B5A4949AE1D</code> <code>FDB282C99A78B2CE4F4DF18212DAF038</code> <code>41718A1207CCE358050298DF6AAA00BD</code> <code>E2E0ED5EE80774756BA3451C276F6A49</code> <code>310C852C04F50E00FEE2ADB1BA91C777</code> <code>24BA04522E92B406C5DD5BB6D460C344</code><br> <code>A0258BFB</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = FFB94A26D90CA48E6041CD9A7F69082464CDE8D44B38BDDE77B48C03F2E3D5A01D1CB55CC33E90FC1D13BD476E4BE59A92AB4649E9D6E183FE25EA74D4FF75C4F10ED7DC18643338BF6C98266571BC289D859C3F8C4C4578C0D870ED941090EE570AD27DB37FF15BF83DBCFC0C2570EE38DC452BCE7B0275FC0D2286143D8A61B2BC82CA61DCE76A0C9E8E477DC1C23B179900195D3643606401CF7A15871EBBAC6C5E0BD52BDBB04D5C72000E4D7D8C18E632E2F0B495A4BF3C30B7FB7BB11F10273D3A0392566DA200D9E2263FAF673833FE28DAAA61F0A28481410F87D67878CDC000626EA540E930842EE776F1D30A02A10D93D2EBED3E563D3B58D97B6E36A387614D0F5A0C81D69DC9B407FF649CE6537FDABB4E3E956668B91F8116EABEB7877C8DD84A84A9B56E46AFEEE5BE59B45BE10571D39D57495C9A45DE87122242C84152642B4369C9F368C417DC9053D5F61879421F634EFE5855E6AD2817208ACC0B70710655DCA58FE308A9C19078E59F2C786E78447CD54BB181CFE83EF40F4DF8D3749566C27494F8B018F76C94F613D8D5E79409AFDE1BAE37E41E60F1D974916C614438B13D303E67FB087A4E53D3DA804CAC6110846265901E2991C02D344DC15B11BCC8387E4F4DB22624CE668123B7AF336C26B40E37D26B247033F6E50C027B195EB612D724D1A3906EFA8853AFBE042B5A4949AE1DFDB282C99A78B2CE4F4DF18212DAF03841718A1207CCE358050298DF6AAA00BDE2E0ED5EE80774756BA3451C276F6A49310C852C04F50E00FEE2ADB1BA91C77724BA04522E92B406C5DD5BB6D460C344A0258BFB
tmp_aes_key = 1FFFE377BF9B551EC5687CABFE512202A840BA0ACD44D652CA37FACEE1C6EABE
tmp_aes_iv = 00756110371E816D2703B47D2E463B47E39D899EA4B4A65B4C9AE78920D77EDE</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = E41715438B6A9A170B38FC02CA17D9B5F872552CBA0D89B50E175873DD4B71B473618C4986791DC654192D5DAA382AA6907C3C13BD1FD3CD03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100C1A3C9CC0F7C26C69F179FB484675D545D8757C9E40DA61C50673A7EEECB281F6DD8132C72E2CBE6E038B57A02822D340CD0120DECDD3FB6A2F764C9D71699131D30167225AB8ED1C8835DEB063C02F67C255CCE0AE4BB313060DD82BF42BB432F6638876C77467B9072F0D883BC41D3F42BBE25B40F0586A35B439E7E9AA56292D4670ABB95BA1C9DB092D33118C653F50C8F9A8F2E28B4A2B6BC13F525051F5BECBBDD704845D4F5EAFB4E1E235A281E24566D0EE8B8F76EB2C0B45D43D76CDE06993C13D6F5DA3C8F54836441262A275279E8E8CD80B962E1A8A8620EA574BC59C2450977D50FF9DAF3FACE7FD5227BC89AD824C86530DB97E4BB6194DC1A794FA065A945AA2D8F9383A5
answer = BA0D89B50E175873DD4B71B473618C4986791DC654192D5DAA382AA6907C3C13BD1FD3CD03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100C1A3C9CC0F7C26C69F179FB484675D545D8757C9E40DA61C50673A7EEECB281F6DD8132C72E2CBE6E038B57A02822D340CD0120DECDD3FB6A2F764C9D71699131D30167225AB8ED1C8835DEB063C02F67C255CCE0AE4BB313060DD82BF42BB432F6638876C77467B9072F0D883BC41D3F42BBE25B40F0586A35B439E7E9AA56292D4670ABB95BA1C9DB092D33118C653F50C8F9A8F2E28B4A2B6BC13F525051F5BECBBDD704845D4F5EAFB4E1E235A281E24566D0EE8B8F76EB2C0B45D43D76CDE06993C13D6F5DA3C8F54836441262A275279E8E8CD80B962E1A8A8620EA574BC59C2450977D50FF9DAF3FACE7FD5227BC89AD824C86530DB97E4BB6194DC1A794FA065A945AA2D8F9383A5</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 0E 17 58 73 DD 4B 71 B4 73 61 8C 49
0010 | 86 79 1D C6 54 19 2D 5D AA 38 2A A6 90 7C 3C 13
0020 | BD 1F D3 CD 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | C1 A3 C9 CC 0F 7C 26 C6 9F 17 9F B4 84 67 5D 54
0140 | 5D 87 57 C9 E4 0D A6 1C 50 67 3A 7E EE CB 28 1F
0150 | 6D D8 13 2C 72 E2 CB E6 E0 38 B5 7A 02 82 2D 34
0160 | 0C D0 12 0D EC DD 3F B6 A2 F7 64 C9 D7 16 99 13
0170 | 1D 30 16 72 25 AB 8E D1 C8 83 5D EB 06 3C 02 F6
0180 | 7C 25 5C CE 0A E4 BB 31 30 60 DD 82 BF 42 BB 43
0190 | 2F 66 38 87 6C 77 46 7B 90 72 F0 D8 83 BC 41 D3
01A0 | F4 2B BE 25 B4 0F 05 86 A3 5B 43 9E 7E 9A A5 62
01B0 | 92 D4 67 0A BB 95 BA 1C 9D B0 92 D3 31 18 C6 53
01C0 | F5 0C 8F 9A 8F 2E 28 B4 A2 B6 BC 13 F5 25 05 1F
01D0 | 5B EC BB DD 70 48 45 D4 F5 EA FB 4E 1E 23 5A 28
01E0 | 1E 24 56 6D 0E E8 B8 F7 6E B2 C0 B4 5D 43 D7 6C
01F0 | DE 06 99 3C 13 D6 F5 DA 3C 8F 54 83 64 41 26 2A
0200 | 27 52 79 E8 E8 CD 80 B9 62 E1 A8 A8 62 0E A5 74
0210 | BC 59 C2 45 09 77 D5 0F F9 DA F3 FA CE 7F D5 22
0220 | 7B C8 9A D8 24 C8 65 30 DB 97 E4 BB 61 94 DC 1A
0230 | 79 4F A0 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100C1A3C9CC0F7C26C69F179FB4</code> <code>84675D545D8757C9E40DA61C50673A7E</code> <code>EECB281F6DD8132C72E2CBE6E038B57A</code> <code>02822D340CD0120DECDD3FB6A2F764C9</code> <code>D71699131D30167225AB8ED1C8835DEB</code> <code>063C02F67C255CCE0AE4BB313060DD82</code> <code>BF42BB432F6638876C77467B9072F0D8</code> <code>83BC41D3F42BBE25B40F0586A35B439E</code> <code>7E9AA56292D4670ABB95BA1C9DB092D3</code> <code>3118C653F50C8F9A8F2E28B4A2B6BC13</code> <code>F525051F5BECBBDD704845D4F5EAFB4E</code> <code>1E235A281E24566D0EE8B8F76EB2C0B4</code> <code>5D43D76CDE06993C13D6F5DA3C8F5483</code> <code>6441262A275279E8E8CD80B962E1A8A8</code> <code>620EA574BC59C2450977D50FF9DAF3FA</code> <code>CE7FD5227BC89AD824C86530DB97E4BB</code><br> <code>6194DC1A</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>794FA065</code> (1705004921 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A4A3808E57E6074C4D4A95F8CAEF9916EB79931F689E615DAFEC29C6E970B040A5752D06953F368BEAD7E6C7B0C41680D825D2EDDBF08DFE4F4096A1530B570F39089020E41E68EB0C7433E6E2D0F5067F216EE76E9EAC04D3A4EB9D37C7091C981B81C1E2B2663A6D0DE5993D4366CE94C4E8F21621D9D6211E43230CFF8DD03B3F83CE6096F5AC19E851F5F7A8E3EE452421BCCE51EEA277CEBFFA3C1AD4195FCBCA57D409DE54DB93CA90BF6C161C7827304C3288D595512BD057D2514F8983028DC37DE19EB1253F895CA54C56E339204950CA9A47DDD93B907EF4E34268CDEAE4CB5323416F41A79D28654BD043C30B579FD8FDF0BA3998FF560F95D42F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B0450866F6F8FD74BDECC692983B28423443419C9A2685979EDFF423A5B5550CE02F731D94F05033A991E2ECB9A93B5D23A3EE1FD4D64C0BB638C917125D51A7224B06489930FE6050E38459AFADF89FEDC3A4FECEBC7CF3C44BC3C022064BA99281D800E27B79EF662F6CE96E72F255CB7F0BA13D802E128C629945AE96A66A104BA74608E6CDED8DE153680AB01EDD23F820F0E046FF4EA12A18FF071E6B60AE4B0EADA6F2E4A879BAA31E8D06FD68B9CAE2677F6AB7653E20B9F2985BE51D8C185A55DE0C6A36A304BC5233A7DBF8EAF67CF60EDA323B17A0848C54F46BE74A42D12FB161FB956DF4981CA09DF6D0AD73C98C5FD7F07DD3A809F1AE742674</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 0E 17 58 73 DD 4B 71 B4 73 61 8C 49
0010 | 86 79 1D C6 54 19 2D 5D AA 38 2A A6 90 7C 3C 13
0020 | BD 1F D3 CD 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B0 45 08 66 F6 F8 FD 74 BD EC C6 92 98 3B 28 42
0040 | 34 43 41 9C 9A 26 85 97 9E DF F4 23 A5 B5 55 0C
0050 | E0 2F 73 1D 94 F0 50 33 A9 91 E2 EC B9 A9 3B 5D
0060 | 23 A3 EE 1F D4 D6 4C 0B B6 38 C9 17 12 5D 51 A7
0070 | 22 4B 06 48 99 30 FE 60 50 E3 84 59 AF AD F8 9F
0080 | ED C3 A4 FE CE BC 7C F3 C4 4B C3 C0 22 06 4B A9
0090 | 92 81 D8 00 E2 7B 79 EF 66 2F 6C E9 6E 72 F2 55
00A0 | CB 7F 0B A1 3D 80 2E 12 8C 62 99 45 AE 96 A6 6A
00B0 | 10 4B A7 46 08 E6 CD ED 8D E1 53 68 0A B0 1E DD
00C0 | 23 F8 20 F0 E0 46 FF 4E A1 2A 18 FF 07 1E 6B 60
00D0 | AE 4B 0E AD A6 F2 E4 A8 79 BA A3 1E 8D 06 FD 68
00E0 | B9 CA E2 67 7F 6A B7 65 3E 20 B9 F2 98 5B E5 1D
00F0 | 8C 18 5A 55 DE 0C 6A 36 A3 04 BC 52 33 A7 DB F8
0100 | EA F6 7C F6 0E DA 32 3B 17 A0 84 8C 54 F4 6B E7
0110 | 4A 42 D1 2F B1 61 FB 95 6D F4 98 1C A0 9D F6 D0
0120 | AD 73 C9 8C 5F D7 F0 7D D3 A8 09 F1 AE 74 26 74</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B0450866F6F8FD74BDECC692</code> <code>983B28423443419C9A2685979EDFF423</code> <code>A5B5550CE02F731D94F05033A991E2EC</code> <code>B9A93B5D23A3EE1FD4D64C0BB638C917</code> <code>125D51A7224B06489930FE6050E38459</code> <code>AFADF89FEDC3A4FECEBC7CF3C44BC3C0</code> <code>22064BA99281D800E27B79EF662F6CE9</code> <code>6E72F255CB7F0BA13D802E128C629945</code> <code>AE96A66A104BA74608E6CDED8DE15368</code> <code>0AB01EDD23F820F0E046FF4EA12A18FF</code> <code>071E6B60AE4B0EADA6F2E4A879BAA31E</code> <code>8D06FD68B9CAE2677F6AB7653E20B9F2</code> <code>985BE51D8C185A55DE0C6A36A304BC52</code> <code>33A7DBF8EAF67CF60EDA323B17A0848C</code> <code>54F46BE74A42D12FB161FB956DF4981C</code> <code>A09DF6D0AD73C98C5FD7F07DD3A809F1</code><br> <code>AE742674</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643660E175873DD4B71B473618C4986791DC654192D5DAA382AA6907C3C13BD1FD3CD0000000000000000FE000100B0450866F6F8FD74BDECC692983B28423443419C9A2685979EDFF423A5B5550CE02F731D94F05033A991E2ECB9A93B5D23A3EE1FD4D64C0BB638C917125D51A7224B06489930FE6050E38459AFADF89FEDC3A4FECEBC7CF3C44BC3C022064BA99281D800E27B79EF662F6CE96E72F255CB7F0BA13D802E128C629945AE96A66A104BA74608E6CDED8DE153680AB01EDD23F820F0E046FF4EA12A18FF071E6B60AE4B0EADA6F2E4A879BAA31E8D06FD68B9CAE2677F6AB7653E20B9F2985BE51D8C185A55DE0C6A36A304BC5233A7DBF8EAF67CF60EDA323B17A0848C54F46BE74A42D12FB161FB956DF4981CA09DF6D0AD73C98C5FD7F07DD3A809F1AE742674
padding = 609205E2D6DFFF6D2AD1F1AF
tmp_aes_key = 1FFFE377BF9B551EC5687CABFE512202A840BA0ACD44D652CA37FACEE1C6EABE
tmp_aes_iv = 00756110371E816D2703B47D2E463B47E39D899EA4B4A65B4C9AE78920D77EDE</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 6F3D902000D82B725FAA60494F27CC01D48E637096772F03AD60963420D7415931E239EE3D0A8099633F10C03B897B2290050DAE9A53A7E73937A3225520525215CDACAE1BD1B5D3DA697075880B5C3E53EA0AFF40D009731DCAB2E5438FDD064301ABDE715D65D77A0ACC4B7CD53059C016A2A25E24314EC44B796D16DC777C0EC83F6DD2DB3A5CD8A488E2A521F83A6F064E25B4B0D64F8B973321DA9AE934DECB973D24C921D5395F0A4422ADCFF98AD3B4E01990E17E010F2C470AB0DFA69F83613813B64EAC0F9DC9FED0D2BE41CC179F4791550D6C921F9D12F546CC9F84A778990BBF40482BD780ED96B95B1DFC50CC627CE0DA130302AC989545083BDA1A08EC57B88EF9263408BB1D025075D4708712A55C2DFEEF274686D9043944873BBDFF7F5267AACF8C85D701A7C0835F58AB1D6D05FB3A43C5B1669BFCE45D82389F8EC1D01BC354CCBECC12040448</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 30 FB 01 00 79 4F A0 65
0010 | 78 01 00 00 1F 5F 04 F5 0E 17 58 73 DD 4B 71 B4
0020 | 73 61 8C 49 86 79 1D C6 54 19 2D 5D AA 38 2A A6
0030 | 90 7C 3C 13 BD 1F D3 CD FE 50 01 00 6F 3D 90 20
0040 | 00 D8 2B 72 5F AA 60 49 4F 27 CC 01 D4 8E 63 70
0050 | 96 77 2F 03 AD 60 96 34 20 D7 41 59 31 E2 39 EE
0060 | 3D 0A 80 99 63 3F 10 C0 3B 89 7B 22 90 05 0D AE
0070 | 9A 53 A7 E7 39 37 A3 22 55 20 52 52 15 CD AC AE
0080 | 1B D1 B5 D3 DA 69 70 75 88 0B 5C 3E 53 EA 0A FF
0090 | 40 D0 09 73 1D CA B2 E5 43 8F DD 06 43 01 AB DE
00A0 | 71 5D 65 D7 7A 0A CC 4B 7C D5 30 59 C0 16 A2 A2
00B0 | 5E 24 31 4E C4 4B 79 6D 16 DC 77 7C 0E C8 3F 6D
00C0 | D2 DB 3A 5C D8 A4 88 E2 A5 21 F8 3A 6F 06 4E 25
00D0 | B4 B0 D6 4F 8B 97 33 21 DA 9A E9 34 DE CB 97 3D
00E0 | 24 C9 21 D5 39 5F 0A 44 22 AD CF F9 8A D3 B4 E0
00F0 | 19 90 E1 7E 01 0F 2C 47 0A B0 DF A6 9F 83 61 38
0100 | 13 B6 4E AC 0F 9D C9 FE D0 D2 BE 41 CC 17 9F 47
0110 | 91 55 0D 6C 92 1F 9D 12 F5 46 CC 9F 84 A7 78 99
0120 | 0B BF 40 48 2B D7 80 ED 96 B9 5B 1D FC 50 CC 62
0130 | 7C E0 DA 13 03 02 AC 98 95 45 08 3B DA 1A 08 EC
0140 | 57 B8 8E F9 26 34 08 BB 1D 02 50 75 D4 70 87 12
0150 | A5 5C 2D FE EF 27 46 86 D9 04 39 44 87 3B BD FF
0160 | 7F 52 67 AA CF 8C 85 D7 01 A7 C0 83 5F 58 AB 1D
0170 | 6D 05 FB 3A 43 C5 B1 66 9B FC E4 5D 82 38 9F 8E
0180 | C1 D0 1B C3 54 CC BE CC 12 04 04 48</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>30FB0100794FA065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001006F3D902000D82B725FAA6049</code> <code>4F27CC01D48E637096772F03AD609634</code> <code>20D7415931E239EE3D0A8099633F10C0</code> <code>3B897B2290050DAE9A53A7E73937A322</code> <code>5520525215CDACAE1BD1B5D3DA697075</code> <code>880B5C3E53EA0AFF40D009731DCAB2E5</code> <code>438FDD064301ABDE715D65D77A0ACC4B</code> <code>7CD53059C016A2A25E24314EC44B796D</code> <code>16DC777C0EC83F6DD2DB3A5CD8A488E2</code> <code>A521F83A6F064E25B4B0D64F8B973321</code> <code>DA9AE934DECB973D24C921D5395F0A44</code> <code>22ADCFF98AD3B4E01990E17E010F2C47</code> <code>0AB0DFA69F83613813B64EAC0F9DC9FE</code> <code>D0D2BE41CC179F4791550D6C921F9D12</code> <code>F546CC9F84A778990BBF40482BD780ED</code> <code>96B95B1DFC50CC627CE0DA130302AC98</code> <code>9545083BDA1A08EC57B88EF9263408BB</code> <code>1D025075D4708712A55C2DFEEF274686</code> <code>D9043944873BBDFF7F5267AACF8C85D7</code> <code>01A7C0835F58AB1D6D05FB3A43C5B166</code> <code>9BFCE45D82389F8EC1D01BC354CCBECC</code><br> <code>12040448</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 836372FEC8DD9BB66446543B93F4B68664A8DB20C4B316663BD20E45A358679B330F0F565966B09CB96692D8077872F65ADFA664CCA8546E3F8445769DE7830E5827C820E7FEF3B46F353FB3BA70050766A0502FF3F3FCFCEEE9938AC053C8E2BFCFAC715DA9C2A4586113801DA12A4D6D6BC0DB36F09ABCABB29FCCEB713D1AE0E9CA16349CC08F0B6F78A7C1EEC03F6AD9EC4FFC87712D99731124AF1927352A3E6893AEF4951BAC5158F42AAF68E99FBF533985B7CB45EB7B3AD3047E5FACAF8B3A6AC7800E84D9258F94C058EDDF237B80DEA05A6D0C4DD631FBBEBBD1747E157C7494B064CF8A40A9FBB44D6FF55D3DB6BAF90E6C27EA8037821D2717A6</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 6F 5A 79 4F A0 65
0010 | 5C 00 00 00 34 F7 CB 3B 0E 17 58 73 DD 4B 71 B4
0020 | 73 61 8C 49 86 79 1D C6 54 19 2D 5D AA 38 2A A6
0030 | 90 7C 3C 13 BD 1F D3 CD 68 AD B5 AB 67 D6 09 BA
0040 | 7D 3F DB E1 95 EB 10 DA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01306F5A794FA065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>5C000000</code> (92 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0E175873DD4B71B473618C4986791DC6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>54192D5DAA382AA6907C3C13BD1FD3CD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>68ADB5AB67D609BA7D3FDBE195EB10DA</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

