<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E8 F0 0D 00 77 12 7B 65
0010 | 14 00 00 00 F1 8E 7E BE B8 F9 ED 7E FD ED 7E E9
0020 | 3F AD BE 6C 51 43 F6 39</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E8F00D0077127B65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 5C 90 BC 77 12 7B 65
0010 | 6C 00 00 00 63 24 16 05 B8 F9 ED 7E FD ED 7E E9
0020 | 3F AD BE 6C 51 43 F6 39 4D 54 EA 31 25 42 43 08
0030 | 9E 77 01 9C 06 A5 29 F0 08 28 64 C6 51 3F EA 5E
0040 | 97 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015C90BC77127B65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>6C000000</code> (108 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082864C6513FEA5E97000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2910669311455157911</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2910669311455157911</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2910669311455157911 = 1652536009 * 1761334879</code></p>
<pre><code>p = 1652536009
q = 1761334879</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 28 64 C6 51 3F EA 5E 97 00 00 00
0010 | 04 62 7F B2 C9 00 00 00 04 68 FB D6 5F 00 00 00
0020 | B8 F9 ED 7E FD ED 7E E9 3F AD BE 6C 51 43 F6 39
0030 | 4D 54 EA 31 25 42 43 08 9E 77 01 9C 06 A5 29 F0
0040 | 04 95 A8 C6 99 65 6E 8E 1E 82 D7 58 79 73 AD AB
0050 | 51 95 4C 4F 99 2B 0B 23 CB FE 10 B1 E6 DA 5E B7
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082864C6513FEA5E97000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2910669311455157911</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04627FB2C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1652536009</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0468FBD65F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1761334879</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>0495A8C699656E8E1E82D7587973ADAB</code> <code>51954C4F992B0B23CBFE10B1E6DA5EB7</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082864C6513FEA5E9700000004627FB2C90000000468FBD65F000000B8F9ED7EFDED7EE93FADBE6C5143F6394D54EA31254243089E77019C06A529F00495A8C699656E8E1E82D7587973ADAB51954C4F992B0B23CBFE10B1E6DA5EB702000000
random_padding_bytes = B70F17797E40020F2084C997F2FBA831F3757D853C154951DBA3A9F313689285293E6ABD665227D7D7F6DF9747964AFFD8BFE7FB449BEB40C4F3A60DB0391F8A542A103F940229C410AE127DE75A755E2D1F78D2015B7B4BFBB3E8C5</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 8CA8796C05681B04A1E690D8B70EB945B564654412521387042FCBD4D640184295D621CA9DBBB3B87A5CA2344C6C64D26C4F2652AE6C734227B966FFB030EADF791D0043E98CD9074414C3EC5E8C2E14CB40236B9A0B7533207BD76B0C967969B338C47A7931336B9D1E00B544FA1609AE240817B02922336DC0822A8329761A4F5D65ACFECE79C1379D98F45C346D07CC3F0C785B2A3A04815669B7B1050F98D96476E99637348C66022D079FDE1E40DE34B9588780530610FF5EF0360C260C8C043FEE9708CC5AE5D8F4982F063192424C3B525FEB3298F14E1CF81CD8BC90B95BF2BFDF62B21F29E086134D0ECC05FC4DCD7DF34C774472C32C82553082A0</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC F0 0D 00 77 12 7B 65
0010 | 40 01 00 00 BE E4 12 D7 B8 F9 ED 7E FD ED 7E E9
0020 | 3F AD BE 6C 51 43 F6 39 4D 54 EA 31 25 42 43 08
0030 | 9E 77 01 9C 06 A5 29 F0 04 62 7F B2 C9 00 00 00
0040 | 04 68 FB D6 5F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 8C A8 79 6C 05 68 1B 04 A1 E6 90 D8
0060 | B7 0E B9 45 B5 64 65 44 12 52 13 87 04 2F CB D4
0070 | D6 40 18 42 95 D6 21 CA 9D BB B3 B8 7A 5C A2 34
0080 | 4C 6C 64 D2 6C 4F 26 52 AE 6C 73 42 27 B9 66 FF
0090 | B0 30 EA DF 79 1D 00 43 E9 8C D9 07 44 14 C3 EC
00A0 | 5E 8C 2E 14 CB 40 23 6B 9A 0B 75 33 20 7B D7 6B
00B0 | 0C 96 79 69 B3 38 C4 7A 79 31 33 6B 9D 1E 00 B5
00C0 | 44 FA 16 09 AE 24 08 17 B0 29 22 33 6D C0 82 2A
00D0 | 83 29 76 1A 4F 5D 65 AC FE CE 79 C1 37 9D 98 F4
00E0 | 5C 34 6D 07 CC 3F 0C 78 5B 2A 3A 04 81 56 69 B7
00F0 | B1 05 0F 98 D9 64 76 E9 96 37 34 8C 66 02 2D 07
0100 | 9F DE 1E 40 DE 34 B9 58 87 80 53 06 10 FF 5E F0
0110 | 36 0C 26 0C 8C 04 3F EE 97 08 CC 5A E5 D8 F4 98
0120 | 2F 06 31 92 42 4C 3B 52 5F EB 32 98 F1 4E 1C F8
0130 | 1C D8 BC 90 B9 5B F2 BF DF 62 B2 1F 29 E0 86 13
0140 | 4D 0E CC 05 FC 4D CD 7D F3 4C 77 44 72 C3 2C 82
0150 | 55 30 82 A0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>ECF00D0077127B65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04627FB2C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1652536009</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0468FBD65F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1761334879</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001008CA8796C05681B04A1E690D8</code> <code>B70EB945B564654412521387042FCBD4</code> <code>D640184295D621CA9DBBB3B87A5CA234</code> <code>4C6C64D26C4F2652AE6C734227B966FF</code> <code>B030EADF791D0043E98CD9074414C3EC</code> <code>5E8C2E14CB40236B9A0B7533207BD76B</code> <code>0C967969B338C47A7931336B9D1E00B5</code> <code>44FA1609AE240817B02922336DC0822A</code> <code>8329761A4F5D65ACFECE79C1379D98F4</code> <code>5C346D07CC3F0C785B2A3A04815669B7</code> <code>B1050F98D96476E99637348C66022D07</code> <code>9FDE1E40DE34B9588780530610FF5EF0</code> <code>360C260C8C043FEE9708CC5AE5D8F498</code> <code>2F063192424C3B525FEB3298F14E1CF8</code> <code>1CD8BC90B95BF2BFDF62B21F29E08613</code> <code>4D0ECC05FC4DCD7DF34C774472C32C82</code><br> <code>553082A0</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 CA 74 78 12 7B 65
0010 | 78 02 00 00 5C 07 E8 D0 B8 F9 ED 7E FD ED 7E E9
0020 | 3F AD BE 6C 51 43 F6 39 4D 54 EA 31 25 42 43 08
0030 | 9E 77 01 9C 06 A5 29 F0 FE 50 02 00 EF 35 0C F0
0040 | A4 32 F0 37 F4 D2 83 5F DF F9 9B 0C F6 8C 82 16
0050 | BD 1F 40 7A 24 70 D4 68 97 D2 4E 19 A3 D7 B9 82
0060 | EE 08 BB 08 4D 1B 5F AC B2 8E 3B D9 C3 03 A8 B4
0070 | EE E8 0F 3F B1 FD AD A5 63 6C 02 B4 55 04 A9 65
0080 | AA 76 1A EC CE 3C 70 B4 12 76 64 5D 5C 0F CC 16
0090 | 15 E4 FC 46 2D 4A 0B 36 F0 C6 0E 8D 4F 5F 39 38
00A0 | A9 BE DA FF EB 5C BA DD A4 9F EE F2 0D 0F 8A 44
00B0 | 60 4E 4D 19 F3 AC 2C 00 F3 1C 2C B8 3D C7 01 61
00C0 | DB 0E 09 13 F6 B7 08 64 D1 C4 12 70 21 85 7A CF
00D0 | 7E FF FC 88 9F 6C B7 3D FF C2 38 6B 03 9E F3 F8
00E0 | 2A 35 47 9B E2 F8 C3 4F A1 66 39 E9 59 D1 3B BC
00F0 | F5 F0 6B 03 E6 E8 93 3C AF 66 0B FE 7F 7F AD D1
0100 | C7 65 B3 12 B8 CA DB 74 48 91 27 D7 7D BC E0 E8
0110 | E8 15 E9 DE 09 6F ED E0 BE 5D 57 8C 65 E0 20 14
0120 | 7C 15 37 32 E1 56 0B 55 D1 84 FE 71 BC 3F AE 52
0130 | 1F 65 2E 78 FB 13 2D 70 88 00 C2 3A 52 B3 19 26
0140 | A3 4C 72 E2 21 AC 9F 6B 01 36 70 26 83 59 15 28
0150 | 21 6E 78 D8 68 A4 21 4F F3 A8 9D 79 13 E0 9A 2C
0160 | FB 43 01 CA 14 93 13 32 FF 35 C5 ED D2 93 F1 B5
0170 | EA A3 28 CA 5D B7 FE 3F 3F 5D 9C 5D 1C 0A 0F B3
0180 | 0B 63 12 41 EB 15 DF D0 18 F6 44 C9 E8 CE 7F F7
0190 | 9A 5A DD 9E 34 15 13 B0 ED F8 9D 2D 0B 1E 8F 34
01A0 | 96 23 D5 E3 77 DC 1D F1 86 9D F2 70 87 0C 2E CF
01B0 | 17 69 BD B0 BA 63 1A 4D 31 04 80 35 CE FF 0A 45
01C0 | 50 7F AC DA CB 17 09 36 DD 2C 42 A8 1F FB A9 2D
01D0 | 4E C6 D0 E8 78 EA B5 20 08 25 67 25 3B C7 76 B8
01E0 | E2 1B F2 9C 38 93 82 17 92 C1 B5 74 C4 31 EA 1B
01F0 | FE 91 F3 9B E1 A7 B7 25 D5 BF 6F 2E F7 E3 F3 E0
0200 | 81 6C 7B CC CF F6 97 35 11 AD 68 CC 72 51 21 D9
0210 | 30 CC FB C5 E2 4E FC 9B 55 B8 43 9D 54 61 36 C4
0220 | C4 F1 50 29 38 58 74 A1 E7 D4 57 98 A7 62 81 9A
0230 | EE 49 20 66 44 41 39 88 B2 2F DE 28 48 D2 19 4C
0240 | B9 2F C9 67 C4 C8 DA 10 AD 71 82 65 92 6D 97 90
0250 | A8 D1 30 A4 84 D2 D7 17 3B 7E 84 B6 70 2B D6 01
0260 | 58 3E CB 63 98 02 2B F2 A9 1A 81 53 8B F7 BC 63
0270 | 89 BF 07 A7 F3 5D BC 68 2A F5 6E A4 1E A1 7B 6F
0280 | 81 4E 71 2A 9C 8B 45 49 E3 96 A1 31</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0138CA7478127B65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200EF350CF0A432F037F4D2835F</code> <code>DFF99B0CF68C8216BD1F407A2470D468</code> <code>97D24E19A3D7B982EE08BB084D1B5FAC</code> <code>B28E3BD9C303A8B4EEE80F3FB1FDADA5</code> <code>636C02B45504A965AA761AECCE3C70B4</code> <code>1276645D5C0FCC1615E4FC462D4A0B36</code> <code>F0C60E8D4F5F3938A9BEDAFFEB5CBADD</code> <code>A49FEEF20D0F8A44604E4D19F3AC2C00</code> <code>F31C2CB83DC70161DB0E0913F6B70864</code> <code>D1C4127021857ACF7EFFFC889F6CB73D</code> <code>FFC2386B039EF3F82A35479BE2F8C34F</code> <code>A16639E959D13BBCF5F06B03E6E8933C</code> <code>AF660BFE7F7FADD1C765B312B8CADB74</code> <code>489127D77DBCE0E8E815E9DE096FEDE0</code> <code>BE5D578C65E020147C153732E1560B55</code> <code>D184FE71BC3FAE521F652E78FB132D70</code> <code>8800C23A52B31926A34C72E221AC9F6B</code> <code>0136702683591528216E78D868A4214F</code> <code>F3A89D7913E09A2CFB4301CA14931332</code> <code>FF35C5EDD293F1B5EAA328CA5DB7FE3F</code> <code>3F5D9C5D1C0A0FB30B631241EB15DFD0</code> <code>18F644C9E8CE7FF79A5ADD9E341513B0</code> <code>EDF89D2D0B1E8F349623D5E377DC1DF1</code> <code>869DF270870C2ECF1769BDB0BA631A4D</code> <code>31048035CEFF0A45507FACDACB170936</code> <code>DD2C42A81FFBA92D4EC6D0E878EAB520</code> <code>082567253BC776B8E21BF29C38938217</code> <code>92C1B574C431EA1BFE91F39BE1A7B725</code> <code>D5BF6F2EF7E3F3E0816C7BCCCFF69735</code> <code>11AD68CC725121D930CCFBC5E24EFC9B</code> <code>55B8439D546136C4C4F15029385874A1</code> <code>E7D45798A762819AEE49206644413988</code> <code>B22FDE2848D2194CB92FC967C4C8DA10</code> <code>AD718265926D9790A8D130A484D2D717</code> <code>3B7E84B6702BD601583ECB6398022BF2</code> <code>A91A81538BF7BC6389BF07A7F35DBC68</code> <code>2AF56EA41EA17B6F814E712A9C8B4549</code><br> <code>E396A131</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = EF350CF0A432F037F4D2835FDFF99B0CF68C8216BD1F407A2470D46897D24E19A3D7B982EE08BB084D1B5FACB28E3BD9C303A8B4EEE80F3FB1FDADA5636C02B45504A965AA761AECCE3C70B41276645D5C0FCC1615E4FC462D4A0B36F0C60E8D4F5F3938A9BEDAFFEB5CBADDA49FEEF20D0F8A44604E4D19F3AC2C00F31C2CB83DC70161DB0E0913F6B70864D1C4127021857ACF7EFFFC889F6CB73DFFC2386B039EF3F82A35479BE2F8C34FA16639E959D13BBCF5F06B03E6E8933CAF660BFE7F7FADD1C765B312B8CADB74489127D77DBCE0E8E815E9DE096FEDE0BE5D578C65E020147C153732E1560B55D184FE71BC3FAE521F652E78FB132D708800C23A52B31926A34C72E221AC9F6B0136702683591528216E78D868A4214FF3A89D7913E09A2CFB4301CA14931332FF35C5EDD293F1B5EAA328CA5DB7FE3F3F5D9C5D1C0A0FB30B631241EB15DFD018F644C9E8CE7FF79A5ADD9E341513B0EDF89D2D0B1E8F349623D5E377DC1DF1869DF270870C2ECF1769BDB0BA631A4D31048035CEFF0A45507FACDACB170936DD2C42A81FFBA92D4EC6D0E878EAB520082567253BC776B8E21BF29C3893821792C1B574C431EA1BFE91F39BE1A7B725D5BF6F2EF7E3F3E0816C7BCCCFF6973511AD68CC725121D930CCFBC5E24EFC9B55B8439D546136C4C4F15029385874A1E7D45798A762819AEE49206644413988B22FDE2848D2194CB92FC967C4C8DA10AD718265926D9790A8D130A484D2D7173B7E84B6702BD601583ECB6398022BF2A91A81538BF7BC6389BF07A7F35DBC682AF56EA41EA17B6F814E712A9C8B4549E396A131
tmp_aes_key = 5028FB57D07AD7AEA070D02B26E6BDE4AB80742328D35421B99A5D37ABE9C368
tmp_aes_iv = BF6F3CBFCFD7D76DF70B881BF7C1B98C341468E67EC78092191B35790495A8C6</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 398932855BF3991F6550E2CA2D2814AD5B38B854BA0D89B5B8F9ED7EFDED7EE93FADBE6C5143F6394D54EA31254243089E77019C06A529F003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100364CFD00A68FCCB95EA58EE4109BE9E30B132F37C0D88DB92059FDF77EDE753539085094B7D23F7E4A8A7603075FFFFD8FEFF0BFFB09CFCE9D977A8617006A669B2D6CA10BF6A753A57695D22165F15E95E8A1DD02452C956B350A52B87FB08A3093DE1068147D4103279F9EDB04C46E7C5ECC7F368CDC9856D40F4C910470ECA8EBBE71C03A6505FBD54655D4874E1F1A4100535A271DF64F7ED72ECDA7EEABA90A09D10FFF8F1B4CC2620C2D133D13ACF7B655A57E1D571F2998BD3D85977253F65AE1C3D11A56FDCE791170ED80B555D8DC0FB28FBFDEC5B31EF3AAAEEA246B620A68EE28A475C9753DDC5E2AA0D372A4E353C5BEE5A84D072E39D50F900B78127B65A06FF77399181DB2
answer = BA0D89B5B8F9ED7EFDED7EE93FADBE6C5143F6394D54EA31254243089E77019C06A529F003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100364CFD00A68FCCB95EA58EE4109BE9E30B132F37C0D88DB92059FDF77EDE753539085094B7D23F7E4A8A7603075FFFFD8FEFF0BFFB09CFCE9D977A8617006A669B2D6CA10BF6A753A57695D22165F15E95E8A1DD02452C956B350A52B87FB08A3093DE1068147D4103279F9EDB04C46E7C5ECC7F368CDC9856D40F4C910470ECA8EBBE71C03A6505FBD54655D4874E1F1A4100535A271DF64F7ED72ECDA7EEABA90A09D10FFF8F1B4CC2620C2D133D13ACF7B655A57E1D571F2998BD3D85977253F65AE1C3D11A56FDCE791170ED80B555D8DC0FB28FBFDEC5B31EF3AAAEEA246B620A68EE28A475C9753DDC5E2AA0D372A4E353C5BEE5A84D072E39D50F900B78127B65A06FF77399181DB2</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 B8 F9 ED 7E FD ED 7E E9 3F AD BE 6C
0010 | 51 43 F6 39 4D 54 EA 31 25 42 43 08 9E 77 01 9C
0020 | 06 A5 29 F0 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 36 4C FD 00 A6 8F CC B9 5E A5 8E E4 10 9B E9 E3
0140 | 0B 13 2F 37 C0 D8 8D B9 20 59 FD F7 7E DE 75 35
0150 | 39 08 50 94 B7 D2 3F 7E 4A 8A 76 03 07 5F FF FD
0160 | 8F EF F0 BF FB 09 CF CE 9D 97 7A 86 17 00 6A 66
0170 | 9B 2D 6C A1 0B F6 A7 53 A5 76 95 D2 21 65 F1 5E
0180 | 95 E8 A1 DD 02 45 2C 95 6B 35 0A 52 B8 7F B0 8A
0190 | 30 93 DE 10 68 14 7D 41 03 27 9F 9E DB 04 C4 6E
01A0 | 7C 5E CC 7F 36 8C DC 98 56 D4 0F 4C 91 04 70 EC
01B0 | A8 EB BE 71 C0 3A 65 05 FB D5 46 55 D4 87 4E 1F
01C0 | 1A 41 00 53 5A 27 1D F6 4F 7E D7 2E CD A7 EE AB
01D0 | A9 0A 09 D1 0F FF 8F 1B 4C C2 62 0C 2D 13 3D 13
01E0 | AC F7 B6 55 A5 7E 1D 57 1F 29 98 BD 3D 85 97 72
01F0 | 53 F6 5A E1 C3 D1 1A 56 FD CE 79 11 70 ED 80 B5
0200 | 55 D8 DC 0F B2 8F BF DE C5 B3 1E F3 AA AE EA 24
0210 | 6B 62 0A 68 EE 28 A4 75 C9 75 3D DC 5E 2A A0 D3
0220 | 72 A4 E3 53 C5 BE E5 A8 4D 07 2E 39 D5 0F 90 0B
0230 | 78 12 7B 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100364CFD00A68FCCB95EA58EE4</code> <code>109BE9E30B132F37C0D88DB92059FDF7</code> <code>7EDE753539085094B7D23F7E4A8A7603</code> <code>075FFFFD8FEFF0BFFB09CFCE9D977A86</code> <code>17006A669B2D6CA10BF6A753A57695D2</code> <code>2165F15E95E8A1DD02452C956B350A52</code> <code>B87FB08A3093DE1068147D4103279F9E</code> <code>DB04C46E7C5ECC7F368CDC9856D40F4C</code> <code>910470ECA8EBBE71C03A6505FBD54655</code> <code>D4874E1F1A4100535A271DF64F7ED72E</code> <code>CDA7EEABA90A09D10FFF8F1B4CC2620C</code> <code>2D133D13ACF7B655A57E1D571F2998BD</code> <code>3D85977253F65AE1C3D11A56FDCE7911</code> <code>70ED80B555D8DC0FB28FBFDEC5B31EF3</code> <code>AAAEEA246B620A68EE28A475C9753DDC</code> <code>5E2AA0D372A4E353C5BEE5A84D072E39</code><br> <code>D50F900B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>78127B65</code> (1702564472 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 6592B40C4B5CBC072AF9D33B1E85212567F9A478365D4CE4B83E75EF4CD633F892776FB80EE860D907655D736C1699C3C882DF67B89E10E6F065DBACEA07B8BB04B65B319013CFD72C3149130FD656300613119568AD5EE8CF4AFBF00DF5E7B7730B6C032A904FD7D0803B8CB0196E628EE617BDB44369D06EDF37C6E04FA12810B763BEC03D8FE00EE7BB69AA9EEF6102EBEFD3A9627A1F8B776A5204D8A9D31CDB208A9E980B52D131B3CC4F80200CEC138DA8A5C686237BC099838136AB75906645704597AE60D74376EB7BDE60731575A898BAC9097F556417103916C6DCEB2AEA7D4E6DF591D55DEB329B8B85332A045E2C4A3EE5646607CA349B2B3018</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 8E56A8EF0B54797579B15BD7757DA0EFF06ED454F5A56DEFB703CA8B7721A5B7F19EC2BE6DA3CC423014F10B045ED5A772B8EFDA8AC8F6D40A2F64FC346E7F2DE9528BE18DE6D113E393C8319CA287DC3C19211CE1177D720B2049CCBAA8C945F672684896AB17BC7CBDDC8CFE62A4DB6D56EC42A0D0F4E776851A52C1EDC6347E93FF26E28EC7FB45E3FB5FF03D10DF418E146D36E62277768080D4E9C3056D40232A7F173A28EB289036E67FBDF6153BF2F866733856ABF19417E675F902F0C8F419A3A53328A633D1B9B0CF3C68F8E445B849EC4BF8EB98DAD6FFE08F2324FE1CBAB01AC3E7540A6B5DCC7CA8317E210F1C5B830C333E70F04FD5392EBDF2</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 B8 F9 ED 7E FD ED 7E E9 3F AD BE 6C
0010 | 51 43 F6 39 4D 54 EA 31 25 42 43 08 9E 77 01 9C
0020 | 06 A5 29 F0 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 8E 56 A8 EF 0B 54 79 75 79 B1 5B D7 75 7D A0 EF
0040 | F0 6E D4 54 F5 A5 6D EF B7 03 CA 8B 77 21 A5 B7
0050 | F1 9E C2 BE 6D A3 CC 42 30 14 F1 0B 04 5E D5 A7
0060 | 72 B8 EF DA 8A C8 F6 D4 0A 2F 64 FC 34 6E 7F 2D
0070 | E9 52 8B E1 8D E6 D1 13 E3 93 C8 31 9C A2 87 DC
0080 | 3C 19 21 1C E1 17 7D 72 0B 20 49 CC BA A8 C9 45
0090 | F6 72 68 48 96 AB 17 BC 7C BD DC 8C FE 62 A4 DB
00A0 | 6D 56 EC 42 A0 D0 F4 E7 76 85 1A 52 C1 ED C6 34
00B0 | 7E 93 FF 26 E2 8E C7 FB 45 E3 FB 5F F0 3D 10 DF
00C0 | 41 8E 14 6D 36 E6 22 77 76 80 80 D4 E9 C3 05 6D
00D0 | 40 23 2A 7F 17 3A 28 EB 28 90 36 E6 7F BD F6 15
00E0 | 3B F2 F8 66 73 38 56 AB F1 94 17 E6 75 F9 02 F0
00F0 | C8 F4 19 A3 A5 33 28 A6 33 D1 B9 B0 CF 3C 68 F8
0100 | E4 45 B8 49 EC 4B F8 EB 98 DA D6 FF E0 8F 23 24
0110 | FE 1C BA B0 1A C3 E7 54 0A 6B 5D CC 7C A8 31 7E
0120 | 21 0F 1C 5B 83 0C 33 3E 70 F0 4F D5 39 2E BD F2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001008E56A8EF0B54797579B15BD7</code> <code>757DA0EFF06ED454F5A56DEFB703CA8B</code> <code>7721A5B7F19EC2BE6DA3CC423014F10B</code> <code>045ED5A772B8EFDA8AC8F6D40A2F64FC</code> <code>346E7F2DE9528BE18DE6D113E393C831</code> <code>9CA287DC3C19211CE1177D720B2049CC</code> <code>BAA8C945F672684896AB17BC7CBDDC8C</code> <code>FE62A4DB6D56EC42A0D0F4E776851A52</code> <code>C1EDC6347E93FF26E28EC7FB45E3FB5F</code> <code>F03D10DF418E146D36E62277768080D4</code> <code>E9C3056D40232A7F173A28EB289036E6</code> <code>7FBDF6153BF2F866733856ABF19417E6</code> <code>75F902F0C8F419A3A53328A633D1B9B0</code> <code>CF3C68F8E445B849EC4BF8EB98DAD6FF</code> <code>E08F2324FE1CBAB01AC3E7540A6B5DCC</code> <code>7CA8317E210F1C5B830C333E70F04FD5</code><br> <code>392EBDF2</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366B8F9ED7EFDED7EE93FADBE6C5143F6394D54EA31254243089E77019C06A529F00000000000000000FE0001008E56A8EF0B54797579B15BD7757DA0EFF06ED454F5A56DEFB703CA8B7721A5B7F19EC2BE6DA3CC423014F10B045ED5A772B8EFDA8AC8F6D40A2F64FC346E7F2DE9528BE18DE6D113E393C8319CA287DC3C19211CE1177D720B2049CCBAA8C945F672684896AB17BC7CBDDC8CFE62A4DB6D56EC42A0D0F4E776851A52C1EDC6347E93FF26E28EC7FB45E3FB5FF03D10DF418E146D36E62277768080D4E9C3056D40232A7F173A28EB289036E67FBDF6153BF2F866733856ABF19417E675F902F0C8F419A3A53328A633D1B9B0CF3C68F8E445B849EC4BF8EB98DAD6FFE08F2324FE1CBAB01AC3E7540A6B5DCC7CA8317E210F1C5B830C333E70F04FD5392EBDF2
padding = 40CDB07914884091266F1ABF
tmp_aes_key = 5028FB57D07AD7AEA070D02B26E6BDE4AB80742328D35421B99A5D37ABE9C368
tmp_aes_iv = BF6F3CBFCFD7D76DF70B881BF7C1B98C341468E67EC78092191B35790495A8C6</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 976CD8BB0F4C15CE6F4600F97BE02EFBE7EFB169AAD735836FB91F978A86EE7AC31D6C2DF542ECFE71778FFADD675964E4C77E8B881E3A69BB15F93B290B3580E63E0833592290FEA95356D0364A4B274711E8E811EA34F3598EEAE1C03004C5C180E05AD9FD786A1FCB8E9F6A50135AB6CD1E333FC473CE83D2B8BE780FC957CBF12EE897B024335E03F6F16B9228FB238C850D629FD4202998F32BDFF9FC02A960F804666D52A9DF3362E12AB73C8098E7DBEA4E3D8E45E5F2080D87E7B2E9BBF7999291D9E1BF023940C5A7DEDBD7D2A3D0FBDC4EAC40069FD982537D2818EA316D51108E8B352406E29F26147DE357B087BDC3633FF2D81E0894551969A6F9F2FE6D3E082FB95C61E10914194F298B0319F72B1747C0C670CC92460BB4A932BD1A97DF3EE135393905674E97A85692ECC46C2CD0F80D080DC8E6CC50BB3A9BCEEDC4FBFB86D7C2EBD78D7DCCE4FB</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 70 96 01 00 78 12 7B 65
0010 | 78 01 00 00 1F 5F 04 F5 B8 F9 ED 7E FD ED 7E E9
0020 | 3F AD BE 6C 51 43 F6 39 4D 54 EA 31 25 42 43 08
0030 | 9E 77 01 9C 06 A5 29 F0 FE 50 01 00 97 6C D8 BB
0040 | 0F 4C 15 CE 6F 46 00 F9 7B E0 2E FB E7 EF B1 69
0050 | AA D7 35 83 6F B9 1F 97 8A 86 EE 7A C3 1D 6C 2D
0060 | F5 42 EC FE 71 77 8F FA DD 67 59 64 E4 C7 7E 8B
0070 | 88 1E 3A 69 BB 15 F9 3B 29 0B 35 80 E6 3E 08 33
0080 | 59 22 90 FE A9 53 56 D0 36 4A 4B 27 47 11 E8 E8
0090 | 11 EA 34 F3 59 8E EA E1 C0 30 04 C5 C1 80 E0 5A
00A0 | D9 FD 78 6A 1F CB 8E 9F 6A 50 13 5A B6 CD 1E 33
00B0 | 3F C4 73 CE 83 D2 B8 BE 78 0F C9 57 CB F1 2E E8
00C0 | 97 B0 24 33 5E 03 F6 F1 6B 92 28 FB 23 8C 85 0D
00D0 | 62 9F D4 20 29 98 F3 2B DF F9 FC 02 A9 60 F8 04
00E0 | 66 6D 52 A9 DF 33 62 E1 2A B7 3C 80 98 E7 DB EA
00F0 | 4E 3D 8E 45 E5 F2 08 0D 87 E7 B2 E9 BB F7 99 92
0100 | 91 D9 E1 BF 02 39 40 C5 A7 DE DB D7 D2 A3 D0 FB
0110 | DC 4E AC 40 06 9F D9 82 53 7D 28 18 EA 31 6D 51
0120 | 10 8E 8B 35 24 06 E2 9F 26 14 7D E3 57 B0 87 BD
0130 | C3 63 3F F2 D8 1E 08 94 55 19 69 A6 F9 F2 FE 6D
0140 | 3E 08 2F B9 5C 61 E1 09 14 19 4F 29 8B 03 19 F7
0150 | 2B 17 47 C0 C6 70 CC 92 46 0B B4 A9 32 BD 1A 97
0160 | DF 3E E1 35 39 39 05 67 4E 97 A8 56 92 EC C4 6C
0170 | 2C D0 F8 0D 08 0D C8 E6 CC 50 BB 3A 9B CE ED C4
0180 | FB FB 86 D7 C2 EB D7 8D 7D CC E4 FB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7096010078127B65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100976CD8BB0F4C15CE6F4600F9</code> <code>7BE02EFBE7EFB169AAD735836FB91F97</code> <code>8A86EE7AC31D6C2DF542ECFE71778FFA</code> <code>DD675964E4C77E8B881E3A69BB15F93B</code> <code>290B3580E63E0833592290FEA95356D0</code> <code>364A4B274711E8E811EA34F3598EEAE1</code> <code>C03004C5C180E05AD9FD786A1FCB8E9F</code> <code>6A50135AB6CD1E333FC473CE83D2B8BE</code> <code>780FC957CBF12EE897B024335E03F6F1</code> <code>6B9228FB238C850D629FD4202998F32B</code> <code>DFF9FC02A960F804666D52A9DF3362E1</code> <code>2AB73C8098E7DBEA4E3D8E45E5F2080D</code> <code>87E7B2E9BBF7999291D9E1BF023940C5</code> <code>A7DEDBD7D2A3D0FBDC4EAC40069FD982</code> <code>537D2818EA316D51108E8B352406E29F</code> <code>26147DE357B087BDC3633FF2D81E0894</code> <code>551969A6F9F2FE6D3E082FB95C61E109</code> <code>14194F298B0319F72B1747C0C670CC92</code> <code>460BB4A932BD1A97DF3EE13539390567</code> <code>4E97A85692ECC46C2CD0F80D080DC8E6</code> <code>CC50BB3A9BCEEDC4FBFB86D7C2EBD78D</code><br> <code>7DCCE4FB</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 823B5A4889770D05C445DFEED1D61CB2CF11F2C0642DA7794CED72BD10D2F8C0E0D6B09EE6A70DC7EAA6487908FAA91959CFDE476ADA6A4301656EA75B19A3204F6B4EC407C8CEC9F4B4EBCE941F133EC6786A74741062A6FFEC3E4DE642A3EE9F02AC306ACABBC3B62350A43097783D055941CB1128373BA6577C136A0D6FBC7976BFC4248438980CF15B952DC397C5998D93A17B683F3943089ED82FC3B3B360ADCB186BAACC2BC5388450B9E15E8F76CD2CCD7CF4763E5DB80BA8EE6961BD310D684CFAC8999E94C8AE99BD1CFE2C009640010B975484CF2A327B1BEA53D93C37968B7EC1677B1189A54836D918E3B4010CEFE009C09EE9DB98C77FA8FD92</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C 3C BF 78 12 7B 65
0010 | 60 00 00 00 34 F7 CB 3B B8 F9 ED 7E FD ED 7E E9
0020 | 3F AD BE 6C 51 43 F6 39 4D 54 EA 31 25 42 43 08
0030 | 9E 77 01 9C 06 A5 29 F0 DF 20 1E 8B 93 39 C4 F6
0040 | 41 F8 AA 8E D8 E2 4B DB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017C3CBF78127B65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>60000000</code> (96 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B8F9ED7EFDED7EE93FADBE6C5143F639</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D54EA31254243089E77019C06A529F0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>DF201E8B9339C4F641F8AA8ED8E24BDB</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

