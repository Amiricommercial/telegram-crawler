<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 C7 0B 00 05 2E A8 65
0010 | 14 00 00 00 F1 8E 7E BE 59 EB 4E A1 77 C2 B0 4D
0020 | C7 A2 21 A2 C0 80 F0 A3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A8C70B00052EA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 28 AB 03 06 2E A8 65
0010 | 58 00 00 00 63 24 16 05 59 EB 4E A1 77 C2 B0 4D
0020 | C7 A2 21 A2 C0 80 F0 A3 7F 5A B2 77 88 A5 39 5E
0030 | 7C 08 6E BA F4 74 75 86 08 19 EC DA 36 66 B5 54
0040 | A7 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0128AB03062EA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0819ECDA3666B554A7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1868107872638162087</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1868107872638162087</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1868107872638162087 = 1176978853 * 1587205979</code></p>
<pre><code>p = 1176978853
q = 1587205979</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 EC DA 36 66 B5 54 A7 00 00 00
0010 | 04 46 27 45 A5 00 00 00 04 5E 9A D7 5B 00 00 00
0020 | 59 EB 4E A1 77 C2 B0 4D C7 A2 21 A2 C0 80 F0 A3
0030 | 7F 5A B2 77 88 A5 39 5E 7C 08 6E BA F4 74 75 86
0040 | 5D EE 58 8E FF 79 DA 1F E7 31 07 A1 C0 23 B6 CD
0050 | 11 3E D8 2D 68 7C 4E 37 D5 2F 24 42 83 8A 24 CB
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0819ECDA3666B554A7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1868107872638162087</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04462745A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1176978853</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045E9AD75B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1587205979</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>5DEE588EFF79DA1FE73107A1C023B6CD</code> <code>113ED82D687C4E37D52F2442838A24CB</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90819ECDA3666B554A700000004462745A5000000045E9AD75B00000059EB4EA177C2B04DC7A221A2C080F0A37F5AB27788A5395E7C086EBAF47475865DEE588EFF79DA1FE73107A1C023B6CD113ED82D687C4E37D52F2442838A24CB02000000
random_padding_bytes = A586B9E34683FA8194230A718DF69B262AE3F6A05BC1252B1C36EA406B1A51724C7E0AAAF9B55333567509DDEC97EA483725E6114DD92D3B606BA1C1F76D5225AD0C94240D5112F5AB7C761B5A54207EA99ECE277E6970E45CCF268E</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 314F92A41A5DAFDA1FC7F0E157B935D4DF2B1F398F30697FE76B83E0F63A50282A7402EEF3F1178B0DE0B8AC34672D628E139747429ABBCEF3402EBF135E45A9A2BCB42EC268693414E830AAF0874EF6AA914EC04EF8DDAF68426F61DCAA995B625D57FFAD1CFD63374495EAF9E5AC2DA9316C90A05761833083DF5160F019315379A2F25B3F183AEF404F9B4065CE585198C635F62C4A2CD9BBFABA3E36649A20AA2617E7E84B4DD4928B1A82896596745EB0ABE6A5D4048D0D2817FED8B830357767E14C88D6F0F5120384E897EA8F13300503B6084E78D855A0EB1A6A22F8AADA95996CABB2609807479D4BA9E763265AF0C1C3489542B7C2262D9135BB9A</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 F3 0D 00 05 2E A8 65
0010 | 40 01 00 00 BE E4 12 D7 59 EB 4E A1 77 C2 B0 4D
0020 | C7 A2 21 A2 C0 80 F0 A3 7F 5A B2 77 88 A5 39 5E
0030 | 7C 08 6E BA F4 74 75 86 04 46 27 45 A5 00 00 00
0040 | 04 5E 9A D7 5B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 31 4F 92 A4 1A 5D AF DA 1F C7 F0 E1
0060 | 57 B9 35 D4 DF 2B 1F 39 8F 30 69 7F E7 6B 83 E0
0070 | F6 3A 50 28 2A 74 02 EE F3 F1 17 8B 0D E0 B8 AC
0080 | 34 67 2D 62 8E 13 97 47 42 9A BB CE F3 40 2E BF
0090 | 13 5E 45 A9 A2 BC B4 2E C2 68 69 34 14 E8 30 AA
00A0 | F0 87 4E F6 AA 91 4E C0 4E F8 DD AF 68 42 6F 61
00B0 | DC AA 99 5B 62 5D 57 FF AD 1C FD 63 37 44 95 EA
00C0 | F9 E5 AC 2D A9 31 6C 90 A0 57 61 83 30 83 DF 51
00D0 | 60 F0 19 31 53 79 A2 F2 5B 3F 18 3A EF 40 4F 9B
00E0 | 40 65 CE 58 51 98 C6 35 F6 2C 4A 2C D9 BB FA BA
00F0 | 3E 36 64 9A 20 AA 26 17 E7 E8 4B 4D D4 92 8B 1A
0100 | 82 89 65 96 74 5E B0 AB E6 A5 D4 04 8D 0D 28 17
0110 | FE D8 B8 30 35 77 67 E1 4C 88 D6 F0 F5 12 03 84
0120 | E8 97 EA 8F 13 30 05 03 B6 08 4E 78 D8 55 A0 EB
0130 | 1A 6A 22 F8 AA DA 95 99 6C AB B2 60 98 07 47 9D
0140 | 4B A9 E7 63 26 5A F0 C1 C3 48 95 42 B7 C2 26 2D
0150 | 91 35 BB 9A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C8F30D00052EA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04462745A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1176978853</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045E9AD75B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1587205979</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100314F92A41A5DAFDA1FC7F0E1</code> <code>57B935D4DF2B1F398F30697FE76B83E0</code> <code>F63A50282A7402EEF3F1178B0DE0B8AC</code> <code>34672D628E139747429ABBCEF3402EBF</code> <code>135E45A9A2BCB42EC268693414E830AA</code> <code>F0874EF6AA914EC04EF8DDAF68426F61</code> <code>DCAA995B625D57FFAD1CFD63374495EA</code> <code>F9E5AC2DA9316C90A05761833083DF51</code> <code>60F019315379A2F25B3F183AEF404F9B</code> <code>4065CE585198C635F62C4A2CD9BBFABA</code> <code>3E36649A20AA2617E7E84B4DD4928B1A</code> <code>82896596745EB0ABE6A5D4048D0D2817</code> <code>FED8B830357767E14C88D6F0F5120384</code> <code>E897EA8F13300503B6084E78D855A0EB</code> <code>1A6A22F8AADA95996CABB2609807479D</code> <code>4BA9E763265AF0C1C3489542B7C2262D</code><br> <code>9135BB9A</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 EC 7D A1 06 2E A8 65
0010 | 8C 02 00 00 5C 07 E8 D0 59 EB 4E A1 77 C2 B0 4D
0020 | C7 A2 21 A2 C0 80 F0 A3 7F 5A B2 77 88 A5 39 5E
0030 | 7C 08 6E BA F4 74 75 86 FE 50 02 00 01 A2 6C 8C
0040 | 77 D3 7C C8 FD A2 7A DC 77 45 30 F7 EA 13 8A EA
0050 | EB 8E 51 92 B0 86 4F 8B 45 D1 39 D0 54 73 A3 DB
0060 | FB 4C A9 67 28 84 AC 1E 9A 0D 1F BC 49 C6 05 27
0070 | 3B 11 5C 76 EA EA 93 6B FF 52 4C 49 EB 82 F7 A8
0080 | 10 FF 74 94 61 B9 F0 F8 D8 E0 3D 8D 29 8C 45 CF
0090 | F1 08 75 D6 76 1D B7 71 C7 35 9B 04 B9 34 EC 23
00A0 | 69 5E 33 70 FB 84 CF 36 9A 8F AD 08 4B 92 AC 6F
00B0 | FE 33 29 D4 BF 65 7E 4F E0 C3 8F 92 18 A7 B1 50
00C0 | BD F8 8A 7F 8E E8 BF B2 89 1E E2 AC BD C0 AC D6
00D0 | 3C 3F 1B A9 FB F0 EC 94 BD D8 B5 C2 E4 EC 71 67
00E0 | 6E 28 67 84 87 8E 80 E2 12 5E 8C 8A 14 F1 30 14
00F0 | 17 59 EF BF 59 36 FF 67 4F FB 56 CC 86 F4 39 BE
0100 | 84 76 FE 1B BB 83 BC B6 8C D2 76 7D 71 AA 47 02
0110 | 54 4B A8 1E 70 8F F3 00 34 8D 6C F0 CA 0E B1 93
0120 | 22 05 D9 4F C3 60 0B A0 35 53 28 2B 79 9E 85 75
0130 | 74 C6 0A E4 36 4F E3 34 39 E6 C8 C2 5F 7C 85 2E
0140 | 69 F2 93 87 FD 6C 85 0D CD B0 3E 10 82 23 8B 92
0150 | F8 00 31 C0 44 00 9B C2 7F 0D 54 85 B4 24 DB 93
0160 | 55 7E 93 16 C9 CB 15 FC 89 EA 11 F4 5C C5 99 0B
0170 | DF 02 E5 CC 07 2D 49 43 EA 84 A2 31 A2 58 E2 A3
0180 | 19 55 10 62 3C 96 52 FD 63 28 2F 04 AC F2 37 0A
0190 | F2 DD 56 B1 38 18 55 2F 34 D3 03 10 31 66 A5 37
01A0 | D7 1F AA 26 B5 04 62 01 48 C0 11 15 37 96 5B 26
01B0 | E8 86 90 D5 DD 85 CA 54 7D 09 9C 29 76 52 61 9E
01C0 | 4E CA 97 40 B9 9F 18 12 35 22 D6 12 24 7C C2 8D
01D0 | BB 85 93 13 28 F1 3A 00 20 CE 99 FA 0C 83 8B EE
01E0 | F5 0B 51 48 67 3C FF 45 FF EF DA 3B BA 54 5B 4E
01F0 | 8A 13 CC DE 2A 1B 65 20 E9 EA BD BE A7 3F 21 47
0200 | 2A E5 AA 03 0C D1 90 2F EF 15 43 17 B0 61 C0 E2
0210 | C7 28 14 4A 67 2A 35 8A 90 01 39 D7 F1 2E 06 28
0220 | B2 CE 5E 6B 16 AA BE 2E CE 10 82 3B 93 0E B8 7E
0230 | 40 14 DF DA 34 3B D8 0F A1 F6 AB 14 18 D1 48 0A
0240 | DE CD 5D 16 44 48 D7 FB 17 50 4E 40 84 09 52 B9
0250 | 25 CB 56 00 4A 15 68 C0 2D AB 8C C3 FE 8F 5E 41
0260 | 66 C1 98 79 35 97 23 FF E8 B6 A9 4A 0A DD 07 14
0270 | 5A 26 E6 CF 70 4E 79 1F 5F ED 94 50 67 11 3E 2C
0280 | CA AD D8 A2 CC AA 3E AF 32 BC AA C0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01EC7DA1062EA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>8C020000</code> (652 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020001A26C8C77D37CC8FDA27ADC</code> <code>774530F7EA138AEAEB8E5192B0864F8B</code> <code>45D139D05473A3DBFB4CA9672884AC1E</code> <code>9A0D1FBC49C605273B115C76EAEA936B</code> <code>FF524C49EB82F7A810FF749461B9F0F8</code> <code>D8E03D8D298C45CFF10875D6761DB771</code> <code>C7359B04B934EC23695E3370FB84CF36</code> <code>9A8FAD084B92AC6FFE3329D4BF657E4F</code> <code>E0C38F9218A7B150BDF88A7F8EE8BFB2</code> <code>891EE2ACBDC0ACD63C3F1BA9FBF0EC94</code> <code>BDD8B5C2E4EC71676E286784878E80E2</code> <code>125E8C8A14F130141759EFBF5936FF67</code> <code>4FFB56CC86F439BE8476FE1BBB83BCB6</code> <code>8CD2767D71AA4702544BA81E708FF300</code> <code>348D6CF0CA0EB1932205D94FC3600BA0</code> <code>3553282B799E857574C60AE4364FE334</code> <code>39E6C8C25F7C852E69F29387FD6C850D</code> <code>CDB03E1082238B92F80031C044009BC2</code> <code>7F0D5485B424DB93557E9316C9CB15FC</code> <code>89EA11F45CC5990BDF02E5CC072D4943</code> <code>EA84A231A258E2A3195510623C9652FD</code> <code>63282F04ACF2370AF2DD56B13818552F</code> <code>34D303103166A537D71FAA26B5046201</code> <code>48C0111537965B26E88690D5DD85CA54</code> <code>7D099C297652619E4ECA9740B99F1812</code> <code>3522D612247CC28DBB85931328F13A00</code> <code>20CE99FA0C838BEEF50B5148673CFF45</code> <code>FFEFDA3BBA545B4E8A13CCDE2A1B6520</code> <code>E9EABDBEA73F21472AE5AA030CD1902F</code> <code>EF154317B061C0E2C728144A672A358A</code> <code>900139D7F12E0628B2CE5E6B16AABE2E</code> <code>CE10823B930EB87E4014DFDA343BD80F</code> <code>A1F6AB1418D1480ADECD5D164448D7FB</code> <code>17504E40840952B925CB56004A1568C0</code> <code>2DAB8CC3FE8F5E4166C19879359723FF</code> <code>E8B6A94A0ADD07145A26E6CF704E791F</code> <code>5FED945067113E2CCAADD8A2CCAA3EAF</code><br> <code>32BCAAC0</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 01A26C8C77D37CC8FDA27ADC774530F7EA138AEAEB8E5192B0864F8B45D139D05473A3DBFB4CA9672884AC1E9A0D1FBC49C605273B115C76EAEA936BFF524C49EB82F7A810FF749461B9F0F8D8E03D8D298C45CFF10875D6761DB771C7359B04B934EC23695E3370FB84CF369A8FAD084B92AC6FFE3329D4BF657E4FE0C38F9218A7B150BDF88A7F8EE8BFB2891EE2ACBDC0ACD63C3F1BA9FBF0EC94BDD8B5C2E4EC71676E286784878E80E2125E8C8A14F130141759EFBF5936FF674FFB56CC86F439BE8476FE1BBB83BCB68CD2767D71AA4702544BA81E708FF300348D6CF0CA0EB1932205D94FC3600BA03553282B799E857574C60AE4364FE33439E6C8C25F7C852E69F29387FD6C850DCDB03E1082238B92F80031C044009BC27F0D5485B424DB93557E9316C9CB15FC89EA11F45CC5990BDF02E5CC072D4943EA84A231A258E2A3195510623C9652FD63282F04ACF2370AF2DD56B13818552F34D303103166A537D71FAA26B504620148C0111537965B26E88690D5DD85CA547D099C297652619E4ECA9740B99F18123522D612247CC28DBB85931328F13A0020CE99FA0C838BEEF50B5148673CFF45FFEFDA3BBA545B4E8A13CCDE2A1B6520E9EABDBEA73F21472AE5AA030CD1902FEF154317B061C0E2C728144A672A358A900139D7F12E0628B2CE5E6B16AABE2ECE10823B930EB87E4014DFDA343BD80FA1F6AB1418D1480ADECD5D164448D7FB17504E40840952B925CB56004A1568C02DAB8CC3FE8F5E4166C19879359723FFE8B6A94A0ADD07145A26E6CF704E791F5FED945067113E2CCAADD8A2CCAA3EAF32BCAAC0
tmp_aes_key = 2D98C430FADBBEF521A985A86D5FEC89B0D80C57012AB00E52CBDBEF385BA609
tmp_aes_iv = 252E68B91E3D4AC180E8FA4B7CC58EACA72F868303EE469B66B95D325DEE588E</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1AC4EED45496F12EB1552F300E6F567E749F7CE9BA0D89B559EB4EA177C2B04DC7A221A2C080F0A37F5AB27788A5395E7C086EBAF474758603000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100016580A48B6D7744D3C0C674241411E844E1CE29BF23763A63E3ED32DF24B969FE60C55CB1CDFFE92F45733036A5A4B0BFBFE9A1622760DA6261CC549C70858A93F073C6A6A099CE63C8084463ED0C4D1F1393A715B71895B06DB2399745B0EA303CD8AFF1B47F057930E6CA70F4F25D3D15E29E268BF9F5A0AD1DA84D216458A2CE6E6EFDC4A1F2AB214D5C8D984919050450A710857C8F625CA4361785923FEFF4089D40A4EB3DB95AA2912753CA255D7CD8BC6220610381B5D082CDF84FC2F9B46DF449FE526435E3D74347C9F19A29391DBCD2F20479F45A7B683D9843640C6589034375356F8606E8CB81CAC69D06CC012F109DF322CB3508FAD4C31A09062EA8656DF821CDED12445D
answer = BA0D89B559EB4EA177C2B04DC7A221A2C080F0A37F5AB27788A5395E7C086EBAF474758603000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100016580A48B6D7744D3C0C674241411E844E1CE29BF23763A63E3ED32DF24B969FE60C55CB1CDFFE92F45733036A5A4B0BFBFE9A1622760DA6261CC549C70858A93F073C6A6A099CE63C8084463ED0C4D1F1393A715B71895B06DB2399745B0EA303CD8AFF1B47F057930E6CA70F4F25D3D15E29E268BF9F5A0AD1DA84D216458A2CE6E6EFDC4A1F2AB214D5C8D984919050450A710857C8F625CA4361785923FEFF4089D40A4EB3DB95AA2912753CA255D7CD8BC6220610381B5D082CDF84FC2F9B46DF449FE526435E3D74347C9F19A29391DBCD2F20479F45A7B683D9843640C6589034375356F8606E8CB81CAC69D06CC012F109DF322CB3508FAD4C31A09062EA8656DF821CDED12445D</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 59 EB 4E A1 77 C2 B0 4D C7 A2 21 A2
0010 | C0 80 F0 A3 7F 5A B2 77 88 A5 39 5E 7C 08 6E BA
0020 | F4 74 75 86 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 01 65 80 A4 8B 6D 77 44 D3 C0 C6 74 24 14 11 E8
0140 | 44 E1 CE 29 BF 23 76 3A 63 E3 ED 32 DF 24 B9 69
0150 | FE 60 C5 5C B1 CD FF E9 2F 45 73 30 36 A5 A4 B0
0160 | BF BF E9 A1 62 27 60 DA 62 61 CC 54 9C 70 85 8A
0170 | 93 F0 73 C6 A6 A0 99 CE 63 C8 08 44 63 ED 0C 4D
0180 | 1F 13 93 A7 15 B7 18 95 B0 6D B2 39 97 45 B0 EA
0190 | 30 3C D8 AF F1 B4 7F 05 79 30 E6 CA 70 F4 F2 5D
01A0 | 3D 15 E2 9E 26 8B F9 F5 A0 AD 1D A8 4D 21 64 58
01B0 | A2 CE 6E 6E FD C4 A1 F2 AB 21 4D 5C 8D 98 49 19
01C0 | 05 04 50 A7 10 85 7C 8F 62 5C A4 36 17 85 92 3F
01D0 | EF F4 08 9D 40 A4 EB 3D B9 5A A2 91 27 53 CA 25
01E0 | 5D 7C D8 BC 62 20 61 03 81 B5 D0 82 CD F8 4F C2
01F0 | F9 B4 6D F4 49 FE 52 64 35 E3 D7 43 47 C9 F1 9A
0200 | 29 39 1D BC D2 F2 04 79 F4 5A 7B 68 3D 98 43 64
0210 | 0C 65 89 03 43 75 35 6F 86 06 E8 CB 81 CA C6 9D
0220 | 06 CC 01 2F 10 9D F3 22 CB 35 08 FA D4 C3 1A 09
0230 | 06 2E A8 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100016580A48B6D7744D3C0C674</code> <code>241411E844E1CE29BF23763A63E3ED32</code> <code>DF24B969FE60C55CB1CDFFE92F457330</code> <code>36A5A4B0BFBFE9A1622760DA6261CC54</code> <code>9C70858A93F073C6A6A099CE63C80844</code> <code>63ED0C4D1F1393A715B71895B06DB239</code> <code>9745B0EA303CD8AFF1B47F057930E6CA</code> <code>70F4F25D3D15E29E268BF9F5A0AD1DA8</code> <code>4D216458A2CE6E6EFDC4A1F2AB214D5C</code> <code>8D984919050450A710857C8F625CA436</code> <code>1785923FEFF4089D40A4EB3DB95AA291</code> <code>2753CA255D7CD8BC6220610381B5D082</code> <code>CDF84FC2F9B46DF449FE526435E3D743</code> <code>47C9F19A29391DBCD2F20479F45A7B68</code> <code>3D9843640C6589034375356F8606E8CB</code> <code>81CAC69D06CC012F109DF322CB3508FA</code><br> <code>D4C31A09</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>062EA865</code> (1705520646 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 2E790C97AFEC39FDDFF632D55A899D103A91AF3B96E37B623D8CFB6AE218703978AE81A3FFFE06E18290E22AAF85D05C14E18985C2B7BE33DEB780739EED71B79DDEFE8892E27E5529D8827338C12B10E1D8335A1F42CAF3C55B25DD8DA6A2F6787AA1FB6C2A3E2ACB95F274D68ECF7F92D5EA7B6F2845F093346649CC7E8F8D738D8B23A88BDB796C484DC7BAC18D3AC710A41636936C4F0FDDA8AF643A1A6C2B2B2EA0A6D51D023CEBF3D4AA50649130B99DC03E0256A01F9CBE120A0FB91686269AB815B6E6B71B0527092022B44DAC38B4307FAAE6F12B838BBD04C50278E8DB061BBC62CA7E5F9AF016B16B705B943C3096EE04800D77E1DE468BCF892E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = ADB2E31A0D4B144B226DF3D17C7C23F9326646A06C9848085B7E2ADA605F220FE05D955E5FAF4F05F173F1E34D9AA7C382E590EDD5EA22488DFAFC362A69B044D6DC95A220DADE9CDA01079093C406F80DB702A3F3175CDC5734CC5BFB94767503EEC027D92CBF86DF4665060193C0CA5F5860C0E48E9D948861F5716F545B1FD7DCB033C6AC93D62FD1627B386B0F59847953694300E20AF3E19F828852AFE0C1B87319F73FD71DD10EF5395239E5CF448B2449D97904EA242F6938A70320467FFB58C8CDE037AC21923A44E8E6F7DEFEFBB03409BABD622510359F93451AE78EE93B79D2FCC857CB58D9A2B6CA7A97935C8D41C5B8823A6F7D8C69968FF979</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 59 EB 4E A1 77 C2 B0 4D C7 A2 21 A2
0010 | C0 80 F0 A3 7F 5A B2 77 88 A5 39 5E 7C 08 6E BA
0020 | F4 74 75 86 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | AD B2 E3 1A 0D 4B 14 4B 22 6D F3 D1 7C 7C 23 F9
0040 | 32 66 46 A0 6C 98 48 08 5B 7E 2A DA 60 5F 22 0F
0050 | E0 5D 95 5E 5F AF 4F 05 F1 73 F1 E3 4D 9A A7 C3
0060 | 82 E5 90 ED D5 EA 22 48 8D FA FC 36 2A 69 B0 44
0070 | D6 DC 95 A2 20 DA DE 9C DA 01 07 90 93 C4 06 F8
0080 | 0D B7 02 A3 F3 17 5C DC 57 34 CC 5B FB 94 76 75
0090 | 03 EE C0 27 D9 2C BF 86 DF 46 65 06 01 93 C0 CA
00A0 | 5F 58 60 C0 E4 8E 9D 94 88 61 F5 71 6F 54 5B 1F
00B0 | D7 DC B0 33 C6 AC 93 D6 2F D1 62 7B 38 6B 0F 59
00C0 | 84 79 53 69 43 00 E2 0A F3 E1 9F 82 88 52 AF E0
00D0 | C1 B8 73 19 F7 3F D7 1D D1 0E F5 39 52 39 E5 CF
00E0 | 44 8B 24 49 D9 79 04 EA 24 2F 69 38 A7 03 20 46
00F0 | 7F FB 58 C8 CD E0 37 AC 21 92 3A 44 E8 E6 F7 DE
0100 | FE FB B0 34 09 BA BD 62 25 10 35 9F 93 45 1A E7
0110 | 8E E9 3B 79 D2 FC C8 57 CB 58 D9 A2 B6 CA 7A 97
0120 | 93 5C 8D 41 C5 B8 82 3A 6F 7D 8C 69 96 8F F9 79</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100ADB2E31A0D4B144B226DF3D1</code> <code>7C7C23F9326646A06C9848085B7E2ADA</code> <code>605F220FE05D955E5FAF4F05F173F1E3</code> <code>4D9AA7C382E590EDD5EA22488DFAFC36</code> <code>2A69B044D6DC95A220DADE9CDA010790</code> <code>93C406F80DB702A3F3175CDC5734CC5B</code> <code>FB94767503EEC027D92CBF86DF466506</code> <code>0193C0CA5F5860C0E48E9D948861F571</code> <code>6F545B1FD7DCB033C6AC93D62FD1627B</code> <code>386B0F59847953694300E20AF3E19F82</code> <code>8852AFE0C1B87319F73FD71DD10EF539</code> <code>5239E5CF448B2449D97904EA242F6938</code> <code>A70320467FFB58C8CDE037AC21923A44</code> <code>E8E6F7DEFEFBB03409BABD622510359F</code> <code>93451AE78EE93B79D2FCC857CB58D9A2</code> <code>B6CA7A97935C8D41C5B8823A6F7D8C69</code><br> <code>968FF979</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436659EB4EA177C2B04DC7A221A2C080F0A37F5AB27788A5395E7C086EBAF47475860000000000000000FE000100ADB2E31A0D4B144B226DF3D17C7C23F9326646A06C9848085B7E2ADA605F220FE05D955E5FAF4F05F173F1E34D9AA7C382E590EDD5EA22488DFAFC362A69B044D6DC95A220DADE9CDA01079093C406F80DB702A3F3175CDC5734CC5BFB94767503EEC027D92CBF86DF4665060193C0CA5F5860C0E48E9D948861F5716F545B1FD7DCB033C6AC93D62FD1627B386B0F59847953694300E20AF3E19F828852AFE0C1B87319F73FD71DD10EF5395239E5CF448B2449D97904EA242F6938A70320467FFB58C8CDE037AC21923A44E8E6F7DEFEFBB03409BABD622510359F93451AE78EE93B79D2FCC857CB58D9A2B6CA7A97935C8D41C5B8823A6F7D8C69968FF979
padding = B906094C1C397547E2487EF2
tmp_aes_key = 2D98C430FADBBEF521A985A86D5FEC89B0D80C57012AB00E52CBDBEF385BA609
tmp_aes_iv = 252E68B91E3D4AC180E8FA4B7CC58EACA72F868303EE469B66B95D325DEE588E</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 4FF005BF31BB1AFB6A86D3AFB20336875ADB2DD803501AD99DC3DB1BEE9625D0804B85D055566BF73B8982B4E505A1EBE3D7290EEEEDB3B66BE4656E29B9CFEBC2A3BF71B805E28F7614A4991C0B4F83EB5F9C15B2E884098803AC148E75239484E7525F2031989832F75CBDBC2204C2FB1D9AD54B503636D376F69A7F552B6006B977115655F22D653FC6784591009B2F35E82C931C83422031FD45CB66B1F15AA3578A37AF06F0161222A2C2073B37083CB5785E3307A1B5C06DEA46C708DF93A3A1DDA10A521A25DC0C6BCDD7D506E9ED9C17B9609CFC6D407AB79748EF6D7D73FC5FBA9EB1310C1E4C460FD972A8A1BE76FA451D5BF3F5B82659DAE1C50A601AE37315F216516B1035E4F9ED5F0FB39F6C8BA9FC7D32CFDDD6CD515936FE0163E980B44F3C465F19D8AED4178762133526B67FEFA64B2B5E7AAD37A4FAB8C95DA2F4D687DF42A88F0226A0621C45</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC 14 06 00 06 2E A8 65
0010 | 78 01 00 00 1F 5F 04 F5 59 EB 4E A1 77 C2 B0 4D
0020 | C7 A2 21 A2 C0 80 F0 A3 7F 5A B2 77 88 A5 39 5E
0030 | 7C 08 6E BA F4 74 75 86 FE 50 01 00 4F F0 05 BF
0040 | 31 BB 1A FB 6A 86 D3 AF B2 03 36 87 5A DB 2D D8
0050 | 03 50 1A D9 9D C3 DB 1B EE 96 25 D0 80 4B 85 D0
0060 | 55 56 6B F7 3B 89 82 B4 E5 05 A1 EB E3 D7 29 0E
0070 | EE ED B3 B6 6B E4 65 6E 29 B9 CF EB C2 A3 BF 71
0080 | B8 05 E2 8F 76 14 A4 99 1C 0B 4F 83 EB 5F 9C 15
0090 | B2 E8 84 09 88 03 AC 14 8E 75 23 94 84 E7 52 5F
00A0 | 20 31 98 98 32 F7 5C BD BC 22 04 C2 FB 1D 9A D5
00B0 | 4B 50 36 36 D3 76 F6 9A 7F 55 2B 60 06 B9 77 11
00C0 | 56 55 F2 2D 65 3F C6 78 45 91 00 9B 2F 35 E8 2C
00D0 | 93 1C 83 42 20 31 FD 45 CB 66 B1 F1 5A A3 57 8A
00E0 | 37 AF 06 F0 16 12 22 A2 C2 07 3B 37 08 3C B5 78
00F0 | 5E 33 07 A1 B5 C0 6D EA 46 C7 08 DF 93 A3 A1 DD
0100 | A1 0A 52 1A 25 DC 0C 6B CD D7 D5 06 E9 ED 9C 17
0110 | B9 60 9C FC 6D 40 7A B7 97 48 EF 6D 7D 73 FC 5F
0120 | BA 9E B1 31 0C 1E 4C 46 0F D9 72 A8 A1 BE 76 FA
0130 | 45 1D 5B F3 F5 B8 26 59 DA E1 C5 0A 60 1A E3 73
0140 | 15 F2 16 51 6B 10 35 E4 F9 ED 5F 0F B3 9F 6C 8B
0150 | A9 FC 7D 32 CF DD D6 CD 51 59 36 FE 01 63 E9 80
0160 | B4 4F 3C 46 5F 19 D8 AE D4 17 87 62 13 35 26 B6
0170 | 7F EF A6 4B 2B 5E 7A AD 37 A4 FA B8 C9 5D A2 F4
0180 | D6 87 DF 42 A8 8F 02 26 A0 62 1C 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CC140600062EA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001004FF005BF31BB1AFB6A86D3AF</code> <code>B20336875ADB2DD803501AD99DC3DB1B</code> <code>EE9625D0804B85D055566BF73B8982B4</code> <code>E505A1EBE3D7290EEEEDB3B66BE4656E</code> <code>29B9CFEBC2A3BF71B805E28F7614A499</code> <code>1C0B4F83EB5F9C15B2E884098803AC14</code> <code>8E75239484E7525F2031989832F75CBD</code> <code>BC2204C2FB1D9AD54B503636D376F69A</code> <code>7F552B6006B977115655F22D653FC678</code> <code>4591009B2F35E82C931C83422031FD45</code> <code>CB66B1F15AA3578A37AF06F0161222A2</code> <code>C2073B37083CB5785E3307A1B5C06DEA</code> <code>46C708DF93A3A1DDA10A521A25DC0C6B</code> <code>CDD7D506E9ED9C17B9609CFC6D407AB7</code> <code>9748EF6D7D73FC5FBA9EB1310C1E4C46</code> <code>0FD972A8A1BE76FA451D5BF3F5B82659</code> <code>DAE1C50A601AE37315F216516B1035E4</code> <code>F9ED5F0FB39F6C8BA9FC7D32CFDDD6CD</code> <code>515936FE0163E980B44F3C465F19D8AE</code> <code>D4178762133526B67FEFA64B2B5E7AAD</code> <code>37A4FAB8C95DA2F4D687DF42A88F0226</code><br> <code>A0621C45</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 04F81FB9B944F83BB701D8BE1B11784C74E3A2ED9E9B0E9E272B1F6935EF8291E3A073C5E5AC89FEA805DFCB3F4B9C7E40D364DAD866B0E9452A265E766CE051326B7391B532170D44BA18AA5CFA97881D6B29A39F04B4D564A483902574A79E1864F702D28A922A884D3D155D73F923EBC7F975A3C7D4CA7EF123707E712EBC46E1FB8950B0A1FE36C82BE449DC734F34D76D15528FABB5A7DAD8246C7B68377471D2268045D29F58B6F5C23445526A0F5249BA622F580D2EDD9F2432F0377812F0850853C27C539C1D932006D57C9D3EE269980957B49C61C51614C9D6F288C06124A0964FDBA8BA6AA11B7E46D79FBABE69C2D2A9F9DE708F03E205E0895F</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 1C FC 85 07 2E A8 65
0010 | 84 00 00 00 34 F7 CB 3B 59 EB 4E A1 77 C2 B0 4D
0020 | C7 A2 21 A2 C0 80 F0 A3 7F 5A B2 77 88 A5 39 5E
0030 | 7C 08 6E BA F4 74 75 86 80 F2 5E 86 60 70 01 35
0040 | AF AD C1 45 22 0C 7C 72</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>011CFC85072EA865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>84000000</code> (132 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59EB4EA177C2B04DC7A221A2C080F0A3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>7F5AB27788A5395E7C086EBAF4747586</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>80F25E8660700135AFADC145220C7C72</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

