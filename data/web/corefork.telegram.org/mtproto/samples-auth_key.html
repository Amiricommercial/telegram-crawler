<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 9C E3 02 00 AC BD 84 65
0010 | 14 00 00 00 F1 8E 7E BE BF 56 08 04 20 B3 5B 3F
0020 | 3D 97 25 B6 70 95 90 F7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>9CE30200ACBD8465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C 3E A0 AC BD 84 65
0010 | 70 00 00 00 63 24 16 05 BF 56 08 04 20 B3 5B 3F
0020 | 3D 97 25 B6 70 95 90 F7 77 36 80 DE F0 DB 45 3E
0030 | 61 12 32 60 A9 D0 1B 7F 08 1B 41 34 6D B9 F1 F6
0040 | 85 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017C3EA0ACBD8465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>70000000</code> (112 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081B41346DB9F1F685000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1963908558385968773</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1963908558385968773</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1963908558385968773 = 1220852309 * 1608637297</code></p>
<pre><code>p = 1220852309
q = 1608637297</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1B 41 34 6D B9 F1 F6 85 00 00 00
0010 | 04 48 C4 BA 55 00 00 00 04 5F E1 DB 71 00 00 00
0020 | BF 56 08 04 20 B3 5B 3F 3D 97 25 B6 70 95 90 F7
0030 | 77 36 80 DE F0 DB 45 3E 61 12 32 60 A9 D0 1B 7F
0040 | 91 45 04 53 43 1A 61 02 1A 8F F9 79 16 4E A9 54
0050 | 7B D5 FC 41 71 21 3F 6D B4 5D C0 7E DB 5D B4 17
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081B41346DB9F1F685000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1963908558385968773</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0448C4BA55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1220852309</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045FE1DB71000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1608637297</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>91450453431A61021A8FF979164EA954</code> <code>7BD5FC4171213F6DB45DC07EDB5DB417</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081B41346DB9F1F6850000000448C4BA55000000045FE1DB71000000BF56080420B35B3F3D9725B6709590F7773680DEF0DB453E61123260A9D01B7F91450453431A61021A8FF979164EA9547BD5FC4171213F6DB45DC07EDB5DB41702000000
random_padding_bytes = 86F1FDDB11130E52B582CC34A595023A989F9B1A847B8038D8B21D1B7C36A77650C23EB223FEA2E2202EBBE4DC70827E185B69A3C2225AF96C23DA5AA76C4B34480162BE0BD0794D59553B31E8378C8EC1D27BF70B1F68E7B86103E8</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 8C91FDCEDDFF18DA3EBBC8C92798482C376076D6E9C27E06D29E93974FF5FA6AC9F5B81087C0721E8507B0CAAC1F117B1CA2DE657B7846F659BA1B01FCF6D48E196AE3E8BE6A1263953BA26D02183A3B9FCCB39DC6794A0B99872B24D6EDCBEF97F39533D93399DA4F53798DED47B4E6C4634B82D4F0C75BB0E1657632AEADBF5663B342BD5D70F364C320BFE29089EE2879292A276A8158280003ADD4F7FE275B562E194ACBA350AB1A346F58364C57D20F2E72819D12305CB2B4DBEF3EFF3DFFF8292185F82C5BAC77C6CB6305E1D260F2444C7620A354EDC0FD4A8F8AAF056EDB41A2F39F31A5539F1F23BBC60D2FCC572C4725FCC6C0306DFD0FD000CA3B</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 BC 0F 0D 00 AC BD 84 65
0010 | 40 01 00 00 BE E4 12 D7 BF 56 08 04 20 B3 5B 3F
0020 | 3D 97 25 B6 70 95 90 F7 77 36 80 DE F0 DB 45 3E
0030 | 61 12 32 60 A9 D0 1B 7F 04 48 C4 BA 55 00 00 00
0040 | 04 5F E1 DB 71 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 8C 91 FD CE DD FF 18 DA 3E BB C8 C9
0060 | 27 98 48 2C 37 60 76 D6 E9 C2 7E 06 D2 9E 93 97
0070 | 4F F5 FA 6A C9 F5 B8 10 87 C0 72 1E 85 07 B0 CA
0080 | AC 1F 11 7B 1C A2 DE 65 7B 78 46 F6 59 BA 1B 01
0090 | FC F6 D4 8E 19 6A E3 E8 BE 6A 12 63 95 3B A2 6D
00A0 | 02 18 3A 3B 9F CC B3 9D C6 79 4A 0B 99 87 2B 24
00B0 | D6 ED CB EF 97 F3 95 33 D9 33 99 DA 4F 53 79 8D
00C0 | ED 47 B4 E6 C4 63 4B 82 D4 F0 C7 5B B0 E1 65 76
00D0 | 32 AE AD BF 56 63 B3 42 BD 5D 70 F3 64 C3 20 BF
00E0 | E2 90 89 EE 28 79 29 2A 27 6A 81 58 28 00 03 AD
00F0 | D4 F7 FE 27 5B 56 2E 19 4A CB A3 50 AB 1A 34 6F
0100 | 58 36 4C 57 D2 0F 2E 72 81 9D 12 30 5C B2 B4 DB
0110 | EF 3E FF 3D FF F8 29 21 85 F8 2C 5B AC 77 C6 CB
0120 | 63 05 E1 D2 60 F2 44 4C 76 20 A3 54 ED C0 FD 4A
0130 | 8F 8A AF 05 6E DB 41 A2 F3 9F 31 A5 53 9F 1F 23
0140 | BB C6 0D 2F CC 57 2C 47 25 FC C6 C0 30 6D FD 0F
0150 | D0 00 CA 3B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>BC0F0D00ACBD8465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0448C4BA55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1220852309</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045FE1DB71000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1608637297</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001008C91FDCEDDFF18DA3EBBC8C9</code> <code>2798482C376076D6E9C27E06D29E9397</code> <code>4FF5FA6AC9F5B81087C0721E8507B0CA</code> <code>AC1F117B1CA2DE657B7846F659BA1B01</code> <code>FCF6D48E196AE3E8BE6A1263953BA26D</code> <code>02183A3B9FCCB39DC6794A0B99872B24</code> <code>D6EDCBEF97F39533D93399DA4F53798D</code> <code>ED47B4E6C4634B82D4F0C75BB0E16576</code> <code>32AEADBF5663B342BD5D70F364C320BF</code> <code>E29089EE2879292A276A8158280003AD</code> <code>D4F7FE275B562E194ACBA350AB1A346F</code> <code>58364C57D20F2E72819D12305CB2B4DB</code> <code>EF3EFF3DFFF8292185F82C5BAC77C6CB</code> <code>6305E1D260F2444C7620A354EDC0FD4A</code> <code>8F8AAF056EDB41A2F39F31A5539F1F23</code> <code>BBC60D2FCC572C4725FCC6C0306DFD0F</code><br> <code>D000CA3B</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 DE 43 AD BD 84 65
0010 | A8 02 00 00 5C 07 E8 D0 BF 56 08 04 20 B3 5B 3F
0020 | 3D 97 25 B6 70 95 90 F7 77 36 80 DE F0 DB 45 3E
0030 | 61 12 32 60 A9 D0 1B 7F FE 50 02 00 94 3B 6F 61
0040 | 6D FA 22 0E 8F 05 F9 0F A3 3D BB D4 A6 4C 47 B2
0050 | 87 0F 1B 40 9E 6A 7F DF 37 72 E9 DA 69 C7 14 1D
0060 | BC 47 99 60 7C E9 05 05 88 54 A7 48 4C 40 D0 98
0070 | 85 F8 63 FD 85 8B B4 07 5F 42 6D 1F C4 DD 43 6D
0080 | 29 59 08 1B E7 1E C0 36 CA 1C 85 E3 4D D2 D0 3B
0090 | A3 99 C3 BA C5 07 FD 8C 36 05 40 8B 9B B9 08 9C
00A0 | F5 71 C5 95 A0 7C 22 10 D8 07 3D 8D 4D CC E5 B9
00B0 | 00 B8 D9 92 09 2F 88 1C B1 48 68 D3 21 98 51 C0
00C0 | 88 67 70 D5 9B C7 BC 53 EF 95 FF E8 49 DD 6F 8D
00D0 | D1 52 1E 88 BE B9 3C BB C5 F4 F2 DF 55 30 66 7B
00E0 | 8C A1 52 F4 95 42 EF 9E 87 C1 35 48 71 7D A3 15
00F0 | B6 D8 BA 60 14 D9 7D 47 57 40 11 5C 0C 01 BA 3E
0100 | 37 A8 B7 C8 25 1E 14 31 90 AA C4 E1 93 30 42 8D
0110 | 53 59 8B BF E8 86 2A 6B 8E A5 AD 5C B8 4A 4A FE
0120 | 23 FE 9B 9D 69 56 2D 6D 1B 6C C8 A5 8E 48 DC 33
0130 | 44 96 66 82 1C 50 B4 67 95 2B A2 BB 3F 2A 1D 90
0140 | 71 77 B0 1B A9 3E 75 FD 9E 13 DF 2A 7D 70 8A B4
0150 | C7 C8 CF AE EB 59 52 47 7D 27 32 3F 0E 0C 3E 4F
0160 | 3C D4 9C B5 E2 2A 72 51 E3 40 04 BA 42 B3 3A E0
0170 | EA C9 FB CB AB D9 BD B9 B4 D1 AC 52 9D F6 2D 55
0180 | 72 CA 1A B5 02 5B D0 62 97 70 2B 33 37 C0 64 0B
0190 | 87 02 BD 69 DD 9A D3 34 84 1F 2B C0 7F F8 43 06
01A0 | 81 93 DC F8 3D 69 8A F5 8B C5 9D CE C3 45 0D 79
01B0 | 4D EF 1C D4 9E 90 3A 59 B8 60 E4 45 DD D0 A7 01
01C0 | 40 B0 AB 5B D0 D4 8F 5B CA A9 61 D1 71 31 19 1B
01D0 | E1 92 2C B6 E4 E9 19 64 31 E1 37 15 2F 8F 64 10
01E0 | 7D F2 B1 7F 68 CF 70 8B 1B EA E2 66 D0 68 68 19
01F0 | 5B 0D 89 97 3E DB 19 0F 46 C5 44 B8 EC DB 35 47
0200 | 45 E9 42 BE 39 CC 5A 1E 19 DD 2E C1 B7 A8 2C 36
0210 | 2F 2E 01 07 F8 76 4A F6 A4 B9 DB F2 F4 A8 74 B3
0220 | BB CC A4 6F 7F AE B5 A9 C8 1D 53 7E 47 C5 29 8A
0230 | 80 5E A2 0D 5F D0 53 2D 12 76 81 BC 27 D2 CF 4E
0240 | 3E 1E 60 F2 BF BF 73 1F 5B B7 3D 79 F6 9F E4 7E
0250 | 5C 9E 65 9F 7F 52 10 C0 57 0D 2F CB CF 99 39 D2
0260 | 5B 75 BA 2F BE 9E 8C 49 9E AE EB 54 AB 17 E3 0E
0270 | 66 D0 FE 26 01 DB 74 F2 70 73 B4 E3 E3 FB B3 24
0280 | FD BC 72 5D 21 03 8F 99 FD 3A 75 95</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0138DE43ADBD8465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8020000</code> (680 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200943B6F616DFA220E8F05F90F</code> <code>A33DBBD4A64C47B2870F1B409E6A7FDF</code> <code>3772E9DA69C7141DBC4799607CE90505</code> <code>8854A7484C40D09885F863FD858BB407</code> <code>5F426D1FC4DD436D2959081BE71EC036</code> <code>CA1C85E34DD2D03BA399C3BAC507FD8C</code> <code>3605408B9BB9089CF571C595A07C2210</code> <code>D8073D8D4DCCE5B900B8D992092F881C</code> <code>B14868D3219851C0886770D59BC7BC53</code> <code>EF95FFE849DD6F8DD1521E88BEB93CBB</code> <code>C5F4F2DF5530667B8CA152F49542EF9E</code> <code>87C13548717DA315B6D8BA6014D97D47</code> <code>5740115C0C01BA3E37A8B7C8251E1431</code> <code>90AAC4E19330428D53598BBFE8862A6B</code> <code>8EA5AD5CB84A4AFE23FE9B9D69562D6D</code> <code>1B6CC8A58E48DC33449666821C50B467</code> <code>952BA2BB3F2A1D907177B01BA93E75FD</code> <code>9E13DF2A7D708AB4C7C8CFAEEB595247</code> <code>7D27323F0E0C3E4F3CD49CB5E22A7251</code> <code>E34004BA42B33AE0EAC9FBCBABD9BDB9</code> <code>B4D1AC529DF62D5572CA1AB5025BD062</code> <code>97702B3337C0640B8702BD69DD9AD334</code> <code>841F2BC07FF843068193DCF83D698AF5</code> <code>8BC59DCEC3450D794DEF1CD49E903A59</code> <code>B860E445DDD0A70140B0AB5BD0D48F5B</code> <code>CAA961D17131191BE1922CB6E4E91964</code> <code>31E137152F8F64107DF2B17F68CF708B</code> <code>1BEAE266D06868195B0D89973EDB190F</code> <code>46C544B8ECDB354745E942BE39CC5A1E</code> <code>19DD2EC1B7A82C362F2E0107F8764AF6</code> <code>A4B9DBF2F4A874B3BBCCA46F7FAEB5A9</code> <code>C81D537E47C5298A805EA20D5FD0532D</code> <code>127681BC27D2CF4E3E1E60F2BFBF731F</code> <code>5BB73D79F69FE47E5C9E659F7F5210C0</code> <code>570D2FCBCF9939D25B75BA2FBE9E8C49</code> <code>9EAEEB54AB17E30E66D0FE2601DB74F2</code> <code>7073B4E3E3FBB324FDBC725D21038F99</code><br> <code>FD3A7595</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 943B6F616DFA220E8F05F90FA33DBBD4A64C47B2870F1B409E6A7FDF3772E9DA69C7141DBC4799607CE905058854A7484C40D09885F863FD858BB4075F426D1FC4DD436D2959081BE71EC036CA1C85E34DD2D03BA399C3BAC507FD8C3605408B9BB9089CF571C595A07C2210D8073D8D4DCCE5B900B8D992092F881CB14868D3219851C0886770D59BC7BC53EF95FFE849DD6F8DD1521E88BEB93CBBC5F4F2DF5530667B8CA152F49542EF9E87C13548717DA315B6D8BA6014D97D475740115C0C01BA3E37A8B7C8251E143190AAC4E19330428D53598BBFE8862A6B8EA5AD5CB84A4AFE23FE9B9D69562D6D1B6CC8A58E48DC33449666821C50B467952BA2BB3F2A1D907177B01BA93E75FD9E13DF2A7D708AB4C7C8CFAEEB5952477D27323F0E0C3E4F3CD49CB5E22A7251E34004BA42B33AE0EAC9FBCBABD9BDB9B4D1AC529DF62D5572CA1AB5025BD06297702B3337C0640B8702BD69DD9AD334841F2BC07FF843068193DCF83D698AF58BC59DCEC3450D794DEF1CD49E903A59B860E445DDD0A70140B0AB5BD0D48F5BCAA961D17131191BE1922CB6E4E9196431E137152F8F64107DF2B17F68CF708B1BEAE266D06868195B0D89973EDB190F46C544B8ECDB354745E942BE39CC5A1E19DD2EC1B7A82C362F2E0107F8764AF6A4B9DBF2F4A874B3BBCCA46F7FAEB5A9C81D537E47C5298A805EA20D5FD0532D127681BC27D2CF4E3E1E60F2BFBF731F5BB73D79F69FE47E5C9E659F7F5210C0570D2FCBCF9939D25B75BA2FBE9E8C499EAEEB54AB17E30E66D0FE2601DB74F27073B4E3E3FBB324FDBC725D21038F99FD3A7595
tmp_aes_key = 2BB30D11720BD1F2C2323FED7A87157D31789B91B22BC565DC9F6529B403565B
tmp_aes_iv = AAD72AEF389D0A44891EC9D3E073E1D9D2D9E04956124878DE8495E391450453</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 7BB511000F89DB5432D58139ACE05F8AE81B0135BA0D89B5BF56080420B35B3F3D9725B6709590F7773680DEF0DB453E61123260A9D01B7F03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004BCEA0BB4772EEF6A5A7E95D61F62E04A99CE818A784EFA82D0F2BF034182E1607CDA483AA28CF2EAF91CBC7E11EFEADD2E47F4CD95F2461F15D59C1E69B7239A40A5C71C1D9275D3AA4162729746245F3DFD65DFD74F648BF7CB4994E01D0898FBFB81F229F2850452503FFA4C0F73404BCB25EC8131F8D06AAEA1C2B479A1D6EF45F0C37C241C6E1808CB8DB20CD80DD0FA24CC4E9D9DB2F7D89DF1E43B37305236CC568C642061306CE3E6127593DC64C6231069E286963F7640C2E52E07A95419962FE40D26AA86E367BCBEFFCC048FF70425AD59CDBD5EAF8ABD7F6E33973784A24F74E1AF05CEF906AFC8559CBEA3546CDD081619148418777093A6641ADBD8465DC8CB9954DE0E279
answer = BA0D89B5BF56080420B35B3F3D9725B6709590F7773680DEF0DB453E61123260A9D01B7F03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004BCEA0BB4772EEF6A5A7E95D61F62E04A99CE818A784EFA82D0F2BF034182E1607CDA483AA28CF2EAF91CBC7E11EFEADD2E47F4CD95F2461F15D59C1E69B7239A40A5C71C1D9275D3AA4162729746245F3DFD65DFD74F648BF7CB4994E01D0898FBFB81F229F2850452503FFA4C0F73404BCB25EC8131F8D06AAEA1C2B479A1D6EF45F0C37C241C6E1808CB8DB20CD80DD0FA24CC4E9D9DB2F7D89DF1E43B37305236CC568C642061306CE3E6127593DC64C6231069E286963F7640C2E52E07A95419962FE40D26AA86E367BCBEFFCC048FF70425AD59CDBD5EAF8ABD7F6E33973784A24F74E1AF05CEF906AFC8559CBEA3546CDD081619148418777093A6641ADBD8465DC8CB9954DE0E279</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 BF 56 08 04 20 B3 5B 3F 3D 97 25 B6
0010 | 70 95 90 F7 77 36 80 DE F0 DB 45 3E 61 12 32 60
0020 | A9 D0 1B 7F 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 4B CE A0 BB 47 72 EE F6 A5 A7 E9 5D 61 F6 2E 04
0140 | A9 9C E8 18 A7 84 EF A8 2D 0F 2B F0 34 18 2E 16
0150 | 07 CD A4 83 AA 28 CF 2E AF 91 CB C7 E1 1E FE AD
0160 | D2 E4 7F 4C D9 5F 24 61 F1 5D 59 C1 E6 9B 72 39
0170 | A4 0A 5C 71 C1 D9 27 5D 3A A4 16 27 29 74 62 45
0180 | F3 DF D6 5D FD 74 F6 48 BF 7C B4 99 4E 01 D0 89
0190 | 8F BF B8 1F 22 9F 28 50 45 25 03 FF A4 C0 F7 34
01A0 | 04 BC B2 5E C8 13 1F 8D 06 AA EA 1C 2B 47 9A 1D
01B0 | 6E F4 5F 0C 37 C2 41 C6 E1 80 8C B8 DB 20 CD 80
01C0 | DD 0F A2 4C C4 E9 D9 DB 2F 7D 89 DF 1E 43 B3 73
01D0 | 05 23 6C C5 68 C6 42 06 13 06 CE 3E 61 27 59 3D
01E0 | C6 4C 62 31 06 9E 28 69 63 F7 64 0C 2E 52 E0 7A
01F0 | 95 41 99 62 FE 40 D2 6A A8 6E 36 7B CB EF FC C0
0200 | 48 FF 70 42 5A D5 9C DB D5 EA F8 AB D7 F6 E3 39
0210 | 73 78 4A 24 F7 4E 1A F0 5C EF 90 6A FC 85 59 CB
0220 | EA 35 46 CD D0 81 61 91 48 41 87 77 09 3A 66 41
0230 | AD BD 84 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001004BCEA0BB4772EEF6A5A7E95D</code> <code>61F62E04A99CE818A784EFA82D0F2BF0</code> <code>34182E1607CDA483AA28CF2EAF91CBC7</code> <code>E11EFEADD2E47F4CD95F2461F15D59C1</code> <code>E69B7239A40A5C71C1D9275D3AA41627</code> <code>29746245F3DFD65DFD74F648BF7CB499</code> <code>4E01D0898FBFB81F229F2850452503FF</code> <code>A4C0F73404BCB25EC8131F8D06AAEA1C</code> <code>2B479A1D6EF45F0C37C241C6E1808CB8</code> <code>DB20CD80DD0FA24CC4E9D9DB2F7D89DF</code> <code>1E43B37305236CC568C642061306CE3E</code> <code>6127593DC64C6231069E286963F7640C</code> <code>2E52E07A95419962FE40D26AA86E367B</code> <code>CBEFFCC048FF70425AD59CDBD5EAF8AB</code> <code>D7F6E33973784A24F74E1AF05CEF906A</code> <code>FC8559CBEA3546CDD081619148418777</code><br> <code>093A6641</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>ADBD8465</code> (1703198125 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = AD2168E1D53ACD5C8F4C968E16EDA76F5D1E87D2ECFB56265F9AEE921D828A9808D63C3A568E1B76C1FAC8CA67E0EB9E3575D06AEA28F3B301667235418900D22F017FBD1CEC31F3D9A22D8531CD48172286DDC6AD42C3B200B080616F9D9EEC3B1F9E7FC95954254E7F87F536F16486FAA74915638284C797B4183D55FF6FF20CE1568C5ACBE7F70C76D310FB4A80E939C26FCE6EF68AFCDFD945A3501270571F5D88A3FF61E823A2D8B7BB360A8270D86F372995D2C70D4EE49563467443CB6C062F232CD8DCBBE8693A4CCAF75CAA6B8389B558D28FBBA75AC0013816B9FE048AF9C1003FBDD5FFAF5E69D2CFE210D036C16E2EB77E081BAD3F49504EF68E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B40164F977F0B2986229D609AF47C7C5B8A67FFC7FD85EB79370C15A52453679FC2F45F0C16E6F2931CBACB92056453CC01727AEC133A295E4A99D43A34B60FF23C8C3C251344721D95C8953BA3FD7EC9D8AAB27696A5DFA2499EC3411194E5D3CFAF5FB31945250A649FFA96C4403CF8E3FC79277342AB32A6991F3BACEE2647AE1CB67233528F30E94C41BC8B5871D1A407158DB74C7844506754243C706AEF420AEE843571B0727B801E0B33C744677F46DE86B3A058E5EF5643042A4E4E1F72DBA8B9E842001B34C536DC2422754447372D876AE39BA9BD40BBB86065A9C4B8BD2EB099E6516F907989165EDCF55DEE222FC0C2DFF27A405EAFD4D42656F</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 BF 56 08 04 20 B3 5B 3F 3D 97 25 B6
0010 | 70 95 90 F7 77 36 80 DE F0 DB 45 3E 61 12 32 60
0020 | A9 D0 1B 7F 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B4 01 64 F9 77 F0 B2 98 62 29 D6 09 AF 47 C7 C5
0040 | B8 A6 7F FC 7F D8 5E B7 93 70 C1 5A 52 45 36 79
0050 | FC 2F 45 F0 C1 6E 6F 29 31 CB AC B9 20 56 45 3C
0060 | C0 17 27 AE C1 33 A2 95 E4 A9 9D 43 A3 4B 60 FF
0070 | 23 C8 C3 C2 51 34 47 21 D9 5C 89 53 BA 3F D7 EC
0080 | 9D 8A AB 27 69 6A 5D FA 24 99 EC 34 11 19 4E 5D
0090 | 3C FA F5 FB 31 94 52 50 A6 49 FF A9 6C 44 03 CF
00A0 | 8E 3F C7 92 77 34 2A B3 2A 69 91 F3 BA CE E2 64
00B0 | 7A E1 CB 67 23 35 28 F3 0E 94 C4 1B C8 B5 87 1D
00C0 | 1A 40 71 58 DB 74 C7 84 45 06 75 42 43 C7 06 AE
00D0 | F4 20 AE E8 43 57 1B 07 27 B8 01 E0 B3 3C 74 46
00E0 | 77 F4 6D E8 6B 3A 05 8E 5E F5 64 30 42 A4 E4 E1
00F0 | F7 2D BA 8B 9E 84 20 01 B3 4C 53 6D C2 42 27 54
0100 | 44 73 72 D8 76 AE 39 BA 9B D4 0B BB 86 06 5A 9C
0110 | 4B 8B D2 EB 09 9E 65 16 F9 07 98 91 65 ED CF 55
0120 | DE E2 22 FC 0C 2D FF 27 A4 05 EA FD 4D 42 65 6F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B40164F977F0B2986229D609</code> <code>AF47C7C5B8A67FFC7FD85EB79370C15A</code> <code>52453679FC2F45F0C16E6F2931CBACB9</code> <code>2056453CC01727AEC133A295E4A99D43</code> <code>A34B60FF23C8C3C251344721D95C8953</code> <code>BA3FD7EC9D8AAB27696A5DFA2499EC34</code> <code>11194E5D3CFAF5FB31945250A649FFA9</code> <code>6C4403CF8E3FC79277342AB32A6991F3</code> <code>BACEE2647AE1CB67233528F30E94C41B</code> <code>C8B5871D1A407158DB74C78445067542</code> <code>43C706AEF420AEE843571B0727B801E0</code> <code>B33C744677F46DE86B3A058E5EF56430</code> <code>42A4E4E1F72DBA8B9E842001B34C536D</code> <code>C2422754447372D876AE39BA9BD40BBB</code> <code>86065A9C4B8BD2EB099E6516F9079891</code> <code>65EDCF55DEE222FC0C2DFF27A405EAFD</code><br> <code>4D42656F</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366BF56080420B35B3F3D9725B6709590F7773680DEF0DB453E61123260A9D01B7F0000000000000000FE000100B40164F977F0B2986229D609AF47C7C5B8A67FFC7FD85EB79370C15A52453679FC2F45F0C16E6F2931CBACB92056453CC01727AEC133A295E4A99D43A34B60FF23C8C3C251344721D95C8953BA3FD7EC9D8AAB27696A5DFA2499EC3411194E5D3CFAF5FB31945250A649FFA96C4403CF8E3FC79277342AB32A6991F3BACEE2647AE1CB67233528F30E94C41BC8B5871D1A407158DB74C7844506754243C706AEF420AEE843571B0727B801E0B33C744677F46DE86B3A058E5EF5643042A4E4E1F72DBA8B9E842001B34C536DC2422754447372D876AE39BA9BD40BBB86065A9C4B8BD2EB099E6516F907989165EDCF55DEE222FC0C2DFF27A405EAFD4D42656F
padding = 57FC2E97B1589A62687AC4A5
tmp_aes_key = 2BB30D11720BD1F2C2323FED7A87157D31789B91B22BC565DC9F6529B403565B
tmp_aes_iv = AAD72AEF389D0A44891EC9D3E073E1D9D2D9E04956124878DE8495E391450453</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 0B4BFDEBDFE5D65DEEF19E7EEB18A1D35E36452FC1F56E6C005A875F2456175A83728704831E8FA250D12FE771D123A7EC56870D23292577B9BF37F54FED232E76FC920B6207E8D5D891B27ACF015573023A66E3B839CDC16529EAA327107D5CFEEAC73DAB509135CD8FA9A968B05569F8B704ED389C9E46A022FDD5C58C4F3FA41E9208C53D16F92FBC821FD30900B23077205FCDA1D46FDDD4EDF10A1B72AD43481FA829FC7DA91E5A8BCD5AD009B0119208B92E5BCC63903FBD5EA68AF8323085252238CC94BAA3614BE6CD480532CCFBD9ED9A834CDB49BDCE4D155AFA950711B5745E83C22B57DD18E38E4B19FCF2747D717B3A80FF9D2FAE6A1D21434AAAF2FA90C12FEB4B553A7E88594485CEF8F3AA3D71A85C09EC9B004174463E54FAA817D7867201BDC77B75FC11FB3525F21D8B858AE84F329D697D4250A60C540F428E09A316A17708A48339E5CC5F9D</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F8 D8 0E 00 AD BD 84 65
0010 | 78 01 00 00 1F 5F 04 F5 BF 56 08 04 20 B3 5B 3F
0020 | 3D 97 25 B6 70 95 90 F7 77 36 80 DE F0 DB 45 3E
0030 | 61 12 32 60 A9 D0 1B 7F FE 50 01 00 0B 4B FD EB
0040 | DF E5 D6 5D EE F1 9E 7E EB 18 A1 D3 5E 36 45 2F
0050 | C1 F5 6E 6C 00 5A 87 5F 24 56 17 5A 83 72 87 04
0060 | 83 1E 8F A2 50 D1 2F E7 71 D1 23 A7 EC 56 87 0D
0070 | 23 29 25 77 B9 BF 37 F5 4F ED 23 2E 76 FC 92 0B
0080 | 62 07 E8 D5 D8 91 B2 7A CF 01 55 73 02 3A 66 E3
0090 | B8 39 CD C1 65 29 EA A3 27 10 7D 5C FE EA C7 3D
00A0 | AB 50 91 35 CD 8F A9 A9 68 B0 55 69 F8 B7 04 ED
00B0 | 38 9C 9E 46 A0 22 FD D5 C5 8C 4F 3F A4 1E 92 08
00C0 | C5 3D 16 F9 2F BC 82 1F D3 09 00 B2 30 77 20 5F
00D0 | CD A1 D4 6F DD D4 ED F1 0A 1B 72 AD 43 48 1F A8
00E0 | 29 FC 7D A9 1E 5A 8B CD 5A D0 09 B0 11 92 08 B9
00F0 | 2E 5B CC 63 90 3F BD 5E A6 8A F8 32 30 85 25 22
0100 | 38 CC 94 BA A3 61 4B E6 CD 48 05 32 CC FB D9 ED
0110 | 9A 83 4C DB 49 BD CE 4D 15 5A FA 95 07 11 B5 74
0120 | 5E 83 C2 2B 57 DD 18 E3 8E 4B 19 FC F2 74 7D 71
0130 | 7B 3A 80 FF 9D 2F AE 6A 1D 21 43 4A AA F2 FA 90
0140 | C1 2F EB 4B 55 3A 7E 88 59 44 85 CE F8 F3 AA 3D
0150 | 71 A8 5C 09 EC 9B 00 41 74 46 3E 54 FA A8 17 D7
0160 | 86 72 01 BD C7 7B 75 FC 11 FB 35 25 F2 1D 8B 85
0170 | 8A E8 4F 32 9D 69 7D 42 50 A6 0C 54 0F 42 8E 09
0180 | A3 16 A1 77 08 A4 83 39 E5 CC 5F 9D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F8D80E00ADBD8465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001000B4BFDEBDFE5D65DEEF19E7E</code> <code>EB18A1D35E36452FC1F56E6C005A875F</code> <code>2456175A83728704831E8FA250D12FE7</code> <code>71D123A7EC56870D23292577B9BF37F5</code> <code>4FED232E76FC920B6207E8D5D891B27A</code> <code>CF015573023A66E3B839CDC16529EAA3</code> <code>27107D5CFEEAC73DAB509135CD8FA9A9</code> <code>68B05569F8B704ED389C9E46A022FDD5</code> <code>C58C4F3FA41E9208C53D16F92FBC821F</code> <code>D30900B23077205FCDA1D46FDDD4EDF1</code> <code>0A1B72AD43481FA829FC7DA91E5A8BCD</code> <code>5AD009B0119208B92E5BCC63903FBD5E</code> <code>A68AF8323085252238CC94BAA3614BE6</code> <code>CD480532CCFBD9ED9A834CDB49BDCE4D</code> <code>155AFA950711B5745E83C22B57DD18E3</code> <code>8E4B19FCF2747D717B3A80FF9D2FAE6A</code> <code>1D21434AAAF2FA90C12FEB4B553A7E88</code> <code>594485CEF8F3AA3D71A85C09EC9B0041</code> <code>74463E54FAA817D7867201BDC77B75FC</code> <code>11FB3525F21D8B858AE84F329D697D42</code> <code>50A60C540F428E09A316A17708A48339</code><br> <code>E5CC5F9D</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2AC4D1821C4675840C1DD51E8BACA406727E346DC5B7CA778BB0B5AD91CB6C2004CC41F12D1095577BE5ED66E9311124AA278346D5C2563B0EF40171BDE15FC2BC98D8AAC61AE4DB2E2247DC2280A7BABB50F31187600DDC10E76C90E35C1728F4AA85178DF579DE4FC3CE8B1380904E4CB66674F82BCB00F179B34BB7FC7F239C76B50B49592B47CF3E7CF44F507E033F4EFE6E977259E68EE65A4293456CBB19EE1EE0779B7D7C379AC4D0F160D4AEF750C6EBC142B6A43C633C434A8AAE448388896100EADE10DCA59E1907DF381540392685473E8CD8DB5E4D1224A175B1D6BD2144E4A5142BA514E718D35AB33A8B0173298061FC199A1A0C365913DE43</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 84 B1 94 AD BD 84 65
0010 | 54 00 00 00 34 F7 CB 3B BF 56 08 04 20 B3 5B 3F
0020 | 3D 97 25 B6 70 95 90 F7 77 36 80 DE F0 DB 45 3E
0030 | 61 12 32 60 A9 D0 1B 7F 04 B3 2D B8 20 43 BE B0
0040 | EA A2 09 62 BF 78 B3 B0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0184B194ADBD8465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BF56080420B35B3F3D9725B6709590F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>773680DEF0DB453E61123260A9D01B7F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>04B32DB82043BEB0EAA20962BF78B3B0</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

