<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D4 4F 0D 00 E1 5A 77 65
0010 | 14 00 00 00 F1 8E 7E BE 83 FE 4F A7 D6 AD 1B 8A
0020 | C7 63 8A 36 AD AB 7A 9A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D44F0D00E15A7765</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 48 2B A5 E1 5A 77 65
0010 | 50 00 00 00 63 24 16 05 83 FE 4F A7 D6 AD 1B 8A
0020 | C7 63 8A 36 AD AB 7A 9A 65 D6 6D 4E 1C C2 16 5A
0030 | 23 E8 D1 8C 4D 3B 8A B7 08 20 CF 44 AD 25 51 F1
0040 | A5 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01482BA5E15A7765</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0820CF44AD2551F1A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2364183839838957989</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2364183839838957989</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2364183839838957989 = 1537378891 * 1537801679</code></p>
<pre><code>p = 1537378891
q = 1537801679</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 CF 44 AD 25 51 F1 A5 00 00 00
0010 | 04 5B A2 8A 4B 00 00 00 04 5B A8 FD CF 00 00 00
0020 | 83 FE 4F A7 D6 AD 1B 8A C7 63 8A 36 AD AB 7A 9A
0030 | 65 D6 6D 4E 1C C2 16 5A 23 E8 D1 8C 4D 3B 8A B7
0040 | 31 44 7E EA FB 1F D5 B6 FF 81 2A 79 EA 09 64 82
0050 | C4 D8 2B 69 5B 78 4E 95 AE 15 F1 FD 4D 3B 3B 27
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0820CF44AD2551F1A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2364183839838957989</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045BA28A4B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1537378891</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045BA8FDCF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1537801679</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>31447EEAFB1FD5B6FF812A79EA096482</code> <code>C4D82B695B784E95AE15F1FD4D3B3B27</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90820CF44AD2551F1A5000000045BA28A4B000000045BA8FDCF00000083FE4FA7D6AD1B8AC7638A36ADAB7A9A65D66D4E1CC2165A23E8D18C4D3B8AB731447EEAFB1FD5B6FF812A79EA096482C4D82B695B784E95AE15F1FD4D3B3B2702000000
random_padding_bytes = 5C1FC0512F2CBE5890F34A0389768EC59F8D369EA3FB98795CF7624BBF2ADC6CF0758829E4F76B167D4EAEF4495D095CE9E3819F7ACB4E02326B1CD2FE68A23F853CD6B5464497B80CEC4373ABBA570278A4D86EA92C49BC65975D55</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 45EF3882B8D866441F9099FDC19285855319042329013E110DCF0C325DE077A434D7D49F0CE10453D313CD034D26E7B1531DBE1B266578B1EB39993C9F4F4A41120C2FC41C78961AD6D35315F51E1FAC62836E08B3422D8CC5179DF4947B6E66F9F6F6836A985CE87D2C27FEEF33B4101281BEB2E9E45EBC026F4EFF3A47EC2EE2AF310D63579575C85D24A0CBE8B95D1AA03DA954C319B8A369FA8D4C057875C87317C016D43A4F6F4B631B15900D6AE7A8138712B4234694C18B8F4CA381D6E123262DBE51793B81771F70B74983F1FEDD5A57296EA575C78B08026E116CC32B5F1A7E3F6C44E03F342689682386B6E61D2A9DEAA5BC5E8C074EE3450D8847</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D8 4F 0D 00 E1 5A 77 65
0010 | 40 01 00 00 BE E4 12 D7 83 FE 4F A7 D6 AD 1B 8A
0020 | C7 63 8A 36 AD AB 7A 9A 65 D6 6D 4E 1C C2 16 5A
0030 | 23 E8 D1 8C 4D 3B 8A B7 04 5B A2 8A 4B 00 00 00
0040 | 04 5B A8 FD CF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 45 EF 38 82 B8 D8 66 44 1F 90 99 FD
0060 | C1 92 85 85 53 19 04 23 29 01 3E 11 0D CF 0C 32
0070 | 5D E0 77 A4 34 D7 D4 9F 0C E1 04 53 D3 13 CD 03
0080 | 4D 26 E7 B1 53 1D BE 1B 26 65 78 B1 EB 39 99 3C
0090 | 9F 4F 4A 41 12 0C 2F C4 1C 78 96 1A D6 D3 53 15
00A0 | F5 1E 1F AC 62 83 6E 08 B3 42 2D 8C C5 17 9D F4
00B0 | 94 7B 6E 66 F9 F6 F6 83 6A 98 5C E8 7D 2C 27 FE
00C0 | EF 33 B4 10 12 81 BE B2 E9 E4 5E BC 02 6F 4E FF
00D0 | 3A 47 EC 2E E2 AF 31 0D 63 57 95 75 C8 5D 24 A0
00E0 | CB E8 B9 5D 1A A0 3D A9 54 C3 19 B8 A3 69 FA 8D
00F0 | 4C 05 78 75 C8 73 17 C0 16 D4 3A 4F 6F 4B 63 1B
0100 | 15 90 0D 6A E7 A8 13 87 12 B4 23 46 94 C1 8B 8F
0110 | 4C A3 81 D6 E1 23 26 2D BE 51 79 3B 81 77 1F 70
0120 | B7 49 83 F1 FE DD 5A 57 29 6E A5 75 C7 8B 08 02
0130 | 6E 11 6C C3 2B 5F 1A 7E 3F 6C 44 E0 3F 34 26 89
0140 | 68 23 86 B6 E6 1D 2A 9D EA A5 BC 5E 8C 07 4E E3
0150 | 45 0D 88 47</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D84F0D00E15A7765</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045BA28A4B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1537378891</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045BA8FDCF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1537801679</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010045EF3882B8D866441F9099FD</code> <code>C19285855319042329013E110DCF0C32</code> <code>5DE077A434D7D49F0CE10453D313CD03</code> <code>4D26E7B1531DBE1B266578B1EB39993C</code> <code>9F4F4A41120C2FC41C78961AD6D35315</code> <code>F51E1FAC62836E08B3422D8CC5179DF4</code> <code>947B6E66F9F6F6836A985CE87D2C27FE</code> <code>EF33B4101281BEB2E9E45EBC026F4EFF</code> <code>3A47EC2EE2AF310D63579575C85D24A0</code> <code>CBE8B95D1AA03DA954C319B8A369FA8D</code> <code>4C057875C87317C016D43A4F6F4B631B</code> <code>15900D6AE7A8138712B4234694C18B8F</code> <code>4CA381D6E123262DBE51793B81771F70</code> <code>B74983F1FEDD5A57296EA575C78B0802</code> <code>6E116CC32B5F1A7E3F6C44E03F342689</code> <code>682386B6E61D2A9DEAA5BC5E8C074EE3</code><br> <code>450D8847</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 08 20 3C E2 5A 77 65
0010 | 7C 02 00 00 5C 07 E8 D0 83 FE 4F A7 D6 AD 1B 8A
0020 | C7 63 8A 36 AD AB 7A 9A 65 D6 6D 4E 1C C2 16 5A
0030 | 23 E8 D1 8C 4D 3B 8A B7 FE 50 02 00 1B 41 8E 98
0040 | EC D0 FD 3F D2 EF 59 07 95 5A 6B A0 9F EE BE BD
0050 | 4D 57 93 DB 90 D1 81 71 0B FD 5A 3A E1 22 7C D4
0060 | 68 DF 74 2E C1 C8 52 57 B5 6F 50 36 4F FE E2 EF
0070 | F1 50 F7 8A EE 2B 71 FC AD 2F CB 68 4A 8C D3 88
0080 | 71 44 A1 E4 26 D8 86 A0 31 42 D2 88 69 FA 5B 5E
0090 | 01 C8 98 49 43 75 AB 2B 68 55 71 A7 5D 98 81 AA
00A0 | 39 5B C9 89 E7 CF 09 AF FE E9 B5 EA E4 2A 9C C1
00B0 | DF 8C 15 FD C3 70 85 9E FA CF 1D 86 3A EA DD A1
00C0 | A0 F8 3A C2 94 2B EB 91 57 A4 9A 70 69 2B 28 4E
00D0 | 4B 45 B8 BF 7B 3B B4 09 58 88 C6 A1 7A 11 04 B7
00E0 | 72 43 91 10 A0 FB B5 5F 89 47 A6 6A 1A B2 30 E8
00F0 | F2 52 51 41 62 0F E3 5D AC 0A 4F 21 16 F0 0B 11
0100 | CF 1F DF 9D 2A C1 74 3F E6 BF 55 66 F9 0B 7D C4
0110 | 86 95 BE EF 87 60 C4 E6 9E 4B AD D2 F6 B9 FA ED
0120 | 26 51 92 F2 92 56 BB BA 9B D2 AA 52 72 1C 76 0D
0130 | BA 91 7B C1 DC 33 BF 7C FD 2B C0 EE 0B 9E 78 9B
0140 | DB 96 DA 36 62 00 D7 27 96 80 7A FF CE 87 09 12
0150 | 1E A4 60 AD 44 CD 21 20 2A 84 34 7B B8 F9 D5 81
0160 | DA 1D A0 03 1B AB 51 23 8B 17 3A 66 0D DF 1A 25
0170 | DB 4C D5 1C 6F 77 2E 59 8D E6 B6 27 EB FE 69 32
0180 | 1C B8 BC 00 09 B4 87 A0 6C 0C 18 0B 5C 82 32 B9
0190 | 16 B5 17 AA 63 6A 1F 14 53 14 E4 F8 39 84 47 08
01A0 | E6 11 43 62 BD FC 4B D3 22 6F 21 B5 9C AA 01 AC
01B0 | FE 2D 76 03 71 96 BC F5 E2 94 DC D6 4E 80 90 A1
01C0 | 2D D6 8F 6E 23 A1 04 79 0D F8 0D EA 65 31 3A 15
01D0 | 6F 45 C3 18 49 0F 5F EF 40 74 B8 E0 4B 0B C3 C5
01E0 | F9 FB FF 6A 0B F4 BC 6E 7C 81 86 EF C3 E3 31 AB
01F0 | 3C 3F 29 4D F2 6D 91 A4 00 57 74 A5 E2 DB E4 49
0200 | 75 A2 7F 9E 23 F1 24 71 FE DF DF A5 75 89 3C B4
0210 | 26 31 71 F6 B3 DE 8E 6D C7 C8 BE 0D 93 6B 2E 21
0220 | 2E 79 EA 90 8A EC 26 B6 B9 88 12 5B 47 63 07 DE
0230 | 4C B5 50 19 24 11 2E 49 B0 42 35 F3 87 34 CD FF
0240 | B5 11 D3 D8 B0 C7 CA 21 A7 89 BC 86 D4 37 77 BF
0250 | 20 5E B8 82 95 1C 4E 5C 82 20 E6 62 1F CA 6E 1A
0260 | BF 02 7B B9 C3 DF 35 6A 78 50 16 E4 A9 F4 C9 C5
0270 | 42 2E 08 81 EF F3 DC F6 16 78 5E EE E5 E8 F3 6E
0280 | 8A C8 3A D6 1A 51 35 22 9F C0 66 A7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0108203CE25A7765</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>7C020000</code> (636 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002001B418E98ECD0FD3FD2EF5907</code> <code>955A6BA09FEEBEBD4D5793DB90D18171</code> <code>0BFD5A3AE1227CD468DF742EC1C85257</code> <code>B56F50364FFEE2EFF150F78AEE2B71FC</code> <code>AD2FCB684A8CD3887144A1E426D886A0</code> <code>3142D28869FA5B5E01C898494375AB2B</code> <code>685571A75D9881AA395BC989E7CF09AF</code> <code>FEE9B5EAE42A9CC1DF8C15FDC370859E</code> <code>FACF1D863AEADDA1A0F83AC2942BEB91</code> <code>57A49A70692B284E4B45B8BF7B3BB409</code> <code>5888C6A17A1104B772439110A0FBB55F</code> <code>8947A66A1AB230E8F2525141620FE35D</code> <code>AC0A4F2116F00B11CF1FDF9D2AC1743F</code> <code>E6BF5566F90B7DC48695BEEF8760C4E6</code> <code>9E4BADD2F6B9FAED265192F29256BBBA</code> <code>9BD2AA52721C760DBA917BC1DC33BF7C</code> <code>FD2BC0EE0B9E789BDB96DA366200D727</code> <code>96807AFFCE8709121EA460AD44CD2120</code> <code>2A84347BB8F9D581DA1DA0031BAB5123</code> <code>8B173A660DDF1A25DB4CD51C6F772E59</code> <code>8DE6B627EBFE69321CB8BC0009B487A0</code> <code>6C0C180B5C8232B916B517AA636A1F14</code> <code>5314E4F839844708E6114362BDFC4BD3</code> <code>226F21B59CAA01ACFE2D76037196BCF5</code> <code>E294DCD64E8090A12DD68F6E23A10479</code> <code>0DF80DEA65313A156F45C318490F5FEF</code> <code>4074B8E04B0BC3C5F9FBFF6A0BF4BC6E</code> <code>7C8186EFC3E331AB3C3F294DF26D91A4</code> <code>005774A5E2DBE44975A27F9E23F12471</code> <code>FEDFDFA575893CB4263171F6B3DE8E6D</code> <code>C7C8BE0D936B2E212E79EA908AEC26B6</code> <code>B988125B476307DE4CB5501924112E49</code> <code>B04235F38734CDFFB511D3D8B0C7CA21</code> <code>A789BC86D43777BF205EB882951C4E5C</code> <code>8220E6621FCA6E1ABF027BB9C3DF356A</code> <code>785016E4A9F4C9C5422E0881EFF3DCF6</code> <code>16785EEEE5E8F36E8AC83AD61A513522</code><br> <code>9FC066A7</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 1B418E98ECD0FD3FD2EF5907955A6BA09FEEBEBD4D5793DB90D181710BFD5A3AE1227CD468DF742EC1C85257B56F50364FFEE2EFF150F78AEE2B71FCAD2FCB684A8CD3887144A1E426D886A03142D28869FA5B5E01C898494375AB2B685571A75D9881AA395BC989E7CF09AFFEE9B5EAE42A9CC1DF8C15FDC370859EFACF1D863AEADDA1A0F83AC2942BEB9157A49A70692B284E4B45B8BF7B3BB4095888C6A17A1104B772439110A0FBB55F8947A66A1AB230E8F2525141620FE35DAC0A4F2116F00B11CF1FDF9D2AC1743FE6BF5566F90B7DC48695BEEF8760C4E69E4BADD2F6B9FAED265192F29256BBBA9BD2AA52721C760DBA917BC1DC33BF7CFD2BC0EE0B9E789BDB96DA366200D72796807AFFCE8709121EA460AD44CD21202A84347BB8F9D581DA1DA0031BAB51238B173A660DDF1A25DB4CD51C6F772E598DE6B627EBFE69321CB8BC0009B487A06C0C180B5C8232B916B517AA636A1F145314E4F839844708E6114362BDFC4BD3226F21B59CAA01ACFE2D76037196BCF5E294DCD64E8090A12DD68F6E23A104790DF80DEA65313A156F45C318490F5FEF4074B8E04B0BC3C5F9FBFF6A0BF4BC6E7C8186EFC3E331AB3C3F294DF26D91A4005774A5E2DBE44975A27F9E23F12471FEDFDFA575893CB4263171F6B3DE8E6DC7C8BE0D936B2E212E79EA908AEC26B6B988125B476307DE4CB5501924112E49B04235F38734CDFFB511D3D8B0C7CA21A789BC86D43777BF205EB882951C4E5C8220E6621FCA6E1ABF027BB9C3DF356A785016E4A9F4C9C5422E0881EFF3DCF616785EEEE5E8F36E8AC83AD61A5135229FC066A7
tmp_aes_key = 77956CAD707C98DD3C0873D0AF3F3388D352E8EF9E3A478719F1F8FD0A1946A3
tmp_aes_iv = 37D0003B77E9B64CC8CB4DF0E64D69CB4A3520877049D1AE1843149831447EEA</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 6AE107D87B0AC6EF18785CB308A21F0D961516CBBA0D89B583FE4FA7D6AD1B8AC7638A36ADAB7A9A65D66D4E1CC2165A23E8D18C4D3B8AB703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BC15179B7B777707A4BC1DD6EFEB86AE7266F68F792CEB76DE1F052FB95BC4C3C8FC438496ED2AAE99DE6E31D49027448A5C7FF6695600E2F368B3E4437EAC9CFA9E21E7AEBCFCAE28A506D6B30A187163A01905EDE179B80DF01BBBC224FBEBB6CF0BE21C4057A71FB57D9664E3458893ED3F88C4A980FC0C0A225E52F7AF4791E91AE862279B9A998A462A759630C5F15DCDC4E1DA9473326E86AD62441805D14C0E8AF75AC36B41418AB0C42BEE3DA18530F891509AA43B9AE8915EFAA45BC2D27B8A69FC1061E1AE2573891B3ADB21E306594347BB09407D41760D8E3DEA1948909A4D8CAE0EA61B4C32FE4E0D11F48D8ED82C1D3BEA6FD5B42EA962251CE25A7765495A203E6B0661AC
answer = BA0D89B583FE4FA7D6AD1B8AC7638A36ADAB7A9A65D66D4E1CC2165A23E8D18C4D3B8AB703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BC15179B7B777707A4BC1DD6EFEB86AE7266F68F792CEB76DE1F052FB95BC4C3C8FC438496ED2AAE99DE6E31D49027448A5C7FF6695600E2F368B3E4437EAC9CFA9E21E7AEBCFCAE28A506D6B30A187163A01905EDE179B80DF01BBBC224FBEBB6CF0BE21C4057A71FB57D9664E3458893ED3F88C4A980FC0C0A225E52F7AF4791E91AE862279B9A998A462A759630C5F15DCDC4E1DA9473326E86AD62441805D14C0E8AF75AC36B41418AB0C42BEE3DA18530F891509AA43B9AE8915EFAA45BC2D27B8A69FC1061E1AE2573891B3ADB21E306594347BB09407D41760D8E3DEA1948909A4D8CAE0EA61B4C32FE4E0D11F48D8ED82C1D3BEA6FD5B42EA962251CE25A7765495A203E6B0661AC</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 83 FE 4F A7 D6 AD 1B 8A C7 63 8A 36
0010 | AD AB 7A 9A 65 D6 6D 4E 1C C2 16 5A 23 E8 D1 8C
0020 | 4D 3B 8A B7 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | BC 15 17 9B 7B 77 77 07 A4 BC 1D D6 EF EB 86 AE
0140 | 72 66 F6 8F 79 2C EB 76 DE 1F 05 2F B9 5B C4 C3
0150 | C8 FC 43 84 96 ED 2A AE 99 DE 6E 31 D4 90 27 44
0160 | 8A 5C 7F F6 69 56 00 E2 F3 68 B3 E4 43 7E AC 9C
0170 | FA 9E 21 E7 AE BC FC AE 28 A5 06 D6 B3 0A 18 71
0180 | 63 A0 19 05 ED E1 79 B8 0D F0 1B BB C2 24 FB EB
0190 | B6 CF 0B E2 1C 40 57 A7 1F B5 7D 96 64 E3 45 88
01A0 | 93 ED 3F 88 C4 A9 80 FC 0C 0A 22 5E 52 F7 AF 47
01B0 | 91 E9 1A E8 62 27 9B 9A 99 8A 46 2A 75 96 30 C5
01C0 | F1 5D CD C4 E1 DA 94 73 32 6E 86 AD 62 44 18 05
01D0 | D1 4C 0E 8A F7 5A C3 6B 41 41 8A B0 C4 2B EE 3D
01E0 | A1 85 30 F8 91 50 9A A4 3B 9A E8 91 5E FA A4 5B
01F0 | C2 D2 7B 8A 69 FC 10 61 E1 AE 25 73 89 1B 3A DB
0200 | 21 E3 06 59 43 47 BB 09 40 7D 41 76 0D 8E 3D EA
0210 | 19 48 90 9A 4D 8C AE 0E A6 1B 4C 32 FE 4E 0D 11
0220 | F4 8D 8E D8 2C 1D 3B EA 6F D5 B4 2E A9 62 25 1C
0230 | E2 5A 77 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100BC15179B7B777707A4BC1DD6</code> <code>EFEB86AE7266F68F792CEB76DE1F052F</code> <code>B95BC4C3C8FC438496ED2AAE99DE6E31</code> <code>D49027448A5C7FF6695600E2F368B3E4</code> <code>437EAC9CFA9E21E7AEBCFCAE28A506D6</code> <code>B30A187163A01905EDE179B80DF01BBB</code> <code>C224FBEBB6CF0BE21C4057A71FB57D96</code> <code>64E3458893ED3F88C4A980FC0C0A225E</code> <code>52F7AF4791E91AE862279B9A998A462A</code> <code>759630C5F15DCDC4E1DA9473326E86AD</code> <code>62441805D14C0E8AF75AC36B41418AB0</code> <code>C42BEE3DA18530F891509AA43B9AE891</code> <code>5EFAA45BC2D27B8A69FC1061E1AE2573</code> <code>891B3ADB21E306594347BB09407D4176</code> <code>0D8E3DEA1948909A4D8CAE0EA61B4C32</code> <code>FE4E0D11F48D8ED82C1D3BEA6FD5B42E</code><br> <code>A962251C</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E25A7765</code> (1702320866 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = D03EB9F7EAE9C226883F2EDF3E567C95B46E967B896EE5B3B4809F553AE78643827F179D03F886CD10A5953B855CCE619227A18BEB308E85312A3CD092213A9B6FE79FE1F6C3E69A76AC0B42A27C14F71277ED22895E5B46ED82DD91D1A0823A65E1C2911EC15674448137A3AC724E47B4C75A8FC4700AC2A87A23DC5D018C9CB3C4E8AC6A4B88C2D4A534858F906287823A847CDE105C5071704675648D26539E457B0D2918B431736962A437EA25B1693DD8309A622FD2B4A69E8E8A7BA8AD258ABCCE4257A32161A0C81EFC90A41B504462D7272E25E611509C211A6E1B3E27E61691E050662F3EEA9BB93844FA41CBC9850BA93AFAD3AB71F6118BA27631</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 7FC2C58B9603B3D75A35AFA493AE2D14DCAA0B5E5D8BF64521ABC28CB1FA7E0850C01F3D50A91722E39655632710D583822751C84AF1629B0E47C6DC5394A0AA1D51392C22CBCF87BD5A5C333438CE292AE3B1CCF58339A436CE0EAD46CDD80C7AF9CA32F52DA53693741C79EE2A209150194C04B407291B81A897D8817CAD435594C2BA944A4D326C8CB91EF417182922D7B5F0DF85F8DD8FCCC84834E6BFFF6C4A36BD6C7C316A7A0729F22ED3FFD2EA3AEF2071BA8D7BBEC13DC2BE08F1A36F203DB03130E04CE226188CABE6AC90F9D1038DE6A7D99A4400E8669F8910D22849C6B00A2B10A1E6AA7B7B2BFF59279574EE2286E4EE45E64152AFE9990899</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 83 FE 4F A7 D6 AD 1B 8A C7 63 8A 36
0010 | AD AB 7A 9A 65 D6 6D 4E 1C C2 16 5A 23 E8 D1 8C
0020 | 4D 3B 8A B7 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 7F C2 C5 8B 96 03 B3 D7 5A 35 AF A4 93 AE 2D 14
0040 | DC AA 0B 5E 5D 8B F6 45 21 AB C2 8C B1 FA 7E 08
0050 | 50 C0 1F 3D 50 A9 17 22 E3 96 55 63 27 10 D5 83
0060 | 82 27 51 C8 4A F1 62 9B 0E 47 C6 DC 53 94 A0 AA
0070 | 1D 51 39 2C 22 CB CF 87 BD 5A 5C 33 34 38 CE 29
0080 | 2A E3 B1 CC F5 83 39 A4 36 CE 0E AD 46 CD D8 0C
0090 | 7A F9 CA 32 F5 2D A5 36 93 74 1C 79 EE 2A 20 91
00A0 | 50 19 4C 04 B4 07 29 1B 81 A8 97 D8 81 7C AD 43
00B0 | 55 94 C2 BA 94 4A 4D 32 6C 8C B9 1E F4 17 18 29
00C0 | 22 D7 B5 F0 DF 85 F8 DD 8F CC C8 48 34 E6 BF FF
00D0 | 6C 4A 36 BD 6C 7C 31 6A 7A 07 29 F2 2E D3 FF D2
00E0 | EA 3A EF 20 71 BA 8D 7B BE C1 3D C2 BE 08 F1 A3
00F0 | 6F 20 3D B0 31 30 E0 4C E2 26 18 8C AB E6 AC 90
0100 | F9 D1 03 8D E6 A7 D9 9A 44 00 E8 66 9F 89 10 D2
0110 | 28 49 C6 B0 0A 2B 10 A1 E6 AA 7B 7B 2B FF 59 27
0120 | 95 74 EE 22 86 E4 EE 45 E6 41 52 AF E9 99 08 99</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001007FC2C58B9603B3D75A35AFA4</code> <code>93AE2D14DCAA0B5E5D8BF64521ABC28C</code> <code>B1FA7E0850C01F3D50A91722E3965563</code> <code>2710D583822751C84AF1629B0E47C6DC</code> <code>5394A0AA1D51392C22CBCF87BD5A5C33</code> <code>3438CE292AE3B1CCF58339A436CE0EAD</code> <code>46CDD80C7AF9CA32F52DA53693741C79</code> <code>EE2A209150194C04B407291B81A897D8</code> <code>817CAD435594C2BA944A4D326C8CB91E</code> <code>F417182922D7B5F0DF85F8DD8FCCC848</code> <code>34E6BFFF6C4A36BD6C7C316A7A0729F2</code> <code>2ED3FFD2EA3AEF2071BA8D7BBEC13DC2</code> <code>BE08F1A36F203DB03130E04CE226188C</code> <code>ABE6AC90F9D1038DE6A7D99A4400E866</code> <code>9F8910D22849C6B00A2B10A1E6AA7B7B</code> <code>2BFF59279574EE2286E4EE45E64152AF</code><br> <code>E9990899</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436683FE4FA7D6AD1B8AC7638A36ADAB7A9A65D66D4E1CC2165A23E8D18C4D3B8AB70000000000000000FE0001007FC2C58B9603B3D75A35AFA493AE2D14DCAA0B5E5D8BF64521ABC28CB1FA7E0850C01F3D50A91722E39655632710D583822751C84AF1629B0E47C6DC5394A0AA1D51392C22CBCF87BD5A5C333438CE292AE3B1CCF58339A436CE0EAD46CDD80C7AF9CA32F52DA53693741C79EE2A209150194C04B407291B81A897D8817CAD435594C2BA944A4D326C8CB91EF417182922D7B5F0DF85F8DD8FCCC84834E6BFFF6C4A36BD6C7C316A7A0729F22ED3FFD2EA3AEF2071BA8D7BBEC13DC2BE08F1A36F203DB03130E04CE226188CABE6AC90F9D1038DE6A7D99A4400E8669F8910D22849C6B00A2B10A1E6AA7B7B2BFF59279574EE2286E4EE45E64152AFE9990899
padding = 0BA27B8C75CCDFCFB67AAB25
tmp_aes_key = 77956CAD707C98DD3C0873D0AF3F3388D352E8EF9E3A478719F1F8FD0A1946A3
tmp_aes_iv = 37D0003B77E9B64CC8CB4DF0E64D69CB4A3520877049D1AE1843149831447EEA</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 3E0AB10AD2B21A9DF4A4FE1D48F23232F6154DFAEDBFC85DD7D7DEF84DACCD7214E21C8E48BE56BEBBBCD8E892A5F0FA02C512708285F45D5A9B8CAE8AA28D800BC4468FA801B95F7A1E5695ABA9B5D5E87D72EA3A27B91CE1AB09DE038249C2E49A12B85C4772701C71468643C5F88DCB5CFFC95662C94F927DB65B3027CCEA8C98D46CE8E8944A520CC148AB5C1A705960BBA9855E040AA88C933103518883398C9AFDAF782DBB6394337A5ED0A2E6D68A04D02CFDC53DE5D93238908C8735C0BD1AC6406D8327D71D1E81E51EAD160CB29AFF53D381100096EE29900C194B3395DF8C89EF566BF2EFF4E9E2FE2E56640580437037E4309965D11C2291BB95CF9E8DDE4B5F172553FB61AD43EDB40BCC44CF76D4245F88E03C0C2699576301F6B1A8164F67EBA98ED2E87D9D15364747C8CA7EA6C6FC55873C5DD0C41E5014165253359DCFDB2BB955C3AD3CA97D4C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 AC 24 0D 00 E2 5A 77 65
0010 | 78 01 00 00 1F 5F 04 F5 83 FE 4F A7 D6 AD 1B 8A
0020 | C7 63 8A 36 AD AB 7A 9A 65 D6 6D 4E 1C C2 16 5A
0030 | 23 E8 D1 8C 4D 3B 8A B7 FE 50 01 00 3E 0A B1 0A
0040 | D2 B2 1A 9D F4 A4 FE 1D 48 F2 32 32 F6 15 4D FA
0050 | ED BF C8 5D D7 D7 DE F8 4D AC CD 72 14 E2 1C 8E
0060 | 48 BE 56 BE BB BC D8 E8 92 A5 F0 FA 02 C5 12 70
0070 | 82 85 F4 5D 5A 9B 8C AE 8A A2 8D 80 0B C4 46 8F
0080 | A8 01 B9 5F 7A 1E 56 95 AB A9 B5 D5 E8 7D 72 EA
0090 | 3A 27 B9 1C E1 AB 09 DE 03 82 49 C2 E4 9A 12 B8
00A0 | 5C 47 72 70 1C 71 46 86 43 C5 F8 8D CB 5C FF C9
00B0 | 56 62 C9 4F 92 7D B6 5B 30 27 CC EA 8C 98 D4 6C
00C0 | E8 E8 94 4A 52 0C C1 48 AB 5C 1A 70 59 60 BB A9
00D0 | 85 5E 04 0A A8 8C 93 31 03 51 88 83 39 8C 9A FD
00E0 | AF 78 2D BB 63 94 33 7A 5E D0 A2 E6 D6 8A 04 D0
00F0 | 2C FD C5 3D E5 D9 32 38 90 8C 87 35 C0 BD 1A C6
0100 | 40 6D 83 27 D7 1D 1E 81 E5 1E AD 16 0C B2 9A FF
0110 | 53 D3 81 10 00 96 EE 29 90 0C 19 4B 33 95 DF 8C
0120 | 89 EF 56 6B F2 EF F4 E9 E2 FE 2E 56 64 05 80 43
0130 | 70 37 E4 30 99 65 D1 1C 22 91 BB 95 CF 9E 8D DE
0140 | 4B 5F 17 25 53 FB 61 AD 43 ED B4 0B CC 44 CF 76
0150 | D4 24 5F 88 E0 3C 0C 26 99 57 63 01 F6 B1 A8 16
0160 | 4F 67 EB A9 8E D2 E8 7D 9D 15 36 47 47 C8 CA 7E
0170 | A6 C6 FC 55 87 3C 5D D0 C4 1E 50 14 16 52 53 35
0180 | 9D CF DB 2B B9 55 C3 AD 3C A9 7D 4C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>AC240D00E25A7765</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001003E0AB10AD2B21A9DF4A4FE1D</code> <code>48F23232F6154DFAEDBFC85DD7D7DEF8</code> <code>4DACCD7214E21C8E48BE56BEBBBCD8E8</code> <code>92A5F0FA02C512708285F45D5A9B8CAE</code> <code>8AA28D800BC4468FA801B95F7A1E5695</code> <code>ABA9B5D5E87D72EA3A27B91CE1AB09DE</code> <code>038249C2E49A12B85C4772701C714686</code> <code>43C5F88DCB5CFFC95662C94F927DB65B</code> <code>3027CCEA8C98D46CE8E8944A520CC148</code> <code>AB5C1A705960BBA9855E040AA88C9331</code> <code>03518883398C9AFDAF782DBB6394337A</code> <code>5ED0A2E6D68A04D02CFDC53DE5D93238</code> <code>908C8735C0BD1AC6406D8327D71D1E81</code> <code>E51EAD160CB29AFF53D381100096EE29</code> <code>900C194B3395DF8C89EF566BF2EFF4E9</code> <code>E2FE2E56640580437037E4309965D11C</code> <code>2291BB95CF9E8DDE4B5F172553FB61AD</code> <code>43EDB40BCC44CF76D4245F88E03C0C26</code> <code>99576301F6B1A8164F67EBA98ED2E87D</code> <code>9D15364747C8CA7EA6C6FC55873C5DD0</code> <code>C41E5014165253359DCFDB2BB955C3AD</code><br> <code>3CA97D4C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 5A4BCAAF3EAEFA5842187B2DA426AF63241C8E476F50D8AA9AF636F9E36324830AC9E2ACEA926D9FB31B74A0AB107A2A2FF2B555F389A0084C44DE425A45D8F335513DD84E0442E7264A1CDB67FE324D325892FA3869087B2D452CE4386A8C11651E5356FA4E68F06B9D2DE5D49E561EBF9778AE4AA591B00EA4EB305A6FB3F2A8CCC3BC84F0E72F5342DA05D4614B669DD88145D61B6B7515719F3120E06C3BFCE06293428C762166CC0AF8E474BF4E5DBCDF1FEB0CA75FAF63571F131A30A15B81B70B71D5365DA5A711A4F890E4A0305D5D0152E916D66D6E9FC0D207B526B0939D2225D6CF851EA402C67D4A1F90D4D975A81C0D7D0E3AF4D3218C96D60E</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 24 A2 00 E3 5A 77 65
0010 | 98 00 00 00 34 F7 CB 3B 83 FE 4F A7 D6 AD 1B 8A
0020 | C7 63 8A 36 AD AB 7A 9A 65 D6 6D 4E 1C C2 16 5A
0030 | 23 E8 D1 8C 4D 3B 8A B7 ED C5 AF E1 45 3C E4 5A
0040 | 47 37 F5 F4 C7 01 2B A9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0124A200E35A7765</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>98000000</code> (152 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>83FE4FA7D6AD1B8AC7638A36ADAB7A9A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>65D66D4E1CC2165A23E8D18C4D3B8AB7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>EDC5AFE1453CE45A4737F5F4C7012BA9</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

