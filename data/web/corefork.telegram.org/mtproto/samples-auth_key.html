<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 74 5F 02 00 46 E5 70 65
0010 | 14 00 00 00 F1 8E 7E BE 0A 95 A3 0D D1 75 4A BF
0020 | 28 3B CE 96 F3 B3 EB 42</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>745F020046E57065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 7D A2 46 E5 70 65
0010 | 54 00 00 00 63 24 16 05 0A 95 A3 0D D1 75 4A BF
0020 | 28 3B CE 96 F3 B3 EB 42 14 B7 7C B9 1E FB E6 D3
0030 | F5 CF 06 3E 93 8C 11 B7 08 1C 18 DE 9B 76 56 E9
0040 | AD 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01947DA246E57065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081C18DE9B7656E9AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2024612791789742509</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2024612791789742509</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2024612791789742509 = 1071870773 * 1888859033</code></p>
<pre><code>p = 1071870773
q = 1888859033</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1C 18 DE 9B 76 56 E9 AD 00 00 00
0010 | 04 3F E3 73 35 00 00 00 04 70 95 B3 99 00 00 00
0020 | 0A 95 A3 0D D1 75 4A BF 28 3B CE 96 F3 B3 EB 42
0030 | 14 B7 7C B9 1E FB E6 D3 F5 CF 06 3E 93 8C 11 B7
0040 | B4 35 80 BF E4 FC 5A 8D 68 30 18 B4 12 26 6D 99
0050 | 62 6F 04 7B 3C 57 0B C2 CE E5 69 91 45 E8 78 0B
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081C18DE9B7656E9AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2024612791789742509</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043FE37335000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1071870773</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047095B399000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1888859033</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>B43580BFE4FC5A8D683018B412266D99</code> <code>626F047B3C570BC2CEE5699145E8780B</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081C18DE9B7656E9AD000000043FE37335000000047095B3990000000A95A30DD1754ABF283BCE96F3B3EB4214B77CB91EFBE6D3F5CF063E938C11B7B43580BFE4FC5A8D683018B412266D99626F047B3C570BC2CEE5699145E8780B02000000
random_padding_bytes = DEF43E9633F3C629CCDB795626418EC6E43810811311F9D038ACCE99AF060EDDF11A098AD4758A294E5366B5E0589387F4696C92E1C4A57F5F30877C7C3C1444DBE0E4F3AA1A0094AA605D830A6A225ED7EB9702729C54A29D11F333</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 211A7F48B2502585FDD2FF0908E06F547EC7A78373635DD8EBEF7D4791133E7BCD5380BF1324F78544718922D6981E98B494CA72DA974B0AFFEAF3703FF6B52B16747175F69FF81DC83AA37F2730915FF2AD834A575768080B921DAE23E0B5A7F07E7B1D605EB991473B702BBCF184A8F9D757F85C215195DCF089422572FEF35B9375F449EDDE40E487C6974AF39699ACB7569C311871003E921683360FF316E5792ABEC630D64FA5D684831801A329EA1A192ED520776DC55D918E454B12CAE4D9D67300B5A1D743DA9DF32AD9E61B051BB11CAB7B5AE8A680B757AD64F5529A1BFC85B0EC08872E4BD3A7FCF5239610423EDBEF1BFFFA53FC1C105ED89479</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 A8 0B 00 46 E5 70 65
0010 | 40 01 00 00 BE E4 12 D7 0A 95 A3 0D D1 75 4A BF
0020 | 28 3B CE 96 F3 B3 EB 42 14 B7 7C B9 1E FB E6 D3
0030 | F5 CF 06 3E 93 8C 11 B7 04 3F E3 73 35 00 00 00
0040 | 04 70 95 B3 99 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 21 1A 7F 48 B2 50 25 85 FD D2 FF 09
0060 | 08 E0 6F 54 7E C7 A7 83 73 63 5D D8 EB EF 7D 47
0070 | 91 13 3E 7B CD 53 80 BF 13 24 F7 85 44 71 89 22
0080 | D6 98 1E 98 B4 94 CA 72 DA 97 4B 0A FF EA F3 70
0090 | 3F F6 B5 2B 16 74 71 75 F6 9F F8 1D C8 3A A3 7F
00A0 | 27 30 91 5F F2 AD 83 4A 57 57 68 08 0B 92 1D AE
00B0 | 23 E0 B5 A7 F0 7E 7B 1D 60 5E B9 91 47 3B 70 2B
00C0 | BC F1 84 A8 F9 D7 57 F8 5C 21 51 95 DC F0 89 42
00D0 | 25 72 FE F3 5B 93 75 F4 49 ED DE 40 E4 87 C6 97
00E0 | 4A F3 96 99 AC B7 56 9C 31 18 71 00 3E 92 16 83
00F0 | 36 0F F3 16 E5 79 2A BE C6 30 D6 4F A5 D6 84 83
0100 | 18 01 A3 29 EA 1A 19 2E D5 20 77 6D C5 5D 91 8E
0110 | 45 4B 12 CA E4 D9 D6 73 00 B5 A1 D7 43 DA 9D F3
0120 | 2A D9 E6 1B 05 1B B1 1C AB 7B 5A E8 A6 80 B7 57
0130 | AD 64 F5 52 9A 1B FC 85 B0 EC 08 87 2E 4B D3 A7
0140 | FC F5 23 96 10 42 3E DB EF 1B FF FA 53 FC 1C 10
0150 | 5E D8 94 79</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>44A80B0046E57065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043FE37335000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1071870773</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047095B399000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1888859033</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100211A7F48B2502585FDD2FF09</code> <code>08E06F547EC7A78373635DD8EBEF7D47</code> <code>91133E7BCD5380BF1324F78544718922</code> <code>D6981E98B494CA72DA974B0AFFEAF370</code> <code>3FF6B52B16747175F69FF81DC83AA37F</code> <code>2730915FF2AD834A575768080B921DAE</code> <code>23E0B5A7F07E7B1D605EB991473B702B</code> <code>BCF184A8F9D757F85C215195DCF08942</code> <code>2572FEF35B9375F449EDDE40E487C697</code> <code>4AF39699ACB7569C311871003E921683</code> <code>360FF316E5792ABEC630D64FA5D68483</code> <code>1801A329EA1A192ED520776DC55D918E</code> <code>454B12CAE4D9D67300B5A1D743DA9DF3</code> <code>2AD9E61B051BB11CAB7B5AE8A680B757</code> <code>AD64F5529A1BFC85B0EC08872E4BD3A7</code> <code>FCF5239610423EDBEF1BFFFA53FC1C10</code><br> <code>5ED89479</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 08 1B 63 47 E5 70 65
0010 | C0 02 00 00 5C 07 E8 D0 0A 95 A3 0D D1 75 4A BF
0020 | 28 3B CE 96 F3 B3 EB 42 14 B7 7C B9 1E FB E6 D3
0030 | F5 CF 06 3E 93 8C 11 B7 FE 50 02 00 7C E4 65 BC
0040 | 91 5E B0 CD 93 47 2D 2C 20 35 63 D7 64 25 D5 AC
0050 | B9 FB 41 50 17 47 DD 7F B0 CC BB 12 97 AE 28 12
0060 | D1 5D 3A 67 E0 AF DD D7 D7 78 35 2D AD 8C 74 82
0070 | 3A 39 A5 66 94 A5 31 1A 04 1B C9 6F 52 49 B9 BC
0080 | 63 31 F0 FF 90 02 13 C9 BE 6C 88 D2 B1 61 94 CA
0090 | CD A2 A1 A7 30 EE ED 93 77 42 D4 7A CB 3F 6F 15
00A0 | 74 75 ED 09 3A 1D 50 98 F7 9E ED C5 14 61 AB EC
00B0 | BA 88 D1 19 A1 E7 BA F7 C2 59 3E DE CE 66 69 38
00C0 | 8F 80 D3 F5 C2 99 C3 90 D3 AD E1 3F E4 22 23 1B
00D0 | 71 6D 3E 1C 69 91 5B 70 17 CD 6E 14 A8 5B 86 58
00E0 | C4 34 4A 23 8E 5F C8 73 EE 64 CE 68 D6 FB AF 07
00F0 | C8 2D E0 EC E4 D8 9C 9E 26 68 B6 FA B1 BA D5 A2
0100 | 63 DD 6D 17 14 94 6B C8 42 7A 8F 82 A1 D4 61 D7
0110 | 9E 78 BE 3A 22 0D BF 54 84 3E B8 E2 27 80 E5 34
0120 | C7 67 87 18 E9 BA 00 19 A9 D7 06 B5 E9 04 A8 C6
0130 | 5C 57 25 67 D4 7F CB 94 9F 93 B4 FA E7 AB 5D 6E
0140 | 6B 91 DE E1 7C BB 40 20 40 92 23 C8 67 FD 77 B3
0150 | 36 59 96 49 1B 26 6A 9C FC 9D BA 86 5D 8E 20 60
0160 | 37 0F AF 5C 66 DD 7F F9 8C BE E4 EB 76 CB C6 63
0170 | 80 9B 41 36 82 BE FC 21 03 22 05 E0 82 23 50 AA
0180 | 06 69 0E 89 C0 66 1F 3F B5 88 A6 18 61 48 48 12
0190 | A9 96 B8 24 78 71 DF 17 24 EE 98 DA D1 3F 3F AC
01A0 | D6 FB 1A 28 56 01 B0 92 61 8A BB 19 0F 2B 8D 8A
01B0 | 40 52 68 5B 6F 4A 3C DE F0 01 0F BE 49 97 52 6D
01C0 | 50 B9 14 5F 05 0A 0C 02 54 28 BA 27 4B 85 55 8E
01D0 | 10 CE 85 6C 61 89 04 2E A8 D1 E8 22 64 FB F1 06
01E0 | C2 5D F5 94 08 CE 45 B9 AE F2 A9 E4 FA 23 84 FE
01F0 | 48 85 EB F7 4E 44 D1 7B 2E 3B 58 B4 6B F6 AB 02
0200 | E8 9F 5A 56 F8 FB 54 89 C6 11 AA 12 42 49 7B 4D
0210 | 13 AD DD 3D 30 C3 8F FF A1 AA 62 FC 03 50 28 8D
0220 | 29 93 14 A3 48 BB 53 17 AD F6 59 1D A5 02 5F CC
0230 | A3 5C FA A0 D4 BF B4 0A 9B 31 0A BB 10 E8 0B 97
0240 | 4D AC 3C 3A 62 87 C2 47 1B D9 7D 68 D2 B7 46 9D
0250 | 02 85 E8 1E 47 3B 46 0B C3 53 8E 2A E5 25 51 42
0260 | EA 8D 13 A7 64 C7 40 F9 3C 5A 5F A6 4E 9C 0A F0
0270 | A4 2D 7C 27 DF FC 86 A2 92 57 B8 6E E4 D8 CC 77
0280 | 90 E0 E8 03 F3 48 49 6F A1 AA BB B0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01081B6347E57065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C0020000</code> (704 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002007CE465BC915EB0CD93472D2C</code> <code>203563D76425D5ACB9FB41501747DD7F</code> <code>B0CCBB1297AE2812D15D3A67E0AFDDD7</code> <code>D778352DAD8C74823A39A56694A5311A</code> <code>041BC96F5249B9BC6331F0FF900213C9</code> <code>BE6C88D2B16194CACDA2A1A730EEED93</code> <code>7742D47ACB3F6F157475ED093A1D5098</code> <code>F79EEDC51461ABECBA88D119A1E7BAF7</code> <code>C2593EDECE6669388F80D3F5C299C390</code> <code>D3ADE13FE422231B716D3E1C69915B70</code> <code>17CD6E14A85B8658C4344A238E5FC873</code> <code>EE64CE68D6FBAF07C82DE0ECE4D89C9E</code> <code>2668B6FAB1BAD5A263DD6D1714946BC8</code> <code>427A8F82A1D461D79E78BE3A220DBF54</code> <code>843EB8E22780E534C7678718E9BA0019</code> <code>A9D706B5E904A8C65C572567D47FCB94</code> <code>9F93B4FAE7AB5D6E6B91DEE17CBB4020</code> <code>409223C867FD77B3365996491B266A9C</code> <code>FC9DBA865D8E2060370FAF5C66DD7FF9</code> <code>8CBEE4EB76CBC663809B413682BEFC21</code> <code>032205E0822350AA06690E89C0661F3F</code> <code>B588A61861484812A996B8247871DF17</code> <code>24EE98DAD13F3FACD6FB1A285601B092</code> <code>618ABB190F2B8D8A4052685B6F4A3CDE</code> <code>F0010FBE4997526D50B9145F050A0C02</code> <code>5428BA274B85558E10CE856C6189042E</code> <code>A8D1E82264FBF106C25DF59408CE45B9</code> <code>AEF2A9E4FA2384FE4885EBF74E44D17B</code> <code>2E3B58B46BF6AB02E89F5A56F8FB5489</code> <code>C611AA1242497B4D13ADDD3D30C38FFF</code> <code>A1AA62FC0350288D299314A348BB5317</code> <code>ADF6591DA5025FCCA35CFAA0D4BFB40A</code> <code>9B310ABB10E80B974DAC3C3A6287C247</code> <code>1BD97D68D2B7469D0285E81E473B460B</code> <code>C3538E2AE5255142EA8D13A764C740F9</code> <code>3C5A5FA64E9C0AF0A42D7C27DFFC86A2</code> <code>9257B86EE4D8CC7790E0E803F348496F</code><br> <code>A1AABBB0</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 7CE465BC915EB0CD93472D2C203563D76425D5ACB9FB41501747DD7FB0CCBB1297AE2812D15D3A67E0AFDDD7D778352DAD8C74823A39A56694A5311A041BC96F5249B9BC6331F0FF900213C9BE6C88D2B16194CACDA2A1A730EEED937742D47ACB3F6F157475ED093A1D5098F79EEDC51461ABECBA88D119A1E7BAF7C2593EDECE6669388F80D3F5C299C390D3ADE13FE422231B716D3E1C69915B7017CD6E14A85B8658C4344A238E5FC873EE64CE68D6FBAF07C82DE0ECE4D89C9E2668B6FAB1BAD5A263DD6D1714946BC8427A8F82A1D461D79E78BE3A220DBF54843EB8E22780E534C7678718E9BA0019A9D706B5E904A8C65C572567D47FCB949F93B4FAE7AB5D6E6B91DEE17CBB4020409223C867FD77B3365996491B266A9CFC9DBA865D8E2060370FAF5C66DD7FF98CBEE4EB76CBC663809B413682BEFC21032205E0822350AA06690E89C0661F3FB588A61861484812A996B8247871DF1724EE98DAD13F3FACD6FB1A285601B092618ABB190F2B8D8A4052685B6F4A3CDEF0010FBE4997526D50B9145F050A0C025428BA274B85558E10CE856C6189042EA8D1E82264FBF106C25DF59408CE45B9AEF2A9E4FA2384FE4885EBF74E44D17B2E3B58B46BF6AB02E89F5A56F8FB5489C611AA1242497B4D13ADDD3D30C38FFFA1AA62FC0350288D299314A348BB5317ADF6591DA5025FCCA35CFAA0D4BFB40A9B310ABB10E80B974DAC3C3A6287C2471BD97D68D2B7469D0285E81E473B460BC3538E2AE5255142EA8D13A764C740F93C5A5FA64E9C0AF0A42D7C27DFFC86A29257B86EE4D8CC7790E0E803F348496FA1AABBB0
tmp_aes_key = 2328CFB62740758C72875FFA9F28954B0F484F3F8F08BA1D9777B83D72EAE49F
tmp_aes_iv = B245F332C793EA0B889E6B792A56842E15EF79E8ACCA8AA4589FC64DB43580BF</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 046C206B00FE2C32D4702997F69F6D333230EBD4BA0D89B50A95A30DD1754ABF283BCE96F3B3EB4214B77CB91EFBE6D3F5CF063E938C11B703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100568755DD212BB5081F78AB938D3E0A63F12D552D0F83FD9794E027AC2590D514CD86BEF1B089E2F78311BB7DA0573C13DF3CE3FE0794F5D6F414D53C8F45F4549251DF16123793B80F11322C5DCE6007E4C62FA7713776BEEEC5DC9E48307495146854F60B3BB7052ABC300C46E57B212E59D6F6C2D2FF704D98888D71CAF958813BED9D916E439AD02A9FA70678454E0C92885E3193FCA553181EE515721688AFAFF9E7527B467B45A0A45A6F3BB0A8616646B6D5B7C71406C3D7AE232E7A5F78B0CDF39A9EC8E3651733A351C6EECA792C58A02C6AC2077714CDB322A50CAD2F28FF307F658DABF2EDA874E65D5A7361F6D779D52F87B08DA77D0D82DAFAE647E5706584CA5D5CFB33E47E
answer = BA0D89B50A95A30DD1754ABF283BCE96F3B3EB4214B77CB91EFBE6D3F5CF063E938C11B703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100568755DD212BB5081F78AB938D3E0A63F12D552D0F83FD9794E027AC2590D514CD86BEF1B089E2F78311BB7DA0573C13DF3CE3FE0794F5D6F414D53C8F45F4549251DF16123793B80F11322C5DCE6007E4C62FA7713776BEEEC5DC9E48307495146854F60B3BB7052ABC300C46E57B212E59D6F6C2D2FF704D98888D71CAF958813BED9D916E439AD02A9FA70678454E0C92885E3193FCA553181EE515721688AFAFF9E7527B467B45A0A45A6F3BB0A8616646B6D5B7C71406C3D7AE232E7A5F78B0CDF39A9EC8E3651733A351C6EECA792C58A02C6AC2077714CDB322A50CAD2F28FF307F658DABF2EDA874E65D5A7361F6D779D52F87B08DA77D0D82DAFAE647E5706584CA5D5CFB33E47E</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 0A 95 A3 0D D1 75 4A BF 28 3B CE 96
0010 | F3 B3 EB 42 14 B7 7C B9 1E FB E6 D3 F5 CF 06 3E
0020 | 93 8C 11 B7 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 56 87 55 DD 21 2B B5 08 1F 78 AB 93 8D 3E 0A 63
0140 | F1 2D 55 2D 0F 83 FD 97 94 E0 27 AC 25 90 D5 14
0150 | CD 86 BE F1 B0 89 E2 F7 83 11 BB 7D A0 57 3C 13
0160 | DF 3C E3 FE 07 94 F5 D6 F4 14 D5 3C 8F 45 F4 54
0170 | 92 51 DF 16 12 37 93 B8 0F 11 32 2C 5D CE 60 07
0180 | E4 C6 2F A7 71 37 76 BE EE C5 DC 9E 48 30 74 95
0190 | 14 68 54 F6 0B 3B B7 05 2A BC 30 0C 46 E5 7B 21
01A0 | 2E 59 D6 F6 C2 D2 FF 70 4D 98 88 8D 71 CA F9 58
01B0 | 81 3B ED 9D 91 6E 43 9A D0 2A 9F A7 06 78 45 4E
01C0 | 0C 92 88 5E 31 93 FC A5 53 18 1E E5 15 72 16 88
01D0 | AF AF F9 E7 52 7B 46 7B 45 A0 A4 5A 6F 3B B0 A8
01E0 | 61 66 46 B6 D5 B7 C7 14 06 C3 D7 AE 23 2E 7A 5F
01F0 | 78 B0 CD F3 9A 9E C8 E3 65 17 33 A3 51 C6 EE CA
0200 | 79 2C 58 A0 2C 6A C2 07 77 14 CD B3 22 A5 0C AD
0210 | 2F 28 FF 30 7F 65 8D AB F2 ED A8 74 E6 5D 5A 73
0220 | 61 F6 D7 79 D5 2F 87 B0 8D A7 7D 0D 82 DA FA E6
0230 | 47 E5 70 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100568755DD212BB5081F78AB93</code> <code>8D3E0A63F12D552D0F83FD9794E027AC</code> <code>2590D514CD86BEF1B089E2F78311BB7D</code> <code>A0573C13DF3CE3FE0794F5D6F414D53C</code> <code>8F45F4549251DF16123793B80F11322C</code> <code>5DCE6007E4C62FA7713776BEEEC5DC9E</code> <code>48307495146854F60B3BB7052ABC300C</code> <code>46E57B212E59D6F6C2D2FF704D98888D</code> <code>71CAF958813BED9D916E439AD02A9FA7</code> <code>0678454E0C92885E3193FCA553181EE5</code> <code>15721688AFAFF9E7527B467B45A0A45A</code> <code>6F3BB0A8616646B6D5B7C71406C3D7AE</code> <code>232E7A5F78B0CDF39A9EC8E3651733A3</code> <code>51C6EECA792C58A02C6AC2077714CDB3</code> <code>22A50CAD2F28FF307F658DABF2EDA874</code> <code>E65D5A7361F6D779D52F87B08DA77D0D</code><br> <code>82DAFAE6</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>47E57065</code> (1701897543 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 9033A9A81291FB69C8DE4F177AFF575EE3A18859009E9A9A5FA3DE161B05494A3578967746425F8A4499CF2088104E2E1DABDED50EB4E84F1CAB7D6F2412AC86F9CE0EC1F41DA233CFA6104F4D1B0992FF9BDDC12E1164CC59DAA74850792A1EFD145DC7975FC9D7DD2CF58613EEB482553A896C6E2B44A9A0D74C356BD5441C3E655FDCE84C5EADF7CC7CE418B67AABFE7513960742D1D43EE4CB57EDDE8D0A04DA31D4D715582194A055EC1F7869291C2C8AE5F335918B611EEB905C03084C47B355A7C0228533DABBC6C98FEB97B28A9200A3649F0BFB049632BC8278F0EEAAF39DA2DACA23C23B963F9ED61076A20B0E94B545E058CECF374053ED0CC1B4</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B58BB862D3E785E98B302A637B5C17DD2F96979B87B93A6A28EC84162007ED36643D42EBF3ECD230CEF3AC57C1E56DB0102392F189B29A9D1EFF5EEE439C6251256A6B174D9182C03490DA9E0EC92AA6524909083CAA8BDBE7F3B34D13E5F6E9C1A4839D68D0A3B480FBB0279AF1A6B1E6BE422BC356A4D01DFBBE25A868295CADF41E1DACFCCC15FACC872AA0A14B2430509A6D33ADD1150BC839AD21854CF348F29D33BF6D86ED5BDB01ED51144150CE17983668E451DC2A0CA1040932095751D609B10F3F634626B5EA0FA6FE1F6E02372B4697A87910A4834A460ECB7F661D25CC139C5913A8E54618C7FC410D41525E5DCAA534D920C74CBD8D8D8663D5</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 0A 95 A3 0D D1 75 4A BF 28 3B CE 96
0010 | F3 B3 EB 42 14 B7 7C B9 1E FB E6 D3 F5 CF 06 3E
0020 | 93 8C 11 B7 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B5 8B B8 62 D3 E7 85 E9 8B 30 2A 63 7B 5C 17 DD
0040 | 2F 96 97 9B 87 B9 3A 6A 28 EC 84 16 20 07 ED 36
0050 | 64 3D 42 EB F3 EC D2 30 CE F3 AC 57 C1 E5 6D B0
0060 | 10 23 92 F1 89 B2 9A 9D 1E FF 5E EE 43 9C 62 51
0070 | 25 6A 6B 17 4D 91 82 C0 34 90 DA 9E 0E C9 2A A6
0080 | 52 49 09 08 3C AA 8B DB E7 F3 B3 4D 13 E5 F6 E9
0090 | C1 A4 83 9D 68 D0 A3 B4 80 FB B0 27 9A F1 A6 B1
00A0 | E6 BE 42 2B C3 56 A4 D0 1D FB BE 25 A8 68 29 5C
00B0 | AD F4 1E 1D AC FC CC 15 FA CC 87 2A A0 A1 4B 24
00C0 | 30 50 9A 6D 33 AD D1 15 0B C8 39 AD 21 85 4C F3
00D0 | 48 F2 9D 33 BF 6D 86 ED 5B DB 01 ED 51 14 41 50
00E0 | CE 17 98 36 68 E4 51 DC 2A 0C A1 04 09 32 09 57
00F0 | 51 D6 09 B1 0F 3F 63 46 26 B5 EA 0F A6 FE 1F 6E
0100 | 02 37 2B 46 97 A8 79 10 A4 83 4A 46 0E CB 7F 66
0110 | 1D 25 CC 13 9C 59 13 A8 E5 46 18 C7 FC 41 0D 41
0120 | 52 5E 5D CA A5 34 D9 20 C7 4C BD 8D 8D 86 63 D5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B58BB862D3E785E98B302A63</code> <code>7B5C17DD2F96979B87B93A6A28EC8416</code> <code>2007ED36643D42EBF3ECD230CEF3AC57</code> <code>C1E56DB0102392F189B29A9D1EFF5EEE</code> <code>439C6251256A6B174D9182C03490DA9E</code> <code>0EC92AA6524909083CAA8BDBE7F3B34D</code> <code>13E5F6E9C1A4839D68D0A3B480FBB027</code> <code>9AF1A6B1E6BE422BC356A4D01DFBBE25</code> <code>A868295CADF41E1DACFCCC15FACC872A</code> <code>A0A14B2430509A6D33ADD1150BC839AD</code> <code>21854CF348F29D33BF6D86ED5BDB01ED</code> <code>51144150CE17983668E451DC2A0CA104</code> <code>0932095751D609B10F3F634626B5EA0F</code> <code>A6FE1F6E02372B4697A87910A4834A46</code> <code>0ECB7F661D25CC139C5913A8E54618C7</code> <code>FC410D41525E5DCAA534D920C74CBD8D</code><br> <code>8D8663D5</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643660A95A30DD1754ABF283BCE96F3B3EB4214B77CB91EFBE6D3F5CF063E938C11B70000000000000000FE000100B58BB862D3E785E98B302A637B5C17DD2F96979B87B93A6A28EC84162007ED36643D42EBF3ECD230CEF3AC57C1E56DB0102392F189B29A9D1EFF5EEE439C6251256A6B174D9182C03490DA9E0EC92AA6524909083CAA8BDBE7F3B34D13E5F6E9C1A4839D68D0A3B480FBB0279AF1A6B1E6BE422BC356A4D01DFBBE25A868295CADF41E1DACFCCC15FACC872AA0A14B2430509A6D33ADD1150BC839AD21854CF348F29D33BF6D86ED5BDB01ED51144150CE17983668E451DC2A0CA1040932095751D609B10F3F634626B5EA0FA6FE1F6E02372B4697A87910A4834A460ECB7F661D25CC139C5913A8E54618C7FC410D41525E5DCAA534D920C74CBD8D8D8663D5
padding = C9204C19F21688A1A9847BE8
tmp_aes_key = 2328CFB62740758C72875FFA9F28954B0F484F3F8F08BA1D9777B83D72EAE49F
tmp_aes_iv = B245F332C793EA0B889E6B792A56842E15EF79E8ACCA8AA4589FC64DB43580BF</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = D874C3A771BE5DC70A8D423F8A392667BBAA03B18144023E3CDA8C58435DFFAA68EB22C0506A55EA8692CB1F651F03FE633A1897E072952B54683FF338BCDBBBCFB362B40B72CA7B9FA52D7A31960ECADE9437895500024F1DCB1A7C7350B1A320ED6E6B57345A22AE0BC3ED46664C9D6684D0DA4BFFB168C98AA0936C59354B9AC8B93578CB707FAFB64F75A80E0D8DC3B4E0B25A9837EDC4689A35C8EF8FDD78BEAEE01DA389F91DE89CA4827F0C794098065A0881DFF2FE2A914663A67D37FCDFDE1A783E468D86577010923CA99085495685FEC1D88A7F73C34F54DFB1A89931C46A166BFF7CF13DAA7D17E3688029624DA4EEA9113264590FEED35C505A345BD47451237A666CEE49E4A2FA740A1F54E463B63D5E5F2C4899AB3994A5493E36BF21ED968D7AD1B45CC22CA533B947E410BE0419CCCF08639FE72A207A88495BB6EAB0B39AF09B878D1B7EE94E0C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 C4 00 00 47 E5 70 65
0010 | 78 01 00 00 1F 5F 04 F5 0A 95 A3 0D D1 75 4A BF
0020 | 28 3B CE 96 F3 B3 EB 42 14 B7 7C B9 1E FB E6 D3
0030 | F5 CF 06 3E 93 8C 11 B7 FE 50 01 00 D8 74 C3 A7
0040 | 71 BE 5D C7 0A 8D 42 3F 8A 39 26 67 BB AA 03 B1
0050 | 81 44 02 3E 3C DA 8C 58 43 5D FF AA 68 EB 22 C0
0060 | 50 6A 55 EA 86 92 CB 1F 65 1F 03 FE 63 3A 18 97
0070 | E0 72 95 2B 54 68 3F F3 38 BC DB BB CF B3 62 B4
0080 | 0B 72 CA 7B 9F A5 2D 7A 31 96 0E CA DE 94 37 89
0090 | 55 00 02 4F 1D CB 1A 7C 73 50 B1 A3 20 ED 6E 6B
00A0 | 57 34 5A 22 AE 0B C3 ED 46 66 4C 9D 66 84 D0 DA
00B0 | 4B FF B1 68 C9 8A A0 93 6C 59 35 4B 9A C8 B9 35
00C0 | 78 CB 70 7F AF B6 4F 75 A8 0E 0D 8D C3 B4 E0 B2
00D0 | 5A 98 37 ED C4 68 9A 35 C8 EF 8F DD 78 BE AE E0
00E0 | 1D A3 89 F9 1D E8 9C A4 82 7F 0C 79 40 98 06 5A
00F0 | 08 81 DF F2 FE 2A 91 46 63 A6 7D 37 FC DF DE 1A
0100 | 78 3E 46 8D 86 57 70 10 92 3C A9 90 85 49 56 85
0110 | FE C1 D8 8A 7F 73 C3 4F 54 DF B1 A8 99 31 C4 6A
0120 | 16 6B FF 7C F1 3D AA 7D 17 E3 68 80 29 62 4D A4
0130 | EE A9 11 32 64 59 0F EE D3 5C 50 5A 34 5B D4 74
0140 | 51 23 7A 66 6C EE 49 E4 A2 FA 74 0A 1F 54 E4 63
0150 | B6 3D 5E 5F 2C 48 99 AB 39 94 A5 49 3E 36 BF 21
0160 | ED 96 8D 7A D1 B4 5C C2 2C A5 33 B9 47 E4 10 BE
0170 | 04 19 CC CF 08 63 9F E7 2A 20 7A 88 49 5B B6 EA
0180 | B0 B3 9A F0 9B 87 8D 1B 7E E9 4E 0C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0C4000047E57065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100D874C3A771BE5DC70A8D423F</code> <code>8A392667BBAA03B18144023E3CDA8C58</code> <code>435DFFAA68EB22C0506A55EA8692CB1F</code> <code>651F03FE633A1897E072952B54683FF3</code> <code>38BCDBBBCFB362B40B72CA7B9FA52D7A</code> <code>31960ECADE9437895500024F1DCB1A7C</code> <code>7350B1A320ED6E6B57345A22AE0BC3ED</code> <code>46664C9D6684D0DA4BFFB168C98AA093</code> <code>6C59354B9AC8B93578CB707FAFB64F75</code> <code>A80E0D8DC3B4E0B25A9837EDC4689A35</code> <code>C8EF8FDD78BEAEE01DA389F91DE89CA4</code> <code>827F0C794098065A0881DFF2FE2A9146</code> <code>63A67D37FCDFDE1A783E468D86577010</code> <code>923CA99085495685FEC1D88A7F73C34F</code> <code>54DFB1A89931C46A166BFF7CF13DAA7D</code> <code>17E3688029624DA4EEA9113264590FEE</code> <code>D35C505A345BD47451237A666CEE49E4</code> <code>A2FA740A1F54E463B63D5E5F2C4899AB</code> <code>3994A5493E36BF21ED968D7AD1B45CC2</code> <code>2CA533B947E410BE0419CCCF08639FE7</code> <code>2A207A88495BB6EAB0B39AF09B878D1B</code><br> <code>7EE94E0C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = BEF72B1A5FD2E0C6A22B264A130572011FC90012F8B29BD1ED755B7F1BEA352CC190D6044E2E7553473849BC1B52389FE0548EA7E678F0070ECF54831639954F5AFBA8A7B5CE0C9E7FB3B0551B1C83A543DE5F99B316DCD8C6CE211975DD3DED84899944EE4643E9D11E1F2C123DE0162FC2C47EFBC5736DB15C134E98581C6EE1A7C93CFEC52DAC6548D4F62706E28F4268BE2BCF9BD343D1F5EB882F246390008E4CEFD3B713A0CD683ACDBA5361B92402AD6E3A6EE91C40915E5C33CC1B7295FF00479CDC5821951B896A6D984FFD03746FE1679EDC1F188B71D620810DD22656E1CB0B8ED287AF8805BDCA2D44092309FA4831760121986B314FF620EA0C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D8 70 AC 47 E5 70 65
0010 | 58 00 00 00 34 F7 CB 3B 0A 95 A3 0D D1 75 4A BF
0020 | 28 3B CE 96 F3 B3 EB 42 14 B7 7C B9 1E FB E6 D3
0030 | F5 CF 06 3E 93 8C 11 B7 CD 07 4D D7 BF 66 CE 04
0040 | 2E 10 24 B3 D8 7E AC 36</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D870AC47E57065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0A95A30DD1754ABF283BCE96F3B3EB42</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>14B77CB91EFBE6D3F5CF063E938C11B7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>CD074DD7BF66CE042E1024B3D87EAC36</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

