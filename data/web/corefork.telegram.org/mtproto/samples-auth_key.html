<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC EF 06 00 59 96 9E 64
0010 | 14 00 00 00 F1 8E 7E BE 3B 6C E1 1B ED C3 46 61
0020 | B0 E7 0F 88 33 91 0C 6F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CCEF060059969E64</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 EC 6A 62 59 96 9E 64
0010 | 50 00 00 00 63 24 16 05 3B 6C E1 1B ED C3 46 61
0020 | B0 E7 0F 88 33 91 0C 6F 78 D0 02 2E 8C 91 C6 34
0030 | 91 06 77 B5 9A 8B DD 7C 08 15 D2 EA 60 D9 E9 F0
0040 | 61 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;long&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01EC6A6259969E64</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0815D2EA60D9E9F061000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1572576921599471713</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector long)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1572576921599471713</code></pre>
<p>Decompose into 2 prime cofactors: <code>1572576921599471713 = 1182921973 * 1329400381</code></p>
<pre><code>p = 1182921973
q = 1329400381</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 15 D2 EA 60 D9 E9 F0 61 00 00 00
0010 | 04 46 81 F4 F5 00 00 00 04 4F 3D 0A 3D 00 00 00
0020 | 3B 6C E1 1B ED C3 46 61 B0 E7 0F 88 33 91 0C 6F
0030 | 78 D0 02 2E 8C 91 C6 34 91 06 77 B5 9A 8B DD 7C
0040 | ED FD 84 45 50 63 A5 3E AB FB 6D 2E 4B 46 7D 2F
0050 | A7 92 E2 CF 09 22 6E E0 10 74 AD 37 BF A3 61 01
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0815D2EA60D9E9F061000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1572576921599471713</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044681F4F5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1182921973</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044F3D0A3D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1329400381</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>EDFD84455063A53EABFB6D2E4B467D2F</code> <code>A792E2CF09226EE01074AD37BFA36101</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90815D2EA60D9E9F061000000044681F4F5000000044F3D0A3D0000003B6CE11BEDC34661B0E70F8833910C6F78D0022E8C91C634910677B59A8BDD7CEDFD84455063A53EABFB6D2E4B467D2FA792E2CF09226EE01074AD37BFA3610102000000
random_padding_bytes = D7BE719CB22BA6AF3DE51EADA87C69C52899A766A1060020D8F78E99F5BA4CE541FA6A770C64721DF54FF65A28D6BBD17EB31520D2E38A2414166F0DDC9504CF67B374297516EA704BC3CDA83CD239D777869EA299EC82F9BDC51E15</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A527714D9BE67624A4B3B7805E93D3D845ECD997A689C7022449909D7444BEF564B361443A949201616ACA30E9FF622C4597A330CDFAF2FFC3185BD9DF83E0D36F35C9921F0653202F696F7AB61BFBF3FA44F8B7D228ED08CDA276B7070F5C0FC6DD87FC8F27D61D63A358ED557CEA2977F2F8474458091F94AA54B46F97BBCB0409F4A999ECC9DC86EE294C608A9558C222B5D7FF4E339306583571F8DD08B6A6FF9D475F93FCB6E7FCF61E8EE1CB394378EBD7DCC86526852BA2FAFD219984FC1BEA7D10EB655AE34E62B0F38301D96160557777DCAD40C1FC311F009D998BB147226A0316A83F4810D6C164755D5AD02F0144BE205F31E5AC778FF3BBAAD7</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 1A 07 00 59 96 9E 64
0010 | 40 01 00 00 BE E4 12 D7 3B 6C E1 1B ED C3 46 61
0020 | B0 E7 0F 88 33 91 0C 6F 78 D0 02 2E 8C 91 C6 34
0030 | 91 06 77 B5 9A 8B DD 7C 04 46 81 F4 F5 00 00 00
0040 | 04 4F 3D 0A 3D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A5 27 71 4D 9B E6 76 24 A4 B3 B7 80
0060 | 5E 93 D3 D8 45 EC D9 97 A6 89 C7 02 24 49 90 9D
0070 | 74 44 BE F5 64 B3 61 44 3A 94 92 01 61 6A CA 30
0080 | E9 FF 62 2C 45 97 A3 30 CD FA F2 FF C3 18 5B D9
0090 | DF 83 E0 D3 6F 35 C9 92 1F 06 53 20 2F 69 6F 7A
00A0 | B6 1B FB F3 FA 44 F8 B7 D2 28 ED 08 CD A2 76 B7
00B0 | 07 0F 5C 0F C6 DD 87 FC 8F 27 D6 1D 63 A3 58 ED
00C0 | 55 7C EA 29 77 F2 F8 47 44 58 09 1F 94 AA 54 B4
00D0 | 6F 97 BB CB 04 09 F4 A9 99 EC C9 DC 86 EE 29 4C
00E0 | 60 8A 95 58 C2 22 B5 D7 FF 4E 33 93 06 58 35 71
00F0 | F8 DD 08 B6 A6 FF 9D 47 5F 93 FC B6 E7 FC F6 1E
0100 | 8E E1 CB 39 43 78 EB D7 DC C8 65 26 85 2B A2 FA
0110 | FD 21 99 84 FC 1B EA 7D 10 EB 65 5A E3 4E 62 B0
0120 | F3 83 01 D9 61 60 55 77 77 DC AD 40 C1 FC 31 1F
0130 | 00 9D 99 8B B1 47 22 6A 03 16 A8 3F 48 10 D6 C1
0140 | 64 75 5D 5A D0 2F 01 44 BE 20 5F 31 E5 AC 77 8F
0150 | F3 BB AA D7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E41A070059969E64</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044681F4F5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1182921973</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044F3D0A3D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1329400381</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A527714D9BE67624A4B3B780</code> <code>5E93D3D845ECD997A689C7022449909D</code> <code>7444BEF564B361443A949201616ACA30</code> <code>E9FF622C4597A330CDFAF2FFC3185BD9</code> <code>DF83E0D36F35C9921F0653202F696F7A</code> <code>B61BFBF3FA44F8B7D228ED08CDA276B7</code> <code>070F5C0FC6DD87FC8F27D61D63A358ED</code> <code>557CEA2977F2F8474458091F94AA54B4</code> <code>6F97BBCB0409F4A999ECC9DC86EE294C</code> <code>608A9558C222B5D7FF4E339306583571</code> <code>F8DD08B6A6FF9D475F93FCB6E7FCF61E</code> <code>8EE1CB394378EBD7DCC86526852BA2FA</code> <code>FD219984FC1BEA7D10EB655AE34E62B0</code> <code>F38301D96160557777DCAD40C1FC311F</code> <code>009D998BB147226A0316A83F4810D6C1</code> <code>64755D5AD02F0144BE205F31E5AC778F</code><br> <code>F3BBAAD7</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 48 D7 03 5A 96 9E 64
0010 | 78 02 00 00 5C 07 E8 D0 3B 6C E1 1B ED C3 46 61
0020 | B0 E7 0F 88 33 91 0C 6F 78 D0 02 2E 8C 91 C6 34
0030 | 91 06 77 B5 9A 8B DD 7C FE 50 02 00 83 6A C3 4E
0040 | F2 22 34 FE 19 22 3F 02 F8 1B CB F2 E1 AD 74 F0
0050 | B4 D3 CF B4 E5 0B E3 12 C6 B4 EA 17 8B 8A FC 86
0060 | 26 5D C1 73 AF 33 24 8C C2 89 51 C2 FD 8E 1A 56
0070 | 58 E4 85 AF C6 51 CA AC 1E 2F 31 F8 3D F5 52 2D
0080 | 8B 1D 04 1A C2 CD 1D 4D 02 B0 C8 C3 95 3B 74 65
0090 | 2E 6F 85 A3 FE A2 7D F2 B9 7E 46 66 44 24 3D 06
00A0 | 2D 55 8C DE 6F 96 95 0F F8 EA 2A 3B 4D 83 9E 58
00B0 | DD 73 0C 44 5B 3E 75 00 FF C5 7E 1F A7 7D 12 CB
00C0 | 9E FF 24 DC 8E 6F 8B D2 64 60 EB 32 C6 BC 76 45
00D0 | 44 B0 BC A0 47 0A FA 0E 99 E6 CD DF CB FC 3B 88
00E0 | F4 6A 30 31 4F A0 3F 51 7B 16 FD C6 60 EF 62 96
00F0 | 12 89 C8 03 67 7E DA 9B E5 9E 74 3C AC A4 E5 13
0100 | 55 37 1B 94 CA DC DB 16 26 F8 9C 4F 5D 5D FB FF
0110 | DC BD 4A D7 E7 73 6C 9B 08 AB 6E FB 72 5A 07 2F
0120 | 02 4F 48 F2 64 11 78 3F AA 27 73 87 DA 62 EA EF
0130 | 5D BA 72 F6 80 53 61 CD 09 8D C6 C5 51 A8 7B 8F
0140 | 70 7E 0E 2A F0 49 EA F9 50 4D 6C C1 A8 16 3E 86
0150 | B9 EC 77 CA 94 CB 92 58 51 73 6B 1F 01 EA 46 32
0160 | 7D 2A 1B 7F C1 1F B0 A9 53 C6 9D 32 DB 5E 64 45
0170 | 10 0C 6B 09 96 A6 77 F2 AF E1 E5 04 EE 20 28 87
0180 | AB 15 B2 D7 EF 36 AE 6A B4 22 2F 2B 5D DD F4 3A
0190 | 22 52 D0 17 4B 87 86 96 6B 1D A5 A9 EC 9E 47 20
01A0 | FD 83 0C 70 E6 5E 6B 27 61 80 77 35 8A E2 CC D6
01B0 | 21 2E ED 54 91 12 27 1F 0A C5 B8 83 19 A6 C6 EA
01C0 | CD 8B 43 7B 12 67 C8 85 5B 10 80 B9 85 C8 3D 25
01D0 | 99 1C F3 EA 6D 77 38 F7 10 CE D4 81 19 6B 8E D7
01E0 | E3 33 05 8B 24 31 27 0E E0 AA 90 17 DF D1 40 CF
01F0 | 82 D5 CB 06 E5 D3 17 69 67 04 53 8F 50 42 06 73
0200 | 44 CA D2 22 8D 4B 13 AA 51 10 DD B2 93 62 52 54
0210 | DB 25 22 ED 64 32 69 26 78 BE D3 EB F9 2F C1 C7
0220 | 0B 25 33 BF 6E 04 FB 4C D8 00 F9 B6 78 65 02 C9
0230 | BF 0E FE A8 51 22 04 B7 4A 6E 89 A6 03 24 5B B1
0240 | 57 8F EA A8 C8 7A F7 3E 6D B6 5F B4 B5 75 D5 65
0250 | D1 DD C3 60 EF BF 20 60 87 82 6A 53 75 5B 13 8A
0260 | F9 FC 04 83 E9 7C 32 E1 6B A8 71 03 4D 93 D1 0A
0270 | A0 30 88 F3 8E DD 65 99 00 7F 1F 4F 09 E6 D6 2B
0280 | 6B 14 55 0E 49 B8 1F 28 EB 06 D6 5A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0148D7035A969E64</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200836AC34EF22234FE19223F02</code> <code>F81BCBF2E1AD74F0B4D3CFB4E50BE312</code> <code>C6B4EA178B8AFC86265DC173AF33248C</code> <code>C28951C2FD8E1A5658E485AFC651CAAC</code> <code>1E2F31F83DF5522D8B1D041AC2CD1D4D</code> <code>02B0C8C3953B74652E6F85A3FEA27DF2</code> <code>B97E466644243D062D558CDE6F96950F</code> <code>F8EA2A3B4D839E58DD730C445B3E7500</code> <code>FFC57E1FA77D12CB9EFF24DC8E6F8BD2</code> <code>6460EB32C6BC764544B0BCA0470AFA0E</code> <code>99E6CDDFCBFC3B88F46A30314FA03F51</code> <code>7B16FDC660EF62961289C803677EDA9B</code> <code>E59E743CACA4E51355371B94CADCDB16</code> <code>26F89C4F5D5DFBFFDCBD4AD7E7736C9B</code> <code>08AB6EFB725A072F024F48F26411783F</code> <code>AA277387DA62EAEF5DBA72F6805361CD</code> <code>098DC6C551A87B8F707E0E2AF049EAF9</code> <code>504D6CC1A8163E86B9EC77CA94CB9258</code> <code>51736B1F01EA46327D2A1B7FC11FB0A9</code> <code>53C69D32DB5E6445100C6B0996A677F2</code> <code>AFE1E504EE202887AB15B2D7EF36AE6A</code> <code>B4222F2B5DDDF43A2252D0174B878696</code> <code>6B1DA5A9EC9E4720FD830C70E65E6B27</code> <code>618077358AE2CCD6212EED549112271F</code> <code>0AC5B88319A6C6EACD8B437B1267C885</code> <code>5B1080B985C83D25991CF3EA6D7738F7</code> <code>10CED481196B8ED7E333058B2431270E</code> <code>E0AA9017DFD140CF82D5CB06E5D31769</code> <code>6704538F5042067344CAD2228D4B13AA</code> <code>5110DDB293625254DB2522ED64326926</code> <code>78BED3EBF92FC1C70B2533BF6E04FB4C</code> <code>D800F9B6786502C9BF0EFEA8512204B7</code> <code>4A6E89A603245BB1578FEAA8C87AF73E</code> <code>6DB65FB4B575D565D1DDC360EFBF2060</code> <code>87826A53755B138AF9FC0483E97C32E1</code> <code>6BA871034D93D10AA03088F38EDD6599</code> <code>007F1F4F09E6D62B6B14550E49B81F28</code><br> <code>EB06D65A</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 836AC34EF22234FE19223F02F81BCBF2E1AD74F0B4D3CFB4E50BE312C6B4EA178B8AFC86265DC173AF33248CC28951C2FD8E1A5658E485AFC651CAAC1E2F31F83DF5522D8B1D041AC2CD1D4D02B0C8C3953B74652E6F85A3FEA27DF2B97E466644243D062D558CDE6F96950FF8EA2A3B4D839E58DD730C445B3E7500FFC57E1FA77D12CB9EFF24DC8E6F8BD26460EB32C6BC764544B0BCA0470AFA0E99E6CDDFCBFC3B88F46A30314FA03F517B16FDC660EF62961289C803677EDA9BE59E743CACA4E51355371B94CADCDB1626F89C4F5D5DFBFFDCBD4AD7E7736C9B08AB6EFB725A072F024F48F26411783FAA277387DA62EAEF5DBA72F6805361CD098DC6C551A87B8F707E0E2AF049EAF9504D6CC1A8163E86B9EC77CA94CB925851736B1F01EA46327D2A1B7FC11FB0A953C69D32DB5E6445100C6B0996A677F2AFE1E504EE202887AB15B2D7EF36AE6AB4222F2B5DDDF43A2252D0174B8786966B1DA5A9EC9E4720FD830C70E65E6B27618077358AE2CCD6212EED549112271F0AC5B88319A6C6EACD8B437B1267C8855B1080B985C83D25991CF3EA6D7738F710CED481196B8ED7E333058B2431270EE0AA9017DFD140CF82D5CB06E5D317696704538F5042067344CAD2228D4B13AA5110DDB293625254DB2522ED6432692678BED3EBF92FC1C70B2533BF6E04FB4CD800F9B6786502C9BF0EFEA8512204B74A6E89A603245BB1578FEAA8C87AF73E6DB65FB4B575D565D1DDC360EFBF206087826A53755B138AF9FC0483E97C32E16BA871034D93D10AA03088F38EDD6599007F1F4F09E6D62B6B14550E49B81F28EB06D65A
tmp_aes_key = 3956EDA6DB9239D3E00942D65FA2782983547D27A037FC9A3875196482457CF5
tmp_aes_iv = ED25CF95B5053DDCC1F53F4AD1AF7DD0E5A4A21F89ECDFBB2F041BE4EDFD8445</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 70F677AA69190441C67862FB9CD0C689083BC134BA0D89B53B6CE11BEDC34661B0E70F8833910C6F78D0022E8C91C634910677B59A8BDD7C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001BEA1C03F21CA802A6E62922E4FEF1FAEC50248AF15A2BBA07A97D3D1FCD3EFCE454F5F51CDB120D8F1DAA89548F9AF41D18A6542B28F9153AA7E48122950F5E002E511DF55F81A6340259CA6DDCB1C19B3FEFF37F382AC719B2A535F76FFD41E14A34EBF7DE44DF8F355893EDA79ED914A9B83C31E6075A1E3F29EE7D682D6DE5A3161D05864E4402E2AF00A331ABD9BF5AFB2FB207DD314459E4AD791F4416C98E51F3FDD9F9210CC24CF14D775C60207950642B2E28B1E1FC0F39102EC590AFD76FB070759C6064E9884AE6F30D7969909A7FF99B1DA6E246DD7612194915BAC36F14139C1728546C0325DFF289D1339AF61772FFFD9C16F7D7AB92267AC85A969E64DAD6000E2A59A52B
answer = BA0D89B53B6CE11BEDC34661B0E70F8833910C6F78D0022E8C91C634910677B59A8BDD7C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001BEA1C03F21CA802A6E62922E4FEF1FAEC50248AF15A2BBA07A97D3D1FCD3EFCE454F5F51CDB120D8F1DAA89548F9AF41D18A6542B28F9153AA7E48122950F5E002E511DF55F81A6340259CA6DDCB1C19B3FEFF37F382AC719B2A535F76FFD41E14A34EBF7DE44DF8F355893EDA79ED914A9B83C31E6075A1E3F29EE7D682D6DE5A3161D05864E4402E2AF00A331ABD9BF5AFB2FB207DD314459E4AD791F4416C98E51F3FDD9F9210CC24CF14D775C60207950642B2E28B1E1FC0F39102EC590AFD76FB070759C6064E9884AE6F30D7969909A7FF99B1DA6E246DD7612194915BAC36F14139C1728546C0325DFF289D1339AF61772FFFD9C16F7D7AB92267AC85A969E64DAD6000E2A59A52B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 3B 6C E1 1B ED C3 46 61 B0 E7 0F 88
0010 | 33 91 0C 6F 78 D0 02 2E 8C 91 C6 34 91 06 77 B5
0020 | 9A 8B DD 7C 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 1B EA 1C 03 F2 1C A8 02 A6 E6 29 22 E4 FE F1 FA
0140 | EC 50 24 8A F1 5A 2B BA 07 A9 7D 3D 1F CD 3E FC
0150 | E4 54 F5 F5 1C DB 12 0D 8F 1D AA 89 54 8F 9A F4
0160 | 1D 18 A6 54 2B 28 F9 15 3A A7 E4 81 22 95 0F 5E
0170 | 00 2E 51 1D F5 5F 81 A6 34 02 59 CA 6D DC B1 C1
0180 | 9B 3F EF F3 7F 38 2A C7 19 B2 A5 35 F7 6F FD 41
0190 | E1 4A 34 EB F7 DE 44 DF 8F 35 58 93 ED A7 9E D9
01A0 | 14 A9 B8 3C 31 E6 07 5A 1E 3F 29 EE 7D 68 2D 6D
01B0 | E5 A3 16 1D 05 86 4E 44 02 E2 AF 00 A3 31 AB D9
01C0 | BF 5A FB 2F B2 07 DD 31 44 59 E4 AD 79 1F 44 16
01D0 | C9 8E 51 F3 FD D9 F9 21 0C C2 4C F1 4D 77 5C 60
01E0 | 20 79 50 64 2B 2E 28 B1 E1 FC 0F 39 10 2E C5 90
01F0 | AF D7 6F B0 70 75 9C 60 64 E9 88 4A E6 F3 0D 79
0200 | 69 90 9A 7F F9 9B 1D A6 E2 46 DD 76 12 19 49 15
0210 | BA C3 6F 14 13 9C 17 28 54 6C 03 25 DF F2 89 D1
0220 | 33 9A F6 17 72 FF FD 9C 16 F7 D7 AB 92 26 7A C8
0230 | 5A 96 9E 64</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001001BEA1C03F21CA802A6E62922</code> <code>E4FEF1FAEC50248AF15A2BBA07A97D3D</code> <code>1FCD3EFCE454F5F51CDB120D8F1DAA89</code> <code>548F9AF41D18A6542B28F9153AA7E481</code> <code>22950F5E002E511DF55F81A6340259CA</code> <code>6DDCB1C19B3FEFF37F382AC719B2A535</code> <code>F76FFD41E14A34EBF7DE44DF8F355893</code> <code>EDA79ED914A9B83C31E6075A1E3F29EE</code> <code>7D682D6DE5A3161D05864E4402E2AF00</code> <code>A331ABD9BF5AFB2FB207DD314459E4AD</code> <code>791F4416C98E51F3FDD9F9210CC24CF1</code> <code>4D775C60207950642B2E28B1E1FC0F39</code> <code>102EC590AFD76FB070759C6064E9884A</code> <code>E6F30D7969909A7FF99B1DA6E246DD76</code> <code>12194915BAC36F14139C1728546C0325</code> <code>DFF289D1339AF61772FFFD9C16F7D7AB</code><br> <code>92267AC8</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>5A969E64</code> (1688114778 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 744E93CF8FA7E1510D1FE832C1DCE2AF7B343B0D786CA507D1F34DBABF922AFFB3D0635EDE27ADF1F2B2A5471CC087A69665BB834C98D4CAEC542892AB02A4087734B6F3AE36A78FCF38A78659F15DBE4C416963955486C656A9AFD8AE81A3357B2FA6BEEB37A561356C5188D593D941A711C06A836ECBF684BF37437F033010432227DB935FDF2CA0B0BF0B644DEB64394D1BFB6A5DCAC8E117DB36E46B8EE8C5FE300276997EFA0B5BDA54C6C9F5F7D45B38E93A0FB2F33A2A929252D47BCB71CF0423DEA4E122F63551C3198C07BA84F95C36104761EF23D294F226FDA75AB3321C2F3A2071F52056688B9295C09EBF751E4CC2022BCD2E79BB716B23203D</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 55F3A678CBBC2D12C34DC41345387B1162E949DCA78F1D7DC02167AB9B983CAC956AE49E50FA0655C45CB7FD439238E6FAB3F4186794602FE44BE4194912B32536619A017A4DFE50D9893FF9C511B5DA8AE5A7598DDFD82BA0122DA7937E22BCE1F3F3C0CE51E6EBEA24FDA496C7365B0CFBC16671E06A10CB45A0749F520401C278E7F8A162BBDDF6973642A5E49E515962328297012984B36EF4D2D35C28C20CB25928B3F3D46BA6FC6FEE832F71F16347744F75085AA22F3677717D8F643F5AF88C394F87B149144CDA035977A08443679DC97E17642AF1C0519095686642E158A0F0D9CFAFE461ACABB41A72A76AE8FC5F39EDAF53DE68DEBE8EDEDFAB9B</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 3B 6C E1 1B ED C3 46 61 B0 E7 0F 88
0010 | 33 91 0C 6F 78 D0 02 2E 8C 91 C6 34 91 06 77 B5
0020 | 9A 8B DD 7C 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 55 F3 A6 78 CB BC 2D 12 C3 4D C4 13 45 38 7B 11
0040 | 62 E9 49 DC A7 8F 1D 7D C0 21 67 AB 9B 98 3C AC
0050 | 95 6A E4 9E 50 FA 06 55 C4 5C B7 FD 43 92 38 E6
0060 | FA B3 F4 18 67 94 60 2F E4 4B E4 19 49 12 B3 25
0070 | 36 61 9A 01 7A 4D FE 50 D9 89 3F F9 C5 11 B5 DA
0080 | 8A E5 A7 59 8D DF D8 2B A0 12 2D A7 93 7E 22 BC
0090 | E1 F3 F3 C0 CE 51 E6 EB EA 24 FD A4 96 C7 36 5B
00A0 | 0C FB C1 66 71 E0 6A 10 CB 45 A0 74 9F 52 04 01
00B0 | C2 78 E7 F8 A1 62 BB DD F6 97 36 42 A5 E4 9E 51
00C0 | 59 62 32 82 97 01 29 84 B3 6E F4 D2 D3 5C 28 C2
00D0 | 0C B2 59 28 B3 F3 D4 6B A6 FC 6F EE 83 2F 71 F1
00E0 | 63 47 74 4F 75 08 5A A2 2F 36 77 71 7D 8F 64 3F
00F0 | 5A F8 8C 39 4F 87 B1 49 14 4C DA 03 59 77 A0 84
0100 | 43 67 9D C9 7E 17 64 2A F1 C0 51 90 95 68 66 42
0110 | E1 58 A0 F0 D9 CF AF E4 61 AC AB B4 1A 72 A7 6A
0120 | E8 FC 5F 39 ED AF 53 DE 68 DE BE 8E DE DF AB 9B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010055F3A678CBBC2D12C34DC413</code> <code>45387B1162E949DCA78F1D7DC02167AB</code> <code>9B983CAC956AE49E50FA0655C45CB7FD</code> <code>439238E6FAB3F4186794602FE44BE419</code> <code>4912B32536619A017A4DFE50D9893FF9</code> <code>C511B5DA8AE5A7598DDFD82BA0122DA7</code> <code>937E22BCE1F3F3C0CE51E6EBEA24FDA4</code> <code>96C7365B0CFBC16671E06A10CB45A074</code> <code>9F520401C278E7F8A162BBDDF6973642</code> <code>A5E49E515962328297012984B36EF4D2</code> <code>D35C28C20CB25928B3F3D46BA6FC6FEE</code> <code>832F71F16347744F75085AA22F367771</code> <code>7D8F643F5AF88C394F87B149144CDA03</code> <code>5977A08443679DC97E17642AF1C05190</code> <code>95686642E158A0F0D9CFAFE461ACABB4</code> <code>1A72A76AE8FC5F39EDAF53DE68DEBE8E</code><br> <code>DEDFAB9B</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643663B6CE11BEDC34661B0E70F8833910C6F78D0022E8C91C634910677B59A8BDD7C0000000000000000FE00010055F3A678CBBC2D12C34DC41345387B1162E949DCA78F1D7DC02167AB9B983CAC956AE49E50FA0655C45CB7FD439238E6FAB3F4186794602FE44BE4194912B32536619A017A4DFE50D9893FF9C511B5DA8AE5A7598DDFD82BA0122DA7937E22BCE1F3F3C0CE51E6EBEA24FDA496C7365B0CFBC16671E06A10CB45A0749F520401C278E7F8A162BBDDF6973642A5E49E515962328297012984B36EF4D2D35C28C20CB25928B3F3D46BA6FC6FEE832F71F16347744F75085AA22F3677717D8F643F5AF88C394F87B149144CDA035977A08443679DC97E17642AF1C0519095686642E158A0F0D9CFAFE461ACABB41A72A76AE8FC5F39EDAF53DE68DEBE8EDEDFAB9B
padding = 85AA2A17BC9D581BA4E758F7
tmp_aes_key = 3956EDA6DB9239D3E00942D65FA2782983547D27A037FC9A3875196482457CF5
tmp_aes_iv = ED25CF95B5053DDCC1F53F4AD1AF7DD0E5A4A21F89ECDFBB2F041BE4EDFD8445</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C65BD12A8AD2A14AC0343F20F6BF3844DD8D81A18975F0827FEE29DD0CB97F7F1531D3EF781A9777F799EAD72CDBB84BEABCEBEC4C8232D51773493C6C4DB77A39B0BCD4AFED22FCEA12957BDF0FE5880FB8D6C38B12FE1C3F39694D12BFA0A3E124ACA9547F44678F5388561196085DE31F6AD05F30C87B213F0A2CC366DD73126FE3668FA448F84E5C1A2BCE76BE5B4B66001C69E6C124FA731FCF653F92A584DFAECCF247BD41AE10F3633999B0BA842BFFEC4B669BB01645167168DABE5C9EBEEA1B0ED94DAED0C7BA6CE6513A1F6292E9D9B85D8328C2A4D8BA3A43DCE484F2B5BB26FDD3337CA81D835A830EF56F623060DE68F93E21BBA5E893A2C352DA2DD697A6B562DDD677AB92FD748445509CDCCF5954D99D934BD7AC2730A36F096C0E8E57CA39C36EE8EDFDCED80B20C558B75A117944E57E0D89F333E2169ED6CA00C73886CD68CC7B116E2BE156E6</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 1C 47 04 00 5A 96 9E 64
0010 | 78 01 00 00 1F 5F 04 F5 3B 6C E1 1B ED C3 46 61
0020 | B0 E7 0F 88 33 91 0C 6F 78 D0 02 2E 8C 91 C6 34
0030 | 91 06 77 B5 9A 8B DD 7C FE 50 01 00 C6 5B D1 2A
0040 | 8A D2 A1 4A C0 34 3F 20 F6 BF 38 44 DD 8D 81 A1
0050 | 89 75 F0 82 7F EE 29 DD 0C B9 7F 7F 15 31 D3 EF
0060 | 78 1A 97 77 F7 99 EA D7 2C DB B8 4B EA BC EB EC
0070 | 4C 82 32 D5 17 73 49 3C 6C 4D B7 7A 39 B0 BC D4
0080 | AF ED 22 FC EA 12 95 7B DF 0F E5 88 0F B8 D6 C3
0090 | 8B 12 FE 1C 3F 39 69 4D 12 BF A0 A3 E1 24 AC A9
00A0 | 54 7F 44 67 8F 53 88 56 11 96 08 5D E3 1F 6A D0
00B0 | 5F 30 C8 7B 21 3F 0A 2C C3 66 DD 73 12 6F E3 66
00C0 | 8F A4 48 F8 4E 5C 1A 2B CE 76 BE 5B 4B 66 00 1C
00D0 | 69 E6 C1 24 FA 73 1F CF 65 3F 92 A5 84 DF AE CC
00E0 | F2 47 BD 41 AE 10 F3 63 39 99 B0 BA 84 2B FF EC
00F0 | 4B 66 9B B0 16 45 16 71 68 DA BE 5C 9E BE EA 1B
0100 | 0E D9 4D AE D0 C7 BA 6C E6 51 3A 1F 62 92 E9 D9
0110 | B8 5D 83 28 C2 A4 D8 BA 3A 43 DC E4 84 F2 B5 BB
0120 | 26 FD D3 33 7C A8 1D 83 5A 83 0E F5 6F 62 30 60
0130 | DE 68 F9 3E 21 BB A5 E8 93 A2 C3 52 DA 2D D6 97
0140 | A6 B5 62 DD D6 77 AB 92 FD 74 84 45 50 9C DC CF
0150 | 59 54 D9 9D 93 4B D7 AC 27 30 A3 6F 09 6C 0E 8E
0160 | 57 CA 39 C3 6E E8 ED FD CE D8 0B 20 C5 58 B7 5A
0170 | 11 79 44 E5 7E 0D 89 F3 33 E2 16 9E D6 CA 00 C7
0180 | 38 86 CD 68 CC 7B 11 6E 2B E1 56 E6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>1C4704005A969E64</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C65BD12A8AD2A14AC0343F20</code> <code>F6BF3844DD8D81A18975F0827FEE29DD</code> <code>0CB97F7F1531D3EF781A9777F799EAD7</code> <code>2CDBB84BEABCEBEC4C8232D51773493C</code> <code>6C4DB77A39B0BCD4AFED22FCEA12957B</code> <code>DF0FE5880FB8D6C38B12FE1C3F39694D</code> <code>12BFA0A3E124ACA9547F44678F538856</code> <code>1196085DE31F6AD05F30C87B213F0A2C</code> <code>C366DD73126FE3668FA448F84E5C1A2B</code> <code>CE76BE5B4B66001C69E6C124FA731FCF</code> <code>653F92A584DFAECCF247BD41AE10F363</code> <code>3999B0BA842BFFEC4B669BB016451671</code> <code>68DABE5C9EBEEA1B0ED94DAED0C7BA6C</code> <code>E6513A1F6292E9D9B85D8328C2A4D8BA</code> <code>3A43DCE484F2B5BB26FDD3337CA81D83</code> <code>5A830EF56F623060DE68F93E21BBA5E8</code> <code>93A2C352DA2DD697A6B562DDD677AB92</code> <code>FD748445509CDCCF5954D99D934BD7AC</code> <code>2730A36F096C0E8E57CA39C36EE8EDFD</code> <code>CED80B20C558B75A117944E57E0D89F3</code> <code>33E2169ED6CA00C73886CD68CC7B116E</code><br> <code>2BE156E6</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 3527D417E01D4F221CECB78C9B5C29936C3CECC218DF73F86FECBAE6641A78998805CDF21B48558B6B5E51B6F4C639C6007CA58453CFEF33DD6CB6E2FF7FB6DDC9FE801BEC559EBD969B16FD49F6F808B18F8391DD336FB7D2E46D868444EE22B4805E1FDCA0EA115B81B3C23B138503DA4DC02EF639240BB60EB4A897A8A325090E221F4D60B37704D7ED709ABD6AC2C78FF6973B79A5196E8EC6F2814E5BD1A99F716085B03769044F38A8A6683EF8E772C6864C72D01A3EBD83F23C2372AC59CDD9260E104FFF8540A8EE5680BF2885FB385D8F6D759C9C66B355F84EB18CB00C4ADDBB7899AE5A3452C559862C3FC7C1171F5701A4D748830FA90C25F334</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 C9 4C 5A 96 9E 64
0010 | 34 00 00 00 34 F7 CB 3B 3B 6C E1 1B ED C3 46 61
0020 | B0 E7 0F 88 33 91 0C 6F 78 D0 02 2E 8C 91 C6 34
0030 | 91 06 77 B5 9A 8B DD 7C 09 8D 03 93 43 E0 FD 46
0040 | 06 5E 7C 90 20 D7 9F 17</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0198C94C5A969E64</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3B6CE11BEDC34661B0E70F8833910C6F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>78D0022E8C91C634910677B59A8BDD7C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>098D039343E0FD46065E7C9020D79F17</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)">Twitter</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

