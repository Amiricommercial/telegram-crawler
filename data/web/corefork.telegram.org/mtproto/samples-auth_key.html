<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C 46 04 00 01 BB 3A 65
0010 | 14 00 00 00 F1 8E 7E BE 43 FE 8B 3B A6 4A AA 94
0020 | F0 20 39 D5 5E 62 38 8C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7C46040001BB3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D8 6F 4A FD BA 3A 65
0010 | A8 00 00 00 63 24 16 05 43 FE 8B 3B A6 4A AA 94
0020 | F0 20 39 D5 5E 62 38 8C AA 91 9A 98 37 CA 9A 0B
0030 | 67 B5 1B BA C6 7D FE 85 08 11 DC E4 D6 EE 81 AE
0040 | 6B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D86F4AFDBA3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8000000</code> (168 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0811DCE4D6EE81AE6B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1287155205296729707</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1287155205296729707</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1287155205296729707 = 1049313127 * 1226664541</code></p>
<pre><code>p = 1049313127
q = 1226664541</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 11 DC E4 D6 EE 81 AE 6B 00 00 00
0010 | 04 3E 8B 3F 67 00 00 00 04 49 1D 6A 5D 00 00 00
0020 | 43 FE 8B 3B A6 4A AA 94 F0 20 39 D5 5E 62 38 8C
0030 | AA 91 9A 98 37 CA 9A 0B 67 B5 1B BA C6 7D FE 85
0040 | 9A D1 C2 F1 29 A2 EE 2B B3 54 7C 10 FB 86 64 7A
0050 | C0 29 26 95 C7 9C 8D 10 92 81 27 8E E8 C0 D9 F9
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0811DCE4D6EE81AE6B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1287155205296729707</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043E8B3F67000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1049313127</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04491D6A5D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1226664541</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>9AD1C2F129A2EE2BB3547C10FB86647A</code> <code>C0292695C79C8D109281278EE8C0D9F9</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90811DCE4D6EE81AE6B000000043E8B3F6700000004491D6A5D00000043FE8B3BA64AAA94F02039D55E62388CAA919A9837CA9A0B67B51BBAC67DFE859AD1C2F129A2EE2BB3547C10FB86647AC0292695C79C8D109281278EE8C0D9F902000000
random_padding_bytes = 3E4818740CBFDBCD9B7598BA1E81B1906EA0BF17B3A0C9FDAC7702439992121F708E684303ABF945BDD9F09D6498336233ADBD5E34E39DFF3E99C4760C43842B4AE628B719C2945E52E235C79AB24164FE7DEC78056FCB932B6A1019</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = DF2EDED6F60F78A5DE43D246475387E9C6BF476D11D786DC8FD2D1816B646EF896B80B18C0FBADF4822EDDA30378EA8611D216E9A82EF862A3E8CA746281065CDE8775A515FF9AB8C3473BFED8993DA00E59A47FECBFB3AAAFE5ED4FBAAB1E6FBC7C1596B7CA2097061D9CE536F5C48BBBC7917D6E0DC3AE91D3A18A9F33A395D8D952308B5CEC1FB01A85539FB3A73DE21234CE05A7BD49DAC9B65DBF0FD1B10979469ECF1374D4DB2034F71D9C907086A1100FBDF1274A524584FDF7A895920FA6425C9CC2ABDC471A1C28D8A0098306879FA4E7AE6FA197541B6AE70BF1641A2EC9A76F835565F3F2C498824024696E6E41B728D9804127F34EFC2F0E757E</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 2C E7 06 00 01 BB 3A 65
0010 | 40 01 00 00 BE E4 12 D7 43 FE 8B 3B A6 4A AA 94
0020 | F0 20 39 D5 5E 62 38 8C AA 91 9A 98 37 CA 9A 0B
0030 | 67 B5 1B BA C6 7D FE 85 04 3E 8B 3F 67 00 00 00
0040 | 04 49 1D 6A 5D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 DF 2E DE D6 F6 0F 78 A5 DE 43 D2 46
0060 | 47 53 87 E9 C6 BF 47 6D 11 D7 86 DC 8F D2 D1 81
0070 | 6B 64 6E F8 96 B8 0B 18 C0 FB AD F4 82 2E DD A3
0080 | 03 78 EA 86 11 D2 16 E9 A8 2E F8 62 A3 E8 CA 74
0090 | 62 81 06 5C DE 87 75 A5 15 FF 9A B8 C3 47 3B FE
00A0 | D8 99 3D A0 0E 59 A4 7F EC BF B3 AA AF E5 ED 4F
00B0 | BA AB 1E 6F BC 7C 15 96 B7 CA 20 97 06 1D 9C E5
00C0 | 36 F5 C4 8B BB C7 91 7D 6E 0D C3 AE 91 D3 A1 8A
00D0 | 9F 33 A3 95 D8 D9 52 30 8B 5C EC 1F B0 1A 85 53
00E0 | 9F B3 A7 3D E2 12 34 CE 05 A7 BD 49 DA C9 B6 5D
00F0 | BF 0F D1 B1 09 79 46 9E CF 13 74 D4 DB 20 34 F7
0100 | 1D 9C 90 70 86 A1 10 0F BD F1 27 4A 52 45 84 FD
0110 | F7 A8 95 92 0F A6 42 5C 9C C2 AB DC 47 1A 1C 28
0120 | D8 A0 09 83 06 87 9F A4 E7 AE 6F A1 97 54 1B 6A
0130 | E7 0B F1 64 1A 2E C9 A7 6F 83 55 65 F3 F2 C4 98
0140 | 82 40 24 69 6E 6E 41 B7 28 D9 80 41 27 F3 4E FC
0150 | 2F 0E 75 7E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>2CE7060001BB3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043E8B3F67000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1049313127</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04491D6A5D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1226664541</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100DF2EDED6F60F78A5DE43D246</code> <code>475387E9C6BF476D11D786DC8FD2D181</code> <code>6B646EF896B80B18C0FBADF4822EDDA3</code> <code>0378EA8611D216E9A82EF862A3E8CA74</code> <code>6281065CDE8775A515FF9AB8C3473BFE</code> <code>D8993DA00E59A47FECBFB3AAAFE5ED4F</code> <code>BAAB1E6FBC7C1596B7CA2097061D9CE5</code> <code>36F5C48BBBC7917D6E0DC3AE91D3A18A</code> <code>9F33A395D8D952308B5CEC1FB01A8553</code> <code>9FB3A73DE21234CE05A7BD49DAC9B65D</code> <code>BF0FD1B10979469ECF1374D4DB2034F7</code> <code>1D9C907086A1100FBDF1274A524584FD</code> <code>F7A895920FA6425C9CC2ABDC471A1C28</code> <code>D8A0098306879FA4E7AE6FA197541B6A</code> <code>E70BF1641A2EC9A76F835565F3F2C498</code> <code>824024696E6E41B728D9804127F34EFC</code><br> <code>2F0E757E</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 50 C8 EE FD BA 3A 65
0010 | A0 02 00 00 5C 07 E8 D0 43 FE 8B 3B A6 4A AA 94
0020 | F0 20 39 D5 5E 62 38 8C AA 91 9A 98 37 CA 9A 0B
0030 | 67 B5 1B BA C6 7D FE 85 FE 50 02 00 16 46 9C B8
0040 | 9D 84 3B 92 A5 50 B2 20 08 6A 3F 84 F4 CC 31 C3
0050 | 94 CC 96 76 32 1E FB 56 90 A4 A9 5B 52 71 17 6A
0060 | 55 77 A8 D2 EE DB 5C E3 D9 86 3E 89 01 B1 6F E3
0070 | 15 18 3E 25 73 F1 E1 F4 E5 57 D4 1B F4 8C 31 91
0080 | 35 4C 36 80 A0 0F 4F BF 28 6E 98 C9 58 25 03 4E
0090 | 5B A1 E8 23 86 3D B5 31 BB AA 7C C4 12 1C 63 3D
00A0 | 33 1E AB 18 3F E2 25 49 3E 9F 3B EC BB C5 59 96
00B0 | 6B 30 10 B0 5B 51 09 1C E6 D1 45 95 58 3D 03 DC
00C0 | DC AA BE 54 6D 1B 8C A9 47 9F 0D AE F9 A6 6A D6
00D0 | 84 30 70 40 11 0C 77 09 22 C7 E7 51 5B F2 B2 F8
00E0 | 1C 89 3A 04 48 7A E8 3D AA 42 FF 02 CB 27 DF E0
00F0 | 73 03 98 48 F8 F4 DC 0E CE 4A 43 73 BC 6F 2C 4B
0100 | 13 15 22 7E 81 25 75 6D 46 06 50 C9 A5 8D D6 34
0110 | F3 20 FF BB 56 CC 73 C9 B2 3F 9E E1 17 2B 5C 23
0120 | EE C1 B9 67 32 2D F9 69 8E FB 42 0C 04 29 F2 6C
0130 | 57 3B 57 75 CD 07 C6 4B F2 2B F8 DB 86 43 6D 86
0140 | BA E7 AF 3D 3C 10 2A C4 95 F4 02 15 89 58 E5 A8
0150 | 9D 13 44 74 7E 68 14 83 89 D4 4C 66 3E B1 B2 3E
0160 | 8E 7E BA 8F 39 22 16 E0 30 2F AA B3 B7 C6 C0 32
0170 | 3D 44 32 45 8A 28 01 4A 43 6E 37 50 D5 96 6D 85
0180 | 52 F3 E5 6D 7C A1 44 0E 5E 88 97 F7 40 2D 47 11
0190 | B2 8A B5 75 3B 66 CC 4B 0D 1A 8A 37 BE 59 B1 BA
01A0 | C7 D5 57 04 AB FB 1D 29 46 38 F6 56 16 FD 6C 5B
01B0 | 4D AE 18 04 89 09 C3 9F 45 D4 4C F5 1B FC 00 75
01C0 | 8E B4 FE 49 FA 2B 0A 48 27 9B 4F 36 11 D3 69 11
01D0 | DB EB 0F 25 22 77 82 C7 AB 2A 95 28 1A F1 EF 19
01E0 | 6A 6C 3D 1B 5D 10 95 69 FC 65 95 FD 67 6E A0 53
01F0 | DA 3E 78 BC E4 3F 90 7B EA 78 C0 8B CF 49 F4 D9
0200 | BF 60 10 F5 2F BA 7E 7A 0B 44 84 CD 8C F1 0D 1A
0210 | 5E AE 88 38 80 93 AA 7A 68 78 73 07 E5 23 FF CB
0220 | 35 14 92 74 E2 7A 96 6B BC B4 04 29 C4 41 DD C2
0230 | 3F 91 A8 15 47 94 10 EE 50 52 C8 60 B9 75 05 9D
0240 | E3 CE 60 C8 DF 96 E1 F5 A3 96 E3 90 AD DC 25 87
0250 | 94 65 6A 52 B6 89 EA AC 8F 41 3B 4D 1A 74 F6 59
0260 | EA 2C 50 72 0A C2 3E A7 28 63 FA 05 C9 37 00 68
0270 | E0 00 32 73 C8 7C 68 F2 4D 57 30 05 8D A8 5D 21
0280 | 7A 47 E9 F8 96 94 AC 4A FF AE 00 31</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0150C8EEFDBA3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A0020000</code> (672 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020016469CB89D843B92A550B220</code> <code>086A3F84F4CC31C394CC9676321EFB56</code> <code>90A4A95B5271176A5577A8D2EEDB5CE3</code> <code>D9863E8901B16FE315183E2573F1E1F4</code> <code>E557D41BF48C3191354C3680A00F4FBF</code> <code>286E98C95825034E5BA1E823863DB531</code> <code>BBAA7CC4121C633D331EAB183FE22549</code> <code>3E9F3BECBBC559966B3010B05B51091C</code> <code>E6D14595583D03DCDCAABE546D1B8CA9</code> <code>479F0DAEF9A66AD684307040110C7709</code> <code>22C7E7515BF2B2F81C893A04487AE83D</code> <code>AA42FF02CB27DFE073039848F8F4DC0E</code> <code>CE4A4373BC6F2C4B1315227E8125756D</code> <code>460650C9A58DD634F320FFBB56CC73C9</code> <code>B23F9EE1172B5C23EEC1B967322DF969</code> <code>8EFB420C0429F26C573B5775CD07C64B</code> <code>F22BF8DB86436D86BAE7AF3D3C102AC4</code> <code>95F402158958E5A89D1344747E681483</code> <code>89D44C663EB1B23E8E7EBA8F392216E0</code> <code>302FAAB3B7C6C0323D4432458A28014A</code> <code>436E3750D5966D8552F3E56D7CA1440E</code> <code>5E8897F7402D4711B28AB5753B66CC4B</code> <code>0D1A8A37BE59B1BAC7D55704ABFB1D29</code> <code>4638F65616FD6C5B4DAE18048909C39F</code> <code>45D44CF51BFC00758EB4FE49FA2B0A48</code> <code>279B4F3611D36911DBEB0F25227782C7</code> <code>AB2A95281AF1EF196A6C3D1B5D109569</code> <code>FC6595FD676EA053DA3E78BCE43F907B</code> <code>EA78C08BCF49F4D9BF6010F52FBA7E7A</code> <code>0B4484CD8CF10D1A5EAE88388093AA7A</code> <code>68787307E523FFCB35149274E27A966B</code> <code>BCB40429C441DDC23F91A815479410EE</code> <code>5052C860B975059DE3CE60C8DF96E1F5</code> <code>A396E390ADDC258794656A52B689EAAC</code> <code>8F413B4D1A74F659EA2C50720AC23EA7</code> <code>2863FA05C9370068E0003273C87C68F2</code> <code>4D5730058DA85D217A47E9F89694AC4A</code><br> <code>FFAE0031</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 16469CB89D843B92A550B220086A3F84F4CC31C394CC9676321EFB5690A4A95B5271176A5577A8D2EEDB5CE3D9863E8901B16FE315183E2573F1E1F4E557D41BF48C3191354C3680A00F4FBF286E98C95825034E5BA1E823863DB531BBAA7CC4121C633D331EAB183FE225493E9F3BECBBC559966B3010B05B51091CE6D14595583D03DCDCAABE546D1B8CA9479F0DAEF9A66AD684307040110C770922C7E7515BF2B2F81C893A04487AE83DAA42FF02CB27DFE073039848F8F4DC0ECE4A4373BC6F2C4B1315227E8125756D460650C9A58DD634F320FFBB56CC73C9B23F9EE1172B5C23EEC1B967322DF9698EFB420C0429F26C573B5775CD07C64BF22BF8DB86436D86BAE7AF3D3C102AC495F402158958E5A89D1344747E68148389D44C663EB1B23E8E7EBA8F392216E0302FAAB3B7C6C0323D4432458A28014A436E3750D5966D8552F3E56D7CA1440E5E8897F7402D4711B28AB5753B66CC4B0D1A8A37BE59B1BAC7D55704ABFB1D294638F65616FD6C5B4DAE18048909C39F45D44CF51BFC00758EB4FE49FA2B0A48279B4F3611D36911DBEB0F25227782C7AB2A95281AF1EF196A6C3D1B5D109569FC6595FD676EA053DA3E78BCE43F907BEA78C08BCF49F4D9BF6010F52FBA7E7A0B4484CD8CF10D1A5EAE88388093AA7A68787307E523FFCB35149274E27A966BBCB40429C441DDC23F91A815479410EE5052C860B975059DE3CE60C8DF96E1F5A396E390ADDC258794656A52B689EAAC8F413B4D1A74F659EA2C50720AC23EA72863FA05C9370068E0003273C87C68F24D5730058DA85D217A47E9F89694AC4AFFAE0031
tmp_aes_key = 3653556166227FF7E7BD25321B0AE7875E74D441E9E43BA3DF41EECD120219BE
tmp_aes_iv = 65DEAC819763A72F155B15D022F049A8AC61F69E6F04E8764738496E9AD1C2F1</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = FD8B2C21EEA966184B4F3D763E52B69B960378EFBA0D89B543FE8B3BA64AAA94F02039D55E62388CAA919A9837CA9A0B67B51BBAC67DFE8503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000409336942FA3C97C6AD3323142F46D5064103C031CD502034B9FBC5E94293E297862C8B97083A683BD4768EFA2C1AE46EC4299D1A7CCB107B1BBA8FA70896F12D955DD386A6ED21944A356FF1363E225B62B532997B0038F09F3530E61AD47EABB797DE592C7237F682CE1EBF1CF5F91290377D53F963C9DB8283B1C60DA21B2479478A26EF2E32EA084421B8CA88878ED6A8F56DFF468572577A77D36BDF0ABAB727DB6D6D99702AAB346E35EF14001829B2F172992C2C0D5D848BB23008E150635BF47BA1430629CBF44FF58A4AB497CCA7AA7B19E91201BF444AD2A3606FB4560787B72655BB14A12B715914DF594531FAF3BCE50B226F18092E43C97C4DFDBA3A65D38460D266140F50
answer = BA0D89B543FE8B3BA64AAA94F02039D55E62388CAA919A9837CA9A0B67B51BBAC67DFE8503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000409336942FA3C97C6AD3323142F46D5064103C031CD502034B9FBC5E94293E297862C8B97083A683BD4768EFA2C1AE46EC4299D1A7CCB107B1BBA8FA70896F12D955DD386A6ED21944A356FF1363E225B62B532997B0038F09F3530E61AD47EABB797DE592C7237F682CE1EBF1CF5F91290377D53F963C9DB8283B1C60DA21B2479478A26EF2E32EA084421B8CA88878ED6A8F56DFF468572577A77D36BDF0ABAB727DB6D6D99702AAB346E35EF14001829B2F172992C2C0D5D848BB23008E150635BF47BA1430629CBF44FF58A4AB497CCA7AA7B19E91201BF444AD2A3606FB4560787B72655BB14A12B715914DF594531FAF3BCE50B226F18092E43C97C4DFDBA3A65D38460D266140F50</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 43 FE 8B 3B A6 4A AA 94 F0 20 39 D5
0010 | 5E 62 38 8C AA 91 9A 98 37 CA 9A 0B 67 B5 1B BA
0020 | C6 7D FE 85 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 04 09 33 69 42 FA 3C 97 C6 AD 33 23 14 2F 46 D5
0140 | 06 41 03 C0 31 CD 50 20 34 B9 FB C5 E9 42 93 E2
0150 | 97 86 2C 8B 97 08 3A 68 3B D4 76 8E FA 2C 1A E4
0160 | 6E C4 29 9D 1A 7C CB 10 7B 1B BA 8F A7 08 96 F1
0170 | 2D 95 5D D3 86 A6 ED 21 94 4A 35 6F F1 36 3E 22
0180 | 5B 62 B5 32 99 7B 00 38 F0 9F 35 30 E6 1A D4 7E
0190 | AB B7 97 DE 59 2C 72 37 F6 82 CE 1E BF 1C F5 F9
01A0 | 12 90 37 7D 53 F9 63 C9 DB 82 83 B1 C6 0D A2 1B
01B0 | 24 79 47 8A 26 EF 2E 32 EA 08 44 21 B8 CA 88 87
01C0 | 8E D6 A8 F5 6D FF 46 85 72 57 7A 77 D3 6B DF 0A
01D0 | BA B7 27 DB 6D 6D 99 70 2A AB 34 6E 35 EF 14 00
01E0 | 18 29 B2 F1 72 99 2C 2C 0D 5D 84 8B B2 30 08 E1
01F0 | 50 63 5B F4 7B A1 43 06 29 CB F4 4F F5 8A 4A B4
0200 | 97 CC A7 AA 7B 19 E9 12 01 BF 44 4A D2 A3 60 6F
0210 | B4 56 07 87 B7 26 55 BB 14 A1 2B 71 59 14 DF 59
0220 | 45 31 FA F3 BC E5 0B 22 6F 18 09 2E 43 C9 7C 4D
0230 | FD BA 3A 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001000409336942FA3C97C6AD3323</code> <code>142F46D5064103C031CD502034B9FBC5</code> <code>E94293E297862C8B97083A683BD4768E</code> <code>FA2C1AE46EC4299D1A7CCB107B1BBA8F</code> <code>A70896F12D955DD386A6ED21944A356F</code> <code>F1363E225B62B532997B0038F09F3530</code> <code>E61AD47EABB797DE592C7237F682CE1E</code> <code>BF1CF5F91290377D53F963C9DB8283B1</code> <code>C60DA21B2479478A26EF2E32EA084421</code> <code>B8CA88878ED6A8F56DFF468572577A77</code> <code>D36BDF0ABAB727DB6D6D99702AAB346E</code> <code>35EF14001829B2F172992C2C0D5D848B</code> <code>B23008E150635BF47BA1430629CBF44F</code> <code>F58A4AB497CCA7AA7B19E91201BF444A</code> <code>D2A3606FB4560787B72655BB14A12B71</code> <code>5914DF594531FAF3BCE50B226F18092E</code><br> <code>43C97C4D</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>FDBA3A65</code> (1698347773 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 37D557FE060941797BBA0A5A6759F2D6670F0C2AB97B48E5DAD4789FCCC0E6494793122EC0A092CFF8DA51B38C1ACD1BEDCE504C7D2720C269B2AB02FD2E7635DE76F5F2FA5B0932BB9B10A637E934EAB7F21CA21FA558110AD1275F96CBE4515F4E867F81FCD975EAA3B54A880BC4DBC43030066E0F451DE80DC71D7A5FFF0C1F17743E4F146F4A78E7B3E164E723CF0A31F51840C709C66ABAF1182F608800E571C07F9C7F79DB14863B6DAE3AC132B8DB265616EAA26109D310909837F7E06E079C0613966FE778496D05627F51CAB596087434622F9EBDED108C930399995CB2E1BBECEB307C3B0DA2A661357B52B2421F0151C89E356BCD38BB0AE798B2</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 914976B4519BE9B9509B28A435B5207706180582161A2E83A7A5E22AFD79D77E5B102B1121B8BD75C781045821A67D69966386A30A3D5B3FF614C925C238AE1AFAD611CC47E116147523E059FC4D17CBFB5E4760F6C7EC3BD0E399A91919E2D6478047A4E5270CF3D121A2EF397CA3DE99271C07D1DA27837C2B2399CC5B49FE69406EA1D1722DAA4154D09C4232DE03DE99091A67FECD4692E9C92B631B4ED2A45092D56C24B0943521A3FEE23F067C52C2B857E3A48D4F39DC8960B0392E567403405A9BC686C703255CA229BCCD3CF00242DE58558014EAE5C7B6BEAEC2BE4F960B86AFFE4A7929F6111186E1B132B8C9663AE0569329F61FC73532C886FA</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 43 FE 8B 3B A6 4A AA 94 F0 20 39 D5
0010 | 5E 62 38 8C AA 91 9A 98 37 CA 9A 0B 67 B5 1B BA
0020 | C6 7D FE 85 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 91 49 76 B4 51 9B E9 B9 50 9B 28 A4 35 B5 20 77
0040 | 06 18 05 82 16 1A 2E 83 A7 A5 E2 2A FD 79 D7 7E
0050 | 5B 10 2B 11 21 B8 BD 75 C7 81 04 58 21 A6 7D 69
0060 | 96 63 86 A3 0A 3D 5B 3F F6 14 C9 25 C2 38 AE 1A
0070 | FA D6 11 CC 47 E1 16 14 75 23 E0 59 FC 4D 17 CB
0080 | FB 5E 47 60 F6 C7 EC 3B D0 E3 99 A9 19 19 E2 D6
0090 | 47 80 47 A4 E5 27 0C F3 D1 21 A2 EF 39 7C A3 DE
00A0 | 99 27 1C 07 D1 DA 27 83 7C 2B 23 99 CC 5B 49 FE
00B0 | 69 40 6E A1 D1 72 2D AA 41 54 D0 9C 42 32 DE 03
00C0 | DE 99 09 1A 67 FE CD 46 92 E9 C9 2B 63 1B 4E D2
00D0 | A4 50 92 D5 6C 24 B0 94 35 21 A3 FE E2 3F 06 7C
00E0 | 52 C2 B8 57 E3 A4 8D 4F 39 DC 89 60 B0 39 2E 56
00F0 | 74 03 40 5A 9B C6 86 C7 03 25 5C A2 29 BC CD 3C
0100 | F0 02 42 DE 58 55 80 14 EA E5 C7 B6 BE AE C2 BE
0110 | 4F 96 0B 86 AF FE 4A 79 29 F6 11 11 86 E1 B1 32
0120 | B8 C9 66 3A E0 56 93 29 F6 1F C7 35 32 C8 86 FA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100914976B4519BE9B9509B28A4</code> <code>35B5207706180582161A2E83A7A5E22A</code> <code>FD79D77E5B102B1121B8BD75C7810458</code> <code>21A67D69966386A30A3D5B3FF614C925</code> <code>C238AE1AFAD611CC47E116147523E059</code> <code>FC4D17CBFB5E4760F6C7EC3BD0E399A9</code> <code>1919E2D6478047A4E5270CF3D121A2EF</code> <code>397CA3DE99271C07D1DA27837C2B2399</code> <code>CC5B49FE69406EA1D1722DAA4154D09C</code> <code>4232DE03DE99091A67FECD4692E9C92B</code> <code>631B4ED2A45092D56C24B0943521A3FE</code> <code>E23F067C52C2B857E3A48D4F39DC8960</code> <code>B0392E567403405A9BC686C703255CA2</code> <code>29BCCD3CF00242DE58558014EAE5C7B6</code> <code>BEAEC2BE4F960B86AFFE4A7929F61111</code> <code>86E1B132B8C9663AE0569329F61FC735</code><br> <code>32C886FA</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436643FE8B3BA64AAA94F02039D55E62388CAA919A9837CA9A0B67B51BBAC67DFE850000000000000000FE000100914976B4519BE9B9509B28A435B5207706180582161A2E83A7A5E22AFD79D77E5B102B1121B8BD75C781045821A67D69966386A30A3D5B3FF614C925C238AE1AFAD611CC47E116147523E059FC4D17CBFB5E4760F6C7EC3BD0E399A91919E2D6478047A4E5270CF3D121A2EF397CA3DE99271C07D1DA27837C2B2399CC5B49FE69406EA1D1722DAA4154D09C4232DE03DE99091A67FECD4692E9C92B631B4ED2A45092D56C24B0943521A3FEE23F067C52C2B857E3A48D4F39DC8960B0392E567403405A9BC686C703255CA229BCCD3CF00242DE58558014EAE5C7B6BEAEC2BE4F960B86AFFE4A7929F6111186E1B132B8C9663AE0569329F61FC73532C886FA
padding = B93E0CD9CB863CBE8554B885
tmp_aes_key = 3653556166227FF7E7BD25321B0AE7875E74D441E9E43BA3DF41EECD120219BE
tmp_aes_iv = 65DEAC819763A72F155B15D022F049A8AC61F69E6F04E8764738496E9AD1C2F1</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = FFD817C837DF7E095D069EB0F61720391C9248546CF06942A0211F7C845798E2583182FB568AFEA3CA203BEC61A757FFBC40896F3A8E3E810477B41A3AA06D237AEB105D7AAF4049207F4F4B22EB68F8309D4877184A5B8B42566D4BD90B903EE70CE66102CD4F401D9ED38EDC960B6BFD9D8D55DDBBBC47069D6335960BE2EB16E4589DA47CE416D6066F9695EA648CF0F02793744C6ECC62C456DCBA21D721A7032F0372037509FDA1AB09927117037FCCE57E54F0543F5A5E395A2F432C7A34F17A2A38EAAD93574231DF204ECCCA7FD4CF5BA7CD28369F9DDDD936F9965B1F1D1CDEF538B4C7F2574C7E4F65F8F724B538145E45D93298FBA4461A148345006CBDB1E10EFBE528F7BE1371E7E074BD088284E3F0B4B84D8CEDF34419DC78F4B7805A55237E3E19D1C625BC61B0D527F92522D0ADD6EE8DDDB2F0840F769AA7BA506BBC992050CD3AF548124BE604</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 30 E7 06 00 01 BB 3A 65
0010 | 78 01 00 00 1F 5F 04 F5 43 FE 8B 3B A6 4A AA 94
0020 | F0 20 39 D5 5E 62 38 8C AA 91 9A 98 37 CA 9A 0B
0030 | 67 B5 1B BA C6 7D FE 85 FE 50 01 00 FF D8 17 C8
0040 | 37 DF 7E 09 5D 06 9E B0 F6 17 20 39 1C 92 48 54
0050 | 6C F0 69 42 A0 21 1F 7C 84 57 98 E2 58 31 82 FB
0060 | 56 8A FE A3 CA 20 3B EC 61 A7 57 FF BC 40 89 6F
0070 | 3A 8E 3E 81 04 77 B4 1A 3A A0 6D 23 7A EB 10 5D
0080 | 7A AF 40 49 20 7F 4F 4B 22 EB 68 F8 30 9D 48 77
0090 | 18 4A 5B 8B 42 56 6D 4B D9 0B 90 3E E7 0C E6 61
00A0 | 02 CD 4F 40 1D 9E D3 8E DC 96 0B 6B FD 9D 8D 55
00B0 | DD BB BC 47 06 9D 63 35 96 0B E2 EB 16 E4 58 9D
00C0 | A4 7C E4 16 D6 06 6F 96 95 EA 64 8C F0 F0 27 93
00D0 | 74 4C 6E CC 62 C4 56 DC BA 21 D7 21 A7 03 2F 03
00E0 | 72 03 75 09 FD A1 AB 09 92 71 17 03 7F CC E5 7E
00F0 | 54 F0 54 3F 5A 5E 39 5A 2F 43 2C 7A 34 F1 7A 2A
0100 | 38 EA AD 93 57 42 31 DF 20 4E CC CA 7F D4 CF 5B
0110 | A7 CD 28 36 9F 9D DD D9 36 F9 96 5B 1F 1D 1C DE
0120 | F5 38 B4 C7 F2 57 4C 7E 4F 65 F8 F7 24 B5 38 14
0130 | 5E 45 D9 32 98 FB A4 46 1A 14 83 45 00 6C BD B1
0140 | E1 0E FB E5 28 F7 BE 13 71 E7 E0 74 BD 08 82 84
0150 | E3 F0 B4 B8 4D 8C ED F3 44 19 DC 78 F4 B7 80 5A
0160 | 55 23 7E 3E 19 D1 C6 25 BC 61 B0 D5 27 F9 25 22
0170 | D0 AD D6 EE 8D DD B2 F0 84 0F 76 9A A7 BA 50 6B
0180 | BC 99 20 50 CD 3A F5 48 12 4B E6 04</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>30E7060001BB3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100FFD817C837DF7E095D069EB0</code> <code>F61720391C9248546CF06942A0211F7C</code> <code>845798E2583182FB568AFEA3CA203BEC</code> <code>61A757FFBC40896F3A8E3E810477B41A</code> <code>3AA06D237AEB105D7AAF4049207F4F4B</code> <code>22EB68F8309D4877184A5B8B42566D4B</code> <code>D90B903EE70CE66102CD4F401D9ED38E</code> <code>DC960B6BFD9D8D55DDBBBC47069D6335</code> <code>960BE2EB16E4589DA47CE416D6066F96</code> <code>95EA648CF0F02793744C6ECC62C456DC</code> <code>BA21D721A7032F0372037509FDA1AB09</code> <code>927117037FCCE57E54F0543F5A5E395A</code> <code>2F432C7A34F17A2A38EAAD93574231DF</code> <code>204ECCCA7FD4CF5BA7CD28369F9DDDD9</code> <code>36F9965B1F1D1CDEF538B4C7F2574C7E</code> <code>4F65F8F724B538145E45D93298FBA446</code> <code>1A148345006CBDB1E10EFBE528F7BE13</code> <code>71E7E074BD088284E3F0B4B84D8CEDF3</code> <code>4419DC78F4B7805A55237E3E19D1C625</code> <code>BC61B0D527F92522D0ADD6EE8DDDB2F0</code> <code>840F769AA7BA506BBC992050CD3AF548</code><br> <code>124BE604</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = C16FF603A488B8B9703763755643508071955FAD470B9B870456635CB789FFC3F5052CDBC0C538DDCD59527143C54A64DE9DA6C58CED3344E222DB84535A63B1F147457704F9B810C3946E71A507BE0ED95CB81ABF33043CD48EB988C308B85DDE70FE4667781B302EC74DF31DCDB7FCB2B530A39B86FE49786C356CED4FCB27A039C5F0CF9D14B0499F172BCDFBAA265A122B4C476218A2085F45E1762AF023F49E59F8FA6F5B6B0AB235C4FC1D6D6E10E3903BD3CB6D6F5EF9DBD0131F6022CF9AA5E9E58A63506E334F8D21CAB678C802412D564AD699C82893911CFB021950CFD6734478A445D268FC8DCFBF95068E064BAF0B5F7E495EB88B5DBC80808F</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 90 E8 40 FE BA 3A 65
0010 | 90 00 00 00 34 F7 CB 3B 43 FE 8B 3B A6 4A AA 94
0020 | F0 20 39 D5 5E 62 38 8C AA 91 9A 98 37 CA 9A 0B
0030 | 67 B5 1B BA C6 7D FE 85 99 8D 45 B9 A5 F7 7F D5
0040 | D4 3E 1B 7A BA 8C 47 29</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0190E840FEBA3A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90000000</code> (144 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>43FE8B3BA64AAA94F02039D55E62388C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AA919A9837CA9A0B67B51BBAC67DFE85</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>998D45B9A5F77FD5D43E1B7ABA8C4729</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

