<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 98 3F 04 00 A3 F9 70 65
0010 | 14 00 00 00 F1 8E 7E BE 33 5E 99 59 32 B9 7A B0
0020 | F4 99 8B 49 79 A9 8A B8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>983F0400A3F97065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 69 C6 A3 F9 70 65
0010 | 94 00 00 00 63 24 16 05 33 5E 99 59 32 B9 7A B0
0020 | F4 99 8B 49 79 A9 8A B8 1D 2A 19 43 39 EB D2 05
0030 | 03 B5 CB 18 9E DE 22 74 08 16 08 6A F8 56 4E 3E
0040 | 97 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B469C6A3F97065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>94000000</code> (148 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0816086AF8564E3E97000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1587636483480501911</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1587636483480501911</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1587636483480501911 = 1073677151 * 1478690761</code></p>
<pre><code>p = 1073677151
q = 1478690761</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 08 6A F8 56 4E 3E 97 00 00 00
0010 | 04 3F FF 03 5F 00 00 00 04 58 23 07 C9 00 00 00
0020 | 33 5E 99 59 32 B9 7A B0 F4 99 8B 49 79 A9 8A B8
0030 | 1D 2A 19 43 39 EB D2 05 03 B5 CB 18 9E DE 22 74
0040 | 16 88 B5 70 21 F1 B7 54 78 B1 AF 42 01 EF 0C 39
0050 | B3 A0 08 7D BF DB 4E E9 E8 B3 64 43 6F 91 E0 19
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0816086AF8564E3E97000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1587636483480501911</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043FFF035F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1073677151</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04582307C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1478690761</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>1688B57021F1B75478B1AF4201EF0C39</code> <code>B3A0087DBFDB4EE9E8B364436F91E019</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90816086AF8564E3E97000000043FFF035F00000004582307C9000000335E995932B97AB0F4998B4979A98AB81D2A194339EBD20503B5CB189EDE22741688B57021F1B75478B1AF4201EF0C39B3A0087DBFDB4EE9E8B364436F91E01902000000
random_padding_bytes = 03C3525F2E8094596546A1360C6AB351EEACC6530CB815E42FCAFB26E832F1F80339BCA128975C48984B2FAF137E4F0E1AD265155E78E2886FDD0FDBB5E96E2A6314725020837EBF1CDE644D45513BE477569CBA041DE7779AD5B536</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 2729BF829FFFB5D06241439874A5AE5CE5F7F6E22DBD98E60566E2AEA4B43793BAF98CD5A35FAF3C9EF5BD9D9B2DFF7BD3B58C08EE9D6F382260822C2B45C918E03B51A855FD16F29B81476B56F36507EE92DFF1603BAFA739A8109F5C0244471BAFD3F62DA29804E346A031DC0BEAC6D66300677CCF6ECD76D26B42A3029B079BA94693E16A04EB9CA7507A0423CA26DB77212970D41B76904935E79AC7458A7BC8F0262ED81292BAA715C69A86F255EA22EE777E243866E5D61BE5921DA6369EF6417450829278AA020E5B1D2182B5BFB9A1E9ED8F526109FCAE381B684AD0936371E09088FBF399AF804FC7A45191EFCE78EE75F8B615F6A60D53D1D15275</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 9C 3F 04 00 A3 F9 70 65
0010 | 40 01 00 00 BE E4 12 D7 33 5E 99 59 32 B9 7A B0
0020 | F4 99 8B 49 79 A9 8A B8 1D 2A 19 43 39 EB D2 05
0030 | 03 B5 CB 18 9E DE 22 74 04 3F FF 03 5F 00 00 00
0040 | 04 58 23 07 C9 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 27 29 BF 82 9F FF B5 D0 62 41 43 98
0060 | 74 A5 AE 5C E5 F7 F6 E2 2D BD 98 E6 05 66 E2 AE
0070 | A4 B4 37 93 BA F9 8C D5 A3 5F AF 3C 9E F5 BD 9D
0080 | 9B 2D FF 7B D3 B5 8C 08 EE 9D 6F 38 22 60 82 2C
0090 | 2B 45 C9 18 E0 3B 51 A8 55 FD 16 F2 9B 81 47 6B
00A0 | 56 F3 65 07 EE 92 DF F1 60 3B AF A7 39 A8 10 9F
00B0 | 5C 02 44 47 1B AF D3 F6 2D A2 98 04 E3 46 A0 31
00C0 | DC 0B EA C6 D6 63 00 67 7C CF 6E CD 76 D2 6B 42
00D0 | A3 02 9B 07 9B A9 46 93 E1 6A 04 EB 9C A7 50 7A
00E0 | 04 23 CA 26 DB 77 21 29 70 D4 1B 76 90 49 35 E7
00F0 | 9A C7 45 8A 7B C8 F0 26 2E D8 12 92 BA A7 15 C6
0100 | 9A 86 F2 55 EA 22 EE 77 7E 24 38 66 E5 D6 1B E5
0110 | 92 1D A6 36 9E F6 41 74 50 82 92 78 AA 02 0E 5B
0120 | 1D 21 82 B5 BF B9 A1 E9 ED 8F 52 61 09 FC AE 38
0130 | 1B 68 4A D0 93 63 71 E0 90 88 FB F3 99 AF 80 4F
0140 | C7 A4 51 91 EF CE 78 EE 75 F8 B6 15 F6 A6 0D 53
0150 | D1 D1 52 75</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>9C3F0400A3F97065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043FFF035F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1073677151</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04582307C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1478690761</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001002729BF829FFFB5D062414398</code> <code>74A5AE5CE5F7F6E22DBD98E60566E2AE</code> <code>A4B43793BAF98CD5A35FAF3C9EF5BD9D</code> <code>9B2DFF7BD3B58C08EE9D6F382260822C</code> <code>2B45C918E03B51A855FD16F29B81476B</code> <code>56F36507EE92DFF1603BAFA739A8109F</code> <code>5C0244471BAFD3F62DA29804E346A031</code> <code>DC0BEAC6D66300677CCF6ECD76D26B42</code> <code>A3029B079BA94693E16A04EB9CA7507A</code> <code>0423CA26DB77212970D41B76904935E7</code> <code>9AC7458A7BC8F0262ED81292BAA715C6</code> <code>9A86F255EA22EE777E243866E5D61BE5</code> <code>921DA6369EF6417450829278AA020E5B</code> <code>1D2182B5BFB9A1E9ED8F526109FCAE38</code> <code>1B684AD0936371E09088FBF399AF804F</code> <code>C7A45191EFCE78EE75F8B615F6A60D53</code><br> <code>D1D15275</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 74 0C 57 A4 F9 70 65
0010 | C8 02 00 00 5C 07 E8 D0 33 5E 99 59 32 B9 7A B0
0020 | F4 99 8B 49 79 A9 8A B8 1D 2A 19 43 39 EB D2 05
0030 | 03 B5 CB 18 9E DE 22 74 FE 50 02 00 4B A8 5D EB
0040 | AA D7 29 5D 89 25 71 4C FD A1 C2 6B F6 96 07 54
0050 | A4 CF AB 54 B5 25 C4 ED 4C 61 85 67 E5 47 47 2D
0060 | 60 B6 F2 E7 91 62 42 A3 E6 B6 83 A2 A9 FF EB A0
0070 | 61 00 F5 B3 C2 A8 FE 0B EF A3 E4 CF 63 F3 7D 91
0080 | 1F 80 F1 FF 95 CD 1D 2D 0A 1A EF B4 F2 69 97 B0
0090 | 92 80 C9 54 01 A6 AE 10 35 16 76 32 06 12 22 8B
00A0 | 03 62 03 E0 64 4A BA 17 87 40 96 ED 5A 6A 0D DB
00B0 | AA 42 0A C6 D0 D4 43 16 B7 9A 8A D4 A0 F3 AD 8F
00C0 | E5 8A 8D 39 B1 3A 91 E5 A4 22 BC 1D F1 06 D7 AF
00D0 | D6 A4 58 0A 26 46 3F 79 33 3D A8 24 79 87 79 03
00E0 | 63 31 11 81 03 AB AC CB 76 8D A5 1C AF FA B7 AD
00F0 | 96 6E 79 FA C3 95 F1 6F A2 C7 5F A5 57 75 E7 8F
0100 | CF 2C 37 C8 1A 5A 6D D7 6B 27 91 80 38 F7 F9 6A
0110 | 38 20 C9 51 78 59 6F 95 86 D5 00 43 EC 98 CE 01
0120 | F7 7F E2 8D 7F 58 70 16 A9 51 E6 33 C9 2D 3F FE
0130 | D7 61 EE A2 68 F2 40 88 F7 E9 43 48 09 D0 4D 58
0140 | 64 7D 5A AA B1 DB 10 F1 B7 0E 06 9D 9F DB 1F DB
0150 | 1B 4A 99 3F CA 5E 40 C3 E4 68 28 9C 63 F4 7E 75
0160 | 7C 30 63 52 12 7B D7 56 EF E0 F5 C0 6C DC 5B 0E
0170 | C0 C4 BD 1A B7 13 E5 FA B4 3B 0A EA 24 8F 0F DB
0180 | 5F 79 D9 90 A4 37 32 DE 0B 13 A9 7B 4D C1 D5 B7
0190 | EF 82 82 F0 32 D0 1D 03 FD B1 41 41 FF E4 E5 54
01A0 | 5E EA 5C 26 CF D3 23 4A BC C0 7D 0A F3 18 76 90
01B0 | D9 B1 E7 8D 7F E0 E2 75 CF 64 EB 43 6D E7 E6 7C
01C0 | EE C5 63 BD 9B 1B 60 4E CD AE 34 60 EC 34 DD A2
01D0 | 4F 15 BE 19 11 BA 47 58 17 31 39 68 FA 9F D7 3D
01E0 | 4A A6 C0 E1 50 4C 77 6A 84 99 7A 64 85 D7 55 4F
01F0 | 90 3C CB 73 B6 12 2A 5D 22 82 72 8D 75 7E 3B B1
0200 | B1 34 2C AF EC B6 F2 AF B3 3A F6 C2 D8 49 D6 91
0210 | F9 2F 9E 06 F1 F0 1F A2 A4 6D 52 A6 AA 96 F4 E3
0220 | 7B 1E DF EB 5B CE C6 E6 3B 5B 0C 34 BE 19 1A AF
0230 | 20 57 08 AD 29 55 28 E5 22 AD D2 39 2B 8E 98 66
0240 | 34 19 A3 87 1E 0A F5 72 98 46 5A 19 33 14 EC D8
0250 | 87 02 7B 37 91 2C 7D 9D 72 4A A1 9B AF 6D 56 CB
0260 | 66 1C 51 47 D1 A8 B0 73 0A DE 8F B9 AA C8 18 D2
0270 | 4B E8 C8 34 D2 1F 47 7F 46 04 56 A3 EE 3C F3 EA
0280 | FC 5E 58 E9 E2 23 95 19 58 70 41 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01740C57A4F97065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C8020000</code> (712 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002004BA85DEBAAD7295D8925714C</code> <code>FDA1C26BF6960754A4CFAB54B525C4ED</code> <code>4C618567E547472D60B6F2E7916242A3</code> <code>E6B683A2A9FFEBA06100F5B3C2A8FE0B</code> <code>EFA3E4CF63F37D911F80F1FF95CD1D2D</code> <code>0A1AEFB4F26997B09280C95401A6AE10</code> <code>351676320612228B036203E0644ABA17</code> <code>874096ED5A6A0DDBAA420AC6D0D44316</code> <code>B79A8AD4A0F3AD8FE58A8D39B13A91E5</code> <code>A422BC1DF106D7AFD6A4580A26463F79</code> <code>333DA824798779036331118103ABACCB</code> <code>768DA51CAFFAB7AD966E79FAC395F16F</code> <code>A2C75FA55775E78FCF2C37C81A5A6DD7</code> <code>6B27918038F7F96A3820C95178596F95</code> <code>86D50043EC98CE01F77FE28D7F587016</code> <code>A951E633C92D3FFED761EEA268F24088</code> <code>F7E9434809D04D58647D5AAAB1DB10F1</code> <code>B70E069D9FDB1FDB1B4A993FCA5E40C3</code> <code>E468289C63F47E757C306352127BD756</code> <code>EFE0F5C06CDC5B0EC0C4BD1AB713E5FA</code> <code>B43B0AEA248F0FDB5F79D990A43732DE</code> <code>0B13A97B4DC1D5B7EF8282F032D01D03</code> <code>FDB14141FFE4E5545EEA5C26CFD3234A</code> <code>BCC07D0AF3187690D9B1E78D7FE0E275</code> <code>CF64EB436DE7E67CEEC563BD9B1B604E</code> <code>CDAE3460EC34DDA24F15BE1911BA4758</code> <code>17313968FA9FD73D4AA6C0E1504C776A</code> <code>84997A6485D7554F903CCB73B6122A5D</code> <code>2282728D757E3BB1B1342CAFECB6F2AF</code> <code>B33AF6C2D849D691F92F9E06F1F01FA2</code> <code>A46D52A6AA96F4E37B1EDFEB5BCEC6E6</code> <code>3B5B0C34BE191AAF205708AD295528E5</code> <code>22ADD2392B8E98663419A3871E0AF572</code> <code>98465A193314ECD887027B37912C7D9D</code> <code>724AA19BAF6D56CB661C5147D1A8B073</code> <code>0ADE8FB9AAC818D24BE8C834D21F477F</code> <code>460456A3EE3CF3EAFC5E58E9E2239519</code><br> <code>58704168</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 4BA85DEBAAD7295D8925714CFDA1C26BF6960754A4CFAB54B525C4ED4C618567E547472D60B6F2E7916242A3E6B683A2A9FFEBA06100F5B3C2A8FE0BEFA3E4CF63F37D911F80F1FF95CD1D2D0A1AEFB4F26997B09280C95401A6AE10351676320612228B036203E0644ABA17874096ED5A6A0DDBAA420AC6D0D44316B79A8AD4A0F3AD8FE58A8D39B13A91E5A422BC1DF106D7AFD6A4580A26463F79333DA824798779036331118103ABACCB768DA51CAFFAB7AD966E79FAC395F16FA2C75FA55775E78FCF2C37C81A5A6DD76B27918038F7F96A3820C95178596F9586D50043EC98CE01F77FE28D7F587016A951E633C92D3FFED761EEA268F24088F7E9434809D04D58647D5AAAB1DB10F1B70E069D9FDB1FDB1B4A993FCA5E40C3E468289C63F47E757C306352127BD756EFE0F5C06CDC5B0EC0C4BD1AB713E5FAB43B0AEA248F0FDB5F79D990A43732DE0B13A97B4DC1D5B7EF8282F032D01D03FDB14141FFE4E5545EEA5C26CFD3234ABCC07D0AF3187690D9B1E78D7FE0E275CF64EB436DE7E67CEEC563BD9B1B604ECDAE3460EC34DDA24F15BE1911BA475817313968FA9FD73D4AA6C0E1504C776A84997A6485D7554F903CCB73B6122A5D2282728D757E3BB1B1342CAFECB6F2AFB33AF6C2D849D691F92F9E06F1F01FA2A46D52A6AA96F4E37B1EDFEB5BCEC6E63B5B0C34BE191AAF205708AD295528E522ADD2392B8E98663419A3871E0AF57298465A193314ECD887027B37912C7D9D724AA19BAF6D56CB661C5147D1A8B0730ADE8FB9AAC818D24BE8C834D21F477F460456A3EE3CF3EAFC5E58E9E223951958704168
tmp_aes_key = 9A4E3B9FFC93395AEF3A1A3D980C65B346AD55239764095BCE4CE82EF7D7B188
tmp_aes_iv = 080199AE9E1B3CB91C6AECDD853F64F0A82A203CC088FA0F2D8F19D71688B570</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 4F41A8F58B280F61F9863375C4A4600B8026DA08BA0D89B5335E995932B97AB0F4998B4979A98AB81D2A194339EBD20503B5CB189EDE227403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010061DEE10F675855ACEFA2B2CA3A0D3354652CB75AD6A4D7CF83F8C62E667ACCA6F039DBA4E8B692A7441CC327A6E7ECF65ECE1F383DE9AB38A7439AE73EC90B02A824F1D64C9FA19C057875AF619621147B5B05A0DB1B0B27A74070C45E30042D2AA455DFA899DFA163C5E0F42F90C94F5BD2E4F689D42EBD1ABF7AB843DEBA27C14060ABCAF569D5B517444B900B1428C8986E46F4985C30C50CEC973F6C2A91AE8EE830E9F4931E84D237872700E547A2424BFDFA35D897ACDD78B6B137A5FCE31FD5A3228575204798E40CD545D309EB82222F3C9EA9568ABF70A5209CF379AC9B1669D6708938A47161F1FE51C48014183D2354953CC6897175B60AC1F191A4F97065B17BBA6E0D1ADED0
answer = BA0D89B5335E995932B97AB0F4998B4979A98AB81D2A194339EBD20503B5CB189EDE227403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010061DEE10F675855ACEFA2B2CA3A0D3354652CB75AD6A4D7CF83F8C62E667ACCA6F039DBA4E8B692A7441CC327A6E7ECF65ECE1F383DE9AB38A7439AE73EC90B02A824F1D64C9FA19C057875AF619621147B5B05A0DB1B0B27A74070C45E30042D2AA455DFA899DFA163C5E0F42F90C94F5BD2E4F689D42EBD1ABF7AB843DEBA27C14060ABCAF569D5B517444B900B1428C8986E46F4985C30C50CEC973F6C2A91AE8EE830E9F4931E84D237872700E547A2424BFDFA35D897ACDD78B6B137A5FCE31FD5A3228575204798E40CD545D309EB82222F3C9EA9568ABF70A5209CF379AC9B1669D6708938A47161F1FE51C48014183D2354953CC6897175B60AC1F191A4F97065B17BBA6E0D1ADED0</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 33 5E 99 59 32 B9 7A B0 F4 99 8B 49
0010 | 79 A9 8A B8 1D 2A 19 43 39 EB D2 05 03 B5 CB 18
0020 | 9E DE 22 74 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 61 DE E1 0F 67 58 55 AC EF A2 B2 CA 3A 0D 33 54
0140 | 65 2C B7 5A D6 A4 D7 CF 83 F8 C6 2E 66 7A CC A6
0150 | F0 39 DB A4 E8 B6 92 A7 44 1C C3 27 A6 E7 EC F6
0160 | 5E CE 1F 38 3D E9 AB 38 A7 43 9A E7 3E C9 0B 02
0170 | A8 24 F1 D6 4C 9F A1 9C 05 78 75 AF 61 96 21 14
0180 | 7B 5B 05 A0 DB 1B 0B 27 A7 40 70 C4 5E 30 04 2D
0190 | 2A A4 55 DF A8 99 DF A1 63 C5 E0 F4 2F 90 C9 4F
01A0 | 5B D2 E4 F6 89 D4 2E BD 1A BF 7A B8 43 DE BA 27
01B0 | C1 40 60 AB CA F5 69 D5 B5 17 44 4B 90 0B 14 28
01C0 | C8 98 6E 46 F4 98 5C 30 C5 0C EC 97 3F 6C 2A 91
01D0 | AE 8E E8 30 E9 F4 93 1E 84 D2 37 87 27 00 E5 47
01E0 | A2 42 4B FD FA 35 D8 97 AC DD 78 B6 B1 37 A5 FC
01F0 | E3 1F D5 A3 22 85 75 20 47 98 E4 0C D5 45 D3 09
0200 | EB 82 22 2F 3C 9E A9 56 8A BF 70 A5 20 9C F3 79
0210 | AC 9B 16 69 D6 70 89 38 A4 71 61 F1 FE 51 C4 80
0220 | 14 18 3D 23 54 95 3C C6 89 71 75 B6 0A C1 F1 91
0230 | A4 F9 70 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010061DEE10F675855ACEFA2B2CA</code> <code>3A0D3354652CB75AD6A4D7CF83F8C62E</code> <code>667ACCA6F039DBA4E8B692A7441CC327</code> <code>A6E7ECF65ECE1F383DE9AB38A7439AE7</code> <code>3EC90B02A824F1D64C9FA19C057875AF</code> <code>619621147B5B05A0DB1B0B27A74070C4</code> <code>5E30042D2AA455DFA899DFA163C5E0F4</code> <code>2F90C94F5BD2E4F689D42EBD1ABF7AB8</code> <code>43DEBA27C14060ABCAF569D5B517444B</code> <code>900B1428C8986E46F4985C30C50CEC97</code> <code>3F6C2A91AE8EE830E9F4931E84D23787</code> <code>2700E547A2424BFDFA35D897ACDD78B6</code> <code>B137A5FCE31FD5A3228575204798E40C</code> <code>D545D309EB82222F3C9EA9568ABF70A5</code> <code>209CF379AC9B1669D6708938A47161F1</code> <code>FE51C48014183D2354953CC6897175B6</code><br> <code>0AC1F191</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>A4F97065</code> (1701902756 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 63CC5ECAEEEBD95B30776FD9AA8B616AD00CF1C6A68EB385433B30B9A15127F9402790A5F9E682AEB58F93D025B2F68989336B717B6EF35F648ABC8AC9D74491F287E05F0E598B2F37903063EE8982FD504F1C55E8852ECF511D80A5DB28E355A37490520AF3D941B790F6F29B4CF38EAE7D34B3CC87261C89706DF7D12758CD85E08DBFF2E2092319F53D37B623EB67941D00C743C46B4D61EAED4C1278A5F6F996B2C05F680D19DC37219C72EDCCFD29FA98E28B3D56B8C8EC6E6AC54B870BAE93923B2D9044690D3CA0B01CB75A9533484676677EDA1DB1E27DEC6AB00F8623B3FFDF8A592EFB4D83B032BD98B12278A9969CA7BAF766E190858CC480C24F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 8D8BCF4B7E8CACB39C31454E2924A64BFD988D4A156175EBB0279F44E3D1FC9A142E635DCE46B2F10063EEB2AEC4BE6C041F0435D672AE4E72D9E73C87DF37245BE30C3008AEA1306062C60CF5299AFD9A06C9E03EA758CD2E627D65499E4D5F44A3D81AD4222EE77C04B0B4D776F69D2C3B5292C220B4415530B3C5BE6A8837B7F3C324AABBE97952958E2E66D36465AA52A7B47F3A1013387D024DFE924046F2E9AA1BEB1D730FB3F433558ADE52758AC7C307AEE0AA9623570836B922B650E0B1C295EC500007A6B9032D3CDD10B8EE065B2D4A962F518EA46C6897CBA5B36411A61FB826EE6FA48AC9CD4DDF59A9E7BADCEC44BA470C6BAC78354F3CEC0C</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 33 5E 99 59 32 B9 7A B0 F4 99 8B 49
0010 | 79 A9 8A B8 1D 2A 19 43 39 EB D2 05 03 B5 CB 18
0020 | 9E DE 22 74 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 8D 8B CF 4B 7E 8C AC B3 9C 31 45 4E 29 24 A6 4B
0040 | FD 98 8D 4A 15 61 75 EB B0 27 9F 44 E3 D1 FC 9A
0050 | 14 2E 63 5D CE 46 B2 F1 00 63 EE B2 AE C4 BE 6C
0060 | 04 1F 04 35 D6 72 AE 4E 72 D9 E7 3C 87 DF 37 24
0070 | 5B E3 0C 30 08 AE A1 30 60 62 C6 0C F5 29 9A FD
0080 | 9A 06 C9 E0 3E A7 58 CD 2E 62 7D 65 49 9E 4D 5F
0090 | 44 A3 D8 1A D4 22 2E E7 7C 04 B0 B4 D7 76 F6 9D
00A0 | 2C 3B 52 92 C2 20 B4 41 55 30 B3 C5 BE 6A 88 37
00B0 | B7 F3 C3 24 AA BB E9 79 52 95 8E 2E 66 D3 64 65
00C0 | AA 52 A7 B4 7F 3A 10 13 38 7D 02 4D FE 92 40 46
00D0 | F2 E9 AA 1B EB 1D 73 0F B3 F4 33 55 8A DE 52 75
00E0 | 8A C7 C3 07 AE E0 AA 96 23 57 08 36 B9 22 B6 50
00F0 | E0 B1 C2 95 EC 50 00 07 A6 B9 03 2D 3C DD 10 B8
0100 | EE 06 5B 2D 4A 96 2F 51 8E A4 6C 68 97 CB A5 B3
0110 | 64 11 A6 1F B8 26 EE 6F A4 8A C9 CD 4D DF 59 A9
0120 | E7 BA DC EC 44 BA 47 0C 6B AC 78 35 4F 3C EC 0C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001008D8BCF4B7E8CACB39C31454E</code> <code>2924A64BFD988D4A156175EBB0279F44</code> <code>E3D1FC9A142E635DCE46B2F10063EEB2</code> <code>AEC4BE6C041F0435D672AE4E72D9E73C</code> <code>87DF37245BE30C3008AEA1306062C60C</code> <code>F5299AFD9A06C9E03EA758CD2E627D65</code> <code>499E4D5F44A3D81AD4222EE77C04B0B4</code> <code>D776F69D2C3B5292C220B4415530B3C5</code> <code>BE6A8837B7F3C324AABBE97952958E2E</code> <code>66D36465AA52A7B47F3A1013387D024D</code> <code>FE924046F2E9AA1BEB1D730FB3F43355</code> <code>8ADE52758AC7C307AEE0AA9623570836</code> <code>B922B650E0B1C295EC500007A6B9032D</code> <code>3CDD10B8EE065B2D4A962F518EA46C68</code> <code>97CBA5B36411A61FB826EE6FA48AC9CD</code> <code>4DDF59A9E7BADCEC44BA470C6BAC7835</code><br> <code>4F3CEC0C</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366335E995932B97AB0F4998B4979A98AB81D2A194339EBD20503B5CB189EDE22740000000000000000FE0001008D8BCF4B7E8CACB39C31454E2924A64BFD988D4A156175EBB0279F44E3D1FC9A142E635DCE46B2F10063EEB2AEC4BE6C041F0435D672AE4E72D9E73C87DF37245BE30C3008AEA1306062C60CF5299AFD9A06C9E03EA758CD2E627D65499E4D5F44A3D81AD4222EE77C04B0B4D776F69D2C3B5292C220B4415530B3C5BE6A8837B7F3C324AABBE97952958E2E66D36465AA52A7B47F3A1013387D024DFE924046F2E9AA1BEB1D730FB3F433558ADE52758AC7C307AEE0AA9623570836B922B650E0B1C295EC500007A6B9032D3CDD10B8EE065B2D4A962F518EA46C6897CBA5B36411A61FB826EE6FA48AC9CD4DDF59A9E7BADCEC44BA470C6BAC78354F3CEC0C
padding = 33608B65B675EDEB574612F3
tmp_aes_key = 9A4E3B9FFC93395AEF3A1A3D980C65B346AD55239764095BCE4CE82EF7D7B188
tmp_aes_iv = 080199AE9E1B3CB91C6AECDD853F64F0A82A203CC088FA0F2D8F19D71688B570</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = E938CDA17FCE9A820D24122C19BFEED33DBA6CB395EA0F4759590F95AF2FCD55BCD8F63083DABE9D16967CC1B452B0ED9D5091FF0F3EA9E17238D8963D6DA168E43BB6C0532CB78F8ECB32F090752D81EB51DD609BF573E7E69F99FDAD0EFCDF98233261403D91FB9D9BBC599B97F0549FCD00D4B97495284836BB0B57F8AE87CB406EF0FB61FCCADAF34275400D36FFE12D7F194D2571CCC4CF60415A54ED0FA91C14B12F5B38217B041D3CA397AD9BEE46D19CC9A0B4BDEEC487586C9BD8D84D3AE7E5DB284233BFF5B15A1404DFB9756A277ECB218C22C5575CCE58F3A10A85ADD9A49C65CFC1D22BB2A9242FC119C1CBC6BC8DED37B2C67AB0B0DCC39C885067AD502891449410C37402D129528F5ECA6F60C170F91709D10A538D9568F816E14923E319D59E413558619EC7CB5648428C8475097941C0E35D50F039620DB8260D430AE5BDA4823798D3EB8F5FCF</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 50 D4 0C 00 A4 F9 70 65
0010 | 78 01 00 00 1F 5F 04 F5 33 5E 99 59 32 B9 7A B0
0020 | F4 99 8B 49 79 A9 8A B8 1D 2A 19 43 39 EB D2 05
0030 | 03 B5 CB 18 9E DE 22 74 FE 50 01 00 E9 38 CD A1
0040 | 7F CE 9A 82 0D 24 12 2C 19 BF EE D3 3D BA 6C B3
0050 | 95 EA 0F 47 59 59 0F 95 AF 2F CD 55 BC D8 F6 30
0060 | 83 DA BE 9D 16 96 7C C1 B4 52 B0 ED 9D 50 91 FF
0070 | 0F 3E A9 E1 72 38 D8 96 3D 6D A1 68 E4 3B B6 C0
0080 | 53 2C B7 8F 8E CB 32 F0 90 75 2D 81 EB 51 DD 60
0090 | 9B F5 73 E7 E6 9F 99 FD AD 0E FC DF 98 23 32 61
00A0 | 40 3D 91 FB 9D 9B BC 59 9B 97 F0 54 9F CD 00 D4
00B0 | B9 74 95 28 48 36 BB 0B 57 F8 AE 87 CB 40 6E F0
00C0 | FB 61 FC CA DA F3 42 75 40 0D 36 FF E1 2D 7F 19
00D0 | 4D 25 71 CC C4 CF 60 41 5A 54 ED 0F A9 1C 14 B1
00E0 | 2F 5B 38 21 7B 04 1D 3C A3 97 AD 9B EE 46 D1 9C
00F0 | C9 A0 B4 BD EE C4 87 58 6C 9B D8 D8 4D 3A E7 E5
0100 | DB 28 42 33 BF F5 B1 5A 14 04 DF B9 75 6A 27 7E
0110 | CB 21 8C 22 C5 57 5C CE 58 F3 A1 0A 85 AD D9 A4
0120 | 9C 65 CF C1 D2 2B B2 A9 24 2F C1 19 C1 CB C6 BC
0130 | 8D ED 37 B2 C6 7A B0 B0 DC C3 9C 88 50 67 AD 50
0140 | 28 91 44 94 10 C3 74 02 D1 29 52 8F 5E CA 6F 60
0150 | C1 70 F9 17 09 D1 0A 53 8D 95 68 F8 16 E1 49 23
0160 | E3 19 D5 9E 41 35 58 61 9E C7 CB 56 48 42 8C 84
0170 | 75 09 79 41 C0 E3 5D 50 F0 39 62 0D B8 26 0D 43
0180 | 0A E5 BD A4 82 37 98 D3 EB 8F 5F CF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>50D40C00A4F97065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100E938CDA17FCE9A820D24122C</code> <code>19BFEED33DBA6CB395EA0F4759590F95</code> <code>AF2FCD55BCD8F63083DABE9D16967CC1</code> <code>B452B0ED9D5091FF0F3EA9E17238D896</code> <code>3D6DA168E43BB6C0532CB78F8ECB32F0</code> <code>90752D81EB51DD609BF573E7E69F99FD</code> <code>AD0EFCDF98233261403D91FB9D9BBC59</code> <code>9B97F0549FCD00D4B97495284836BB0B</code> <code>57F8AE87CB406EF0FB61FCCADAF34275</code> <code>400D36FFE12D7F194D2571CCC4CF6041</code> <code>5A54ED0FA91C14B12F5B38217B041D3C</code> <code>A397AD9BEE46D19CC9A0B4BDEEC48758</code> <code>6C9BD8D84D3AE7E5DB284233BFF5B15A</code> <code>1404DFB9756A277ECB218C22C5575CCE</code> <code>58F3A10A85ADD9A49C65CFC1D22BB2A9</code> <code>242FC119C1CBC6BC8DED37B2C67AB0B0</code> <code>DCC39C885067AD502891449410C37402</code> <code>D129528F5ECA6F60C170F91709D10A53</code> <code>8D9568F816E14923E319D59E41355861</code> <code>9EC7CB5648428C8475097941C0E35D50</code> <code>F039620DB8260D430AE5BDA4823798D3</code><br> <code>EB8F5FCF</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = A4230DDD3A80A925774E23CFB272A8C4B6CD40C989561A6E8397B01785D9367B3B21A75155B3ADE1D2292ACB565A635AC34FBD077CE68C71A8E5B8AD494655916B3BF1941F51EB1E75122648BB1587CD18D570187902BA47EB5DBA8EA3D63243FFE8431EC4C0AB4DE7AE26CDE9E2D1D946BEEA55DDAC2730CC89BE17F68295ABD5906EC873EA7566FA0E8B734DA862B0F6AB876796A9F36C2DB2654288EEE2032CDAAF6AC156FFA5004DDB377E3D8E0659079DFA41D622935C1E36B897EE2F571503A8EA19F6B2E0AC31D18FC09AA7E8727531008F77B5A91DFE2540CE236F27177113E7B2B865B9F9BD90483D36E836938621D69AA9B66217FE2306B56408F0</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 74 C3 A2 A4 F9 70 65
0010 | 6C 00 00 00 34 F7 CB 3B 33 5E 99 59 32 B9 7A B0
0020 | F4 99 8B 49 79 A9 8A B8 1D 2A 19 43 39 EB D2 05
0030 | 03 B5 CB 18 9E DE 22 74 EE 44 DE 65 D0 70 EE 2F
0040 | 4A 60 F9 09 59 D9 15 C9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0174C3A2A4F97065</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>6C000000</code> (108 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>335E995932B97AB0F4998B4979A98AB8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D2A194339EBD20503B5CB189EDE2274</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>EE44DE65D070EE2F4A60F90959D915C9</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

