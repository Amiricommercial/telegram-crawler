<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 54 62 0A 00 CE 97 5F 65
0010 | 14 00 00 00 F1 8E 7E BE 9A 34 B2 BA F3 FF F7 F1
0020 | C3 31 F2 31 91 49 DF 0F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>54620A00CE975F65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 20 6E C1 CE 97 5F 65
0010 | 5C 00 00 00 63 24 16 05 9A 34 B2 BA F3 FF F7 F1
0020 | C3 31 F2 31 91 49 DF 0F EE 52 4C B3 9F 67 CF EF
0030 | A6 71 47 6A 74 13 E8 55 08 1E 14 EA 0E 80 3B 6D
0040 | 49 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01206EC1CE975F65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>5C000000</code> (92 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081E14EA0E803B6D49000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2167614668673871177</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2167614668673871177</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2167614668673871177 = 1358494177 * 1595601001</code></p>
<pre><code>p = 1358494177
q = 1595601001</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1E 14 EA 0E 80 3B 6D 49 00 00 00
0010 | 04 50 F8 F9 E1 00 00 00 04 5F 1A F0 69 00 00 00
0020 | 9A 34 B2 BA F3 FF F7 F1 C3 31 F2 31 91 49 DF 0F
0030 | EE 52 4C B3 9F 67 CF EF A6 71 47 6A 74 13 E8 55
0040 | 2E A9 3C 55 A6 9B 21 26 00 7B EE CF 09 39 A7 7D
0050 | 32 32 60 FB 68 C8 DF 67 D3 20 49 70 11 51 32 1C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081E14EA0E803B6D49000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2167614668673871177</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0450F8F9E1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1358494177</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045F1AF069000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1595601001</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>2EA93C55A69B2126007BEECF0939A77D</code> <code>323260FB68C8DF67D32049701151321C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081E14EA0E803B6D490000000450F8F9E1000000045F1AF0690000009A34B2BAF3FFF7F1C331F2319149DF0FEE524CB39F67CFEFA671476A7413E8552EA93C55A69B2126007BEECF0939A77D323260FB68C8DF67D32049701151321C02000000
random_padding_bytes = 441AD8C99CE5A2AB3F1DF851330024CEE71186EC20A16CC06E5756A596F8439DCFE0C706927E1483D8F95B089AA5575ADF5917018AFD7192D3DFD481F3D036D9545898FA3B92B47D85AF0DC1497FF8D785D00DE958A25301433E532B</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = CAF6728D3ED9D3C91FDD6F60DA1D298A516E8234AC876CF715341E74E6670B6F5168A4D79C025A05265280540C260D3945CE1CB1EE4D27800D681CFFB572FFAA42A9BAAC3474CAEC86B44B4D41ED09864CD4A43419DF12A7CB984ADA2E3987A993925D9DA258E8975B9CA795591803A2C73AF1B2BB2A3121B35A6BF13763FFC04F21046876942DA6084B36DC857C874F318B076BD083FDD056C897C6428695C5D3C284CDC858BB479B92376F75EEE68715D3C35F7E19CC1196E853AEC2FA4891DE206A1F3CF4F728A35753C8C2B394D8CD28D2CC8874AC300CAD30D2098A8DFE232902E11635291ACB23EFA07C521209B27C53BAC41916EDA3EA3816361D169A</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 58 62 0A 00 CE 97 5F 65
0010 | 40 01 00 00 BE E4 12 D7 9A 34 B2 BA F3 FF F7 F1
0020 | C3 31 F2 31 91 49 DF 0F EE 52 4C B3 9F 67 CF EF
0030 | A6 71 47 6A 74 13 E8 55 04 50 F8 F9 E1 00 00 00
0040 | 04 5F 1A F0 69 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 CA F6 72 8D 3E D9 D3 C9 1F DD 6F 60
0060 | DA 1D 29 8A 51 6E 82 34 AC 87 6C F7 15 34 1E 74
0070 | E6 67 0B 6F 51 68 A4 D7 9C 02 5A 05 26 52 80 54
0080 | 0C 26 0D 39 45 CE 1C B1 EE 4D 27 80 0D 68 1C FF
0090 | B5 72 FF AA 42 A9 BA AC 34 74 CA EC 86 B4 4B 4D
00A0 | 41 ED 09 86 4C D4 A4 34 19 DF 12 A7 CB 98 4A DA
00B0 | 2E 39 87 A9 93 92 5D 9D A2 58 E8 97 5B 9C A7 95
00C0 | 59 18 03 A2 C7 3A F1 B2 BB 2A 31 21 B3 5A 6B F1
00D0 | 37 63 FF C0 4F 21 04 68 76 94 2D A6 08 4B 36 DC
00E0 | 85 7C 87 4F 31 8B 07 6B D0 83 FD D0 56 C8 97 C6
00F0 | 42 86 95 C5 D3 C2 84 CD C8 58 BB 47 9B 92 37 6F
0100 | 75 EE E6 87 15 D3 C3 5F 7E 19 CC 11 96 E8 53 AE
0110 | C2 FA 48 91 DE 20 6A 1F 3C F4 F7 28 A3 57 53 C8
0120 | C2 B3 94 D8 CD 28 D2 CC 88 74 AC 30 0C AD 30 D2
0130 | 09 8A 8D FE 23 29 02 E1 16 35 29 1A CB 23 EF A0
0140 | 7C 52 12 09 B2 7C 53 BA C4 19 16 ED A3 EA 38 16
0150 | 36 1D 16 9A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>58620A00CE975F65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0450F8F9E1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1358494177</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045F1AF069000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1595601001</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100CAF6728D3ED9D3C91FDD6F60</code> <code>DA1D298A516E8234AC876CF715341E74</code> <code>E6670B6F5168A4D79C025A0526528054</code> <code>0C260D3945CE1CB1EE4D27800D681CFF</code> <code>B572FFAA42A9BAAC3474CAEC86B44B4D</code> <code>41ED09864CD4A43419DF12A7CB984ADA</code> <code>2E3987A993925D9DA258E8975B9CA795</code> <code>591803A2C73AF1B2BB2A3121B35A6BF1</code> <code>3763FFC04F21046876942DA6084B36DC</code> <code>857C874F318B076BD083FDD056C897C6</code> <code>428695C5D3C284CDC858BB479B92376F</code> <code>75EEE68715D3C35F7E19CC1196E853AE</code> <code>C2FA4891DE206A1F3CF4F728A35753C8</code> <code>C2B394D8CD28D2CC8874AC300CAD30D2</code> <code>098A8DFE232902E11635291ACB23EFA0</code> <code>7C521209B27C53BAC41916EDA3EA3816</code><br> <code>361D169A</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 FC 45 6F CF 97 5F 65
0010 | 78 02 00 00 5C 07 E8 D0 9A 34 B2 BA F3 FF F7 F1
0020 | C3 31 F2 31 91 49 DF 0F EE 52 4C B3 9F 67 CF EF
0030 | A6 71 47 6A 74 13 E8 55 FE 50 02 00 41 10 93 8E
0040 | AC B0 EC C6 4A 25 8E F4 17 3B CB 5F 9C B2 7B 36
0050 | 5F 11 A9 17 2B 44 FC 4B 4E 1E 08 83 9B D0 97 D3
0060 | 5F C5 72 0F 4F 9E AE F9 45 7D 05 A3 25 76 B5 CB
0070 | 8F 99 7A 1E A2 E2 08 7C 32 1F B1 BF A2 1A 5E D2
0080 | A0 BC 87 AF FB 68 FB E0 60 D3 19 6B 30 DC 1E BC
0090 | 22 6D B9 16 8E 47 1D 60 0E A7 5E 59 CC D7 3E 9A
00A0 | 26 63 E3 82 94 22 FD 22 5A 0C 3A 80 3D 49 9A 52
00B0 | F5 DF E0 D9 F6 CA 25 2D 97 22 C8 76 E9 AA FE 46
00C0 | CD 79 2D 85 2F 73 46 46 18 3A 7B 47 39 2D E9 C0
00D0 | 9C 6B 29 4B 23 D1 B8 76 5E 72 6D B1 BC 13 80 D0
00E0 | 24 0E A5 96 B0 DE AF C1 19 27 3C CA B9 50 C9 61
00F0 | 47 1E 9C 78 57 AB AE DD 86 13 8E A2 AA 9E 37 F1
0100 | AB 1E DE 96 48 9F 03 82 8A D0 E1 E4 57 1B 4E 63
0110 | 06 BF F4 F1 9A 64 B7 6D 74 CC 61 C5 8C 13 EC 15
0120 | 2E FE EC 9F A0 E1 49 F4 7B E9 8E 42 43 56 92 09
0130 | 6C 4F 21 47 A7 CC CC A6 C6 C4 40 FD C2 FA D9 D9
0140 | EB CE 03 22 92 B2 AA 84 D0 D9 25 4D 33 77 8B 0B
0150 | 84 AF 4D 2E B9 5B 79 4A E9 B7 5F 0C BD 10 46 6F
0160 | 33 A8 5B 3B CC B6 82 02 47 B2 89 FA CE CF A6 A1
0170 | 23 ED 59 B8 50 DB 9F 99 45 AC 02 F1 7B 6C 1E 0B
0180 | 11 EA 2E AA 0C 51 2B 7A 45 F1 0D A9 2A 6B 85 3E
0190 | 1E 31 3B A7 25 0B FD ED 89 88 D4 55 E3 2D A0 6F
01A0 | 72 E3 5D B2 A6 6E 4F FA E2 09 77 74 8D A3 A3 EC
01B0 | 30 0C 27 5F 88 33 E3 78 50 C4 65 84 5A 7C 6C 9E
01C0 | 07 C5 AE 95 FB 70 5D 8F DE F6 33 80 A2 0D 72 7E
01D0 | 8A F7 FF 7A 40 C1 74 B1 27 AC 11 8A 46 D1 5D 7F
01E0 | 07 D6 D7 2F 55 4C B3 D8 F0 67 45 BE 72 BF DC 55
01F0 | 47 05 0A 33 8D 9E 14 B6 56 C9 E4 33 18 9D 29 42
0200 | 18 A0 73 3B 12 05 22 E6 9C 8A 33 A2 DA C7 E4 0F
0210 | 8A 7D 10 38 A8 72 5F E0 8F 54 3B 14 0F FB EE BA
0220 | A3 56 4D F0 B1 0D 82 F9 CF 9A DF D7 89 70 E5 73
0230 | 15 01 A6 31 AE 13 BE 8A DD 44 A4 77 92 BE 57 C2
0240 | 4F 6F 27 2D BE 87 87 C5 2B AD 8E D5 38 25 AA C9
0250 | B0 83 6B 95 3E 17 B4 83 91 B8 3E 92 E3 56 23 8E
0260 | 36 01 93 7C DD E5 33 0D 6B 6B FB E6 34 77 26 37
0270 | 32 A3 75 CF 97 80 1A CF 71 75 00 58 16 9A 66 E9
0280 | EF B9 46 88 BE D1 95 C0 8A 76 F0 1A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01FC456FCF975F65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002004110938EACB0ECC64A258EF4</code> <code>173BCB5F9CB27B365F11A9172B44FC4B</code> <code>4E1E08839BD097D35FC5720F4F9EAEF9</code> <code>457D05A32576B5CB8F997A1EA2E2087C</code> <code>321FB1BFA21A5ED2A0BC87AFFB68FBE0</code> <code>60D3196B30DC1EBC226DB9168E471D60</code> <code>0EA75E59CCD73E9A2663E3829422FD22</code> <code>5A0C3A803D499A52F5DFE0D9F6CA252D</code> <code>9722C876E9AAFE46CD792D852F734646</code> <code>183A7B47392DE9C09C6B294B23D1B876</code> <code>5E726DB1BC1380D0240EA596B0DEAFC1</code> <code>19273CCAB950C961471E9C7857ABAEDD</code> <code>86138EA2AA9E37F1AB1EDE96489F0382</code> <code>8AD0E1E4571B4E6306BFF4F19A64B76D</code> <code>74CC61C58C13EC152EFEEC9FA0E149F4</code> <code>7BE98E42435692096C4F2147A7CCCCA6</code> <code>C6C440FDC2FAD9D9EBCE032292B2AA84</code> <code>D0D9254D33778B0B84AF4D2EB95B794A</code> <code>E9B75F0CBD10466F33A85B3BCCB68202</code> <code>47B289FACECFA6A123ED59B850DB9F99</code> <code>45AC02F17B6C1E0B11EA2EAA0C512B7A</code> <code>45F10DA92A6B853E1E313BA7250BFDED</code> <code>8988D455E32DA06F72E35DB2A66E4FFA</code> <code>E20977748DA3A3EC300C275F8833E378</code> <code>50C465845A7C6C9E07C5AE95FB705D8F</code> <code>DEF63380A20D727E8AF7FF7A40C174B1</code> <code>27AC118A46D15D7F07D6D72F554CB3D8</code> <code>F06745BE72BFDC5547050A338D9E14B6</code> <code>56C9E433189D294218A0733B120522E6</code> <code>9C8A33A2DAC7E40F8A7D1038A8725FE0</code> <code>8F543B140FFBEEBAA3564DF0B10D82F9</code> <code>CF9ADFD78970E5731501A631AE13BE8A</code> <code>DD44A47792BE57C24F6F272DBE8787C5</code> <code>2BAD8ED53825AAC9B0836B953E17B483</code> <code>91B83E92E356238E3601937CDDE5330D</code> <code>6B6BFBE63477263732A375CF97801ACF</code> <code>71750058169A66E9EFB94688BED195C0</code><br> <code>8A76F01A</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 4110938EACB0ECC64A258EF4173BCB5F9CB27B365F11A9172B44FC4B4E1E08839BD097D35FC5720F4F9EAEF9457D05A32576B5CB8F997A1EA2E2087C321FB1BFA21A5ED2A0BC87AFFB68FBE060D3196B30DC1EBC226DB9168E471D600EA75E59CCD73E9A2663E3829422FD225A0C3A803D499A52F5DFE0D9F6CA252D9722C876E9AAFE46CD792D852F734646183A7B47392DE9C09C6B294B23D1B8765E726DB1BC1380D0240EA596B0DEAFC119273CCAB950C961471E9C7857ABAEDD86138EA2AA9E37F1AB1EDE96489F03828AD0E1E4571B4E6306BFF4F19A64B76D74CC61C58C13EC152EFEEC9FA0E149F47BE98E42435692096C4F2147A7CCCCA6C6C440FDC2FAD9D9EBCE032292B2AA84D0D9254D33778B0B84AF4D2EB95B794AE9B75F0CBD10466F33A85B3BCCB6820247B289FACECFA6A123ED59B850DB9F9945AC02F17B6C1E0B11EA2EAA0C512B7A45F10DA92A6B853E1E313BA7250BFDED8988D455E32DA06F72E35DB2A66E4FFAE20977748DA3A3EC300C275F8833E37850C465845A7C6C9E07C5AE95FB705D8FDEF63380A20D727E8AF7FF7A40C174B127AC118A46D15D7F07D6D72F554CB3D8F06745BE72BFDC5547050A338D9E14B656C9E433189D294218A0733B120522E69C8A33A2DAC7E40F8A7D1038A8725FE08F543B140FFBEEBAA3564DF0B10D82F9CF9ADFD78970E5731501A631AE13BE8ADD44A47792BE57C24F6F272DBE8787C52BAD8ED53825AAC9B0836B953E17B48391B83E92E356238E3601937CDDE5330D6B6BFBE63477263732A375CF97801ACF71750058169A66E9EFB94688BED195C08A76F01A
tmp_aes_key = DB2F34B706C1F015EF12A76AD1A6D824D5C4EBA7CA8DD56DF50B61B7A9536C80
tmp_aes_iv = 0B108CEA9A57852932D4DF2C472DD80227154011C4EDB6BA8D1E18682EA93C55</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = FFD741ADB59CFD08046C78EEC6486E798865444CBA0D89B59A34B2BAF3FFF7F1C331F2319149DF0FEE524CB39F67CFEFA671476A7413E85503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010079241B5C80B4C81FED0BAF2D4C892B0124D2CD962C2C09CBB117D6E8D4541C56E1902CD0330601647E56C20DB73C55659D8B97F5BEC0DF0D652130B969F6F1C6B72566B68852C8C831B72FF864390C2B0AA0083053FB88CF3D47F08E05EF7AF9057367EE44511540C561B5BA21B7D12AB50ECBECFB85CE1FDCE5654ED90A086B816606EC948399B262748C8732A630633D888B644D2B584622F9DA08294F307DD43E655C5A0687EA568291AAB091D9F6D57D861E75CD4CE8E68B1A69CCE29A4857E570141C53062633339BAB64FC96A28723523975BD7670DB616D2D1C1FAD08D29C781E866B2BA05AEA4F9C90AD55897DBA1077A7FCEBC34C33A43A5E7DBAA7CF975F65167DF1F4851834AB
answer = BA0D89B59A34B2BAF3FFF7F1C331F2319149DF0FEE524CB39F67CFEFA671476A7413E85503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010079241B5C80B4C81FED0BAF2D4C892B0124D2CD962C2C09CBB117D6E8D4541C56E1902CD0330601647E56C20DB73C55659D8B97F5BEC0DF0D652130B969F6F1C6B72566B68852C8C831B72FF864390C2B0AA0083053FB88CF3D47F08E05EF7AF9057367EE44511540C561B5BA21B7D12AB50ECBECFB85CE1FDCE5654ED90A086B816606EC948399B262748C8732A630633D888B644D2B584622F9DA08294F307DD43E655C5A0687EA568291AAB091D9F6D57D861E75CD4CE8E68B1A69CCE29A4857E570141C53062633339BAB64FC96A28723523975BD7670DB616D2D1C1FAD08D29C781E866B2BA05AEA4F9C90AD55897DBA1077A7FCEBC34C33A43A5E7DBAA7CF975F65167DF1F4851834AB</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 9A 34 B2 BA F3 FF F7 F1 C3 31 F2 31
0010 | 91 49 DF 0F EE 52 4C B3 9F 67 CF EF A6 71 47 6A
0020 | 74 13 E8 55 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 79 24 1B 5C 80 B4 C8 1F ED 0B AF 2D 4C 89 2B 01
0140 | 24 D2 CD 96 2C 2C 09 CB B1 17 D6 E8 D4 54 1C 56
0150 | E1 90 2C D0 33 06 01 64 7E 56 C2 0D B7 3C 55 65
0160 | 9D 8B 97 F5 BE C0 DF 0D 65 21 30 B9 69 F6 F1 C6
0170 | B7 25 66 B6 88 52 C8 C8 31 B7 2F F8 64 39 0C 2B
0180 | 0A A0 08 30 53 FB 88 CF 3D 47 F0 8E 05 EF 7A F9
0190 | 05 73 67 EE 44 51 15 40 C5 61 B5 BA 21 B7 D1 2A
01A0 | B5 0E CB EC FB 85 CE 1F DC E5 65 4E D9 0A 08 6B
01B0 | 81 66 06 EC 94 83 99 B2 62 74 8C 87 32 A6 30 63
01C0 | 3D 88 8B 64 4D 2B 58 46 22 F9 DA 08 29 4F 30 7D
01D0 | D4 3E 65 5C 5A 06 87 EA 56 82 91 AA B0 91 D9 F6
01E0 | D5 7D 86 1E 75 CD 4C E8 E6 8B 1A 69 CC E2 9A 48
01F0 | 57 E5 70 14 1C 53 06 26 33 33 9B AB 64 FC 96 A2
0200 | 87 23 52 39 75 BD 76 70 DB 61 6D 2D 1C 1F AD 08
0210 | D2 9C 78 1E 86 6B 2B A0 5A EA 4F 9C 90 AD 55 89
0220 | 7D BA 10 77 A7 FC EB C3 4C 33 A4 3A 5E 7D BA A7
0230 | CF 97 5F 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010079241B5C80B4C81FED0BAF2D</code> <code>4C892B0124D2CD962C2C09CBB117D6E8</code> <code>D4541C56E1902CD0330601647E56C20D</code> <code>B73C55659D8B97F5BEC0DF0D652130B9</code> <code>69F6F1C6B72566B68852C8C831B72FF8</code> <code>64390C2B0AA0083053FB88CF3D47F08E</code> <code>05EF7AF9057367EE44511540C561B5BA</code> <code>21B7D12AB50ECBECFB85CE1FDCE5654E</code> <code>D90A086B816606EC948399B262748C87</code> <code>32A630633D888B644D2B584622F9DA08</code> <code>294F307DD43E655C5A0687EA568291AA</code> <code>B091D9F6D57D861E75CD4CE8E68B1A69</code> <code>CCE29A4857E570141C53062633339BAB</code> <code>64FC96A28723523975BD7670DB616D2D</code> <code>1C1FAD08D29C781E866B2BA05AEA4F9C</code> <code>90AD55897DBA1077A7FCEBC34C33A43A</code><br> <code>5E7DBAA7</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>CF975F65</code> (1700763599 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = B94B19F4663965D3475834E9594CE260D9E75DBA771A518EBFF7826310821ED0140E73DAEED7D995D00D1707F83B95D7B3BED5FB02E907C8DAF8874529D3D6F59954F6E371F62E1D9C0BFD3C9B37BFF4ACF8F364038F8BE4E3CEF93C6AA75FE01F79C47FDB9F898AAB104027B59B029FC356D21637338E5A2A02324A10895C885E1D84B0673FFD7F309DC3CD538AFB85335A9E6E5B2C24FF80DDFECF7F8E07935DBBEEE3125DC748348312C162DFD2EB355FCBFDE963C8A9756B52B0FA53EADAE0C5C4208AF988316F78F87A31EB8F52ECD6FEC107286D9C5B9B1B521A08BD39A041BBA65C1474A2CB765A8AC2006B03E2F2E931D741B50FBFEA07CB22189BFB</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B03B9954067464ABDF175BADDFCC201F0B7E7971DCC88DB4150BD2AEB28A4A93F4D41E5F2B10E5408046F584714511196614524F66E681191F1F7B48C71DD519EDE29A0686D8E7B7BD60D4C276AACE8D6825C79740541A32012589B0FA4FA45632A579F8B962A17850086DA30715DBC9B8F1636A1D04743A542773FEB7F785E47C5DA93B4CBF935DC762245ED7D1448DFBF0C3CD86EF34DF3966FE5A677976026DFF0244EB5822A85AF94C4B17102653239533CA14C9366A486371911B75C4C2A93448F0C6A70F72AE4D3075FC6CC70CCB1D4CC4D64C57D4436DBA65A8DCC93E455770789A3572A636CC8AB107B86B9D7E5596D5FBC71C26D5AAD6AF58290E64</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 9A 34 B2 BA F3 FF F7 F1 C3 31 F2 31
0010 | 91 49 DF 0F EE 52 4C B3 9F 67 CF EF A6 71 47 6A
0020 | 74 13 E8 55 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B0 3B 99 54 06 74 64 AB DF 17 5B AD DF CC 20 1F
0040 | 0B 7E 79 71 DC C8 8D B4 15 0B D2 AE B2 8A 4A 93
0050 | F4 D4 1E 5F 2B 10 E5 40 80 46 F5 84 71 45 11 19
0060 | 66 14 52 4F 66 E6 81 19 1F 1F 7B 48 C7 1D D5 19
0070 | ED E2 9A 06 86 D8 E7 B7 BD 60 D4 C2 76 AA CE 8D
0080 | 68 25 C7 97 40 54 1A 32 01 25 89 B0 FA 4F A4 56
0090 | 32 A5 79 F8 B9 62 A1 78 50 08 6D A3 07 15 DB C9
00A0 | B8 F1 63 6A 1D 04 74 3A 54 27 73 FE B7 F7 85 E4
00B0 | 7C 5D A9 3B 4C BF 93 5D C7 62 24 5E D7 D1 44 8D
00C0 | FB F0 C3 CD 86 EF 34 DF 39 66 FE 5A 67 79 76 02
00D0 | 6D FF 02 44 EB 58 22 A8 5A F9 4C 4B 17 10 26 53
00E0 | 23 95 33 CA 14 C9 36 6A 48 63 71 91 1B 75 C4 C2
00F0 | A9 34 48 F0 C6 A7 0F 72 AE 4D 30 75 FC 6C C7 0C
0100 | CB 1D 4C C4 D6 4C 57 D4 43 6D BA 65 A8 DC C9 3E
0110 | 45 57 70 78 9A 35 72 A6 36 CC 8A B1 07 B8 6B 9D
0120 | 7E 55 96 D5 FB C7 1C 26 D5 AA D6 AF 58 29 0E 64</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B03B9954067464ABDF175BAD</code> <code>DFCC201F0B7E7971DCC88DB4150BD2AE</code> <code>B28A4A93F4D41E5F2B10E5408046F584</code> <code>714511196614524F66E681191F1F7B48</code> <code>C71DD519EDE29A0686D8E7B7BD60D4C2</code> <code>76AACE8D6825C79740541A32012589B0</code> <code>FA4FA45632A579F8B962A17850086DA3</code> <code>0715DBC9B8F1636A1D04743A542773FE</code> <code>B7F785E47C5DA93B4CBF935DC762245E</code> <code>D7D1448DFBF0C3CD86EF34DF3966FE5A</code> <code>677976026DFF0244EB5822A85AF94C4B</code> <code>17102653239533CA14C9366A48637191</code> <code>1B75C4C2A93448F0C6A70F72AE4D3075</code> <code>FC6CC70CCB1D4CC4D64C57D4436DBA65</code> <code>A8DCC93E455770789A3572A636CC8AB1</code> <code>07B86B9D7E5596D5FBC71C26D5AAD6AF</code><br> <code>58290E64</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643669A34B2BAF3FFF7F1C331F2319149DF0FEE524CB39F67CFEFA671476A7413E8550000000000000000FE000100B03B9954067464ABDF175BADDFCC201F0B7E7971DCC88DB4150BD2AEB28A4A93F4D41E5F2B10E5408046F584714511196614524F66E681191F1F7B48C71DD519EDE29A0686D8E7B7BD60D4C276AACE8D6825C79740541A32012589B0FA4FA45632A579F8B962A17850086DA30715DBC9B8F1636A1D04743A542773FEB7F785E47C5DA93B4CBF935DC762245ED7D1448DFBF0C3CD86EF34DF3966FE5A677976026DFF0244EB5822A85AF94C4B17102653239533CA14C9366A486371911B75C4C2A93448F0C6A70F72AE4D3075FC6CC70CCB1D4CC4D64C57D4436DBA65A8DCC93E455770789A3572A636CC8AB107B86B9D7E5596D5FBC71C26D5AAD6AF58290E64
padding = 20107E428F635BE3D5AC0F63
tmp_aes_key = DB2F34B706C1F015EF12A76AD1A6D824D5C4EBA7CA8DD56DF50B61B7A9536C80
tmp_aes_iv = 0B108CEA9A57852932D4DF2C472DD80227154011C4EDB6BA8D1E18682EA93C55</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = FF6551BB89A52E6E84591FFD97A0B9B04287F5DF2C9DD99981BF339DA80E67F776348AD9182D2B0E62D021B2013DB21FC5631F96F0BFADF9EC2EAA77256247AECBD46E6453C672DE7E96B6C1F0D3A3A93DB290A939B63A0E9756566ED63D80E4A621065B3AC71BF537FA9DE8345363DB25BE0622B24EE43FF4765A609739BE0612C4F6852AD998A2D5EE66A19A48C5C2F049CB606AECD4FB68B14BE28E9CC8CAEDEFC599501039C9E61E333B6487FB64145D26BC53BD0EC357CE6CC22D901043EEC24B7940F92C04253513FF16C711039DA3C1E6EE9BA19707845D7055FEB077383C80253E852F4699A493417E8E078BA432846553008B6F88C5D92048C014ABE942B5D785C622EA7277B8C24422471611009604EE51FC9F6ABA96A6A724A83398CF3EBDFC9268A56A1271DCF337D765E134E2F132B089858573F13A1F18F1968FC110EE978EC3360661FF127D97E2AC</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 14 05 00 CF 97 5F 65
0010 | 78 01 00 00 1F 5F 04 F5 9A 34 B2 BA F3 FF F7 F1
0020 | C3 31 F2 31 91 49 DF 0F EE 52 4C B3 9F 67 CF EF
0030 | A6 71 47 6A 74 13 E8 55 FE 50 01 00 FF 65 51 BB
0040 | 89 A5 2E 6E 84 59 1F FD 97 A0 B9 B0 42 87 F5 DF
0050 | 2C 9D D9 99 81 BF 33 9D A8 0E 67 F7 76 34 8A D9
0060 | 18 2D 2B 0E 62 D0 21 B2 01 3D B2 1F C5 63 1F 96
0070 | F0 BF AD F9 EC 2E AA 77 25 62 47 AE CB D4 6E 64
0080 | 53 C6 72 DE 7E 96 B6 C1 F0 D3 A3 A9 3D B2 90 A9
0090 | 39 B6 3A 0E 97 56 56 6E D6 3D 80 E4 A6 21 06 5B
00A0 | 3A C7 1B F5 37 FA 9D E8 34 53 63 DB 25 BE 06 22
00B0 | B2 4E E4 3F F4 76 5A 60 97 39 BE 06 12 C4 F6 85
00C0 | 2A D9 98 A2 D5 EE 66 A1 9A 48 C5 C2 F0 49 CB 60
00D0 | 6A EC D4 FB 68 B1 4B E2 8E 9C C8 CA ED EF C5 99
00E0 | 50 10 39 C9 E6 1E 33 3B 64 87 FB 64 14 5D 26 BC
00F0 | 53 BD 0E C3 57 CE 6C C2 2D 90 10 43 EE C2 4B 79
0100 | 40 F9 2C 04 25 35 13 FF 16 C7 11 03 9D A3 C1 E6
0110 | EE 9B A1 97 07 84 5D 70 55 FE B0 77 38 3C 80 25
0120 | 3E 85 2F 46 99 A4 93 41 7E 8E 07 8B A4 32 84 65
0130 | 53 00 8B 6F 88 C5 D9 20 48 C0 14 AB E9 42 B5 D7
0140 | 85 C6 22 EA 72 77 B8 C2 44 22 47 16 11 00 96 04
0150 | EE 51 FC 9F 6A BA 96 A6 A7 24 A8 33 98 CF 3E BD
0160 | FC 92 68 A5 6A 12 71 DC F3 37 D7 65 E1 34 E2 F1
0170 | 32 B0 89 85 85 73 F1 3A 1F 18 F1 96 8F C1 10 EE
0180 | 97 8E C3 36 06 61 FF 12 7D 97 E2 AC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>44140500CF975F65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100FF6551BB89A52E6E84591FFD</code> <code>97A0B9B04287F5DF2C9DD99981BF339D</code> <code>A80E67F776348AD9182D2B0E62D021B2</code> <code>013DB21FC5631F96F0BFADF9EC2EAA77</code> <code>256247AECBD46E6453C672DE7E96B6C1</code> <code>F0D3A3A93DB290A939B63A0E9756566E</code> <code>D63D80E4A621065B3AC71BF537FA9DE8</code> <code>345363DB25BE0622B24EE43FF4765A60</code> <code>9739BE0612C4F6852AD998A2D5EE66A1</code> <code>9A48C5C2F049CB606AECD4FB68B14BE2</code> <code>8E9CC8CAEDEFC599501039C9E61E333B</code> <code>6487FB64145D26BC53BD0EC357CE6CC2</code> <code>2D901043EEC24B7940F92C04253513FF</code> <code>16C711039DA3C1E6EE9BA19707845D70</code> <code>55FEB077383C80253E852F4699A49341</code> <code>7E8E078BA432846553008B6F88C5D920</code> <code>48C014ABE942B5D785C622EA7277B8C2</code> <code>4422471611009604EE51FC9F6ABA96A6</code> <code>A724A83398CF3EBDFC9268A56A1271DC</code> <code>F337D765E134E2F132B089858573F13A</code> <code>1F18F1968FC110EE978EC3360661FF12</code><br> <code>7D97E2AC</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 68C607FBF732686328AE0C9C39DA9D914C386228BF7FBE1891A24C99167A35B3586593272E4EF007588229042E8035599C21731D959E408B0CF9842AE25F1715E3F58CFAA3737061AAAD1D1C4195F2502C3AAB56C2FFEA4C2CA0A5443F4C4A74FDBF5CA5CC6E254B301DC3262B52FDD0E92E9FB7406E6E9953A028D2CF4BEE3D7C34C8910C03D041AED65FC90A0BFFC5D52718D7D0C6AF7B8C624B967F8BF06201EB64009F1C191E250A81E1261B2BD0C22075D3CFECDE990C857AD9CBCB180DE9AA3211C34D140D67D6778F209A0FA96742D3D05EBDB8A993CF2C40EF44F4B190DAC0A7B9A9766EFF33C60457ABEB765DAF5F75F5EDA564F78AB4DBFD571E03</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 68 BC C8 CF 97 5F 65
0010 | 4C 00 00 00 34 F7 CB 3B 9A 34 B2 BA F3 FF F7 F1
0020 | C3 31 F2 31 91 49 DF 0F EE 52 4C B3 9F 67 CF EF
0030 | A6 71 47 6A 74 13 E8 55 6C 0F 3C 63 0E 46 CC AE
0040 | B0 6F 9F 7D 3C 57 80 43</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0168BCC8CF975F65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>4C000000</code> (76 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A34B2BAF3FFF7F1C331F2319149DF0F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EE524CB39F67CFEFA671476A7413E855</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>6C0F3C630E46CCAEB06F9F7D3C578043</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

