<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 84 D3 04 00 2B 92 7C 65
0010 | 14 00 00 00 F1 8E 7E BE B5 10 65 80 A8 53 D8 F8
0020 | A3 DF 59 C9 34 61 01 99</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>84D304002B927C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C8 F4 91 2B 92 7C 65
0010 | 60 00 00 00 63 24 16 05 B5 10 65 80 A8 53 D8 F8
0020 | A3 DF 59 C9 34 61 01 99 13 A6 43 4C A0 99 1F 73
0030 | 1C C7 CD BC F5 61 29 27 08 2C 89 0B 03 50 A1 43
0040 | 95 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C8F4912B927C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>60000000</code> (96 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082C890B0350A14395000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3209108318343742357</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3209108318343742357</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3209108318343742357 = 1617897103 * 1983505819</code></p>
<pre><code>p = 1617897103
q = 1983505819</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2C 89 0B 03 50 A1 43 95 00 00 00
0010 | 04 60 6F 26 8F 00 00 00 04 76 39 E5 9B 00 00 00
0020 | B5 10 65 80 A8 53 D8 F8 A3 DF 59 C9 34 61 01 99
0030 | 13 A6 43 4C A0 99 1F 73 1C C7 CD BC F5 61 29 27
0040 | 60 7D 7D 78 2C 96 A7 03 3C 7F 13 54 7F D0 8D E7
0050 | A8 2B A4 A1 E3 22 5F 95 7C 63 58 C2 C1 A3 50 EB
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082C890B0350A14395000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3209108318343742357</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04606F268F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1617897103</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047639E59B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1983505819</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>607D7D782C96A7033C7F13547FD08DE7</code> <code>A82BA4A1E3225F957C6358C2C1A350EB</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082C890B0350A1439500000004606F268F000000047639E59B000000B5106580A853D8F8A3DF59C93461019913A6434CA0991F731CC7CDBCF5612927607D7D782C96A7033C7F13547FD08DE7A82BA4A1E3225F957C6358C2C1A350EB02000000
random_padding_bytes = 4C3471B040D96D83504DF135DD38DCBCB14DB78FC791727988FB4EF7BE075FEB23383A59B6437FBA350FEB6A0B03E22D6B02BC211AB936A36E226D794C7BC084BDAA043731BAB14BBD8EA8835D0587DFE3B4E917EE115EADBA5A133F</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 75C41209512F89246CAE08AD3B140242085E523FD733BF3EAD375217260628EAF2D17D9439D35E966C71DCE1FF7722377D93C012909862B07EA8E5F02D2F32C2314ABC54747778E337A91EE415B187B2A06033D55C278ADA567A2C36BC4A0AB247DF7292636EDA00BD92E72A78DEA581419943F17E1B971ED1325A69CEA40EFB1102FBD573796B18CF30B2AEFC232BB81A0ECF2F4991C62C91F5C3E90265031B84C3C4BE1FE8056EDB77B210D536E4398821EF24DB2AA5B9529FE3E899B1F646E05FE1D4DDE3745036B5ECB1267229F08C0AC6D32477F69672FDAA5CACCCFCDAD06C5733607D10561CC579CF955F4A884A38607A8DBB9797F59B70718E8B779F</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 AC 96 0B 00 2B 92 7C 65
0010 | 40 01 00 00 BE E4 12 D7 B5 10 65 80 A8 53 D8 F8
0020 | A3 DF 59 C9 34 61 01 99 13 A6 43 4C A0 99 1F 73
0030 | 1C C7 CD BC F5 61 29 27 04 60 6F 26 8F 00 00 00
0040 | 04 76 39 E5 9B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 75 C4 12 09 51 2F 89 24 6C AE 08 AD
0060 | 3B 14 02 42 08 5E 52 3F D7 33 BF 3E AD 37 52 17
0070 | 26 06 28 EA F2 D1 7D 94 39 D3 5E 96 6C 71 DC E1
0080 | FF 77 22 37 7D 93 C0 12 90 98 62 B0 7E A8 E5 F0
0090 | 2D 2F 32 C2 31 4A BC 54 74 77 78 E3 37 A9 1E E4
00A0 | 15 B1 87 B2 A0 60 33 D5 5C 27 8A DA 56 7A 2C 36
00B0 | BC 4A 0A B2 47 DF 72 92 63 6E DA 00 BD 92 E7 2A
00C0 | 78 DE A5 81 41 99 43 F1 7E 1B 97 1E D1 32 5A 69
00D0 | CE A4 0E FB 11 02 FB D5 73 79 6B 18 CF 30 B2 AE
00E0 | FC 23 2B B8 1A 0E CF 2F 49 91 C6 2C 91 F5 C3 E9
00F0 | 02 65 03 1B 84 C3 C4 BE 1F E8 05 6E DB 77 B2 10
0100 | D5 36 E4 39 88 21 EF 24 DB 2A A5 B9 52 9F E3 E8
0110 | 99 B1 F6 46 E0 5F E1 D4 DD E3 74 50 36 B5 EC B1
0120 | 26 72 29 F0 8C 0A C6 D3 24 77 F6 96 72 FD AA 5C
0130 | AC CC FC DA D0 6C 57 33 60 7D 10 56 1C C5 79 CF
0140 | 95 5F 4A 88 4A 38 60 7A 8D BB 97 97 F5 9B 70 71
0150 | 8E 8B 77 9F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>AC960B002B927C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04606F268F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1617897103</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047639E59B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1983505819</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010075C41209512F89246CAE08AD</code> <code>3B140242085E523FD733BF3EAD375217</code> <code>260628EAF2D17D9439D35E966C71DCE1</code> <code>FF7722377D93C012909862B07EA8E5F0</code> <code>2D2F32C2314ABC54747778E337A91EE4</code> <code>15B187B2A06033D55C278ADA567A2C36</code> <code>BC4A0AB247DF7292636EDA00BD92E72A</code> <code>78DEA581419943F17E1B971ED1325A69</code> <code>CEA40EFB1102FBD573796B18CF30B2AE</code> <code>FC232BB81A0ECF2F4991C62C91F5C3E9</code> <code>0265031B84C3C4BE1FE8056EDB77B210</code> <code>D536E4398821EF24DB2AA5B9529FE3E8</code> <code>99B1F646E05FE1D4DDE3745036B5ECB1</code> <code>267229F08C0AC6D32477F69672FDAA5C</code> <code>ACCCFCDAD06C5733607D10561CC579CF</code> <code>955F4A884A38607A8DBB9797F59B7071</code><br> <code>8E8B779F</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 10 B7 27 2C 92 7C 65
0010 | 8C 02 00 00 5C 07 E8 D0 B5 10 65 80 A8 53 D8 F8
0020 | A3 DF 59 C9 34 61 01 99 13 A6 43 4C A0 99 1F 73
0030 | 1C C7 CD BC F5 61 29 27 FE 50 02 00 68 53 BE 75
0040 | B8 ED C1 53 E5 38 C8 76 A0 55 64 56 43 29 7C 47
0050 | D5 02 8E 2C 94 04 FE 52 D5 68 F5 84 1C 40 5A AB
0060 | FD D0 3F 6C E8 26 F2 CB 90 A7 FC F1 FC 52 FF 11
0070 | AF AA A9 62 11 9D A6 E1 F0 35 84 85 12 AE 1E 38
0080 | DF 5E 69 6C 9B 93 69 5D B1 D7 2F DE 5A D4 14 4A
0090 | E7 5F D8 4D 50 9D A6 C4 7B 7D 2B 8B 07 F5 9F D4
00A0 | 3C AF A0 D9 51 E6 2C FD 53 AB 2C 9A B7 86 87 5D
00B0 | 8C 04 FC FB 1E 53 10 FC AF A8 D0 28 65 0B 1E E3
00C0 | B6 37 9D 63 21 71 0F 11 15 F1 B9 5E DC FF 95 F2
00D0 | BA 4D 45 AD 52 FB F8 24 0E 19 FE 07 20 56 AF 36
00E0 | DE DA 9E 56 D2 CD 3F A0 34 C9 9B 9F 43 F8 AE FC
00F0 | 5E 93 8A CA 2B D4 96 CB 16 51 74 C2 CF B8 0B 4B
0100 | 9D 5F C1 B8 E3 BA A6 45 1B 0F 6B D0 DE F5 F8 FB
0110 | 23 5F 6E D3 4E 3E A4 7C F1 A2 9F 70 0D 27 EB CE
0120 | C5 64 13 72 61 39 FB C9 13 38 42 EF CB 89 E2 E0
0130 | B8 19 2C E8 1A 53 62 C3 7F D6 2B 18 3C 0F 3D 03
0140 | 06 62 D7 6D 9F 23 D9 0A C0 4F 08 39 EA 84 AB 50
0150 | D3 DF 18 D9 38 A7 BF 66 EE 71 E6 BA 26 2C 4F 2D
0160 | E8 A1 7F DB 60 D6 4D 75 96 49 C1 EC F6 BF C5 91
0170 | 92 0F 78 8B 6C 0C FE BE 36 E5 08 E5 B9 DD C6 9E
0180 | 3D B2 54 C1 0D E9 45 76 FB 00 9E 03 46 AD 6D 8A
0190 | 7F 00 D4 4B 80 EE 02 48 4A 49 9D A7 77 E2 09 7D
01A0 | E7 0C 89 E6 0C 7B 64 50 AE CB 83 F7 D1 0E 44 78
01B0 | FE 52 39 AA 45 33 14 94 57 E9 A6 6D 93 7D 51 05
01C0 | 55 42 1A 64 42 00 D2 18 72 4F B7 57 09 A7 02 0D
01D0 | 4B 50 6C 40 4C 2B 15 4D 93 48 AF AC 32 AC D3 2B
01E0 | 11 1F B0 92 EE 58 85 04 5F BA 6D CF D6 96 F2 CB
01F0 | DF 43 98 03 C4 BE DB 4D 84 2E 3D 01 10 CF D8 D5
0200 | E5 2E 95 A6 3F 42 AD 92 7C 62 03 30 87 16 38 86
0210 | C8 ED 99 3B 64 B2 6F 2D D2 E3 C2 A6 CF 5C 8B DE
0220 | 98 59 D2 96 A5 AA 4C B9 82 16 51 CB 6D 9F A7 D5
0230 | 68 BE 3D 74 75 AB 5C B3 F4 E0 BD 45 E6 80 2E 1B
0240 | 76 47 DF A6 1C 0B EB 9B 07 80 42 C2 36 46 7C 40
0250 | 03 E9 D6 3F 66 E8 AF DE 52 15 EF 1B 72 AB 1F 6D
0260 | B8 2F C3 A5 5B F9 16 3E FF 20 6C 4E DB EB D4 91
0270 | 85 AE 63 7D F5 3F 8C DC 05 9C 01 D8 1B 54 3B 72
0280 | 9F 59 57 A4 C4 E7 9B B5 E9 75 34 BA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0110B7272C927C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>8C020000</code> (652 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002006853BE75B8EDC153E538C876</code> <code>A055645643297C47D5028E2C9404FE52</code> <code>D568F5841C405AABFDD03F6CE826F2CB</code> <code>90A7FCF1FC52FF11AFAAA962119DA6E1</code> <code>F035848512AE1E38DF5E696C9B93695D</code> <code>B1D72FDE5AD4144AE75FD84D509DA6C4</code> <code>7B7D2B8B07F59FD43CAFA0D951E62CFD</code> <code>53AB2C9AB786875D8C04FCFB1E5310FC</code> <code>AFA8D028650B1EE3B6379D6321710F11</code> <code>15F1B95EDCFF95F2BA4D45AD52FBF824</code> <code>0E19FE072056AF36DEDA9E56D2CD3FA0</code> <code>34C99B9F43F8AEFC5E938ACA2BD496CB</code> <code>165174C2CFB80B4B9D5FC1B8E3BAA645</code> <code>1B0F6BD0DEF5F8FB235F6ED34E3EA47C</code> <code>F1A29F700D27EBCEC56413726139FBC9</code> <code>133842EFCB89E2E0B8192CE81A5362C3</code> <code>7FD62B183C0F3D030662D76D9F23D90A</code> <code>C04F0839EA84AB50D3DF18D938A7BF66</code> <code>EE71E6BA262C4F2DE8A17FDB60D64D75</code> <code>9649C1ECF6BFC591920F788B6C0CFEBE</code> <code>36E508E5B9DDC69E3DB254C10DE94576</code> <code>FB009E0346AD6D8A7F00D44B80EE0248</code> <code>4A499DA777E2097DE70C89E60C7B6450</code> <code>AECB83F7D10E4478FE5239AA45331494</code> <code>57E9A66D937D510555421A644200D218</code> <code>724FB75709A7020D4B506C404C2B154D</code> <code>9348AFAC32ACD32B111FB092EE588504</code> <code>5FBA6DCFD696F2CBDF439803C4BEDB4D</code> <code>842E3D0110CFD8D5E52E95A63F42AD92</code> <code>7C62033087163886C8ED993B64B26F2D</code> <code>D2E3C2A6CF5C8BDE9859D296A5AA4CB9</code> <code>821651CB6D9FA7D568BE3D7475AB5CB3</code> <code>F4E0BD45E6802E1B7647DFA61C0BEB9B</code> <code>078042C236467C4003E9D63F66E8AFDE</code> <code>5215EF1B72AB1F6DB82FC3A55BF9163E</code> <code>FF206C4EDBEBD49185AE637DF53F8CDC</code> <code>059C01D81B543B729F5957A4C4E79BB5</code><br> <code>E97534BA</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 6853BE75B8EDC153E538C876A055645643297C47D5028E2C9404FE52D568F5841C405AABFDD03F6CE826F2CB90A7FCF1FC52FF11AFAAA962119DA6E1F035848512AE1E38DF5E696C9B93695DB1D72FDE5AD4144AE75FD84D509DA6C47B7D2B8B07F59FD43CAFA0D951E62CFD53AB2C9AB786875D8C04FCFB1E5310FCAFA8D028650B1EE3B6379D6321710F1115F1B95EDCFF95F2BA4D45AD52FBF8240E19FE072056AF36DEDA9E56D2CD3FA034C99B9F43F8AEFC5E938ACA2BD496CB165174C2CFB80B4B9D5FC1B8E3BAA6451B0F6BD0DEF5F8FB235F6ED34E3EA47CF1A29F700D27EBCEC56413726139FBC9133842EFCB89E2E0B8192CE81A5362C37FD62B183C0F3D030662D76D9F23D90AC04F0839EA84AB50D3DF18D938A7BF66EE71E6BA262C4F2DE8A17FDB60D64D759649C1ECF6BFC591920F788B6C0CFEBE36E508E5B9DDC69E3DB254C10DE94576FB009E0346AD6D8A7F00D44B80EE02484A499DA777E2097DE70C89E60C7B6450AECB83F7D10E4478FE5239AA4533149457E9A66D937D510555421A644200D218724FB75709A7020D4B506C404C2B154D9348AFAC32ACD32B111FB092EE5885045FBA6DCFD696F2CBDF439803C4BEDB4D842E3D0110CFD8D5E52E95A63F42AD927C62033087163886C8ED993B64B26F2DD2E3C2A6CF5C8BDE9859D296A5AA4CB9821651CB6D9FA7D568BE3D7475AB5CB3F4E0BD45E6802E1B7647DFA61C0BEB9B078042C236467C4003E9D63F66E8AFDE5215EF1B72AB1F6DB82FC3A55BF9163EFF206C4EDBEBD49185AE637DF53F8CDC059C01D81B543B729F5957A4C4E79BB5E97534BA
tmp_aes_key = D7DB3A5CBE76732E7C40207C176219F421EA89FC4406E027086FE19674F181B9
tmp_aes_iv = 310989E9F54E7C900B18180B9B0A370BF3FB82758A1EB8AFD94700BD607D7D78</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 2D5764EAAF98C1C588DD69F329786D18A15F8093BA0D89B5B5106580A853D8F8A3DF59C93461019913A6434CA0991F731CC7CDBCF561292703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BBCF36C7A84BA7DB516000161E761E173703460395A1DE26B8CE2EB69872E4969F8CEFC53C2BE9373F13DEE6F183E214CD2B98E205283DB29EEBB0E7320C62670CC115883E4D138075B99B1A275D7E015E321DAA419965C3A7FB8F6EDF10A94BC8015608BBFC2341415C3A27FE6E15821574ECDED063C8C0397FA0C2AABA45BCEACE6056A2CCA9BF87046D5B7C065DA3A38D15E25B702463176627A2CA1DEB0E0D58CEB178E2814DE5FF8948E721CEDE7759BE4CAE8A388BD52395897C97542AE030B47FB45D0E969F1EF15DA0D6EC1CEF6E1C16AB596659AEFD72E0006A766537B15099FF7875F1A1A7B52ED3AAC561C30455BC8F8E84C80CE2DD48ED9FCBCF2C927C651462563185EB3F5A
answer = BA0D89B5B5106580A853D8F8A3DF59C93461019913A6434CA0991F731CC7CDBCF561292703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BBCF36C7A84BA7DB516000161E761E173703460395A1DE26B8CE2EB69872E4969F8CEFC53C2BE9373F13DEE6F183E214CD2B98E205283DB29EEBB0E7320C62670CC115883E4D138075B99B1A275D7E015E321DAA419965C3A7FB8F6EDF10A94BC8015608BBFC2341415C3A27FE6E15821574ECDED063C8C0397FA0C2AABA45BCEACE6056A2CCA9BF87046D5B7C065DA3A38D15E25B702463176627A2CA1DEB0E0D58CEB178E2814DE5FF8948E721CEDE7759BE4CAE8A388BD52395897C97542AE030B47FB45D0E969F1EF15DA0D6EC1CEF6E1C16AB596659AEFD72E0006A766537B15099FF7875F1A1A7B52ED3AAC561C30455BC8F8E84C80CE2DD48ED9FCBCF2C927C651462563185EB3F5A</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 B5 10 65 80 A8 53 D8 F8 A3 DF 59 C9
0010 | 34 61 01 99 13 A6 43 4C A0 99 1F 73 1C C7 CD BC
0020 | F5 61 29 27 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | BB CF 36 C7 A8 4B A7 DB 51 60 00 16 1E 76 1E 17
0140 | 37 03 46 03 95 A1 DE 26 B8 CE 2E B6 98 72 E4 96
0150 | 9F 8C EF C5 3C 2B E9 37 3F 13 DE E6 F1 83 E2 14
0160 | CD 2B 98 E2 05 28 3D B2 9E EB B0 E7 32 0C 62 67
0170 | 0C C1 15 88 3E 4D 13 80 75 B9 9B 1A 27 5D 7E 01
0180 | 5E 32 1D AA 41 99 65 C3 A7 FB 8F 6E DF 10 A9 4B
0190 | C8 01 56 08 BB FC 23 41 41 5C 3A 27 FE 6E 15 82
01A0 | 15 74 EC DE D0 63 C8 C0 39 7F A0 C2 AA BA 45 BC
01B0 | EA CE 60 56 A2 CC A9 BF 87 04 6D 5B 7C 06 5D A3
01C0 | A3 8D 15 E2 5B 70 24 63 17 66 27 A2 CA 1D EB 0E
01D0 | 0D 58 CE B1 78 E2 81 4D E5 FF 89 48 E7 21 CE DE
01E0 | 77 59 BE 4C AE 8A 38 8B D5 23 95 89 7C 97 54 2A
01F0 | E0 30 B4 7F B4 5D 0E 96 9F 1E F1 5D A0 D6 EC 1C
0200 | EF 6E 1C 16 AB 59 66 59 AE FD 72 E0 00 6A 76 65
0210 | 37 B1 50 99 FF 78 75 F1 A1 A7 B5 2E D3 AA C5 61
0220 | C3 04 55 BC 8F 8E 84 C8 0C E2 DD 48 ED 9F CB CF
0230 | 2C 92 7C 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100BBCF36C7A84BA7DB51600016</code> <code>1E761E173703460395A1DE26B8CE2EB6</code> <code>9872E4969F8CEFC53C2BE9373F13DEE6</code> <code>F183E214CD2B98E205283DB29EEBB0E7</code> <code>320C62670CC115883E4D138075B99B1A</code> <code>275D7E015E321DAA419965C3A7FB8F6E</code> <code>DF10A94BC8015608BBFC2341415C3A27</code> <code>FE6E15821574ECDED063C8C0397FA0C2</code> <code>AABA45BCEACE6056A2CCA9BF87046D5B</code> <code>7C065DA3A38D15E25B702463176627A2</code> <code>CA1DEB0E0D58CEB178E2814DE5FF8948</code> <code>E721CEDE7759BE4CAE8A388BD5239589</code> <code>7C97542AE030B47FB45D0E969F1EF15D</code> <code>A0D6EC1CEF6E1C16AB596659AEFD72E0</code> <code>006A766537B15099FF7875F1A1A7B52E</code> <code>D3AAC561C30455BC8F8E84C80CE2DD48</code><br> <code>ED9FCBCF</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>2C927C65</code> (1702662700 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = F2976193DFBD361EBF298C2A30514DB377651FFAAD84F2C51C1EFF62470D5B630BA44A8BDF0B43017EC088F9C03AEA86B0D5B4E2DDDA81BE6D593995943312184DB37C27940A0FB3C89AAE477C7C54AECB3CB6CF0BE9DA3CAF37EF21C3D4907D58EDFCC45528F9EA33BB4492E44C99FBF647D36003A6E7FF822C4945E37A9F10E6D711F9AAB1EFBBA4A6889A458AFAF74ECE841F8D7D0FBAE154C055D38E8BC8E1793A9C68736E24AF144BC307368660B35AC492855D22B521A426C8D117DB6F1CF96AE0E7F35A38490B0996A417C81C4A2DE3B76710140D61D8934820B70A82C38CAD6AAEF52D85EB383E2BA07F4F642CED03BEFBB1D658795722DE4D0E4CC9</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B93CB28886BF50D0D125314DA548003F3389FF26261EA61C633291D403E99BF89CF1CCCB0B89BF62336AE5D6E0136E334B91BDBBE5FCF62604F1B15601E1B6415A24EE59BD35FE6AFCEDA11843201B0E55E393924E4D268C29C1CCF4F178651EA75B25A8CE0D5C8EB309D4FF4CA87590ABF3518522960685D876A310AF88A150974A8662BEFC93DA8DD01B31D31480A1C08A25B193A33A5F65ED9DB777ED681FF83E8A273A393D9CAF5618CE2B0D8D45D1CBC60C315D0740A3DA95C7062ED93E6B8E5C69CB559F9303F8D28D45FA616609A5E694C1A792627A7B759C160A9FFB2F87C0BC16306A4731FCABE6551C84A8A5313FBA02BA4CAC81530F1169BE3C48</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 B5 10 65 80 A8 53 D8 F8 A3 DF 59 C9
0010 | 34 61 01 99 13 A6 43 4C A0 99 1F 73 1C C7 CD BC
0020 | F5 61 29 27 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B9 3C B2 88 86 BF 50 D0 D1 25 31 4D A5 48 00 3F
0040 | 33 89 FF 26 26 1E A6 1C 63 32 91 D4 03 E9 9B F8
0050 | 9C F1 CC CB 0B 89 BF 62 33 6A E5 D6 E0 13 6E 33
0060 | 4B 91 BD BB E5 FC F6 26 04 F1 B1 56 01 E1 B6 41
0070 | 5A 24 EE 59 BD 35 FE 6A FC ED A1 18 43 20 1B 0E
0080 | 55 E3 93 92 4E 4D 26 8C 29 C1 CC F4 F1 78 65 1E
0090 | A7 5B 25 A8 CE 0D 5C 8E B3 09 D4 FF 4C A8 75 90
00A0 | AB F3 51 85 22 96 06 85 D8 76 A3 10 AF 88 A1 50
00B0 | 97 4A 86 62 BE FC 93 DA 8D D0 1B 31 D3 14 80 A1
00C0 | C0 8A 25 B1 93 A3 3A 5F 65 ED 9D B7 77 ED 68 1F
00D0 | F8 3E 8A 27 3A 39 3D 9C AF 56 18 CE 2B 0D 8D 45
00E0 | D1 CB C6 0C 31 5D 07 40 A3 DA 95 C7 06 2E D9 3E
00F0 | 6B 8E 5C 69 CB 55 9F 93 03 F8 D2 8D 45 FA 61 66
0100 | 09 A5 E6 94 C1 A7 92 62 7A 7B 75 9C 16 0A 9F FB
0110 | 2F 87 C0 BC 16 30 6A 47 31 FC AB E6 55 1C 84 A8
0120 | A5 31 3F BA 02 BA 4C AC 81 53 0F 11 69 BE 3C 48</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B93CB28886BF50D0D125314D</code> <code>A548003F3389FF26261EA61C633291D4</code> <code>03E99BF89CF1CCCB0B89BF62336AE5D6</code> <code>E0136E334B91BDBBE5FCF62604F1B156</code> <code>01E1B6415A24EE59BD35FE6AFCEDA118</code> <code>43201B0E55E393924E4D268C29C1CCF4</code> <code>F178651EA75B25A8CE0D5C8EB309D4FF</code> <code>4CA87590ABF3518522960685D876A310</code> <code>AF88A150974A8662BEFC93DA8DD01B31</code> <code>D31480A1C08A25B193A33A5F65ED9DB7</code> <code>77ED681FF83E8A273A393D9CAF5618CE</code> <code>2B0D8D45D1CBC60C315D0740A3DA95C7</code> <code>062ED93E6B8E5C69CB559F9303F8D28D</code> <code>45FA616609A5E694C1A792627A7B759C</code> <code>160A9FFB2F87C0BC16306A4731FCABE6</code> <code>551C84A8A5313FBA02BA4CAC81530F11</code><br> <code>69BE3C48</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366B5106580A853D8F8A3DF59C93461019913A6434CA0991F731CC7CDBCF56129270000000000000000FE000100B93CB28886BF50D0D125314DA548003F3389FF26261EA61C633291D403E99BF89CF1CCCB0B89BF62336AE5D6E0136E334B91BDBBE5FCF62604F1B15601E1B6415A24EE59BD35FE6AFCEDA11843201B0E55E393924E4D268C29C1CCF4F178651EA75B25A8CE0D5C8EB309D4FF4CA87590ABF3518522960685D876A310AF88A150974A8662BEFC93DA8DD01B31D31480A1C08A25B193A33A5F65ED9DB777ED681FF83E8A273A393D9CAF5618CE2B0D8D45D1CBC60C315D0740A3DA95C7062ED93E6B8E5C69CB559F9303F8D28D45FA616609A5E694C1A792627A7B759C160A9FFB2F87C0BC16306A4731FCABE6551C84A8A5313FBA02BA4CAC81530F1169BE3C48
padding = 88A5EC7B9D1ACCDDE4D55C97
tmp_aes_key = D7DB3A5CBE76732E7C40207C176219F421EA89FC4406E027086FE19674F181B9
tmp_aes_iv = 310989E9F54E7C900B18180B9B0A370BF3FB82758A1EB8AFD94700BD607D7D78</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 9AE28210D481850559F9A8DDE26B5A951BBFEC500B8747FD460189E5BCCB5CFC5FD36130B93AD988B83DB1BECD608D466583F59E6383AC5145BBBE621EB1F61D3FF2B8EBDC9063DC945B4D6BB89989A5D2009B71A59213EACA5E4FB91F710A41913C9C76136DF9941FF52993D1E0D03F6E291DF1297EE732FFAAEA1A1A9EFFC6A2085705DFD190A44D026A7DCA50AE62EBA9AABBDA358B282824D498F549AF553CDD6AFD59A5F6CE91A684AF00EC3B630EF95FC19A0BE9E397F41CB4199B5D2ECFDE1EFAE43017A3E039A7476257EC3492380793CBACBD82CEDD5376A6FA62868A8E72C3CEEF6F103837DF8ACEEE4BCDD059EBED16C1843EEFEC5958FB74E315EB5FED87D405483EDBF74A7D30DBBF78961776593BC780033789C7529B7CEFC24748A23885B9B1B024D4C072EDC2D38C1582B8A8C3AD14F34D1FF7273970C33158F005A15465BDBEADF97BFDA2ED2F8F</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 00 FB 04 00 2C 92 7C 65
0010 | 78 01 00 00 1F 5F 04 F5 B5 10 65 80 A8 53 D8 F8
0020 | A3 DF 59 C9 34 61 01 99 13 A6 43 4C A0 99 1F 73
0030 | 1C C7 CD BC F5 61 29 27 FE 50 01 00 9A E2 82 10
0040 | D4 81 85 05 59 F9 A8 DD E2 6B 5A 95 1B BF EC 50
0050 | 0B 87 47 FD 46 01 89 E5 BC CB 5C FC 5F D3 61 30
0060 | B9 3A D9 88 B8 3D B1 BE CD 60 8D 46 65 83 F5 9E
0070 | 63 83 AC 51 45 BB BE 62 1E B1 F6 1D 3F F2 B8 EB
0080 | DC 90 63 DC 94 5B 4D 6B B8 99 89 A5 D2 00 9B 71
0090 | A5 92 13 EA CA 5E 4F B9 1F 71 0A 41 91 3C 9C 76
00A0 | 13 6D F9 94 1F F5 29 93 D1 E0 D0 3F 6E 29 1D F1
00B0 | 29 7E E7 32 FF AA EA 1A 1A 9E FF C6 A2 08 57 05
00C0 | DF D1 90 A4 4D 02 6A 7D CA 50 AE 62 EB A9 AA BB
00D0 | DA 35 8B 28 28 24 D4 98 F5 49 AF 55 3C DD 6A FD
00E0 | 59 A5 F6 CE 91 A6 84 AF 00 EC 3B 63 0E F9 5F C1
00F0 | 9A 0B E9 E3 97 F4 1C B4 19 9B 5D 2E CF DE 1E FA
0100 | E4 30 17 A3 E0 39 A7 47 62 57 EC 34 92 38 07 93
0110 | CB AC BD 82 CE DD 53 76 A6 FA 62 86 8A 8E 72 C3
0120 | CE EF 6F 10 38 37 DF 8A CE EE 4B CD D0 59 EB ED
0130 | 16 C1 84 3E EF EC 59 58 FB 74 E3 15 EB 5F ED 87
0140 | D4 05 48 3E DB F7 4A 7D 30 DB BF 78 96 17 76 59
0150 | 3B C7 80 03 37 89 C7 52 9B 7C EF C2 47 48 A2 38
0160 | 85 B9 B1 B0 24 D4 C0 72 ED C2 D3 8C 15 82 B8 A8
0170 | C3 AD 14 F3 4D 1F F7 27 39 70 C3 31 58 F0 05 A1
0180 | 54 65 BD BE AD F9 7B FD A2 ED 2F 8F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>00FB04002C927C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001009AE28210D481850559F9A8DD</code> <code>E26B5A951BBFEC500B8747FD460189E5</code> <code>BCCB5CFC5FD36130B93AD988B83DB1BE</code> <code>CD608D466583F59E6383AC5145BBBE62</code> <code>1EB1F61D3FF2B8EBDC9063DC945B4D6B</code> <code>B89989A5D2009B71A59213EACA5E4FB9</code> <code>1F710A41913C9C76136DF9941FF52993</code> <code>D1E0D03F6E291DF1297EE732FFAAEA1A</code> <code>1A9EFFC6A2085705DFD190A44D026A7D</code> <code>CA50AE62EBA9AABBDA358B282824D498</code> <code>F549AF553CDD6AFD59A5F6CE91A684AF</code> <code>00EC3B630EF95FC19A0BE9E397F41CB4</code> <code>199B5D2ECFDE1EFAE43017A3E039A747</code> <code>6257EC3492380793CBACBD82CEDD5376</code> <code>A6FA62868A8E72C3CEEF6F103837DF8A</code> <code>CEEE4BCDD059EBED16C1843EEFEC5958</code> <code>FB74E315EB5FED87D405483EDBF74A7D</code> <code>30DBBF78961776593BC780033789C752</code> <code>9B7CEFC24748A23885B9B1B024D4C072</code> <code>EDC2D38C1582B8A8C3AD14F34D1FF727</code> <code>3970C33158F005A15465BDBEADF97BFD</code><br> <code>A2ED2F8F</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 239A20B68B5BCF933EC6CFBB35AD2B5EE54CA43951B6956CCCF49B0D7127E28785979FBA39D37F80AD00FA609DAAECB5CB06E6349275ECF665656FA96896E418507B9EA201FF5857EC8A502D87E89D68AC63DAAA2F83509E24E305DF98E4638BF3A42A620C304409CACF93BB3039C8049A2F4AD71800DD76F807D6C3C1C518E2D1F29597ED11458F2D3491F67BA9B9C2130C92F7073F3B50E3DDAA0347B76B4681A16E26FF47804CD62C81789493A811A3A6146B9687B2871C1320D9CD1541BD6A52D5FB795CDBC054D496E119120552096D214C1037C4DB9443FEFE7E13350A584454F8097C1119BF7459E5E65A1226F8C99D49CD7B80C0638840A8EE54B675</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 70 4C 06 2D 92 7C 65
0010 | 40 00 00 00 34 F7 CB 3B B5 10 65 80 A8 53 D8 F8
0020 | A3 DF 59 C9 34 61 01 99 13 A6 43 4C A0 99 1F 73
0030 | 1C C7 CD BC F5 61 29 27 EE D6 27 56 C4 2F 66 7A
0040 | 37 1D 1F F7 18 A6 79 0F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01704C062D927C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40000000</code> (64 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B5106580A853D8F8A3DF59C934610199</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>13A6434CA0991F731CC7CDBCF5612927</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>EED62756C42F667A371D1FF718A6790F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

