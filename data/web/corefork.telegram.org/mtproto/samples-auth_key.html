<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 FC 1A 0B 00 C2 BD 74 65
0010 | 14 00 00 00 F1 8E 7E BE 59 DE DF 5B B5 F9 3F E0
0020 | B8 6A A6 22 1D 70 B0 B9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>FC1A0B00C2BD7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 88 60 DF C2 BD 74 65
0010 | 74 00 00 00 63 24 16 05 59 DE DF 5B B5 F9 3F E0
0020 | B8 6A A6 22 1D 70 B0 B9 A1 E0 68 88 4F 45 FD C9
0030 | 74 BA A8 22 30 11 21 C3 08 1E 11 D1 2C 1F 19 BE
0040 | 5F 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018860DFC2BD7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>74000000</code> (116 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081E11D12C1F19BE5F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2166742883172466271</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2166742883172466271</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2166742883172466271 = 1471902331 * 1472069741</code></p>
<pre><code>p = 1471902331
q = 1472069741</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1E 11 D1 2C 1F 19 BE 5F 00 00 00
0010 | 04 57 BB 72 7B 00 00 00 04 57 BE 00 6D 00 00 00
0020 | 59 DE DF 5B B5 F9 3F E0 B8 6A A6 22 1D 70 B0 B9
0030 | A1 E0 68 88 4F 45 FD C9 74 BA A8 22 30 11 21 C3
0040 | 82 12 94 E3 32 7D E3 34 6E EF FD 0C DE 04 44 B4
0050 | 35 BF 03 7F EA FA C9 1A AB 5D E9 5F 97 ED CA CA
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081E11D12C1F19BE5F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2166742883172466271</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0457BB727B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1471902331</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0457BE006D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1472069741</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>821294E3327DE3346EEFFD0CDE0444B4</code> <code>35BF037FEAFAC91AAB5DE95F97EDCACA</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081E11D12C1F19BE5F0000000457BB727B0000000457BE006D00000059DEDF5BB5F93FE0B86AA6221D70B0B9A1E068884F45FDC974BAA822301121C3821294E3327DE3346EEFFD0CDE0444B435BF037FEAFAC91AAB5DE95F97EDCACA02000000
random_padding_bytes = C55B9974477A10A7027C992B4BA5294202137AD6A670EC64185288591D167A0CC5ED15F531E110AF842CC23E6B22BB831F95DA61214A0E97326876BE3FE0C35A34FB9D8599397DFB4CC35048AFA6A7D00C4D6054A46C15DC936C418A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 5140F776F0F0FAEE120254ED061871F5BB4608C0DA34E65A342C7968B407D8CBF841A7696ADC9CF6E45458D6981621232F59CB53EE98F5FD834F2531DD65CDA6AD59A4F9601B7A8F590FA182A39C80D3A7C2C1ED75192B1DB9E72D727F06CF4468B237EDF01C63D73763F961406B9A33DE0BB896F5E09623641F00CAEFBB8A50839D658991E7D86B3DF238E00C987C1446B746BAC21373DD0A93D2CBD4B0BE57BBE670E5AD00EEA0C0F30BA989EA6BF37FFEEC75D59BB932C010A8E5AC9572E9F86857763A47F226E8E2034D457697628350D21ED96A71F8172C2AF3086BADEBAAD85C776AC194F48A59F750DA63FA1CF4BCAA0587DE688C8FF9E84F5753C01D</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 80 7B 08 00 C3 BD 74 65
0010 | 40 01 00 00 BE E4 12 D7 59 DE DF 5B B5 F9 3F E0
0020 | B8 6A A6 22 1D 70 B0 B9 A1 E0 68 88 4F 45 FD C9
0030 | 74 BA A8 22 30 11 21 C3 04 57 BB 72 7B 00 00 00
0040 | 04 57 BE 00 6D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 51 40 F7 76 F0 F0 FA EE 12 02 54 ED
0060 | 06 18 71 F5 BB 46 08 C0 DA 34 E6 5A 34 2C 79 68
0070 | B4 07 D8 CB F8 41 A7 69 6A DC 9C F6 E4 54 58 D6
0080 | 98 16 21 23 2F 59 CB 53 EE 98 F5 FD 83 4F 25 31
0090 | DD 65 CD A6 AD 59 A4 F9 60 1B 7A 8F 59 0F A1 82
00A0 | A3 9C 80 D3 A7 C2 C1 ED 75 19 2B 1D B9 E7 2D 72
00B0 | 7F 06 CF 44 68 B2 37 ED F0 1C 63 D7 37 63 F9 61
00C0 | 40 6B 9A 33 DE 0B B8 96 F5 E0 96 23 64 1F 00 CA
00D0 | EF BB 8A 50 83 9D 65 89 91 E7 D8 6B 3D F2 38 E0
00E0 | 0C 98 7C 14 46 B7 46 BA C2 13 73 DD 0A 93 D2 CB
00F0 | D4 B0 BE 57 BB E6 70 E5 AD 00 EE A0 C0 F3 0B A9
0100 | 89 EA 6B F3 7F FE EC 75 D5 9B B9 32 C0 10 A8 E5
0110 | AC 95 72 E9 F8 68 57 76 3A 47 F2 26 E8 E2 03 4D
0120 | 45 76 97 62 83 50 D2 1E D9 6A 71 F8 17 2C 2A F3
0130 | 08 6B AD EB AA D8 5C 77 6A C1 94 F4 8A 59 F7 50
0140 | DA 63 FA 1C F4 BC AA 05 87 DE 68 8C 8F F9 E8 4F
0150 | 57 53 C0 1D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>807B0800C3BD7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0457BB727B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1471902331</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0457BE006D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1472069741</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001005140F776F0F0FAEE120254ED</code> <code>061871F5BB4608C0DA34E65A342C7968</code> <code>B407D8CBF841A7696ADC9CF6E45458D6</code> <code>981621232F59CB53EE98F5FD834F2531</code> <code>DD65CDA6AD59A4F9601B7A8F590FA182</code> <code>A39C80D3A7C2C1ED75192B1DB9E72D72</code> <code>7F06CF4468B237EDF01C63D73763F961</code> <code>406B9A33DE0BB896F5E09623641F00CA</code> <code>EFBB8A50839D658991E7D86B3DF238E0</code> <code>0C987C1446B746BAC21373DD0A93D2CB</code> <code>D4B0BE57BBE670E5AD00EEA0C0F30BA9</code> <code>89EA6BF37FFEEC75D59BB932C010A8E5</code> <code>AC9572E9F86857763A47F226E8E2034D</code> <code>457697628350D21ED96A71F8172C2AF3</code> <code>086BADEBAAD85C776AC194F48A59F750</code> <code>DA63FA1CF4BCAA0587DE688C8FF9E84F</code><br> <code>5753C01D</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 A7 9A C3 BD 74 65
0010 | 7C 02 00 00 5C 07 E8 D0 59 DE DF 5B B5 F9 3F E0
0020 | B8 6A A6 22 1D 70 B0 B9 A1 E0 68 88 4F 45 FD C9
0030 | 74 BA A8 22 30 11 21 C3 FE 50 02 00 4C 4E 4C A6
0040 | 13 FE 35 8D 63 35 DE 99 53 6B 1C 1F 07 AA 00 99
0050 | C1 EE 02 F9 CB 4D BE F2 E9 FC 75 39 43 6F 45 AE
0060 | D9 31 C9 62 A8 47 1F A1 26 C1 DA F2 9E 69 74 A0
0070 | D7 10 FA D5 60 DA 7E 89 B2 89 AE E5 CD 64 60 F7
0080 | 1B 8F A1 F3 66 04 16 BE E6 60 8C AE 10 39 FE 43
0090 | 0E C3 7B 61 64 95 67 51 CB 48 8C 47 33 1C CE AF
00A0 | 77 01 39 BD 96 B9 E8 2A A5 80 23 C8 60 14 95 8A
00B0 | C9 7C 42 8A 01 AD 79 7E AC 98 AE F0 92 E6 ED 77
00C0 | B7 22 2C 9C 3F 0F 30 62 3B 9B A6 C7 77 81 A5 FD
00D0 | 23 56 9E F9 56 6F 3B 15 9F 52 28 F1 1B 3C CE 5B
00E0 | 2C B3 04 B0 08 98 6B F1 AD 9B A6 83 2A EA 74 D1
00F0 | 1B 3F C8 80 13 36 7A 6A 65 7A F2 A1 40 6C 30 06
0100 | 7D 06 50 75 9A D9 C6 AB 0C E2 62 53 2A BD 3C 0E
0110 | A3 8C D8 58 E6 64 85 18 6B D0 4D E0 AD 29 FD 2F
0120 | C5 5F 30 C5 D3 AF A2 0D F5 34 A2 6D 7E F0 76 34
0130 | 84 17 BE E1 49 D6 91 F1 DA BE 87 63 C7 B9 E2 A0
0140 | C3 EE C2 28 15 EC 42 C1 C2 9F 80 A6 BA 73 87 E4
0150 | 26 60 12 09 4D 4B E8 38 7F AF 6E B9 86 49 A8 46
0160 | D8 9D B6 9E DA D7 9B 8A 0E D5 F2 56 2A 94 B9 06
0170 | 5B E8 82 A6 F0 D6 AB FE 96 44 61 4E 35 2E C3 73
0180 | 15 89 D3 CD 0C F3 96 0F 3D 9D C7 45 24 C8 34 84
0190 | A9 A2 5A E0 44 FE 1A 64 0D 1B E5 BD 23 82 88 76
01A0 | 60 37 55 56 68 D4 05 89 D2 3B E9 9E CE 04 80 2A
01B0 | 41 82 83 DE 27 83 CC 2E B2 41 BB E9 10 52 B5 19
01C0 | CC C4 A7 3F E0 52 F2 5A 77 45 16 A1 B7 CD 4D 5B
01D0 | 58 A1 F0 C4 C8 03 FF 45 63 77 8E 5F E3 72 C9 3D
01E0 | 3F AA 73 B8 E6 5D 59 9F 4B 15 1B 70 2E C8 26 DF
01F0 | 83 8F 90 64 21 14 19 D3 DD 93 90 EC 09 6F 79 13
0200 | 46 2B 36 A2 A2 FC 02 87 5A B0 9A BD F7 D9 BE 6E
0210 | 8B 29 E0 BC 42 25 ED 6A 45 63 DB A7 77 B4 98 C0
0220 | D5 90 59 46 A2 62 D4 C1 CE BB FD 3F 64 2B 17 35
0230 | 93 97 FC 0A A9 BA 38 F5 70 29 B4 F4 EC E8 8D 07
0240 | 79 45 C8 97 9C 8E 13 7A 98 68 B5 B3 7C 5A AF C4
0250 | EB 80 0F BD 27 49 4F A2 BE D9 17 78 F4 11 C4 F1
0260 | 08 B9 97 15 F8 F8 4D A8 9C CF 2D 84 D5 B2 F3 72
0270 | B0 2C 8F 1C D6 68 90 D3 D6 2B 80 7B E7 0C 25 E5
0280 | 78 D2 0B F6 14 4D 9C 49 BE B1 4C 35</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0158A79AC3BD7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>7C020000</code> (636 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002004C4E4CA613FE358D6335DE99</code> <code>536B1C1F07AA0099C1EE02F9CB4DBEF2</code> <code>E9FC7539436F45AED931C962A8471FA1</code> <code>26C1DAF29E6974A0D710FAD560DA7E89</code> <code>B289AEE5CD6460F71B8FA1F3660416BE</code> <code>E6608CAE1039FE430EC37B6164956751</code> <code>CB488C47331CCEAF770139BD96B9E82A</code> <code>A58023C86014958AC97C428A01AD797E</code> <code>AC98AEF092E6ED77B7222C9C3F0F3062</code> <code>3B9BA6C77781A5FD23569EF9566F3B15</code> <code>9F5228F11B3CCE5B2CB304B008986BF1</code> <code>AD9BA6832AEA74D11B3FC88013367A6A</code> <code>657AF2A1406C30067D0650759AD9C6AB</code> <code>0CE262532ABD3C0EA38CD858E6648518</code> <code>6BD04DE0AD29FD2FC55F30C5D3AFA20D</code> <code>F534A26D7EF076348417BEE149D691F1</code> <code>DABE8763C7B9E2A0C3EEC22815EC42C1</code> <code>C29F80A6BA7387E4266012094D4BE838</code> <code>7FAF6EB98649A846D89DB69EDAD79B8A</code> <code>0ED5F2562A94B9065BE882A6F0D6ABFE</code> <code>9644614E352EC3731589D3CD0CF3960F</code> <code>3D9DC74524C83484A9A25AE044FE1A64</code> <code>0D1BE5BD238288766037555668D40589</code> <code>D23BE99ECE04802A418283DE2783CC2E</code> <code>B241BBE91052B519CCC4A73FE052F25A</code> <code>774516A1B7CD4D5B58A1F0C4C803FF45</code> <code>63778E5FE372C93D3FAA73B8E65D599F</code> <code>4B151B702EC826DF838F9064211419D3</code> <code>DD9390EC096F7913462B36A2A2FC0287</code> <code>5AB09ABDF7D9BE6E8B29E0BC4225ED6A</code> <code>4563DBA777B498C0D5905946A262D4C1</code> <code>CEBBFD3F642B17359397FC0AA9BA38F5</code> <code>7029B4F4ECE88D077945C8979C8E137A</code> <code>9868B5B37C5AAFC4EB800FBD27494FA2</code> <code>BED91778F411C4F108B99715F8F84DA8</code> <code>9CCF2D84D5B2F372B02C8F1CD66890D3</code> <code>D62B807BE70C25E578D20BF6144D9C49</code><br> <code>BEB14C35</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 4C4E4CA613FE358D6335DE99536B1C1F07AA0099C1EE02F9CB4DBEF2E9FC7539436F45AED931C962A8471FA126C1DAF29E6974A0D710FAD560DA7E89B289AEE5CD6460F71B8FA1F3660416BEE6608CAE1039FE430EC37B6164956751CB488C47331CCEAF770139BD96B9E82AA58023C86014958AC97C428A01AD797EAC98AEF092E6ED77B7222C9C3F0F30623B9BA6C77781A5FD23569EF9566F3B159F5228F11B3CCE5B2CB304B008986BF1AD9BA6832AEA74D11B3FC88013367A6A657AF2A1406C30067D0650759AD9C6AB0CE262532ABD3C0EA38CD858E66485186BD04DE0AD29FD2FC55F30C5D3AFA20DF534A26D7EF076348417BEE149D691F1DABE8763C7B9E2A0C3EEC22815EC42C1C29F80A6BA7387E4266012094D4BE8387FAF6EB98649A846D89DB69EDAD79B8A0ED5F2562A94B9065BE882A6F0D6ABFE9644614E352EC3731589D3CD0CF3960F3D9DC74524C83484A9A25AE044FE1A640D1BE5BD238288766037555668D40589D23BE99ECE04802A418283DE2783CC2EB241BBE91052B519CCC4A73FE052F25A774516A1B7CD4D5B58A1F0C4C803FF4563778E5FE372C93D3FAA73B8E65D599F4B151B702EC826DF838F9064211419D3DD9390EC096F7913462B36A2A2FC02875AB09ABDF7D9BE6E8B29E0BC4225ED6A4563DBA777B498C0D5905946A262D4C1CEBBFD3F642B17359397FC0AA9BA38F57029B4F4ECE88D077945C8979C8E137A9868B5B37C5AAFC4EB800FBD27494FA2BED91778F411C4F108B99715F8F84DA89CCF2D84D5B2F372B02C8F1CD66890D3D62B807BE70C25E578D20BF6144D9C49BEB14C35
tmp_aes_key = 56B2C3E6BB7FBD59CA9178DF4059D3BCA25157272819D34C149366D1E04D9851
tmp_aes_iv = E5D580D8753E8E3F6E6C714C25CB0017D99976612AE7E8689500A2CE821294E3</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 6319F0BBD5C9431E73D83D3DD38E68C71C3871E7BA0D89B559DEDF5BB5F93FE0B86AA6221D70B0B9A1E068884F45FDC974BAA822301121C303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010003D66EDC067FE7D78DA60C9B3EA72A31D544C02611193B1F46D47894079C6676B664B6E9BFBAA93E33FBCD8AB19C34A40C4978023860571761E70DE143FCA1B6636B77845055964A2D27AE775074635E9BA4B29FD90ECF2F92B0534ED3252937566F4C8AFCDD398E718AF4E9817BA92B00EC39239E47DADCE4AA2ED8390816D89135D7168DEEC4E8C963B4D73AB479EF6E82E0FBD354968908C15F5FEA444431C54F8347A1A42CDAB57934EB56BF4010FD363399DAF51F72AFFF72D6A6B8D651A530B686B797DE062C9E5101C451187909FAC6A37303ABCAD08EC7F27ED9D176A9CF86574A94633C9126917470FF81BB4E45E9C39EB5FDA81C5BD45A84F53035C3BD7465BE17B117A77C665D
answer = BA0D89B559DEDF5BB5F93FE0B86AA6221D70B0B9A1E068884F45FDC974BAA822301121C303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010003D66EDC067FE7D78DA60C9B3EA72A31D544C02611193B1F46D47894079C6676B664B6E9BFBAA93E33FBCD8AB19C34A40C4978023860571761E70DE143FCA1B6636B77845055964A2D27AE775074635E9BA4B29FD90ECF2F92B0534ED3252937566F4C8AFCDD398E718AF4E9817BA92B00EC39239E47DADCE4AA2ED8390816D89135D7168DEEC4E8C963B4D73AB479EF6E82E0FBD354968908C15F5FEA444431C54F8347A1A42CDAB57934EB56BF4010FD363399DAF51F72AFFF72D6A6B8D651A530B686B797DE062C9E5101C451187909FAC6A37303ABCAD08EC7F27ED9D176A9CF86574A94633C9126917470FF81BB4E45E9C39EB5FDA81C5BD45A84F53035C3BD7465BE17B117A77C665D</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 59 DE DF 5B B5 F9 3F E0 B8 6A A6 22
0010 | 1D 70 B0 B9 A1 E0 68 88 4F 45 FD C9 74 BA A8 22
0020 | 30 11 21 C3 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 03 D6 6E DC 06 7F E7 D7 8D A6 0C 9B 3E A7 2A 31
0140 | D5 44 C0 26 11 19 3B 1F 46 D4 78 94 07 9C 66 76
0150 | B6 64 B6 E9 BF BA A9 3E 33 FB CD 8A B1 9C 34 A4
0160 | 0C 49 78 02 38 60 57 17 61 E7 0D E1 43 FC A1 B6
0170 | 63 6B 77 84 50 55 96 4A 2D 27 AE 77 50 74 63 5E
0180 | 9B A4 B2 9F D9 0E CF 2F 92 B0 53 4E D3 25 29 37
0190 | 56 6F 4C 8A FC DD 39 8E 71 8A F4 E9 81 7B A9 2B
01A0 | 00 EC 39 23 9E 47 DA DC E4 AA 2E D8 39 08 16 D8
01B0 | 91 35 D7 16 8D EE C4 E8 C9 63 B4 D7 3A B4 79 EF
01C0 | 6E 82 E0 FB D3 54 96 89 08 C1 5F 5F EA 44 44 31
01D0 | C5 4F 83 47 A1 A4 2C DA B5 79 34 EB 56 BF 40 10
01E0 | FD 36 33 99 DA F5 1F 72 AF FF 72 D6 A6 B8 D6 51
01F0 | A5 30 B6 86 B7 97 DE 06 2C 9E 51 01 C4 51 18 79
0200 | 09 FA C6 A3 73 03 AB CA D0 8E C7 F2 7E D9 D1 76
0210 | A9 CF 86 57 4A 94 63 3C 91 26 91 74 70 FF 81 BB
0220 | 4E 45 E9 C3 9E B5 FD A8 1C 5B D4 5A 84 F5 30 35
0230 | C3 BD 74 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010003D66EDC067FE7D78DA60C9B</code> <code>3EA72A31D544C02611193B1F46D47894</code> <code>079C6676B664B6E9BFBAA93E33FBCD8A</code> <code>B19C34A40C4978023860571761E70DE1</code> <code>43FCA1B6636B77845055964A2D27AE77</code> <code>5074635E9BA4B29FD90ECF2F92B0534E</code> <code>D3252937566F4C8AFCDD398E718AF4E9</code> <code>817BA92B00EC39239E47DADCE4AA2ED8</code> <code>390816D89135D7168DEEC4E8C963B4D7</code> <code>3AB479EF6E82E0FBD354968908C15F5F</code> <code>EA444431C54F8347A1A42CDAB57934EB</code> <code>56BF4010FD363399DAF51F72AFFF72D6</code> <code>A6B8D651A530B686B797DE062C9E5101</code> <code>C451187909FAC6A37303ABCAD08EC7F2</code> <code>7ED9D176A9CF86574A94633C91269174</code> <code>70FF81BB4E45E9C39EB5FDA81C5BD45A</code><br> <code>84F53035</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>C3BD7465</code> (1702149571 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 5878CC9BCEE0DE7CE9B439D6BE47F88C2B24F4F96ACE1F0C74143335813297DCC40BE82B54628A0C0C3623C0FCFA2453B255101ECD9C1226560F5F2BE832C726CF503B1AF394F557995F95B3EE94D965FFAF43FA862346E58FDC1D2802020E15BB97BE50F2FD7089832D4D0A6F54D4332444C817A4623A10438C633210D77E22AF91ACC18F6743D8E26840664C5B9EBD98ED5F1BED4CFD7439D8C5D872E76FA05AA5903A347262EC2D5D8948207DC0C6FF22A14DF9951CC6890BC9E7D8B51CDEEE509F2AE9DA418A155801B88EB87FF8A02A76159209FC4346EA27104996797D8D6090F7F6F4655C58F363C225E5BC532C1E278FC3C7E3EAD461893E37C66CD5</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B1952AB41F3302737E52EC2F611B34E444C09B1C21E4CF650E6C6683CB9E99F7EF0A2DB8B9C0268E857670D813E405C57D37C533699513F382D1579EC5B68182DB1C600B3665041247C98F05ADBFB44419CD8B986F268AD8E69993E0A6E9BB5AF9C8425BCDF5B8ADABFAA872D1B34195A8CE178C9353AEF8B8A59FC1C2616627842B86C83236B4E40EE86DCC960E4D08B3BAB54C183A9D8715DF0D9BF77EA110E08A6E9A11BDD93CE47C5059B2E9277A0CFC246B00896DCE82D3038E9033D92629643D63482BC5D1BA688A404A7D2753CFC0A4070B8845B505B233C22726D8A21C5E38760703746C245C7D35A3150724388798F4B8D86440D05EF43DE4BECB98</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 59 DE DF 5B B5 F9 3F E0 B8 6A A6 22
0010 | 1D 70 B0 B9 A1 E0 68 88 4F 45 FD C9 74 BA A8 22
0020 | 30 11 21 C3 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B1 95 2A B4 1F 33 02 73 7E 52 EC 2F 61 1B 34 E4
0040 | 44 C0 9B 1C 21 E4 CF 65 0E 6C 66 83 CB 9E 99 F7
0050 | EF 0A 2D B8 B9 C0 26 8E 85 76 70 D8 13 E4 05 C5
0060 | 7D 37 C5 33 69 95 13 F3 82 D1 57 9E C5 B6 81 82
0070 | DB 1C 60 0B 36 65 04 12 47 C9 8F 05 AD BF B4 44
0080 | 19 CD 8B 98 6F 26 8A D8 E6 99 93 E0 A6 E9 BB 5A
0090 | F9 C8 42 5B CD F5 B8 AD AB FA A8 72 D1 B3 41 95
00A0 | A8 CE 17 8C 93 53 AE F8 B8 A5 9F C1 C2 61 66 27
00B0 | 84 2B 86 C8 32 36 B4 E4 0E E8 6D CC 96 0E 4D 08
00C0 | B3 BA B5 4C 18 3A 9D 87 15 DF 0D 9B F7 7E A1 10
00D0 | E0 8A 6E 9A 11 BD D9 3C E4 7C 50 59 B2 E9 27 7A
00E0 | 0C FC 24 6B 00 89 6D CE 82 D3 03 8E 90 33 D9 26
00F0 | 29 64 3D 63 48 2B C5 D1 BA 68 8A 40 4A 7D 27 53
0100 | CF C0 A4 07 0B 88 45 B5 05 B2 33 C2 27 26 D8 A2
0110 | 1C 5E 38 76 07 03 74 6C 24 5C 7D 35 A3 15 07 24
0120 | 38 87 98 F4 B8 D8 64 40 D0 5E F4 3D E4 BE CB 98</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B1952AB41F3302737E52EC2F</code> <code>611B34E444C09B1C21E4CF650E6C6683</code> <code>CB9E99F7EF0A2DB8B9C0268E857670D8</code> <code>13E405C57D37C533699513F382D1579E</code> <code>C5B68182DB1C600B3665041247C98F05</code> <code>ADBFB44419CD8B986F268AD8E69993E0</code> <code>A6E9BB5AF9C8425BCDF5B8ADABFAA872</code> <code>D1B34195A8CE178C9353AEF8B8A59FC1</code> <code>C2616627842B86C83236B4E40EE86DCC</code> <code>960E4D08B3BAB54C183A9D8715DF0D9B</code> <code>F77EA110E08A6E9A11BDD93CE47C5059</code> <code>B2E9277A0CFC246B00896DCE82D3038E</code> <code>9033D92629643D63482BC5D1BA688A40</code> <code>4A7D2753CFC0A4070B8845B505B233C2</code> <code>2726D8A21C5E38760703746C245C7D35</code> <code>A3150724388798F4B8D86440D05EF43D</code><br> <code>E4BECB98</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436659DEDF5BB5F93FE0B86AA6221D70B0B9A1E068884F45FDC974BAA822301121C30000000000000000FE000100B1952AB41F3302737E52EC2F611B34E444C09B1C21E4CF650E6C6683CB9E99F7EF0A2DB8B9C0268E857670D813E405C57D37C533699513F382D1579EC5B68182DB1C600B3665041247C98F05ADBFB44419CD8B986F268AD8E69993E0A6E9BB5AF9C8425BCDF5B8ADABFAA872D1B34195A8CE178C9353AEF8B8A59FC1C2616627842B86C83236B4E40EE86DCC960E4D08B3BAB54C183A9D8715DF0D9BF77EA110E08A6E9A11BDD93CE47C5059B2E9277A0CFC246B00896DCE82D3038E9033D92629643D63482BC5D1BA688A404A7D2753CFC0A4070B8845B505B233C22726D8A21C5E38760703746C245C7D35A3150724388798F4B8D86440D05EF43DE4BECB98
padding = F69BBD80927115ACB89164D0
tmp_aes_key = 56B2C3E6BB7FBD59CA9178DF4059D3BCA25157272819D34C149366D1E04D9851
tmp_aes_iv = E5D580D8753E8E3F6E6C714C25CB0017D99976612AE7E8689500A2CE821294E3</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 23BC410D26E4C48F28548BC9B1590D266064D3F1E7CB4B06F34FBB73CE3B45713EDEFCECA538578403B8D06ED2CBA2B7EEB2B105CCF468AC8456B602B38602DB37AEF13D3CA9BCB9867BED2C1FA91B5D652D871D2EA71427640CA2BCE82D02578FE43DA39BAA56150D51EDBEACD86090840DABA6DC72265CB49616FB225F5DBB7E6E8C2C3543B7BBAB26B56C3931323C5BD47212B1F2B35471D4E304491A6D4EDC00049DC66176D670F69BB1E1442AD7C6110DCBE3A4AAFBB4A167BECAC2916B91F292C8084251DA204F83E9B3A2CE9E03456D472019F5555AC6BA4E9285FF96536FB7AB369BBBDA7D0AD5C493680EDAE8157DD4313DB2CC6DE351C04B355E39579757E0828598ECCB519E52B4D04AD6C73CE656EB2DC4D76A53F527DEC8ABAF3B71DA1F83D17EB7D0D430CBFE9ACAFA23565A3064EEEAEDCB24EBA89320FAF3F5B90FCEE999AF857EF25AA6E274972D</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 04 3E 0B 00 C3 BD 74 65
0010 | 78 01 00 00 1F 5F 04 F5 59 DE DF 5B B5 F9 3F E0
0020 | B8 6A A6 22 1D 70 B0 B9 A1 E0 68 88 4F 45 FD C9
0030 | 74 BA A8 22 30 11 21 C3 FE 50 01 00 23 BC 41 0D
0040 | 26 E4 C4 8F 28 54 8B C9 B1 59 0D 26 60 64 D3 F1
0050 | E7 CB 4B 06 F3 4F BB 73 CE 3B 45 71 3E DE FC EC
0060 | A5 38 57 84 03 B8 D0 6E D2 CB A2 B7 EE B2 B1 05
0070 | CC F4 68 AC 84 56 B6 02 B3 86 02 DB 37 AE F1 3D
0080 | 3C A9 BC B9 86 7B ED 2C 1F A9 1B 5D 65 2D 87 1D
0090 | 2E A7 14 27 64 0C A2 BC E8 2D 02 57 8F E4 3D A3
00A0 | 9B AA 56 15 0D 51 ED BE AC D8 60 90 84 0D AB A6
00B0 | DC 72 26 5C B4 96 16 FB 22 5F 5D BB 7E 6E 8C 2C
00C0 | 35 43 B7 BB AB 26 B5 6C 39 31 32 3C 5B D4 72 12
00D0 | B1 F2 B3 54 71 D4 E3 04 49 1A 6D 4E DC 00 04 9D
00E0 | C6 61 76 D6 70 F6 9B B1 E1 44 2A D7 C6 11 0D CB
00F0 | E3 A4 AA FB B4 A1 67 BE CA C2 91 6B 91 F2 92 C8
0100 | 08 42 51 DA 20 4F 83 E9 B3 A2 CE 9E 03 45 6D 47
0110 | 20 19 F5 55 5A C6 BA 4E 92 85 FF 96 53 6F B7 AB
0120 | 36 9B BB DA 7D 0A D5 C4 93 68 0E DA E8 15 7D D4
0130 | 31 3D B2 CC 6D E3 51 C0 4B 35 5E 39 57 97 57 E0
0140 | 82 85 98 EC CB 51 9E 52 B4 D0 4A D6 C7 3C E6 56
0150 | EB 2D C4 D7 6A 53 F5 27 DE C8 AB AF 3B 71 DA 1F
0160 | 83 D1 7E B7 D0 D4 30 CB FE 9A CA FA 23 56 5A 30
0170 | 64 EE EA ED CB 24 EB A8 93 20 FA F3 F5 B9 0F CE
0180 | E9 99 AF 85 7E F2 5A A6 E2 74 97 2D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>043E0B00C3BD7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010023BC410D26E4C48F28548BC9</code> <code>B1590D266064D3F1E7CB4B06F34FBB73</code> <code>CE3B45713EDEFCECA538578403B8D06E</code> <code>D2CBA2B7EEB2B105CCF468AC8456B602</code> <code>B38602DB37AEF13D3CA9BCB9867BED2C</code> <code>1FA91B5D652D871D2EA71427640CA2BC</code> <code>E82D02578FE43DA39BAA56150D51EDBE</code> <code>ACD86090840DABA6DC72265CB49616FB</code> <code>225F5DBB7E6E8C2C3543B7BBAB26B56C</code> <code>3931323C5BD47212B1F2B35471D4E304</code> <code>491A6D4EDC00049DC66176D670F69BB1</code> <code>E1442AD7C6110DCBE3A4AAFBB4A167BE</code> <code>CAC2916B91F292C8084251DA204F83E9</code> <code>B3A2CE9E03456D472019F5555AC6BA4E</code> <code>9285FF96536FB7AB369BBBDA7D0AD5C4</code> <code>93680EDAE8157DD4313DB2CC6DE351C0</code> <code>4B355E39579757E0828598ECCB519E52</code> <code>B4D04AD6C73CE656EB2DC4D76A53F527</code> <code>DEC8ABAF3B71DA1F83D17EB7D0D430CB</code> <code>FE9ACAFA23565A3064EEEAEDCB24EBA8</code> <code>9320FAF3F5B90FCEE999AF857EF25AA6</code><br> <code>E274972D</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 29D550452738C5D5243D21EEF71D21FFB93F3AB03938FACB83CFA34E19D9614E53A7780CA95FF9A9D94E2301DF8B5C06B1488F80B8CC20E1ABFC68DA7E85CA8893E778577D643CC2E615C186FE195B99A89A3C696D3525A3E186466AB768D246B1D16B360029B13DE4AC41550B97C44AAB0F81BF17AD50FBE38838631660BE90D714BDA7F93E2D8EBC0970D8A303C7F80E4953B58792675D93E59DB40FDAABA5D109B8FCF767E61729DE4712D5C7ACECF9E1ED065280970790394C27E9E1E9BDFDAF331E8646708ADB1502159D3138E77F66E12D9BAA05DA564E14A3694BE7059542819B8EF77CFC232F51DC9BE17BC9C6B099AC2536DB26F67F89C0FFF8E513</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D8 94 E3 C3 BD 74 65
0010 | 78 00 00 00 34 F7 CB 3B 59 DE DF 5B B5 F9 3F E0
0020 | B8 6A A6 22 1D 70 B0 B9 A1 E0 68 88 4F 45 FD C9
0030 | 74 BA A8 22 30 11 21 C3 75 CE EC A7 57 B5 1E 32
0040 | 54 6F 1A 52 29 5E 13 ED</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D894E3C3BD7465</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78000000</code> (120 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59DEDF5BB5F93FE0B86AA6221D70B0B9</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1E068884F45FDC974BAA822301121C3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>75CEECA757B51E32546F1A52295E13ED</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

