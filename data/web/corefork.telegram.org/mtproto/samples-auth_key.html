<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F4 28 09 00 69 A7 7C 65
0010 | 14 00 00 00 F1 8E 7E BE EB 7B 0E A1 99 7D 01 79
0020 | D5 4F 04 D1 19 D1 05 5C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F428090069A77C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 FC EC 69 A7 7C 65
0010 | 68 00 00 00 63 24 16 05 EB 7B 0E A1 99 7D 01 79
0020 | D5 4F 04 D1 19 D1 05 5C A2 A0 68 94 28 07 FB E9
0030 | C4 16 81 0B EB 9E 03 A5 08 17 33 04 C8 68 FF 9C
0040 | 49 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0198FCEC69A77C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>68000000</code> (104 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08173304C868FF9C49000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1671685145486138441</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1671685145486138441</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1671685145486138441 = 1001973023 * 1668393367</code></p>
<pre><code>p = 1001973023
q = 1668393367</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 17 33 04 C8 68 FF 9C 49 00 00 00
0010 | 04 3B B8 E5 1F 00 00 00 04 63 71 A9 97 00 00 00
0020 | EB 7B 0E A1 99 7D 01 79 D5 4F 04 D1 19 D1 05 5C
0030 | A2 A0 68 94 28 07 FB E9 C4 16 81 0B EB 9E 03 A5
0040 | 59 61 30 91 F7 07 20 AB EB EC 07 3D 42 34 C7 E9
0050 | 2E 0F 7F 43 4E 0F 4F E0 89 76 6C A2 1C 78 CD C5
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08173304C868FF9C49000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1671685145486138441</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043BB8E51F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1001973023</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046371A997000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1668393367</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>59613091F70720ABEBEC073D4234C7E9</code> <code>2E0F7F434E0F4FE089766CA21C78CDC5</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908173304C868FF9C49000000043BB8E51F000000046371A997000000EB7B0EA1997D0179D54F04D119D1055CA2A068942807FBE9C416810BEB9E03A559613091F70720ABEBEC073D4234C7E92E0F7F434E0F4FE089766CA21C78CDC502000000
random_padding_bytes = EEBA3434C615134553B00DEBC46195C1D0833963B2B736022F75318140EBA79B9BF83873FA62D857C6F9B7E5F07C9A71456AAC7600BBDE8ED9C830B28799E545763B4135C331083D670E9B3E7289F16C49B52A390D32AAEA182CADF9</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = AA967CA705CCFF5B80D6E998E12EFBEC9FCAF190CF0CD6068B00B8C2E52AEC6FC2F4CC7E8FF7F47BAD0EF80C08AFD28BF6F707E245A6D6FB7CBF71EC0E178FA5919BCF17ABD386CD5A710D8034607FE150A3CD50140826C26B3F80779B08C6D955CF09D5B9555412286D4D62B6EFEA9E744AEC9F89732D318F2C0DF4D48414B06B75B7708E743AA52A8D58F35817D8CB3CD158B7E093F9E763D6847F49B33E92B771673D2CC2F15DC6D2EF708A83C79295068F2C64B3D91D7914B8863A5C1C479ACFADFF7F5A98C5CCE637F33900EA1042A44AAC1111E18C1F9514FD260D309AD8C8D9AC1D9D1E8EC305D30F733767C29E8E40DE6E5C01F9B84874FB25BD6675</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 DF 09 00 69 A7 7C 65
0010 | 40 01 00 00 BE E4 12 D7 EB 7B 0E A1 99 7D 01 79
0020 | D5 4F 04 D1 19 D1 05 5C A2 A0 68 94 28 07 FB E9
0030 | C4 16 81 0B EB 9E 03 A5 04 3B B8 E5 1F 00 00 00
0040 | 04 63 71 A9 97 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 AA 96 7C A7 05 CC FF 5B 80 D6 E9 98
0060 | E1 2E FB EC 9F CA F1 90 CF 0C D6 06 8B 00 B8 C2
0070 | E5 2A EC 6F C2 F4 CC 7E 8F F7 F4 7B AD 0E F8 0C
0080 | 08 AF D2 8B F6 F7 07 E2 45 A6 D6 FB 7C BF 71 EC
0090 | 0E 17 8F A5 91 9B CF 17 AB D3 86 CD 5A 71 0D 80
00A0 | 34 60 7F E1 50 A3 CD 50 14 08 26 C2 6B 3F 80 77
00B0 | 9B 08 C6 D9 55 CF 09 D5 B9 55 54 12 28 6D 4D 62
00C0 | B6 EF EA 9E 74 4A EC 9F 89 73 2D 31 8F 2C 0D F4
00D0 | D4 84 14 B0 6B 75 B7 70 8E 74 3A A5 2A 8D 58 F3
00E0 | 58 17 D8 CB 3C D1 58 B7 E0 93 F9 E7 63 D6 84 7F
00F0 | 49 B3 3E 92 B7 71 67 3D 2C C2 F1 5D C6 D2 EF 70
0100 | 8A 83 C7 92 95 06 8F 2C 64 B3 D9 1D 79 14 B8 86
0110 | 3A 5C 1C 47 9A CF AD FF 7F 5A 98 C5 CC E6 37 F3
0120 | 39 00 EA 10 42 A4 4A AC 11 11 E1 8C 1F 95 14 FD
0130 | 26 0D 30 9A D8 C8 D9 AC 1D 9D 1E 8E C3 05 D3 0F
0140 | 73 37 67 C2 9E 8E 40 DE 6E 5C 01 F9 B8 48 74 FB
0150 | 25 BD 66 75</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E4DF090069A77C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043BB8E51F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1001973023</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046371A997000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1668393367</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100AA967CA705CCFF5B80D6E998</code> <code>E12EFBEC9FCAF190CF0CD6068B00B8C2</code> <code>E52AEC6FC2F4CC7E8FF7F47BAD0EF80C</code> <code>08AFD28BF6F707E245A6D6FB7CBF71EC</code> <code>0E178FA5919BCF17ABD386CD5A710D80</code> <code>34607FE150A3CD50140826C26B3F8077</code> <code>9B08C6D955CF09D5B9555412286D4D62</code> <code>B6EFEA9E744AEC9F89732D318F2C0DF4</code> <code>D48414B06B75B7708E743AA52A8D58F3</code> <code>5817D8CB3CD158B7E093F9E763D6847F</code> <code>49B33E92B771673D2CC2F15DC6D2EF70</code> <code>8A83C79295068F2C64B3D91D7914B886</code> <code>3A5C1C479ACFADFF7F5A98C5CCE637F3</code> <code>3900EA1042A44AAC1111E18C1F9514FD</code> <code>260D309AD8C8D9AC1D9D1E8EC305D30F</code> <code>733767C29E8E40DE6E5C01F9B84874FB</code><br> <code>25BD6675</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 40 22 8C 6A A7 7C 65
0010 | C0 02 00 00 5C 07 E8 D0 EB 7B 0E A1 99 7D 01 79
0020 | D5 4F 04 D1 19 D1 05 5C A2 A0 68 94 28 07 FB E9
0030 | C4 16 81 0B EB 9E 03 A5 FE 50 02 00 9A B0 EB E5
0040 | 7A 4B 51 3D 05 82 8B A8 6C 21 B5 D2 EE 7E B0 E9
0050 | DF 94 CB 93 FB C8 1D AC 0F FF 3C DA 22 72 CB 69
0060 | 00 13 29 7B C0 41 AF 6E 53 6C 36 4E 8C 40 79 D4
0070 | 96 46 DD 0A 26 63 0A 2B 24 AA 65 5F 39 F9 1D C2
0080 | 5D 9A 70 CE E6 0F 21 96 2D 8F C0 3A F5 7E 01 6A
0090 | F4 FF 70 71 E1 E2 81 AD FF A9 E7 44 E0 5F 3E D2
00A0 | F7 00 21 5C 9B 57 DD 3E D2 91 8F 45 59 6A 0F BC
00B0 | 90 DC 7C F5 17 57 45 2E 0B 74 98 31 50 34 CC 30
00C0 | 23 BF 5C E3 20 CF F2 77 B3 72 EE F7 53 5F 5D 98
00D0 | A1 D0 60 87 C1 CE DC 1E FA 28 2C 49 1D 72 59 C7
00E0 | 7F F0 1C 74 3F 6D E1 FA 52 C3 04 A9 6C 42 C6 DF
00F0 | AE B7 E0 EA CA 90 0C D0 A3 86 6E F0 44 8D 27 18
0100 | C1 EF 65 A9 81 95 E0 2A 32 E6 F7 36 31 8C DC 2A
0110 | 36 39 41 98 A0 4B DB BE F3 E0 03 69 A0 DA D4 60
0120 | 04 55 D7 B7 6F BF 2A 13 4C 36 92 E6 D1 E7 9B 7E
0130 | 89 DD DC 1E B8 E0 40 9B 9F E0 61 C9 66 AE 90 15
0140 | FD 9C 46 A6 B8 70 93 E3 0E 77 43 9C A7 88 88 19
0150 | E7 70 C5 A4 EE C7 5F D2 32 09 6B D1 57 43 28 BE
0160 | 93 82 BF 29 73 40 A1 5C 23 56 9A B1 5E 3C 77 4F
0170 | 30 5F 72 09 9F CE 24 BF B5 F2 63 12 CC 9F 9E 88
0180 | 8E 83 01 A1 4E D9 01 35 C6 98 01 E4 DB A7 29 53
0190 | BE 45 FD F5 13 7C 1F 2E 8C CE D7 63 52 47 A6 52
01A0 | 62 E8 F3 34 04 35 54 53 CE 99 73 6A ED B6 81 93
01B0 | F5 F6 25 5E 6B 51 93 02 0F A4 DE A5 E3 9A 77 6C
01C0 | C8 05 E3 BD 0E 6A EE 1D 36 83 5B 55 68 D0 10 C6
01D0 | 3F 54 88 98 8A CE F9 8F E0 2A 8F 4D E0 98 01 B7
01E0 | 20 F6 9B 2E E3 19 A8 A4 A2 5B 8C 7F 3B B5 EC 44
01F0 | FB 7E AB 1E 9F CF 16 3D B0 36 D2 DF 90 39 6B 6A
0200 | AD 7F 03 60 CE 9D CC E1 1E C0 E7 AD D5 C3 14 65
0210 | DC 64 23 91 90 C9 02 2A B2 90 D1 D8 00 A0 82 9C
0220 | 60 F9 F3 4D EE 7B 9F FF D7 46 46 8B 4B 87 F4 4B
0230 | 75 17 3F 5A 1C A1 23 27 23 2E 12 0E B4 63 54 1C
0240 | 13 36 29 F0 7A AF BF 80 1F 15 B7 58 5D 8F 7D ED
0250 | 8F 3F 9A 2D DA E1 C9 30 7F ED 77 D7 A4 3E DC 5C
0260 | C7 C3 6C C8 0C B4 DD 2E 43 9F AB 2E 69 78 D5 43
0270 | 5D 21 90 11 54 2D C2 9D 44 4F D2 6A 91 18 04 40
0280 | C0 8F DA B1 F1 96 FB B4 5E 54 29 DB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0140228C6AA77C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C0020000</code> (704 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002009AB0EBE57A4B513D05828BA8</code> <code>6C21B5D2EE7EB0E9DF94CB93FBC81DAC</code> <code>0FFF3CDA2272CB690013297BC041AF6E</code> <code>536C364E8C4079D49646DD0A26630A2B</code> <code>24AA655F39F91DC25D9A70CEE60F2196</code> <code>2D8FC03AF57E016AF4FF7071E1E281AD</code> <code>FFA9E744E05F3ED2F700215C9B57DD3E</code> <code>D2918F45596A0FBC90DC7CF51757452E</code> <code>0B7498315034CC3023BF5CE320CFF277</code> <code>B372EEF7535F5D98A1D06087C1CEDC1E</code> <code>FA282C491D7259C77FF01C743F6DE1FA</code> <code>52C304A96C42C6DFAEB7E0EACA900CD0</code> <code>A3866EF0448D2718C1EF65A98195E02A</code> <code>32E6F736318CDC2A36394198A04BDBBE</code> <code>F3E00369A0DAD4600455D7B76FBF2A13</code> <code>4C3692E6D1E79B7E89DDDC1EB8E0409B</code> <code>9FE061C966AE9015FD9C46A6B87093E3</code> <code>0E77439CA7888819E770C5A4EEC75FD2</code> <code>32096BD1574328BE9382BF297340A15C</code> <code>23569AB15E3C774F305F72099FCE24BF</code> <code>B5F26312CC9F9E888E8301A14ED90135</code> <code>C69801E4DBA72953BE45FDF5137C1F2E</code> <code>8CCED7635247A65262E8F33404355453</code> <code>CE99736AEDB68193F5F6255E6B519302</code> <code>0FA4DEA5E39A776CC805E3BD0E6AEE1D</code> <code>36835B5568D010C63F5488988ACEF98F</code> <code>E02A8F4DE09801B720F69B2EE319A8A4</code> <code>A25B8C7F3BB5EC44FB7EAB1E9FCF163D</code> <code>B036D2DF90396B6AAD7F0360CE9DCCE1</code> <code>1EC0E7ADD5C31465DC64239190C9022A</code> <code>B290D1D800A0829C60F9F34DEE7B9FFF</code> <code>D746468B4B87F44B75173F5A1CA12327</code> <code>232E120EB463541C133629F07AAFBF80</code> <code>1F15B7585D8F7DED8F3F9A2DDAE1C930</code> <code>7FED77D7A43EDC5CC7C36CC80CB4DD2E</code> <code>439FAB2E6978D5435D219011542DC29D</code> <code>444FD26A91180440C08FDAB1F196FBB4</code><br> <code>5E5429DB</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 9AB0EBE57A4B513D05828BA86C21B5D2EE7EB0E9DF94CB93FBC81DAC0FFF3CDA2272CB690013297BC041AF6E536C364E8C4079D49646DD0A26630A2B24AA655F39F91DC25D9A70CEE60F21962D8FC03AF57E016AF4FF7071E1E281ADFFA9E744E05F3ED2F700215C9B57DD3ED2918F45596A0FBC90DC7CF51757452E0B7498315034CC3023BF5CE320CFF277B372EEF7535F5D98A1D06087C1CEDC1EFA282C491D7259C77FF01C743F6DE1FA52C304A96C42C6DFAEB7E0EACA900CD0A3866EF0448D2718C1EF65A98195E02A32E6F736318CDC2A36394198A04BDBBEF3E00369A0DAD4600455D7B76FBF2A134C3692E6D1E79B7E89DDDC1EB8E0409B9FE061C966AE9015FD9C46A6B87093E30E77439CA7888819E770C5A4EEC75FD232096BD1574328BE9382BF297340A15C23569AB15E3C774F305F72099FCE24BFB5F26312CC9F9E888E8301A14ED90135C69801E4DBA72953BE45FDF5137C1F2E8CCED7635247A65262E8F33404355453CE99736AEDB68193F5F6255E6B5193020FA4DEA5E39A776CC805E3BD0E6AEE1D36835B5568D010C63F5488988ACEF98FE02A8F4DE09801B720F69B2EE319A8A4A25B8C7F3BB5EC44FB7EAB1E9FCF163DB036D2DF90396B6AAD7F0360CE9DCCE11EC0E7ADD5C31465DC64239190C9022AB290D1D800A0829C60F9F34DEE7B9FFFD746468B4B87F44B75173F5A1CA12327232E120EB463541C133629F07AAFBF801F15B7585D8F7DED8F3F9A2DDAE1C9307FED77D7A43EDC5CC7C36CC80CB4DD2E439FAB2E6978D5435D219011542DC29D444FD26A91180440C08FDAB1F196FBB45E5429DB
tmp_aes_key = 275B889088CE5A26C0BF451502C89FD28FD1F257E0AFDC0EAA03CC8E5CDC8131
tmp_aes_iv = 05B14F80F5EE413FB9958A0817559888C2207326A7F9A475C35190E259613091</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = CD1B709CE6CE16DDB05CA4CCA51D8C2C532F5BDBBA0D89B5EB7B0EA1997D0179D54F04D119D1055CA2A068942807FBE9C416810BEB9E03A503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000A3A669963FCB029A3DFE3D4492EA38E7A07D609E46EE5E600FAED40994C123FBB8015820517944911A2CC7A0199F9400A7A5AC71456AF6058BCF00615AFF2A14032D4E26664345006CCD1994171372517817479213F7C79EC2AF7BBE73406F41C1B2BA8F3030F4F8DC6A51D735FE352F47A7CC31F8BEC90C620CC30435C8E8E0AFFA24634E7417302D662D179A7B493FD071C4302707B5C38234845F332050F17946B8DCE573AC3DBD36EABEDBA1B4753672E66493F49951B0E8BE928F476BA2A7EE58E3C5DCCFC0ACDD6DF4CF7E15121CDBEC2BFC3AA1D9A158DE9E18C2857F29324E1A8191B082C7E13DDA1B080ECBB7FF443880EF287EBADC2037F82C6726AA77C652EBC83D6F26C0818
answer = BA0D89B5EB7B0EA1997D0179D54F04D119D1055CA2A068942807FBE9C416810BEB9E03A503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000A3A669963FCB029A3DFE3D4492EA38E7A07D609E46EE5E600FAED40994C123FBB8015820517944911A2CC7A0199F9400A7A5AC71456AF6058BCF00615AFF2A14032D4E26664345006CCD1994171372517817479213F7C79EC2AF7BBE73406F41C1B2BA8F3030F4F8DC6A51D735FE352F47A7CC31F8BEC90C620CC30435C8E8E0AFFA24634E7417302D662D179A7B493FD071C4302707B5C38234845F332050F17946B8DCE573AC3DBD36EABEDBA1B4753672E66493F49951B0E8BE928F476BA2A7EE58E3C5DCCFC0ACDD6DF4CF7E15121CDBEC2BFC3AA1D9A158DE9E18C2857F29324E1A8191B082C7E13DDA1B080ECBB7FF443880EF287EBADC2037F82C6726AA77C652EBC83D6F26C0818</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 EB 7B 0E A1 99 7D 01 79 D5 4F 04 D1
0010 | 19 D1 05 5C A2 A0 68 94 28 07 FB E9 C4 16 81 0B
0020 | EB 9E 03 A5 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 0A 3A 66 99 63 FC B0 29 A3 DF E3 D4 49 2E A3 8E
0140 | 7A 07 D6 09 E4 6E E5 E6 00 FA ED 40 99 4C 12 3F
0150 | BB 80 15 82 05 17 94 49 11 A2 CC 7A 01 99 F9 40
0160 | 0A 7A 5A C7 14 56 AF 60 58 BC F0 06 15 AF F2 A1
0170 | 40 32 D4 E2 66 64 34 50 06 CC D1 99 41 71 37 25
0180 | 17 81 74 79 21 3F 7C 79 EC 2A F7 BB E7 34 06 F4
0190 | 1C 1B 2B A8 F3 03 0F 4F 8D C6 A5 1D 73 5F E3 52
01A0 | F4 7A 7C C3 1F 8B EC 90 C6 20 CC 30 43 5C 8E 8E
01B0 | 0A FF A2 46 34 E7 41 73 02 D6 62 D1 79 A7 B4 93
01C0 | FD 07 1C 43 02 70 7B 5C 38 23 48 45 F3 32 05 0F
01D0 | 17 94 6B 8D CE 57 3A C3 DB D3 6E AB ED BA 1B 47
01E0 | 53 67 2E 66 49 3F 49 95 1B 0E 8B E9 28 F4 76 BA
01F0 | 2A 7E E5 8E 3C 5D CC FC 0A CD D6 DF 4C F7 E1 51
0200 | 21 CD BE C2 BF C3 AA 1D 9A 15 8D E9 E1 8C 28 57
0210 | F2 93 24 E1 A8 19 1B 08 2C 7E 13 DD A1 B0 80 EC
0220 | BB 7F F4 43 88 0E F2 87 EB AD C2 03 7F 82 C6 72
0230 | 6A A7 7C 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001000A3A669963FCB029A3DFE3D4</code> <code>492EA38E7A07D609E46EE5E600FAED40</code> <code>994C123FBB8015820517944911A2CC7A</code> <code>0199F9400A7A5AC71456AF6058BCF006</code> <code>15AFF2A14032D4E26664345006CCD199</code> <code>4171372517817479213F7C79EC2AF7BB</code> <code>E73406F41C1B2BA8F3030F4F8DC6A51D</code> <code>735FE352F47A7CC31F8BEC90C620CC30</code> <code>435C8E8E0AFFA24634E7417302D662D1</code> <code>79A7B493FD071C4302707B5C38234845</code> <code>F332050F17946B8DCE573AC3DBD36EAB</code> <code>EDBA1B4753672E66493F49951B0E8BE9</code> <code>28F476BA2A7EE58E3C5DCCFC0ACDD6DF</code> <code>4CF7E15121CDBEC2BFC3AA1D9A158DE9</code> <code>E18C2857F29324E1A8191B082C7E13DD</code> <code>A1B080ECBB7FF443880EF287EBADC203</code><br> <code>7F82C672</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>6AA77C65</code> (1702668138 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 0847DE3EB9F6690864BC0C267C603318E9F20DDAE4C725DD087452E1A4BFF2B132E753F68E0D5621BA06E3C51B43F1A7F4BE2A1B944B5AD264B7C2E4F1315249793ACDA94327BB0DC8CA5C5FE049993A7770B91AFC1BB921B1C0565FBC35AD175E01942BDF47FE973524388D427C5DF32F14FDCB5A9DB276BFC64CEE91CB5CED93110796CC41DEA65AD2BBAED6E365AA51EC5272967948EDB7F2537A8D1A725657C441CAB20D0ADAC523AC7D9E4AC0E2A3E5E651F40659C7C6C54A371DC1E9EF70FD890FC53891313D1D108473B6EC1F64F466F8C18CE6964FB425484228B156AB6A8D34AB4F7A9DB011CFFDD30A83CF068CEE2490F1213CE6D308F064C80F45</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = BC80AF986526DB25A08912129ED64D76962E351B624A14959904E03E20E72B496F5BDBED65020338782F286A9C26AF4F9A3867449C2B47EE1D12C628E533319CDF5D224CC5516B45569E597ACA300F5203EA4D8043BCCD4A9C4FC849526D8C4B9D58E97864CB303E0233F156BF073070433444702AEFE21ADD30644032AFE1EBB2ADDC6713D1DF96C14CDE3E1DE9E16D6255AB8966F1ED0DA2C558F6630AB2C9C68DAE096ABBBA6DBF3B0CA6CF5227A5BEB6FBD42465D148396348CC95E309B850405EE6D007544641C4BEDD185A4378C249A7F209EADDADB57B541500FB65354CFCC74D270B4B2B03E554E61EA79EEBB48F0225676D6B4C0DAAC6D36CEBABD5</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 EB 7B 0E A1 99 7D 01 79 D5 4F 04 D1
0010 | 19 D1 05 5C A2 A0 68 94 28 07 FB E9 C4 16 81 0B
0020 | EB 9E 03 A5 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | BC 80 AF 98 65 26 DB 25 A0 89 12 12 9E D6 4D 76
0040 | 96 2E 35 1B 62 4A 14 95 99 04 E0 3E 20 E7 2B 49
0050 | 6F 5B DB ED 65 02 03 38 78 2F 28 6A 9C 26 AF 4F
0060 | 9A 38 67 44 9C 2B 47 EE 1D 12 C6 28 E5 33 31 9C
0070 | DF 5D 22 4C C5 51 6B 45 56 9E 59 7A CA 30 0F 52
0080 | 03 EA 4D 80 43 BC CD 4A 9C 4F C8 49 52 6D 8C 4B
0090 | 9D 58 E9 78 64 CB 30 3E 02 33 F1 56 BF 07 30 70
00A0 | 43 34 44 70 2A EF E2 1A DD 30 64 40 32 AF E1 EB
00B0 | B2 AD DC 67 13 D1 DF 96 C1 4C DE 3E 1D E9 E1 6D
00C0 | 62 55 AB 89 66 F1 ED 0D A2 C5 58 F6 63 0A B2 C9
00D0 | C6 8D AE 09 6A BB BA 6D BF 3B 0C A6 CF 52 27 A5
00E0 | BE B6 FB D4 24 65 D1 48 39 63 48 CC 95 E3 09 B8
00F0 | 50 40 5E E6 D0 07 54 46 41 C4 BE DD 18 5A 43 78
0100 | C2 49 A7 F2 09 EA DD AD B5 7B 54 15 00 FB 65 35
0110 | 4C FC C7 4D 27 0B 4B 2B 03 E5 54 E6 1E A7 9E EB
0120 | B4 8F 02 25 67 6D 6B 4C 0D AA C6 D3 6C EB AB D5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100BC80AF986526DB25A0891212</code> <code>9ED64D76962E351B624A14959904E03E</code> <code>20E72B496F5BDBED65020338782F286A</code> <code>9C26AF4F9A3867449C2B47EE1D12C628</code> <code>E533319CDF5D224CC5516B45569E597A</code> <code>CA300F5203EA4D8043BCCD4A9C4FC849</code> <code>526D8C4B9D58E97864CB303E0233F156</code> <code>BF073070433444702AEFE21ADD306440</code> <code>32AFE1EBB2ADDC6713D1DF96C14CDE3E</code> <code>1DE9E16D6255AB8966F1ED0DA2C558F6</code> <code>630AB2C9C68DAE096ABBBA6DBF3B0CA6</code> <code>CF5227A5BEB6FBD42465D148396348CC</code> <code>95E309B850405EE6D007544641C4BEDD</code> <code>185A4378C249A7F209EADDADB57B5415</code> <code>00FB65354CFCC74D270B4B2B03E554E6</code> <code>1EA79EEBB48F0225676D6B4C0DAAC6D3</code><br> <code>6CEBABD5</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366EB7B0EA1997D0179D54F04D119D1055CA2A068942807FBE9C416810BEB9E03A50000000000000000FE000100BC80AF986526DB25A08912129ED64D76962E351B624A14959904E03E20E72B496F5BDBED65020338782F286A9C26AF4F9A3867449C2B47EE1D12C628E533319CDF5D224CC5516B45569E597ACA300F5203EA4D8043BCCD4A9C4FC849526D8C4B9D58E97864CB303E0233F156BF073070433444702AEFE21ADD30644032AFE1EBB2ADDC6713D1DF96C14CDE3E1DE9E16D6255AB8966F1ED0DA2C558F6630AB2C9C68DAE096ABBBA6DBF3B0CA6CF5227A5BEB6FBD42465D148396348CC95E309B850405EE6D007544641C4BEDD185A4378C249A7F209EADDADB57B541500FB65354CFCC74D270B4B2B03E554E61EA79EEBB48F0225676D6B4C0DAAC6D36CEBABD5
padding = CCC8EC019F365604BB43AA05
tmp_aes_key = 275B889088CE5A26C0BF451502C89FD28FD1F257E0AFDC0EAA03CC8E5CDC8131
tmp_aes_iv = 05B14F80F5EE413FB9958A0817559888C2207326A7F9A475C35190E259613091</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C256F7B27B79470C3F2FBEEC58594E1BFEA4D761EB1AB092B75C00C785762B4F4F55A15E37CD75461B9BFB6461F96E85601DC5759DDA52D530279FED4E318A3183BBB5680636AFB4B6FEFB8D4139772EF43A81ABC4DC989C020ADEF3893F666CC968E33AFDD2DBB259C79A5DF77475FDE583928A2BD045624553A604ABF4B17DF03884EF9BB761FC5D56C608A0108B4C0420745418C8984CD01567FBC9FACFC1499AF5726DC6FA6DA5E9A05948D590DBF1876B5363F37E9784D15B0B0E5002220D44C9B3AC5DB7D6A954DB26BD25BAE4F9D01ABA9366F735EC4DD4C3159253DDE09FE4C4E4B75A58F05D85D8B244F5A6021B84EABD9B20590D887520E8883BD41E742E9FBF263A819E01CC65BD60D80640B94142F4ACBC10A00FCD73B6DDB6F2C8AB9941330B930D538CAE4CAD872203920E9277E0FBB2CCEC051E21B3CEF5EDC0C73E920D27F813DB35F79BEFA6D828</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 F5 00 00 6A A7 7C 65
0010 | 78 01 00 00 1F 5F 04 F5 EB 7B 0E A1 99 7D 01 79
0020 | D5 4F 04 D1 19 D1 05 5C A2 A0 68 94 28 07 FB E9
0030 | C4 16 81 0B EB 9E 03 A5 FE 50 01 00 C2 56 F7 B2
0040 | 7B 79 47 0C 3F 2F BE EC 58 59 4E 1B FE A4 D7 61
0050 | EB 1A B0 92 B7 5C 00 C7 85 76 2B 4F 4F 55 A1 5E
0060 | 37 CD 75 46 1B 9B FB 64 61 F9 6E 85 60 1D C5 75
0070 | 9D DA 52 D5 30 27 9F ED 4E 31 8A 31 83 BB B5 68
0080 | 06 36 AF B4 B6 FE FB 8D 41 39 77 2E F4 3A 81 AB
0090 | C4 DC 98 9C 02 0A DE F3 89 3F 66 6C C9 68 E3 3A
00A0 | FD D2 DB B2 59 C7 9A 5D F7 74 75 FD E5 83 92 8A
00B0 | 2B D0 45 62 45 53 A6 04 AB F4 B1 7D F0 38 84 EF
00C0 | 9B B7 61 FC 5D 56 C6 08 A0 10 8B 4C 04 20 74 54
00D0 | 18 C8 98 4C D0 15 67 FB C9 FA CF C1 49 9A F5 72
00E0 | 6D C6 FA 6D A5 E9 A0 59 48 D5 90 DB F1 87 6B 53
00F0 | 63 F3 7E 97 84 D1 5B 0B 0E 50 02 22 0D 44 C9 B3
0100 | AC 5D B7 D6 A9 54 DB 26 BD 25 BA E4 F9 D0 1A BA
0110 | 93 66 F7 35 EC 4D D4 C3 15 92 53 DD E0 9F E4 C4
0120 | E4 B7 5A 58 F0 5D 85 D8 B2 44 F5 A6 02 1B 84 EA
0130 | BD 9B 20 59 0D 88 75 20 E8 88 3B D4 1E 74 2E 9F
0140 | BF 26 3A 81 9E 01 CC 65 BD 60 D8 06 40 B9 41 42
0150 | F4 AC BC 10 A0 0F CD 73 B6 DD B6 F2 C8 AB 99 41
0160 | 33 0B 93 0D 53 8C AE 4C AD 87 22 03 92 0E 92 77
0170 | E0 FB B2 CC EC 05 1E 21 B3 CE F5 ED C0 C7 3E 92
0180 | 0D 27 F8 13 DB 35 F7 9B EF A6 D8 28</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0F500006AA77C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C256F7B27B79470C3F2FBEEC</code> <code>58594E1BFEA4D761EB1AB092B75C00C7</code> <code>85762B4F4F55A15E37CD75461B9BFB64</code> <code>61F96E85601DC5759DDA52D530279FED</code> <code>4E318A3183BBB5680636AFB4B6FEFB8D</code> <code>4139772EF43A81ABC4DC989C020ADEF3</code> <code>893F666CC968E33AFDD2DBB259C79A5D</code> <code>F77475FDE583928A2BD045624553A604</code> <code>ABF4B17DF03884EF9BB761FC5D56C608</code> <code>A0108B4C0420745418C8984CD01567FB</code> <code>C9FACFC1499AF5726DC6FA6DA5E9A059</code> <code>48D590DBF1876B5363F37E9784D15B0B</code> <code>0E5002220D44C9B3AC5DB7D6A954DB26</code> <code>BD25BAE4F9D01ABA9366F735EC4DD4C3</code> <code>159253DDE09FE4C4E4B75A58F05D85D8</code> <code>B244F5A6021B84EABD9B20590D887520</code> <code>E8883BD41E742E9FBF263A819E01CC65</code> <code>BD60D80640B94142F4ACBC10A00FCD73</code> <code>B6DDB6F2C8AB9941330B930D538CAE4C</code> <code>AD872203920E9277E0FBB2CCEC051E21</code> <code>B3CEF5EDC0C73E920D27F813DB35F79B</code><br> <code>EFA6D828</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 5A845B26373924B96EFE1B615EE6E12C91CD3913BAEE7B7C2B9AD470DF469AE79FC3A2C8A148DC58A071CC0556DB1802F2D4BC78E9DD846BC1CB95A258C7163EA937ADADC8DE1140E46561ACE51831EF24B27EFCAA0C692E969332E23CB979B2A5379110F41D74992AC6E457BB36E8610B325B4C8D28ECFFE642A290DEB7F4C0A9C6A68AE4E6D41D294938341D038E5460D779BA993E0F8B0CC5BD496E6158B76165B38E63A27C2093B006B3F5C72F883D133433D4EC91F4D2C8F3201F0610A4431163904FCFD009B67E535F742DD85F670BCB32AB1712D25270D22A0E83535D65016C25712B8E4A5E2EDC4EF82E8068433D1F2BE92D27352AEDC40778910140</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C0 E2 D8 6A A7 7C 65
0010 | 70 00 00 00 34 F7 CB 3B EB 7B 0E A1 99 7D 01 79
0020 | D5 4F 04 D1 19 D1 05 5C A2 A0 68 94 28 07 FB E9
0030 | C4 16 81 0B EB 9E 03 A5 40 94 BD 6C 16 45 12 A1
0040 | C3 1B C1 F0 35 DF 17 5F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C0E2D86AA77C65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>70000000</code> (112 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EB7B0EA1997D0179D54F04D119D1055C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A2A068942807FBE9C416810BEB9E03A5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4094BD6C164512A1C31BC1F035DF175F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

