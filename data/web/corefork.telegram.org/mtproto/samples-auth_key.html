<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 24 09 00 B2 81 3A 65
0010 | 14 00 00 00 F1 8E 7E BE 5B C4 75 40 D7 80 0C F2
0020 | 57 0E 01 B2 0E 7A C4 96</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>44240900B2813A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C 32 E1 AE 81 3A 65
0010 | 74 00 00 00 63 24 16 05 5B C4 75 40 D7 80 0C F2
0020 | 57 0E 01 B2 0E 7A C4 96 A3 5B C5 BC D1 78 47 75
0030 | 79 57 68 32 EF F8 E6 3F 08 28 27 1F 2A AC 25 46
0040 | ED 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019C32E1AE813A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>74000000</code> (116 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0828271F2AAC2546ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2893315553746044653</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2893315553746044653</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2893315553746044653 = 1546123877 * 1871334889</code></p>
<pre><code>p = 1546123877
q = 1871334889</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 28 27 1F 2A AC 25 46 ED 00 00 00
0010 | 04 5C 27 FA 65 00 00 00 04 6F 8A 4D E9 00 00 00
0020 | 5B C4 75 40 D7 80 0C F2 57 0E 01 B2 0E 7A C4 96
0030 | A3 5B C5 BC D1 78 47 75 79 57 68 32 EF F8 E6 3F
0040 | CA 93 8B A9 ED 98 8E D7 58 30 62 8A 66 F0 94 34
0050 | 72 82 4E 42 D5 D5 D6 72 9B CA 1B B2 07 6A 45 D2
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0828271F2AAC2546ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2893315553746044653</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045C27FA65000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1546123877</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046F8A4DE9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1871334889</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>CA938BA9ED988ED75830628A66F09434</code> <code>72824E42D5D5D6729BCA1BB2076A45D2</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90828271F2AAC2546ED000000045C27FA65000000046F8A4DE90000005BC47540D7800CF2570E01B20E7AC496A35BC5BCD178477579576832EFF8E63FCA938BA9ED988ED75830628A66F0943472824E42D5D5D6729BCA1BB2076A45D202000000
random_padding_bytes = 870F8330DC0083AD325B066CAEAF9131E9D692B19576290095EDBD0097D22103BBE1B169A4E52E96B5A58F47B9F9254B7E100C5C672A11012B6A1869E6978174BE3A9E93E723F5E92B68C668E84F3799966F2783FB8EF22F6B29B12B</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = C06B72C499F627197E6B852125A4AA546767EC843715E479C400F9FD2B6709358593715B6ECCF7E12C996E7C60F2F998C448750613CC5F6BF8E8524B368AE8AAE6A60F00A88C5D85D6298D16B7C098BF0C4068FD7D4976DCEF2C605F7BE6B42F0D666BD451345D1E2B6A4A5B3614CA9BF9BA2BBDC9452C517342831E01073B57B7D113DAF10DF7C3851F5CA00891EAA8EAD81182D35ADFA8FCAB7B935A5B16F1DA1FC199F68C7A32FCC85154A0C6CD6C68511596D9EFC278066D1D0C60A8DF0B586E35823E428522DB314116770D69582C120F69624CE6D74029E0EC57B88F3B6ABBD613E294715D5E664322ABCC5E351AB396CCFA8B180AE31F831857C13439</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 AC 0E 00 B3 81 3A 65
0010 | 40 01 00 00 BE E4 12 D7 5B C4 75 40 D7 80 0C F2
0020 | 57 0E 01 B2 0E 7A C4 96 A3 5B C5 BC D1 78 47 75
0030 | 79 57 68 32 EF F8 E6 3F 04 5C 27 FA 65 00 00 00
0040 | 04 6F 8A 4D E9 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 C0 6B 72 C4 99 F6 27 19 7E 6B 85 21
0060 | 25 A4 AA 54 67 67 EC 84 37 15 E4 79 C4 00 F9 FD
0070 | 2B 67 09 35 85 93 71 5B 6E CC F7 E1 2C 99 6E 7C
0080 | 60 F2 F9 98 C4 48 75 06 13 CC 5F 6B F8 E8 52 4B
0090 | 36 8A E8 AA E6 A6 0F 00 A8 8C 5D 85 D6 29 8D 16
00A0 | B7 C0 98 BF 0C 40 68 FD 7D 49 76 DC EF 2C 60 5F
00B0 | 7B E6 B4 2F 0D 66 6B D4 51 34 5D 1E 2B 6A 4A 5B
00C0 | 36 14 CA 9B F9 BA 2B BD C9 45 2C 51 73 42 83 1E
00D0 | 01 07 3B 57 B7 D1 13 DA F1 0D F7 C3 85 1F 5C A0
00E0 | 08 91 EA A8 EA D8 11 82 D3 5A DF A8 FC AB 7B 93
00F0 | 5A 5B 16 F1 DA 1F C1 99 F6 8C 7A 32 FC C8 51 54
0100 | A0 C6 CD 6C 68 51 15 96 D9 EF C2 78 06 6D 1D 0C
0110 | 60 A8 DF 0B 58 6E 35 82 3E 42 85 22 DB 31 41 16
0120 | 77 0D 69 58 2C 12 0F 69 62 4C E6 D7 40 29 E0 EC
0130 | 57 B8 8F 3B 6A BB D6 13 E2 94 71 5D 5E 66 43 22
0140 | AB CC 5E 35 1A B3 96 CC FA 8B 18 0A E3 1F 83 18
0150 | 57 C1 34 39</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>78AC0E00B3813A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045C27FA65000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1546123877</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046F8A4DE9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1871334889</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100C06B72C499F627197E6B8521</code> <code>25A4AA546767EC843715E479C400F9FD</code> <code>2B6709358593715B6ECCF7E12C996E7C</code> <code>60F2F998C448750613CC5F6BF8E8524B</code> <code>368AE8AAE6A60F00A88C5D85D6298D16</code> <code>B7C098BF0C4068FD7D4976DCEF2C605F</code> <code>7BE6B42F0D666BD451345D1E2B6A4A5B</code> <code>3614CA9BF9BA2BBDC9452C517342831E</code> <code>01073B57B7D113DAF10DF7C3851F5CA0</code> <code>0891EAA8EAD81182D35ADFA8FCAB7B93</code> <code>5A5B16F1DA1FC199F68C7A32FCC85154</code> <code>A0C6CD6C68511596D9EFC278066D1D0C</code> <code>60A8DF0B586E35823E428522DB314116</code> <code>770D69582C120F69624CE6D74029E0EC</code> <code>57B88F3B6ABBD613E294715D5E664322</code> <code>ABCC5E351AB396CCFA8B180AE31F8318</code><br> <code>57C13439</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 BC E1 83 AF 81 3A 65
0010 | 78 02 00 00 5C 07 E8 D0 5B C4 75 40 D7 80 0C F2
0020 | 57 0E 01 B2 0E 7A C4 96 A3 5B C5 BC D1 78 47 75
0030 | 79 57 68 32 EF F8 E6 3F FE 50 02 00 6D 38 D0 7A
0040 | A7 A5 E4 47 6D EF 58 94 49 6B 33 1D 11 D2 51 B6
0050 | 04 F9 C1 0C D4 5B E3 78 C3 01 37 7C B2 95 D7 85
0060 | F8 60 7B 6F 70 20 FE 24 DF 66 00 7F BB 81 79 84
0070 | D5 88 12 FF 38 C1 1D 4F FE 59 1B E0 A6 51 AF 4A
0080 | DC 29 19 66 A0 59 56 C7 EB 51 C5 0B D5 7E 26 79
0090 | F2 75 3C 4E 5F 14 87 3A 95 AC C7 96 10 58 19 EB
00A0 | 14 3C FF 3E 4D ED C0 FB 2E 1F 75 A5 65 FA 41 F7
00B0 | C4 4C 75 3F 2D FA 34 4C 40 86 1E F3 C1 EF EC 10
00C0 | 7D 71 99 EA 30 EF F1 23 A7 16 9C 76 87 97 05 F8
00D0 | 1A D6 A9 FD 21 B6 BE 69 99 90 0A CD 62 A2 E6 BB
00E0 | CA 44 DA B4 45 83 8E 48 AC 16 5A AA 09 24 00 29
00F0 | 5E A6 22 E7 4C 19 CE 4D C4 E0 98 4E F2 01 1C B0
0100 | 68 BC F0 AF 5E 7F 5A 4A F0 E5 31 5E 58 A7 79 6E
0110 | F3 4B C3 9E 91 34 64 E0 65 AB 72 83 CC 7A A3 5E
0120 | 18 C0 A5 D2 0A FE 51 C5 A4 13 B5 EC E4 FC 22 E8
0130 | 06 C0 45 99 DF 6E 84 9B A9 F1 A7 EE A7 67 FA FF
0140 | F0 4E B5 D9 87 6C 78 06 5F 61 97 69 CD 4F 73 DF
0150 | EC 43 61 B7 0A 30 5C 77 83 3E 84 DB BA 00 57 3A
0160 | 5C C0 62 ED 1D 75 A6 8F 5C ED 0B 19 29 0B 1D 0F
0170 | 8E 43 4F F5 18 86 A4 31 67 7E B3 2E 02 9A 9B 89
0180 | 9A 05 09 8D 35 9A E5 55 51 EE 61 B0 4E E0 D7 9A
0190 | 23 0C 12 7B 9A 68 2D 3C 4B 49 ED BF 6C 7B 1B 98
01A0 | 12 5F D3 46 66 FC 36 5D 10 B1 AF 3A 67 BC 9E DD
01B0 | 50 E9 77 C4 8C 61 9E 9B 60 4C CC D5 39 E9 5B 7E
01C0 | 0D D6 47 E5 73 D1 61 47 64 E8 E1 D9 A0 17 CD 0C
01D0 | 23 9A 2A A1 68 B2 75 15 20 68 9A 06 98 BE FE C8
01E0 | 54 AC D3 ED 73 74 31 6A 1F 3D 80 C5 0D 18 54 12
01F0 | 6A B7 9B EA DC 91 8C 3F 01 2E 50 80 FA 85 C6 C2
0200 | EA C4 70 9A BC B4 A9 3D EF 99 6C EE 8D F7 B8 B1
0210 | 70 7C 7C 01 D0 B6 18 41 0E 4F D6 AA 2B B8 13 C0
0220 | 12 7C 57 67 E4 F4 95 C2 F0 CA 6C 35 CD F9 D7 B9
0230 | 4E 8F 1D 7B AA 6E 51 0B 34 AF 4E 3E 4C D7 46 E3
0240 | 4D 21 B0 26 75 D9 DC C0 08 EA 88 E2 84 52 20 E6
0250 | E9 8C 2B 24 6A F4 79 CB 93 8C 16 D3 3C E1 5B A6
0260 | 3F 17 E4 CD FF C0 11 CA 98 B2 6F BC A2 74 E3 CA
0270 | D4 D4 2C DE F8 09 1C 0D BA 67 3A 64 5C 0E 79 F0
0280 | DB 08 1C 9A F6 6C 14 EC 18 10 D8 2E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01BCE183AF813A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002006D38D07AA7A5E4476DEF5894</code> <code>496B331D11D251B604F9C10CD45BE378</code> <code>C301377CB295D785F8607B6F7020FE24</code> <code>DF66007FBB817984D58812FF38C11D4F</code> <code>FE591BE0A651AF4ADC291966A05956C7</code> <code>EB51C50BD57E2679F2753C4E5F14873A</code> <code>95ACC796105819EB143CFF3E4DEDC0FB</code> <code>2E1F75A565FA41F7C44C753F2DFA344C</code> <code>40861EF3C1EFEC107D7199EA30EFF123</code> <code>A7169C76879705F81AD6A9FD21B6BE69</code> <code>99900ACD62A2E6BBCA44DAB445838E48</code> <code>AC165AAA092400295EA622E74C19CE4D</code> <code>C4E0984EF2011CB068BCF0AF5E7F5A4A</code> <code>F0E5315E58A7796EF34BC39E913464E0</code> <code>65AB7283CC7AA35E18C0A5D20AFE51C5</code> <code>A413B5ECE4FC22E806C04599DF6E849B</code> <code>A9F1A7EEA767FAFFF04EB5D9876C7806</code> <code>5F619769CD4F73DFEC4361B70A305C77</code> <code>833E84DBBA00573A5CC062ED1D75A68F</code> <code>5CED0B19290B1D0F8E434FF51886A431</code> <code>677EB32E029A9B899A05098D359AE555</code> <code>51EE61B04EE0D79A230C127B9A682D3C</code> <code>4B49EDBF6C7B1B98125FD34666FC365D</code> <code>10B1AF3A67BC9EDD50E977C48C619E9B</code> <code>604CCCD539E95B7E0DD647E573D16147</code> <code>64E8E1D9A017CD0C239A2AA168B27515</code> <code>20689A0698BEFEC854ACD3ED7374316A</code> <code>1F3D80C50D1854126AB79BEADC918C3F</code> <code>012E5080FA85C6C2EAC4709ABCB4A93D</code> <code>EF996CEE8DF7B8B1707C7C01D0B61841</code> <code>0E4FD6AA2BB813C0127C5767E4F495C2</code> <code>F0CA6C35CDF9D7B94E8F1D7BAA6E510B</code> <code>34AF4E3E4CD746E34D21B02675D9DCC0</code> <code>08EA88E2845220E6E98C2B246AF479CB</code> <code>938C16D33CE15BA63F17E4CDFFC011CA</code> <code>98B26FBCA274E3CAD4D42CDEF8091C0D</code> <code>BA673A645C0E79F0DB081C9AF66C14EC</code><br> <code>1810D82E</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 6D38D07AA7A5E4476DEF5894496B331D11D251B604F9C10CD45BE378C301377CB295D785F8607B6F7020FE24DF66007FBB817984D58812FF38C11D4FFE591BE0A651AF4ADC291966A05956C7EB51C50BD57E2679F2753C4E5F14873A95ACC796105819EB143CFF3E4DEDC0FB2E1F75A565FA41F7C44C753F2DFA344C40861EF3C1EFEC107D7199EA30EFF123A7169C76879705F81AD6A9FD21B6BE6999900ACD62A2E6BBCA44DAB445838E48AC165AAA092400295EA622E74C19CE4DC4E0984EF2011CB068BCF0AF5E7F5A4AF0E5315E58A7796EF34BC39E913464E065AB7283CC7AA35E18C0A5D20AFE51C5A413B5ECE4FC22E806C04599DF6E849BA9F1A7EEA767FAFFF04EB5D9876C78065F619769CD4F73DFEC4361B70A305C77833E84DBBA00573A5CC062ED1D75A68F5CED0B19290B1D0F8E434FF51886A431677EB32E029A9B899A05098D359AE55551EE61B04EE0D79A230C127B9A682D3C4B49EDBF6C7B1B98125FD34666FC365D10B1AF3A67BC9EDD50E977C48C619E9B604CCCD539E95B7E0DD647E573D1614764E8E1D9A017CD0C239A2AA168B2751520689A0698BEFEC854ACD3ED7374316A1F3D80C50D1854126AB79BEADC918C3F012E5080FA85C6C2EAC4709ABCB4A93DEF996CEE8DF7B8B1707C7C01D0B618410E4FD6AA2BB813C0127C5767E4F495C2F0CA6C35CDF9D7B94E8F1D7BAA6E510B34AF4E3E4CD746E34D21B02675D9DCC008EA88E2845220E6E98C2B246AF479CB938C16D33CE15BA63F17E4CDFFC011CA98B26FBCA274E3CAD4D42CDEF8091C0DBA673A645C0E79F0DB081C9AF66C14EC1810D82E
tmp_aes_key = 8F1B855F685543EEBC158D37252B4C1609AFBD767149C011C89005DCA2BA9EE4
tmp_aes_iv = D332730E4F33F366440193503837B56ADB3667C4B76F079787BB40D8CA938BA9</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 328A6890300E40B3594EDC2AF8A58EF65F882214BA0D89B55BC47540D7800CF2570E01B20E7AC496A35BC5BCD178477579576832EFF8E63F03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002C51E6585757AC05CDE65EAA95E45B3990882F39471D8A371C6C2506A3E642FAAEDF28D26A270C6DA89A5B23DAE7D53285907089B0D13BFC9823AB87E5443AE44636F7E2E553E7E70B750FCCFE78AABB50A148DB0F56809E864EF221BF0896E58262DFA8DD07CEB4907613D2221A9BE437753324AB71354F0AA4F0653B57C99B3B042B9512E457766E84C4271C476998F345A9AF97E8D4F3D5B936484354ACE0EF3D05D16907C5AC596274F774544965EEE315E48AFF8DC6766B5F53037EADBDEF5570AB5ED831F517BB5845A6BFB4D57B93ECCEC292328D10018EE45D177273E8E891CD7A3DC0F33EDFA4451C0C7B27959D49E2BCA10CD6AF261B6C0955CA81AF813A652CDC093CF0112680
answer = BA0D89B55BC47540D7800CF2570E01B20E7AC496A35BC5BCD178477579576832EFF8E63F03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002C51E6585757AC05CDE65EAA95E45B3990882F39471D8A371C6C2506A3E642FAAEDF28D26A270C6DA89A5B23DAE7D53285907089B0D13BFC9823AB87E5443AE44636F7E2E553E7E70B750FCCFE78AABB50A148DB0F56809E864EF221BF0896E58262DFA8DD07CEB4907613D2221A9BE437753324AB71354F0AA4F0653B57C99B3B042B9512E457766E84C4271C476998F345A9AF97E8D4F3D5B936484354ACE0EF3D05D16907C5AC596274F774544965EEE315E48AFF8DC6766B5F53037EADBDEF5570AB5ED831F517BB5845A6BFB4D57B93ECCEC292328D10018EE45D177273E8E891CD7A3DC0F33EDFA4451C0C7B27959D49E2BCA10CD6AF261B6C0955CA81AF813A652CDC093CF0112680</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 5B C4 75 40 D7 80 0C F2 57 0E 01 B2
0010 | 0E 7A C4 96 A3 5B C5 BC D1 78 47 75 79 57 68 32
0020 | EF F8 E6 3F 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 2C 51 E6 58 57 57 AC 05 CD E6 5E AA 95 E4 5B 39
0140 | 90 88 2F 39 47 1D 8A 37 1C 6C 25 06 A3 E6 42 FA
0150 | AE DF 28 D2 6A 27 0C 6D A8 9A 5B 23 DA E7 D5 32
0160 | 85 90 70 89 B0 D1 3B FC 98 23 AB 87 E5 44 3A E4
0170 | 46 36 F7 E2 E5 53 E7 E7 0B 75 0F CC FE 78 AA BB
0180 | 50 A1 48 DB 0F 56 80 9E 86 4E F2 21 BF 08 96 E5
0190 | 82 62 DF A8 DD 07 CE B4 90 76 13 D2 22 1A 9B E4
01A0 | 37 75 33 24 AB 71 35 4F 0A A4 F0 65 3B 57 C9 9B
01B0 | 3B 04 2B 95 12 E4 57 76 6E 84 C4 27 1C 47 69 98
01C0 | F3 45 A9 AF 97 E8 D4 F3 D5 B9 36 48 43 54 AC E0
01D0 | EF 3D 05 D1 69 07 C5 AC 59 62 74 F7 74 54 49 65
01E0 | EE E3 15 E4 8A FF 8D C6 76 6B 5F 53 03 7E AD BD
01F0 | EF 55 70 AB 5E D8 31 F5 17 BB 58 45 A6 BF B4 D5
0200 | 7B 93 EC CE C2 92 32 8D 10 01 8E E4 5D 17 72 73
0210 | E8 E8 91 CD 7A 3D C0 F3 3E DF A4 45 1C 0C 7B 27
0220 | 95 9D 49 E2 BC A1 0C D6 AF 26 1B 6C 09 55 CA 81
0230 | AF 81 3A 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001002C51E6585757AC05CDE65EAA</code> <code>95E45B3990882F39471D8A371C6C2506</code> <code>A3E642FAAEDF28D26A270C6DA89A5B23</code> <code>DAE7D53285907089B0D13BFC9823AB87</code> <code>E5443AE44636F7E2E553E7E70B750FCC</code> <code>FE78AABB50A148DB0F56809E864EF221</code> <code>BF0896E58262DFA8DD07CEB4907613D2</code> <code>221A9BE437753324AB71354F0AA4F065</code> <code>3B57C99B3B042B9512E457766E84C427</code> <code>1C476998F345A9AF97E8D4F3D5B93648</code> <code>4354ACE0EF3D05D16907C5AC596274F7</code> <code>74544965EEE315E48AFF8DC6766B5F53</code> <code>037EADBDEF5570AB5ED831F517BB5845</code> <code>A6BFB4D57B93ECCEC292328D10018EE4</code> <code>5D177273E8E891CD7A3DC0F33EDFA445</code> <code>1C0C7B27959D49E2BCA10CD6AF261B6C</code><br> <code>0955CA81</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>AF813A65</code> (1698333103 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 22364BC52FE22E197509E17EC88E8EAC8EC6C4A9977437747BCB7615E28F964E8ED7B414617CDD0A892C756DA23376894C0AE7D85C7D6D951535AABB60212A21CB3D7C6C13186DE1D416412B0ACDC53C360F7A08CD032A635AE1AB2B901FE6DF9C5DB62BCDB8226749098824109B4284047463B36582B497CB6408B3D92CB1AA2C578398AB9CB85DFC575F6647C0BBAD892A20C0F73EA564C0B68F48444221AC0E23FB849FC5D294328C7019F251B0373A72A30F44CAE7A45BECC3BC90A978C4AF2F05B3C2A98BC972164054DB153C6DF033B747C42E21A49091705CD6B7614D0A3C132BE3435A04E2FA3A1FD42ED1A5D94E8FC6AC0BFF4552D7453B3BBDF340</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 962D9EAC96083ADEC9DBD5147CC105C7EBF175FC65DF93DC9AE66BBED609687673ECB29FD81A5150663D1673FB78758E8131B9328C6328750DEC1AF449B7FF15E39D5BA24958204267730E4B8897A7FCC41043B2B748AD22CCA6F67F1D6AC873E9AE4EADD39ADF32705B4BF78D3C250F97A8C80FE03845CB8DE483AB646AF8ADCFCBB554346E4C4ED3F3886DC111787F3271A8A71214F1F89FE45C68F7624B1D62D66950E6AFE3AFAF4601636C81361FC01A397BB606CC54FBC70042870EA521160F509963AE1E90778135B1458980D47C663FF34BDE1666433C33DE04335608305F0E1849107B1A6D733CCB9B951D40477D58B5515E41DEE9D7ECD8785E5927</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 5B C4 75 40 D7 80 0C F2 57 0E 01 B2
0010 | 0E 7A C4 96 A3 5B C5 BC D1 78 47 75 79 57 68 32
0020 | EF F8 E6 3F 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 96 2D 9E AC 96 08 3A DE C9 DB D5 14 7C C1 05 C7
0040 | EB F1 75 FC 65 DF 93 DC 9A E6 6B BE D6 09 68 76
0050 | 73 EC B2 9F D8 1A 51 50 66 3D 16 73 FB 78 75 8E
0060 | 81 31 B9 32 8C 63 28 75 0D EC 1A F4 49 B7 FF 15
0070 | E3 9D 5B A2 49 58 20 42 67 73 0E 4B 88 97 A7 FC
0080 | C4 10 43 B2 B7 48 AD 22 CC A6 F6 7F 1D 6A C8 73
0090 | E9 AE 4E AD D3 9A DF 32 70 5B 4B F7 8D 3C 25 0F
00A0 | 97 A8 C8 0F E0 38 45 CB 8D E4 83 AB 64 6A F8 AD
00B0 | CF CB B5 54 34 6E 4C 4E D3 F3 88 6D C1 11 78 7F
00C0 | 32 71 A8 A7 12 14 F1 F8 9F E4 5C 68 F7 62 4B 1D
00D0 | 62 D6 69 50 E6 AF E3 AF AF 46 01 63 6C 81 36 1F
00E0 | C0 1A 39 7B B6 06 CC 54 FB C7 00 42 87 0E A5 21
00F0 | 16 0F 50 99 63 AE 1E 90 77 81 35 B1 45 89 80 D4
0100 | 7C 66 3F F3 4B DE 16 66 43 3C 33 DE 04 33 56 08
0110 | 30 5F 0E 18 49 10 7B 1A 6D 73 3C CB 9B 95 1D 40
0120 | 47 7D 58 B5 51 5E 41 DE E9 D7 EC D8 78 5E 59 27</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100962D9EAC96083ADEC9DBD514</code> <code>7CC105C7EBF175FC65DF93DC9AE66BBE</code> <code>D609687673ECB29FD81A5150663D1673</code> <code>FB78758E8131B9328C6328750DEC1AF4</code> <code>49B7FF15E39D5BA24958204267730E4B</code> <code>8897A7FCC41043B2B748AD22CCA6F67F</code> <code>1D6AC873E9AE4EADD39ADF32705B4BF7</code> <code>8D3C250F97A8C80FE03845CB8DE483AB</code> <code>646AF8ADCFCBB554346E4C4ED3F3886D</code> <code>C111787F3271A8A71214F1F89FE45C68</code> <code>F7624B1D62D66950E6AFE3AFAF460163</code> <code>6C81361FC01A397BB606CC54FBC70042</code> <code>870EA521160F509963AE1E90778135B1</code> <code>458980D47C663FF34BDE1666433C33DE</code> <code>04335608305F0E1849107B1A6D733CCB</code> <code>9B951D40477D58B5515E41DEE9D7ECD8</code><br> <code>785E5927</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643665BC47540D7800CF2570E01B20E7AC496A35BC5BCD178477579576832EFF8E63F0000000000000000FE000100962D9EAC96083ADEC9DBD5147CC105C7EBF175FC65DF93DC9AE66BBED609687673ECB29FD81A5150663D1673FB78758E8131B9328C6328750DEC1AF449B7FF15E39D5BA24958204267730E4B8897A7FCC41043B2B748AD22CCA6F67F1D6AC873E9AE4EADD39ADF32705B4BF78D3C250F97A8C80FE03845CB8DE483AB646AF8ADCFCBB554346E4C4ED3F3886DC111787F3271A8A71214F1F89FE45C68F7624B1D62D66950E6AFE3AFAF4601636C81361FC01A397BB606CC54FBC70042870EA521160F509963AE1E90778135B1458980D47C663FF34BDE1666433C33DE04335608305F0E1849107B1A6D733CCB9B951D40477D58B5515E41DEE9D7ECD8785E5927
padding = F7543DED13D642559C6340C5
tmp_aes_key = 8F1B855F685543EEBC158D37252B4C1609AFBD767149C011C89005DCA2BA9EE4
tmp_aes_iv = D332730E4F33F366440193503837B56ADB3667C4B76F079787BB40D8CA938BA9</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C4AF8EC9E830FADDE7B443E428C8FC181874C57FA121D51B966C24B5DDDF6BED72756F18F8C4904FD5E30D732D43F0171AB9141C4D04B5B69FA8F78AC247FD458CAA619373DDC95AC4FD8B9C5614298E4B59C3EE63C04B430E836B2122B55937B0702128255C4E5A15D2072A0E1A2C2E05E651C41124DC504818991E11AA115E31E25547574B7596EDC3662013A07DCD01724E28C3D8A5AD31ADFF95C06A60BFBEBB605F0B48A6AB4C312BB6EFA999CE5F704E684E7B47EE06E582495E79DBE8A201FD025ED31C911C61B24FD3811E9D519C3EF64F78E332995B101C86A6647D51EEEFF0FB369B6623A90E12E30C77724A2DB8BFC5E88A8607750FFF28D53BF2A693383DB9A7ABCEA53D07BB97F6EE97B12AB21EE93B0A84BACC25F609972A3D715FC1E05E6300713AF5C46FC158C355045A4AF73C369C11A2ACCB4EEF5A0F32AE003B2C283B387F23D91D1FCEA69FB0</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C AC 0E 00 B3 81 3A 65
0010 | 78 01 00 00 1F 5F 04 F5 5B C4 75 40 D7 80 0C F2
0020 | 57 0E 01 B2 0E 7A C4 96 A3 5B C5 BC D1 78 47 75
0030 | 79 57 68 32 EF F8 E6 3F FE 50 01 00 C4 AF 8E C9
0040 | E8 30 FA DD E7 B4 43 E4 28 C8 FC 18 18 74 C5 7F
0050 | A1 21 D5 1B 96 6C 24 B5 DD DF 6B ED 72 75 6F 18
0060 | F8 C4 90 4F D5 E3 0D 73 2D 43 F0 17 1A B9 14 1C
0070 | 4D 04 B5 B6 9F A8 F7 8A C2 47 FD 45 8C AA 61 93
0080 | 73 DD C9 5A C4 FD 8B 9C 56 14 29 8E 4B 59 C3 EE
0090 | 63 C0 4B 43 0E 83 6B 21 22 B5 59 37 B0 70 21 28
00A0 | 25 5C 4E 5A 15 D2 07 2A 0E 1A 2C 2E 05 E6 51 C4
00B0 | 11 24 DC 50 48 18 99 1E 11 AA 11 5E 31 E2 55 47
00C0 | 57 4B 75 96 ED C3 66 20 13 A0 7D CD 01 72 4E 28
00D0 | C3 D8 A5 AD 31 AD FF 95 C0 6A 60 BF BE BB 60 5F
00E0 | 0B 48 A6 AB 4C 31 2B B6 EF A9 99 CE 5F 70 4E 68
00F0 | 4E 7B 47 EE 06 E5 82 49 5E 79 DB E8 A2 01 FD 02
0100 | 5E D3 1C 91 1C 61 B2 4F D3 81 1E 9D 51 9C 3E F6
0110 | 4F 78 E3 32 99 5B 10 1C 86 A6 64 7D 51 EE EF F0
0120 | FB 36 9B 66 23 A9 0E 12 E3 0C 77 72 4A 2D B8 BF
0130 | C5 E8 8A 86 07 75 0F FF 28 D5 3B F2 A6 93 38 3D
0140 | B9 A7 AB CE A5 3D 07 BB 97 F6 EE 97 B1 2A B2 1E
0150 | E9 3B 0A 84 BA CC 25 F6 09 97 2A 3D 71 5F C1 E0
0160 | 5E 63 00 71 3A F5 C4 6F C1 58 C3 55 04 5A 4A F7
0170 | 3C 36 9C 11 A2 AC CB 4E EF 5A 0F 32 AE 00 3B 2C
0180 | 28 3B 38 7F 23 D9 1D 1F CE A6 9F B0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7CAC0E00B3813A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C4AF8EC9E830FADDE7B443E4</code> <code>28C8FC181874C57FA121D51B966C24B5</code> <code>DDDF6BED72756F18F8C4904FD5E30D73</code> <code>2D43F0171AB9141C4D04B5B69FA8F78A</code> <code>C247FD458CAA619373DDC95AC4FD8B9C</code> <code>5614298E4B59C3EE63C04B430E836B21</code> <code>22B55937B0702128255C4E5A15D2072A</code> <code>0E1A2C2E05E651C41124DC504818991E</code> <code>11AA115E31E25547574B7596EDC36620</code> <code>13A07DCD01724E28C3D8A5AD31ADFF95</code> <code>C06A60BFBEBB605F0B48A6AB4C312BB6</code> <code>EFA999CE5F704E684E7B47EE06E58249</code> <code>5E79DBE8A201FD025ED31C911C61B24F</code> <code>D3811E9D519C3EF64F78E332995B101C</code> <code>86A6647D51EEEFF0FB369B6623A90E12</code> <code>E30C77724A2DB8BFC5E88A8607750FFF</code> <code>28D53BF2A693383DB9A7ABCEA53D07BB</code> <code>97F6EE97B12AB21EE93B0A84BACC25F6</code> <code>09972A3D715FC1E05E6300713AF5C46F</code> <code>C158C355045A4AF73C369C11A2ACCB4E</code> <code>EF5A0F32AE003B2C283B387F23D91D1F</code><br> <code>CEA69FB0</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 4068B2CF903CC148609AE00C7C2CC189D50B86881C907D1600BBACDC535A8312C59585F2ACAF1922F8368F45C87E2D5331903D462CBBB479509D39FF24CE63FE907855F2A3189B6ACA77D7D9E148F21180D6A0A0A7DA847A90765ECBE1361C7DE1B54901F2839068885F8EE5B04A84EF91B99402BE61D8E816E56040FBEEA9EAD609E02A5ECB2146C92E53FAB2472DB93E556D75780551F37988D2CD42B3FC38EDE50BBDCCD1D8275A92E5B5CA7443FE7994F6DFF2DD8447DD79EF64FA149FAA235EBBF86902879364126BD4F34EBA5C12141C8CFFDAE5498CA1C2C1F59A301E54C726034E24BAA56C94F07AB756DE6DF7C4998F96A20B5F4626773F8CF32C28</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B0 03 E2 AF 81 3A 65
0010 | 50 00 00 00 34 F7 CB 3B 5B C4 75 40 D7 80 0C F2
0020 | 57 0E 01 B2 0E 7A C4 96 A3 5B C5 BC D1 78 47 75
0030 | 79 57 68 32 EF F8 E6 3F 32 05 65 2D 21 F4 F8 E2
0040 | 8C 0B 5D 34 B5 30 63 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B003E2AF813A65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5BC47540D7800CF2570E01B20E7AC496</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A35BC5BCD178477579576832EFF8E63F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>3205652D21F4F8E28C0B5D34B530631E</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

