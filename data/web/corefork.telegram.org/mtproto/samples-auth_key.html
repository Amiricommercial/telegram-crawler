<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 18 89 06 00 62 49 A8 65
0010 | 14 00 00 00 F1 8E 7E BE D9 31 E2 CD 8A 38 C2 63
0020 | 1B A0 BA C5 0B B1 24 D2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>188906006249A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 C3 8A 62 49 A8 65
0010 | 84 00 00 00 63 24 16 05 D9 31 E2 CD 8A 38 C2 63
0020 | 1B A0 BA C5 0B B1 24 D2 AD D3 FB 20 7B 9C 6D 78
0030 | 2E 45 E7 4C C4 68 64 E7 08 2A 6F 73 28 7C 4B 16
0040 | D5 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B4C38A6249A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>84000000</code> (132 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082A6F73287C4B16D5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3057789289729038037</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3057789289729038037</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3057789289729038037 = 1641849427 * 1862405431</code></p>
<pre><code>p = 1641849427
q = 1862405431</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2A 6F 73 28 7C 4B 16 D5 00 00 00
0010 | 04 61 DC A2 53 00 00 00 04 6F 02 0D 37 00 00 00
0020 | D9 31 E2 CD 8A 38 C2 63 1B A0 BA C5 0B B1 24 D2
0030 | AD D3 FB 20 7B 9C 6D 78 2E 45 E7 4C C4 68 64 E7
0040 | 1E 40 91 8F D3 14 D3 2C 3B 8B C5 67 4A 6F 33 68
0050 | 00 D1 A3 C7 17 5F 97 DD A7 F3 9C 44 8A E9 06 89
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082A6F73287C4B16D5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3057789289729038037</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0461DCA253000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1641849427</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046F020D37000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1862405431</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>1E40918FD314D32C3B8BC5674A6F3368</code> <code>00D1A3C7175F97DDA7F39C448AE90689</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082A6F73287C4B16D50000000461DCA253000000046F020D37000000D931E2CD8A38C2631BA0BAC50BB124D2ADD3FB207B9C6D782E45E74CC46864E71E40918FD314D32C3B8BC5674A6F336800D1A3C7175F97DDA7F39C448AE9068902000000
random_padding_bytes = 24503EAB5F8091B8BF416CFA4B3EB85F81698E119C2FDE782758FC5F34DFBB891448B9E98B7337DB093CD960CF12B181018937B320293A3D23BE2C6415B593FFF3D567F7F41B963B529961A3A7A8CCA741B0F51B705B82D36771DCD0</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 09803EE06BE788DC986466A78F13E917BDBBBC63D1615CD41A2D4689F120B5D80381557F429EE83A9BF90818B0D4F3988FF7352DC59DECA6C3457672FBF176D652CD37319F5ACFF2EB79896676ADD5E3C10542CBDECAB1F4267F568BEE08919D27529F2A1A260FC84CB11BCCFD028531794B254DEB1CEC8E904E7FD573B749A429ECA4F84E2F06B29CCDD51F1BB14EF5A43A169FB9B18FC1FD9494C7062E74C731FAFC4DBB0830B29E7A80ACBBD2CDEA4567D545C6BCE2FF93AA4CA4F17A5ABFB3E4C93D3C18B026E8FD2D775A7D7D41C697C384004AB749346DBD856D2A7C86DD0D8B1066A872E0A4B2FA26D0F5CF4B2CCD7BAC25CE345F88BEF0007DC0DBBB</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 1C 89 06 00 62 49 A8 65
0010 | 40 01 00 00 BE E4 12 D7 D9 31 E2 CD 8A 38 C2 63
0020 | 1B A0 BA C5 0B B1 24 D2 AD D3 FB 20 7B 9C 6D 78
0030 | 2E 45 E7 4C C4 68 64 E7 04 61 DC A2 53 00 00 00
0040 | 04 6F 02 0D 37 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 09 80 3E E0 6B E7 88 DC 98 64 66 A7
0060 | 8F 13 E9 17 BD BB BC 63 D1 61 5C D4 1A 2D 46 89
0070 | F1 20 B5 D8 03 81 55 7F 42 9E E8 3A 9B F9 08 18
0080 | B0 D4 F3 98 8F F7 35 2D C5 9D EC A6 C3 45 76 72
0090 | FB F1 76 D6 52 CD 37 31 9F 5A CF F2 EB 79 89 66
00A0 | 76 AD D5 E3 C1 05 42 CB DE CA B1 F4 26 7F 56 8B
00B0 | EE 08 91 9D 27 52 9F 2A 1A 26 0F C8 4C B1 1B CC
00C0 | FD 02 85 31 79 4B 25 4D EB 1C EC 8E 90 4E 7F D5
00D0 | 73 B7 49 A4 29 EC A4 F8 4E 2F 06 B2 9C CD D5 1F
00E0 | 1B B1 4E F5 A4 3A 16 9F B9 B1 8F C1 FD 94 94 C7
00F0 | 06 2E 74 C7 31 FA FC 4D BB 08 30 B2 9E 7A 80 AC
0100 | BB D2 CD EA 45 67 D5 45 C6 BC E2 FF 93 AA 4C A4
0110 | F1 7A 5A BF B3 E4 C9 3D 3C 18 B0 26 E8 FD 2D 77
0120 | 5A 7D 7D 41 C6 97 C3 84 00 4A B7 49 34 6D BD 85
0130 | 6D 2A 7C 86 DD 0D 8B 10 66 A8 72 E0 A4 B2 FA 26
0140 | D0 F5 CF 4B 2C CD 7B AC 25 CE 34 5F 88 BE F0 00
0150 | 7D C0 DB BB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>1C8906006249A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0461DCA253000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1641849427</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046F020D37000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1862405431</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010009803EE06BE788DC986466A7</code> <code>8F13E917BDBBBC63D1615CD41A2D4689</code> <code>F120B5D80381557F429EE83A9BF90818</code> <code>B0D4F3988FF7352DC59DECA6C3457672</code> <code>FBF176D652CD37319F5ACFF2EB798966</code> <code>76ADD5E3C10542CBDECAB1F4267F568B</code> <code>EE08919D27529F2A1A260FC84CB11BCC</code> <code>FD028531794B254DEB1CEC8E904E7FD5</code> <code>73B749A429ECA4F84E2F06B29CCDD51F</code> <code>1BB14EF5A43A169FB9B18FC1FD9494C7</code> <code>062E74C731FAFC4DBB0830B29E7A80AC</code> <code>BBD2CDEA4567D545C6BCE2FF93AA4CA4</code> <code>F17A5ABFB3E4C93D3C18B026E8FD2D77</code> <code>5A7D7D41C697C384004AB749346DBD85</code> <code>6D2A7C86DD0D8B1066A872E0A4B2FA26</code> <code>D0F5CF4B2CCD7BAC25CE345F88BEF000</code><br> <code>7DC0DBBB</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 3C 68 29 63 49 A8 65
0010 | A8 02 00 00 5C 07 E8 D0 D9 31 E2 CD 8A 38 C2 63
0020 | 1B A0 BA C5 0B B1 24 D2 AD D3 FB 20 7B 9C 6D 78
0030 | 2E 45 E7 4C C4 68 64 E7 FE 50 02 00 03 7B C1 F6
0040 | A9 B7 16 E7 AF 9A 55 D4 77 CF 5F 78 43 01 37 E2
0050 | 63 CA 90 8E 0F CB C2 4A D3 03 5D 7D 7E 41 83 F7
0060 | 49 EA F6 96 6D 67 84 EB A4 9E 27 24 7D 89 99 CF
0070 | C4 94 E8 F6 BA 9B DD FF 12 4F 1C 12 98 17 AF 50
0080 | BD B2 15 6D C2 CD C4 79 D3 D2 5A 8D FA AC 48 1B
0090 | ED A2 C8 05 9B 13 1F 34 50 96 9B AC 0B E3 5E 5E
00A0 | 4B 7F C5 62 7B 7B B6 C6 43 36 88 C0 0A 8D 92 C1
00B0 | FB 20 62 20 F5 C0 CF 07 AA A4 27 12 56 21 F4 53
00C0 | AC 73 61 D7 AC 97 29 45 A7 90 0E 73 60 43 51 5E
00D0 | 79 62 3D A4 E2 AF 6C 5F E6 CB A0 E9 D1 07 61 76
00E0 | 71 42 F9 70 29 D7 E5 E8 31 73 FB 02 2C 1F CC 7A
00F0 | 63 4A F5 A0 59 A5 44 39 66 4E 46 F9 C6 33 8F D0
0100 | 89 87 1C 45 80 6D EE 2C 3F FD 7F CE B3 71 E3 4C
0110 | 16 B1 27 DE C0 44 DA B8 5C 5E E4 21 EE 94 AC 12
0120 | 74 56 CE 98 CD B8 CC 16 59 B0 9D 6C F5 EB 15 C5
0130 | DE AB 9F 70 27 6C 05 5D 42 38 6E 43 F3 F7 3C B8
0140 | 41 E6 FB EC E5 63 8E 60 05 18 D6 4D F6 8E F8 78
0150 | D5 66 24 6F 33 63 88 48 9D 05 24 DC E2 08 1A D9
0160 | 65 23 7C 6F 7B 82 52 EB D4 FF D4 C1 2B 68 F6 06
0170 | 1F B4 CA 2A A6 3E 8D C3 A4 A1 05 9C 05 D9 19 B9
0180 | B0 4D 8F 11 70 F5 A7 99 29 80 BD 41 4E AF 17 B5
0190 | EC 86 FE 8C C8 DF DA 29 16 E4 A1 90 AF DE A2 0C
01A0 | A3 E7 49 BE 4C 24 E9 61 E2 F6 54 15 F8 1F A8 1B
01B0 | 9D 1E 1D 80 A6 A4 0E 57 53 68 9F 54 E2 DE F9 8C
01C0 | A7 CA BA 10 CE FD 0B 78 B3 68 11 03 8D 02 61 B9
01D0 | FA E6 CE 4A 1B 7E 9C C5 69 01 D6 4B C6 D9 1C C3
01E0 | A1 58 84 26 D4 44 9D CC C7 63 85 5A 14 49 03 DF
01F0 | 28 4A AB 04 7C 21 D1 F1 CA C7 A2 37 78 6F A1 18
0200 | B7 0F 11 89 3F 46 5F 82 2D FE C1 2D F6 6B 9A 2B
0210 | DE 02 06 3B AC D9 93 5B B4 4D 7F 9D 49 ED 90 2F
0220 | F0 51 B0 B0 C8 43 55 74 9A 10 BC E6 09 8C A1 BF
0230 | 18 72 60 64 9C BD 9A CC 97 B6 41 4A D6 93 5E 50
0240 | EF 48 BC 18 46 9E 8A C0 28 14 6F D6 AD 2B EF AE
0250 | DB 1A 86 FD 2A D2 BD 0D DE D0 5F D3 66 1F 5C 70
0260 | 19 DE E8 C4 57 4A C1 C1 E8 D4 95 06 55 C6 A2 7F
0270 | 51 D2 F8 58 D9 43 6B 0A D4 71 08 B2 70 7A F2 50
0280 | 34 49 A6 A5 00 4C B8 2E 4A 5C 8B 71</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013C68296349A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8020000</code> (680 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200037BC1F6A9B716E7AF9A55D4</code> <code>77CF5F78430137E263CA908E0FCBC24A</code> <code>D3035D7D7E4183F749EAF6966D6784EB</code> <code>A49E27247D8999CFC494E8F6BA9BDDFF</code> <code>124F1C129817AF50BDB2156DC2CDC479</code> <code>D3D25A8DFAAC481BEDA2C8059B131F34</code> <code>50969BAC0BE35E5E4B7FC5627B7BB6C6</code> <code>433688C00A8D92C1FB206220F5C0CF07</code> <code>AAA427125621F453AC7361D7AC972945</code> <code>A7900E736043515E79623DA4E2AF6C5F</code> <code>E6CBA0E9D10761767142F97029D7E5E8</code> <code>3173FB022C1FCC7A634AF5A059A54439</code> <code>664E46F9C6338FD089871C45806DEE2C</code> <code>3FFD7FCEB371E34C16B127DEC044DAB8</code> <code>5C5EE421EE94AC127456CE98CDB8CC16</code> <code>59B09D6CF5EB15C5DEAB9F70276C055D</code> <code>42386E43F3F73CB841E6FBECE5638E60</code> <code>0518D64DF68EF878D566246F33638848</code> <code>9D0524DCE2081AD965237C6F7B8252EB</code> <code>D4FFD4C12B68F6061FB4CA2AA63E8DC3</code> <code>A4A1059C05D919B9B04D8F1170F5A799</code> <code>2980BD414EAF17B5EC86FE8CC8DFDA29</code> <code>16E4A190AFDEA20CA3E749BE4C24E961</code> <code>E2F65415F81FA81B9D1E1D80A6A40E57</code> <code>53689F54E2DEF98CA7CABA10CEFD0B78</code> <code>B36811038D0261B9FAE6CE4A1B7E9CC5</code> <code>6901D64BC6D91CC3A1588426D4449DCC</code> <code>C763855A144903DF284AAB047C21D1F1</code> <code>CAC7A237786FA118B70F11893F465F82</code> <code>2DFEC12DF66B9A2BDE02063BACD9935B</code> <code>B44D7F9D49ED902FF051B0B0C8435574</code> <code>9A10BCE6098CA1BF187260649CBD9ACC</code> <code>97B6414AD6935E50EF48BC18469E8AC0</code> <code>28146FD6AD2BEFAEDB1A86FD2AD2BD0D</code> <code>DED05FD3661F5C7019DEE8C4574AC1C1</code> <code>E8D4950655C6A27F51D2F858D9436B0A</code> <code>D47108B2707AF2503449A6A5004CB82E</code><br> <code>4A5C8B71</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 037BC1F6A9B716E7AF9A55D477CF5F78430137E263CA908E0FCBC24AD3035D7D7E4183F749EAF6966D6784EBA49E27247D8999CFC494E8F6BA9BDDFF124F1C129817AF50BDB2156DC2CDC479D3D25A8DFAAC481BEDA2C8059B131F3450969BAC0BE35E5E4B7FC5627B7BB6C6433688C00A8D92C1FB206220F5C0CF07AAA427125621F453AC7361D7AC972945A7900E736043515E79623DA4E2AF6C5FE6CBA0E9D10761767142F97029D7E5E83173FB022C1FCC7A634AF5A059A54439664E46F9C6338FD089871C45806DEE2C3FFD7FCEB371E34C16B127DEC044DAB85C5EE421EE94AC127456CE98CDB8CC1659B09D6CF5EB15C5DEAB9F70276C055D42386E43F3F73CB841E6FBECE5638E600518D64DF68EF878D566246F336388489D0524DCE2081AD965237C6F7B8252EBD4FFD4C12B68F6061FB4CA2AA63E8DC3A4A1059C05D919B9B04D8F1170F5A7992980BD414EAF17B5EC86FE8CC8DFDA2916E4A190AFDEA20CA3E749BE4C24E961E2F65415F81FA81B9D1E1D80A6A40E5753689F54E2DEF98CA7CABA10CEFD0B78B36811038D0261B9FAE6CE4A1B7E9CC56901D64BC6D91CC3A1588426D4449DCCC763855A144903DF284AAB047C21D1F1CAC7A237786FA118B70F11893F465F822DFEC12DF66B9A2BDE02063BACD9935BB44D7F9D49ED902FF051B0B0C84355749A10BCE6098CA1BF187260649CBD9ACC97B6414AD6935E50EF48BC18469E8AC028146FD6AD2BEFAEDB1A86FD2AD2BD0DDED05FD3661F5C7019DEE8C4574AC1C1E8D4950655C6A27F51D2F858D9436B0AD47108B2707AF2503449A6A5004CB82E4A5C8B71
tmp_aes_key = 873AEAC281F01185C530BB2596AA459908E09B522E3C379B7CD35A43375E9A1D
tmp_aes_iv = AB3A2342BE66E11F80C7443B553D3A04628F8264C0D282FE36F6C0031E40918F</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1CD7234C459FB90D4D6CF7C76BA4E0F326E01EDDBA0D89B5D931E2CD8A38C2631BA0BAC50BB124D2ADD3FB207B9C6D782E45E74CC46864E703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010044A98C96013842CADC9FB9DEAB71BD4A004D695A3C1A59035903FBFC9AEECCC66D520D17374255211163C5BAC196E3327CD6AB3E89FA61B8CEE8672F2B9B5C1741FEB48CF3459C9BA92536028E2DD52CAF3786AA65E351050B1CD0469B8B2F1E3F71CA6138762DB238E57EABD14CE75FCEECADB493A458A23B7F91B71788003BD97D1B7F409C69857C63E31F7778F7156E85762FF876966699C51F2650C54DCD8C5108AA5C2891F4B8D19E5E66E91354AF1DD3F854208A99950920F6858D8058BD3470B3A5B4D3D0B2AB186E7CB0DEAE6ED923A8A9C5F4529A5D0F7F36C740FB0E37D1D26ED2EC7FE6B15489E4A1869BCDFA7DE1A2E6541894D6A18707CE7F856349A8657DE4F39D0953433D
answer = BA0D89B5D931E2CD8A38C2631BA0BAC50BB124D2ADD3FB207B9C6D782E45E74CC46864E703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010044A98C96013842CADC9FB9DEAB71BD4A004D695A3C1A59035903FBFC9AEECCC66D520D17374255211163C5BAC196E3327CD6AB3E89FA61B8CEE8672F2B9B5C1741FEB48CF3459C9BA92536028E2DD52CAF3786AA65E351050B1CD0469B8B2F1E3F71CA6138762DB238E57EABD14CE75FCEECADB493A458A23B7F91B71788003BD97D1B7F409C69857C63E31F7778F7156E85762FF876966699C51F2650C54DCD8C5108AA5C2891F4B8D19E5E66E91354AF1DD3F854208A99950920F6858D8058BD3470B3A5B4D3D0B2AB186E7CB0DEAE6ED923A8A9C5F4529A5D0F7F36C740FB0E37D1D26ED2EC7FE6B15489E4A1869BCDFA7DE1A2E6541894D6A18707CE7F856349A8657DE4F39D0953433D</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 D9 31 E2 CD 8A 38 C2 63 1B A0 BA C5
0010 | 0B B1 24 D2 AD D3 FB 20 7B 9C 6D 78 2E 45 E7 4C
0020 | C4 68 64 E7 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 44 A9 8C 96 01 38 42 CA DC 9F B9 DE AB 71 BD 4A
0140 | 00 4D 69 5A 3C 1A 59 03 59 03 FB FC 9A EE CC C6
0150 | 6D 52 0D 17 37 42 55 21 11 63 C5 BA C1 96 E3 32
0160 | 7C D6 AB 3E 89 FA 61 B8 CE E8 67 2F 2B 9B 5C 17
0170 | 41 FE B4 8C F3 45 9C 9B A9 25 36 02 8E 2D D5 2C
0180 | AF 37 86 AA 65 E3 51 05 0B 1C D0 46 9B 8B 2F 1E
0190 | 3F 71 CA 61 38 76 2D B2 38 E5 7E AB D1 4C E7 5F
01A0 | CE EC AD B4 93 A4 58 A2 3B 7F 91 B7 17 88 00 3B
01B0 | D9 7D 1B 7F 40 9C 69 85 7C 63 E3 1F 77 78 F7 15
01C0 | 6E 85 76 2F F8 76 96 66 99 C5 1F 26 50 C5 4D CD
01D0 | 8C 51 08 AA 5C 28 91 F4 B8 D1 9E 5E 66 E9 13 54
01E0 | AF 1D D3 F8 54 20 8A 99 95 09 20 F6 85 8D 80 58
01F0 | BD 34 70 B3 A5 B4 D3 D0 B2 AB 18 6E 7C B0 DE AE
0200 | 6E D9 23 A8 A9 C5 F4 52 9A 5D 0F 7F 36 C7 40 FB
0210 | 0E 37 D1 D2 6E D2 EC 7F E6 B1 54 89 E4 A1 86 9B
0220 | CD FA 7D E1 A2 E6 54 18 94 D6 A1 87 07 CE 7F 85
0230 | 63 49 A8 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010044A98C96013842CADC9FB9DE</code> <code>AB71BD4A004D695A3C1A59035903FBFC</code> <code>9AEECCC66D520D17374255211163C5BA</code> <code>C196E3327CD6AB3E89FA61B8CEE8672F</code> <code>2B9B5C1741FEB48CF3459C9BA9253602</code> <code>8E2DD52CAF3786AA65E351050B1CD046</code> <code>9B8B2F1E3F71CA6138762DB238E57EAB</code> <code>D14CE75FCEECADB493A458A23B7F91B7</code> <code>1788003BD97D1B7F409C69857C63E31F</code> <code>7778F7156E85762FF876966699C51F26</code> <code>50C54DCD8C5108AA5C2891F4B8D19E5E</code> <code>66E91354AF1DD3F854208A99950920F6</code> <code>858D8058BD3470B3A5B4D3D0B2AB186E</code> <code>7CB0DEAE6ED923A8A9C5F4529A5D0F7F</code> <code>36C740FB0E37D1D26ED2EC7FE6B15489</code> <code>E4A1869BCDFA7DE1A2E6541894D6A187</code><br> <code>07CE7F85</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>6349A865</code> (1705527651 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = FB94D8ED7FA8E1BAEB9891201DFDEA684BCA26534C00EB89677EA05019A585EFD899653C33888D4744F825BB5658C442A71CBF667999574756A06ECD977A57338138C50F9B6396CB12A8BD715D6E94B38E58D56FF8BF3FDA5BBA884DB1B4D4FFCA8F80C7A66A27DDECB3CDEF57D7FB5BAF56BB29EA193EB293DA0BCA224C5873EA4CED35079AB4145084D8CE16E49011012DA2B3036A1F06026826F73C70E49251FF6D3B6E6E52ACE73EC3234E85222B354D9D1A10DAAB7409763654BDF985D5DC552126713A655FA08EBF839991F6834A3CBBC8320431C526410699612792DBCBB395BC7B33BB898FD9F28A94202DA3CF81E2908B926844B3A34B05CEE382F3</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 5AFE83CCBACB2139ADD46F0E30D4C426488D86CFB5EED390D8AAECF6ECAB600F7FD25C0594069C158D4D2BCCE5C9B51F1DECC257B718CABB91242C981F8E2B33406A2CFF910BBE31C46698491B9295409162B3652CE927A4ABA2B95AE7129DF2E4C9F6F3846843AA2CFCD84C29AB5928DB5629B2DB3AA7556FF279AEDBBE5EDA6F3A46174A869DAFE6F2D9F53FCE489C409D3BF2BCDFB242E7DBA15F7AC9FA12B05CFA2442605016393330F27F991075898FB83963F8101C35932C387AA8377F06CAD5ECB57AB1C6883DB04D403BE1134198BB27104BFF62603377319F2DDFB25F5EE500B10B88BCB96920109233FFD9D7CE06B653D414BB99A9EAAA03D5CED8</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 D9 31 E2 CD 8A 38 C2 63 1B A0 BA C5
0010 | 0B B1 24 D2 AD D3 FB 20 7B 9C 6D 78 2E 45 E7 4C
0020 | C4 68 64 E7 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 5A FE 83 CC BA CB 21 39 AD D4 6F 0E 30 D4 C4 26
0040 | 48 8D 86 CF B5 EE D3 90 D8 AA EC F6 EC AB 60 0F
0050 | 7F D2 5C 05 94 06 9C 15 8D 4D 2B CC E5 C9 B5 1F
0060 | 1D EC C2 57 B7 18 CA BB 91 24 2C 98 1F 8E 2B 33
0070 | 40 6A 2C FF 91 0B BE 31 C4 66 98 49 1B 92 95 40
0080 | 91 62 B3 65 2C E9 27 A4 AB A2 B9 5A E7 12 9D F2
0090 | E4 C9 F6 F3 84 68 43 AA 2C FC D8 4C 29 AB 59 28
00A0 | DB 56 29 B2 DB 3A A7 55 6F F2 79 AE DB BE 5E DA
00B0 | 6F 3A 46 17 4A 86 9D AF E6 F2 D9 F5 3F CE 48 9C
00C0 | 40 9D 3B F2 BC DF B2 42 E7 DB A1 5F 7A C9 FA 12
00D0 | B0 5C FA 24 42 60 50 16 39 33 30 F2 7F 99 10 75
00E0 | 89 8F B8 39 63 F8 10 1C 35 93 2C 38 7A A8 37 7F
00F0 | 06 CA D5 EC B5 7A B1 C6 88 3D B0 4D 40 3B E1 13
0100 | 41 98 BB 27 10 4B FF 62 60 33 77 31 9F 2D DF B2
0110 | 5F 5E E5 00 B1 0B 88 BC B9 69 20 10 92 33 FF D9
0120 | D7 CE 06 B6 53 D4 14 BB 99 A9 EA AA 03 D5 CE D8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001005AFE83CCBACB2139ADD46F0E</code> <code>30D4C426488D86CFB5EED390D8AAECF6</code> <code>ECAB600F7FD25C0594069C158D4D2BCC</code> <code>E5C9B51F1DECC257B718CABB91242C98</code> <code>1F8E2B33406A2CFF910BBE31C4669849</code> <code>1B9295409162B3652CE927A4ABA2B95A</code> <code>E7129DF2E4C9F6F3846843AA2CFCD84C</code> <code>29AB5928DB5629B2DB3AA7556FF279AE</code> <code>DBBE5EDA6F3A46174A869DAFE6F2D9F5</code> <code>3FCE489C409D3BF2BCDFB242E7DBA15F</code> <code>7AC9FA12B05CFA2442605016393330F2</code> <code>7F991075898FB83963F8101C35932C38</code> <code>7AA8377F06CAD5ECB57AB1C6883DB04D</code> <code>403BE1134198BB27104BFF6260337731</code> <code>9F2DDFB25F5EE500B10B88BCB9692010</code> <code>9233FFD9D7CE06B653D414BB99A9EAAA</code><br> <code>03D5CED8</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366D931E2CD8A38C2631BA0BAC50BB124D2ADD3FB207B9C6D782E45E74CC46864E70000000000000000FE0001005AFE83CCBACB2139ADD46F0E30D4C426488D86CFB5EED390D8AAECF6ECAB600F7FD25C0594069C158D4D2BCCE5C9B51F1DECC257B718CABB91242C981F8E2B33406A2CFF910BBE31C46698491B9295409162B3652CE927A4ABA2B95AE7129DF2E4C9F6F3846843AA2CFCD84C29AB5928DB5629B2DB3AA7556FF279AEDBBE5EDA6F3A46174A869DAFE6F2D9F53FCE489C409D3BF2BCDFB242E7DBA15F7AC9FA12B05CFA2442605016393330F27F991075898FB83963F8101C35932C387AA8377F06CAD5ECB57AB1C6883DB04D403BE1134198BB27104BFF62603377319F2DDFB25F5EE500B10B88BCB96920109233FFD9D7CE06B653D414BB99A9EAAA03D5CED8
padding = 54D2BB588DD01761BBD25523
tmp_aes_key = 873AEAC281F01185C530BB2596AA459908E09B522E3C379B7CD35A43375E9A1D
tmp_aes_iv = AB3A2342BE66E11F80C7443B553D3A04628F8264C0D282FE36F6C0031E40918F</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 5C0479CAA1F2AEBA4586CE457147B6F6E0E82B76F48629CA40DE224ED1623F43C41F067CEB12A3A9DF4CCFEE9389D9B6F2797FE66B5CD0A20DA78CA52D6D32FD04040D9E98ACCAACD7BC6B393B6E744DFA7D6546ECBA819F8B6ECFCC1832103193780FAE82AB6E11F3F1706B21688D041AE90241873BABDFCEA9C2936DDECFC96D4216C945255D8CB4E172A63E2175B714E794EB92A0A084B8B0A9F3BBFF17D912706A1EDEF2D4BE2E512066AFA9ADE4CB0D530A0A8588A7E87E99010D6F8A85782876B7EE45C3A8C3DC8E601248BDF950CBEEA3C925BC37B47E1F3B40A7C3A91EC719846EF473C969520D8D962C3798FB562646AF1B35D97E572DB5CF8293E385A9450495FBCA19FEEDF9F029149B89C3BC62BEE540FFED18DEFF2D1F791E2B755234E8A6DE012FFC824A35F98522B73D6D9168F4397FB0A7B3303C1D81CD4BF2F2B53F5E9AA49BCC8E5AAEFDD65672</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E8 37 0E 00 63 49 A8 65
0010 | 78 01 00 00 1F 5F 04 F5 D9 31 E2 CD 8A 38 C2 63
0020 | 1B A0 BA C5 0B B1 24 D2 AD D3 FB 20 7B 9C 6D 78
0030 | 2E 45 E7 4C C4 68 64 E7 FE 50 01 00 5C 04 79 CA
0040 | A1 F2 AE BA 45 86 CE 45 71 47 B6 F6 E0 E8 2B 76
0050 | F4 86 29 CA 40 DE 22 4E D1 62 3F 43 C4 1F 06 7C
0060 | EB 12 A3 A9 DF 4C CF EE 93 89 D9 B6 F2 79 7F E6
0070 | 6B 5C D0 A2 0D A7 8C A5 2D 6D 32 FD 04 04 0D 9E
0080 | 98 AC CA AC D7 BC 6B 39 3B 6E 74 4D FA 7D 65 46
0090 | EC BA 81 9F 8B 6E CF CC 18 32 10 31 93 78 0F AE
00A0 | 82 AB 6E 11 F3 F1 70 6B 21 68 8D 04 1A E9 02 41
00B0 | 87 3B AB DF CE A9 C2 93 6D DE CF C9 6D 42 16 C9
00C0 | 45 25 5D 8C B4 E1 72 A6 3E 21 75 B7 14 E7 94 EB
00D0 | 92 A0 A0 84 B8 B0 A9 F3 BB FF 17 D9 12 70 6A 1E
00E0 | DE F2 D4 BE 2E 51 20 66 AF A9 AD E4 CB 0D 53 0A
00F0 | 0A 85 88 A7 E8 7E 99 01 0D 6F 8A 85 78 28 76 B7
0100 | EE 45 C3 A8 C3 DC 8E 60 12 48 BD F9 50 CB EE A3
0110 | C9 25 BC 37 B4 7E 1F 3B 40 A7 C3 A9 1E C7 19 84
0120 | 6E F4 73 C9 69 52 0D 8D 96 2C 37 98 FB 56 26 46
0130 | AF 1B 35 D9 7E 57 2D B5 CF 82 93 E3 85 A9 45 04
0140 | 95 FB CA 19 FE ED F9 F0 29 14 9B 89 C3 BC 62 BE
0150 | E5 40 FF ED 18 DE FF 2D 1F 79 1E 2B 75 52 34 E8
0160 | A6 DE 01 2F FC 82 4A 35 F9 85 22 B7 3D 6D 91 68
0170 | F4 39 7F B0 A7 B3 30 3C 1D 81 CD 4B F2 F2 B5 3F
0180 | 5E 9A A4 9B CC 8E 5A AE FD D6 56 72</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E8370E006349A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001005C0479CAA1F2AEBA4586CE45</code> <code>7147B6F6E0E82B76F48629CA40DE224E</code> <code>D1623F43C41F067CEB12A3A9DF4CCFEE</code> <code>9389D9B6F2797FE66B5CD0A20DA78CA5</code> <code>2D6D32FD04040D9E98ACCAACD7BC6B39</code> <code>3B6E744DFA7D6546ECBA819F8B6ECFCC</code> <code>1832103193780FAE82AB6E11F3F1706B</code> <code>21688D041AE90241873BABDFCEA9C293</code> <code>6DDECFC96D4216C945255D8CB4E172A6</code> <code>3E2175B714E794EB92A0A084B8B0A9F3</code> <code>BBFF17D912706A1EDEF2D4BE2E512066</code> <code>AFA9ADE4CB0D530A0A8588A7E87E9901</code> <code>0D6F8A85782876B7EE45C3A8C3DC8E60</code> <code>1248BDF950CBEEA3C925BC37B47E1F3B</code> <code>40A7C3A91EC719846EF473C969520D8D</code> <code>962C3798FB562646AF1B35D97E572DB5</code> <code>CF8293E385A9450495FBCA19FEEDF9F0</code> <code>29149B89C3BC62BEE540FFED18DEFF2D</code> <code>1F791E2B755234E8A6DE012FFC824A35</code> <code>F98522B73D6D9168F4397FB0A7B3303C</code> <code>1D81CD4BF2F2B53F5E9AA49BCC8E5AAE</code><br> <code>FDD65672</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7D2A13F3E72E119A0A89302E9FD40E357757E02E8C7FF0D4E6CA8153F28951C4A017C8237385221E629EDC35838CA2A284600907C60044056F64C144B5B6F07AEE1BB0C29D743FF2010E58E1E65D142AF4F86DC549200C39776D7663288BC1C16A52222767052424817AEB81AD2032B2B95F9CF8BE1532E950C09064328F5911AE5E781092CACD7993A4F987EC3B6E1D5B3A88B456B7FC0B6BD642222C0C42E712D7A9179F984F76CBF825459E0467298C9DBF781A7563955F404E0C8612D95FE852DC33A07EA4FEC73B128E6DCE8C18951C558AAFA1BBC890CE2D01C606505227FA71DA5EF1DB61FB8E31C602024284A6264C5CCDBD03DCE6B78AB130B37446</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 20 22 1D 64 49 A8 65
0010 | 9C 00 00 00 34 F7 CB 3B D9 31 E2 CD 8A 38 C2 63
0020 | 1B A0 BA C5 0B B1 24 D2 AD D3 FB 20 7B 9C 6D 78
0030 | 2E 45 E7 4C C4 68 64 E7 2D 23 7E 1C DF BB EA B0
0040 | DB E7 EA 77 58 44 CE 12</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0120221D6449A865</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>9C000000</code> (156 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D931E2CD8A38C2631BA0BAC50BB124D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ADD3FB207B9C6D782E45E74CC46864E7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>2D237E1CDFBBEAB0DBE7EA775844CE12</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

