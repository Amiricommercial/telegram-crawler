<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 75 02 00 B1 14 AC 65
0010 | 14 00 00 00 F1 8E 7E BE E9 78 DB B0 74 3F E9 90
0020 | 23 90 8D 35 49 A9 D0 3E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>44750200B114AC65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A4 5F 52 B1 14 AC 65
0010 | BC 00 00 00 63 24 16 05 E9 78 DB B0 74 3F E9 90
0020 | 23 90 8D 35 49 A9 D0 3E 43 7A 52 81 56 6B 8D D1
0030 | B4 C2 39 1A 28 03 40 0C 08 15 BB 46 F8 61 C2 9A
0040 | E7 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A45F52B114AC65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC000000</code> (188 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0815BB46F861C29AE7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1565923328047356647</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1565923328047356647</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1565923328047356647 = 1171349233 * 1336854359</code></p>
<pre><code>p = 1171349233
q = 1336854359</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 15 BB 46 F8 61 C2 9A E7 00 00 00
0010 | 04 45 D1 5E F1 00 00 00 04 4F AE C7 57 00 00 00
0020 | E9 78 DB B0 74 3F E9 90 23 90 8D 35 49 A9 D0 3E
0030 | 43 7A 52 81 56 6B 8D D1 B4 C2 39 1A 28 03 40 0C
0040 | 73 D7 F0 C7 7D FB 49 EB BC 51 8F 5D 94 9D 71 FC
0050 | 34 A1 32 6A E4 61 F9 6C 05 E8 E4 04 DD B2 F7 4E
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0815BB46F861C29AE7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1565923328047356647</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0445D15EF1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1171349233</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044FAEC757000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1336854359</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>73D7F0C77DFB49EBBC518F5D949D71FC</code> <code>34A1326AE461F96C05E8E404DDB2F74E</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90815BB46F861C29AE70000000445D15EF1000000044FAEC757000000E978DBB0743FE99023908D3549A9D03E437A5281566B8DD1B4C2391A2803400C73D7F0C77DFB49EBBC518F5D949D71FC34A1326AE461F96C05E8E404DDB2F74E02000000
random_padding_bytes = 14BF6A70E3F550467FAE1BE28E80F43545AEEFD410661367EF0D1FE2C1DB27F312549AA75E13C15C17417F2535F10CADADE45FB8EC24FFFE33DB2B6BF2980D491991904D1FFBEBF398DDC890E218AACB21C25D1C0C0F7935E596126E</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = ADBAFD9A9BF1E23B77A1C20D6D1A7EFFF9D678D6ABD122378D9ED8E09A4E5A33FD3519B821D339F0CB2CC6E7ADBCAC7C754698508AB7B024C61F48E4084CDA4DDEE413A65D729E5D09ACFAAC5F2FF93141C02126794A2475A6428F4D094EFF3D5DF111BD2AEBB4F38D07728D622C7DC536D284AC71F9F980264B3E5E9A281E849E99B0A9DA817775481BB623F1F2F915FD955427D6D823C03EC30FBA9D810D195177B5EFE322DBCDF60862E5EA44FE0A56B6CF6A9017A25ADB52F7935A31E033763C4DBD47E5F507D8ED216D6CF7029AC7F7B85CF50CBDA91423F545D73A497FC26885A1CDF464728BAF0FBC07523556CE9C3C5AA02F516F26997BF54F8CF4C7</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 80 E8 05 00 B1 14 AC 65
0010 | 40 01 00 00 BE E4 12 D7 E9 78 DB B0 74 3F E9 90
0020 | 23 90 8D 35 49 A9 D0 3E 43 7A 52 81 56 6B 8D D1
0030 | B4 C2 39 1A 28 03 40 0C 04 45 D1 5E F1 00 00 00
0040 | 04 4F AE C7 57 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 AD BA FD 9A 9B F1 E2 3B 77 A1 C2 0D
0060 | 6D 1A 7E FF F9 D6 78 D6 AB D1 22 37 8D 9E D8 E0
0070 | 9A 4E 5A 33 FD 35 19 B8 21 D3 39 F0 CB 2C C6 E7
0080 | AD BC AC 7C 75 46 98 50 8A B7 B0 24 C6 1F 48 E4
0090 | 08 4C DA 4D DE E4 13 A6 5D 72 9E 5D 09 AC FA AC
00A0 | 5F 2F F9 31 41 C0 21 26 79 4A 24 75 A6 42 8F 4D
00B0 | 09 4E FF 3D 5D F1 11 BD 2A EB B4 F3 8D 07 72 8D
00C0 | 62 2C 7D C5 36 D2 84 AC 71 F9 F9 80 26 4B 3E 5E
00D0 | 9A 28 1E 84 9E 99 B0 A9 DA 81 77 75 48 1B B6 23
00E0 | F1 F2 F9 15 FD 95 54 27 D6 D8 23 C0 3E C3 0F BA
00F0 | 9D 81 0D 19 51 77 B5 EF E3 22 DB CD F6 08 62 E5
0100 | EA 44 FE 0A 56 B6 CF 6A 90 17 A2 5A DB 52 F7 93
0110 | 5A 31 E0 33 76 3C 4D BD 47 E5 F5 07 D8 ED 21 6D
0120 | 6C F7 02 9A C7 F7 B8 5C F5 0C BD A9 14 23 F5 45
0130 | D7 3A 49 7F C2 68 85 A1 CD F4 64 72 8B AF 0F BC
0140 | 07 52 35 56 CE 9C 3C 5A A0 2F 51 6F 26 99 7B F5
0150 | 4F 8C F4 C7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>80E80500B114AC65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0445D15EF1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1171349233</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044FAEC757000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1336854359</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100ADBAFD9A9BF1E23B77A1C20D</code> <code>6D1A7EFFF9D678D6ABD122378D9ED8E0</code> <code>9A4E5A33FD3519B821D339F0CB2CC6E7</code> <code>ADBCAC7C754698508AB7B024C61F48E4</code> <code>084CDA4DDEE413A65D729E5D09ACFAAC</code> <code>5F2FF93141C02126794A2475A6428F4D</code> <code>094EFF3D5DF111BD2AEBB4F38D07728D</code> <code>622C7DC536D284AC71F9F980264B3E5E</code> <code>9A281E849E99B0A9DA817775481BB623</code> <code>F1F2F915FD955427D6D823C03EC30FBA</code> <code>9D810D195177B5EFE322DBCDF60862E5</code> <code>EA44FE0A56B6CF6A9017A25ADB52F793</code> <code>5A31E033763C4DBD47E5F507D8ED216D</code> <code>6CF7029AC7F7B85CF50CBDA91423F545</code> <code>D73A497FC26885A1CDF464728BAF0FBC</code> <code>07523556CE9C3C5AA02F516F26997BF5</code><br> <code>4F8CF4C7</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C 64 FF B1 14 AC 65
0010 | 90 02 00 00 5C 07 E8 D0 E9 78 DB B0 74 3F E9 90
0020 | 23 90 8D 35 49 A9 D0 3E 43 7A 52 81 56 6B 8D D1
0030 | B4 C2 39 1A 28 03 40 0C FE 50 02 00 D9 77 C0 F7
0040 | 92 34 D1 4B A4 3A C0 C7 A9 42 95 0F CC 70 66 E8
0050 | A8 4F 8B F4 BF EB 2D 77 A3 1C EE BC B5 6A E0 78
0060 | A8 D9 D4 F0 9D 4C 17 D7 0C 0C 56 9F 08 E4 EC B3
0070 | FD 90 4E 08 42 2D 08 31 DF 12 F1 A7 87 5F 23 3E
0080 | BE 0B DF DD 73 14 8B 9A D1 80 A3 06 2C 6A 8B BF
0090 | 3B 5B 96 6F CF 0C 75 1A A0 57 88 4B 3D D1 75 87
00A0 | E7 69 70 C3 79 F4 8A 0D FD BF 9A 75 A4 46 1F E8
00B0 | C5 EE 3B 00 29 60 19 E9 B3 9F 24 A1 3F 10 42 E0
00C0 | 6F 35 69 5F FE 17 87 8D BE 96 73 E2 31 E3 68 D9
00D0 | CF 87 73 32 4D DE 2F 62 C6 77 DA C2 CF EC F4 0E
00E0 | 40 BD 41 4B BB BF 77 79 A8 63 0A C9 B4 05 88 28
00F0 | AF 60 8D A6 3E 91 E5 9E CA C6 AE 23 4C 69 B0 EE
0100 | 8B 57 F0 C9 D6 9A DA 34 10 08 86 85 07 9A 7F A6
0110 | F7 09 EB 8E 9F 82 1D 24 1F EA 13 C5 DA 6D 0F F5
0120 | 6D 6F 90 0A 40 AA 84 8B F5 CC 44 CB 09 8A 85 7B
0130 | 6B 59 7D C5 23 CA 54 4D 74 DE 63 2D C2 C9 87 A6
0140 | 59 01 24 73 F3 3D 59 47 83 54 47 BE B2 BB D7 4C
0150 | F1 9C 15 9F 34 B6 84 20 81 78 A6 C9 FD 6F 9A 54
0160 | CF F2 8E C7 24 A9 FF 2E 19 C3 79 09 CE E7 4C 3F
0170 | F3 54 04 4A 30 3B 70 EC 69 1F A0 A3 BD F5 A3 FA
0180 | A2 26 D9 00 98 75 7B 3D E0 AF 9A 4C 27 47 97 85
0190 | 4A 5B 35 C9 F5 8E 68 37 A0 E9 A1 5E B3 78 6B AC
01A0 | E8 71 B8 C6 AB C0 69 3B 41 40 5D 9B C2 07 D8 DE
01B0 | 04 D3 F4 2C E5 68 48 19 CD 0C 48 C9 9F C5 77 76
01C0 | 25 86 F7 25 16 2A 21 A0 95 7E A4 FD 15 C5 5E A6
01D0 | 4D CE 91 15 33 7A 9C 5B 18 D8 16 CC 3A 99 33 A4
01E0 | 83 61 D0 5A F1 4F 99 8E 28 18 9D 14 BA 60 75 55
01F0 | 96 26 95 D5 0A 24 D7 A7 D2 FE D4 7E 39 E2 C5 7B
0200 | F1 1A 67 8C E4 F6 95 7F 90 A5 AC C6 5E 12 77 CF
0210 | A2 DE 4E 5F 63 AE 9B 30 9F 04 EC CD 93 E1 AE 07
0220 | 74 BD ED 7B 64 51 45 18 15 03 8C 5A 93 56 32 17
0230 | C7 3D 5F 69 25 93 EB FE 28 FC 3C D7 5A B7 3F 14
0240 | C6 8C 57 F2 41 BA FD B9 B1 48 78 30 47 B3 1C 78
0250 | 23 85 C7 8D 2D D9 6E 45 79 DF 46 E3 D0 49 D5 0F
0260 | 18 C3 D7 1E 92 2D 07 DC E9 BA 40 7B C3 D3 BF 76
0270 | A1 88 E9 41 39 82 CD EA 98 78 AA 52 61 10 16 11
0280 | 7D F9 8B F9 4B 67 85 55 CA 95 CA AD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017C64FFB114AC65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90020000</code> (656 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200D977C0F79234D14BA43AC0C7</code> <code>A942950FCC7066E8A84F8BF4BFEB2D77</code> <code>A31CEEBCB56AE078A8D9D4F09D4C17D7</code> <code>0C0C569F08E4ECB3FD904E08422D0831</code> <code>DF12F1A7875F233EBE0BDFDD73148B9A</code> <code>D180A3062C6A8BBF3B5B966FCF0C751A</code> <code>A057884B3DD17587E76970C379F48A0D</code> <code>FDBF9A75A4461FE8C5EE3B00296019E9</code> <code>B39F24A13F1042E06F35695FFE17878D</code> <code>BE9673E231E368D9CF8773324DDE2F62</code> <code>C677DAC2CFECF40E40BD414BBBBF7779</code> <code>A8630AC9B4058828AF608DA63E91E59E</code> <code>CAC6AE234C69B0EE8B57F0C9D69ADA34</code> <code>10088685079A7FA6F709EB8E9F821D24</code> <code>1FEA13C5DA6D0FF56D6F900A40AA848B</code> <code>F5CC44CB098A857B6B597DC523CA544D</code> <code>74DE632DC2C987A659012473F33D5947</code> <code>835447BEB2BBD74CF19C159F34B68420</code> <code>8178A6C9FD6F9A54CFF28EC724A9FF2E</code> <code>19C37909CEE74C3FF354044A303B70EC</code> <code>691FA0A3BDF5A3FAA226D90098757B3D</code> <code>E0AF9A4C274797854A5B35C9F58E6837</code> <code>A0E9A15EB3786BACE871B8C6ABC0693B</code> <code>41405D9BC207D8DE04D3F42CE5684819</code> <code>CD0C48C99FC577762586F725162A21A0</code> <code>957EA4FD15C55EA64DCE9115337A9C5B</code> <code>18D816CC3A9933A48361D05AF14F998E</code> <code>28189D14BA607555962695D50A24D7A7</code> <code>D2FED47E39E2C57BF11A678CE4F6957F</code> <code>90A5ACC65E1277CFA2DE4E5F63AE9B30</code> <code>9F04ECCD93E1AE0774BDED7B64514518</code> <code>15038C5A93563217C73D5F692593EBFE</code> <code>28FC3CD75AB73F14C68C57F241BAFDB9</code> <code>B148783047B31C782385C78D2DD96E45</code> <code>79DF46E3D049D50F18C3D71E922D07DC</code> <code>E9BA407BC3D3BF76A188E9413982CDEA</code> <code>9878AA52611016117DF98BF94B678555</code><br> <code>CA95CAAD</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = D977C0F79234D14BA43AC0C7A942950FCC7066E8A84F8BF4BFEB2D77A31CEEBCB56AE078A8D9D4F09D4C17D70C0C569F08E4ECB3FD904E08422D0831DF12F1A7875F233EBE0BDFDD73148B9AD180A3062C6A8BBF3B5B966FCF0C751AA057884B3DD17587E76970C379F48A0DFDBF9A75A4461FE8C5EE3B00296019E9B39F24A13F1042E06F35695FFE17878DBE9673E231E368D9CF8773324DDE2F62C677DAC2CFECF40E40BD414BBBBF7779A8630AC9B4058828AF608DA63E91E59ECAC6AE234C69B0EE8B57F0C9D69ADA3410088685079A7FA6F709EB8E9F821D241FEA13C5DA6D0FF56D6F900A40AA848BF5CC44CB098A857B6B597DC523CA544D74DE632DC2C987A659012473F33D5947835447BEB2BBD74CF19C159F34B684208178A6C9FD6F9A54CFF28EC724A9FF2E19C37909CEE74C3FF354044A303B70EC691FA0A3BDF5A3FAA226D90098757B3DE0AF9A4C274797854A5B35C9F58E6837A0E9A15EB3786BACE871B8C6ABC0693B41405D9BC207D8DE04D3F42CE5684819CD0C48C99FC577762586F725162A21A0957EA4FD15C55EA64DCE9115337A9C5B18D816CC3A9933A48361D05AF14F998E28189D14BA607555962695D50A24D7A7D2FED47E39E2C57BF11A678CE4F6957F90A5ACC65E1277CFA2DE4E5F63AE9B309F04ECCD93E1AE0774BDED7B6451451815038C5A93563217C73D5F692593EBFE28FC3CD75AB73F14C68C57F241BAFDB9B148783047B31C782385C78D2DD96E4579DF46E3D049D50F18C3D71E922D07DCE9BA407BC3D3BF76A188E9413982CDEA9878AA52611016117DF98BF94B678555CA95CAAD
tmp_aes_key = 9D464C45BFDBF0975744920C88FBCD9F83D23DF794CB0C0CCCEF73FA533221EC
tmp_aes_iv = 003930D9E4EE401EA2A0EDC81E549AA70E9379EE97C2AEE9B901A95C73D7F0C7</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 9FE17F63CD99657B72F874E8B9D51DB3CB70E5CFBA0D89B5E978DBB0743FE99023908D3549A9D03E437A5281566B8DD1B4C2391A2803400C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010052A783B9A22EC1DC4969B37491A7A52FAD830D2F81686502E224E589F92EFFCA4C03D9F0C542D30E89DC227B512637FEDA0035E8C68FC044835F3BB0A3E48DF78A640615158528537E190482C475319332C43AC35368AE9857CC80C04B795536BDA9CF3C506391265DF2094CCAD5E2EB5F0BAAC34E3FBB70F181A9203ADC595BE225CF32999F67E3C190B684B72387972337DA5517A4E7746AE569F7995B5DA276AD97284BE85C15157CDAD9BE287167812ECDEF9903C2A3D2C2693ED2BBF9190F4E65D56BC8F1AE75F6A7986AC9A214CBF9E7599D099C8B60DAA9DC4425A9CA016BDF8B7A9582540F5F66BBDC5FFF9F878982976290BE974DA5A7397E454C35B114AC651D04E47BD0474E2C
answer = BA0D89B5E978DBB0743FE99023908D3549A9D03E437A5281566B8DD1B4C2391A2803400C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010052A783B9A22EC1DC4969B37491A7A52FAD830D2F81686502E224E589F92EFFCA4C03D9F0C542D30E89DC227B512637FEDA0035E8C68FC044835F3BB0A3E48DF78A640615158528537E190482C475319332C43AC35368AE9857CC80C04B795536BDA9CF3C506391265DF2094CCAD5E2EB5F0BAAC34E3FBB70F181A9203ADC595BE225CF32999F67E3C190B684B72387972337DA5517A4E7746AE569F7995B5DA276AD97284BE85C15157CDAD9BE287167812ECDEF9903C2A3D2C2693ED2BBF9190F4E65D56BC8F1AE75F6A7986AC9A214CBF9E7599D099C8B60DAA9DC4425A9CA016BDF8B7A9582540F5F66BBDC5FFF9F878982976290BE974DA5A7397E454C35B114AC651D04E47BD0474E2C</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E9 78 DB B0 74 3F E9 90 23 90 8D 35
0010 | 49 A9 D0 3E 43 7A 52 81 56 6B 8D D1 B4 C2 39 1A
0020 | 28 03 40 0C 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 52 A7 83 B9 A2 2E C1 DC 49 69 B3 74 91 A7 A5 2F
0140 | AD 83 0D 2F 81 68 65 02 E2 24 E5 89 F9 2E FF CA
0150 | 4C 03 D9 F0 C5 42 D3 0E 89 DC 22 7B 51 26 37 FE
0160 | DA 00 35 E8 C6 8F C0 44 83 5F 3B B0 A3 E4 8D F7
0170 | 8A 64 06 15 15 85 28 53 7E 19 04 82 C4 75 31 93
0180 | 32 C4 3A C3 53 68 AE 98 57 CC 80 C0 4B 79 55 36
0190 | BD A9 CF 3C 50 63 91 26 5D F2 09 4C CA D5 E2 EB
01A0 | 5F 0B AA C3 4E 3F BB 70 F1 81 A9 20 3A DC 59 5B
01B0 | E2 25 CF 32 99 9F 67 E3 C1 90 B6 84 B7 23 87 97
01C0 | 23 37 DA 55 17 A4 E7 74 6A E5 69 F7 99 5B 5D A2
01D0 | 76 AD 97 28 4B E8 5C 15 15 7C DA D9 BE 28 71 67
01E0 | 81 2E CD EF 99 03 C2 A3 D2 C2 69 3E D2 BB F9 19
01F0 | 0F 4E 65 D5 6B C8 F1 AE 75 F6 A7 98 6A C9 A2 14
0200 | CB F9 E7 59 9D 09 9C 8B 60 DA A9 DC 44 25 A9 CA
0210 | 01 6B DF 8B 7A 95 82 54 0F 5F 66 BB DC 5F FF 9F
0220 | 87 89 82 97 62 90 BE 97 4D A5 A7 39 7E 45 4C 35
0230 | B1 14 AC 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010052A783B9A22EC1DC4969B374</code> <code>91A7A52FAD830D2F81686502E224E589</code> <code>F92EFFCA4C03D9F0C542D30E89DC227B</code> <code>512637FEDA0035E8C68FC044835F3BB0</code> <code>A3E48DF78A640615158528537E190482</code> <code>C475319332C43AC35368AE9857CC80C0</code> <code>4B795536BDA9CF3C506391265DF2094C</code> <code>CAD5E2EB5F0BAAC34E3FBB70F181A920</code> <code>3ADC595BE225CF32999F67E3C190B684</code> <code>B72387972337DA5517A4E7746AE569F7</code> <code>995B5DA276AD97284BE85C15157CDAD9</code> <code>BE287167812ECDEF9903C2A3D2C2693E</code> <code>D2BBF9190F4E65D56BC8F1AE75F6A798</code> <code>6AC9A214CBF9E7599D099C8B60DAA9DC</code> <code>4425A9CA016BDF8B7A9582540F5F66BB</code> <code>DC5FFF9F878982976290BE974DA5A739</code><br> <code>7E454C35</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B114AC65</code> (1705776305 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = F5167391C60A0EBDA2071C37A5E084D06D9C9228E862ECF0013E0BE74D9D1B2358415A696DA68FAAD9A7CDFDE5898343729BEFDBF4B15A62B477EBEED313012BD021F140032F30EC34AEDDB670464597EACFB25E0FB2D3E7ABFF2EE60264DA115731A81549E90DDB3D3BD6DF365F9D026FF5DE53075047CD3B0AF9B8B97ADB1E9608C5DB1EBD9BC4BEB54A9B5F263F9604A6B445BD611E0E3A02B0161C7345489DE26658E51D2B38B726AAC82084782CCC2E81CD1333720201048B483D7F2763CA43EA25BBFA3FCFB32DCE197F3F89585B4D2E3FBBC130E22D8A76B5F06C7DABA35BD8D511A7078D41E64356CA0C9353A9397E1FD2BBF784C7BAB9E492096012</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = C2246172FFB04B371A24EE430BD735394280ED1B34AB0E59F865498B2C7FC4D795E3E71A0D2B80D8F9FF0FCDA262E52AFE0C5FF3B1B09911091E8A8D885D8C017B622D2560BC4487FAE42E04E1971D16C4BF6B88E2AC632385719A31236B7F2B417022E0865A046003D5B320DEB3B2CA845CEDB0EFB5BDCAF0F5F2F2B17249FD42CEE616EC64EC02C6B10C33BAFEE67FD13D4283EFE2E399B3ED006B4184295EA69B991083F083617D5875AE7BE5027281C1FA33E6D408FE500EE45DFC11913C54E4B5F3E247A998917F4BDE2CDFE952B7D6C820B8682A1EC974B44147E3A2D1CC9938DE9B3F2061C80FF0B67A5446F90F11BFFE48652653E0EE4DE1FEC5268C</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E9 78 DB B0 74 3F E9 90 23 90 8D 35
0010 | 49 A9 D0 3E 43 7A 52 81 56 6B 8D D1 B4 C2 39 1A
0020 | 28 03 40 0C 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | C2 24 61 72 FF B0 4B 37 1A 24 EE 43 0B D7 35 39
0040 | 42 80 ED 1B 34 AB 0E 59 F8 65 49 8B 2C 7F C4 D7
0050 | 95 E3 E7 1A 0D 2B 80 D8 F9 FF 0F CD A2 62 E5 2A
0060 | FE 0C 5F F3 B1 B0 99 11 09 1E 8A 8D 88 5D 8C 01
0070 | 7B 62 2D 25 60 BC 44 87 FA E4 2E 04 E1 97 1D 16
0080 | C4 BF 6B 88 E2 AC 63 23 85 71 9A 31 23 6B 7F 2B
0090 | 41 70 22 E0 86 5A 04 60 03 D5 B3 20 DE B3 B2 CA
00A0 | 84 5C ED B0 EF B5 BD CA F0 F5 F2 F2 B1 72 49 FD
00B0 | 42 CE E6 16 EC 64 EC 02 C6 B1 0C 33 BA FE E6 7F
00C0 | D1 3D 42 83 EF E2 E3 99 B3 ED 00 6B 41 84 29 5E
00D0 | A6 9B 99 10 83 F0 83 61 7D 58 75 AE 7B E5 02 72
00E0 | 81 C1 FA 33 E6 D4 08 FE 50 0E E4 5D FC 11 91 3C
00F0 | 54 E4 B5 F3 E2 47 A9 98 91 7F 4B DE 2C DF E9 52
0100 | B7 D6 C8 20 B8 68 2A 1E C9 74 B4 41 47 E3 A2 D1
0110 | CC 99 38 DE 9B 3F 20 61 C8 0F F0 B6 7A 54 46 F9
0120 | 0F 11 BF FE 48 65 26 53 E0 EE 4D E1 FE C5 26 8C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100C2246172FFB04B371A24EE43</code> <code>0BD735394280ED1B34AB0E59F865498B</code> <code>2C7FC4D795E3E71A0D2B80D8F9FF0FCD</code> <code>A262E52AFE0C5FF3B1B09911091E8A8D</code> <code>885D8C017B622D2560BC4487FAE42E04</code> <code>E1971D16C4BF6B88E2AC632385719A31</code> <code>236B7F2B417022E0865A046003D5B320</code> <code>DEB3B2CA845CEDB0EFB5BDCAF0F5F2F2</code> <code>B17249FD42CEE616EC64EC02C6B10C33</code> <code>BAFEE67FD13D4283EFE2E399B3ED006B</code> <code>4184295EA69B991083F083617D5875AE</code> <code>7BE5027281C1FA33E6D408FE500EE45D</code> <code>FC11913C54E4B5F3E247A998917F4BDE</code> <code>2CDFE952B7D6C820B8682A1EC974B441</code> <code>47E3A2D1CC9938DE9B3F2061C80FF0B6</code> <code>7A5446F90F11BFFE48652653E0EE4DE1</code><br> <code>FEC5268C</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E978DBB0743FE99023908D3549A9D03E437A5281566B8DD1B4C2391A2803400C0000000000000000FE000100C2246172FFB04B371A24EE430BD735394280ED1B34AB0E59F865498B2C7FC4D795E3E71A0D2B80D8F9FF0FCDA262E52AFE0C5FF3B1B09911091E8A8D885D8C017B622D2560BC4487FAE42E04E1971D16C4BF6B88E2AC632385719A31236B7F2B417022E0865A046003D5B320DEB3B2CA845CEDB0EFB5BDCAF0F5F2F2B17249FD42CEE616EC64EC02C6B10C33BAFEE67FD13D4283EFE2E399B3ED006B4184295EA69B991083F083617D5875AE7BE5027281C1FA33E6D408FE500EE45DFC11913C54E4B5F3E247A998917F4BDE2CDFE952B7D6C820B8682A1EC974B44147E3A2D1CC9938DE9B3F2061C80FF0B67A5446F90F11BFFE48652653E0EE4DE1FEC5268C
padding = A239ABEDF75DB73AFA1FD7B5
tmp_aes_key = 9D464C45BFDBF0975744920C88FBCD9F83D23DF794CB0C0CCCEF73FA533221EC
tmp_aes_iv = 003930D9E4EE401EA2A0EDC81E549AA70E9379EE97C2AEE9B901A95C73D7F0C7</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 9508FE98AACA0EA3897250A9C454D0F0AB67F4FCA1CC99EC031F0AF84D974D8A75475F6420E58A86C2162A6BD3B06B6D5D61F2098858E0C3505FCF294C3E4CD9F251BE6533816F7CE7F22341E3D021F4BD4EF4551ABFA446A36D3906BC90F29D74DA0BBDA55C85A6DA2C7C4A75B9A883BD65C28981E496390473D2D33AEAB86E3C593BE41BD8BA311A521876B976F58115B41B27DE29EE80422080F4BC7CD673A965FE9C2BCB29B5F979650387F35550FD7E119FBF585576F15AA5354C0AA69A8D070382A93B0882F979E9265C5E6D63159C5578057856D5D71804E361A35DA8B3DD2A8E2E8692E7F8414D218DCD805D9A0C20B7BD77CF2052E0DF16C1BA9932B43B27A08D1FD1ECDD43A6B08297BA7CBD74E43434B85E67845246EF52AC0874612156FA30DF5EE6EA9F4AD3726E044B9E477FFE89D4682B6DCE3A63381FDB05B53C28EDD64EA8D376D3A458A02204FE</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 A0 09 00 B1 14 AC 65
0010 | 78 01 00 00 1F 5F 04 F5 E9 78 DB B0 74 3F E9 90
0020 | 23 90 8D 35 49 A9 D0 3E 43 7A 52 81 56 6B 8D D1
0030 | B4 C2 39 1A 28 03 40 0C FE 50 01 00 95 08 FE 98
0040 | AA CA 0E A3 89 72 50 A9 C4 54 D0 F0 AB 67 F4 FC
0050 | A1 CC 99 EC 03 1F 0A F8 4D 97 4D 8A 75 47 5F 64
0060 | 20 E5 8A 86 C2 16 2A 6B D3 B0 6B 6D 5D 61 F2 09
0070 | 88 58 E0 C3 50 5F CF 29 4C 3E 4C D9 F2 51 BE 65
0080 | 33 81 6F 7C E7 F2 23 41 E3 D0 21 F4 BD 4E F4 55
0090 | 1A BF A4 46 A3 6D 39 06 BC 90 F2 9D 74 DA 0B BD
00A0 | A5 5C 85 A6 DA 2C 7C 4A 75 B9 A8 83 BD 65 C2 89
00B0 | 81 E4 96 39 04 73 D2 D3 3A EA B8 6E 3C 59 3B E4
00C0 | 1B D8 BA 31 1A 52 18 76 B9 76 F5 81 15 B4 1B 27
00D0 | DE 29 EE 80 42 20 80 F4 BC 7C D6 73 A9 65 FE 9C
00E0 | 2B CB 29 B5 F9 79 65 03 87 F3 55 50 FD 7E 11 9F
00F0 | BF 58 55 76 F1 5A A5 35 4C 0A A6 9A 8D 07 03 82
0100 | A9 3B 08 82 F9 79 E9 26 5C 5E 6D 63 15 9C 55 78
0110 | 05 78 56 D5 D7 18 04 E3 61 A3 5D A8 B3 DD 2A 8E
0120 | 2E 86 92 E7 F8 41 4D 21 8D CD 80 5D 9A 0C 20 B7
0130 | BD 77 CF 20 52 E0 DF 16 C1 BA 99 32 B4 3B 27 A0
0140 | 8D 1F D1 EC DD 43 A6 B0 82 97 BA 7C BD 74 E4 34
0150 | 34 B8 5E 67 84 52 46 EF 52 AC 08 74 61 21 56 FA
0160 | 30 DF 5E E6 EA 9F 4A D3 72 6E 04 4B 9E 47 7F FE
0170 | 89 D4 68 2B 6D CE 3A 63 38 1F DB 05 B5 3C 28 ED
0180 | D6 4E A8 D3 76 D3 A4 58 A0 22 04 FE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C8A00900B114AC65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001009508FE98AACA0EA3897250A9</code> <code>C454D0F0AB67F4FCA1CC99EC031F0AF8</code> <code>4D974D8A75475F6420E58A86C2162A6B</code> <code>D3B06B6D5D61F2098858E0C3505FCF29</code> <code>4C3E4CD9F251BE6533816F7CE7F22341</code> <code>E3D021F4BD4EF4551ABFA446A36D3906</code> <code>BC90F29D74DA0BBDA55C85A6DA2C7C4A</code> <code>75B9A883BD65C28981E496390473D2D3</code> <code>3AEAB86E3C593BE41BD8BA311A521876</code> <code>B976F58115B41B27DE29EE80422080F4</code> <code>BC7CD673A965FE9C2BCB29B5F9796503</code> <code>87F35550FD7E119FBF585576F15AA535</code> <code>4C0AA69A8D070382A93B0882F979E926</code> <code>5C5E6D63159C5578057856D5D71804E3</code> <code>61A35DA8B3DD2A8E2E8692E7F8414D21</code> <code>8DCD805D9A0C20B7BD77CF2052E0DF16</code> <code>C1BA9932B43B27A08D1FD1ECDD43A6B0</code> <code>8297BA7CBD74E43434B85E67845246EF</code> <code>52AC0874612156FA30DF5EE6EA9F4AD3</code> <code>726E044B9E477FFE89D4682B6DCE3A63</code> <code>381FDB05B53C28EDD64EA8D376D3A458</code><br> <code>A02204FE</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 27A95B5899719BB35E4AE0DB6B6BC6947FF46DD631E499BBDA6F961C56554D09EE1B78ED28FDBE916000CCB524074461D141DBACE5B09667FA7C2660C85C3B09798E7DFE33A081124771EE963880033760B4049EF2A49E0685D5A9476F03ED8212D898A8353477FCD8A5A8823850D70D0B114612843CA75DB8CC4686CC34E59D25B484B9C3F1381AACD5B3E26F122B8FF5D5D808AE98049F6D35F8CCEDE7D357F7D1976B25249B2DFF6D16F151A3CC274FFFFD23BA5146A2805CA9B78A731DC49DA1A345ABA1798FEFFB7DC6E5B6334B4E059DB14F2414E159460476B1E78D7C04F1681618B322DB56B7A0D2CDEFDA679B76C27C5AD033119C76BB119293B7B7</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 70 C6 06 B3 14 AC 65
0010 | 60 00 00 00 34 F7 CB 3B E9 78 DB B0 74 3F E9 90
0020 | 23 90 8D 35 49 A9 D0 3E 43 7A 52 81 56 6B 8D D1
0030 | B4 C2 39 1A 28 03 40 0C BA DF F3 86 0B A8 AF BA
0040 | 2C 98 F3 A9 03 0D D1 6D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0170C606B314AC65</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>60000000</code> (96 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E978DBB0743FE99023908D3549A9D03E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>437A5281566B8DD1B4C2391A2803400C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>BADFF3860BA8AFBA2C98F3A9030DD16D</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

