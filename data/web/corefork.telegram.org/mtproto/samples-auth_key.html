<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E8 90 02 00 F0 E5 D0 64
0010 | 14 00 00 00 F1 8E 7E BE FA 56 B8 81 4A 7D 8A 03
0020 | EF 19 33 5E 6B 08 91 F0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E8900200F0E5D064</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 28 CA A4 F0 E5 D0 64
0010 | 6C 00 00 00 63 24 16 05 FA 56 B8 81 4A 7D 8A 03
0020 | EF 19 33 5E 6B 08 91 F0 DB 9F E2 2A 93 C1 07 45
0030 | 08 DE 79 17 1E 18 50 CE 08 1C 84 51 C9 6B 32 C2
0040 | FD 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0128CAA4F0E5D064</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>6C000000</code> (108 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081C8451C96B32C2FD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2054857255516553981</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p--q" id="3-client-decomposes-pq-into-prime-factors-such-that-p--q" name="3-client-decomposes-pq-into-prime-factors-such-that-p--q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2054857255516553981</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2054857255516553981 = 1103058367 * 1862872643</code></p>
<pre><code>p = 1103058367
q = 1862872643</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1C 84 51 C9 6B 32 C2 FD 00 00 00
0010 | 04 41 BF 55 BF 00 00 00 04 6F 09 2E 43 00 00 00
0020 | FA 56 B8 81 4A 7D 8A 03 EF 19 33 5E 6B 08 91 F0
0030 | DB 9F E2 2A 93 C1 07 45 08 DE 79 17 1E 18 50 CE
0040 | 27 1F FA 94 F7 6D D9 A1 B8 44 D2 3B 1F 14 66 C8
0050 | E6 8F 61 D4 48 8A CA E8 20 1A E5 70 84 27 5C B8
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081C8451C96B32C2FD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2054857255516553981</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0441BF55BF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1103058367</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046F092E43000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1862872643</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>271FFA94F76DD9A1B844D23B1F1466C8</code> <code>E68F61D4488ACAE8201AE57084275CB8</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081C8451C96B32C2FD0000000441BF55BF000000046F092E43000000FA56B8814A7D8A03EF19335E6B0891F0DB9FE22A93C1074508DE79171E1850CE271FFA94F76DD9A1B844D23B1F1466C8E68F61D4488ACAE8201AE57084275CB802000000
random_padding_bytes = 982FF8E0583964DDDE33C21862E923F799A0768BB0D0BF2B7DCE86A965E5085B46CF8C0023A8AAE9EF6D6F033C08790577FB305E7492ABD99266C1A04481EE08FED2565698114E49565BE749BF90143A35E48A139E0B01DA47552605</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = CBCC221B7089C4A33B6B85318CDB8430FBEA9A6753941B7A8173773A58E42B9BA76B2ABFBD0AB244D9F797EA524CF404F2E7B87BB54D51253EAD3B6F8BF9DC1823A963B78A3F4F0146132FFC33FE54708E98766F0356C1E7722BD69877981F7FA8F62ADC8A2FB16CD6C19474F6DE14F7245397A0CB378ECFCD785789B9E3BC1B4B369F5A95BBE3E8FC1F4D184AF9C7CFCC019CD6A8A9EC9D3DB50C6E0E2358F2D947EE062FA5ED120CA94E8B95961CD2F4BF1FB2E53B660A6E6B02C2C88188B39C577EB07231723EE35118DCEB5F72C200A6A1F27F46C8665EE6412D2869DD8FF8DDB55A0010FD45D96C27A3F505C1300B4FE51619B48D183E7F969D8691D021</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C4 55 0E 00 F0 E5 D0 64
0010 | 40 01 00 00 BE E4 12 D7 FA 56 B8 81 4A 7D 8A 03
0020 | EF 19 33 5E 6B 08 91 F0 DB 9F E2 2A 93 C1 07 45
0030 | 08 DE 79 17 1E 18 50 CE 04 41 BF 55 BF 00 00 00
0040 | 04 6F 09 2E 43 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 CB CC 22 1B 70 89 C4 A3 3B 6B 85 31
0060 | 8C DB 84 30 FB EA 9A 67 53 94 1B 7A 81 73 77 3A
0070 | 58 E4 2B 9B A7 6B 2A BF BD 0A B2 44 D9 F7 97 EA
0080 | 52 4C F4 04 F2 E7 B8 7B B5 4D 51 25 3E AD 3B 6F
0090 | 8B F9 DC 18 23 A9 63 B7 8A 3F 4F 01 46 13 2F FC
00A0 | 33 FE 54 70 8E 98 76 6F 03 56 C1 E7 72 2B D6 98
00B0 | 77 98 1F 7F A8 F6 2A DC 8A 2F B1 6C D6 C1 94 74
00C0 | F6 DE 14 F7 24 53 97 A0 CB 37 8E CF CD 78 57 89
00D0 | B9 E3 BC 1B 4B 36 9F 5A 95 BB E3 E8 FC 1F 4D 18
00E0 | 4A F9 C7 CF CC 01 9C D6 A8 A9 EC 9D 3D B5 0C 6E
00F0 | 0E 23 58 F2 D9 47 EE 06 2F A5 ED 12 0C A9 4E 8B
0100 | 95 96 1C D2 F4 BF 1F B2 E5 3B 66 0A 6E 6B 02 C2
0110 | C8 81 88 B3 9C 57 7E B0 72 31 72 3E E3 51 18 DC
0120 | EB 5F 72 C2 00 A6 A1 F2 7F 46 C8 66 5E E6 41 2D
0130 | 28 69 DD 8F F8 DD B5 5A 00 10 FD 45 D9 6C 27 A3
0140 | F5 05 C1 30 0B 4F E5 16 19 B4 8D 18 3E 7F 96 9D
0150 | 86 91 D0 21</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C4550E00F0E5D064</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0441BF55BF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1103058367</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046F092E43000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1862872643</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100CBCC221B7089C4A33B6B8531</code> <code>8CDB8430FBEA9A6753941B7A8173773A</code> <code>58E42B9BA76B2ABFBD0AB244D9F797EA</code> <code>524CF404F2E7B87BB54D51253EAD3B6F</code> <code>8BF9DC1823A963B78A3F4F0146132FFC</code> <code>33FE54708E98766F0356C1E7722BD698</code> <code>77981F7FA8F62ADC8A2FB16CD6C19474</code> <code>F6DE14F7245397A0CB378ECFCD785789</code> <code>B9E3BC1B4B369F5A95BBE3E8FC1F4D18</code> <code>4AF9C7CFCC019CD6A8A9EC9D3DB50C6E</code> <code>0E2358F2D947EE062FA5ED120CA94E8B</code> <code>95961CD2F4BF1FB2E53B660A6E6B02C2</code> <code>C88188B39C577EB07231723EE35118DC</code> <code>EB5F72C200A6A1F27F46C8665EE6412D</code> <code>2869DD8FF8DDB55A0010FD45D96C27A3</code> <code>F505C1300B4FE51619B48D183E7F969D</code><br> <code>8691D021</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D0 B5 45 F1 E5 D0 64
0010 | 7C 02 00 00 5C 07 E8 D0 FA 56 B8 81 4A 7D 8A 03
0020 | EF 19 33 5E 6B 08 91 F0 DB 9F E2 2A 93 C1 07 45
0030 | 08 DE 79 17 1E 18 50 CE FE 50 02 00 54 05 70 19
0040 | A0 F5 84 77 B6 7F 75 BF D4 8C FC E2 4D 13 F5 A4
0050 | D6 3D 29 2C 92 56 59 93 B8 29 B6 C6 81 93 A3 19
0060 | 7E 06 91 43 02 09 FF 4D 9D 7F E6 E2 FF FB 3E FF
0070 | 5C C9 14 A2 21 97 DF ED D6 39 55 8E 4B A4 98 66
0080 | 7A B1 FB 93 D1 1E D7 E5 D8 00 5E 74 5F 70 74 30
0090 | 6E 44 B9 80 56 18 7D AE EE 10 31 C4 F9 4D 6F 83
00A0 | 1C 98 98 A6 02 1D 37 84 A9 34 CD 3F 35 B1 EA 75
00B0 | 3D E0 14 C6 74 5C 37 75 B7 92 AD 09 83 79 09 CA
00C0 | 38 56 AB 99 CB D2 FA 92 EE B1 F8 86 05 04 CD 97
00D0 | BA 1D 2B 87 CD CA 4A C1 28 BB AF AB A1 85 33 10
00E0 | 7F A9 00 D2 56 13 1C F2 06 D3 A4 B1 83 4B 71 45
00F0 | D3 6E 70 E3 02 4F A2 7E 86 A6 55 AC AD 41 5B F8
0100 | 24 C9 7A A1 59 C4 14 2D 40 D0 F9 9C 89 3C AC DB
0110 | 15 1B B3 32 96 ED BA D8 F1 13 F0 46 53 BA 60 42
0120 | DB F4 98 E5 5F 82 D0 CB B8 1E 24 FB 46 24 6B F3
0130 | 98 8F 30 4F 69 D5 A8 10 98 15 0D FA EE D7 1F A7
0140 | E9 37 56 EE 19 50 6A EB 4D 0A B4 F2 E9 29 DB 8F
0150 | CB 5F 0D D9 70 DC E3 AD 98 73 5C 5D 9E 9A 49 E9
0160 | 01 14 30 11 5C E7 3F 3C 9A 33 C0 52 92 9D 33 EE
0170 | E2 09 24 C9 D1 AC AF 0C 13 00 50 10 C9 F3 86 FD
0180 | 02 D1 64 9F BC 6A A7 5F 6A 53 24 31 10 94 1E 60
0190 | 99 D7 77 D9 F4 49 DC E8 EA 01 1E A2 39 1C 1E CF
01A0 | F6 AF FA BA 51 2D 45 0B F6 79 6E F1 43 CB 85 78
01B0 | 31 82 37 CC 24 87 86 DD 26 FE 1A 26 3D B8 A7 38
01C0 | B1 8B BD 19 0A C3 F9 DD 37 9C 34 70 7D 74 3A CF
01D0 | D3 00 19 EF 80 DD 38 20 34 40 5A BB 22 69 42 4A
01E0 | 62 E2 60 98 CC 40 02 88 7D D8 04 E2 71 4D A8 3F
01F0 | 7C C7 48 37 5C A2 CF 53 A0 5B E5 FD 85 1C 38 9E
0200 | DF 36 17 37 DD 61 EC 1A E7 17 6B F8 3F 2E FD 1A
0210 | 10 92 A6 B5 4C 44 6A CA 66 FA 37 27 28 7E 12 B4
0220 | 00 70 7F 2B DD 2B 36 26 C3 FC F6 27 35 4B C1 C9
0230 | DA 93 8F 39 06 17 CA E1 35 46 9B 16 8B C6 36 3C
0240 | EF 42 28 C5 8C 2C 7E 37 F6 F6 C4 B6 7B 5D 95 57
0250 | AE EE 93 4C 1C 1E A0 EB F9 0A 23 17 90 DF 1A F0
0260 | 5C D2 2F 83 57 C5 F6 FD 43 17 48 7C 19 74 3D BD
0270 | AD 7B B1 AB 03 37 30 EB A8 61 2F 59 6F 2A 34 01
0280 | 8B CA DF 83 77 7A B9 79 4B 65 AC 5A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D0B545F1E5D064</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>7C020000</code> (636 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020054057019A0F58477B67F75BF</code> <code>D48CFCE24D13F5A4D63D292C92565993</code> <code>B829B6C68193A3197E0691430209FF4D</code> <code>9D7FE6E2FFFB3EFF5CC914A22197DFED</code> <code>D639558E4BA498667AB1FB93D11ED7E5</code> <code>D8005E745F7074306E44B98056187DAE</code> <code>EE1031C4F94D6F831C9898A6021D3784</code> <code>A934CD3F35B1EA753DE014C6745C3775</code> <code>B792AD09837909CA3856AB99CBD2FA92</code> <code>EEB1F8860504CD97BA1D2B87CDCA4AC1</code> <code>28BBAFABA18533107FA900D256131CF2</code> <code>06D3A4B1834B7145D36E70E3024FA27E</code> <code>86A655ACAD415BF824C97AA159C4142D</code> <code>40D0F99C893CACDB151BB33296EDBAD8</code> <code>F113F04653BA6042DBF498E55F82D0CB</code> <code>B81E24FB46246BF3988F304F69D5A810</code> <code>98150DFAEED71FA7E93756EE19506AEB</code> <code>4D0AB4F2E929DB8FCB5F0DD970DCE3AD</code> <code>98735C5D9E9A49E9011430115CE73F3C</code> <code>9A33C052929D33EEE20924C9D1ACAF0C</code> <code>13005010C9F386FD02D1649FBC6AA75F</code> <code>6A53243110941E6099D777D9F449DCE8</code> <code>EA011EA2391C1ECFF6AFFABA512D450B</code> <code>F6796EF143CB8578318237CC248786DD</code> <code>26FE1A263DB8A738B18BBD190AC3F9DD</code> <code>379C34707D743ACFD30019EF80DD3820</code> <code>34405ABB2269424A62E26098CC400288</code> <code>7DD804E2714DA83F7CC748375CA2CF53</code> <code>A05BE5FD851C389EDF361737DD61EC1A</code> <code>E7176BF83F2EFD1A1092A6B54C446ACA</code> <code>66FA3727287E12B400707F2BDD2B3626</code> <code>C3FCF627354BC1C9DA938F390617CAE1</code> <code>35469B168BC6363CEF4228C58C2C7E37</code> <code>F6F6C4B67B5D9557AEEE934C1C1EA0EB</code> <code>F90A231790DF1AF05CD22F8357C5F6FD</code> <code>4317487C19743DBDAD7BB1AB033730EB</code> <code>A8612F596F2A34018BCADF83777AB979</code><br> <code>4B65AC5A</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 54057019A0F58477B67F75BFD48CFCE24D13F5A4D63D292C92565993B829B6C68193A3197E0691430209FF4D9D7FE6E2FFFB3EFF5CC914A22197DFEDD639558E4BA498667AB1FB93D11ED7E5D8005E745F7074306E44B98056187DAEEE1031C4F94D6F831C9898A6021D3784A934CD3F35B1EA753DE014C6745C3775B792AD09837909CA3856AB99CBD2FA92EEB1F8860504CD97BA1D2B87CDCA4AC128BBAFABA18533107FA900D256131CF206D3A4B1834B7145D36E70E3024FA27E86A655ACAD415BF824C97AA159C4142D40D0F99C893CACDB151BB33296EDBAD8F113F04653BA6042DBF498E55F82D0CBB81E24FB46246BF3988F304F69D5A81098150DFAEED71FA7E93756EE19506AEB4D0AB4F2E929DB8FCB5F0DD970DCE3AD98735C5D9E9A49E9011430115CE73F3C9A33C052929D33EEE20924C9D1ACAF0C13005010C9F386FD02D1649FBC6AA75F6A53243110941E6099D777D9F449DCE8EA011EA2391C1ECFF6AFFABA512D450BF6796EF143CB8578318237CC248786DD26FE1A263DB8A738B18BBD190AC3F9DD379C34707D743ACFD30019EF80DD382034405ABB2269424A62E26098CC4002887DD804E2714DA83F7CC748375CA2CF53A05BE5FD851C389EDF361737DD61EC1AE7176BF83F2EFD1A1092A6B54C446ACA66FA3727287E12B400707F2BDD2B3626C3FCF627354BC1C9DA938F390617CAE135469B168BC6363CEF4228C58C2C7E37F6F6C4B67B5D9557AEEE934C1C1EA0EBF90A231790DF1AF05CD22F8357C5F6FD4317487C19743DBDAD7BB1AB033730EBA8612F596F2A34018BCADF83777AB9794B65AC5A
tmp_aes_key = 2254F20E901881266F49CA54E3BD0A187375A0440D8E90D69FA30C4FB4414477
tmp_aes_iv = D0D2643702C4C19E178AE141ACC6C2DF87CD0C761E8B13EC361296D1271FFA94</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = B9E1266C58E205B9B57041114999ADC56DBD01C3BA0D89B5FA56B8814A7D8A03EF19335E6B0891F0DB9FE22A93C1074508DE79171E1850CE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010067E90A8C787B0B939B8C4E40B5B694938842786B75DB893DFF4D309A10C3FE9323C063C053A4DC2F50381FBC841CD9221C4403DADCC7C76B642435810CB145526784A1C4D7A6825755948CF8F2E581C12A7B24667E7B98CD4335C82530CFB42A0D090C441CF9AECCADA3068DD869DDB8585E4512828FB27175975884529157EFC1EBAF7B5BAC7870551CD8EB717695C4D2CAFB71C4B152D2D1A76264F1A8EF9139CF74FE945F150356BF24C057C10B9DD482CD9460BA8E8533F3AD389F0185DF7C8930F664A5C6EB0EFB552FC7D1315C9DDD3F7A1013E9A4B3C41C572AE0577C2F5E4D17196C6C7423028BF5A43A589A53A53B3E99699F3A13F5121D9F961445F1E5D06421F9AE252BE3F26B
answer = BA0D89B5FA56B8814A7D8A03EF19335E6B0891F0DB9FE22A93C1074508DE79171E1850CE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010067E90A8C787B0B939B8C4E40B5B694938842786B75DB893DFF4D309A10C3FE9323C063C053A4DC2F50381FBC841CD9221C4403DADCC7C76B642435810CB145526784A1C4D7A6825755948CF8F2E581C12A7B24667E7B98CD4335C82530CFB42A0D090C441CF9AECCADA3068DD869DDB8585E4512828FB27175975884529157EFC1EBAF7B5BAC7870551CD8EB717695C4D2CAFB71C4B152D2D1A76264F1A8EF9139CF74FE945F150356BF24C057C10B9DD482CD9460BA8E8533F3AD389F0185DF7C8930F664A5C6EB0EFB552FC7D1315C9DDD3F7A1013E9A4B3C41C572AE0577C2F5E4D17196C6C7423028BF5A43A589A53A53B3E99699F3A13F5121D9F961445F1E5D06421F9AE252BE3F26B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 FA 56 B8 81 4A 7D 8A 03 EF 19 33 5E
0010 | 6B 08 91 F0 DB 9F E2 2A 93 C1 07 45 08 DE 79 17
0020 | 1E 18 50 CE 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 67 E9 0A 8C 78 7B 0B 93 9B 8C 4E 40 B5 B6 94 93
0140 | 88 42 78 6B 75 DB 89 3D FF 4D 30 9A 10 C3 FE 93
0150 | 23 C0 63 C0 53 A4 DC 2F 50 38 1F BC 84 1C D9 22
0160 | 1C 44 03 DA DC C7 C7 6B 64 24 35 81 0C B1 45 52
0170 | 67 84 A1 C4 D7 A6 82 57 55 94 8C F8 F2 E5 81 C1
0180 | 2A 7B 24 66 7E 7B 98 CD 43 35 C8 25 30 CF B4 2A
0190 | 0D 09 0C 44 1C F9 AE CC AD A3 06 8D D8 69 DD B8
01A0 | 58 5E 45 12 82 8F B2 71 75 97 58 84 52 91 57 EF
01B0 | C1 EB AF 7B 5B AC 78 70 55 1C D8 EB 71 76 95 C4
01C0 | D2 CA FB 71 C4 B1 52 D2 D1 A7 62 64 F1 A8 EF 91
01D0 | 39 CF 74 FE 94 5F 15 03 56 BF 24 C0 57 C1 0B 9D
01E0 | D4 82 CD 94 60 BA 8E 85 33 F3 AD 38 9F 01 85 DF
01F0 | 7C 89 30 F6 64 A5 C6 EB 0E FB 55 2F C7 D1 31 5C
0200 | 9D DD 3F 7A 10 13 E9 A4 B3 C4 1C 57 2A E0 57 7C
0210 | 2F 5E 4D 17 19 6C 6C 74 23 02 8B F5 A4 3A 58 9A
0220 | 53 A5 3B 3E 99 69 9F 3A 13 F5 12 1D 9F 96 14 45
0230 | F1 E5 D0 64</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010067E90A8C787B0B939B8C4E40</code> <code>B5B694938842786B75DB893DFF4D309A</code> <code>10C3FE9323C063C053A4DC2F50381FBC</code> <code>841CD9221C4403DADCC7C76B64243581</code> <code>0CB145526784A1C4D7A6825755948CF8</code> <code>F2E581C12A7B24667E7B98CD4335C825</code> <code>30CFB42A0D090C441CF9AECCADA3068D</code> <code>D869DDB8585E4512828FB27175975884</code> <code>529157EFC1EBAF7B5BAC7870551CD8EB</code> <code>717695C4D2CAFB71C4B152D2D1A76264</code> <code>F1A8EF9139CF74FE945F150356BF24C0</code> <code>57C10B9DD482CD9460BA8E8533F3AD38</code> <code>9F0185DF7C8930F664A5C6EB0EFB552F</code> <code>C7D1315C9DDD3F7A1013E9A4B3C41C57</code> <code>2AE0577C2F5E4D17196C6C7423028BF5</code> <code>A43A589A53A53B3E99699F3A13F5121D</code><br> <code>9F961445</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>F1E5D064</code> (1691411953 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = DF27D4D1915AC970A121A59A49BBD6233DD10CABD7B7DCCBA343C2CADD7C8491968162A5AF50506C28C9E7FBFB6E7E2C7D54BC4F61767756C4F3949CA0D853F45F6A920B61239B173F2127B1174069C51B8E1289AA2FFB581747EE4C2565A326BEF154AEB6184CFAF42FFD1829B50950A703266462002AA1127CFCBC1E2B9932E80350746C981C6CE0D21844140A66EF9ED21E1D23B1E16E2F6DD94F61E400C13E75FD07AA40242490939E9A267069042864BF69655DC237DC512A8EE88C2CD043F7A6E8C3CE99C1AB6BD5A18BB23706228C88F8D65225309EEABEC0B36215993E21193B3DAB9701A848D63D30FBBF7611FB3B276BFC589EFFD765A823EA7A54</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4353012BD4A1D36D836C48F49CAD0410F08C4F3212E9506B7BB9F4EE4022445E4E9EFFE99D7F373A1BE5398A816A46D4D456F9A70F634A76A13164DFF1C9CE9BC0DE47B00E69C59D99648C3B0993D2A06FF13DF6BF64FA0CAFD542AA5BD99D0886018E1D4D4C84E63FCCA409A7B32F27FBC2C94EE7BC7ED911BD6DB6A2EF4067F3083FA6385112FB9081A185970B7BA04596621BAF0742E1FECCEE8EEFE273DD01D72E370612A9C8891355D9A76FB4CCD1DA983792BA75ED8ABF23EF2D4828B66ABE938F73E0C29868BEFA3322ABB4CD6534623C97608964E845D275C394C8D067A92B892EC0647F5FEC960D54D1B380144D2253B5B268C8311FA96AF2B26B0A</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 FA 56 B8 81 4A 7D 8A 03 EF 19 33 5E
0010 | 6B 08 91 F0 DB 9F E2 2A 93 C1 07 45 08 DE 79 17
0020 | 1E 18 50 CE 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 43 53 01 2B D4 A1 D3 6D 83 6C 48 F4 9C AD 04 10
0040 | F0 8C 4F 32 12 E9 50 6B 7B B9 F4 EE 40 22 44 5E
0050 | 4E 9E FF E9 9D 7F 37 3A 1B E5 39 8A 81 6A 46 D4
0060 | D4 56 F9 A7 0F 63 4A 76 A1 31 64 DF F1 C9 CE 9B
0070 | C0 DE 47 B0 0E 69 C5 9D 99 64 8C 3B 09 93 D2 A0
0080 | 6F F1 3D F6 BF 64 FA 0C AF D5 42 AA 5B D9 9D 08
0090 | 86 01 8E 1D 4D 4C 84 E6 3F CC A4 09 A7 B3 2F 27
00A0 | FB C2 C9 4E E7 BC 7E D9 11 BD 6D B6 A2 EF 40 67
00B0 | F3 08 3F A6 38 51 12 FB 90 81 A1 85 97 0B 7B A0
00C0 | 45 96 62 1B AF 07 42 E1 FE CC EE 8E EF E2 73 DD
00D0 | 01 D7 2E 37 06 12 A9 C8 89 13 55 D9 A7 6F B4 CC
00E0 | D1 DA 98 37 92 BA 75 ED 8A BF 23 EF 2D 48 28 B6
00F0 | 6A BE 93 8F 73 E0 C2 98 68 BE FA 33 22 AB B4 CD
0100 | 65 34 62 3C 97 60 89 64 E8 45 D2 75 C3 94 C8 D0
0110 | 67 A9 2B 89 2E C0 64 7F 5F EC 96 0D 54 D1 B3 80
0120 | 14 4D 22 53 B5 B2 68 C8 31 1F A9 6A F2 B2 6B 0A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004353012BD4A1D36D836C48F4</code> <code>9CAD0410F08C4F3212E9506B7BB9F4EE</code> <code>4022445E4E9EFFE99D7F373A1BE5398A</code> <code>816A46D4D456F9A70F634A76A13164DF</code> <code>F1C9CE9BC0DE47B00E69C59D99648C3B</code> <code>0993D2A06FF13DF6BF64FA0CAFD542AA</code> <code>5BD99D0886018E1D4D4C84E63FCCA409</code> <code>A7B32F27FBC2C94EE7BC7ED911BD6DB6</code> <code>A2EF4067F3083FA6385112FB9081A185</code> <code>970B7BA04596621BAF0742E1FECCEE8E</code> <code>EFE273DD01D72E370612A9C8891355D9</code> <code>A76FB4CCD1DA983792BA75ED8ABF23EF</code> <code>2D4828B66ABE938F73E0C29868BEFA33</code> <code>22ABB4CD6534623C97608964E845D275</code> <code>C394C8D067A92B892EC0647F5FEC960D</code> <code>54D1B380144D2253B5B268C8311FA96A</code><br> <code>F2B26B0A</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366FA56B8814A7D8A03EF19335E6B0891F0DB9FE22A93C1074508DE79171E1850CE0000000000000000FE0001004353012BD4A1D36D836C48F49CAD0410F08C4F3212E9506B7BB9F4EE4022445E4E9EFFE99D7F373A1BE5398A816A46D4D456F9A70F634A76A13164DFF1C9CE9BC0DE47B00E69C59D99648C3B0993D2A06FF13DF6BF64FA0CAFD542AA5BD99D0886018E1D4D4C84E63FCCA409A7B32F27FBC2C94EE7BC7ED911BD6DB6A2EF4067F3083FA6385112FB9081A185970B7BA04596621BAF0742E1FECCEE8EEFE273DD01D72E370612A9C8891355D9A76FB4CCD1DA983792BA75ED8ABF23EF2D4828B66ABE938F73E0C29868BEFA3322ABB4CD6534623C97608964E845D275C394C8D067A92B892EC0647F5FEC960D54D1B380144D2253B5B268C8311FA96AF2B26B0A
padding = B600FC2C750DB82A853DB393
tmp_aes_key = 2254F20E901881266F49CA54E3BD0A187375A0440D8E90D69FA30C4FB4414477
tmp_aes_iv = D0D2643702C4C19E178AE141ACC6C2DF87CD0C761E8B13EC361296D1271FFA94</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = CF16EAF8B7A0F9BB0A3AA114DE0C97B2629FEE1EF6160C98A198CCABED2AEC31954E252D389FE6A87C92E0B9D230C8288A13BD5DA24A4DEA736D6CC220773858E8923D5FA0AD0B9EF5DF01521F9728C2BD44D95A1D790AD1880FA00298DF1D01A492FA6D51FF327B94EAFA603367A3B5EC47CAD771987F4D2D1EC0FB0B39803F7C9666786584A5E6471AFE92C1D3EAAE256385D9372B2BDFCDC050B6699ADE25302E9B76B93D9E4B05CFB1DB24BB0C72B841240C84E1634CCC08BDF8969AB6B882B9C457C6EB95BE6BAC9F606B8D2DB83C1B824F854D11BE1FCCDEF8D212A4DDEF6F58C070607BFB5C283BC6501BF23B9D5B952B12A8EB28C7EA951810C4C0613CCC59CCDB4133564F3AFA7214F3EFC08528BBF0A2A9EB939128A98F7AADB8E195FD238AF6E918DA7408A4EF635B662D75C0130EE5742AE436EA6219084BB7139D7F36B7D9DEF7000615A7A48BDE8770</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A4 14 0B 00 F2 E5 D0 64
0010 | 78 01 00 00 1F 5F 04 F5 FA 56 B8 81 4A 7D 8A 03
0020 | EF 19 33 5E 6B 08 91 F0 DB 9F E2 2A 93 C1 07 45
0030 | 08 DE 79 17 1E 18 50 CE FE 50 01 00 CF 16 EA F8
0040 | B7 A0 F9 BB 0A 3A A1 14 DE 0C 97 B2 62 9F EE 1E
0050 | F6 16 0C 98 A1 98 CC AB ED 2A EC 31 95 4E 25 2D
0060 | 38 9F E6 A8 7C 92 E0 B9 D2 30 C8 28 8A 13 BD 5D
0070 | A2 4A 4D EA 73 6D 6C C2 20 77 38 58 E8 92 3D 5F
0080 | A0 AD 0B 9E F5 DF 01 52 1F 97 28 C2 BD 44 D9 5A
0090 | 1D 79 0A D1 88 0F A0 02 98 DF 1D 01 A4 92 FA 6D
00A0 | 51 FF 32 7B 94 EA FA 60 33 67 A3 B5 EC 47 CA D7
00B0 | 71 98 7F 4D 2D 1E C0 FB 0B 39 80 3F 7C 96 66 78
00C0 | 65 84 A5 E6 47 1A FE 92 C1 D3 EA AE 25 63 85 D9
00D0 | 37 2B 2B DF CD C0 50 B6 69 9A DE 25 30 2E 9B 76
00E0 | B9 3D 9E 4B 05 CF B1 DB 24 BB 0C 72 B8 41 24 0C
00F0 | 84 E1 63 4C CC 08 BD F8 96 9A B6 B8 82 B9 C4 57
0100 | C6 EB 95 BE 6B AC 9F 60 6B 8D 2D B8 3C 1B 82 4F
0110 | 85 4D 11 BE 1F CC DE F8 D2 12 A4 DD EF 6F 58 C0
0120 | 70 60 7B FB 5C 28 3B C6 50 1B F2 3B 9D 5B 95 2B
0130 | 12 A8 EB 28 C7 EA 95 18 10 C4 C0 61 3C CC 59 CC
0140 | DB 41 33 56 4F 3A FA 72 14 F3 EF C0 85 28 BB F0
0150 | A2 A9 EB 93 91 28 A9 8F 7A AD B8 E1 95 FD 23 8A
0160 | F6 E9 18 DA 74 08 A4 EF 63 5B 66 2D 75 C0 13 0E
0170 | E5 74 2A E4 36 EA 62 19 08 4B B7 13 9D 7F 36 B7
0180 | D9 DE F7 00 06 15 A7 A4 8B DE 87 70</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A4140B00F2E5D064</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100CF16EAF8B7A0F9BB0A3AA114</code> <code>DE0C97B2629FEE1EF6160C98A198CCAB</code> <code>ED2AEC31954E252D389FE6A87C92E0B9</code> <code>D230C8288A13BD5DA24A4DEA736D6CC2</code> <code>20773858E8923D5FA0AD0B9EF5DF0152</code> <code>1F9728C2BD44D95A1D790AD1880FA002</code> <code>98DF1D01A492FA6D51FF327B94EAFA60</code> <code>3367A3B5EC47CAD771987F4D2D1EC0FB</code> <code>0B39803F7C9666786584A5E6471AFE92</code> <code>C1D3EAAE256385D9372B2BDFCDC050B6</code> <code>699ADE25302E9B76B93D9E4B05CFB1DB</code> <code>24BB0C72B841240C84E1634CCC08BDF8</code> <code>969AB6B882B9C457C6EB95BE6BAC9F60</code> <code>6B8D2DB83C1B824F854D11BE1FCCDEF8</code> <code>D212A4DDEF6F58C070607BFB5C283BC6</code> <code>501BF23B9D5B952B12A8EB28C7EA9518</code> <code>10C4C0613CCC59CCDB4133564F3AFA72</code> <code>14F3EFC08528BBF0A2A9EB939128A98F</code> <code>7AADB8E195FD238AF6E918DA7408A4EF</code> <code>635B662D75C0130EE5742AE436EA6219</code> <code>084BB7139D7F36B7D9DEF7000615A7A4</code><br> <code>8BDE8770</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2E5F591B50199135DAEA65BA82D78F6FC1854659353E081C6341BA5D2DBA42BD05BC591089118A1D6068D02706570020B1BBC205A02D272A601C93E44C93C6183501584C07095120B9DEEF74B92F9E6237ADB0DECC32A5BC271270DCDCFE697A432351F7A02271DD125D92F8BAB19C999112DB4DF5D99BA36A179E0CC642EF6A28CB777F45B1F2DE8558D050B5197DB55F8B9CC72A4E56131ED0AADC35B603685932E70342378BD384E99F2E9568F0ABB6BFE9E312157EEF73674F47BDD4D78E0E8F02173C6F0364ACD2F9471E80A450C635F43942F3690F0D47AF0BC8C2B94237734760F5843FD8FFF86A43F0BB547F5173867AEB7FA1F70BA45A11B929791E</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 C2 AC F2 E5 D0 64
0010 | B0 00 00 00 34 F7 CB 3B FA 56 B8 81 4A 7D 8A 03
0020 | EF 19 33 5E 6B 08 91 F0 DB 9F E2 2A 93 C1 07 45
0030 | 08 DE 79 17 1E 18 50 CE 5A DB 0C 24 7A D2 98 7E
0040 | 73 47 83 C3 0A 1B 96 56</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0138C2ACF2E5D064</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0000000</code> (176 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FA56B8814A7D8A03EF19335E6B0891F0</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DB9FE22A93C1074508DE79171E1850CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>5ADB0C247AD2987E734783C30A1B9656</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)">Twitter</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

