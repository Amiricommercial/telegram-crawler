<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?236" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 98 B8 09 00 E4 57 63 65
0010 | 14 00 00 00 F1 8E 7E BE C0 50 C4 54 83 E6 C2 E3
0020 | 30 D6 52 14 99 45 3D 5B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>98B80900E4576365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A0 36 E7 E4 57 63 65
0010 | 58 00 00 00 63 24 16 05 C0 50 C4 54 83 E6 C2 E3
0020 | 30 D6 52 14 99 45 3D 5B 53 3B AC FB 11 67 B9 55
0030 | 80 95 BD 91 A7 7F 8D 0E 08 2D 8E A2 50 67 4C 7B
0040 | 4D 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A036E7E4576365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082D8EA250674C7B4D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3282739644613819213</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3282739644613819213</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3282739644613819213 = 1714145599 * 1915087987</code></p>
<pre><code>p = 1714145599
q = 1915087987</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2D 8E A2 50 67 4C 7B 4D 00 00 00
0010 | 04 66 2B C9 3F 00 00 00 04 72 25 EC 73 00 00 00
0020 | C0 50 C4 54 83 E6 C2 E3 30 D6 52 14 99 45 3D 5B
0030 | 53 3B AC FB 11 67 B9 55 80 95 BD 91 A7 7F 8D 0E
0040 | C6 A0 60 71 DD 25 D9 01 92 CD C6 02 F6 5A EE BB
0050 | BF BA FF 36 14 11 48 C8 FD 54 BE DA D3 5A D6 97
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082D8EA250674C7B4D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3282739644613819213</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04662BC93F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1714145599</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047225EC73000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1915087987</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>C6A06071DD25D90192CDC602F65AEEBB</code> <code>BFBAFF36141148C8FD54BEDAD35AD697</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082D8EA250674C7B4D00000004662BC93F000000047225EC73000000C050C45483E6C2E330D6521499453D5B533BACFB1167B9558095BD91A77F8D0EC6A06071DD25D90192CDC602F65AEEBBBFBAFF36141148C8FD54BEDAD35AD69702000000
random_padding_bytes = BB7BE6BB46F63D92991135E46285BD79AC708608F822D5B593FA8A4CA7FB01CBED39F3B4B6023C1AF3739DA07DA27579BD7BA1788D591F5D5D1101E97821C3EE4989C1104BE50CCC7FC31E23109735366DFBDF1537DB16C7F5642652</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = AB05DFE223030018B0E6A1D58FBA9E9AE568DB395B5202C6284621AE5381E536DC9932757EF89B571D5E8F0D686FF13A952E229608A4D0185E95E86A6C2155CED021AA97A3E97DB21D89C361006FFC1923D168381CC045A82EF1CB2C1E3D75BEC6A22E37930EE6219A3238D10CAED7325C244C1F5906D1B79F252054E80185A8B769AEB7266808A26D8387505796D4E10959C573240AAB2FA611DE816AA069FEFA4D46809C83789D1EAAAD4C14249D98241315561F35E8C9021A69918441AEFA8F34E8523EE9E22CBE57DE903954405E70387306C2E0C40CC272C9F3B9EA361E554677797796194EDFFD385243BF592729F26D54AC82D326053C8580437DD57A</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 9C 34 08 00 E5 57 63 65
0010 | 40 01 00 00 BE E4 12 D7 C0 50 C4 54 83 E6 C2 E3
0020 | 30 D6 52 14 99 45 3D 5B 53 3B AC FB 11 67 B9 55
0030 | 80 95 BD 91 A7 7F 8D 0E 04 66 2B C9 3F 00 00 00
0040 | 04 72 25 EC 73 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 AB 05 DF E2 23 03 00 18 B0 E6 A1 D5
0060 | 8F BA 9E 9A E5 68 DB 39 5B 52 02 C6 28 46 21 AE
0070 | 53 81 E5 36 DC 99 32 75 7E F8 9B 57 1D 5E 8F 0D
0080 | 68 6F F1 3A 95 2E 22 96 08 A4 D0 18 5E 95 E8 6A
0090 | 6C 21 55 CE D0 21 AA 97 A3 E9 7D B2 1D 89 C3 61
00A0 | 00 6F FC 19 23 D1 68 38 1C C0 45 A8 2E F1 CB 2C
00B0 | 1E 3D 75 BE C6 A2 2E 37 93 0E E6 21 9A 32 38 D1
00C0 | 0C AE D7 32 5C 24 4C 1F 59 06 D1 B7 9F 25 20 54
00D0 | E8 01 85 A8 B7 69 AE B7 26 68 08 A2 6D 83 87 50
00E0 | 57 96 D4 E1 09 59 C5 73 24 0A AB 2F A6 11 DE 81
00F0 | 6A A0 69 FE FA 4D 46 80 9C 83 78 9D 1E AA AD 4C
0100 | 14 24 9D 98 24 13 15 56 1F 35 E8 C9 02 1A 69 91
0110 | 84 41 AE FA 8F 34 E8 52 3E E9 E2 2C BE 57 DE 90
0120 | 39 54 40 5E 70 38 73 06 C2 E0 C4 0C C2 72 C9 F3
0130 | B9 EA 36 1E 55 46 77 79 77 96 19 4E DF FD 38 52
0140 | 43 BF 59 27 29 F2 6D 54 AC 82 D3 26 05 3C 85 80
0150 | 43 7D D5 7A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>9C340800E5576365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04662BC93F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1714145599</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047225EC73000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1915087987</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100AB05DFE223030018B0E6A1D5</code> <code>8FBA9E9AE568DB395B5202C6284621AE</code> <code>5381E536DC9932757EF89B571D5E8F0D</code> <code>686FF13A952E229608A4D0185E95E86A</code> <code>6C2155CED021AA97A3E97DB21D89C361</code> <code>006FFC1923D168381CC045A82EF1CB2C</code> <code>1E3D75BEC6A22E37930EE6219A3238D1</code> <code>0CAED7325C244C1F5906D1B79F252054</code> <code>E80185A8B769AEB7266808A26D838750</code> <code>5796D4E10959C573240AAB2FA611DE81</code> <code>6AA069FEFA4D46809C83789D1EAAAD4C</code> <code>14249D98241315561F35E8C9021A6991</code> <code>8441AEFA8F34E8523EE9E22CBE57DE90</code> <code>3954405E70387306C2E0C40CC272C9F3</code> <code>B9EA361E554677797796194EDFFD3852</code> <code>43BF592729F26D54AC82D326053C8580</code><br> <code>437DD57A</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 EC A2 A7 E5 57 63 65
0010 | A4 02 00 00 5C 07 E8 D0 C0 50 C4 54 83 E6 C2 E3
0020 | 30 D6 52 14 99 45 3D 5B 53 3B AC FB 11 67 B9 55
0030 | 80 95 BD 91 A7 7F 8D 0E FE 50 02 00 A5 43 81 85
0040 | D3 4A 6F 57 F3 6A 57 8D 18 9F 02 6F 7A 32 D3 DC
0050 | 05 A3 41 A3 9C 23 C4 BA D1 8C 4C DB 78 A1 A2 DE
0060 | 8B F1 85 3A BD 10 62 50 C3 7D 13 E2 D3 C3 80 71
0070 | 0A 36 F5 02 60 FE D7 8D FA 5A D4 85 D2 AF D5 1D
0080 | 05 77 CE 22 98 60 A3 66 8D F2 AA 2C 3B 86 38 0A
0090 | 42 40 3B 80 06 60 11 FD 79 D1 81 D4 20 C6 21 B8
00A0 | 6E 8F 96 C7 A3 65 F9 34 0D 01 48 26 5B 6E 32 18
00B0 | 50 05 5C 4D E7 5E 3C 58 1A 9C E3 9A 11 97 46 7C
00C0 | 7F C6 F4 A2 D3 49 85 DA 26 B1 22 A7 5B 1B 66 0B
00D0 | 96 85 81 FA AE FD 8B B8 DB 30 7F B3 12 34 EA F3
00E0 | DD 3F 31 94 33 17 C3 F0 99 8E 67 59 02 3F 25 4A
00F0 | 19 A5 7C 70 41 4D 31 76 68 FF F7 E1 DC B0 EC F0
0100 | 88 78 21 B9 A7 B4 05 CD 13 AE 67 54 22 93 E4 04
0110 | CA A5 B0 AE 34 63 CE 8B B6 F7 26 BA D9 A1 E0 53
0120 | 9F 86 3A 31 81 8D B7 68 49 9C C9 0D 29 21 04 BF
0130 | 7D 54 F0 1D 15 73 9A EB 6B 9F 8C 89 28 C6 4C F5
0140 | 0C BC B7 2A A4 A4 AE 1F 5E BC B9 2A 9F 56 5F 9C
0150 | 45 3D 07 1D 28 9C 91 67 46 1D 8D 3A 2E DA 8C 0C
0160 | 8E CC 0A 1D 9B E9 6F DA 1C 56 01 1E C9 D5 79 8A
0170 | A2 F3 FD 13 C5 AB 52 DC 06 62 0B CD F2 CC 61 0E
0180 | B5 20 B6 DB 94 C8 2E 30 FC 87 AE 65 25 B7 B3 2C
0190 | B7 BB 70 87 B3 59 A5 9A 03 9D 04 4C 64 29 81 24
01A0 | 7C 30 1A 9C 8E D5 1B 73 F2 D1 D4 45 5C 04 53 D2
01B0 | 60 74 1D 3D BB 78 83 74 D1 51 F0 E5 3A 20 DF AA
01C0 | 36 38 F2 6F 36 20 62 73 9A 4E 7A 57 1C 4A 96 23
01D0 | 91 DB D3 65 10 AF E4 4C 0D 9B 50 0B 9B 46 E1 9E
01E0 | 1A EF 88 0E 96 C0 49 3C D7 92 59 91 9C F2 56 24
01F0 | 52 3A 74 17 A1 FB 21 7E 5C 97 89 99 F2 29 DE B2
0200 | 90 3A DD 8E E1 ED 7E F6 AD B2 A2 4A 9D B4 3D 3C
0210 | F4 8B 24 EA A8 48 FF DD 6E EA DC 08 74 04 00 63
0220 | 46 A8 B8 2C C7 38 BE 4D E3 27 6D D3 2C 5B 12 A3
0230 | AA 60 D5 2B 21 1F D3 1C CF 95 08 E5 9B E8 FB 3A
0240 | 32 EE 3A 70 BA BB 60 3F 7D 76 A5 AE 7A DE 0A 6C
0250 | 8E 39 1B 1F D9 C2 60 C9 15 D0 92 3B 19 99 43 A9
0260 | 56 C7 BB 28 3D 41 BB 4D E4 62 DC BB 7C 2E 4A 2E
0270 | E9 71 FD 92 52 CF AB C4 2F 31 9E 99 95 0C E7 D3
0280 | 95 E5 9B 42 BC 26 AC 4D BF C3 8F 1A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01ECA2A7E5576365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A4020000</code> (676 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200A5438185D34A6F57F36A578D</code> <code>189F026F7A32D3DC05A341A39C23C4BA</code> <code>D18C4CDB78A1A2DE8BF1853ABD106250</code> <code>C37D13E2D3C380710A36F50260FED78D</code> <code>FA5AD485D2AFD51D0577CE229860A366</code> <code>8DF2AA2C3B86380A42403B80066011FD</code> <code>79D181D420C621B86E8F96C7A365F934</code> <code>0D0148265B6E321850055C4DE75E3C58</code> <code>1A9CE39A1197467C7FC6F4A2D34985DA</code> <code>26B122A75B1B660B968581FAAEFD8BB8</code> <code>DB307FB31234EAF3DD3F31943317C3F0</code> <code>998E6759023F254A19A57C70414D3176</code> <code>68FFF7E1DCB0ECF0887821B9A7B405CD</code> <code>13AE67542293E404CAA5B0AE3463CE8B</code> <code>B6F726BAD9A1E0539F863A31818DB768</code> <code>499CC90D292104BF7D54F01D15739AEB</code> <code>6B9F8C8928C64CF50CBCB72AA4A4AE1F</code> <code>5EBCB92A9F565F9C453D071D289C9167</code> <code>461D8D3A2EDA8C0C8ECC0A1D9BE96FDA</code> <code>1C56011EC9D5798AA2F3FD13C5AB52DC</code> <code>06620BCDF2CC610EB520B6DB94C82E30</code> <code>FC87AE6525B7B32CB7BB7087B359A59A</code> <code>039D044C642981247C301A9C8ED51B73</code> <code>F2D1D4455C0453D260741D3DBB788374</code> <code>D151F0E53A20DFAA3638F26F36206273</code> <code>9A4E7A571C4A962391DBD36510AFE44C</code> <code>0D9B500B9B46E19E1AEF880E96C0493C</code> <code>D79259919CF25624523A7417A1FB217E</code> <code>5C978999F229DEB2903ADD8EE1ED7EF6</code> <code>ADB2A24A9DB43D3CF48B24EAA848FFDD</code> <code>6EEADC087404006346A8B82CC738BE4D</code> <code>E3276DD32C5B12A3AA60D52B211FD31C</code> <code>CF9508E59BE8FB3A32EE3A70BABB603F</code> <code>7D76A5AE7ADE0A6C8E391B1FD9C260C9</code> <code>15D0923B199943A956C7BB283D41BB4D</code> <code>E462DCBB7C2E4A2EE971FD9252CFABC4</code> <code>2F319E99950CE7D395E59B42BC26AC4D</code><br> <code>BFC38F1A</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = A5438185D34A6F57F36A578D189F026F7A32D3DC05A341A39C23C4BAD18C4CDB78A1A2DE8BF1853ABD106250C37D13E2D3C380710A36F50260FED78DFA5AD485D2AFD51D0577CE229860A3668DF2AA2C3B86380A42403B80066011FD79D181D420C621B86E8F96C7A365F9340D0148265B6E321850055C4DE75E3C581A9CE39A1197467C7FC6F4A2D34985DA26B122A75B1B660B968581FAAEFD8BB8DB307FB31234EAF3DD3F31943317C3F0998E6759023F254A19A57C70414D317668FFF7E1DCB0ECF0887821B9A7B405CD13AE67542293E404CAA5B0AE3463CE8BB6F726BAD9A1E0539F863A31818DB768499CC90D292104BF7D54F01D15739AEB6B9F8C8928C64CF50CBCB72AA4A4AE1F5EBCB92A9F565F9C453D071D289C9167461D8D3A2EDA8C0C8ECC0A1D9BE96FDA1C56011EC9D5798AA2F3FD13C5AB52DC06620BCDF2CC610EB520B6DB94C82E30FC87AE6525B7B32CB7BB7087B359A59A039D044C642981247C301A9C8ED51B73F2D1D4455C0453D260741D3DBB788374D151F0E53A20DFAA3638F26F362062739A4E7A571C4A962391DBD36510AFE44C0D9B500B9B46E19E1AEF880E96C0493CD79259919CF25624523A7417A1FB217E5C978999F229DEB2903ADD8EE1ED7EF6ADB2A24A9DB43D3CF48B24EAA848FFDD6EEADC087404006346A8B82CC738BE4DE3276DD32C5B12A3AA60D52B211FD31CCF9508E59BE8FB3A32EE3A70BABB603F7D76A5AE7ADE0A6C8E391B1FD9C260C915D0923B199943A956C7BB283D41BB4DE462DCBB7C2E4A2EE971FD9252CFABC42F319E99950CE7D395E59B42BC26AC4DBFC38F1A
tmp_aes_key = DDE9D7DA461399FD1D9564B9313F80C9B33BE062852B3D48A82D396812037569
tmp_aes_iv = 23E6A1FE2F85BF5F4EA12E1514BB8D937849463EF3B1027712C1F8D2C6A06071</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 4981FEE758D8D56353659697CAD7365E11277F6DBA0D89B5C050C45483E6C2E330D6521499453D5B533BACFB1167B9558095BD91A77F8D0E03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004916D416BFA942C255D504A1D88816E0D80F34339B3C1376A762AD2576372A5249A5FCDE1A49958BC65225E92C93FD93F65DC937E8A7F0546D06736CD8485ACE26F4859402156493386E61B772F5F284CFF194B96D58476DA6A52F2E1C61E932E6FEABB2ADABE10F14F0EA0D09DF221398014C7D0C210470F4C6F9BE6EF14C0003A5985E6B7D82E7B4A6D8C6C304C37852D75E87BAAE2A7D893698EBF5453DA4BACA62DFC5D4E8DC2712F07118A9008824368E96C3EE9D9984DA64D0943F02DB7E17E4321D8C91155CA500B338297405B1B6871BF39AFD240492FBB7D9C6F3AC0DA8EA80070AAAD2590EB474FCE3EEE3736642AACF362169F8C2A7F68BAE15AFE5576365EBFE2B4E1BFAC66E
answer = BA0D89B5C050C45483E6C2E330D6521499453D5B533BACFB1167B9558095BD91A77F8D0E03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004916D416BFA942C255D504A1D88816E0D80F34339B3C1376A762AD2576372A5249A5FCDE1A49958BC65225E92C93FD93F65DC937E8A7F0546D06736CD8485ACE26F4859402156493386E61B772F5F284CFF194B96D58476DA6A52F2E1C61E932E6FEABB2ADABE10F14F0EA0D09DF221398014C7D0C210470F4C6F9BE6EF14C0003A5985E6B7D82E7B4A6D8C6C304C37852D75E87BAAE2A7D893698EBF5453DA4BACA62DFC5D4E8DC2712F07118A9008824368E96C3EE9D9984DA64D0943F02DB7E17E4321D8C91155CA500B338297405B1B6871BF39AFD240492FBB7D9C6F3AC0DA8EA80070AAAD2590EB474FCE3EEE3736642AACF362169F8C2A7F68BAE15AFE5576365EBFE2B4E1BFAC66E</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 C0 50 C4 54 83 E6 C2 E3 30 D6 52 14
0010 | 99 45 3D 5B 53 3B AC FB 11 67 B9 55 80 95 BD 91
0020 | A7 7F 8D 0E 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 49 16 D4 16 BF A9 42 C2 55 D5 04 A1 D8 88 16 E0
0140 | D8 0F 34 33 9B 3C 13 76 A7 62 AD 25 76 37 2A 52
0150 | 49 A5 FC DE 1A 49 95 8B C6 52 25 E9 2C 93 FD 93
0160 | F6 5D C9 37 E8 A7 F0 54 6D 06 73 6C D8 48 5A CE
0170 | 26 F4 85 94 02 15 64 93 38 6E 61 B7 72 F5 F2 84
0180 | CF F1 94 B9 6D 58 47 6D A6 A5 2F 2E 1C 61 E9 32
0190 | E6 FE AB B2 AD AB E1 0F 14 F0 EA 0D 09 DF 22 13
01A0 | 98 01 4C 7D 0C 21 04 70 F4 C6 F9 BE 6E F1 4C 00
01B0 | 03 A5 98 5E 6B 7D 82 E7 B4 A6 D8 C6 C3 04 C3 78
01C0 | 52 D7 5E 87 BA AE 2A 7D 89 36 98 EB F5 45 3D A4
01D0 | BA CA 62 DF C5 D4 E8 DC 27 12 F0 71 18 A9 00 88
01E0 | 24 36 8E 96 C3 EE 9D 99 84 DA 64 D0 94 3F 02 DB
01F0 | 7E 17 E4 32 1D 8C 91 15 5C A5 00 B3 38 29 74 05
0200 | B1 B6 87 1B F3 9A FD 24 04 92 FB B7 D9 C6 F3 AC
0210 | 0D A8 EA 80 07 0A AA D2 59 0E B4 74 FC E3 EE E3
0220 | 73 66 42 AA CF 36 21 69 F8 C2 A7 F6 8B AE 15 AF
0230 | E5 57 63 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001004916D416BFA942C255D504A1</code> <code>D88816E0D80F34339B3C1376A762AD25</code> <code>76372A5249A5FCDE1A49958BC65225E9</code> <code>2C93FD93F65DC937E8A7F0546D06736C</code> <code>D8485ACE26F4859402156493386E61B7</code> <code>72F5F284CFF194B96D58476DA6A52F2E</code> <code>1C61E932E6FEABB2ADABE10F14F0EA0D</code> <code>09DF221398014C7D0C210470F4C6F9BE</code> <code>6EF14C0003A5985E6B7D82E7B4A6D8C6</code> <code>C304C37852D75E87BAAE2A7D893698EB</code> <code>F5453DA4BACA62DFC5D4E8DC2712F071</code> <code>18A9008824368E96C3EE9D9984DA64D0</code> <code>943F02DB7E17E4321D8C91155CA500B3</code> <code>38297405B1B6871BF39AFD240492FBB7</code> <code>D9C6F3AC0DA8EA80070AAAD2590EB474</code> <code>FCE3EEE3736642AACF362169F8C2A7F6</code><br> <code>8BAE15AF</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E5576365</code> (1701009381 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 1690CE50058E37D10D31692F9BA3CCDA8023192F99EAFF1CCB556981BA08BC948D90B29E964137F12FEEB4B416212F96399825D52EEF78BFD0A5EE912DE42AC307AC10FF6547C1AC166D86D9603D259AAABAF03EAA80318CDBE1276476543B7F0FF381419BD9A52101F632608C51FBABAEBE4D16DBEDA7CA729722E304A8A1D0945B1CFEACA4970A4E7BAB66B5159519A10841A641333E76B6F7012C86BD9E7F40D4D7AF86007D713BF5BD716965FDC318370C4AFD10E2FC0B0798C318D757D14F2F88EA8AB529EBC7A8614108EF89DDFCF61F83DECDB688DAC7C8057CA658F4AFD9C450E7B37A86CA67FFFB647708835FE1833F6702820D44B3076943510824</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B5B7ECA50AA21159E6808734399E78D58C7DE735990AF8B1746B86107EBCEDCBCBAEABD2015748E99BE50429B233BB0E94572C48DF4D138D5587C37FAB8394A1660F7C1183E1C145A5C71349D39D146DF30FB39624AE87868937EA0EC34E433A217DA33A84A0150412DCDC257D11B4B68C7280B06A6C751F3AA8ED313F23049DB2470B09AFDD52A4362F9FF28287C11F4750443C6440125C44F21F0B410E49A39E10F45DA6ACF7FC2AA14D1549C7674692DA2192CE41B1238B0E94F17328C18550BC5C74CA9655B368A95660134B662DFC194F95A7437FD59E9E81FD8E1A6A51CC37604472F864C0317D5A16998F1191D1D539F0105DBD872104B5EDF13A357E</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 C0 50 C4 54 83 E6 C2 E3 30 D6 52 14
0010 | 99 45 3D 5B 53 3B AC FB 11 67 B9 55 80 95 BD 91
0020 | A7 7F 8D 0E 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B5 B7 EC A5 0A A2 11 59 E6 80 87 34 39 9E 78 D5
0040 | 8C 7D E7 35 99 0A F8 B1 74 6B 86 10 7E BC ED CB
0050 | CB AE AB D2 01 57 48 E9 9B E5 04 29 B2 33 BB 0E
0060 | 94 57 2C 48 DF 4D 13 8D 55 87 C3 7F AB 83 94 A1
0070 | 66 0F 7C 11 83 E1 C1 45 A5 C7 13 49 D3 9D 14 6D
0080 | F3 0F B3 96 24 AE 87 86 89 37 EA 0E C3 4E 43 3A
0090 | 21 7D A3 3A 84 A0 15 04 12 DC DC 25 7D 11 B4 B6
00A0 | 8C 72 80 B0 6A 6C 75 1F 3A A8 ED 31 3F 23 04 9D
00B0 | B2 47 0B 09 AF DD 52 A4 36 2F 9F F2 82 87 C1 1F
00C0 | 47 50 44 3C 64 40 12 5C 44 F2 1F 0B 41 0E 49 A3
00D0 | 9E 10 F4 5D A6 AC F7 FC 2A A1 4D 15 49 C7 67 46
00E0 | 92 DA 21 92 CE 41 B1 23 8B 0E 94 F1 73 28 C1 85
00F0 | 50 BC 5C 74 CA 96 55 B3 68 A9 56 60 13 4B 66 2D
0100 | FC 19 4F 95 A7 43 7F D5 9E 9E 81 FD 8E 1A 6A 51
0110 | CC 37 60 44 72 F8 64 C0 31 7D 5A 16 99 8F 11 91
0120 | D1 D5 39 F0 10 5D BD 87 21 04 B5 ED F1 3A 35 7E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B5B7ECA50AA21159E6808734</code> <code>399E78D58C7DE735990AF8B1746B8610</code> <code>7EBCEDCBCBAEABD2015748E99BE50429</code> <code>B233BB0E94572C48DF4D138D5587C37F</code> <code>AB8394A1660F7C1183E1C145A5C71349</code> <code>D39D146DF30FB39624AE87868937EA0E</code> <code>C34E433A217DA33A84A0150412DCDC25</code> <code>7D11B4B68C7280B06A6C751F3AA8ED31</code> <code>3F23049DB2470B09AFDD52A4362F9FF2</code> <code>8287C11F4750443C6440125C44F21F0B</code> <code>410E49A39E10F45DA6ACF7FC2AA14D15</code> <code>49C7674692DA2192CE41B1238B0E94F1</code> <code>7328C18550BC5C74CA9655B368A95660</code> <code>134B662DFC194F95A7437FD59E9E81FD</code> <code>8E1A6A51CC37604472F864C0317D5A16</code> <code>998F1191D1D539F0105DBD872104B5ED</code><br> <code>F13A357E</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366C050C45483E6C2E330D6521499453D5B533BACFB1167B9558095BD91A77F8D0E0000000000000000FE000100B5B7ECA50AA21159E6808734399E78D58C7DE735990AF8B1746B86107EBCEDCBCBAEABD2015748E99BE50429B233BB0E94572C48DF4D138D5587C37FAB8394A1660F7C1183E1C145A5C71349D39D146DF30FB39624AE87868937EA0EC34E433A217DA33A84A0150412DCDC257D11B4B68C7280B06A6C751F3AA8ED313F23049DB2470B09AFDD52A4362F9FF28287C11F4750443C6440125C44F21F0B410E49A39E10F45DA6ACF7FC2AA14D1549C7674692DA2192CE41B1238B0E94F17328C18550BC5C74CA9655B368A95660134B662DFC194F95A7437FD59E9E81FD8E1A6A51CC37604472F864C0317D5A16998F1191D1D539F0105DBD872104B5EDF13A357E
padding = C4134CFF706DDC04451346F6
tmp_aes_key = DDE9D7DA461399FD1D9564B9313F80C9B33BE062852B3D48A82D396812037569
tmp_aes_iv = 23E6A1FE2F85BF5F4EA12E1514BB8D937849463EF3B1027712C1F8D2C6A06071</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 00EE6F2CF13AEEB7440E04A12A3078CDDA211EB8A4A97013C8DEC965B732C51B71452CC89748DB2860DBEDA83F7908EE27AACDE23A63E55162193FB951C95708990E9583E0FC26B7B3892061A7ED7FDBE0DF4A33E06BB9E5BCFC9CB403810589FEFCBE32DDB40EEB2D79493F7CCAD91BEA12E57FBC104B231D85158ABBBF01BF6A48E8C19F1180574E73F59051967B7842AF0B80B30C43DD55ABFBB7F946B1E9A1BF81DFB72E48633B368F88E9CB4FF8DCA7EE762E4E5D9C875F1C91787F7BC6D29E0FE91D88C791FDDDB3FE25C5D4AA4C1C92AE11E3B34D4B012FBE502FA969B1427DC8A2F030BF537CC50723F2E1B88ADC81F496EBEBF328315A96FAB040A83242F53DC9A8C7B8179388C1A52F1477082AF82D687B46464187CA5F6672C7A427F0F32C25CCC5FDBD7E3E44488EF4938402ACEC1512856C3E7D768FBA24D6D8800A4F48B07B8EAED197534D91C84C8B</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A0 34 08 00 E5 57 63 65
0010 | 78 01 00 00 1F 5F 04 F5 C0 50 C4 54 83 E6 C2 E3
0020 | 30 D6 52 14 99 45 3D 5B 53 3B AC FB 11 67 B9 55
0030 | 80 95 BD 91 A7 7F 8D 0E FE 50 01 00 00 EE 6F 2C
0040 | F1 3A EE B7 44 0E 04 A1 2A 30 78 CD DA 21 1E B8
0050 | A4 A9 70 13 C8 DE C9 65 B7 32 C5 1B 71 45 2C C8
0060 | 97 48 DB 28 60 DB ED A8 3F 79 08 EE 27 AA CD E2
0070 | 3A 63 E5 51 62 19 3F B9 51 C9 57 08 99 0E 95 83
0080 | E0 FC 26 B7 B3 89 20 61 A7 ED 7F DB E0 DF 4A 33
0090 | E0 6B B9 E5 BC FC 9C B4 03 81 05 89 FE FC BE 32
00A0 | DD B4 0E EB 2D 79 49 3F 7C CA D9 1B EA 12 E5 7F
00B0 | BC 10 4B 23 1D 85 15 8A BB BF 01 BF 6A 48 E8 C1
00C0 | 9F 11 80 57 4E 73 F5 90 51 96 7B 78 42 AF 0B 80
00D0 | B3 0C 43 DD 55 AB FB B7 F9 46 B1 E9 A1 BF 81 DF
00E0 | B7 2E 48 63 3B 36 8F 88 E9 CB 4F F8 DC A7 EE 76
00F0 | 2E 4E 5D 9C 87 5F 1C 91 78 7F 7B C6 D2 9E 0F E9
0100 | 1D 88 C7 91 FD DD B3 FE 25 C5 D4 AA 4C 1C 92 AE
0110 | 11 E3 B3 4D 4B 01 2F BE 50 2F A9 69 B1 42 7D C8
0120 | A2 F0 30 BF 53 7C C5 07 23 F2 E1 B8 8A DC 81 F4
0130 | 96 EB EB F3 28 31 5A 96 FA B0 40 A8 32 42 F5 3D
0140 | C9 A8 C7 B8 17 93 88 C1 A5 2F 14 77 08 2A F8 2D
0150 | 68 7B 46 46 41 87 CA 5F 66 72 C7 A4 27 F0 F3 2C
0160 | 25 CC C5 FD BD 7E 3E 44 48 8E F4 93 84 02 AC EC
0170 | 15 12 85 6C 3E 7D 76 8F BA 24 D6 D8 80 0A 4F 48
0180 | B0 7B 8E AE D1 97 53 4D 91 C8 4C 8B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A0340800E5576365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010000EE6F2CF13AEEB7440E04A1</code> <code>2A3078CDDA211EB8A4A97013C8DEC965</code> <code>B732C51B71452CC89748DB2860DBEDA8</code> <code>3F7908EE27AACDE23A63E55162193FB9</code> <code>51C95708990E9583E0FC26B7B3892061</code> <code>A7ED7FDBE0DF4A33E06BB9E5BCFC9CB4</code> <code>03810589FEFCBE32DDB40EEB2D79493F</code> <code>7CCAD91BEA12E57FBC104B231D85158A</code> <code>BBBF01BF6A48E8C19F1180574E73F590</code> <code>51967B7842AF0B80B30C43DD55ABFBB7</code> <code>F946B1E9A1BF81DFB72E48633B368F88</code> <code>E9CB4FF8DCA7EE762E4E5D9C875F1C91</code> <code>787F7BC6D29E0FE91D88C791FDDDB3FE</code> <code>25C5D4AA4C1C92AE11E3B34D4B012FBE</code> <code>502FA969B1427DC8A2F030BF537CC507</code> <code>23F2E1B88ADC81F496EBEBF328315A96</code> <code>FAB040A83242F53DC9A8C7B8179388C1</code> <code>A52F1477082AF82D687B46464187CA5F</code> <code>6672C7A427F0F32C25CCC5FDBD7E3E44</code> <code>488EF4938402ACEC1512856C3E7D768F</code> <code>BA24D6D8800A4F48B07B8EAED197534D</code><br> <code>91C84C8B</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7005033C51F039B6421BB899E60D797774C3566D859FD86BC5BC0715A19411F8FBFCA7F7BDD1776AD091897A9DB32A97E811AE6AF33229A187D667E054CA7E1E4A2887F98A392536A1AB8CF3F65FAA7E71E992E0B628BF4B34337967804DBCC9CB74707639E0B6B6C4E29C7E78AD66846C7C1305923FAEAD6BDD91A6D20F89061F80BBC997BF42A8748338E3F44173C57BFAA2AD1A9B0520475A091F9FDE3BFED9B0A2FA92C0E4ECE12B7D1A98D3C9AFD25F10919EEF0A20F443856DE0284CE2647A9B2DE6C4E8DF71A014F6CAF09ADD5D83CFD066E330B3ECDC024514DE6F54EFFD14C156CC9ECBF472FECC70A4AB10BFA7281D4A93B8348CA48C6215017801</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 0B 03 E6 57 63 65
0010 | 48 00 00 00 34 F7 CB 3B C0 50 C4 54 83 E6 C2 E3
0020 | 30 D6 52 14 99 45 3D 5B 53 3B AC FB 11 67 B9 55
0030 | 80 95 BD 91 A7 7F 8D 0E EA 9F 42 E2 0B 5E 54 AF
0040 | 96 4B DE BE 06 1B 1B 7A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01380B03E6576365</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>48000000</code> (72 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C050C45483E6C2E330D6521499453D5B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>533BACFB1167B9558095BD91A77F8D0E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>EA9F42E20B5E54AF964BDEBE061B1B7A</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

